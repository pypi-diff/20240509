# Comparing `tmp/nutils-8.6.tar.gz` & `tmp/nutils-8.7.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "nutils-8.6.tar", last modified: Fri Jan  1 00:00:00 2016, max compression
+gzip compressed data, was "nutils-8.7.tar", last modified: Fri Jan  1 00:00:00 2016, max compression
```

## Comparing `nutils-8.6.tar` & `nutils-8.7.tar`

### file list

```diff
@@ -1,132 +1,132 @@
--rw-r--r--   0        0        0       13 2024-02-09 16:07:44.730349 nutils-8.6/.codecov.yml
--rw-r--r--   0        0        0       58 2024-02-09 16:07:44.730349 nutils-8.6/.coveragerc
--rw-r--r--   0        0        0      539 2024-02-09 16:07:44.730349 nutils-8.6/.github/workflows/release.yml
--rw-r--r--   0        0        0     9822 2024-02-09 16:07:44.730349 nutils-8.6/.github/workflows/test.yaml
--rw-r--r--   0        0        0       65 2024-02-09 16:07:44.730349 nutils-8.6/.gitignore
--rw-r--r--   0        0        0     8296 2024-02-09 16:07:44.730349 nutils-8.6/CHANGELOG
--rw-r--r--   0        0        0     1062 2024-02-09 16:07:44.730349 nutils-8.6/LICENSE
--rw-r--r--   0        0        0     6035 2024-02-09 16:07:44.730349 nutils-8.6/README.md
--rw-r--r--   0        0        0     1437 2024-02-09 16:07:44.730349 nutils-8.6/devtools/__init__.py
--rw-r--r--   0        0        0     1303 2024-02-09 16:07:44.730349 nutils-8.6/devtools/_git.py
--rw-r--r--   0        0        0      732 2024-02-09 16:07:44.730349 nutils-8.6/devtools/_log_default.py
--rw-r--r--   0        0        0      701 2024-02-09 16:07:44.730349 nutils-8.6/devtools/_log_gha.py
--rw-r--r--   0        0        0     3985 2024-02-09 16:07:44.730349 nutils-8.6/devtools/container/__init__.py
--rw-r--r--   0        0        0     6071 2024-02-09 16:07:44.730349 nutils-8.6/devtools/container/build.py
--rw-r--r--   0        0        0     1772 2024-02-09 16:07:44.730349 nutils-8.6/devtools/container/build_base.py
--rw-r--r--   0        0        0        0 2024-02-09 16:07:44.730349 nutils-8.6/devtools/gha/__init__.py
--rw-r--r--   0        0        0     1242 2024-02-09 16:07:44.730349 nutils-8.6/devtools/gha/configure_mkl.py
--rw-r--r--   0        0        0     1697 2024-02-09 16:07:44.730349 nutils-8.6/devtools/gha/coverage_report_xml.py
--rw-r--r--   0        0        0      776 2024-02-09 16:07:44.730349 nutils-8.6/devtools/gha/get_base_and_image_tags.py
--rw-r--r--   0        0        0      105 2024-02-09 16:07:44.730349 nutils-8.6/docs/_static/mods.css
--rw-r--r--   0        0        0      585 2024-02-09 16:07:44.730349 nutils-8.6/docs/_templates/breadcrumbs.html
--rw-r--r--   0        0        0    11343 2024-02-09 16:07:44.730349 nutils-8.6/docs/conf.py
--rw-r--r--   0        0        0   360414 2024-02-09 16:07:44.734349 nutils-8.6/docs/favicon.ico
--rw-r--r--   0        0        0      510 2024-02-09 16:07:44.734349 nutils-8.6/docs/index.rst
--rw-r--r--   0        0        0     5599 2024-02-09 16:07:44.734349 nutils-8.6/docs/sphinx_mods.py
--rw-r--r--   0        0        0      456 2024-02-09 16:07:44.734349 nutils-8.6/examples/__init__.py
--rw-r--r--   0        0        0     7534 2024-02-09 16:07:44.734349 nutils-8.6/examples/adaptivity.py
--rw-r--r--   0        0        0     3561 2024-02-09 16:07:44.734349 nutils-8.6/examples/burgers.py
--rw-r--r--   0        0        0    12677 2024-02-09 16:07:44.734349 nutils-8.6/examples/cahnhilliard.py
--rw-r--r--   0        0        0    11156 2024-02-09 16:07:44.734349 nutils-8.6/examples/coil.py
--rw-r--r--   0        0        0    12287 2024-02-09 16:07:44.734349 nutils-8.6/examples/cylinderflow.py
--rw-r--r--   0        0        0    14036 2024-02-09 16:07:44.734349 nutils-8.6/examples/drivencavity.py
--rw-r--r--   0        0        0     6133 2024-02-09 16:07:44.734349 nutils-8.6/examples/elasticity.py
--rw-r--r--   0        0        0     4916 2024-02-09 16:07:44.734349 nutils-8.6/examples/finitestrain.py
--rw-r--r--   0        0        0     6972 2024-02-09 16:07:44.734349 nutils-8.6/examples/laplace.py
--rw-r--r--   0        0        0     9751 2024-02-09 16:07:44.734349 nutils-8.6/examples/platewithhole.py
--rw-r--r--   0        0        0     1564 2024-02-09 16:07:44.734349 nutils-8.6/examples/poisson.py
--rw-r--r--   0        0        0     5665 2024-02-09 16:07:44.734349 nutils-8.6/examples/torsion.py
--rw-r--r--   0        0        0    21018 2024-02-09 16:07:44.734349 nutils-8.6/nutils/SI.py
--rw-r--r--   0        0        0      612 2024-02-09 16:07:44.734349 nutils-8.6/nutils/__init__.py
--rw-r--r--   0        0        0     1537 2024-02-09 16:07:44.734349 nutils-8.6/nutils/_backports.py
--rw-r--r--   0        0        0    11089 2024-02-09 16:07:44.734349 nutils-8.6/nutils/_graph.py
--rw-r--r--   0        0        0    26774 2024-02-09 16:07:44.734349 nutils-8.6/nutils/_util.py
--rw-r--r--   0        0        0    15246 2024-02-09 16:07:44.734349 nutils-8.6/nutils/cache.py
--rw-r--r--   0        0        0     1565 2024-02-09 16:07:44.734349 nutils-8.6/nutils/cli.py
--rw-r--r--   0        0        0      468 2024-02-09 16:07:44.734349 nutils-8.6/nutils/debug_flags.py
--rw-r--r--   0        0        0    48181 2024-02-09 16:07:44.734349 nutils-8.6/nutils/element.py
--rw-r--r--   0        0        0    20568 2024-02-09 16:07:44.734349 nutils-8.6/nutils/elementseq.py
--rw-r--r--   0        0        0   200146 2024-02-09 16:07:44.734349 nutils-8.6/nutils/evaluable.py
--rw-r--r--   0        0        0    11441 2024-02-09 16:07:44.734349 nutils-8.6/nutils/export.py
--rw-r--r--   0        0        0    84259 2024-02-09 16:07:44.738349 nutils-8.6/nutils/expression_v1.py
--rw-r--r--   0        0        0    41347 2024-02-09 16:07:44.738349 nutils-8.6/nutils/expression_v2.py
--rw-r--r--   0        0        0   168493 2024-02-09 16:07:44.738349 nutils-8.6/nutils/function.py
--rw-r--r--   0        0        0     2233 2024-02-09 16:07:44.738349 nutils-8.6/nutils/matrix/__init__.py
--rw-r--r--   0        0        0      219 2024-02-09 16:07:44.738349 nutils-8.6/nutils/matrix/_auto.py
--rw-r--r--   0        0        0    13463 2024-02-09 16:07:44.738349 nutils-8.6/nutils/matrix/_base.py
--rw-r--r--   0        0        0    14313 2024-02-09 16:07:44.738349 nutils-8.6/nutils/matrix/_mkl.py
--rw-r--r--   0        0        0     2292 2024-02-09 16:07:44.738349 nutils-8.6/nutils/matrix/_numpy.py
--rw-r--r--   0        0        0     4341 2024-02-09 16:07:44.738349 nutils-8.6/nutils/matrix/_scipy.py
--rw-r--r--   0        0        0    35487 2024-02-09 16:07:44.738349 nutils-8.6/nutils/mesh.py
--rw-r--r--   0        0        0    23614 2024-02-09 16:07:44.738349 nutils-8.6/nutils/numeric.py
--rw-r--r--   0        0        0     5682 2024-02-09 16:07:44.738349 nutils-8.6/nutils/parallel.py
--rw-r--r--   0        0        0    19641 2024-02-09 16:07:44.738349 nutils-8.6/nutils/points.py
--rw-r--r--   0        0        0    22300 2024-02-09 16:07:44.738349 nutils-8.6/nutils/pointsseq.py
--rw-r--r--   0        0        0    45140 2024-02-09 16:07:44.738349 nutils-8.6/nutils/sample.py
--rw-r--r--   0        0        0    48637 2024-02-09 16:07:44.738349 nutils-8.6/nutils/solver.py
--rw-r--r--   0        0        0    13225 2024-02-09 16:07:44.738349 nutils-8.6/nutils/sparse.py
--rw-r--r--   0        0        0    11497 2024-02-09 16:07:44.738349 nutils-8.6/nutils/testing.py
--rw-r--r--   0        0        0   156643 2024-02-09 16:07:44.738349 nutils-8.6/nutils/topology.py
--rw-r--r--   0        0        0    16670 2024-02-09 16:07:44.738349 nutils-8.6/nutils/transform.py
--rw-r--r--   0        0        0    34922 2024-02-09 16:07:44.738349 nutils-8.6/nutils/transformseq.py
--rw-r--r--   0        0        0    23704 2024-02-09 16:07:44.738349 nutils-8.6/nutils/types.py
--rw-r--r--   0        0        0     6934 2024-02-09 16:07:44.738349 nutils-8.6/nutils/unit.py
--rw-r--r--   0        0        0      872 2024-02-09 16:07:44.738349 nutils-8.6/nutils/warnings.py
--rw-r--r--   0        0        0      793 2024-02-09 16:07:44.738349 nutils-8.6/pyproject.toml
--rw-r--r--   0        0        0      118 2024-02-09 16:07:44.738349 nutils-8.6/readthedocs.yml
--rw-r--r--   0        0        0        0 2024-02-09 16:07:44.738349 nutils-8.6/tests/__init__.py
--rw-r--r--   0        0        0    10400 2024-02-09 16:07:44.738349 nutils-8.6/tests/test_SI.py
--rw-r--r--   0        0        0      793 2024-02-09 16:07:44.738349 nutils-8.6/tests/test_backports.py
--rw-r--r--   0        0        0    16428 2024-02-09 16:07:44.738349 nutils-8.6/tests/test_basis.py
--rw-r--r--   0        0        0    14044 2024-02-09 16:07:44.738349 nutils-8.6/tests/test_cache.py
--rw-r--r--   0        0        0     2116 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_cli.py
--rw-r--r--   0        0        0     2977 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_docs.py
--rw-r--r--   0        0        0     6271 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_element.py
--rw-r--r--   0        0        0     9541 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_elementseq.py
--rw-r--r--   0        0        0    78239 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_evaluable.py
--rw-r--r--   0        0        0    10908 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_export.py
--rw-r--r--   0        0        0    52161 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_expression_v1.py
--rw-r--r--   0        0        0    24669 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_expression_v2.py
--rw-r--r--   0        0        0    18942 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_finitecell.py
--rw-r--r--   0        0        0    75580 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_function.py
--rw-r--r--   0        0        0    13788 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_graph.py
--rw-r--r--   0        0        0     3253 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_ischeme.py
--rw-r--r--   0        0        0    11189 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_matrix.py
--rw-r--r--   0        0        0     9685 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh.py
--rw-r--r--   0        0        0     1388 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh/mesh2d.geo
--rw-r--r--   0        0        0     6702 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh/mesh2d_p1_v2.msh
--rw-r--r--   0        0        0     5618 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh/mesh2d_p1_v4.msh
--rw-r--r--   0        0        0    17648 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh/mesh2d_p2_v2.msh
--rw-r--r--   0        0        0    16228 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh/mesh2d_p2_v4.msh
--rw-r--r--   0        0        0    35340 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh/mesh2d_p3_v2.msh
--rw-r--r--   0        0        0    33181 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh/mesh2d_p3_v4.msh
--rw-r--r--   0        0        0    59708 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh/mesh2d_p4_v2.msh
--rw-r--r--   0        0        0    56807 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh/mesh2d_p4_v4.msh
--rw-r--r--   0        0        0     3221 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh/mesh3d.geo
--rw-r--r--   0        0        0    78920 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh/mesh3d_p1_v2.msh
--rw-r--r--   0        0        0    59146 2024-02-09 16:07:44.742349 nutils-8.6/tests/test_mesh/mesh3d_p1_v4.msh
--rw-r--r--   0        0        0   254705 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_mesh/mesh3d_p2_v2.msh
--rw-r--r--   0        0        0   225898 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_mesh/mesh3d_p2_v4.msh
--rw-r--r--   0        0        0      742 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_mesh/mesh3dmani.geo
--rw-r--r--   0        0        0     5893 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_mesh/mesh3dmani_p1_v2.msh
--rw-r--r--   0        0        0     5587 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_mesh/mesh3dmani_p1_v4.msh
--rw-r--r--   0        0        0    17016 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_mesh/mesh3dmani_p2_v2.msh
--rw-r--r--   0        0        0    16281 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_mesh/mesh3dmani_p2_v4.msh
--rw-r--r--   0        0        0     2708 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_normals.py
--rw-r--r--   0        0        0    16473 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_numeric.py
--rw-r--r--   0        0        0     2206 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_parallel.py
--rw-r--r--   0        0        0     5654 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_points.py
--rw-r--r--   0        0        0    11346 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_pointsseq.py
--rw-r--r--   0        0        0     2297 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_quadrature.py
--rw-r--r--   0        0        0    27473 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_sample.py
--rw-r--r--   0        0        0    15950 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_solver.py
--rw-r--r--   0        0        0    13697 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_sparse.py
--rw-r--r--   0        0        0     1712 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_testing.py
--rw-r--r--   0        0        0    65717 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_topology.py
--rw-r--r--   0        0        0     4607 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_transform.py
--rw-r--r--   0        0        0    20363 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_transformseq.py
--rw-r--r--   0        0        0    23999 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_types.py
--rw-r--r--   0        0        0     2317 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_unit.py
--rw-r--r--   0        0        0    12562 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_util.py
--rw-r--r--   0        0        0      379 2024-02-09 16:07:44.746349 nutils-8.6/tests/test_warnings.py
--rw-r--r--   0        0        0     7017 1970-01-01 00:00:00.000000 nutils-8.6/PKG-INFO
+-rw-r--r--   0        0        0       13 2024-05-09 09:27:53.830973 nutils-8.7/.codecov.yml
+-rw-r--r--   0        0        0       58 2024-05-09 09:27:53.830973 nutils-8.7/.coveragerc
+-rw-r--r--   0        0        0      539 2024-05-09 09:27:53.830973 nutils-8.7/.github/workflows/release.yml
+-rw-r--r--   0        0        0     9815 2024-05-09 09:27:53.830973 nutils-8.7/.github/workflows/test.yaml
+-rw-r--r--   0        0        0       65 2024-05-09 09:27:53.830973 nutils-8.7/.gitignore
+-rw-r--r--   0        0        0     8296 2024-05-09 09:27:53.830973 nutils-8.7/CHANGELOG
+-rw-r--r--   0        0        0     1062 2024-05-09 09:27:53.830973 nutils-8.7/LICENSE
+-rw-r--r--   0        0        0     6035 2024-05-09 09:27:53.830973 nutils-8.7/README.md
+-rw-r--r--   0        0        0     1437 2024-05-09 09:27:53.830973 nutils-8.7/devtools/__init__.py
+-rw-r--r--   0        0        0     1303 2024-05-09 09:27:53.830973 nutils-8.7/devtools/_git.py
+-rw-r--r--   0        0        0      732 2024-05-09 09:27:53.830973 nutils-8.7/devtools/_log_default.py
+-rw-r--r--   0        0        0      701 2024-05-09 09:27:53.830973 nutils-8.7/devtools/_log_gha.py
+-rw-r--r--   0        0        0     3985 2024-05-09 09:27:53.830973 nutils-8.7/devtools/container/__init__.py
+-rw-r--r--   0        0        0     6071 2024-05-09 09:27:53.830973 nutils-8.7/devtools/container/build.py
+-rw-r--r--   0        0        0     1772 2024-05-09 09:27:53.830973 nutils-8.7/devtools/container/build_base.py
+-rw-r--r--   0        0        0        0 2024-05-09 09:27:53.830973 nutils-8.7/devtools/gha/__init__.py
+-rw-r--r--   0        0        0     1242 2024-05-09 09:27:53.830973 nutils-8.7/devtools/gha/configure_mkl.py
+-rw-r--r--   0        0        0     1697 2024-05-09 09:27:53.830973 nutils-8.7/devtools/gha/coverage_report_xml.py
+-rw-r--r--   0        0        0      776 2024-05-09 09:27:53.830973 nutils-8.7/devtools/gha/get_base_and_image_tags.py
+-rw-r--r--   0        0        0      105 2024-05-09 09:27:53.830973 nutils-8.7/docs/_static/mods.css
+-rw-r--r--   0        0        0      585 2024-05-09 09:27:53.830973 nutils-8.7/docs/_templates/breadcrumbs.html
+-rw-r--r--   0        0        0    11343 2024-05-09 09:27:53.830973 nutils-8.7/docs/conf.py
+-rw-r--r--   0        0        0   360414 2024-05-09 09:27:53.830973 nutils-8.7/docs/favicon.ico
+-rw-r--r--   0        0        0      510 2024-05-09 09:27:53.830973 nutils-8.7/docs/index.rst
+-rw-r--r--   0        0        0     5599 2024-05-09 09:27:53.830973 nutils-8.7/docs/sphinx_mods.py
+-rw-r--r--   0        0        0      456 2024-05-09 09:27:53.830973 nutils-8.7/examples/__init__.py
+-rw-r--r--   0        0        0     7534 2024-05-09 09:27:53.830973 nutils-8.7/examples/adaptivity.py
+-rw-r--r--   0        0        0     3561 2024-05-09 09:27:53.830973 nutils-8.7/examples/burgers.py
+-rw-r--r--   0        0        0    12669 2024-05-09 09:27:53.830973 nutils-8.7/examples/cahnhilliard.py
+-rw-r--r--   0        0        0    11156 2024-05-09 09:27:53.830973 nutils-8.7/examples/coil.py
+-rw-r--r--   0        0        0    12287 2024-05-09 09:27:53.830973 nutils-8.7/examples/cylinderflow.py
+-rw-r--r--   0        0        0    14036 2024-05-09 09:27:53.830973 nutils-8.7/examples/drivencavity.py
+-rw-r--r--   0        0        0     6133 2024-05-09 09:27:53.830973 nutils-8.7/examples/elasticity.py
+-rw-r--r--   0        0        0     4916 2024-05-09 09:27:53.830973 nutils-8.7/examples/finitestrain.py
+-rw-r--r--   0        0        0     6972 2024-05-09 09:27:53.830973 nutils-8.7/examples/laplace.py
+-rw-r--r--   0        0        0     9751 2024-05-09 09:27:53.830973 nutils-8.7/examples/platewithhole.py
+-rw-r--r--   0        0        0     1564 2024-05-09 09:27:53.830973 nutils-8.7/examples/poisson.py
+-rw-r--r--   0        0        0     5665 2024-05-09 09:27:53.830973 nutils-8.7/examples/torsion.py
+-rw-r--r--   0        0        0    21014 2024-05-09 09:27:53.834973 nutils-8.7/nutils/SI.py
+-rw-r--r--   0        0        0      612 2024-05-09 09:27:53.834973 nutils-8.7/nutils/__init__.py
+-rw-r--r--   0        0        0     1537 2024-05-09 09:27:53.834973 nutils-8.7/nutils/_backports.py
+-rw-r--r--   0        0        0    11089 2024-05-09 09:27:53.834973 nutils-8.7/nutils/_graph.py
+-rw-r--r--   0        0        0    26886 2024-05-09 09:27:53.834973 nutils-8.7/nutils/_util.py
+-rw-r--r--   0        0        0    15246 2024-05-09 09:27:53.834973 nutils-8.7/nutils/cache.py
+-rw-r--r--   0        0        0     1565 2024-05-09 09:27:53.834973 nutils-8.7/nutils/cli.py
+-rw-r--r--   0        0        0      468 2024-05-09 09:27:53.834973 nutils-8.7/nutils/debug_flags.py
+-rw-r--r--   0        0        0    48181 2024-05-09 09:27:53.834973 nutils-8.7/nutils/element.py
+-rw-r--r--   0        0        0    20568 2024-05-09 09:27:53.834973 nutils-8.7/nutils/elementseq.py
+-rw-r--r--   0        0        0   200409 2024-05-09 09:27:53.834973 nutils-8.7/nutils/evaluable.py
+-rw-r--r--   0        0        0    11441 2024-05-09 09:27:53.834973 nutils-8.7/nutils/export.py
+-rw-r--r--   0        0        0    84259 2024-05-09 09:27:53.834973 nutils-8.7/nutils/expression_v1.py
+-rw-r--r--   0        0        0    41347 2024-05-09 09:27:53.834973 nutils-8.7/nutils/expression_v2.py
+-rw-r--r--   0        0        0   168493 2024-05-09 09:27:53.834973 nutils-8.7/nutils/function.py
+-rw-r--r--   0        0        0     2233 2024-05-09 09:27:53.834973 nutils-8.7/nutils/matrix/__init__.py
+-rw-r--r--   0        0        0      219 2024-05-09 09:27:53.834973 nutils-8.7/nutils/matrix/_auto.py
+-rw-r--r--   0        0        0    13463 2024-05-09 09:27:53.834973 nutils-8.7/nutils/matrix/_base.py
+-rw-r--r--   0        0        0    14313 2024-05-09 09:27:53.834973 nutils-8.7/nutils/matrix/_mkl.py
+-rw-r--r--   0        0        0     2292 2024-05-09 09:27:53.834973 nutils-8.7/nutils/matrix/_numpy.py
+-rw-r--r--   0        0        0     4341 2024-05-09 09:27:53.834973 nutils-8.7/nutils/matrix/_scipy.py
+-rw-r--r--   0        0        0    35336 2024-05-09 09:27:53.834973 nutils-8.7/nutils/mesh.py
+-rw-r--r--   0        0        0    23614 2024-05-09 09:27:53.834973 nutils-8.7/nutils/numeric.py
+-rw-r--r--   0        0        0     5682 2024-05-09 09:27:53.834973 nutils-8.7/nutils/parallel.py
+-rw-r--r--   0        0        0    19641 2024-05-09 09:27:53.834973 nutils-8.7/nutils/points.py
+-rw-r--r--   0        0        0    22300 2024-05-09 09:27:53.834973 nutils-8.7/nutils/pointsseq.py
+-rw-r--r--   0        0        0    45140 2024-05-09 09:27:53.838973 nutils-8.7/nutils/sample.py
+-rw-r--r--   0        0        0    48637 2024-05-09 09:27:53.838973 nutils-8.7/nutils/solver.py
+-rw-r--r--   0        0        0    13225 2024-05-09 09:27:53.838973 nutils-8.7/nutils/sparse.py
+-rw-r--r--   0        0        0    11497 2024-05-09 09:27:53.838973 nutils-8.7/nutils/testing.py
+-rw-r--r--   0        0        0   153119 2024-05-09 09:27:53.838973 nutils-8.7/nutils/topology.py
+-rw-r--r--   0        0        0    16670 2024-05-09 09:27:53.838973 nutils-8.7/nutils/transform.py
+-rw-r--r--   0        0        0    34922 2024-05-09 09:27:53.838973 nutils-8.7/nutils/transformseq.py
+-rw-r--r--   0        0        0    23704 2024-05-09 09:27:53.838973 nutils-8.7/nutils/types.py
+-rw-r--r--   0        0        0     6934 2024-05-09 09:27:53.838973 nutils-8.7/nutils/unit.py
+-rw-r--r--   0        0        0      872 2024-05-09 09:27:53.838973 nutils-8.7/nutils/warnings.py
+-rw-r--r--   0        0        0      787 2024-05-09 09:27:53.838973 nutils-8.7/pyproject.toml
+-rw-r--r--   0        0        0      118 2024-05-09 09:27:53.838973 nutils-8.7/readthedocs.yml
+-rw-r--r--   0        0        0        0 2024-05-09 09:27:53.838973 nutils-8.7/tests/__init__.py
+-rw-r--r--   0        0        0    10400 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_SI.py
+-rw-r--r--   0        0        0      793 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_backports.py
+-rw-r--r--   0        0        0    16428 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_basis.py
+-rw-r--r--   0        0        0    14044 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_cache.py
+-rw-r--r--   0        0        0     2116 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_cli.py
+-rw-r--r--   0        0        0     2977 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_docs.py
+-rw-r--r--   0        0        0     6271 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_element.py
+-rw-r--r--   0        0        0     9541 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_elementseq.py
+-rw-r--r--   0        0        0    78239 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_evaluable.py
+-rw-r--r--   0        0        0    10908 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_export.py
+-rw-r--r--   0        0        0    52161 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_expression_v1.py
+-rw-r--r--   0        0        0    24669 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_expression_v2.py
+-rw-r--r--   0        0        0    18942 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_finitecell.py
+-rw-r--r--   0        0        0    75580 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_function.py
+-rw-r--r--   0        0        0    13788 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_graph.py
+-rw-r--r--   0        0        0     3253 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_ischeme.py
+-rw-r--r--   0        0        0    11189 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_matrix.py
+-rw-r--r--   0        0        0     9685 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_mesh.py
+-rw-r--r--   0        0        0     1388 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_mesh/mesh2d.geo
+-rw-r--r--   0        0        0     6702 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_mesh/mesh2d_p1_v2.msh
+-rw-r--r--   0        0        0     5618 2024-05-09 09:27:53.838973 nutils-8.7/tests/test_mesh/mesh2d_p1_v4.msh
+-rw-r--r--   0        0        0    17648 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh2d_p2_v2.msh
+-rw-r--r--   0        0        0    16228 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh2d_p2_v4.msh
+-rw-r--r--   0        0        0    35340 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh2d_p3_v2.msh
+-rw-r--r--   0        0        0    33181 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh2d_p3_v4.msh
+-rw-r--r--   0        0        0    59708 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh2d_p4_v2.msh
+-rw-r--r--   0        0        0    56807 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh2d_p4_v4.msh
+-rw-r--r--   0        0        0     3221 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh3d.geo
+-rw-r--r--   0        0        0    78920 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh3d_p1_v2.msh
+-rw-r--r--   0        0        0    59146 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh3d_p1_v4.msh
+-rw-r--r--   0        0        0   254705 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh3d_p2_v2.msh
+-rw-r--r--   0        0        0   225898 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh3d_p2_v4.msh
+-rw-r--r--   0        0        0      742 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh3dmani.geo
+-rw-r--r--   0        0        0     5893 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh3dmani_p1_v2.msh
+-rw-r--r--   0        0        0     5587 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh3dmani_p1_v4.msh
+-rw-r--r--   0        0        0    17016 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh3dmani_p2_v2.msh
+-rw-r--r--   0        0        0    16281 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_mesh/mesh3dmani_p2_v4.msh
+-rw-r--r--   0        0        0     2708 2024-05-09 09:27:53.842973 nutils-8.7/tests/test_normals.py
+-rw-r--r--   0        0        0    16473 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_numeric.py
+-rw-r--r--   0        0        0     2206 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_parallel.py
+-rw-r--r--   0        0        0     5654 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_points.py
+-rw-r--r--   0        0        0    11346 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_pointsseq.py
+-rw-r--r--   0        0        0     2297 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_quadrature.py
+-rw-r--r--   0        0        0    27473 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_sample.py
+-rw-r--r--   0        0        0    15950 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_solver.py
+-rw-r--r--   0        0        0    13697 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_sparse.py
+-rw-r--r--   0        0        0     1712 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_testing.py
+-rw-r--r--   0        0        0    67165 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_topology.py
+-rw-r--r--   0        0        0     4607 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_transform.py
+-rw-r--r--   0        0        0    20363 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_transformseq.py
+-rw-r--r--   0        0        0    23999 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_types.py
+-rw-r--r--   0        0        0     2317 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_unit.py
+-rw-r--r--   0        0        0    12562 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_util.py
+-rw-r--r--   0        0        0      379 2024-05-09 09:27:53.846973 nutils-8.7/tests/test_warnings.py
+-rw-r--r--   0        0        0     7011 1970-01-01 00:00:00.000000 nutils-8.7/PKG-INFO
```

### Comparing `nutils-8.6/.github/workflows/release.yml` & `nutils-8.7/.github/workflows/release.yml`

 * *Files identical despite different names*

### Comparing `nutils-8.6/.github/workflows/test.yaml` & `nutils-8.7/.github/workflows/test.yaml`

 * *Files 0% similar despite different names*

```diff
@@ -98,15 +98,15 @@
           python -um pip install "$_wheel[import_gmsh,export_mpl]"
       - name: Install Scipy
         if: ${{ matrix.matrix-backend == 'scipy' }}
         run: python -um pip install --upgrade scipy
       - name: Configure MKL
         if: ${{ matrix.matrix-backend == 'mkl' }}
         run: |
-          python -um pip install --upgrade --upgrade-strategy eager 'mkl<2024'
+          python -um pip install --upgrade --upgrade-strategy eager mkl
           python -um devtools.gha.configure_mkl
       - name: Test
         run: python -um coverage run -m unittest discover -b -q -t . -s tests
       - name: Post-process coverage
         run: python -um devtools.gha.coverage_report_xml
       - name: Upload coverage
         uses: codecov/codecov-action@v3
```

### Comparing `nutils-8.6/CHANGELOG` & `nutils-8.7/CHANGELOG`

 * *Files identical despite different names*

### Comparing `nutils-8.6/LICENSE` & `nutils-8.7/LICENSE`

 * *Files identical despite different names*

### Comparing `nutils-8.6/README.md` & `nutils-8.7/README.md`

 * *Files identical despite different names*

### Comparing `nutils-8.6/devtools/__init__.py` & `nutils-8.7/devtools/__init__.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/devtools/_git.py` & `nutils-8.7/devtools/_git.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/devtools/_log_default.py` & `nutils-8.7/devtools/_log_default.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/devtools/_log_gha.py` & `nutils-8.7/devtools/_log_gha.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/devtools/container/__init__.py` & `nutils-8.7/devtools/container/__init__.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/devtools/container/build.py` & `nutils-8.7/devtools/container/build.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/devtools/container/build_base.py` & `nutils-8.7/devtools/container/build_base.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/devtools/gha/configure_mkl.py` & `nutils-8.7/devtools/gha/configure_mkl.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/devtools/gha/coverage_report_xml.py` & `nutils-8.7/devtools/gha/coverage_report_xml.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/devtools/gha/get_base_and_image_tags.py` & `nutils-8.7/devtools/gha/get_base_and_image_tags.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/docs/_templates/breadcrumbs.html` & `nutils-8.7/docs/_templates/breadcrumbs.html`

 * *Files identical despite different names*

### Comparing `nutils-8.6/docs/conf.py` & `nutils-8.7/docs/conf.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/docs/favicon.ico` & `nutils-8.7/docs/favicon.ico`

 * *Files identical despite different names*

### Comparing `nutils-8.6/docs/sphinx_mods.py` & `nutils-8.7/docs/sphinx_mods.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/examples/adaptivity.py` & `nutils-8.7/examples/adaptivity.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/examples/burgers.py` & `nutils-8.7/examples/burgers.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/examples/cahnhilliard.py` & `nutils-8.7/examples/cahnhilliard.py`

 * *Files 5% similar despite different names*

```diff
@@ -242,30 +242,30 @@
                 eNoBYgCd/3TIkccBNkQ6IDqIN4HMF8cSx9Y02DmdOVHLMcecxxLIEjQUOAHOa8a1xWw3izb1M9kzPMc0
                 xmnGpzibODY359ETyJHHp8hbyWU2xzZSydfIOsrNyo3GjMjAyyXIm8hkzD3K1ggxvA==''')
 
     def test_multipatchcircle(self):
         args = main(epsilon=parse('5cm'), mobility=parse('1μL*s/kg'), nelems=3, etype='multipatch', degree=2, timestep=parse('1h'), endtime=parse('2h'))
         with self.subTest('concentration'):
             self.assertAlmostEqual64(args['φ'], '''
-                eNoNyE9Ik3EYB3BwZohodpCSIk9NQub7/n7PA5IHu7Y6xKBbgUQK0mGUMIS6jIgmJRZitc3MEi/VxQVz
-                XsouDcHn+7w///B22HYU/wTBOuwUmcfPp8Yhr/JfrnOJJ3iU2/g1X+YHXKMcrdnvVLYt9NwMmlTfBn2g
-                ZhL71OZMl214H72yu+6KmtFdpPxFbzjcu3Rl59rmafdMe1xVS7iFdk2jKdjRcb0JHxGQhriDs/oeoRTk
-                SMoyiJN4JVl5I7OSdLeDqJ6y2ybtj6Ahb8NDXTr+PLpRoEWy9If2qUCz9oV/n+ZsJajil9/hcvyS77JS
-                iSbJcJEStGxbqWC+mHp/zc7bIdttV82cv2aS/ufYuOurLATr2qPzXjX2wx3qCZ1AHMbNBBVd8rZiDXdD
-                v+FM0KEJdGIEXfhtHppJ7ypdpEf2yGV0zER60ziPBc2ik/9Rltpp2tituCb6c8G5YBcHGEAU21KUKXmC
-                ZlzAT3knjyUvn+SefJVNWTl2TXrxHyMaybw=''')
+                eNoNwk1I02EcB/AGnYQCQcvDBqYYVGz7P8/v93QIyhdYK8lyDktKx8ouQ0hz6EEdjOpWdIqCXrAONrAg
+                AhGGBSHhxe/v+f//8yVpWIGXgk5DSAjf+HzyZsKkTZv5xdf5PN01A8aYCndwgrKq2hw0bzjEtfTdmfIK
+                /JBX6Z2eiN6zz+Uf+bSt76g635WoFHVO59SfyFE3KxsIqU2nyZmMOF6rjclbeSTDcmNfv3RLFEEoXEIe
+                s/iKT3iMJ3iJaczgPUL2s4wISQVFvEBKG92oLkSSblGCEuezvEgnKKOueWXp46tczz/pMI2qW94DkzPt
+                5pDJ8yx16Sqzw/M8xt+orCvObb7IB7hAazql5laDtK4zuqSGnd3lTrcuHCid9pLumh20W7JQivkfXbFL
+                ckq+oDV6LHzTv+8esc0iOKOeOqlIjT9oe6SMBBE906/V35N52y9JjvMPukxLaqh03DasxN0tGZD/2JaU
+                /MYCpvABWZzDFaQxjl60YAgFdKMT7XiFgOwBQRG+vg==''')
         with self.subTest('chemical-potential'):
             self.assertAlmostEqual64(args['η'], '''
-                eNoBggF9/lU4VTgzOIo4kDhIOCY3Lzd5Ngw4xjf1N1o3YzV70II3ijZoNuIyZcpFybM1jjXxzgY28TVH
-                zyLKzMjGyXfICsjfx73Hl8dyMzozgstEylLKFsqEyU3I2snuyJvHZMc7yLzHKctJy6rKqci4yGDIrcqK
-                yvLID8royADInMcIyJ7HI8jnx13HcMdax2fHWNPez6/JHzZENjI1V8jHx7AxHMpqx2PHpMgAyDk4SDgR
-                OH84gThhONA3ejY/OJw3Y84NyYY2C8x1NqU2BjfJyQTKYC9rN303ATZmNnY3TTaMNmI0e8mFyf3KKjYz
-                Nj80DDD+Mn3MhsqCM/bLsslNyRo3BzcuNUbLEMk7yDfI0snXyWjJu817zdTK+8hRyLPJt8jYx4/HEMiy
-                x5wzXTNbzP02CTdQNmLKFslCNc7MRcjSx5DJZ8hiOG04JDjJN4020jBZySIwQsvxyJDInMlnyCzIxMes
-                x3DHmMeAx1fHVMdfx0vHS8dsxzzHl8csxz3HSceixxfIfsLEFg==''')
+                eNoN0F8onWEcB/AjQ1pNoZb8u8Ki0HvO+zy/F4uJ2eTG7I9W1q602toOdS4pIXZSs+zUpJN2ywXJboTE
+                /H7f53lf08nalZqkJldGmXYzbj+Xn2X6StM0RKf6v0rtvKS3dI8yqFOd2W5k0i3K0MfhLPNeiuQ+NVC6
+                O4NK6ec33ESKYu4/PJdJjnGzJm0jIRvIT45zcnc19SVo9PPMX3FkClOYxBg+YxuMqmt5KsOyJ9UoQ1Jm
+                RORCbuI2DuQAh/iNfbxCCPOSr+v0kKp1e/yQKUSH99g7olZKKt8HHE956d4G/dLFasXGKUHvqIXiulnN
+                +7m6TEf1pm7TnaokcMMPw2nK1eeqVtUEp86WMxuei9REup1Rm/P9xk6j32XJ1tmPZs2kTML0mj6sSYVs
+                mxPzw6pgwNQjKgmzZKr8wVSBncaieOq1unSb3PLgkSnFChlqp096ws3y15GNdowgiif4w3fkhYzLkjzg
+                AV7kM74rz/gDf+M8iV0fLvAxt8mWXAGfucYq''')
 
 
 if __name__ == '__main__':
     from nutils import cli
     cli.run(main)
```

### Comparing `nutils-8.6/examples/coil.py` & `nutils-8.7/examples/coil.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/examples/cylinderflow.py` & `nutils-8.7/examples/cylinderflow.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/examples/drivencavity.py` & `nutils-8.7/examples/drivencavity.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/examples/elasticity.py` & `nutils-8.7/examples/elasticity.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/examples/finitestrain.py` & `nutils-8.7/examples/finitestrain.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/examples/laplace.py` & `nutils-8.7/examples/laplace.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/examples/platewithhole.py` & `nutils-8.7/examples/platewithhole.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/examples/poisson.py` & `nutils-8.7/examples/poisson.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/examples/torsion.py` & `nutils-8.7/examples/torsion.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/SI.py` & `nutils-8.7/nutils/SI.py`

 * *Files 1% similar despite different names*

```diff
@@ -367,21 +367,21 @@
 
     @register('pow', 'power', 'jacobian')
     def __pow_like(op, *args, **kwargs):
         (dim0, arg0), = Quantity.__unpack(args[0])
         return (dim0**args[1]).wrap(op(arg0, *args[1:], **kwargs))
 
     @register('isfinite', 'isnan', 'shape', 'ndim', 'size', 'normal', 'normalized')
-    def __unary_drop(op, *args, **kwargs):
+    def __unary_op(op, *args, **kwargs):
         (_dim0, arg0), = Quantity.__unpack(args[0])
         return op(arg0, *args[1:], **kwargs)
 
     @register('lt', 'le', 'eq', 'ne', 'gt', 'ge', 'equal', 'not_equal', 'less',
               'less_equal', 'greater', 'greater_equal')
-    def __binary_drop(op, *args, **kwargs):
+    def __binary_op(op, *args, **kwargs):
         (dim0, arg0), (dim1, arg1) = Quantity.__unpack(args[0], args[1])
         if dim0 != dim1:
             raise TypeError(f'incompatible arguments for {op.__name__}: {dim0.__name__}, {dim1.__name__}')
         return op(arg0, arg1, *args[2:], **kwargs)
 
     @register('stack', 'concatenate')
     def __stack_like(op, *args, **kwargs):
```

### Comparing `nutils-8.6/nutils/__init__.py` & `nutils-8.7/nutils/__init__.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 'Numerical Utilities for Finite Element Analysis'
 
-__version__ = version = '8.6'
+__version__ = version = '8.7'
 version_name = 'idiyappam'
 long_version = ('{} "{}"' if version_name else '{}').format(version, version_name)
 
 __all__ = [
     'cache',
     'cli',
     'element',
```

### Comparing `nutils-8.6/nutils/_backports.py` & `nutils-8.7/nutils/_backports.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/_graph.py` & `nutils-8.7/nutils/_graph.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/_util.py` & `nutils-8.7/nutils/_util.py`

 * *Files 2% similar despite different names*

```diff
@@ -515,15 +515,15 @@
     @functools.wraps(f)
     def log_arguments(*args, **kwargs):
         bound = sig.bind(*args, **kwargs)
         bound.apply_defaults()
         with treelog.context('arguments'):
             for k, v in bound.arguments.items():
                 try:
-                    s = stringly.dumps(sig.parameters[k].annotation, v)
+                    s = stringly.dumps(_infer_type(sig.parameters[k]), v)
                 except:
                     s = str(v)
                 treelog.info(f'{k}={s}')
         return f(*args, **kwargs)
 
     return log_arguments
 
@@ -690,31 +690,37 @@
             with treelog.set(htmllog):
                 treelog.error(f'{e.__class__.__name__}: {e}')
             raise
         finally:
             treelog.info(f'log written to: {loguri}')
 
 
+def _infer_type(param):
+    '''Infer argument type from annotation or default value.'''
+
+    if param.annotation is not param.empty:
+        return param.annotation
+    if param.default is not param.empty:
+        return type(param.default)
+    raise Exception(f'cannot determine type for argument {param.name!r}')
+
+
 def cli(f, *, argv=None):
     '''Call a function using command line arguments.'''
 
     import textwrap
 
     progname, *args = argv or sys.argv
     doc = stringly.util.DocString(f)
     serializers = {}
     booleans = set()
     mandatory = set()
 
     for param in inspect.signature(f).parameters.values():
-        T = param.annotation
-        if T == param.empty and param.default != param.empty:
-            T = type(param.default)
-        if T == param.empty:
-            raise Exception(f'cannot determine type for argument {param.name!r}')
+        T = _infer_type(param)
         try:
             s = stringly.serializer.get(T)
         except Exception as e:
             raise Exception(f'stringly cannot deserialize argument {param.name!r} of type {T}') from e
         if param.kind not in (param.POSITIONAL_OR_KEYWORD, param.KEYWORD_ONLY):
             raise Exception(f'argument {param.name!r} is positional-only')
         if param.default is param.empty and param.name not in doc.defaults:
```

### Comparing `nutils-8.6/nutils/cache.py` & `nutils-8.7/nutils/cache.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/cli.py` & `nutils-8.7/nutils/cli.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/element.py` & `nutils-8.7/nutils/element.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/elementseq.py` & `nutils-8.7/nutils/elementseq.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/evaluable.py` & `nutils-8.7/nutils/evaluable.py`

 * *Files 1% similar despite different names*

```diff
@@ -1015,11496 +1015,11512 @@
 00003f60: 6469 6365 7329 2069 6e20 656e 756d 6572  dices) in enumer
 00003f70: 6174 6528 7365 6c66 2e73 6572 6961 6c69  ate(self.seriali
 00003f80: 7a65 642c 2073 7461 7274 3d31 293a 0a20  zed, start=1):. 
 00003f90: 2020 2020 2020 2020 2020 2073 203d 205b             s = [
 00003fa0: 6627 257b 697d 203d 207b 6f70 7d27 5d0a  f'%{i} = {op}'].
 00003fb0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
 00003fc0: 6e64 6963 6573 3a0a 2020 2020 2020 2020  ndices:.        
-00003fd0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00003fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ff0: 2073 6967 203d 2069 6e73 7065 6374 2e73   sig = inspect.s
-00004000: 6967 6e61 7475 7265 286f 702e 6576 616c  ignature(op.eval
-00004010: 6629 0a20 2020 2020 2020 2020 2020 2020  f).             
-00004020: 2020 2065 7863 6570 7420 5661 6c75 6545     except ValueE
-00004030: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-00004040: 2020 2020 2020 2020 2020 732e 6578 7465            s.exte
-00004050: 6e64 2866 2725 7b69 7d27 2066 6f72 2069  nd(f'%{i}' for i
-00004060: 2069 6e20 696e 6469 6365 7329 0a20 2020   in indices).   
-00004070: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00004080: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00004090: 2020 2020 2020 2073 2e65 7874 656e 6428         s.extend(
-000040a0: 6627 7b70 6172 616d 7d3d 257b 697d 2720  f'{param}=%{i}' 
-000040b0: 666f 7220 7061 7261 6d2c 2069 2069 6e20  for param, i in 
-000040c0: 7a69 7028 7369 672e 7061 7261 6d65 7465  zip(sig.paramete
-000040d0: 7273 2c20 696e 6469 6365 7329 290a 2020  rs, indices)).  
-000040e0: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
-000040f0: 2720 272e 6a6f 696e 2873 290a 0a20 2020  ' '.join(s)..   
-00004100: 2064 6566 205f 666f 726d 6174 5f73 7461   def _format_sta
-00004110: 636b 2873 656c 662c 2076 616c 7565 732c  ck(self, values,
-00004120: 2065 293a 0a20 2020 2020 2020 206c 696e   e):.        lin
-00004130: 6573 203d 205b 6627 6576 616c 7561 7469  es = [f'evaluati
-00004140: 6f6e 2066 6169 6c65 6420 696e 2073 7465  on failed in ste
-00004150: 7020 7b6c 656e 2876 616c 7565 7329 7d2f  p {len(values)}/
-00004160: 7b6c 656e 2873 656c 662e 6465 7065 6e64  {len(self.depend
-00004170: 656e 6369 6573 292b 317d 275d 0a20 2020  encies)+1}'].   
-00004180: 2020 2020 2073 7461 636b 203d 2073 656c       stack = sel
-00004190: 662e 5f69 7465 725f 7374 6163 6b28 290a  f._iter_stack().
-000041a0: 2020 2020 2020 2020 666f 7220 762c 206f          for v, o
-000041b0: 7020 696e 207a 6970 2876 616c 7565 732c  p in zip(values,
-000041c0: 2073 7461 636b 293a 2023 204e 4f54 4520   stack): # NOTE 
-000041d0: 7661 6c75 6573 206d 7573 7420 636f 6d65  values must come
-000041e0: 2066 6972 7374 2074 6f20 6176 6f69 6420   first to avoid 
-000041f0: 706f 7070 696e 6720 6e65 7874 2069 7465  popping next ite
-00004200: 6d20 6672 6f6d 2073 7461 636b 0a20 2020  m from stack.   
-00004210: 2020 2020 2020 2020 2073 203d 2066 277b           s = f'{
-00004220: 7479 7065 2876 292e 5f5f 6e61 6d65 5f5f  type(v).__name__
-00004230: 7d27 0a20 2020 2020 2020 2020 2020 2069  }'.            i
-00004240: 6620 6e75 6d65 7269 632e 6973 6172 7261  f numeric.isarra
-00004250: 7928 7629 3a0a 2020 2020 2020 2020 2020  y(v):.          
-00004260: 2020 2020 2020 7320 2b3d 2066 273c 7b76        s += f'<{v
-00004270: 2e64 7479 7065 2e6b 696e 647d 3a7b 222c  .dtype.kind}:{",
-00004280: 222e 6a6f 696e 2873 7472 286e 2920 666f  ".join(str(n) fo
-00004290: 7220 6e20 696e 2076 2e73 6861 7065 297d  r n in v.shape)}
-000042a0: 3e27 0a20 2020 2020 2020 2020 2020 206c  >'.            l
-000042b0: 696e 6573 2e61 7070 656e 6428 6627 7b6f  ines.append(f'{o
-000042c0: 707d 202d 2d3e 207b 737d 2729 0a20 2020  p} --> {s}').   
-000042d0: 2020 2020 206c 696e 6573 2e61 7070 656e       lines.appen
-000042e0: 6428 6627 7b6e 6578 7428 7374 6163 6b29  d(f'{next(stack)
-000042f0: 7d20 2d2d 3e20 7b65 7d27 290a 2020 2020  } --> {e}').    
-00004300: 2020 2020 7265 7475 726e 2027 5c6e 2020      return '\n  
-00004310: 272e 6a6f 696e 286c 696e 6573 290a 0a20  '.join(lines).. 
-00004320: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-00004330: 2040 7265 706c 6163 6528 6465 7074 6866   @replace(depthf
-00004340: 6972 7374 3d54 7275 652c 2072 6563 7572  irst=True, recur
-00004350: 7369 7665 3d54 7275 6529 0a20 2020 2064  sive=True).    d
-00004360: 6566 2073 696d 706c 6966 6965 6428 6f62  ef simplified(ob
-00004370: 6a29 3a0a 2020 2020 2020 2020 6966 2069  j):.        if i
-00004380: 7369 6e73 7461 6e63 6528 6f62 6a2c 2045  sinstance(obj, E
-00004390: 7661 6c75 6162 6c65 293a 0a20 2020 2020  valuable):.     
-000043a0: 2020 2020 2020 2072 6574 7661 6c20 3d20         retval = 
-000043b0: 6f62 6a2e 5f73 696d 706c 6966 6965 6428  obj._simplified(
-000043c0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-000043d0: 2072 6574 7661 6c20 6973 206e 6f74 204e   retval is not N
-000043e0: 6f6e 6520 616e 6420 6973 696e 7374 616e  one and isinstan
-000043f0: 6365 286f 626a 2c20 4172 7261 7929 3a0a  ce(obj, Array):.
-00004400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004410: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-00004420: 6528 7265 7476 616c 2c20 4172 7261 7929  e(retval, Array)
-00004430: 2061 6e64 2065 7175 616c 7368 6170 6528   and equalshape(
-00004440: 7265 7476 616c 2e73 6861 7065 2c20 6f62  retval.shape, ob
-00004450: 6a2e 7368 6170 6529 2061 6e64 2072 6574  j.shape) and ret
-00004460: 7661 6c2e 6474 7970 6520 3d3d 206f 626a  val.dtype == obj
-00004470: 2e64 7479 7065 2c20 277b 7d20 2d2d 7369  .dtype, '{} --si
-00004480: 6d70 6c69 6679 2d2d 3e20 7b7d 272e 666f  mplify--> {}'.fo
-00004490: 726d 6174 286f 626a 2c20 7265 7476 616c  rmat(obj, retval
-000044a0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-000044b0: 7475 726e 2072 6574 7661 6c0a 0a20 2020  turn retval..   
-000044c0: 2064 6566 205f 7369 6d70 6c69 6669 6564   def _simplified
-000044d0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000044e0: 7265 7475 726e 0a0a 2020 2020 4063 6163  return..    @cac
-000044f0: 6865 645f 7072 6f70 6572 7479 0a20 2020  hed_property.   
-00004500: 2064 6566 206f 7074 696d 697a 6564 5f66   def optimized_f
-00004510: 6f72 5f6e 756d 7079 2873 656c 6629 3a0a  or_numpy(self):.
-00004520: 2020 2020 2020 2020 7265 7476 616c 203d          retval =
-00004530: 2073 656c 662e 7369 6d70 6c69 6669 6564   self.simplified
-00004540: 2e5f 6f70 7469 6d69 7a65 645f 666f 725f  ._optimized_for_
-00004550: 6e75 6d70 7931 2829 206f 7220 7365 6c66  numpy1() or self
-00004560: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00004570: 7265 7476 616c 2e5f 636f 6d62 696e 655f  retval._combine_
-00004580: 6c6f 6f70 5f63 6f6e 6361 7465 6e61 7465  loop_concatenate
-00004590: 7328 6672 6f7a 656e 7365 7428 2929 0a0a  s(frozenset())..
-000045a0: 2020 2020 4072 6570 6c61 6365 2864 6570      @replace(dep
-000045b0: 7468 6669 7273 743d 5472 7565 2c20 7265  thfirst=True, re
-000045c0: 6375 7273 6976 653d 5472 7565 290a 2020  cursive=True).  
-000045d0: 2020 6465 6620 5f6f 7074 696d 697a 6564    def _optimized
-000045e0: 5f66 6f72 5f6e 756d 7079 3128 6f62 6a29  _for_numpy1(obj)
-000045f0: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-00004600: 6e73 7461 6e63 6528 6f62 6a2c 2045 7661  nstance(obj, Eva
-00004610: 6c75 6162 6c65 293a 0a20 2020 2020 2020  luable):.       
-00004620: 2020 2020 2072 6574 7661 6c20 3d20 6f62       retval = ob
-00004630: 6a2e 5f73 696d 706c 6966 6965 6428 2920  j._simplified() 
-00004640: 6f72 206f 626a 2e5f 6f70 7469 6d69 7a65  or obj._optimize
-00004650: 645f 666f 725f 6e75 6d70 7928 290a 2020  d_for_numpy().  
-00004660: 2020 2020 2020 2020 2020 6966 2072 6574            if ret
-00004670: 7661 6c20 6973 206e 6f74 204e 6f6e 6520  val is not None 
-00004680: 616e 6420 6973 696e 7374 616e 6365 286f  and isinstance(o
-00004690: 626a 2c20 4172 7261 7929 3a0a 2020 2020  bj, Array):.    
-000046a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000046b0: 7274 2069 7369 6e73 7461 6e63 6528 7265  rt isinstance(re
-000046c0: 7476 616c 2c20 4172 7261 7929 2061 6e64  tval, Array) and
-000046d0: 2065 7175 616c 7368 6170 6528 7265 7476   equalshape(retv
-000046e0: 616c 2e73 6861 7065 2c20 6f62 6a2e 7368  al.shape, obj.sh
-000046f0: 6170 6529 2c20 277b 307d 2e5f 6f70 7469  ape), '{0}._opti
-00004700: 6d69 7a65 645f 666f 725f 6e75 6d70 7920  mized_for_numpy 
-00004710: 6f72 207b 307d 2e5f 7369 6d70 6c69 6669  or {0}._simplifi
-00004720: 6564 2072 6573 756c 7465 6420 696e 2073  ed resulted in s
-00004730: 6861 7065 2063 6861 6e67 6527 2e66 6f72  hape change'.for
-00004740: 6d61 7428 7479 7065 286f 626a 292e 5f5f  mat(type(obj).__
-00004750: 6e61 6d65 5f5f 290a 2020 2020 2020 2020  name__).        
-00004760: 2020 2020 7265 7475 726e 2072 6574 7661      return retva
-00004770: 6c0a 0a20 2020 2064 6566 205f 6f70 7469  l..    def _opti
-00004780: 6d69 7a65 645f 666f 725f 6e75 6d70 7928  mized_for_numpy(
-00004790: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
-000047a0: 6574 7572 6e0a 0a20 2020 2040 6361 6368  eturn..    @cach
-000047b0: 6564 5f70 726f 7065 7274 790a 2020 2020  ed_property.    
-000047c0: 6465 6620 5f6c 6f6f 705f 636f 6e63 6174  def _loop_concat
-000047d0: 656e 6174 655f 6465 7073 2873 656c 6629  enate_deps(self)
-000047e0: 3a0a 2020 2020 2020 2020 6465 7073 203d  :.        deps =
-000047f0: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
-00004800: 6172 6720 696e 2073 656c 662e 5f5f 6172  arg in self.__ar
-00004810: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00004820: 6465 7073 202b 3d20 5b64 6570 2066 6f72  deps += [dep for
-00004830: 2064 6570 2069 6e20 6172 672e 5f6c 6f6f   dep in arg._loo
-00004840: 705f 636f 6e63 6174 656e 6174 655f 6465  p_concatenate_de
-00004850: 7073 2069 6620 6465 7020 6e6f 7420 696e  ps if dep not in
-00004860: 2064 6570 735d 0a20 2020 2020 2020 2072   deps].        r
-00004870: 6574 7572 6e20 7475 706c 6528 6465 7073  eturn tuple(deps
-00004880: 290a 0a20 2020 2064 6566 205f 636f 6d62  )..    def _comb
-00004890: 696e 655f 6c6f 6f70 5f63 6f6e 6361 7465  ine_loop_concate
-000048a0: 6e61 7465 7328 7365 6c66 2c20 6f75 7465  nates(self, oute
-000048b0: 725f 6578 636c 7564 6529 3a0a 2020 2020  r_exclude):.    
-000048c0: 2020 2020 7768 696c 6520 5472 7565 3a0a      while True:.
-000048d0: 2020 2020 2020 2020 2020 2020 6578 636c              excl
-000048e0: 7564 6520 3d20 7365 7428 6f75 7465 725f  ude = set(outer_
-000048f0: 6578 636c 7564 6529 0a20 2020 2020 2020  exclude).       
-00004900: 2020 2020 2063 6f6d 6269 6e65 203d 207b       combine = {
-00004910: 7d0a 2020 2020 2020 2020 2020 2020 2320  }.            # 
-00004920: 436f 6c6c 6563 7420 616c 6c20 746f 702d  Collect all top-
-00004930: 6c65 7665 6c20 604c 6f6f 7043 6f6e 6361  level `LoopConca
-00004940: 7465 6e61 7465 6020 696e 7374 616e 6365  tenate` instance
-00004950: 7320 696e 2060 636f 6d62 696e 6560 2061  s in `combine` a
-00004960: 6e64 2061 6c6c 0a20 2020 2020 2020 2020  nd all.         
-00004970: 2020 2023 2074 6865 6972 2064 6570 656e     # their depen
-00004980: 6465 6e74 2060 4c6f 6f70 436f 6e63 6174  dent `LoopConcat
-00004990: 656e 6174 6560 2069 6e73 7461 6e63 6573  enate` instances
-000049a0: 2069 6e20 6065 7863 6c75 6465 602e 0a20   in `exclude`.. 
-000049b0: 2020 2020 2020 2020 2020 2066 6f72 206c             for l
-000049c0: 6320 696e 2073 656c 662e 5f6c 6f6f 705f  c in self._loop_
-000049d0: 636f 6e63 6174 656e 6174 655f 6465 7073  concatenate_deps
-000049e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000049f0: 2020 6c63 7320 3d20 636f 6d62 696e 652e    lcs = combine.
-00004a00: 7365 7464 6566 6175 6c74 286c 632e 696e  setdefault(lc.in
-00004a10: 6465 782c 205b 5d29 0a20 2020 2020 2020  dex, []).       
-00004a20: 2020 2020 2020 2020 2069 6620 6c63 206e           if lc n
-00004a30: 6f74 2069 6e20 6c63 733a 0a20 2020 2020  ot in lcs:.     
-00004a40: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00004a50: 6373 2e61 7070 656e 6428 6c63 290a 2020  cs.append(lc).  
-00004a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004a70: 2020 6578 636c 7564 652e 7570 6461 7465    exclude.update
-00004a80: 2873 6574 286c 632e 5f6c 6f6f 705f 636f  (set(lc._loop_co
-00004a90: 6e63 6174 656e 6174 655f 6465 7073 2920  ncatenate_deps) 
-00004aa0: 2d20 7b6c 637d 290a 2020 2020 2020 2020  - {lc}).        
-00004ab0: 2020 2020 2320 436f 6d62 696e 6520 746f      # Combine to
-00004ac0: 702d 6c65 7665 6c20 604c 6f6f 7043 6f6e  p-level `LoopCon
-00004ad0: 6361 7465 6e61 7465 6020 696e 7374 616e  catenate` instan
-00004ae0: 6365 7320 6578 636c 7564 696e 6720 7468  ces excluding th
-00004af0: 6f73 6520 696e 0a20 2020 2020 2020 2020  ose in.         
-00004b00: 2020 2023 2060 6578 636c 7564 6560 2e0a     # `exclude`..
-00004b10: 2020 2020 2020 2020 2020 2020 7265 706c              repl
-00004b20: 6163 656d 656e 7473 203d 207b 7d0a 2020  acements = {}.  
-00004b30: 2020 2020 2020 2020 2020 666f 7220 696e            for in
-00004b40: 6465 782c 206c 6373 2069 6e20 636f 6d62  dex, lcs in comb
-00004b50: 696e 652e 6974 656d 7328 293a 0a20 2020  ine.items():.   
-00004b60: 2020 2020 2020 2020 2020 2020 206c 6373               lcs
-00004b70: 203d 205b 6c63 2066 6f72 206c 6320 696e   = [lc for lc in
-00004b80: 206c 6373 2069 6620 6c63 206e 6f74 2069   lcs if lc not i
-00004b90: 6e20 6578 636c 7564 655d 0a20 2020 2020  n exclude].     
-00004ba0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00004bb0: 7420 6c63 733a 0a20 2020 2020 2020 2020  t lcs:.         
-00004bc0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00004bd0: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-00004be0: 2020 2020 2320 5765 2772 6520 6578 7472      # We're extr
-00004bf0: 6163 7469 6e67 2064 6174 6120 6672 6f6d  acting data from
-00004c00: 2060 4c6f 6f70 436f 6e63 6174 656e 6174   `LoopConcatenat
-00004c10: 6560 2069 6e20 6661 766f 7220 6f66 2075  e` in favor of u
-00004c20: 7369 6e67 0a20 2020 2020 2020 2020 2020  sing.           
-00004c30: 2020 2020 2023 2060 6c6f 6f70 5f63 6f6e       # `loop_con
-00004c40: 6361 7465 6e61 7465 5f63 6f6d 6269 6e65  catenate_combine
-00004c50: 6428 6c63 732c 202e 2e2e 2960 2062 6563  d(lcs, ...)` bec
-00004c60: 6175 7365 2074 6865 206c 6174 6572 2072  ause the later r
-00004c70: 6571 7569 7265 730a 2020 2020 2020 2020  equires.        
-00004c80: 2020 2020 2020 2020 2320 7265 6170 706c          # reappl
-00004c90: 7969 6e67 2073 696d 706c 6966 6963 6174  ying simplificat
-00004ca0: 696f 6e73 2074 6861 7420 6172 6520 616c  ions that are al
-00004cb0: 7265 6164 7920 6170 706c 6965 6420 696e  ready applied in
-00004cc0: 2074 6865 2066 6f72 6d65 722e 0a20 2020   the former..   
-00004cd0: 2020 2020 2020 2020 2020 2020 2023 2046               # F
-00004ce0: 6f72 2065 7861 6d70 6c65 2c20 696e 2060  or example, in `
-00004cf0: 6c6f 6f70 5f63 6f6e 6361 7465 6e61 7465  loop_concatenate
-00004d00: 5f63 6f6d 6269 6e65 6460 2074 6865 206f  _combined` the o
-00004d10: 6666 7365 7473 2028 7573 6564 2062 790a  ffsets (used by.
-00004d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d30: 2320 7374 6172 742c 2073 746f 7020 616e  # start, stop an
-00004d40: 6420 7468 6520 636f 6e63 6174 656e 6174  d the concatenat
-00004d50: 696f 6e20 6c65 6e67 7468 2920 6172 6520  ion length) are 
-00004d60: 666f 726d 6564 2062 790a 2020 2020 2020  formed by.      
-00004d70: 2020 2020 2020 2020 2020 2320 606c 6f6f            # `loo
-00004d80: 705f 636f 6e63 6174 656e 6174 6560 2d69  p_concatenate`-i
-00004d90: 6e67 2060 6675 6e63 2e73 6861 7065 5b2d  ng `func.shape[-
-00004da0: 315d 602e 2049 6620 7468 6520 7368 6170  1]`. If the shap
-00004db0: 6520 6973 2063 6f6e 7374 616e 742c 0a20  e is constant,. 
-00004dc0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00004dd0: 2074 6869 7320 6361 6e20 6265 2073 696d   this can be sim
-00004de0: 706c 6966 6965 6420 746f 2061 2060 5261  plified to a `Ra
-00004df0: 6e67 6560 2e0a 2020 2020 2020 2020 2020  nge`..          
-00004e00: 2020 2020 2020 6461 7461 203d 2054 7570        data = Tup
-00004e10: 6c65 2874 7570 6c65 2854 7570 6c65 286c  le(tuple(Tuple(l
-00004e20: 632e 6675 6e63 6461 7461 2920 666f 7220  c.funcdata) for 
-00004e30: 6c63 2069 6e20 6c63 7329 290a 2020 2020  lc in lcs)).    
-00004e40: 2020 2020 2020 2020 2020 2020 2320 436f              # Co
-00004e50: 6d62 696e 6520 604c 6f6f 7043 6f6e 6361  mbine `LoopConca
-00004e60: 7465 6e61 7465 6020 696e 7374 616e 6365  tenate` instance
-00004e70: 7320 696e 2060 6461 7461 6020 6578 636c  s in `data` excl
-00004e80: 7564 696e 670a 2020 2020 2020 2020 2020  uding.          
-00004e90: 2020 2020 2020 2320 606f 7574 6572 5f65        # `outer_e
-00004ea0: 7863 6c75 6465 6020 616e 6420 7468 6f73  xclude` and thos
-00004eb0: 6520 7468 6174 2077 696c 6c20 6265 2070  e that will be p
-00004ec0: 726f 6365 7373 6564 2069 6e20 6120 7375  rocessed in a su
-00004ed0: 6273 6571 7565 6e74 206c 6f6f 700a 2020  bsequent loop.  
-00004ee0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00004ef0: 2874 6865 2072 656d 6169 6e64 6572 206f  (the remainder o
-00004f00: 6620 6065 7863 6c75 6465 6029 2e20 5468  f `exclude`). Th
-00004f10: 6520 6c61 7474 6572 2063 6f6e 7369 7374  e latter consist
-00004f20: 7320 6f66 206c 6f6f 7073 2074 6861 7420  s of loops that 
-00004f30: 6172 650a 2020 2020 2020 2020 2020 2020  are.            
-00004f40: 2020 2020 2320 696e 7661 7269 616e 7420      # invariant 
-00004f50: 772e 722e 742e 2074 6865 2063 7572 7265  w.r.t. the curre
-00004f60: 6e74 206c 6f6f 7020 6069 6e64 6578 602e  nt loop `index`.
-00004f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004f80: 2064 6174 6120 3d20 6461 7461 2e5f 636f   data = data._co
-00004f90: 6d62 696e 655f 6c6f 6f70 5f63 6f6e 6361  mbine_loop_conca
-00004fa0: 7465 6e61 7465 7328 6578 636c 7564 6529  tenates(exclude)
-00004fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004fc0: 2063 6f6d 6269 6e65 6420 3d20 4c6f 6f70   combined = Loop
-00004fd0: 436f 6e63 6174 656e 6174 6543 6f6d 6269  ConcatenateCombi
-00004fe0: 6e65 6428 7475 706c 6528 6d61 7028 7475  ned(tuple(map(tu
-00004ff0: 706c 652c 2064 6174 6129 292c 2069 6e64  ple, data)), ind
-00005000: 6578 2e5f 6e61 6d65 2c20 696e 6465 782e  ex._name, index.
-00005010: 6c65 6e67 7468 290a 2020 2020 2020 2020  length).        
-00005020: 2020 2020 2020 2020 666f 7220 692c 206c          for i, l
-00005030: 6320 696e 2065 6e75 6d65 7261 7465 286c  c in enumerate(l
-00005040: 6373 293a 0a20 2020 2020 2020 2020 2020  cs):.           
-00005050: 2020 2020 2020 2020 2069 6e74 626f 756e           intboun
-00005060: 6473 203d 2064 6963 7428 7a69 7028 2827  ds = dict(zip(('
-00005070: 5f6c 6f77 6572 272c 2027 5f75 7070 6572  _lower', '_upper
-00005080: 2729 2c20 6c63 2e5f 696e 7462 6f75 6e64  '), lc._intbound
-00005090: 7329 2920 6966 206c 632e 6474 7970 6520  s)) if lc.dtype 
-000050a0: 3d3d 2069 6e74 2065 6c73 6520 7b7d 0a20  == int else {}. 
-000050b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000050c0: 2020 2072 6570 6c61 6365 6d65 6e74 735b     replacements[
-000050d0: 6c63 5d20 3d20 4172 7261 7946 726f 6d54  lc] = ArrayFromT
-000050e0: 7570 6c65 2863 6f6d 6269 6e65 642c 2069  uple(combined, i
-000050f0: 2c20 6c63 2e73 6861 7065 2c20 6c63 2e64  , lc.shape, lc.d
-00005100: 7479 7065 2c20 2a2a 696e 7462 6f75 6e64  type, **intbound
-00005110: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
-00005120: 6620 7265 706c 6163 656d 656e 7473 3a0a  f replacements:.
-00005130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005140: 7365 6c66 203d 2072 6570 6c61 6365 286c  self = replace(l
-00005150: 616d 6264 6120 6b65 793a 2072 6570 6c61  ambda key: repla
-00005160: 6365 6d65 6e74 732e 6765 7428 6b65 7929  cements.get(key)
-00005170: 2069 6620 6973 696e 7374 616e 6365 286b   if isinstance(k
-00005180: 6579 2c20 4c6f 6f70 436f 6e63 6174 656e  ey, LoopConcaten
-00005190: 6174 6529 2065 6c73 6520 4e6f 6e65 2c20  ate) else None, 
-000051a0: 7265 6375 7273 6976 653d 4661 6c73 652c  recursive=False,
-000051b0: 2064 6570 7468 6669 7273 743d 4661 6c73   depthfirst=Fals
-000051c0: 6529 2873 656c 6629 0a20 2020 2020 2020  e)(self).       
-000051d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000051e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000051f0: 6e20 7365 6c66 0a0a 0a63 6c61 7373 2045  n self...class E
-00005200: 5641 4c41 5247 5328 4576 616c 7561 626c  VALARGS(Evaluabl
-00005210: 6529 3a0a 2020 2020 6465 6620 5f5f 696e  e):.    def __in
-00005220: 6974 5f5f 2873 656c 6629 3a0a 2020 2020  it__(self):.    
-00005230: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-00005240: 6974 5f5f 2861 7267 733d 2829 290a 0a20  it__(args=()).. 
-00005250: 2020 2064 6566 205f 6e6f 6465 2873 656c     def _node(sel
-00005260: 662c 2063 6163 6865 2c20 7375 6267 7261  f, cache, subgra
-00005270: 7068 2c20 7469 6d65 7329 3a0a 2020 2020  ph, times):.    
-00005280: 2020 2020 7265 7475 726e 2049 6e76 6973      return Invis
-00005290: 6962 6c65 4e6f 6465 2828 7479 7065 2873  ibleNode((type(s
-000052a0: 656c 6629 2e5f 5f6e 616d 655f 5f2c 205f  elf).__name__, _
-000052b0: 5374 6174 7328 2929 290a 0a0a 4556 414c  Stats()))...EVAL
-000052c0: 4152 4753 203d 2045 5641 4c41 5247 5328  ARGS = EVALARGS(
-000052d0: 290a 0a0a 636c 6173 7320 4576 616c 7561  )...class Evalua
-000052e0: 626c 6543 6f6e 7374 616e 7428 4576 616c  bleConstant(Eval
-000052f0: 7561 626c 6529 3a0a 2020 2020 2727 2745  uable):.    '''E
-00005300: 7661 6c75 6174 6520 746f 2074 6865 2067  valuate to the g
-00005310: 6976 656e 2063 6f6e 7374 616e 7420 7661  iven constant va
-00005320: 6c75 652e 0a0a 2020 2020 5061 7261 6d65  lue...    Parame
-00005330: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-00005340: 2d2d 2d0a 2020 2020 7661 6c75 650a 2020  ---.    value.  
-00005350: 2020 2020 2020 5468 6520 7265 7475 726e        The return
-00005360: 2076 616c 7565 206f 6620 6060 6576 616c   value of ``eval
-00005370: 6060 2e0a 2020 2020 2727 270a 0a20 2020  ``..    '''..   
-00005380: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00005390: 6c66 2c20 7661 6c75 6529 3a0a 2020 2020  lf, value):.    
-000053a0: 2020 2020 7365 6c66 2e76 616c 7565 203d      self.value =
-000053b0: 2076 616c 7565 0a20 2020 2020 2020 2073   value.        s
-000053c0: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
-000053d0: 2829 290a 0a20 2020 2064 6566 2065 7661  ())..    def eva
-000053e0: 6c66 2873 656c 6629 3a0a 2020 2020 2020  lf(self):.      
-000053f0: 2020 7265 7475 726e 2073 656c 662e 7661    return self.va
-00005400: 6c75 650a 0a20 2020 2040 7072 6f70 6572  lue..    @proper
-00005410: 7479 0a20 2020 2064 6566 205f 6e6f 6465  ty.    def _node
-00005420: 5f64 6574 6169 6c73 2873 656c 6629 3a0a  _details(self):.
-00005430: 2020 2020 2020 2020 7320 3d20 7265 7072          s = repr
-00005440: 2873 656c 662e 7661 6c75 6529 0a20 2020  (self.value).   
-00005450: 2020 2020 2069 6620 275c 6e27 2069 6e20       if '\n' in 
-00005460: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
-00005470: 203d 2073 2e73 706c 6974 2827 5c6e 272c   = s.split('\n',
-00005480: 2031 295b 305d 202b 2027 2e2e 2e27 0a20   1)[0] + '...'. 
-00005490: 2020 2020 2020 2069 6620 6c65 6e28 7329         if len(s)
-000054a0: 203e 2032 303a 0a20 2020 2020 2020 2020   > 20:.         
-000054b0: 2020 2073 203d 2073 5b3a 3137 5d20 2b20     s = s[:17] + 
-000054c0: 272e 2e2e 270a 2020 2020 2020 2020 7265  '...'.        re
-000054d0: 7475 726e 2073 0a0a 0a63 6c61 7373 2054  turn s...class T
-000054e0: 7570 6c65 2845 7661 6c75 6162 6c65 293a  uple(Evaluable):
-000054f0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-00005500: 5f5f 2873 656c 662c 2069 7465 6d73 293a  __(self, items):
-00005510: 0a20 2020 2020 2020 2073 656c 662e 6974  .        self.it
-00005520: 656d 7320 3d20 6974 656d 730a 2020 2020  ems = items.    
-00005530: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-00005540: 6974 5f5f 2869 7465 6d73 290a 0a20 2020  it__(items)..   
-00005550: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-00005560: 2020 2064 6566 2065 7661 6c66 282a 6974     def evalf(*it
-00005570: 656d 7329 3a0a 2020 2020 2020 2020 7265  ems):.        re
-00005580: 7475 726e 2069 7465 6d73 0a0a 2020 2020  turn items..    
-00005590: 6465 6620 5f5f 6974 6572 5f5f 2873 656c  def __iter__(sel
-000055a0: 6629 3a0a 2020 2020 2020 2020 2769 7465  f):.        'ite
-000055b0: 7261 7465 270a 0a20 2020 2020 2020 2072  rate'..        r
-000055c0: 6574 7572 6e20 6974 6572 2873 656c 662e  eturn iter(self.
-000055d0: 6974 656d 7329 0a0a 2020 2020 6465 6620  items)..    def 
-000055e0: 5f5f 6c65 6e5f 5f28 7365 6c66 293a 0a20  __len__(self):. 
-000055f0: 2020 2020 2020 2027 6c65 6e67 7468 270a         'length'.
-00005600: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00005610: 6c65 6e28 7365 6c66 2e69 7465 6d73 290a  len(self.items).
-00005620: 0a20 2020 2064 6566 205f 5f67 6574 6974  .    def __getit
-00005630: 656d 5f5f 2873 656c 662c 2069 7465 6d29  em__(self, item)
-00005640: 3a0a 2020 2020 2020 2020 2767 6574 2069  :.        'get i
-00005650: 7465 6d27 0a0a 2020 2020 2020 2020 7265  tem'..        re
-00005660: 7475 726e 2073 656c 662e 6974 656d 735b  turn self.items[
-00005670: 6974 656d 5d0a 0a20 2020 2064 6566 205f  item]..    def _
-00005680: 5f61 6464 5f5f 2873 656c 662c 206f 7468  _add__(self, oth
-00005690: 6572 293a 0a20 2020 2020 2020 2027 6164  er):.        'ad
-000056a0: 6427 0a0a 2020 2020 2020 2020 7265 7475  d'..        retu
-000056b0: 726e 2054 7570 6c65 2873 656c 662e 6974  rn Tuple(self.it
-000056c0: 656d 7320 2b20 7475 706c 6528 6f74 6865  ems + tuple(othe
-000056d0: 7229 290a 0a20 2020 2064 6566 205f 5f72  r))..    def __r
-000056e0: 6164 645f 5f28 7365 6c66 2c20 6f74 6865  add__(self, othe
-000056f0: 7229 3a0a 2020 2020 2020 2020 2761 6464  r):.        'add
-00005700: 270a 0a20 2020 2020 2020 2072 6574 7572  '..        retur
-00005710: 6e20 5475 706c 6528 7475 706c 6528 6f74  n Tuple(tuple(ot
-00005720: 6865 7229 202b 2073 656c 662e 6974 656d  her) + self.item
-00005730: 7329 0a0a 0a23 2041 5252 4159 4655 4e43  s)...# ARRAYFUNC
-00005740: 0a23 0a23 2054 6865 206d 6169 6e20 6576  .#.# The main ev
-00005750: 616c 7561 626c 652e 2043 6c6f 7365 6c79  aluable. Closely
-00005760: 206d 696d 6963 7320 6120 6e75 6d70 7920   mimics a numpy 
-00005770: 6172 7261 792e 0a0a 0a64 6566 2061 6464  array....def add
-00005780: 2861 7267 302c 202a 6172 6773 293a 0a20  (arg0, *args):. 
-00005790: 2020 2066 6f72 2061 7267 3120 696e 2061     for arg1 in a
-000057a0: 7267 733a 0a20 2020 2020 2020 2061 7267  rgs:.        arg
-000057b0: 3020 3d20 4164 6428 7479 7065 732e 6672  0 = Add(types.fr
-000057c0: 6f7a 656e 6d75 6c74 6973 6574 285f 6e75  ozenmultiset(_nu
-000057d0: 6d70 795f 616c 6967 6e28 6172 6730 2c20  mpy_align(arg0, 
-000057e0: 6172 6731 2929 290a 2020 2020 7265 7475  arg1))).    retu
-000057f0: 726e 2061 7267 300a 0a0a 6465 6620 6d75  rn arg0...def mu
-00005800: 6c74 6970 6c79 2861 7267 302c 202a 6172  ltiply(arg0, *ar
-00005810: 6773 293a 0a20 2020 2066 6f72 2061 7267  gs):.    for arg
-00005820: 3120 696e 2061 7267 733a 0a20 2020 2020  1 in args:.     
-00005830: 2020 2061 7267 3020 3d20 4d75 6c74 6970     arg0 = Multip
-00005840: 6c79 2874 7970 6573 2e66 726f 7a65 6e6d  ly(types.frozenm
-00005850: 756c 7469 7365 7428 5f6e 756d 7079 5f61  ultiset(_numpy_a
-00005860: 6c69 676e 2861 7267 302c 2061 7267 3129  lign(arg0, arg1)
-00005870: 2929 0a20 2020 2072 6574 7572 6e20 6172  )).    return ar
-00005880: 6730 0a0a 0a64 6566 2073 756d 2861 7267  g0...def sum(arg
-00005890: 2c20 6178 6973 3d4e 6f6e 6529 3a0a 2020  , axis=None):.  
-000058a0: 2020 2727 2753 756d 2061 7272 6179 2065    '''Sum array e
-000058b0: 6c65 6d65 6e74 7320 6f76 6572 2061 2067  lements over a g
-000058c0: 6976 656e 2061 7869 732e 2727 270a 0a20  iven axis.'''.. 
-000058d0: 2020 2069 6620 6178 6973 2069 7320 4e6f     if axis is No
-000058e0: 6e65 3a0a 2020 2020 2020 2020 7265 7475  ne:.        retu
-000058f0: 726e 2053 756d 2861 7267 290a 2020 2020  rn Sum(arg).    
-00005900: 6178 6573 203d 2028 6178 6973 2c29 2069  axes = (axis,) i
-00005910: 6620 6e75 6d65 7269 632e 6973 696e 7428  f numeric.isint(
-00005920: 6178 6973 2920 656c 7365 2061 7869 730a  axis) else axis.
-00005930: 2020 2020 7375 6d6d 6564 203d 2054 7261      summed = Tra
-00005940: 6e73 706f 7365 2e74 6f5f 656e 6428 6172  nspose.to_end(ar
-00005950: 672c 202a 6178 6573 290a 2020 2020 666f  g, *axes).    fo
-00005960: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
-00005970: 2861 7865 7329 293a 0a20 2020 2020 2020  (axes)):.       
-00005980: 2073 756d 6d65 6420 3d20 5375 6d28 7375   summed = Sum(su
-00005990: 6d6d 6564 290a 2020 2020 7265 7475 726e  mmed).    return
-000059a0: 2073 756d 6d65 640a 0a0a 6465 6620 7072   summed...def pr
-000059b0: 6f64 7563 7428 6172 672c 2061 7869 7329  oduct(arg, axis)
-000059c0: 3a0a 2020 2020 7265 7475 726e 2050 726f  :.    return Pro
-000059d0: 6475 6374 2854 7261 6e73 706f 7365 2e74  duct(Transpose.t
-000059e0: 6f5f 656e 6428 6172 672c 2061 7869 7329  o_end(arg, axis)
-000059f0: 290a 0a0a 6465 6620 706f 7765 7228 6172  )...def power(ar
-00005a00: 672c 206e 293a 0a20 2020 2061 7267 2c20  g, n):.    arg, 
-00005a10: 6e20 3d20 5f6e 756d 7079 5f61 6c69 676e  n = _numpy_align
-00005a20: 2861 7267 2c20 6e29 0a20 2020 2072 6574  (arg, n).    ret
-00005a30: 7572 6e20 506f 7765 7228 6172 672c 206e  urn Power(arg, n
-00005a40: 290a 0a0a 6465 6620 646f 7428 612c 2062  )...def dot(a, b
-00005a50: 2c20 6178 6573 293a 0a20 2020 2027 2727  , axes):.    '''
-00005a60: 0a20 2020 2043 6f6e 7472 6163 7420 6060  .    Contract ``
-00005a70: 6160 6020 616e 6420 6060 6260 6020 616c  a`` and ``b`` al
-00005a80: 6f6e 6720 6060 6178 6573 6060 2e0a 2020  ong ``axes``..  
-00005a90: 2020 2727 270a 0a20 2020 2072 6574 7572    '''..    retur
-00005aa0: 6e20 6d75 6c74 6970 6c79 2861 2c20 6229  n multiply(a, b)
-00005ab0: 2e73 756d 2861 7865 7329 0a0a 0a64 6566  .sum(axes)...def
-00005ac0: 2063 6f6e 6a75 6761 7465 2861 7267 293a   conjugate(arg):
-00005ad0: 0a20 2020 2061 7267 203d 2061 7361 7272  .    arg = asarr
-00005ae0: 6179 2861 7267 290a 2020 2020 6966 2061  ay(arg).    if a
-00005af0: 7267 2e64 7479 7065 203d 3d20 636f 6d70  rg.dtype == comp
-00005b00: 6c65 783a 0a20 2020 2020 2020 2072 6574  lex:.        ret
-00005b10: 7572 6e20 436f 6e6a 7567 6174 6528 6172  urn Conjugate(ar
-00005b20: 6729 0a20 2020 2065 6c73 653a 0a20 2020  g).    else:.   
-00005b30: 2020 2020 2072 6574 7572 6e20 6172 670a       return arg.
-00005b40: 0a0a 636f 6e6a 7567 6174 650a 0a0a 6465  ..conjugate...de
-00005b50: 6620 7265 616c 2861 7267 293a 0a20 2020  f real(arg):.   
-00005b60: 2061 7267 203d 2061 7361 7272 6179 2861   arg = asarray(a
-00005b70: 7267 290a 2020 2020 6966 2061 7267 2e64  rg).    if arg.d
-00005b80: 7479 7065 203d 3d20 636f 6d70 6c65 783a  type == complex:
-00005b90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00005ba0: 5265 616c 2861 7267 290a 2020 2020 656c  Real(arg).    el
-00005bb0: 7365 3a0a 2020 2020 2020 2020 7265 7475  se:.        retu
-00005bc0: 726e 2061 7267 0a0a 0a64 6566 2069 6d61  rn arg...def ima
-00005bd0: 6728 6172 6729 3a0a 2020 2020 6172 6720  g(arg):.    arg 
-00005be0: 3d20 6173 6172 7261 7928 6172 6729 0a20  = asarray(arg). 
-00005bf0: 2020 2069 6620 6172 672e 6474 7970 6520     if arg.dtype 
-00005c00: 3d3d 2063 6f6d 706c 6578 3a0a 2020 2020  == complex:.    
-00005c10: 2020 2020 7265 7475 726e 2049 6d61 6728      return Imag(
-00005c20: 6172 6729 0a20 2020 2065 6c73 653a 0a20  arg).    else:. 
-00005c30: 2020 2020 2020 2072 6574 7572 6e20 7a65         return ze
-00005c40: 726f 735f 6c69 6b65 2861 7267 290a 0a0a  ros_like(arg)...
-00005c50: 6465 6620 7472 616e 7370 6f73 6528 6172  def transpose(ar
-00005c60: 672c 2074 7261 6e73 3d4e 6f6e 6529 3a0a  g, trans=None):.
-00005c70: 2020 2020 6172 6720 3d20 6173 6172 7261      arg = asarra
-00005c80: 7928 6172 6729 0a20 2020 2069 6620 7472  y(arg).    if tr
-00005c90: 616e 7320 6973 204e 6f6e 653a 0a20 2020  ans is None:.   
-00005ca0: 2020 2020 206e 6f72 6d74 7261 6e73 203d       normtrans =
-00005cb0: 2074 7570 6c65 2872 616e 6765 2861 7267   tuple(range(arg
-00005cc0: 2e6e 6469 6d2d 312c 202d 312c 202d 3129  .ndim-1, -1, -1)
-00005cd0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-00005ce0: 2020 2020 6e6f 726d 7472 616e 7320 3d20      normtrans = 
-00005cf0: 7475 706c 6528 6e75 6d65 7269 632e 6e6f  tuple(numeric.no
-00005d00: 726d 6469 6d28 6172 672e 6e64 696d 2c20  rmdim(arg.ndim, 
-00005d10: 7368 292e 5f5f 696e 6465 785f 5f28 2920  sh).__index__() 
-00005d20: 666f 7220 7368 2069 6e20 7472 616e 7329  for sh in trans)
-00005d30: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00005d40: 736f 7274 6564 286e 6f72 6d74 7261 6e73  sorted(normtrans
-00005d50: 2920 3d3d 206c 6973 7428 7261 6e67 6528  ) == list(range(
-00005d60: 6172 672e 6e64 696d 2929 0a20 2020 2072  arg.ndim)).    r
-00005d70: 6574 7572 6e20 5472 616e 7370 6f73 6528  eturn Transpose(
-00005d80: 6172 672c 206e 6f72 6d74 7261 6e73 290a  arg, normtrans).
-00005d90: 0a0a 6465 6620 7377 6170 6178 6573 2861  ..def swapaxes(a
-00005da0: 7267 2c20 6178 6973 312c 2061 7869 7332  rg, axis1, axis2
-00005db0: 293a 0a20 2020 2061 7267 203d 2061 7361  ):.    arg = asa
-00005dc0: 7272 6179 2861 7267 290a 2020 2020 7472  rray(arg).    tr
-00005dd0: 616e 7320 3d20 6e75 6d70 792e 6172 616e  ans = numpy.aran
-00005de0: 6765 2861 7267 2e6e 6469 6d29 0a20 2020  ge(arg.ndim).   
-00005df0: 2074 7261 6e73 5b61 7869 7331 5d2c 2074   trans[axis1], t
-00005e00: 7261 6e73 5b61 7869 7332 5d20 3d20 7472  rans[axis2] = tr
-00005e10: 616e 735b 6178 6973 325d 2c20 7472 616e  ans[axis2], tran
-00005e20: 735b 6178 6973 315d 0a20 2020 2072 6574  s[axis1].    ret
-00005e30: 7572 6e20 7472 616e 7370 6f73 6528 6172  urn transpose(ar
-00005e40: 672c 2074 7261 6e73 290a 0a0a 6465 6620  g, trans)...def 
-00005e50: 616c 6967 6e28 6172 672c 2077 6865 7265  align(arg, where
-00005e60: 2c20 7368 6170 6529 3a0a 2020 2020 2727  , shape):.    ''
-00005e70: 2741 6c69 676e 2061 7272 6179 2074 6f20  'Align array to 
-00005e80: 7461 7267 6574 2073 6861 7065 2e0a 0a20  target shape... 
-00005e90: 2020 2054 6865 2061 6c69 676e 206f 7065     The align ope
-00005ea0: 7261 7469 6f6e 2063 616e 2062 6520 636f  ration can be co
-00005eb0: 6e73 6964 6572 6564 2074 6865 206f 7070  nsidered the opp
-00005ec0: 6f73 6974 6520 6f66 2074 7261 6e73 706f  osite of transpo
-00005ed0: 7365 3a20 696e 7374 6561 6420 6f66 0a20  se: instead of. 
-00005ee0: 2020 2073 7065 6369 6679 696e 6720 666f     specifying fo
-00005ef0: 7220 6561 6368 2061 7869 7320 6f66 2074  r each axis of t
-00005f00: 6865 2072 6574 7572 6e20 7661 6c75 6520  he return value 
-00005f10: 7468 6520 6f72 6967 696e 616c 2070 6f73  the original pos
-00005f20: 6974 696f 6e20 696e 2074 6865 0a20 2020  ition in the.   
-00005f30: 2061 7267 756d 656e 742c 2061 6c69 676e   argument, align
-00005f40: 2073 7065 6369 6669 6573 2066 6f72 2065   specifies for e
-00005f50: 6163 6820 6178 6973 206f 6620 7468 6520  ach axis of the 
-00005f60: 6172 6775 6d65 6e74 2074 6865 206e 6577  argument the new
-00005f70: 2070 6f73 6974 696f 6e20 696e 0a20 2020   position in.   
-00005f80: 2074 6865 2072 6574 7572 6e20 7661 6c75   the return valu
-00005f90: 652e 2049 6e20 6164 6469 7469 6f6e 2c20  e. In addition, 
-00005fa0: 7468 6520 7265 7475 726e 2076 616c 7565  the return value
-00005fb0: 206d 6179 2062 6520 6f66 2068 6967 6865   may be of highe
-00005fc0: 7220 6469 6d65 6e73 696f 6e2c 0a20 2020  r dimension,.   
-00005fd0: 2077 6974 6820 6e65 7720 6178 6573 2062   with new axes b
-00005fe0: 6569 6e67 2069 6e73 6572 7465 6420 6163  eing inserted ac
-00005ff0: 636f 7264 696e 6720 746f 2074 6865 2060  cording to the `
-00006000: 6073 6861 7065 6060 2061 7267 756d 656e  `shape`` argumen
-00006010: 742e 0a0a 2020 2020 4172 6773 0a20 2020  t...    Args.   
-00006020: 202d 2d2d 2d0a 2020 2020 6172 6720 3a20   ----.    arg : 
-00006030: 3a63 6c61 7373 3a60 4172 7261 7960 0a20  :class:`Array`. 
-00006040: 2020 2020 2020 204f 7269 6769 6e61 6c20         Original 
-00006050: 6172 7261 792e 0a20 2020 2077 6865 7265  array..    where
-00006060: 203a 203a 636c 6173 733a 6074 7570 6c65   : :class:`tuple
-00006070: 6020 6f66 2069 6e74 6567 6572 730a 2020  ` of integers.  
-00006080: 2020 2020 2020 4e65 7720 6178 6973 2070        New axis p
-00006090: 6f73 6974 696f 6e73 2e0a 2020 2020 7368  ositions..    sh
-000060a0: 6170 6520 3a20 3a63 6c61 7373 3a60 7475  ape : :class:`tu
-000060b0: 706c 6560 0a20 2020 2020 2020 2053 6861  ple`.        Sha
-000060c0: 7065 206f 6620 7468 6520 616c 6967 6e65  pe of the aligne
-000060d0: 6420 6172 7261 792e 0a0a 2020 2020 5265  d array...    Re
-000060e0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-000060f0: 2d0a 2020 2020 3a63 6c61 7373 3a60 4172  -.    :class:`Ar
-00006100: 7261 7960 0a20 2020 2020 2020 2054 6865  ray`.        The
-00006110: 2061 6c69 676e 6564 2061 7272 6179 2e0a   aligned array..
-00006120: 2020 2020 2727 270a 0a20 2020 2077 6865      '''..    whe
-00006130: 7265 203d 206c 6973 7428 7768 6572 6529  re = list(where)
-00006140: 0a20 2020 2066 6f72 2069 2c20 6c65 6e67  .    for i, leng
-00006150: 7468 2069 6e20 656e 756d 6572 6174 6528  th in enumerate(
-00006160: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
-00006170: 6966 2069 206e 6f74 2069 6e20 7768 6572  if i not in wher
-00006180: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00006190: 7267 203d 2049 6e73 6572 7441 7869 7328  rg = InsertAxis(
-000061a0: 6172 672c 206c 656e 6774 6829 0a20 2020  arg, length).   
-000061b0: 2020 2020 2020 2020 2077 6865 7265 2e61           where.a
-000061c0: 7070 656e 6428 6929 0a20 2020 2069 6620  ppend(i).    if 
-000061d0: 7768 6572 6520 213d 206c 6973 7428 7261  where != list(ra
-000061e0: 6e67 6528 6c65 6e28 7368 6170 6529 2929  nge(len(shape)))
-000061f0: 3a0a 2020 2020 2020 2020 6172 6720 3d20  :.        arg = 
-00006200: 5472 616e 7370 6f73 652e 696e 7628 6172  Transpose.inv(ar
-00006210: 672c 2077 6865 7265 290a 2020 2020 6173  g, where).    as
-00006220: 7365 7274 2065 7175 616c 7368 6170 6528  sert equalshape(
-00006230: 6172 672e 7368 6170 652c 2073 6861 7065  arg.shape, shape
-00006240: 292c 2066 2761 7267 2e73 6861 7065 3d7b  ), f'arg.shape={
-00006250: 6172 672e 7368 6170 6521 727d 2c20 7368  arg.shape!r}, sh
-00006260: 6170 653d 7b73 6861 7065 2172 7d27 0a20  ape={shape!r}'. 
-00006270: 2020 2072 6574 7572 6e20 6172 670a 0a0a     return arg...
-00006280: 6465 6620 756e 616c 6967 6e28 2a61 7267  def unalign(*arg
-00006290: 732c 206e 6178 6573 3a20 696e 7420 3d20  s, naxes: int = 
-000062a0: 4e6f 6e65 293a 0a20 2020 2027 2727 5265  None):.    '''Re
-000062b0: 6d6f 7665 2028 6a6f 696e 7429 2069 6e73  move (joint) ins
-000062c0: 6572 7465 6420 6178 6573 2e0a 0a20 2020  erted axes...   
-000062d0: 2047 6976 656e 206f 6e65 206f 7220 6d6f   Given one or mo
-000062e0: 7265 2061 7272 6179 2061 7267 756d 656e  re array argumen
-000062f0: 7473 2c20 7265 7475 726e 2074 6865 2073  ts, return the s
-00006300: 686f 7274 6573 7420 636f 6d6d 6f6e 2061  hortest common a
-00006310: 7869 7320 7665 6374 6f72 0a20 2020 2061  xis vector.    a
-00006320: 6c6f 6e67 2077 6974 6820 6675 6e63 7469  long with functi
-00006330: 6f6e 2061 7267 756d 656e 7473 2073 7563  on arguments suc
-00006340: 6820 7468 6174 2074 6865 206f 7269 6769  h that the origi
-00006350: 6e61 6c20 6172 7261 7973 2063 616e 2062  nal arrays can b
-00006360: 650a 2020 2020 7265 636f 7665 7265 6420  e.    recovered 
-00006370: 6279 203a 6675 6e63 3a60 616c 6967 6e60  by :func:`align`
-00006380: 2e20 4178 6573 2062 6579 6f6e 6420 7468  . Axes beyond th
-00006390: 6520 6669 7273 7420 6060 6e61 7865 7360  e first ``naxes`
-000063a0: 6020 6172 6520 6e6f 740a 2020 2020 636f  ` are not.    co
-000063b0: 6e73 6964 6572 6564 2066 6f72 2072 656d  nsidered for rem
-000063c0: 6f76 616c 2c20 6b65 6570 2074 6865 6972  oval, keep their
-000063d0: 2070 6f73 6974 696f 6e20 2861 7320 7365   position (as se
-000063e0: 656e 2066 726f 6d20 7468 6520 7269 6768  en from the righ
-000063f0: 7429 2c20 616e 640a 2020 2020 6172 6520  t), and.    are 
-00006400: 6e6f 7420 7061 7274 206f 6620 7468 6520  not part of the 
-00006410: 636f 6d6d 6f6e 2061 7869 7320 7665 6374  common axis vect
-00006420: 6f72 2e20 5468 6f73 6520 6178 6573 2073  or. Those axes s
-00006430: 686f 756c 6420 6265 2061 6464 6564 2074  hould be added t
-00006440: 6f20 7468 650a 2020 2020 6178 6973 2076  o the.    axis v
-00006450: 6563 746f 7220 6265 666f 7265 2063 616c  ector before cal
-00006460: 6c69 6e67 203a 6675 6e63 3a60 616c 6967  ling :func:`alig
-00006470: 6e60 2e0a 0a20 2020 2049 6620 6060 6e61  n`...    If ``na
-00006480: 7865 7360 6020 6973 2060 604e 6f6e 6560  xes`` is ``None`
-00006490: 6020 2874 6865 2064 6566 6175 6c74 292c  ` (the default),
-000064a0: 2061 6c6c 2061 7267 756d 656e 7473 206d   all arguments m
-000064b0: 7573 7420 6861 7665 2074 6865 2073 616d  ust have the sam
-000064c0: 650a 2020 2020 6e75 6d62 6572 206f 6620  e.    number of 
-000064d0: 6178 6573 2061 6e64 2060 606e 6178 6573  axes and ``naxes
-000064e0: 6060 2069 7320 7365 7420 746f 2074 6869  `` is set to thi
-000064f0: 7320 6e75 6d62 6572 2e0a 2020 2020 2727  s number..    ''
-00006500: 270a 0a20 2020 2061 7373 6572 7420 6172  '..    assert ar
-00006510: 6773 0a20 2020 2069 6620 6c65 6e28 6172  gs.    if len(ar
-00006520: 6773 2920 3d3d 2031 2061 6e64 206e 6178  gs) == 1 and nax
-00006530: 6573 2069 7320 4e6f 6e65 3a0a 2020 2020  es is None:.    
-00006540: 2020 2020 7265 7475 726e 2061 7267 735b      return args[
-00006550: 305d 2e5f 756e 616c 6967 6e65 640a 2020  0]._unaligned.  
-00006560: 2020 6966 206e 6178 6573 2069 7320 4e6f    if naxes is No
-00006570: 6e65 3a0a 2020 2020 2020 2020 6966 2061  ne:.        if a
-00006580: 6e79 2861 7267 2e6e 6469 6d20 213d 2061  ny(arg.ndim != a
-00006590: 7267 735b 305d 2e6e 6469 6d20 666f 7220  rgs[0].ndim for 
-000065a0: 6172 6720 696e 2061 7267 735b 313a 5d29  arg in args[1:])
-000065b0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-000065c0: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
-000065d0: 7661 7279 696e 6720 6469 6d65 6e73 696f  varying dimensio
-000065e0: 6e73 2069 6e20 756e 616c 6967 6e27 290a  ns in unalign').
-000065f0: 2020 2020 2020 2020 6e61 7865 7320 3d20          naxes = 
-00006600: 6172 6773 5b30 5d2e 6e64 696d 0a20 2020  args[0].ndim.   
-00006610: 2065 6c69 6620 616e 7928 6172 672e 6e64   elif any(arg.nd
-00006620: 696d 203c 206e 6178 6573 2066 6f72 2061  im < naxes for a
-00006630: 7267 2069 6e20 6172 6773 293a 0a20 2020  rg in args):.   
-00006640: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00006650: 4572 726f 7228 276f 6e65 206f 7220 6d6f  Error('one or mo
-00006660: 7265 2061 7267 756d 656e 7473 2068 6176  re arguments hav
-00006670: 6520 6665 7765 7220 6178 6573 2074 6861  e fewer axes tha
-00006680: 6e20 6578 7065 6374 6564 2729 0a20 2020  n expected').   
-00006690: 206e 6f6e 696e 7320 3d20 6675 6e63 746f   nonins = functo
-000066a0: 6f6c 732e 7265 6475 6365 286f 7065 7261  ols.reduce(opera
-000066b0: 746f 722e 6f72 5f2c 205b 7365 7428 6172  tor.or_, [set(ar
-000066c0: 672e 5f75 6e61 6c69 676e 6564 5b31 5d29  g._unaligned[1])
-000066d0: 2066 6f72 2061 7267 2069 6e20 6172 6773   for arg in args
-000066e0: 5d29 2026 2073 6574 2872 616e 6765 286e  ]) & set(range(n
-000066f0: 6178 6573 2929 0a20 2020 2069 6620 6c65  axes)).    if le
-00006700: 6e28 6e6f 6e69 6e73 2920 3d3d 206e 6178  n(nonins) == nax
-00006710: 6573 3a0a 2020 2020 2020 2020 7265 7475  es:.        retu
-00006720: 726e 2028 2a61 7267 732c 2074 7570 6c65  rn (*args, tuple
-00006730: 2872 616e 6765 286e 6178 6573 2929 290a  (range(naxes))).
-00006740: 2020 2020 7265 7420 3d20 5b5d 0a20 2020      ret = [].   
-00006750: 2066 6f72 2061 7267 2069 6e20 6172 6773   for arg in args
-00006760: 3a0a 2020 2020 2020 2020 756e 616c 6967  :.        unalig
-00006770: 6e65 642c 2077 6865 7265 203d 2061 7267  ned, where = arg
-00006780: 2e5f 756e 616c 6967 6e65 640a 2020 2020  ._unaligned.    
-00006790: 2020 2020 6b65 6570 203d 2074 7570 6c65      keep = tuple
-000067a0: 2872 616e 6765 286e 6178 6573 2c20 6172  (range(naxes, ar
-000067b0: 672e 6e64 696d 2929 0a20 2020 2020 2020  g.ndim)).       
-000067c0: 2066 6f72 2069 2069 6e20 736f 7274 6564   for i in sorted
-000067d0: 2828 6e6f 6e69 6e73 207c 2073 6574 286b  ((nonins | set(k
-000067e0: 6565 7029 2920 2d20 7365 7428 7768 6572  eep)) - set(wher
-000067f0: 6529 293a 0a20 2020 2020 2020 2020 2020  e)):.           
-00006800: 2075 6e61 6c69 676e 6564 203d 2049 6e73   unaligned = Ins
-00006810: 6572 7441 7869 7328 756e 616c 6967 6e65  ertAxis(unaligne
-00006820: 642c 2061 7267 2e73 6861 7065 5b69 5d29  d, arg.shape[i])
-00006830: 0a20 2020 2020 2020 2020 2020 2077 6865  .            whe
-00006840: 7265 202b 3d20 692c 0a20 2020 2020 2020  re += i,.       
-00006850: 2069 6620 6e6f 7420 7265 743a 2020 2320   if not ret:  # 
-00006860: 6669 7273 7420 6172 6775 6d65 6e74 0a20  first argument. 
-00006870: 2020 2020 2020 2020 2020 2063 6f6d 6d6f             commo
-00006880: 6e77 6865 7265 203d 2074 7570 6c65 2869  nwhere = tuple(i
-00006890: 2066 6f72 2069 2069 6e20 7768 6572 6520   for i in where 
-000068a0: 6966 2069 203c 206e 6178 6573 290a 2020  if i < naxes).  
-000068b0: 2020 2020 2020 6966 2077 6865 7265 2021        if where !
-000068c0: 3d20 636f 6d6d 6f6e 7768 6572 6520 2b20  = commonwhere + 
-000068d0: 6b65 6570 3a0a 2020 2020 2020 2020 2020  keep:.          
-000068e0: 2020 756e 616c 6967 6e65 6420 3d20 5472    unaligned = Tr
-000068f0: 616e 7370 6f73 6528 756e 616c 6967 6e65  anspose(unaligne
-00006900: 642c 2074 7570 6c65 2877 6865 7265 2e69  d, tuple(where.i
-00006910: 6e64 6578 286e 2920 666f 7220 6e20 696e  ndex(n) for n in
-00006920: 2063 6f6d 6d6f 6e77 6865 7265 202b 206b   commonwhere + k
-00006930: 6565 7029 290a 2020 2020 2020 2020 7265  eep)).        re
-00006940: 742e 6170 7065 6e64 2875 6e61 6c69 676e  t.append(unalign
-00006950: 6564 290a 2020 2020 7265 7475 726e 2028  ed).    return (
-00006960: 2a72 6574 2c20 636f 6d6d 6f6e 7768 6572  *ret, commonwher
-00006970: 6529 0a0a 2320 4152 5241 5953 0a0a 0a5f  e)..# ARRAYS..._
-00006980: 4172 7261 794d 6574 6120 3d20 7479 7065  ArrayMeta = type
-00006990: 2845 7661 6c75 6162 6c65 290a 0a69 6620  (Evaluable)..if 
-000069a0: 6465 6275 675f 666c 6167 732e 7370 6172  debug_flags.spar
-000069b0: 7365 3a0a 2020 2020 6465 6620 5f63 6875  se:.    def _chu
-000069c0: 6e6b 6564 5f61 7373 7061 7273 655f 6368  nked_assparse_ch
-000069d0: 6563 6b65 7228 6f72 6967 293a 0a20 2020  ecker(orig):.   
-000069e0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-000069f0: 7374 616e 6365 286f 7269 672c 2063 6163  stance(orig, cac
-00006a00: 6865 645f 7072 6f70 6572 7479 290a 0a20  hed_property).. 
-00006a10: 2020 2020 2020 2040 6361 6368 6564 5f70         @cached_p
-00006a20: 726f 7065 7274 790a 2020 2020 2020 2020  roperty.        
-00006a30: 6465 6620 5f61 7373 7061 7273 6528 7365  def _assparse(se
-00006a40: 6c66 293a 0a20 2020 2020 2020 2020 2020  lf):.           
-00006a50: 2063 6875 6e6b 7320 3d20 6f72 6967 2e66   chunks = orig.f
-00006a60: 756e 6328 7365 6c66 290a 2020 2020 2020  unc(self).      
-00006a70: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-00006a80: 6e73 7461 6e63 6528 6368 756e 6b73 2c20  nstance(chunks, 
-00006a90: 7475 706c 6529 0a20 2020 2020 2020 2020  tuple).         
-00006aa0: 2020 2061 7373 6572 7420 616c 6c28 6973     assert all(is
-00006ab0: 696e 7374 616e 6365 2863 6875 6e6b 2c20  instance(chunk, 
-00006ac0: 7475 706c 6529 2066 6f72 2063 6875 6e6b  tuple) for chunk
-00006ad0: 2069 6e20 6368 756e 6b73 290a 2020 2020   in chunks).    
-00006ae0: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
-00006af0: 6c6c 2861 6c6c 2869 7369 6e73 7461 6e63  ll(all(isinstanc
-00006b00: 6528 6974 656d 2c20 4172 7261 7929 2066  e(item, Array) f
-00006b10: 6f72 2069 7465 6d20 696e 2063 6875 6e6b  or item in chunk
-00006b20: 2920 666f 7220 6368 756e 6b20 696e 2063  ) for chunk in c
-00006b30: 6875 6e6b 7329 0a20 2020 2020 2020 2020  hunks).         
-00006b40: 2020 2069 6620 7365 6c66 2e6e 6469 6d3a     if self.ndim:
-00006b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006b60: 2066 6f72 202a 696e 6469 6365 732c 2076   for *indices, v
-00006b70: 616c 7565 7320 696e 2063 6875 6e6b 733a  alues in chunks:
-00006b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006b90: 2020 2020 2061 7373 6572 7420 6c65 6e28       assert len(
-00006ba0: 696e 6469 6365 7329 203d 3d20 7365 6c66  indices) == self
-00006bb0: 2e6e 6469 6d0a 2020 2020 2020 2020 2020  .ndim.          
-00006bc0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00006bd0: 2061 6c6c 2869 6478 2e64 7479 7065 203d   all(idx.dtype =
-00006be0: 3d20 696e 7420 666f 7220 6964 7820 696e  = int for idx in
-00006bf0: 2069 6e64 6963 6573 290a 2020 2020 2020   indices).      
-00006c00: 2020 2020 2020 2020 2020 2020 2020 6173                as
-00006c10: 7365 7274 2061 6c6c 2865 7175 616c 7368  sert all(equalsh
-00006c20: 6170 6528 6964 782e 7368 6170 652c 2076  ape(idx.shape, v
-00006c30: 616c 7565 732e 7368 6170 6529 2066 6f72  alues.shape) for
-00006c40: 2069 6478 2069 6e20 696e 6469 6365 7329   idx in indices)
-00006c50: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00006c60: 6620 6368 756e 6b73 3a0a 2020 2020 2020  f chunks:.      
-00006c70: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00006c80: 206c 656e 2863 6875 6e6b 7329 203d 3d20   len(chunks) == 
-00006c90: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-00006ca0: 2020 6368 756e 6b2c 203d 2063 6875 6e6b    chunk, = chunk
-00006cb0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00006cc0: 2020 6173 7365 7274 206c 656e 2863 6875    assert len(chu
-00006cd0: 6e6b 2920 3d3d 2031 0a20 2020 2020 2020  nk) == 1.       
-00006ce0: 2020 2020 2020 2020 2076 616c 7565 732c           values,
-00006cf0: 203d 2063 6875 6e6b 0a20 2020 2020 2020   = chunk.       
-00006d00: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00006d10: 7661 6c75 6573 2e73 6861 7065 203d 3d20  values.shape == 
-00006d20: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
-00006d30: 6574 7572 6e20 6368 756e 6b73 0a20 2020  eturn chunks.   
-00006d40: 2020 2020 2072 6574 7572 6e20 5f61 7373       return _ass
-00006d50: 7061 7273 650a 0a20 2020 2063 6c61 7373  parse..    class
-00006d60: 205f 4172 7261 794d 6574 6128 5f41 7272   _ArrayMeta(_Arr
-00006d70: 6179 4d65 7461 293a 0a20 2020 2020 2020  ayMeta):.       
-00006d80: 2064 6566 205f 5f6e 6577 5f5f 286d 636c   def __new__(mcl
-00006d90: 732c 206e 616d 652c 2062 6173 6573 2c20  s, name, bases, 
-00006da0: 6e61 6d65 7370 6163 6529 3a0a 2020 2020  namespace):.    
-00006db0: 2020 2020 2020 2020 6966 2027 5f61 7373          if '_ass
-00006dc0: 7061 7273 6527 2069 6e20 6e61 6d65 7370  parse' in namesp
-00006dd0: 6163 653a 0a20 2020 2020 2020 2020 2020  ace:.           
-00006de0: 2020 2020 206e 616d 6573 7061 6365 5b27       namespace['
-00006df0: 5f61 7373 7061 7273 6527 5d20 3d20 5f63  _assparse'] = _c
-00006e00: 6875 6e6b 6564 5f61 7373 7061 7273 655f  hunked_assparse_
-00006e10: 6368 6563 6b65 7228 6e61 6d65 7370 6163  checker(namespac
-00006e20: 655b 275f 6173 7370 6172 7365 275d 290a  e['_assparse']).
-00006e30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00006e40: 726e 2073 7570 6572 2829 2e5f 5f6e 6577  rn super().__new
-00006e50: 5f5f 286d 636c 732c 206e 616d 652c 2062  __(mcls, name, b
-00006e60: 6173 6573 2c20 6e61 6d65 7370 6163 6529  ases, namespace)
-00006e70: 0a0a 6966 2064 6562 7567 5f66 6c61 6773  ..if debug_flags
-00006e80: 2e65 7661 6c66 3a0a 2020 2020 636c 6173  .evalf:.    clas
-00006e90: 7320 5f65 7661 6c66 5f63 6865 636b 6572  s _evalf_checker
-00006ea0: 3a0a 2020 2020 2020 2020 6465 6620 5f5f  :.        def __
-00006eb0: 696e 6974 5f5f 2873 656c 662c 206f 7269  init__(self, ori
-00006ec0: 6729 3a0a 2020 2020 2020 2020 2020 2020  g):.            
-00006ed0: 7365 6c66 2e6f 7269 6720 3d20 6f72 6967  self.orig = orig
-00006ee0: 0a0a 2020 2020 2020 2020 6465 6620 5f5f  ..        def __
-00006ef0: 7365 745f 6e61 6d65 5f5f 2873 656c 662c  set_name__(self,
-00006f00: 206f 776e 6572 2c20 6e61 6d65 293a 0a20   owner, name):. 
-00006f10: 2020 2020 2020 2020 2020 2069 6620 6861             if ha
-00006f20: 7361 7474 7228 7365 6c66 2e6f 7269 672c  sattr(self.orig,
-00006f30: 2027 5f5f 7365 745f 6e61 6d65 5f5f 2729   '__set_name__')
-00006f40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006f50: 2020 7365 6c66 2e6f 7269 672e 5f5f 7365    self.orig.__se
-00006f60: 745f 6e61 6d65 5f5f 286f 776e 6572 2c20  t_name__(owner, 
-00006f70: 6e61 6d65 290a 0a20 2020 2020 2020 2064  name)..        d
-00006f80: 6566 205f 5f67 6574 5f5f 2873 656c 662c  ef __get__(self,
-00006f90: 2069 6e73 7461 6e63 652c 206f 776e 6572   instance, owner
-00006fa0: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
-00006fb0: 7661 6c66 203d 2073 656c 662e 6f72 6967  valf = self.orig
-00006fc0: 2e5f 5f67 6574 5f5f 2869 6e73 7461 6e63  .__get__(instanc
-00006fd0: 652c 206f 776e 6572 290a 0a20 2020 2020  e, owner)..     
-00006fe0: 2020 2020 2020 2040 6675 6e63 746f 6f6c         @functool
-00006ff0: 732e 7772 6170 7328 6576 616c 6629 0a20  s.wraps(evalf). 
-00007000: 2020 2020 2020 2020 2020 2064 6566 2065             def e
-00007010: 7661 6c66 5f77 6974 685f 6368 6563 6b28  valf_with_check(
-00007020: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
-00007030: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007040: 2020 7265 7320 3d20 6576 616c 6628 2a61    res = evalf(*a
-00007050: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
-00007060: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00007070: 7373 6572 7420 6e6f 7420 6861 7361 7474  ssert not hasatt
-00007080: 7228 696e 7374 616e 6365 2c20 2764 7479  r(instance, 'dty
-00007090: 7065 2729 206f 7220 6173 6474 7970 6528  pe') or asdtype(
-000070a0: 7265 732e 6474 7970 6529 203d 3d20 696e  res.dtype) == in
-000070b0: 7374 616e 6365 2e64 7479 7065 2c20 2828  stance.dtype, ((
-000070c0: 696e 7374 616e 6365 2e64 7479 7065 2c20  instance.dtype, 
-000070d0: 7265 732e 6474 7970 6529 2c20 696e 7374  res.dtype), inst
-000070e0: 616e 6365 2c20 7265 7329 0a20 2020 2020  ance, res).     
-000070f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00007100: 7420 6e6f 7420 6861 7361 7474 7228 696e  t not hasattr(in
-00007110: 7374 616e 6365 2c20 276e 6469 6d27 2920  stance, 'ndim') 
-00007120: 6f72 2072 6573 2e6e 6469 6d20 3d3d 2069  or res.ndim == i
-00007130: 6e73 7461 6e63 652e 6e64 696d 0a20 2020  nstance.ndim.   
-00007140: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-00007150: 6572 7420 6e6f 7420 6861 7361 7474 7228  ert not hasattr(
-00007160: 696e 7374 616e 6365 2c20 2773 6861 7065  instance, 'shape
-00007170: 2729 206f 7220 616c 6c28 6d20 3d3d 206e  ') or all(m == n
-00007180: 2066 6f72 206d 2c20 6e20 696e 207a 6970   for m, n in zip
-00007190: 2872 6573 2e73 6861 7065 2c20 696e 7374  (res.shape, inst
-000071a0: 616e 6365 2e73 6861 7065 2920 6966 2069  ance.shape) if i
-000071b0: 7369 6e73 7461 6e63 6528 6e2c 2069 6e74  sinstance(n, int
-000071c0: 2929 2c20 2773 6861 7065 206d 6973 6d61  )), 'shape misma
-000071d0: 7463 6827 0a20 2020 2020 2020 2020 2020  tch'.           
-000071e0: 2020 2020 2072 6574 7572 6e20 7265 730a       return res.
-000071f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00007200: 726e 2065 7661 6c66 5f77 6974 685f 6368  rn evalf_with_ch
-00007210: 6563 6b0a 0a20 2020 2063 6c61 7373 205f  eck..    class _
-00007220: 4172 7261 794d 6574 6128 5f41 7272 6179  ArrayMeta(_Array
-00007230: 4d65 7461 293a 0a20 2020 2020 2020 2064  Meta):.        d
-00007240: 6566 205f 5f6e 6577 5f5f 286d 636c 732c  ef __new__(mcls,
-00007250: 206e 616d 652c 2062 6173 6573 2c20 6e61   name, bases, na
-00007260: 6d65 7370 6163 6529 3a0a 2020 2020 2020  mespace):.      
-00007270: 2020 2020 2020 6966 2027 6576 616c 6627        if 'evalf'
-00007280: 2069 6e20 6e61 6d65 7370 6163 653a 0a20   in namespace:. 
-00007290: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-000072a0: 616d 6573 7061 6365 5b27 6576 616c 6627  amespace['evalf'
-000072b0: 5d20 3d20 5f65 7661 6c66 5f63 6865 636b  ] = _evalf_check
-000072c0: 6572 286e 616d 6573 7061 6365 5b27 6576  er(namespace['ev
-000072d0: 616c 6627 5d29 0a20 2020 2020 2020 2020  alf']).         
-000072e0: 2020 2072 6574 7572 6e20 7375 7065 7228     return super(
-000072f0: 292e 5f5f 6e65 775f 5f28 6d63 6c73 2c20  ).__new__(mcls, 
-00007300: 6e61 6d65 2c20 6261 7365 732c 206e 616d  name, bases, nam
-00007310: 6573 7061 6365 290a 0a0a 636c 6173 7320  espace)...class 
-00007320: 4173 4576 616c 7561 626c 6541 7272 6179  AsEvaluableArray
-00007330: 2850 726f 746f 636f 6c29 3a0a 2020 2020  (Protocol):.    
-00007340: 2750 726f 746f 636f 6c20 666f 7220 636f  'Protocol for co
-00007350: 6e76 6572 7369 6f6e 2069 6e74 6f20 616e  nversion into an
-00007360: 203a 636c 6173 733a 6041 7272 6179 602e   :class:`Array`.
-00007370: 270a 0a20 2020 2040 7072 6f70 6572 7479  '..    @property
-00007380: 0a20 2020 2064 6566 2061 735f 6576 616c  .    def as_eval
-00007390: 7561 626c 655f 6172 7261 7928 7365 6c66  uable_array(self
-000073a0: 2920 2d3e 2027 4172 7261 7927 3a0a 2020  ) -> 'Array':.  
-000073b0: 2020 2020 2020 274c 6f77 6572 2074 6869        'Lower thi
-000073c0: 7320 6f62 6a65 6374 2074 6f20 6120 3a63  s object to a :c
-000073d0: 6c61 7373 3a60 6e75 7469 6c73 2e65 7661  lass:`nutils.eva
-000073e0: 6c75 6162 6c65 2e41 7272 6179 602e 270a  luable.Array`.'.
-000073f0: 0a0a 636c 6173 7320 4172 7261 7928 4576  ..class Array(Ev
-00007400: 616c 7561 626c 652c 206d 6574 6163 6c61  aluable, metacla
-00007410: 7373 3d5f 4172 7261 794d 6574 6129 3a0a  ss=_ArrayMeta):.
-00007420: 2020 2020 2727 270a 2020 2020 4261 7365      '''.    Base
-00007430: 2063 6c61 7373 2066 6f72 2061 7272 6179   class for array
-00007440: 2076 616c 7565 6420 6675 6e63 7469 6f6e   valued function
-00007450: 732e 0a0a 2020 2020 4174 7472 6962 7574  s...    Attribut
-00007460: 6573 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  es.    ---------
-00007470: 2d0a 2020 2020 7368 6170 6520 3a20 3a63  -.    shape : :c
-00007480: 6c61 7373 3a60 7475 706c 6560 206f 6620  lass:`tuple` of 
-00007490: 3a63 6c61 7373 3a60 696e 7460 5c5c 730a  :class:`int`\\s.
-000074a0: 2020 2020 2020 2020 5468 6520 7368 6170          The shap
-000074b0: 6520 6f66 2074 6869 7320 6172 7261 7920  e of this array 
-000074c0: 6675 6e63 7469 6f6e 2e0a 2020 2020 6e64  function..    nd
-000074d0: 696d 203a 203a 636c 6173 733a 6069 6e74  im : :class:`int
-000074e0: 600a 2020 2020 2020 2020 5468 6520 6e75  `.        The nu
-000074f0: 6d62 6572 206f 6620 6469 6d65 6e73 696f  mber of dimensio
-00007500: 6e73 206f 6620 7468 6973 2061 7272 6179  ns of this array
-00007510: 2061 7272 6179 2066 756e 6374 696f 6e2e   array function.
-00007520: 2020 4571 7561 6c20 746f 0a20 2020 2020    Equal to.     
-00007530: 2020 2060 606c 656e 2873 6861 7065 2960     ``len(shape)`
-00007540: 602e 0a20 2020 2064 7479 7065 203a 203a  `..    dtype : :
-00007550: 636c 6173 733a 6069 6e74 602c 203a 636c  class:`int`, :cl
-00007560: 6173 733a 6066 6c6f 6174 600a 2020 2020  ass:`float`.    
-00007570: 2020 2020 5468 6520 6474 7970 6520 6f66      The dtype of
-00007580: 2074 6865 2061 7272 6179 2065 6c65 6d65   the array eleme
-00007590: 6e74 732e 0a20 2020 2027 2727 0a0a 2020  nts..    '''..  
-000075a0: 2020 5f5f 6172 7261 795f 7072 696f 7269    __array_priori
-000075b0: 7479 5f5f 203d 2031 2e20 2023 2068 7474  ty__ = 1.  # htt
-000075c0: 703a 2f2f 7374 6163 6b6f 7665 7266 6c6f  p://stackoverflo
-000075d0: 772e 636f 6d2f 7175 6573 7469 6f6e 732f  w.com/questions/
-000075e0: 3730 3432 3439 362f 6e75 6d70 792d 636f  7042496/numpy-co
-000075f0: 6572 6369 6f6e 2d70 726f 626c 656d 2d66  ercion-problem-f
-00007600: 6f72 2d6c 6566 742d 7369 6465 642d 6269  or-left-sided-bi
-00007610: 6e61 7279 2d6f 7065 7261 746f 722f 3730  nary-operator/70
-00007620: 3537 3533 3023 3730 3537 3533 300a 0a20  57530#7057530.. 
-00007630: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00007640: 7365 6c66 2c20 6172 6773 2c20 7368 6170  self, args, shap
-00007650: 653a 2074 7970 696e 672e 5475 706c 655b  e: typing.Tuple[
-00007660: 2741 7272 6179 272c 202e 2e2e 5d2c 2064  'Array', ...], d
-00007670: 7479 7065 3a20 4474 7970 6529 3a0a 2020  type: Dtype):.  
-00007680: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-00007690: 6e73 7461 6e63 6528 7368 6170 652c 2074  nstance(shape, t
-000076a0: 7570 6c65 2920 616e 6420 616c 6c28 5f69  uple) and all(_i
-000076b0: 7369 6e64 6578 286e 2920 666f 7220 6e20  sindex(n) for n 
-000076c0: 696e 2073 6861 7065 292c 2066 2773 6861  in shape), f'sha
-000076d0: 7065 3d7b 7368 6170 6521 727d 270a 2020  pe={shape!r}'.  
-000076e0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-000076f0: 6e73 7461 6e63 6528 6474 7970 652c 2074  nstance(dtype, t
-00007700: 7970 6529 2061 6e64 2064 7479 7065 2069  ype) and dtype i
-00007710: 6e20 5f74 7970 655f 6f72 6465 722c 2066  n _type_order, f
-00007720: 2764 7479 7065 3d7b 6474 7970 6521 727d  'dtype={dtype!r}
-00007730: 270a 2020 2020 2020 2020 7365 6c66 2e73  '.        self.s
-00007740: 6861 7065 203d 2073 6861 7065 0a20 2020  hape = shape.   
-00007750: 2020 2020 2073 656c 662e 6474 7970 6520       self.dtype 
-00007760: 3d20 6474 7970 650a 2020 2020 2020 2020  = dtype.        
-00007770: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
-00007780: 2861 7267 733d 6172 6773 290a 0a20 2020  (args=args)..   
-00007790: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-000077a0: 6566 206e 6469 6d28 7365 6c66 293a 0a20  ef ndim(self):. 
-000077b0: 2020 2020 2020 2072 6574 7572 6e20 6c65         return le
-000077c0: 6e28 7365 6c66 2e73 6861 7065 290a 0a20  n(self.shape).. 
-000077d0: 2020 2064 6566 205f 5f67 6574 6974 656d     def __getitem
-000077e0: 5f5f 2873 656c 662c 2069 7465 6d29 3a0a  __(self, item):.
-000077f0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-00007800: 7369 6e73 7461 6e63 6528 6974 656d 2c20  sinstance(item, 
-00007810: 7475 706c 6529 3a0a 2020 2020 2020 2020  tuple):.        
-00007820: 2020 2020 6974 656d 203d 2069 7465 6d2c      item = item,
-00007830: 0a20 2020 2020 2020 2069 6620 2e2e 2e20  .        if ... 
-00007840: 696e 2069 7465 6d3a 0a20 2020 2020 2020  in item:.       
-00007850: 2020 2020 2069 656c 6c20 3d20 6974 656d       iell = item
-00007860: 2e69 6e64 6578 282e 2e2e 290a 2020 2020  .index(...).    
-00007870: 2020 2020 2020 2020 6966 202e 2e2e 2069          if ... i
-00007880: 6e20 6974 656d 5b69 656c 6c2b 313a 5d3a  n item[iell+1:]:
-00007890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000078a0: 2072 6169 7365 2049 6e64 6578 4572 726f   raise IndexErro
-000078b0: 7228 2761 6e20 696e 6465 7820 6361 6e20  r('an index can 
-000078c0: 6861 7665 206f 6e6c 7920 6120 7369 6e67  have only a sing
-000078d0: 6c65 2065 6c6c 6970 7369 7327 290a 2020  le ellipsis').  
-000078e0: 2020 2020 2020 2020 2020 2320 7265 706c            # repl
-000078f0: 6163 6520 656c 6c69 7073 6973 2062 7920  ace ellipsis by 
-00007900: 7468 6520 6170 7072 6f70 7269 6174 6520  the appropriate 
-00007910: 6e75 6d62 6572 206f 6620 736c 6963 6528  number of slice(
-00007920: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
-00007930: 2020 6974 656d 203d 2069 7465 6d5b 3a69    item = item[:i
-00007940: 656c 6c5d 202b 2028 736c 6963 6528 4e6f  ell] + (slice(No
-00007950: 6e65 292c 292a 2873 656c 662e 6e64 696d  ne),)*(self.ndim
-00007960: 2d6c 656e 2869 7465 6d29 2b31 2920 2b20  -len(item)+1) + 
-00007970: 6974 656d 5b69 656c 6c2b 313a 5d0a 2020  item[iell+1:].  
-00007980: 2020 2020 2020 6966 206c 656e 2869 7465        if len(ite
-00007990: 6d29 203e 2073 656c 662e 6e64 696d 3a0a  m) > self.ndim:.
-000079a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000079b0: 6520 496e 6465 7845 7272 6f72 2827 746f  e IndexError('to
-000079c0: 6f20 6d61 6e79 2069 6e64 6963 6573 2066  o many indices f
-000079d0: 6f72 2061 7272 6179 2729 0a20 2020 2020  or array').     
-000079e0: 2020 2061 7272 6179 203d 2073 656c 660a     array = self.
-000079f0: 2020 2020 2020 2020 666f 7220 6178 6973          for axis
-00007a00: 2c20 6974 2069 6e20 7265 7665 7273 6564  , it in reversed
-00007a10: 2874 7570 6c65 2865 6e75 6d65 7261 7465  (tuple(enumerate
-00007a20: 2869 7465 6d29 2929 3a0a 2020 2020 2020  (item))):.      
-00007a30: 2020 2020 2020 6172 7261 7920 3d20 6765        array = ge
-00007a40: 7428 6172 7261 792c 2061 7869 732c 2069  t(array, axis, i
-00007a50: 7465 6d3d 636f 6e73 7461 6e74 2869 7429  tem=constant(it)
-00007a60: 2920 6966 206e 756d 6572 6963 2e69 7369  ) if numeric.isi
-00007a70: 6e74 2869 7429 205c 0a20 2020 2020 2020  nt(it) \.       
-00007a80: 2020 2020 2020 2020 2065 6c73 6520 5f74           else _t
-00007a90: 616b 6573 6c69 6365 2861 7272 6179 2c20  akeslice(array, 
-00007aa0: 6974 2c20 6178 6973 2920 6966 2069 7369  it, axis) if isi
-00007ab0: 6e73 7461 6e63 6528 6974 2c20 736c 6963  nstance(it, slic
-00007ac0: 6529 205c 0a20 2020 2020 2020 2020 2020  e) \.           
-00007ad0: 2020 2020 2065 6c73 6520 7461 6b65 2861       else take(a
-00007ae0: 7272 6179 2c20 6974 2c20 6178 6973 290a  rray, it, axis).
-00007af0: 2020 2020 2020 2020 7265 7475 726e 2061          return a
-00007b00: 7272 6179 0a0a 2020 2020 6465 6620 5f5f  rray..    def __
-00007b10: 626f 6f6c 5f5f 2873 656c 6629 3a0a 2020  bool__(self):.  
-00007b20: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-00007b30: 650a 0a20 2020 2064 6566 205f 5f6c 656e  e..    def __len
-00007b40: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
-00007b50: 2020 6966 2073 656c 662e 6e64 696d 203d    if self.ndim =
-00007b60: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00007b70: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
-00007b80: 2827 6c65 6e28 2920 6f66 2075 6e73 697a  ('len() of unsiz
-00007b90: 6564 206f 626a 6563 7427 290a 2020 2020  ed object').    
-00007ba0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00007bb0: 7368 6170 655b 305d 0a0a 2020 2020 6465  shape[0]..    de
-00007bc0: 6620 5f5f 696e 6465 785f 5f28 7365 6c66  f __index__(self
-00007bd0: 293a 0a20 2020 2020 2020 2074 7279 3a0a  ):.        try:.
-00007be0: 2020 2020 2020 2020 2020 2020 696e 6465              inde
-00007bf0: 7820 3d20 7365 6c66 2e5f 5f69 6e64 6578  x = self.__index
-00007c00: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00007c10: 4174 7472 6962 7574 6545 7272 6f72 3a0a  AttributeError:.
-00007c20: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00007c30: 656c 662e 6e64 696d 206f 7220 7365 6c66  elf.ndim or self
-00007c40: 2e64 7479 7065 206e 6f74 2069 6e20 2869  .dtype not in (i
-00007c50: 6e74 2c20 626f 6f6c 2920 6f72 206e 6f74  nt, bool) or not
-00007c60: 2073 656c 662e 6973 636f 6e73 7461 6e74   self.isconstant
-00007c70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007c80: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
-00007c90: 7228 2763 616e 6e6f 7420 636f 6e76 6572  r('cannot conver
-00007ca0: 7420 7b21 727d 2074 6f20 696e 7427 2e66  t {!r} to int'.f
-00007cb0: 6f72 6d61 7428 7365 6c66 2929 0a20 2020  ormat(self)).   
-00007cc0: 2020 2020 2020 2020 2069 6e64 6578 203d           index =
-00007cd0: 2073 656c 662e 5f5f 696e 6465 7820 3d20   self.__index = 
-00007ce0: 696e 7428 7365 6c66 2e73 696d 706c 6966  int(self.simplif
-00007cf0: 6965 642e 6576 616c 2829 290a 2020 2020  ied.eval()).    
-00007d00: 2020 2020 7265 7475 726e 2069 6e64 6578      return index
-00007d10: 0a0a 2020 2020 5420 3d20 7072 6f70 6572  ..    T = proper
-00007d20: 7479 286c 616d 6264 6120 7365 6c66 3a20  ty(lambda self: 
-00007d30: 7472 616e 7370 6f73 6528 7365 6c66 2929  transpose(self))
-00007d40: 0a0a 2020 2020 5f5f 6164 645f 5f20 3d20  ..    __add__ = 
-00007d50: 5f5f 7261 6464 5f5f 203d 2061 6464 0a20  __radd__ = add. 
-00007d60: 2020 205f 5f73 7562 5f5f 203d 206c 616d     __sub__ = lam
-00007d70: 6264 6120 7365 6c66 2c20 6f74 6865 723a  bda self, other:
-00007d80: 2073 7562 7472 6163 7428 7365 6c66 2c20   subtract(self, 
-00007d90: 6f74 6865 7229 0a20 2020 205f 5f72 7375  other).    __rsu
-00007da0: 625f 5f20 3d20 6c61 6d62 6461 2073 656c  b__ = lambda sel
-00007db0: 662c 206f 7468 6572 3a20 7375 6274 7261  f, other: subtra
-00007dc0: 6374 286f 7468 6572 2c20 7365 6c66 290a  ct(other, self).
-00007dd0: 2020 2020 5f5f 6d75 6c5f 5f20 3d20 5f5f      __mul__ = __
-00007de0: 726d 756c 5f5f 203d 206d 756c 7469 706c  rmul__ = multipl
-00007df0: 790a 2020 2020 5f5f 7472 7565 6469 765f  y.    __truediv_
-00007e00: 5f20 3d20 6c61 6d62 6461 2073 656c 662c  _ = lambda self,
-00007e10: 206f 7468 6572 3a20 6469 7669 6465 2873   other: divide(s
-00007e20: 656c 662c 206f 7468 6572 290a 2020 2020  elf, other).    
-00007e30: 5f5f 7274 7275 6564 6976 5f5f 203d 206c  __rtruediv__ = l
-00007e40: 616d 6264 6120 7365 6c66 2c20 6f74 6865  ambda self, othe
-00007e50: 723a 2064 6976 6964 6528 6f74 6865 722c  r: divide(other,
-00007e60: 2073 656c 6629 0a20 2020 205f 5f70 6f73   self).    __pos
-00007e70: 5f5f 203d 206c 616d 6264 6120 7365 6c66  __ = lambda self
-00007e80: 3a20 7365 6c66 0a20 2020 205f 5f6e 6567  : self.    __neg
-00007e90: 5f5f 203d 206c 616d 6264 6120 7365 6c66  __ = lambda self
-00007ea0: 3a20 6e65 6761 7469 7665 2873 656c 6629  : negative(self)
-00007eb0: 0a20 2020 205f 5f70 6f77 5f5f 203d 2070  .    __pow__ = p
-00007ec0: 6f77 6572 0a20 2020 205f 5f61 6273 5f5f  ower.    __abs__
-00007ed0: 203d 206c 616d 6264 6120 7365 6c66 3a20   = lambda self: 
-00007ee0: 6162 7328 7365 6c66 290a 2020 2020 5f5f  abs(self).    __
-00007ef0: 6d6f 645f 5f20 3d20 6c61 6d62 6461 2073  mod__ = lambda s
-00007f00: 656c 662c 206f 7468 6572 3a20 6d6f 6428  elf, other: mod(
-00007f10: 7365 6c66 2c20 6f74 6865 7229 0a20 2020  self, other).   
-00007f20: 205f 5f69 6e74 5f5f 203d 205f 5f69 6e64   __int__ = __ind
-00007f30: 6578 5f5f 0a20 2020 205f 5f73 7472 5f5f  ex__.    __str__
-00007f40: 203d 205f 5f72 6570 725f 5f20 3d20 6c61   = __repr__ = la
-00007f50: 6d62 6461 2073 656c 663a 2027 7b7d 2e7b  mbda self: '{}.{
-00007f60: 7d3c 7b7d 3e27 2e66 6f72 6d61 7428 7479  }<{}>'.format(ty
-00007f70: 7065 2873 656c 6629 2e5f 5f6d 6f64 756c  pe(self).__modul
-00007f80: 655f 5f2c 2074 7970 6528 7365 6c66 292e  e__, type(self).
-00007f90: 5f5f 6e61 6d65 5f5f 2c20 7365 6c66 2e5f  __name__, self._
-00007fa0: 7368 6170 655f 7374 7228 666f 726d 3d73  shape_str(form=s
-00007fb0: 7472 2929 0a0a 2020 2020 6465 6620 5f73  tr))..    def _s
-00007fc0: 6861 7065 5f73 7472 2873 656c 662c 2066  hape_str(self, f
-00007fd0: 6f72 6d29 3a0a 2020 2020 2020 2020 6474  orm):.        dt
-00007fe0: 7970 6520 3d20 7365 6c66 2e64 7479 7065  ype = self.dtype
-00007ff0: 2e5f 5f6e 616d 655f 5f5b 305d 2069 6620  .__name__[0] if 
-00008000: 6861 7361 7474 7228 7365 6c66 2c20 2764  hasattr(self, 'd
-00008010: 7479 7065 2729 2065 6c73 6520 273f 270a  type') else '?'.
-00008020: 2020 2020 2020 2020 7368 6170 6520 3d20          shape = 
-00008030: 5b73 7472 286e 2e5f 5f69 6e64 6578 5f5f  [str(n.__index__
-00008040: 2829 2920 6966 206e 2e69 7363 6f6e 7374  ()) if n.isconst
-00008050: 616e 7420 656c 7365 2027 3f27 2066 6f72  ant else '?' for
-00008060: 206e 2069 6e20 7365 6c66 2e73 6861 7065   n in self.shape
-00008070: 5d0a 2020 2020 2020 2020 666f 7220 6920  ].        for i 
-00008080: 696e 2073 6574 2872 616e 6765 2873 656c  in set(range(sel
-00008090: 662e 6e64 696d 2929 202d 2073 6574 2873  f.ndim)) - set(s
-000080a0: 656c 662e 5f75 6e61 6c69 676e 6564 5b31  elf._unaligned[1
-000080b0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-000080c0: 7368 6170 655b 695d 203d 2066 2728 7b73  shape[i] = f'({s
-000080d0: 6861 7065 5b69 5d7d 2927 0a20 2020 2020  hape[i]})'.     
-000080e0: 2020 2066 6f72 2069 2c20 5f20 696e 2073     for i, _ in s
-000080f0: 656c 662e 5f69 6e66 6c61 7469 6f6e 733a  elf._inflations:
-00008100: 0a20 2020 2020 2020 2020 2020 2073 6861  .            sha
-00008110: 7065 5b69 5d20 3d20 6627 7e7b 7368 6170  pe[i] = f'~{shap
-00008120: 655b 695d 7d27 0a20 2020 2020 2020 2066  e[i]}'.        f
-00008130: 6f72 2061 7865 7320 696e 2073 656c 662e  or axes in self.
-00008140: 5f64 6961 676f 6e61 6c73 3a0a 2020 2020  _diagonals:.    
-00008150: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-00008160: 2061 7865 733a 0a20 2020 2020 2020 2020   axes:.         
-00008170: 2020 2020 2020 2073 6861 7065 5b69 5d20         shape[i] 
-00008180: 3d20 6627 7b73 6861 7065 5b69 5d7d 2f27  = f'{shape[i]}/'
-00008190: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000081a0: 6627 7b64 7479 7065 7d3a 7b22 2c22 2e6a  f'{dtype}:{",".j
-000081b0: 6f69 6e28 7368 6170 6529 7d27 0a0a 2020  oin(shape)}'..  
-000081c0: 2020 7375 6d20 3d20 7375 6d0a 2020 2020    sum = sum.    
-000081d0: 7072 6f64 203d 2070 726f 6475 6374 0a20  prod = product. 
-000081e0: 2020 2064 6f74 203d 2064 6f74 0a20 2020     dot = dot.   
-000081f0: 2073 7761 7061 7865 7320 3d20 7377 6170   swapaxes = swap
-00008200: 6178 6573 0a20 2020 2074 7261 6e73 706f  axes.    transpo
-00008210: 7365 203d 2074 7261 6e73 706f 7365 0a20  se = transpose. 
-00008220: 2020 2063 686f 6f73 6520 3d20 6c61 6d62     choose = lamb
-00008230: 6461 2073 656c 662c 2063 686f 6963 6573  da self, choices
-00008240: 3a20 4368 6f6f 7365 2873 656c 662c 202a  : Choose(self, *
-00008250: 6368 6f69 6365 7329 0a20 2020 2063 6f6e  choices).    con
-00008260: 6a75 6761 7465 203d 2063 6f6e 6a75 6761  jugate = conjuga
-00008270: 7465 0a0a 2020 2020 4070 726f 7065 7274  te..    @propert
-00008280: 790a 2020 2020 6465 6620 7265 616c 2873  y.    def real(s
-00008290: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-000082a0: 7475 726e 2072 6561 6c28 7365 6c66 290a  turn real(self).
-000082b0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-000082c0: 2020 2064 6566 2069 6d61 6728 7365 6c66     def imag(self
-000082d0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-000082e0: 6e20 696d 6167 2873 656c 6629 0a0a 2020  n imag(self)..  
-000082f0: 2020 4063 6163 6865 645f 7072 6f70 6572    @cached_proper
-00008300: 7479 0a20 2020 2064 6566 205f 6173 7370  ty.    def _assp
-00008310: 6172 7365 2873 656c 6629 3a0a 2020 2020  arse(self):.    
-00008320: 2020 2020 2320 436f 6e76 6572 7420 746f      # Convert to
-00008330: 2061 2073 6571 7565 6e63 6520 6f66 2073   a sequence of s
-00008340: 7061 7273 6520 434f 4f20 6172 7261 7973  parse COO arrays
-00008350: 2e20 5468 6520 7265 7475 726e 6564 2064  . The returned d
-00008360: 6174 6120 6973 2061 2074 7570 6c65 0a20  ata is a tuple. 
-00008370: 2020 2020 2020 2023 206f 6620 6028 2a69         # of `(*i
-00008380: 6e64 6963 6573 2c20 7661 6c75 6573 2960  ndices, values)`
-00008390: 2074 7570 6c65 732c 2077 6865 7265 2060   tuples, where `
-000083a0: 7661 6c75 6573 6020 6973 2061 6e20 6041  values` is an `A
-000083b0: 7272 6179 6020 7769 7468 2074 6865 0a20  rray` with the. 
-000083c0: 2020 2020 2020 2023 2073 616d 6520 6474         # same dt
-000083d0: 7970 6520 6173 2060 7365 6c66 602c 2062  ype as `self`, b
-000083e0: 7574 2074 6869 7320 6973 206e 6f74 2065  ut this is not e
-000083f0: 6e66 6f72 6365 6420 7965 742c 2061 6e64  nforced yet, and
-00008400: 2065 6163 6820 696e 6465 7820 696e 0a20   each index in. 
-00008410: 2020 2020 2020 2023 2060 696e 6469 6365         # `indice
-00008420: 7360 2069 7320 616e 2060 4172 7261 7960  s` is an `Array`
-00008430: 2077 6974 6820 6474 7970 6520 6069 6e74   with dtype `int
-00008440: 6020 616e 6420 7468 6520 6578 6163 7420  ` and the exact 
-00008450: 7361 6d65 2073 6861 7065 2061 730a 2020  same shape as.  
-00008460: 2020 2020 2020 2320 6076 616c 7565 7360        # `values`
-00008470: 2e20 5468 6520 6c65 6e67 7468 206f 6620  . The length of 
-00008480: 6069 6e64 6963 6573 6020 6571 7561 6c73  `indices` equals
-00008490: 2060 7365 6c66 2e6e 6469 6d60 2e20 496e   `self.ndim`. In
-000084a0: 2061 6464 6974 696f 6e2c 2069 660a 2020   addition, if.  
-000084b0: 2020 2020 2020 2320 6073 656c 6660 2069        # `self` i
-000084c0: 7320 3064 2074 6865 206c 656e 6774 6820  s 0d the length 
-000084d0: 6f66 2060 7365 6c66 2e5f 6173 7370 6172  of `self._asspar
-000084e0: 7365 6020 6973 2061 7420 6d6f 7374 206f  se` is at most o
-000084f0: 6e65 2061 6e64 2074 6865 0a20 2020 2020  ne and the.     
-00008500: 2020 2023 2060 7661 6c75 6573 6020 6172     # `values` ar
-00008510: 7261 7920 6d75 7374 2062 6520 3064 2061  ray must be 0d a
-00008520: 7320 7765 6c6c 2e0a 2020 2020 2020 2020  s well..        
-00008530: 230a 2020 2020 2020 2020 2320 5468 6520  #.        # The 
-00008540: 7370 6172 7365 2064 6174 6120 6361 6e20  sparse data can 
-00008550: 6265 2072 6561 7373 656d 626c 6564 2061  be reassembled a
-00008560: 6674 6572 2065 7661 6c75 6174 696f 6e20  fter evaluation 
-00008570: 6279 0a20 2020 2020 2020 2023 0a20 2020  by.        #.   
-00008580: 2020 2020 2023 2020 2020 2064 656e 7365       #     dense
-00008590: 203d 206e 756d 7079 2e7a 6572 6f73 2873   = numpy.zeros(s
-000085a0: 656c 662e 7368 6170 6529 0a20 2020 2020  elf.shape).     
-000085b0: 2020 2023 2020 2020 2066 6f72 2049 302c     #     for I0,
-000085c0: 2e2e 2e2c 496b 2c56 2069 6e20 7365 6c66  ...,Ik,V in self
-000085d0: 2e5f 6173 7370 6172 7365 3a0a 2020 2020  ._assparse:.    
-000085e0: 2020 2020 2320 2020 2020 2020 666f 7220      #       for 
-000085f0: 6930 2c2e 2e2e 2c69 6b2c 7620 696e 207a  i0,...,ik,v in z
-00008600: 6970 2849 302e 6576 616c 2829 2e72 6176  ip(I0.eval().rav
-00008610: 656c 2829 2c2e 2e2e 2c49 6b2e 6576 616c  el(),...,Ik.eval
-00008620: 2829 2e72 6176 656c 2829 2c56 2e65 7661  ().ravel(),V.eva
-00008630: 6c28 292e 7261 7665 6c28 2929 3a0a 2020  l().ravel()):.  
-00008640: 2020 2020 2020 2320 2020 2020 2020 2020        #         
-00008650: 6465 6e73 655b 6930 2c2e 2e2e 2c69 6b5d  dense[i0,...,ik]
-00008660: 203d 2076 0a0a 2020 2020 2020 2020 696e   = v..        in
-00008670: 6469 6365 7320 3d20 5b70 7265 7065 6e64  dices = [prepend
-00008680: 6178 6573 2861 7070 656e 6461 7865 7328  axes(appendaxes(
-00008690: 5261 6e67 6528 6c65 6e67 7468 292c 2073  Range(length), s
-000086a0: 656c 662e 7368 6170 655b 692b 313a 5d29  elf.shape[i+1:])
-000086b0: 2c20 7365 6c66 2e73 6861 7065 5b3a 695d  , self.shape[:i]
-000086c0: 2920 666f 7220 692c 206c 656e 6774 6820  ) for i, length 
-000086d0: 696e 2065 6e75 6d65 7261 7465 2873 656c  in enumerate(sel
-000086e0: 662e 7368 6170 6529 5d0a 2020 2020 2020  f.shape)].      
-000086f0: 2020 7265 7475 726e 2028 2a69 6e64 6963    return (*indic
-00008700: 6573 2c20 7365 6c66 292c 0a0a 2020 2020  es, self),..    
-00008710: 6465 6620 5f6e 6f64 6528 7365 6c66 2c20  def _node(self, 
-00008720: 6361 6368 652c 2073 7562 6772 6170 682c  cache, subgraph,
-00008730: 2074 696d 6573 293a 0a20 2020 2020 2020   times):.       
-00008740: 2069 6620 7365 6c66 2069 6e20 6361 6368   if self in cach
-00008750: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00008760: 6574 7572 6e20 6361 6368 655b 7365 6c66  eturn cache[self
-00008770: 5d0a 2020 2020 2020 2020 6172 6773 203d  ].        args =
-00008780: 2074 7570 6c65 2861 7267 2e5f 6e6f 6465   tuple(arg._node
-00008790: 2863 6163 6865 2c20 7375 6267 7261 7068  (cache, subgraph
-000087a0: 2c20 7469 6d65 7329 2066 6f72 2061 7267  , times) for arg
-000087b0: 2069 6e20 7365 6c66 2e5f 4576 616c 7561   in self._Evalua
-000087c0: 626c 655f 5f61 7267 7329 0a20 2020 2020  ble__args).     
-000087d0: 2020 2062 6f75 6e64 7320 3d20 275b 7b7d     bounds = '[{}
-000087e0: 2c7b 7d5d 272e 666f 726d 6174 282a 7365  ,{}]'.format(*se
-000087f0: 6c66 2e5f 696e 7462 6f75 6e64 7329 2069  lf._intbounds) i
-00008800: 6620 7365 6c66 2e64 7479 7065 203d 3d20  f self.dtype == 
-00008810: 696e 7420 656c 7365 204e 6f6e 650a 2020  int else None.  
-00008820: 2020 2020 2020 6c61 6265 6c20 3d20 275c        label = '\
-00008830: 6e27 2e6a 6f69 6e28 6669 6c74 6572 284e  n'.join(filter(N
-00008840: 6f6e 652c 2028 7479 7065 2873 656c 6629  one, (type(self)
-00008850: 2e5f 5f6e 616d 655f 5f2c 2073 656c 662e  .__name__, self.
-00008860: 5f6e 6f64 655f 6465 7461 696c 732c 2073  _node_details, s
-00008870: 656c 662e 5f73 6861 7065 5f73 7472 2866  elf._shape_str(f
-00008880: 6f72 6d3d 7265 7072 292c 2062 6f75 6e64  orm=repr), bound
-00008890: 7329 2929 0a20 2020 2020 2020 2063 6163  s))).        cac
-000088a0: 6865 5b73 656c 665d 203d 206e 6f64 6520  he[self] = node 
-000088b0: 3d20 5265 6775 6c61 724e 6f64 6528 6c61  = RegularNode(la
-000088c0: 6265 6c2c 2061 7267 732c 207b 7d2c 2028  bel, args, {}, (
-000088d0: 7479 7065 2873 656c 6629 2e5f 5f6e 616d  type(self).__nam
-000088e0: 655f 5f2c 2074 696d 6573 5b73 656c 665d  e__, times[self]
-000088f0: 292c 2073 7562 6772 6170 6829 0a20 2020  ), subgraph).   
-00008900: 2020 2020 2072 6574 7572 6e20 6e6f 6465       return node
-00008910: 0a0a 2020 2020 2320 7369 6d70 6c69 6669  ..    # simplifi
-00008920: 6361 7469 6f6e 730a 2020 2020 5f6d 756c  cations.    _mul
-00008930: 7469 706c 7920 3d20 6c61 6d62 6461 2073  tiply = lambda s
-00008940: 656c 662c 206f 7468 6572 3a20 4e6f 6e65  elf, other: None
-00008950: 0a20 2020 205f 7472 616e 7370 6f73 6520  .    _transpose 
-00008960: 3d20 6c61 6d62 6461 2073 656c 662c 2061  = lambda self, a
-00008970: 7865 733a 204e 6f6e 650a 2020 2020 5f69  xes: None.    _i
-00008980: 6e73 6572 7461 7869 7320 3d20 6c61 6d62  nsertaxis = lamb
-00008990: 6461 2073 656c 662c 2061 7869 732c 206c  da self, axis, l
-000089a0: 656e 6774 683a 204e 6f6e 650a 2020 2020  ength: None.    
-000089b0: 5f70 6f77 6572 203d 206c 616d 6264 6120  _power = lambda 
-000089c0: 7365 6c66 2c20 6e3a 204e 6f6e 650a 2020  self, n: None.  
-000089d0: 2020 5f61 6464 203d 206c 616d 6264 6120    _add = lambda 
-000089e0: 7365 6c66 2c20 6f74 6865 723a 204e 6f6e  self, other: Non
-000089f0: 650a 2020 2020 5f73 756d 203d 206c 616d  e.    _sum = lam
-00008a00: 6264 6120 7365 6c66 2c20 6178 6973 3a20  bda self, axis: 
-00008a10: 4e6f 6e65 0a20 2020 205f 7461 6b65 203d  None.    _take =
-00008a20: 206c 616d 6264 6120 7365 6c66 2c20 696e   lambda self, in
-00008a30: 6465 782c 2061 7869 733a 204e 6f6e 650a  dex, axis: None.
-00008a40: 2020 2020 5f72 7461 6b65 203d 206c 616d      _rtake = lam
-00008a50: 6264 6120 7365 6c66 2c20 696e 6465 782c  bda self, index,
-00008a60: 2061 7869 733a 204e 6f6e 650a 2020 2020   axis: None.    
-00008a70: 5f64 6574 6572 6d69 6e61 6e74 203d 206c  _determinant = l
-00008a80: 616d 6264 6120 7365 6c66 2c20 6178 6973  ambda self, axis
-00008a90: 312c 2061 7869 7332 3a20 4e6f 6e65 0a20  1, axis2: None. 
-00008aa0: 2020 205f 696e 7665 7273 6520 3d20 6c61     _inverse = la
-00008ab0: 6d62 6461 2073 656c 662c 2061 7869 7331  mbda self, axis1
-00008ac0: 2c20 6178 6973 323a 204e 6f6e 650a 2020  , axis2: None.  
-00008ad0: 2020 5f74 616b 6564 6961 6720 3d20 6c61    _takediag = la
-00008ae0: 6d62 6461 2073 656c 662c 2061 7869 7331  mbda self, axis1
-00008af0: 2c20 6178 6973 323a 204e 6f6e 650a 2020  , axis2: None.  
-00008b00: 2020 5f64 6961 676f 6e61 6c69 7a65 203d    _diagonalize =
-00008b10: 206c 616d 6264 6120 7365 6c66 2c20 6178   lambda self, ax
-00008b20: 6973 3a20 4e6f 6e65 0a20 2020 205f 7072  is: None.    _pr
-00008b30: 6f64 7563 7420 3d20 6c61 6d62 6461 2073  oduct = lambda s
-00008b40: 656c 663a 204e 6f6e 650a 2020 2020 5f73  elf: None.    _s
-00008b50: 6967 6e20 3d20 6c61 6d62 6461 2073 656c  ign = lambda sel
-00008b60: 663a 204e 6f6e 650a 2020 2020 5f65 6967  f: None.    _eig
-00008b70: 203d 206c 616d 6264 6120 7365 6c66 2c20   = lambda self, 
-00008b80: 7379 6d6d 6574 7269 633a 204e 6f6e 650a  symmetric: None.
-00008b90: 2020 2020 5f69 6e66 6c61 7465 203d 206c      _inflate = l
-00008ba0: 616d 6264 6120 7365 6c66 2c20 646f 666d  ambda self, dofm
-00008bb0: 6170 2c20 6c65 6e67 7468 2c20 6178 6973  ap, length, axis
-00008bc0: 3a20 4e6f 6e65 0a20 2020 205f 7269 6e66  : None.    _rinf
-00008bd0: 6c61 7465 203d 206c 616d 6264 6120 7365  late = lambda se
-00008be0: 6c66 2c20 6675 6e63 2c20 6c65 6e67 7468  lf, func, length
-00008bf0: 2c20 6178 6973 3a20 4e6f 6e65 0a20 2020  , axis: None.   
-00008c00: 205f 756e 7261 7665 6c20 3d20 6c61 6d62   _unravel = lamb
-00008c10: 6461 2073 656c 662c 2061 7869 732c 2073  da self, axis, s
-00008c20: 6861 7065 3a20 4e6f 6e65 0a20 2020 205f  hape: None.    _
-00008c30: 7261 7665 6c20 3d20 6c61 6d62 6461 2073  ravel = lambda s
-00008c40: 656c 662c 2061 7869 733a 204e 6f6e 650a  elf, axis: None.
-00008c50: 2020 2020 5f6c 6f6f 7073 756d 203d 206c      _loopsum = l
-00008c60: 616d 6264 6120 7365 6c66 2c20 6c6f 6f70  ambda self, loop
-00008c70: 5f69 6e64 6578 3a20 4e6f 6e65 2020 2320  _index: None  # 
-00008c80: 4e4f 5445 3a20 7479 7065 206f 6620 606c  NOTE: type of `l
-00008c90: 6f6f 705f 696e 6465 7860 2069 7320 605f  oop_index` is `_
-00008ca0: 4c6f 6f70 496e 6465 7860 0a20 2020 205f  LoopIndex`.    _
-00008cb0: 7265 616c 203d 206c 616d 6264 6120 7365  real = lambda se
-00008cc0: 6c66 3a20 4e6f 6e65 0a20 2020 205f 696d  lf: None.    _im
-00008cd0: 6167 203d 206c 616d 6264 6120 7365 6c66  ag = lambda self
-00008ce0: 3a20 4e6f 6e65 0a20 2020 205f 636f 6e6a  : None.    _conj
-00008cf0: 7567 6174 6520 3d20 6c61 6d62 6461 2073  ugate = lambda s
-00008d00: 656c 663a 204e 6f6e 650a 0a20 2020 2040  elf: None..    @
-00008d10: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00008d20: 205f 756e 616c 6967 6e65 6428 7365 6c66   _unaligned(self
-00008d30: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00008d40: 6e20 7365 6c66 2c20 7475 706c 6528 7261  n self, tuple(ra
-00008d50: 6e67 6528 7365 6c66 2e6e 6469 6d29 290a  nge(self.ndim)).
-00008d60: 0a20 2020 205f 6469 6167 6f6e 616c 7320  .    _diagonals 
-00008d70: 3d20 2829 0a20 2020 205f 696e 666c 6174  = ().    _inflat
-00008d80: 696f 6e73 203d 2028 290a 0a20 2020 2064  ions = ()..    d
-00008d90: 6566 205f 6465 7269 7661 7469 7665 2873  ef _derivative(s
-00008da0: 656c 662c 2076 6172 2c20 7365 656e 293a  elf, var, seen):
-00008db0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00008dc0: 2e64 7479 7065 2069 6e20 2862 6f6f 6c2c  .dtype in (bool,
-00008dd0: 2069 6e74 2920 6f72 2076 6172 206e 6f74   int) or var not
-00008de0: 2069 6e20 7365 6c66 2e61 7267 756d 656e   in self.argumen
-00008df0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00008e00: 7265 7475 726e 205a 6572 6f73 2873 656c  return Zeros(sel
-00008e10: 662e 7368 6170 6520 2b20 7661 722e 7368  f.shape + var.sh
-00008e20: 6170 652c 2064 7479 7065 3d73 656c 662e  ape, dtype=self.
-00008e30: 6474 7970 6529 0a20 2020 2020 2020 2072  dtype).        r
-00008e40: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
-00008e50: 7465 6445 7272 6f72 2827 6465 7269 7661  tedError('deriva
-00008e60: 7469 7665 206e 6f74 2064 6566 696e 6564  tive not defined
-00008e70: 2066 6f72 207b 7d27 2e66 6f72 6d61 7428   for {}'.format(
-00008e80: 7365 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f  self.__class__._
-00008e90: 5f6e 616d 655f 5f29 290a 0a20 2020 2040  _name__))..    @
-00008ea0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00008eb0: 2061 735f 6576 616c 7561 626c 655f 6172   as_evaluable_ar
-00008ec0: 7261 7928 7365 6c66 293a 0a20 2020 2020  ray(self):.     
-00008ed0: 2020 2027 7265 7475 726e 2073 656c 6627     'return self'
-00008ee0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00008ef0: 2073 656c 660a 0a20 2020 2040 6361 6368   self..    @cach
-00008f00: 6564 5f70 726f 7065 7274 790a 2020 2020  ed_property.    
-00008f10: 6465 6620 5f69 6e74 626f 756e 6473 2873  def _intbounds(s
-00008f20: 656c 6629 3a0a 2020 2020 2020 2020 2320  elf):.        # 
-00008f30: 696e 636c 7573 6976 6520 6c6f 7765 7220  inclusive lower 
-00008f40: 616e 6420 7570 7065 7220 626f 756e 6473  and upper bounds
-00008f50: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00008f60: 2e6e 6469 6d20 3d3d 2030 2061 6e64 2073  .ndim == 0 and s
-00008f70: 656c 662e 6474 7970 6520 3d3d 2069 6e74  elf.dtype == int
-00008f80: 2061 6e64 2073 656c 662e 6973 636f 6e73   and self.iscons
-00008f90: 7461 6e74 3a0a 2020 2020 2020 2020 2020  tant:.          
-00008fa0: 2020 7661 6c75 6520 3d20 7365 6c66 2e5f    value = self._
-00008fb0: 5f69 6e64 6578 5f5f 2829 0a20 2020 2020  _index__().     
-00008fc0: 2020 2020 2020 2072 6574 7572 6e20 7661         return va
-00008fd0: 6c75 652c 2076 616c 7565 0a20 2020 2020  lue, value.     
-00008fe0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00008ff0: 2020 2020 206c 6f77 6572 2c20 7570 7065       lower, uppe
-00009000: 7220 3d20 7365 6c66 2e5f 696e 7462 6f75  r = self._intbou
-00009010: 6e64 735f 696d 706c 2829 0a20 2020 2020  nds_impl().     
-00009020: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-00009030: 696e 7374 616e 6365 286c 6f77 6572 2c20  instance(lower, 
-00009040: 696e 7429 206f 7220 6c6f 7765 7220 3d3d  int) or lower ==
-00009050: 2066 6c6f 6174 2827 2d69 6e66 2729 206f   float('-inf') o
-00009060: 7220 6c6f 7765 7220 3d3d 2066 6c6f 6174  r lower == float
-00009070: 2827 696e 6627 290a 2020 2020 2020 2020  ('inf').        
-00009080: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-00009090: 7461 6e63 6528 7570 7065 722c 2069 6e74  tance(upper, int
-000090a0: 2920 6f72 2075 7070 6572 203d 3d20 666c  ) or upper == fl
-000090b0: 6f61 7428 272d 696e 6627 2920 6f72 2075  oat('-inf') or u
-000090c0: 7070 6572 203d 3d20 666c 6f61 7428 2769  pper == float('i
-000090d0: 6e66 2729 0a20 2020 2020 2020 2020 2020  nf').           
-000090e0: 2061 7373 6572 7420 6c6f 7765 7220 3c3d   assert lower <=
-000090f0: 2075 7070 6572 0a20 2020 2020 2020 2020   upper.         
-00009100: 2020 2072 6574 7572 6e20 6c6f 7765 722c     return lower,
-00009110: 2075 7070 6572 0a0a 2020 2020 6465 6620   upper..    def 
-00009120: 5f69 6e74 626f 756e 6473 5f69 6d70 6c28  _intbounds_impl(
-00009130: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
-00009140: 6574 7572 6e20 666c 6f61 7428 272d 696e  eturn float('-in
-00009150: 6627 292c 2066 6c6f 6174 2827 696e 6627  f'), float('inf'
-00009160: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
-00009170: 0a20 2020 2064 6566 205f 636f 6e73 745f  .    def _const_
-00009180: 756e 6966 6f72 6d28 7365 6c66 293a 0a20  uniform(self):. 
-00009190: 2020 2020 2020 2069 6620 7365 6c66 2e64         if self.d
-000091a0: 7479 7065 203d 3d20 696e 743a 0a20 2020  type == int:.   
-000091b0: 2020 2020 2020 2020 206c 6f77 6572 2c20           lower, 
-000091c0: 7570 7065 7220 3d20 7365 6c66 2e5f 696e  upper = self._in
-000091d0: 7462 6f75 6e64 730a 2020 2020 2020 2020  tbounds.        
-000091e0: 2020 2020 7265 7475 726e 206c 6f77 6572      return lower
-000091f0: 2069 6620 6c6f 7765 7220 3d3d 2075 7070   if lower == upp
-00009200: 6572 2065 6c73 6520 4e6f 6e65 0a0a 0a63  er else None...c
-00009210: 6c61 7373 204e 506f 696e 7473 2841 7272  lass NPoints(Arr
-00009220: 6179 293a 0a20 2020 2027 5468 6520 6c65  ay):.    'The le
-00009230: 6e67 7468 206f 6620 7468 6520 706f 696e  ngth of the poin
-00009240: 7473 2061 7869 732e 270a 0a20 2020 2064  ts axis.'..    d
-00009250: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00009260: 293a 0a20 2020 2020 2020 2073 7570 6572  ):.        super
-00009270: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
-00009280: 3d28 4556 414c 4152 4753 2c29 2c20 7368  =(EVALARGS,), sh
-00009290: 6170 653d 2829 2c20 6474 7970 653d 696e  ape=(), dtype=in
-000092a0: 7429 0a0a 2020 2020 4073 7461 7469 636d  t)..    @staticm
-000092b0: 6574 686f 640a 2020 2020 6465 6620 6576  ethod.    def ev
-000092c0: 616c 6628 6576 616c 6172 6773 293a 0a20  alf(evalargs):. 
-000092d0: 2020 2020 2020 2070 6f69 6e74 7320 3d20         points = 
-000092e0: 6576 616c 6172 6773 5b27 5f70 6f69 6e74  evalargs['_point
-000092f0: 7327 5d2e 636f 6f72 6473 0a20 2020 2020  s'].coords.     
-00009300: 2020 2072 6574 7572 6e20 7479 7065 732e     return types.
-00009310: 6672 6f7a 656e 6172 7261 7928 706f 696e  frozenarray(poin
-00009320: 7473 2e73 6861 7065 5b30 5d29 0a0a 2020  ts.shape[0])..  
-00009330: 2020 6465 6620 5f69 6e74 626f 756e 6473    def _intbounds
-00009340: 5f69 6d70 6c28 7365 6c66 293a 0a20 2020  _impl(self):.   
-00009350: 2020 2020 2072 6574 7572 6e20 302c 2066       return 0, f
-00009360: 6c6f 6174 2827 696e 6627 290a 0a0a 636c  loat('inf')...cl
-00009370: 6173 7320 506f 696e 7473 2841 7272 6179  ass Points(Array
-00009380: 293a 0a0a 2020 2020 6465 6620 5f5f 696e  ):..    def __in
-00009390: 6974 5f5f 2873 656c 662c 206e 706f 696e  it__(self, npoin
-000093a0: 7473 2c20 6e64 696d 293a 0a20 2020 2020  ts, ndim):.     
-000093b0: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
-000093c0: 745f 5f28 6172 6773 3d28 4556 414c 4152  t__(args=(EVALAR
-000093d0: 4753 2c29 2c20 7368 6170 653d 286e 706f  GS,), shape=(npo
-000093e0: 696e 7473 2c20 6e64 696d 292c 2064 7479  ints, ndim), dty
-000093f0: 7065 3d66 6c6f 6174 290a 0a20 2020 2040  pe=float)..    @
-00009400: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-00009410: 2064 6566 2065 7661 6c66 2865 7661 6c61   def evalf(evala
-00009420: 7267 7329 3a0a 2020 2020 2020 2020 7265  rgs):.        re
-00009430: 7475 726e 2065 7661 6c61 7267 735b 275f  turn evalargs['_
-00009440: 706f 696e 7473 275d 2e63 6f6f 7264 730a  points'].coords.
-00009450: 0a0a 636c 6173 7320 5765 6967 6874 7328  ..class Weights(
-00009460: 4172 7261 7929 3a0a 0a20 2020 2064 6566  Array):..    def
-00009470: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00009480: 6e70 6f69 6e74 7329 3a0a 2020 2020 2020  npoints):.      
-00009490: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
-000094a0: 5f5f 2861 7267 733d 2845 5641 4c41 5247  __(args=(EVALARG
-000094b0: 532c 292c 2073 6861 7065 3d28 6e70 6f69  S,), shape=(npoi
-000094c0: 6e74 732c 292c 2064 7479 7065 3d66 6c6f  nts,), dtype=flo
-000094d0: 6174 290a 0a20 2020 2040 7374 6174 6963  at)..    @static
-000094e0: 6d65 7468 6f64 0a20 2020 2064 6566 2065  method.    def e
-000094f0: 7661 6c66 2865 7661 6c61 7267 7329 3a0a  valf(evalargs):.
-00009500: 2020 2020 2020 2020 7765 6967 6874 7320          weights 
-00009510: 3d20 6576 616c 6172 6773 5b27 5f70 6f69  = evalargs['_poi
-00009520: 6e74 7327 5d2e 7765 6967 6874 730a 2020  nts'].weights.  
-00009530: 2020 2020 2020 6173 7365 7274 206e 756d        assert num
-00009540: 6572 6963 2e69 7361 7272 6179 2877 6569  eric.isarray(wei
-00009550: 6768 7473 2920 616e 6420 7765 6967 6874  ghts) and weight
-00009560: 732e 6e64 696d 203d 3d20 310a 2020 2020  s.ndim == 1.    
-00009570: 2020 2020 7265 7475 726e 2077 6569 6768      return weigh
-00009580: 7473 0a0a 0a63 6c61 7373 204f 7274 686f  ts...class Ortho
-00009590: 6e6f 726d 616c 2841 7272 6179 293a 0a20  normal(Array):. 
-000095a0: 2020 2027 6d61 6b65 2061 2076 6563 746f     'make a vecto
-000095b0: 7220 6f72 7468 6f6e 6f72 6d61 6c20 746f  r orthonormal to
-000095c0: 2061 2073 7562 7370 6163 6527 0a0a 2020   a subspace'..  
-000095d0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-000095e0: 656c 662c 2062 6173 6973 3a20 4172 7261  elf, basis: Arra
-000095f0: 792c 2076 6563 746f 723a 2041 7272 6179  y, vector: Array
-00009600: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
-00009610: 7420 6973 696e 7374 616e 6365 2862 6173  t isinstance(bas
-00009620: 6973 2c20 4172 7261 7929 2061 6e64 2062  is, Array) and b
-00009630: 6173 6973 2e6e 6469 6d20 3e3d 2032 2061  asis.ndim >= 2 a
-00009640: 6e64 2062 6173 6973 2e64 7479 7065 2021  nd basis.dtype !
-00009650: 3d20 636f 6d70 6c65 782c 2066 2762 6173  = complex, f'bas
-00009660: 6973 3d7b 6261 7369 7321 727d 270a 2020  is={basis!r}'.  
-00009670: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-00009680: 6e73 7461 6e63 6528 7665 6374 6f72 2c20  nstance(vector, 
-00009690: 4172 7261 7929 2061 6e64 2076 6563 746f  Array) and vecto
-000096a0: 722e 6e64 696d 203e 3d20 3120 616e 6420  r.ndim >= 1 and 
-000096b0: 7665 6374 6f72 2e64 7479 7065 2021 3d20  vector.dtype != 
-000096c0: 636f 6d70 6c65 782c 2066 2776 6563 746f  complex, f'vecto
-000096d0: 723d 7b76 6563 746f 7221 727d 270a 2020  r={vector!r}'.  
-000096e0: 2020 2020 2020 6173 7365 7274 2065 7175        assert equ
-000096f0: 616c 7368 6170 6528 6261 7369 732e 7368  alshape(basis.sh
-00009700: 6170 655b 3a2d 315d 2c20 7665 6374 6f72  ape[:-1], vector
-00009710: 2e73 6861 7065 290a 2020 2020 2020 2020  .shape).        
-00009720: 7365 6c66 2e5f 6261 7369 7320 3d20 6261  self._basis = ba
-00009730: 7369 730a 2020 2020 2020 2020 7365 6c66  sis.        self
-00009740: 2e5f 7665 6374 6f72 203d 2076 6563 746f  ._vector = vecto
-00009750: 720a 2020 2020 2020 2020 7375 7065 7228  r.        super(
-00009760: 292e 5f5f 696e 6974 5f5f 2861 7267 733d  ).__init__(args=
-00009770: 2862 6173 6973 2c20 7665 6374 6f72 292c  (basis, vector),
-00009780: 2073 6861 7065 3d76 6563 746f 722e 7368   shape=vector.sh
-00009790: 6170 652c 2064 7479 7065 3d66 6c6f 6174  ape, dtype=float
-000097a0: 290a 0a20 2020 2064 6566 205f 7369 6d70  )..    def _simp
-000097b0: 6c69 6669 6564 2873 656c 6629 3a0a 2020  lified(self):.  
-000097c0: 2020 2020 2020 6966 205f 6571 7561 6c73        if _equals
-000097d0: 5f73 6361 6c61 725f 636f 6e73 7461 6e74  _scalar_constant
-000097e0: 2873 656c 662e 7368 6170 655b 2d31 5d2c  (self.shape[-1],
-000097f0: 2031 293a 0a20 2020 2020 2020 2020 2020   1):.           
-00009800: 2072 6574 7572 6e20 5369 676e 2873 656c   return Sign(sel
-00009810: 662e 5f76 6563 746f 7229 0a20 2020 2020  f._vector).     
-00009820: 2020 2062 6173 6973 2c20 7665 6374 6f72     basis, vector
-00009830: 2c20 7768 6572 6520 3d20 756e 616c 6967  , where = unalig
-00009840: 6e28 7365 6c66 2e5f 6261 7369 732c 2073  n(self._basis, s
-00009850: 656c 662e 5f76 6563 746f 722c 206e 6178  elf._vector, nax
-00009860: 6573 3d73 656c 662e 6e64 696d 202d 2031  es=self.ndim - 1
-00009870: 290a 2020 2020 2020 2020 6966 206c 656e  ).        if len
-00009880: 2877 6865 7265 2920 3c20 7365 6c66 2e6e  (where) < self.n
-00009890: 6469 6d20 2d20 313a 0a20 2020 2020 2020  dim - 1:.       
-000098a0: 2020 2020 2072 6574 7572 6e20 616c 6967       return alig
-000098b0: 6e28 4f72 7468 6f6e 6f72 6d61 6c28 6261  n(Orthonormal(ba
-000098c0: 7369 732c 2076 6563 746f 7229 2c20 282a  sis, vector), (*
-000098d0: 7768 6572 652c 2073 656c 662e 6e64 696d  where, self.ndim
-000098e0: 202d 2031 292c 2073 656c 662e 7368 6170   - 1), self.shap
-000098f0: 6529 0a0a 2020 2020 4073 7461 7469 636d  e)..    @staticm
-00009900: 6574 686f 640a 2020 2020 6465 6620 6576  ethod.    def ev
-00009910: 616c 6628 472c 206e 293a 0a20 2020 2020  alf(G, n):.     
-00009920: 2020 2047 4720 3d20 6e75 6d70 792e 6569     GG = numpy.ei
-00009930: 6e73 756d 2827 2e2e 2e6b 692c 2e2e 2e6b  nsum('...ki,...k
-00009940: 6a2d 3e2e 2e2e 696a 272c 2047 2c20 4729  j->...ij', G, G)
-00009950: 0a20 2020 2020 2020 2076 3120 3d20 6e75  .        v1 = nu
-00009960: 6d70 792e 6569 6e73 756d 2827 2e2e 2e69  mpy.einsum('...i
-00009970: 6a2c 2e2e 2e69 2d3e 2e2e 2e6a 272c 2047  j,...i->...j', G
-00009980: 2c20 6e29 0a20 2020 2020 2020 2076 3220  , n).        v2 
-00009990: 3d20 6e75 6d70 792e 6c69 6e61 6c67 2e73  = numpy.linalg.s
-000099a0: 6f6c 7665 2847 472c 2076 3129 0a20 2020  olve(GG, v1).   
-000099b0: 2020 2020 2076 3320 3d20 6e75 6d70 792e       v3 = numpy.
-000099c0: 6569 6e73 756d 2827 2e2e 2e69 6a2c 2e2e  einsum('...ij,..
-000099d0: 2e6a 2d3e 2e2e 2e69 272c 2047 2c20 7632  .j->...i', G, v2
-000099e0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000099f0: 206e 756d 6572 6963 2e6e 6f72 6d61 6c69   numeric.normali
-00009a00: 7a65 286e 202d 2076 3329 0a0a 2020 2020  ze(n - v3)..    
-00009a10: 6465 6620 5f64 6572 6976 6174 6976 6528  def _derivative(
-00009a20: 7365 6c66 2c20 7661 722c 2073 6565 6e29  self, var, seen)
-00009a30: 3a0a 2020 2020 2020 2020 6966 205f 6571  :.        if _eq
-00009a40: 7561 6c73 5f73 6361 6c61 725f 636f 6e73  uals_scalar_cons
-00009a50: 7461 6e74 2873 656c 662e 7368 6170 655b  tant(self.shape[
-00009a60: 2d31 5d2c 2031 293a 0a20 2020 2020 2020  -1], 1):.       
-00009a70: 2020 2020 2072 6574 7572 6e20 7a65 726f       return zero
-00009a80: 7328 7365 6c66 2e73 6861 7065 202b 2076  s(self.shape + v
-00009a90: 6172 2e73 6861 7065 290a 0a20 2020 2020  ar.shape)..     
-00009aa0: 2020 2023 2064 6566 696e 6974 696f 6e73     # definitions
-00009ab0: 3a0a 2020 2020 2020 2020 230a 2020 2020  :.        #.    
-00009ac0: 2020 2020 2320 5020 3a3d 2049 202d 2047      # P := I - G
-00009ad0: 2028 475e 5420 4729 5e2d 3120 475e 5420   (G^T G)^-1 G^T 
-00009ae0: 286f 7274 686f 676f 6e61 6c20 7072 6f6a  (orthogonal proj
-00009af0: 6563 746f 7229 0a20 2020 2020 2020 2023  ector).        #
-00009b00: 206e 203a 3d20 5020 7620 286f 7274 686f   n := P v (ortho
-00009b10: 676f 6e61 6c20 7072 6f6a 6563 7469 6f6e  gonal projection
-00009b20: 206f 6620 7629 0a20 2020 2020 2020 2023   of v).        #
-00009b30: 204e 203a 3d20 6e20 2f20 7c6e 7c20 2873   N := n / |n| (s
-00009b40: 656c 663a 206f 7274 686f 6e6f 726d 616c  elf: orthonormal
-00009b50: 2070 726f 6a65 6374 696f 6e20 6f66 2076   projection of v
-00009b60: 290a 2020 2020 2020 2020 230a 2020 2020  ).        #.    
-00009b70: 2020 2020 2320 6964 656e 7469 7469 6573      # identities
-00009b80: 3a0a 2020 2020 2020 2020 230a 2020 2020  :.        #.    
-00009b90: 2020 2020 2320 2020 505e 5420 3d20 5020      #   P^T = P 
-00009ba0: 2020 2020 2020 2020 204e 5e54 204e 203d           N^T N =
-00009bb0: 2031 0a20 2020 2020 2020 2023 2020 2050   1.        #   P
-00009bc0: 2050 203d 2050 2020 2020 2020 2020 2020   P = P          
-00009bd0: 5020 4e20 3d20 4e0a 2020 2020 2020 2020  P N = N.        
-00009be0: 2320 2020 5020 4720 3d20 5020 5120 3d20  #   P G = P Q = 
-00009bf0: 3020 2020 2047 5e54 204e 203d 2051 5e54  0    G^T N = Q^T
-00009c00: 204e 203d 2030 0a20 2020 2020 2020 2023   N = 0.        #
-00009c10: 0a20 2020 2020 2020 2023 2064 6572 6976  .        # deriv
-00009c20: 6174 6976 6573 3a0a 2020 2020 2020 2020  atives:.        
-00009c30: 230a 2020 2020 2020 2020 2320 5027 203d  #.        # P' =
-00009c40: 2051 2050 202b 2050 2051 5e54 2077 6865   Q P + P Q^T whe
-00009c50: 7265 2051 203a 3d20 2d47 2028 475e 5420  re Q := -G (G^T 
-00009c60: 4729 5e2d 3120 4727 5e54 0a20 2020 2020  G)^-1 G'^T.     
-00009c70: 2020 2023 206e 2720 3d20 5027 2076 202b     # n' = P' v +
-00009c80: 2050 2076 270a 2020 2020 2020 2020 2320   P v'.        # 
-00009c90: 2020 203d 2051 206e 202b 2050 2028 515e     = Q n + P (Q^
-00009ca0: 5420 7620 2b20 7627 290a 2020 2020 2020  T v + v').      
-00009cb0: 2020 2320 4e27 203d 2028 4920 2d20 4e20    # N' = (I - N 
-00009cc0: 4e5e 5429 206e 2720 2f20 7c6e 7c0a 2020  N^T) n' / |n|.  
-00009cd0: 2020 2020 2020 2320 2020 203d 2028 4920        #    = (I 
-00009ce0: 2d20 4e20 4e5e 5429 2028 5120 6e20 2f20  - N N^T) (Q n / 
-00009cf0: 7c6e 7c20 2b20 5020 2851 5e54 2076 202b  |n| + P (Q^T v +
-00009d00: 2076 2729 202f 207c 6e7c 290a 2020 2020   v') / |n|).    
-00009d10: 2020 2020 2320 2020 203d 2051 204e 202b      #    = Q N +
-00009d20: 2028 5020 2d20 4e20 4e5e 5429 2028 515e   (P - N N^T) (Q^
-00009d30: 5420 7620 2b20 7627 2920 2f20 7c6e 7c0a  T v + v') / |n|.
-00009d40: 0a20 2020 2020 2020 2047 203d 2073 656c  .        G = sel
-00009d50: 662e 5f62 6173 6973 0a20 2020 2020 2020  f._basis.       
-00009d60: 2069 6e76 4747 203d 2069 6e76 6572 7365   invGG = inverse
-00009d70: 2865 696e 7375 6d28 2741 6b69 2c41 6b6a  (einsum('Aki,Akj
-00009d80: 2d3e 4169 6a27 2c20 472c 2047 2929 0a0a  ->Aij', G, G))..
-00009d90: 2020 2020 2020 2020 5120 3d20 2d65 696e          Q = -ein
-00009da0: 7375 6d28 2741 696d 2c41 6d6e 2c41 6a6e  sum('Aim,Amn,Ajn
-00009db0: 422d 3e41 696a 4227 2c20 472c 2069 6e76  B->AijB', G, inv
-00009dc0: 4747 2c20 6465 7269 7661 7469 7665 2847  GG, derivative(G
-00009dd0: 2c20 7661 722c 2073 6565 6e29 290a 2020  , var, seen)).  
-00009de0: 2020 2020 2020 514e 203d 2065 696e 7375        QN = einsu
-00009df0: 6d28 2741 692c 416a 6942 2d3e 416a 4227  m('Ai,AjiB->AjB'
-00009e00: 2c20 7365 6c66 2c20 5129 0a0a 2020 2020  , self, Q)..    
-00009e10: 2020 2020 6966 205f 6571 7561 6c73 5f73      if _equals_s
-00009e20: 696d 706c 6966 6965 6428 472e 7368 6170  implified(G.shap
-00009e30: 655b 2d31 5d2c 2047 2e73 6861 7065 5b2d  e[-1], G.shape[-
-00009e40: 325d 202d 2031 293a 2023 2064 696d 286b  2] - 1): # dim(k
-00009e50: 6572 6e28 4729 2920 3d20 310a 2020 2020  ern(G)) = 1.    
-00009e60: 2020 2020 2020 2020 2320 496e 2074 6869          # In thi
-00009e70: 7320 7369 7475 6174 696f 6e2c 2073 696e  s situation, sin
-00009e80: 6365 204e 2069 7320 6120 6261 7369 7320  ce N is a basis 
-00009e90: 666f 7220 7468 6520 6b65 726e 656c 206f  for the kernel o
-00009ea0: 6620 472c 2077 650a 2020 2020 2020 2020  f G, we.        
-00009eb0: 2020 2020 2320 6861 7665 2074 6865 2069      # have the i
-00009ec0: 6465 6e74 6974 7920 5020 3d3d 204e 204e  dentity P == N N
-00009ed0: 5e54 2077 6869 6368 2063 616e 6365 6c73  ^T which cancels
-00009ee0: 2074 6865 2065 6e74 6972 6520 7365 636f   the entire seco
-00009ef0: 6e64 2074 6572 6d0a 2020 2020 2020 2020  nd term.        
-00009f00: 2020 2020 2320 6f66 204e 2720 616c 6f6e      # of N' alon
-00009f10: 6720 7769 7468 2061 6e79 2072 6566 6572  g with any refer
-00009f20: 656e 6365 2074 6f20 7627 2c20 7265 6475  ence to v', redu
-00009f30: 6369 6e67 2069 7420 746f 204e 2720 3d20  cing it to N' = 
-00009f40: 5120 4e2e 0a20 2020 2020 2020 2020 2020  Q N..           
-00009f50: 2072 6574 7572 6e20 514e 0a0a 2020 2020   return QN..    
-00009f60: 2020 2020 7620 3d20 7365 6c66 2e5f 7665      v = self._ve
-00009f70: 6374 6f72 0a20 2020 2020 2020 2050 203d  ctor.        P =
-00009f80: 2044 6961 676f 6e61 6c69 7a65 286f 6e65   Diagonalize(one
-00009f90: 7328 7365 6c66 2e73 6861 7065 2929 202d  s(self.shape)) -
-00009fa0: 2065 696e 7375 6d28 2741 696d 2c41 6d6e   einsum('Aim,Amn
-00009fb0: 2c41 6a6e 2d3e 4169 6a27 2c20 472c 2069  ,Ajn->Aij', G, i
-00009fc0: 6e76 4747 2c20 4729 0a20 2020 2020 2020  nvGG, G).       
-00009fd0: 205a 203d 2050 202d 2065 696e 7375 6d28   Z = P - einsum(
-00009fe0: 2741 692c 416a 2d3e 4169 6a27 2c20 7365  'Ai,Aj->Aij', se
-00009ff0: 6c66 2c20 7365 6c66 2920 2320 5020 2d20  lf, self) # P - 
-0000a000: 4e20 4e5e 540a 0a20 2020 2020 2020 2072  N N^T..        r
-0000a010: 6574 7572 6e20 514e 202b 2065 696e 7375  eturn QN + einsu
-0000a020: 6d28 2741 2c41 6942 2d3e 4169 4227 2c0a  m('A,AiB->AiB',.
-0000a030: 2020 2020 2020 2020 2020 2020 706f 7765              powe
-0000a040: 7228 6569 6e73 756d 2827 4169 2c41 696a  r(einsum('Ai,Aij
-0000a050: 2c41 6a2d 3e41 272c 2076 2c20 502c 2076  ,Aj->A', v, P, v
-0000a060: 292c 202d 2e35 292c 0a20 2020 2020 2020  ), -.5),.       
-0000a070: 2020 2020 2065 696e 7375 6d28 2741 696a       einsum('Aij
-0000a080: 2c41 6a42 2d3e 4169 4227 2c20 5a2c 2065  ,AjB->AiB', Z, e
-0000a090: 696e 7375 6d28 2741 692c 4169 6a42 2d3e  insum('Ai,AijB->
-0000a0a0: 416a 4227 2c20 762c 2051 2920 2b20 6465  AjB', v, Q) + de
-0000a0b0: 7269 7661 7469 7665 2876 2c20 7661 722c  rivative(v, var,
-0000a0c0: 2073 6565 6e29 2929 0a0a 0a63 6c61 7373   seen)))...class
-0000a0d0: 2043 6f6e 7374 616e 7428 4172 7261 7929   Constant(Array)
-0000a0e0: 3a0a 0a20 2020 2064 6566 205f 5f69 6e69  :..    def __ini
-0000a0f0: 745f 5f28 7365 6c66 2c20 7661 6c75 653a  t__(self, value:
-0000a100: 2074 7970 6573 2e61 7272 6179 6461 7461   types.arraydata
-0000a110: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
-0000a120: 7420 6973 696e 7374 616e 6365 2876 616c  t isinstance(val
-0000a130: 7565 2c20 7479 7065 732e 6172 7261 7964  ue, types.arrayd
-0000a140: 6174 6129 2c20 6627 7661 6c75 653d 7b76  ata), f'value={v
-0000a150: 616c 7565 2172 7d27 0a20 2020 2020 2020  alue!r}'.       
-0000a160: 2073 656c 662e 7661 6c75 6520 3d20 6e75   self.value = nu
-0000a170: 6d70 792e 6173 6172 7261 7928 7661 6c75  mpy.asarray(valu
-0000a180: 6529 0a20 2020 2020 2020 2073 7570 6572  e).        super
-0000a190: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
-0000a1a0: 3d28 292c 2073 6861 7065 3d74 7570 6c65  =(), shape=tuple
-0000a1b0: 2863 6f6e 7374 616e 7428 6e29 2066 6f72  (constant(n) for
-0000a1c0: 206e 2069 6e20 7661 6c75 652e 7368 6170   n in value.shap
-0000a1d0: 6529 2c20 6474 7970 653d 7661 6c75 652e  e), dtype=value.
-0000a1e0: 6474 7970 6529 0a0a 2020 2020 6465 6620  dtype)..    def 
-0000a1f0: 5f73 696d 706c 6966 6965 6428 7365 6c66  _simplified(self
-0000a200: 293a 0a20 2020 2020 2020 2069 6620 6e6f  ):.        if no
-0000a210: 7420 7365 6c66 2e76 616c 7565 2e61 6e79  t self.value.any
-0000a220: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0000a230: 7265 7475 726e 207a 6572 6f73 5f6c 696b  return zeros_lik
-0000a240: 6528 7365 6c66 290a 2020 2020 2020 2020  e(self).        
-0000a250: 6966 2073 656c 662e 6e64 696d 203d 3d20  if self.ndim == 
-0000a260: 3120 616e 6420 7365 6c66 2e64 7479 7065  1 and self.dtype
-0000a270: 203d 3d20 696e 7420 616e 6420 6e75 6d70   == int and nump
-0000a280: 792e 616c 6c28 7365 6c66 2e76 616c 7565  y.all(self.value
-0000a290: 203d 3d20 6e75 6d70 792e 6172 616e 6765   == numpy.arange
-0000a2a0: 2873 656c 662e 7661 6c75 652e 7368 6170  (self.value.shap
-0000a2b0: 655b 305d 2929 3a0a 2020 2020 2020 2020  e[0])):.        
-0000a2c0: 2020 2020 7265 7475 726e 2052 616e 6765      return Range
-0000a2d0: 2873 656c 662e 7368 6170 655b 305d 290a  (self.shape[0]).
-0000a2e0: 2020 2020 2020 2020 666f 7220 692c 2073          for i, s
-0000a2f0: 6820 696e 2065 6e75 6d65 7261 7465 2873  h in enumerate(s
-0000a300: 656c 662e 7368 6170 6529 3a0a 2020 2020  elf.shape):.    
-0000a310: 2020 2020 2020 2020 2320 4669 6e64 2061          # Find a
-0000a320: 6e64 2072 6570 6c61 6365 2069 6e76 6172  nd replace invar
-0000a330: 6961 6e74 2061 7865 7320 7769 7468 2049  iant axes with I
-0000a340: 6e73 6572 7441 7869 732e 2053 696e 6365  nsertAxis. Since
-0000a350: 2060 7365 6c66 2e76 616c 7565 2e61 6e79   `self.value.any
-0000a360: 2829 600a 2020 2020 2020 2020 2020 2020  ()`.            
-0000a370: 2320 6973 2046 616c 7365 2066 6f72 2061  # is False for a
-0000a380: 7272 6179 7320 7769 7468 2061 207a 6572  rrays with a zer
-0000a390: 6f2d 6c65 6e67 7468 2061 7869 732c 2077  o-length axis, w
-0000a3a0: 6520 6361 6e20 6172 7269 7665 2068 6572  e can arrive her
-0000a3b0: 6520 6f6e 6c79 2069 6620 616c 6c0a 2020  e only if all.  
-0000a3c0: 2020 2020 2020 2020 2020 2320 6178 6573            # axes
-0000a3d0: 2068 6176 6520 6174 206c 6561 7374 206c   have at least l
-0000a3e0: 656e 6774 6820 6f6e 652c 2068 656e 6365  ength one, hence
-0000a3f0: 2074 6865 2066 6f6c 6c6f 7769 6e67 2073   the following s
-0000a400: 7461 7465 6d65 6e74 2073 686f 756c 6420  tatement should 
-0000a410: 776f 726b 2e0a 2020 2020 2020 2020 2020  work..          
-0000a420: 2020 6669 7273 742c 202a 6f74 6865 7273    first, *others
-0000a430: 203d 206e 756d 7079 2e72 6f6c 6c61 7869   = numpy.rollaxi
-0000a440: 7328 7365 6c66 2e76 616c 7565 2c20 6929  s(self.value, i)
-0000a450: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000a460: 616c 6c28 6e75 6d70 792e 6571 7561 6c28  all(numpy.equal(
-0000a470: 6669 7273 742c 206f 7468 6572 292e 616c  first, other).al
-0000a480: 6c28 2920 666f 7220 6f74 6865 7220 696e  l() for other in
-0000a490: 206f 7468 6572 7329 3a0a 2020 2020 2020   others):.      
-0000a4a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000a4b0: 2069 6e73 6572 7461 7869 7328 636f 6e73   insertaxis(cons
-0000a4c0: 7461 6e74 2866 6972 7374 292c 2069 2c20  tant(first), i, 
-0000a4d0: 7368 290a 0a20 2020 2064 6566 2065 7661  sh)..    def eva
-0000a4e0: 6c66 2873 656c 6629 3a0a 2020 2020 2020  lf(self):.      
-0000a4f0: 2020 7265 7475 726e 2073 656c 662e 7661    return self.va
-0000a500: 6c75 650a 0a20 2020 2064 6566 205f 6e6f  lue..    def _no
-0000a510: 6465 2873 656c 662c 2063 6163 6865 2c20  de(self, cache, 
-0000a520: 7375 6267 7261 7068 2c20 7469 6d65 7329  subgraph, times)
-0000a530: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
-0000a540: 662e 6e64 696d 3a0a 2020 2020 2020 2020  f.ndim:.        
-0000a550: 2020 2020 7265 7475 726e 2073 7570 6572      return super
-0000a560: 2829 2e5f 6e6f 6465 2863 6163 6865 2c20  ()._node(cache, 
-0000a570: 7375 6267 7261 7068 2c20 7469 6d65 7329  subgraph, times)
-0000a580: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
-0000a590: 6c66 2069 6e20 6361 6368 653a 0a20 2020  lf in cache:.   
-0000a5a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000a5b0: 6361 6368 655b 7365 6c66 5d0a 2020 2020  cache[self].    
-0000a5c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000a5d0: 2020 2020 2020 6c61 6265 6c20 3d20 277b        label = '{
-0000a5e0: 7d27 2e66 6f72 6d61 7428 7365 6c66 2e76  }'.format(self.v
-0000a5f0: 616c 7565 5b28 295d 290a 2020 2020 2020  alue[()]).      
-0000a600: 2020 2020 2020 6966 206c 656e 286c 6162        if len(lab
-0000a610: 656c 2920 3e20 393a 0a20 2020 2020 2020  el) > 9:.       
-0000a620: 2020 2020 2020 2020 206c 6162 656c 203d           label =
-0000a630: 2027 7e7b 3a2e 3265 7d27 2e66 6f72 6d61   '~{:.2e}'.forma
-0000a640: 7428 7365 6c66 2e76 616c 7565 5b28 295d  t(self.value[()]
-0000a650: 290a 2020 2020 2020 2020 2020 2020 6361  ).            ca
-0000a660: 6368 655b 7365 6c66 5d20 3d20 6e6f 6465  che[self] = node
-0000a670: 203d 2044 7570 6c69 6361 7465 644c 6561   = DuplicatedLea
-0000a680: 664e 6f64 6528 6c61 6265 6c2c 2028 7479  fNode(label, (ty
-0000a690: 7065 2873 656c 6629 2e5f 5f6e 616d 655f  pe(self).__name_
-0000a6a0: 5f2c 2074 696d 6573 5b73 656c 665d 2929  _, times[self]))
-0000a6b0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000a6c0: 7572 6e20 6e6f 6465 0a0a 2020 2020 4063  urn node..    @c
-0000a6d0: 6163 6865 645f 7072 6f70 6572 7479 0a20  ached_property. 
-0000a6e0: 2020 2064 6566 205f 6973 756e 6974 2873     def _isunit(s
-0000a6f0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-0000a700: 7475 726e 206e 756d 7079 2e65 7175 616c  turn numpy.equal
-0000a710: 2873 656c 662e 7661 6c75 652c 2031 292e  (self.value, 1).
-0000a720: 616c 6c28 290a 0a20 2020 2064 6566 205f  all()..    def _
-0000a730: 7472 616e 7370 6f73 6528 7365 6c66 2c20  transpose(self, 
-0000a740: 6178 6573 293a 0a20 2020 2020 2020 2072  axes):.        r
-0000a750: 6574 7572 6e20 636f 6e73 7461 6e74 2873  eturn constant(s
-0000a760: 656c 662e 7661 6c75 652e 7472 616e 7370  elf.value.transp
-0000a770: 6f73 6528 6178 6573 2929 0a0a 2020 2020  ose(axes))..    
-0000a780: 6465 6620 5f73 756d 2873 656c 662c 2061  def _sum(self, a
-0000a790: 7869 7329 3a0a 2020 2020 2020 2020 7265  xis):.        re
-0000a7a0: 7475 726e 2063 6f6e 7374 616e 7428 6e75  turn constant(nu
-0000a7b0: 6d70 792e 7375 6d28 7365 6c66 2e76 616c  mpy.sum(self.val
-0000a7c0: 7565 2c20 6178 6973 2929 0a0a 2020 2020  ue, axis))..    
-0000a7d0: 6465 6620 5f61 6464 2873 656c 662c 206f  def _add(self, o
-0000a7e0: 7468 6572 293a 0a20 2020 2020 2020 2069  ther):.        i
-0000a7f0: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
-0000a800: 6572 2c20 436f 6e73 7461 6e74 293a 0a20  er, Constant):. 
-0000a810: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000a820: 6e20 636f 6e73 7461 6e74 286e 756d 7079  n constant(numpy
-0000a830: 2e61 6464 2873 656c 662e 7661 6c75 652c  .add(self.value,
-0000a840: 206f 7468 6572 2e76 616c 7565 2929 0a0a   other.value))..
-0000a850: 2020 2020 6465 6620 5f69 6e76 6572 7365      def _inverse
-0000a860: 2873 656c 662c 2061 7869 7331 2c20 6178  (self, axis1, ax
-0000a870: 6973 3229 3a0a 2020 2020 2020 2020 6173  is2):.        as
-0000a880: 7365 7274 2030 203c 3d20 6178 6973 3120  sert 0 <= axis1 
-0000a890: 3c20 6178 6973 3220 3c20 7365 6c66 2e6e  < axis2 < self.n
-0000a8a0: 6469 6d0a 2020 2020 2020 2020 6178 6573  dim.        axes
-0000a8b0: 203d 2028 2a72 616e 6765 2861 7869 7331   = (*range(axis1
-0000a8c0: 292c 202a 7261 6e67 6528 6178 6973 312b  ), *range(axis1+
-0000a8d0: 312c 2061 7869 7332 292c 202a 7261 6e67  1, axis2), *rang
-0000a8e0: 6528 6178 6973 322b 312c 2073 656c 662e  e(axis2+1, self.
-0000a8f0: 6e64 696d 292c 2061 7869 7331 2c20 6178  ndim), axis1, ax
-0000a900: 6973 3229 0a20 2020 2020 2020 2076 616c  is2).        val
-0000a910: 7565 203d 206e 756d 7079 2e74 7261 6e73  ue = numpy.trans
-0000a920: 706f 7365 2873 656c 662e 7661 6c75 652c  pose(self.value,
-0000a930: 2061 7865 7329 0a20 2020 2020 2020 2072   axes).        r
-0000a940: 6574 7572 6e20 636f 6e73 7461 6e74 286e  eturn constant(n
-0000a950: 756d 7079 2e74 7261 6e73 706f 7365 286e  umpy.transpose(n
-0000a960: 756d 7079 2e6c 696e 616c 672e 696e 7628  umpy.linalg.inv(
-0000a970: 7661 6c75 6529 2c20 6e75 6d70 792e 6172  value), numpy.ar
-0000a980: 6773 6f72 7428 6178 6573 2929 290a 0a20  gsort(axes))).. 
-0000a990: 2020 2064 6566 205f 7072 6f64 7563 7428     def _product(
-0000a9a0: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
-0000a9b0: 6574 7572 6e20 636f 6e73 7461 6e74 2873  eturn constant(s
-0000a9c0: 656c 662e 7661 6c75 652e 7072 6f64 282d  elf.value.prod(-
-0000a9d0: 3129 290a 0a20 2020 2064 6566 205f 6d75  1))..    def _mu
-0000a9e0: 6c74 6970 6c79 2873 656c 662c 206f 7468  ltiply(self, oth
-0000a9f0: 6572 293a 0a20 2020 2020 2020 2069 6620  er):.        if 
-0000aa00: 7365 6c66 2e5f 6973 756e 6974 3a0a 2020  self._isunit:.  
-0000aa10: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000aa20: 206f 7468 6572 0a20 2020 2020 2020 2069   other.        i
-0000aa30: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
-0000aa40: 6572 2c20 436f 6e73 7461 6e74 293a 0a20  er, Constant):. 
-0000aa50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000aa60: 6e20 636f 6e73 7461 6e74 286e 756d 7079  n constant(numpy
-0000aa70: 2e6d 756c 7469 706c 7928 7365 6c66 2e76  .multiply(self.v
-0000aa80: 616c 7565 2c20 6f74 6865 722e 7661 6c75  alue, other.valu
-0000aa90: 6529 290a 0a20 2020 2064 6566 205f 7461  e))..    def _ta
-0000aaa0: 6b65 6469 6167 2873 656c 662c 2061 7869  kediag(self, axi
-0000aab0: 7331 2c20 6178 6973 3229 3a0a 2020 2020  s1, axis2):.    
-0000aac0: 2020 2020 6173 7365 7274 2061 7869 7331      assert axis1
-0000aad0: 203c 2061 7869 7332 0a20 2020 2020 2020   < axis2.       
-0000aae0: 2072 6574 7572 6e20 636f 6e73 7461 6e74   return constant
-0000aaf0: 286e 756d 7079 2e65 696e 7375 6d28 272e  (numpy.einsum('.
-0000ab00: 2e2e 6b6b 2d3e 2e2e 2e6b 272c 206e 756d  ..kk->...k', num
-0000ab10: 7079 2e74 7261 6e73 706f 7365 2873 656c  py.transpose(sel
-0000ab20: 662e 7661 6c75 652c 0a20 2020 2020 2020  f.value,.       
-0000ab30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab60: 2020 2020 2020 2020 2020 2020 206c 6973               lis
-0000ab70: 7428 7261 6e67 6528 6178 6973 3129 2920  t(range(axis1)) 
-0000ab80: 2b20 6c69 7374 2872 616e 6765 2861 7869  + list(range(axi
-0000ab90: 7331 2b31 2c20 6178 6973 3229 2920 2b20  s1+1, axis2)) + 
-0000aba0: 6c69 7374 2872 616e 6765 2861 7869 7332  list(range(axis2
-0000abb0: 2b31 2c20 7365 6c66 2e6e 6469 6d29 2920  +1, self.ndim)) 
-0000abc0: 2b20 5b61 7869 7331 2c20 6178 6973 325d  + [axis1, axis2]
-0000abd0: 2929 290a 0a20 2020 2064 6566 205f 7461  )))..    def _ta
-0000abe0: 6b65 2873 656c 662c 2069 6e64 6578 2c20  ke(self, index, 
-0000abf0: 6178 6973 293a 0a20 2020 2020 2020 2069  axis):.        i
-0000ac00: 6620 696e 6465 782e 6973 636f 6e73 7461  f index.isconsta
-0000ac10: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
-0000ac20: 696e 6465 785f 203d 2069 6e64 6578 2e65  index_ = index.e
-0000ac30: 7661 6c28 290a 2020 2020 2020 2020 2020  val().          
-0000ac40: 2020 7265 7475 726e 2063 6f6e 7374 616e    return constan
-0000ac50: 7428 7365 6c66 2e76 616c 7565 2e74 616b  t(self.value.tak
-0000ac60: 6528 696e 6465 785f 2c20 6178 6973 2929  e(index_, axis))
-0000ac70: 0a0a 2020 2020 6465 6620 5f70 6f77 6572  ..    def _power
-0000ac80: 2873 656c 662c 206e 293a 0a20 2020 2020  (self, n):.     
-0000ac90: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0000aca0: 286e 2c20 436f 6e73 7461 6e74 293a 0a20  (n, Constant):. 
-0000acb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000acc0: 6e20 636f 6e73 7461 6e74 286e 756d 7079  n constant(numpy
-0000acd0: 2e70 6f77 6572 2873 656c 662e 7661 6c75  .power(self.valu
-0000ace0: 652c 206e 2e76 616c 7565 2929 0a0a 2020  e, n.value))..  
-0000acf0: 2020 6465 6620 5f65 6967 2873 656c 662c    def _eig(self,
-0000ad00: 2073 796d 6d65 7472 6963 293a 0a20 2020   symmetric):.   
-0000ad10: 2020 2020 2065 6967 7661 6c2c 2065 6967       eigval, eig
-0000ad20: 7665 6320 3d20 286e 756d 7079 2e6c 696e  vec = (numpy.lin
-0000ad30: 616c 672e 6569 6768 2069 6620 7379 6d6d  alg.eigh if symm
-0000ad40: 6574 7269 6320 656c 7365 206e 756d 7079  etric else numpy
-0000ad50: 2e6c 696e 616c 672e 6569 6729 2873 656c  .linalg.eig)(sel
-0000ad60: 662e 7661 6c75 6529 0a20 2020 2020 2020  f.value).       
-0000ad70: 2069 6620 6e6f 7420 7379 6d6d 6574 7269   if not symmetri
-0000ad80: 633a 0a20 2020 2020 2020 2020 2020 2065  c:.            e
-0000ad90: 6967 7661 6c20 3d20 6569 6776 616c 2e61  igval = eigval.a
-0000ada0: 7374 7970 6528 636f 6d70 6c65 782c 2063  stype(complex, c
-0000adb0: 6f70 793d 4661 6c73 6529 0a20 2020 2020  opy=False).     
-0000adc0: 2020 2020 2020 2065 6967 7665 6320 3d20         eigvec = 
-0000add0: 6569 6776 6563 2e61 7374 7970 6528 636f  eigvec.astype(co
-0000ade0: 6d70 6c65 782c 2063 6f70 793d 4661 6c73  mplex, copy=Fals
-0000adf0: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
-0000ae00: 6e20 5475 706c 6528 2863 6f6e 7374 616e  n Tuple((constan
-0000ae10: 7428 6569 6776 616c 292c 2063 6f6e 7374  t(eigval), const
-0000ae20: 616e 7428 6569 6776 6563 2929 290a 0a20  ant(eigvec))).. 
-0000ae30: 2020 2064 6566 205f 7369 676e 2873 656c     def _sign(sel
-0000ae40: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
-0000ae50: 726e 2063 6f6e 7374 616e 7428 6e75 6d70  rn constant(nump
-0000ae60: 792e 7369 676e 2873 656c 662e 7661 6c75  y.sign(self.valu
-0000ae70: 6529 290a 0a20 2020 2064 6566 205f 756e  e))..    def _un
-0000ae80: 7261 7665 6c28 7365 6c66 2c20 6178 6973  ravel(self, axis
-0000ae90: 2c20 7368 6170 6529 3a0a 2020 2020 2020  , shape):.      
-0000aea0: 2020 7368 6170 6520 3d20 7365 6c66 2e76    shape = self.v
-0000aeb0: 616c 7565 2e73 6861 7065 5b3a 6178 6973  alue.shape[:axis
-0000aec0: 5d20 2b20 7368 6170 6520 2b20 7365 6c66  ] + shape + self
-0000aed0: 2e76 616c 7565 2e73 6861 7065 5b61 7869  .value.shape[axi
-0000aee0: 732b 313a 5d0a 2020 2020 2020 2020 7265  s+1:].        re
-0000aef0: 7475 726e 2063 6f6e 7374 616e 7428 7365  turn constant(se
-0000af00: 6c66 2e76 616c 7565 2e72 6573 6861 7065  lf.value.reshape
-0000af10: 2873 6861 7065 2929 0a0a 2020 2020 6465  (shape))..    de
-0000af20: 6620 5f64 6574 6572 6d69 6e61 6e74 2873  f _determinant(s
-0000af30: 656c 662c 2061 7869 7331 2c20 6178 6973  elf, axis1, axis
-0000af40: 3229 3a0a 2020 2020 2020 2020 7661 6c75  2):.        valu
-0000af50: 6520 3d20 6e75 6d70 792e 7472 616e 7370  e = numpy.transp
-0000af60: 6f73 6528 7365 6c66 2e76 616c 7565 2c20  ose(self.value, 
-0000af70: 7475 706c 6528 6920 666f 7220 6920 696e  tuple(i for i in
-0000af80: 2072 616e 6765 2873 656c 662e 6e64 696d   range(self.ndim
-0000af90: 2920 6966 2069 2021 3d20 6178 6973 3120  ) if i != axis1 
-0000afa0: 616e 6420 6920 213d 2061 7869 7332 2920  and i != axis2) 
-0000afb0: 2b20 2861 7869 7331 2c20 6178 6973 3229  + (axis1, axis2)
-0000afc0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0000afd0: 2063 6f6e 7374 616e 7428 6e75 6d70 792e   constant(numpy.
-0000afe0: 6c69 6e61 6c67 2e64 6574 2876 616c 7565  linalg.det(value
-0000aff0: 2929 0a0a 2020 2020 6465 6620 5f69 6e74  ))..    def _int
-0000b000: 626f 756e 6473 5f69 6d70 6c28 7365 6c66  bounds_impl(self
-0000b010: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
-0000b020: 6c66 2e64 7479 7065 203d 3d20 696e 7420  lf.dtype == int 
-0000b030: 616e 6420 7365 6c66 2e76 616c 7565 2e73  and self.value.s
-0000b040: 697a 653a 0a20 2020 2020 2020 2020 2020  ize:.           
-0000b050: 2072 6574 7572 6e20 696e 7428 7365 6c66   return int(self
-0000b060: 2e76 616c 7565 2e6d 696e 2829 292c 2069  .value.min()), i
-0000b070: 6e74 2873 656c 662e 7661 6c75 652e 6d61  nt(self.value.ma
-0000b080: 7828 2929 0a20 2020 2020 2020 2065 6c73  x()).        els
-0000b090: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0000b0a0: 6574 7572 6e20 7375 7065 7228 292e 5f69  eturn super()._i
-0000b0b0: 6e74 626f 756e 6473 5f69 6d70 6c28 290a  ntbounds_impl().
-0000b0c0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-0000b0d0: 2020 2064 6566 205f 636f 6e73 745f 756e     def _const_un
-0000b0e0: 6966 6f72 6d28 7365 6c66 293a 0a20 2020  iform(self):.   
-0000b0f0: 2020 2020 2069 6620 7365 6c66 2e6e 6469       if self.ndi
-0000b100: 6d20 3d3d 2030 3a0a 2020 2020 2020 2020  m == 0:.        
-0000b110: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000b120: 6474 7970 6528 7365 6c66 2e76 616c 7565  dtype(self.value
-0000b130: 5b28 295d 290a 0a0a 636c 6173 7320 496e  [()])...class In
-0000b140: 7365 7274 4178 6973 2841 7272 6179 293a  sertAxis(Array):
-0000b150: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-0000b160: 5f5f 2873 656c 662c 2066 756e 633a 2041  __(self, func: A
-0000b170: 7272 6179 2c20 6c65 6e67 7468 3a20 4172  rray, length: Ar
-0000b180: 7261 7929 3a0a 2020 2020 2020 2020 6173  ray):.        as
-0000b190: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-0000b1a0: 6675 6e63 2c20 4172 7261 7929 2c20 6627  func, Array), f'
-0000b1b0: 6675 6e63 3d7b 6675 6e63 2172 7d27 0a20  func={func!r}'. 
-0000b1c0: 2020 2020 2020 2061 7373 6572 7420 5f69         assert _i
-0000b1d0: 7369 6e64 6578 286c 656e 6774 6829 2c20  sindex(length), 
-0000b1e0: 6627 6c65 6e67 7468 3d7b 6c65 6e67 7468  f'length={length
-0000b1f0: 2172 7d27 0a20 2020 2020 2020 2073 656c  !r}'.        sel
-0000b200: 662e 6675 6e63 203d 2066 756e 630a 2020  f.func = func.  
-0000b210: 2020 2020 2020 7365 6c66 2e6c 656e 6774        self.lengt
-0000b220: 6820 3d20 6c65 6e67 7468 0a20 2020 2020  h = length.     
-0000b230: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
-0000b240: 745f 5f28 6172 6773 3d28 6675 6e63 2c20  t__(args=(func, 
-0000b250: 6c65 6e67 7468 292c 2073 6861 7065 3d28  length), shape=(
-0000b260: 2a66 756e 632e 7368 6170 652c 206c 656e  *func.shape, len
-0000b270: 6774 6829 2c20 6474 7970 653d 6675 6e63  gth), dtype=func
-0000b280: 2e64 7479 7065 290a 0a20 2020 2040 7072  .dtype)..    @pr
-0000b290: 6f70 6572 7479 0a20 2020 2064 6566 205f  operty.    def _
-0000b2a0: 6469 6167 6f6e 616c 7328 7365 6c66 293a  diagonals(self):
-0000b2b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000b2c0: 7365 6c66 2e66 756e 632e 5f64 6961 676f  self.func._diago
-0000b2d0: 6e61 6c73 0a0a 2020 2020 4063 6163 6865  nals..    @cache
-0000b2e0: 645f 7072 6f70 6572 7479 0a20 2020 2064  d_property.    d
-0000b2f0: 6566 205f 696e 666c 6174 696f 6e73 2873  ef _inflations(s
-0000b300: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-0000b310: 7475 726e 2074 7570 6c65 2828 6178 6973  turn tuple((axis
-0000b320: 2c20 7479 7065 732e 6672 6f7a 656e 6469  , types.frozendi
-0000b330: 6374 2828 646f 666d 6170 2c20 496e 7365  ct((dofmap, Inse
-0000b340: 7274 4178 6973 2866 756e 632c 2073 656c  rtAxis(func, sel
-0000b350: 662e 6c65 6e67 7468 2929 2066 6f72 2064  f.length)) for d
-0000b360: 6f66 6d61 702c 2066 756e 6320 696e 2070  ofmap, func in p
-0000b370: 6172 7473 2e69 7465 6d73 2829 2929 2066  arts.items())) f
-0000b380: 6f72 2061 7869 732c 2070 6172 7473 2069  or axis, parts i
-0000b390: 6e20 7365 6c66 2e66 756e 632e 5f69 6e66  n self.func._inf
-0000b3a0: 6c61 7469 6f6e 7329 0a0a 2020 2020 4063  lations)..    @c
-0000b3b0: 6163 6865 645f 7072 6f70 6572 7479 0a20  ached_property. 
-0000b3c0: 2020 2064 6566 205f 756e 616c 6967 6e65     def _unaligne
-0000b3d0: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-0000b3e0: 2072 6574 7572 6e20 7365 6c66 2e66 756e   return self.fun
-0000b3f0: 632e 5f75 6e61 6c69 676e 6564 0a0a 2020  c._unaligned..  
-0000b400: 2020 6465 6620 5f73 696d 706c 6966 6965    def _simplifie
-0000b410: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-0000b420: 2069 6620 5f65 7175 616c 735f 7363 616c   if _equals_scal
-0000b430: 6172 5f63 6f6e 7374 616e 7428 7365 6c66  ar_constant(self
-0000b440: 2e6c 656e 6774 682c 2030 293a 0a20 2020  .length, 0):.   
-0000b450: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000b460: 7a65 726f 735f 6c69 6b65 2873 656c 6629  zeros_like(self)
-0000b470: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000b480: 7365 6c66 2e66 756e 632e 5f69 6e73 6572  self.func._inser
-0000b490: 7461 7869 7328 7365 6c66 2e6e 6469 6d2d  taxis(self.ndim-
-0000b4a0: 312c 2073 656c 662e 6c65 6e67 7468 290a  1, self.length).
-0000b4b0: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
-0000b4c0: 6f64 0a20 2020 2064 6566 2065 7661 6c66  od.    def evalf
-0000b4d0: 2866 756e 632c 206c 656e 6774 6829 3a0a  (func, length):.
-0000b4e0: 2020 2020 2020 2020 6966 206c 656e 6774          if lengt
-0000b4f0: 6820 3d3d 2031 3a0a 2020 2020 2020 2020  h == 1:.        
-0000b500: 2020 2020 7265 7475 726e 2066 756e 635b      return func[
-0000b510: 2e2e 2e2c 206e 756d 7079 2e6e 6577 6178  ..., numpy.newax
-0000b520: 6973 5d0a 2020 2020 2020 2020 7472 793a  is].        try:
-0000b530: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000b540: 7572 6e20 6e75 6d70 792e 6e64 6172 7261  urn numpy.ndarra
-0000b550: 7928 6275 6666 6572 3d66 756e 632c 2064  y(buffer=func, d
-0000b560: 7479 7065 3d66 756e 632e 6474 7970 652c  type=func.dtype,
-0000b570: 2073 6861 7065 3d28 2a66 756e 632e 7368   shape=(*func.sh
-0000b580: 6170 652c 206c 656e 6774 6829 2c20 7374  ape, length), st
-0000b590: 7269 6465 733d 282a 6675 6e63 2e73 7472  rides=(*func.str
-0000b5a0: 6964 6573 2c20 3029 290a 2020 2020 2020  ides, 0)).      
-0000b5b0: 2020 6578 6365 7074 2056 616c 7565 4572    except ValueEr
-0000b5c0: 726f 723a 2020 2320 6e6f 6e2d 636f 6e74  ror:  # non-cont
-0000b5d0: 6967 756f 7573 2064 6174 610a 2020 2020  iguous data.    
-0000b5e0: 2020 2020 2020 2020 7265 7475 726e 206e          return n
-0000b5f0: 756d 7079 2e72 6570 6561 7428 6675 6e63  umpy.repeat(func
-0000b600: 5b2e 2e2e 2c20 6e75 6d70 792e 6e65 7761  [..., numpy.newa
-0000b610: 7869 735d 2c20 6c65 6e67 7468 2c20 2d31  xis], length, -1
-0000b620: 290a 0a20 2020 2064 6566 205f 6465 7269  )..    def _deri
-0000b630: 7661 7469 7665 2873 656c 662c 2076 6172  vative(self, var
-0000b640: 2c20 7365 656e 293a 0a20 2020 2020 2020  , seen):.       
-0000b650: 2072 6574 7572 6e20 696e 7365 7274 6178   return insertax
-0000b660: 6973 2864 6572 6976 6174 6976 6528 7365  is(derivative(se
-0000b670: 6c66 2e66 756e 632c 2076 6172 2c20 7365  lf.func, var, se
-0000b680: 656e 292c 2073 656c 662e 6e64 696d 2d31  en), self.ndim-1
-0000b690: 2c20 7365 6c66 2e6c 656e 6774 6829 0a0a  , self.length)..
-0000b6a0: 2020 2020 6465 6620 5f73 756d 2873 656c      def _sum(sel
-0000b6b0: 662c 2069 293a 0a20 2020 2020 2020 2069  f, i):.        i
-0000b6c0: 6620 6920 3d3d 2073 656c 662e 6e64 696d  f i == self.ndim
-0000b6d0: 202d 2031 3a0a 2020 2020 2020 2020 2020   - 1:.          
-0000b6e0: 2020 7265 7475 726e 2073 656c 662e 6675    return self.fu
-0000b6f0: 6e63 202a 2073 656c 662e 6c65 6e67 7468  nc * self.length
-0000b700: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000b710: 496e 7365 7274 4178 6973 2873 756d 2873  InsertAxis(sum(s
-0000b720: 656c 662e 6675 6e63 2c20 6929 2c20 7365  elf.func, i), se
-0000b730: 6c66 2e6c 656e 6774 6829 0a0a 2020 2020  lf.length)..    
-0000b740: 6465 6620 5f70 726f 6475 6374 2873 656c  def _product(sel
-0000b750: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
-0000b760: 726e 2073 656c 662e 6675 6e63 2a2a 7365  rn self.func**se
-0000b770: 6c66 2e6c 656e 6774 680a 0a20 2020 2064  lf.length..    d
-0000b780: 6566 205f 706f 7765 7228 7365 6c66 2c20  ef _power(self, 
-0000b790: 6e29 3a0a 2020 2020 2020 2020 756e 616c  n):.        unal
-0000b7a0: 6967 6e65 6431 2c20 756e 616c 6967 6e65  igned1, unaligne
-0000b7b0: 6432 2c20 7768 6572 6520 3d20 756e 616c  d2, where = unal
-0000b7c0: 6967 6e28 7365 6c66 2c20 6e29 0a20 2020  ign(self, n).   
-0000b7d0: 2020 2020 2069 6620 6c65 6e28 7768 6572       if len(wher
-0000b7e0: 6529 2021 3d20 7365 6c66 2e6e 6469 6d3a  e) != self.ndim:
-0000b7f0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000b800: 7572 6e20 616c 6967 6e28 756e 616c 6967  urn align(unalig
-0000b810: 6e65 6431 202a 2a20 756e 616c 6967 6e65  ned1 ** unaligne
-0000b820: 6432 2c20 7768 6572 652c 2073 656c 662e  d2, where, self.
-0000b830: 7368 6170 6529 0a0a 2020 2020 6465 6620  shape)..    def 
-0000b840: 5f61 6464 2873 656c 662c 206f 7468 6572  _add(self, other
-0000b850: 293a 0a20 2020 2020 2020 2075 6e61 6c69  ):.        unali
-0000b860: 676e 6564 312c 2075 6e61 6c69 676e 6564  gned1, unaligned
-0000b870: 322c 2077 6865 7265 203d 2075 6e61 6c69  2, where = unali
-0000b880: 676e 2873 656c 662c 206f 7468 6572 290a  gn(self, other).
-0000b890: 2020 2020 2020 2020 6966 206c 656e 2877          if len(w
-0000b8a0: 6865 7265 2920 213d 2073 656c 662e 6e64  here) != self.nd
-0000b8b0: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
-0000b8c0: 7265 7475 726e 2061 6c69 676e 2875 6e61  return align(una
-0000b8d0: 6c69 676e 6564 3120 2b20 756e 616c 6967  ligned1 + unalig
-0000b8e0: 6e65 6432 2c20 7768 6572 652c 2073 656c  ned2, where, sel
-0000b8f0: 662e 7368 6170 6529 0a0a 2020 2020 6465  f.shape)..    de
-0000b900: 6620 5f6d 756c 7469 706c 7928 7365 6c66  f _multiply(self
-0000b910: 2c20 6f74 6865 7229 3a0a 2020 2020 2020  , other):.      
-0000b920: 2020 756e 616c 6967 6e65 6431 2c20 756e    unaligned1, un
-0000b930: 616c 6967 6e65 6432 2c20 7768 6572 6520  aligned2, where 
-0000b940: 3d20 756e 616c 6967 6e28 7365 6c66 2c20  = unalign(self, 
-0000b950: 6f74 6865 7229 0a20 2020 2020 2020 2069  other).        i
-0000b960: 6620 6c65 6e28 7768 6572 6529 2021 3d20  f len(where) != 
-0000b970: 7365 6c66 2e6e 6469 6d3a 0a20 2020 2020  self.ndim:.     
-0000b980: 2020 2020 2020 2072 6574 7572 6e20 616c         return al
-0000b990: 6967 6e28 756e 616c 6967 6e65 6431 202a  ign(unaligned1 *
-0000b9a0: 2075 6e61 6c69 676e 6564 322c 2077 6865   unaligned2, whe
-0000b9b0: 7265 2c20 7365 6c66 2e73 6861 7065 290a  re, self.shape).
-0000b9c0: 0a20 2020 2064 6566 205f 6469 6167 6f6e  .    def _diagon
-0000b9d0: 616c 697a 6528 7365 6c66 2c20 6178 6973  alize(self, axis
-0000b9e0: 293a 0a20 2020 2020 2020 2069 6620 6178  ):.        if ax
-0000b9f0: 6973 203c 2073 656c 662e 6e64 696d 202d  is < self.ndim -
-0000ba00: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-0000ba10: 7265 7475 726e 2069 6e73 6572 7461 7869  return insertaxi
-0000ba20: 7328 6469 6167 6f6e 616c 697a 6528 7365  s(diagonalize(se
-0000ba30: 6c66 2e66 756e 632c 2061 7869 732c 2073  lf.func, axis, s
-0000ba40: 656c 662e 6e64 696d 202d 2031 292c 2073  elf.ndim - 1), s
-0000ba50: 656c 662e 6e64 696d 202d 2031 2c20 7365  elf.ndim - 1, se
-0000ba60: 6c66 2e6c 656e 6774 6829 0a0a 2020 2020  lf.length)..    
-0000ba70: 6465 6620 5f69 6e66 6c61 7465 2873 656c  def _inflate(sel
-0000ba80: 662c 2064 6f66 6d61 702c 206c 656e 6774  f, dofmap, lengt
-0000ba90: 682c 2061 7869 7329 3a0a 2020 2020 2020  h, axis):.      
-0000baa0: 2020 6966 2061 7869 7320 2b20 646f 666d    if axis + dofm
-0000bab0: 6170 2e6e 6469 6d20 3c20 7365 6c66 2e6e  ap.ndim < self.n
-0000bac0: 6469 6d3a 0a20 2020 2020 2020 2020 2020  dim:.           
-0000bad0: 2072 6574 7572 6e20 496e 7365 7274 4178   return InsertAx
-0000bae0: 6973 285f 696e 666c 6174 6528 7365 6c66  is(_inflate(self
-0000baf0: 2e66 756e 632c 2064 6f66 6d61 702c 206c  .func, dofmap, l
-0000bb00: 656e 6774 682c 2061 7869 7329 2c20 7365  ength, axis), se
-0000bb10: 6c66 2e6c 656e 6774 6829 0a20 2020 2020  lf.length).     
-0000bb20: 2020 2065 6c69 6620 6178 6973 203d 3d20     elif axis == 
-0000bb30: 7365 6c66 2e6e 6469 6d3a 0a20 2020 2020  self.ndim:.     
-0000bb40: 2020 2020 2020 2072 6574 7572 6e20 696e         return in
-0000bb50: 7365 7274 6178 6973 2849 6e66 6c61 7465  sertaxis(Inflate
-0000bb60: 2873 656c 662e 6675 6e63 2c20 646f 666d  (self.func, dofm
-0000bb70: 6170 2c20 6c65 6e67 7468 292c 2073 656c  ap, length), sel
-0000bb80: 662e 6e64 696d 202d 2031 2c20 7365 6c66  f.ndim - 1, self
-0000bb90: 2e6c 656e 6774 6829 0a0a 2020 2020 6465  .length)..    de
-0000bba0: 6620 5f69 6e73 6572 7461 7869 7328 7365  f _insertaxis(se
-0000bbb0: 6c66 2c20 6178 6973 2c20 6c65 6e67 7468  lf, axis, length
-0000bbc0: 293a 0a20 2020 2020 2020 2069 6620 6178  ):.        if ax
-0000bbd0: 6973 203d 3d20 7365 6c66 2e6e 6469 6d20  is == self.ndim 
-0000bbe0: 2d20 313a 0a20 2020 2020 2020 2020 2020  - 1:.           
-0000bbf0: 2072 6574 7572 6e20 496e 7365 7274 4178   return InsertAx
-0000bc00: 6973 2849 6e73 6572 7441 7869 7328 7365  is(InsertAxis(se
-0000bc10: 6c66 2e66 756e 632c 206c 656e 6774 6829  lf.func, length)
-0000bc20: 2c20 7365 6c66 2e6c 656e 6774 6829 0a0a  , self.length)..
-0000bc30: 2020 2020 6465 6620 5f74 616b 6528 7365      def _take(se
-0000bc40: 6c66 2c20 696e 6465 782c 2061 7869 7329  lf, index, axis)
-0000bc50: 3a0a 2020 2020 2020 2020 6966 2061 7869  :.        if axi
-0000bc60: 7320 3d3d 2073 656c 662e 6e64 696d 202d  s == self.ndim -
-0000bc70: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-0000bc80: 7265 7475 726e 2061 7070 656e 6461 7865  return appendaxe
-0000bc90: 7328 7365 6c66 2e66 756e 632c 2069 6e64  s(self.func, ind
-0000bca0: 6578 2e73 6861 7065 290a 2020 2020 2020  ex.shape).      
-0000bcb0: 2020 7265 7475 726e 2049 6e73 6572 7441    return InsertA
-0000bcc0: 7869 7328 5f74 616b 6528 7365 6c66 2e66  xis(_take(self.f
-0000bcd0: 756e 632c 2069 6e64 6578 2c20 6178 6973  unc, index, axis
-0000bce0: 292c 2073 656c 662e 6c65 6e67 7468 290a  ), self.length).
-0000bcf0: 0a20 2020 2064 6566 205f 7461 6b65 6469  .    def _takedi
-0000bd00: 6167 2873 656c 662c 2061 7869 7331 2c20  ag(self, axis1, 
-0000bd10: 6178 6973 3229 3a0a 2020 2020 2020 2020  axis2):.        
-0000bd20: 6173 7365 7274 2061 7869 7331 203c 2061  assert axis1 < a
-0000bd30: 7869 7332 0a20 2020 2020 2020 2069 6620  xis2.        if 
-0000bd40: 6178 6973 3220 3d3d 2073 656c 662e 6e64  axis2 == self.nd
-0000bd50: 696d 2d31 3a0a 2020 2020 2020 2020 2020  im-1:.          
-0000bd60: 2020 7265 7475 726e 2054 7261 6e73 706f    return Transpo
-0000bd70: 7365 2e74 6f5f 656e 6428 7365 6c66 2e66  se.to_end(self.f
-0000bd80: 756e 632c 2061 7869 7331 290a 2020 2020  unc, axis1).    
-0000bd90: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000bda0: 2020 2020 2020 7265 7475 726e 2069 6e73        return ins
-0000bdb0: 6572 7461 7869 7328 5f74 616b 6564 6961  ertaxis(_takedia
-0000bdc0: 6728 7365 6c66 2e66 756e 632c 2061 7869  g(self.func, axi
-0000bdd0: 7331 2c20 6178 6973 3229 2c20 7365 6c66  s1, axis2), self
-0000bde0: 2e6e 6469 6d2d 332c 2073 656c 662e 6c65  .ndim-3, self.le
-0000bdf0: 6e67 7468 290a 0a20 2020 2064 6566 205f  ngth)..    def _
-0000be00: 756e 7261 7665 6c28 7365 6c66 2c20 6178  unravel(self, ax
-0000be10: 6973 2c20 7368 6170 6529 3a0a 2020 2020  is, shape):.    
-0000be20: 2020 2020 6966 2061 7869 7320 3d3d 2073      if axis == s
-0000be30: 656c 662e 6e64 696d 202d 2031 3a0a 2020  elf.ndim - 1:.  
-0000be40: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000be50: 2049 6e73 6572 7441 7869 7328 496e 7365   InsertAxis(Inse
-0000be60: 7274 4178 6973 2873 656c 662e 6675 6e63  rtAxis(self.func
-0000be70: 2c20 7368 6170 655b 305d 292c 2073 6861  , shape[0]), sha
-0000be80: 7065 5b31 5d29 0a20 2020 2020 2020 2065  pe[1]).        e
-0000be90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000bea0: 2072 6574 7572 6e20 496e 7365 7274 4178   return InsertAx
-0000beb0: 6973 2875 6e72 6176 656c 2873 656c 662e  is(unravel(self.
-0000bec0: 6675 6e63 2c20 6178 6973 2c20 7368 6170  func, axis, shap
-0000bed0: 6529 2c20 7365 6c66 2e6c 656e 6774 6829  e), self.length)
-0000bee0: 0a0a 2020 2020 6465 6620 5f73 6967 6e28  ..    def _sign(
-0000bef0: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
-0000bf00: 6574 7572 6e20 496e 7365 7274 4178 6973  eturn InsertAxis
-0000bf10: 2853 6967 6e28 7365 6c66 2e66 756e 6329  (Sign(self.func)
-0000bf20: 2c20 7365 6c66 2e6c 656e 6774 6829 0a0a  , self.length)..
-0000bf30: 2020 2020 6465 6620 5f64 6574 6572 6d69      def _determi
-0000bf40: 6e61 6e74 2873 656c 662c 2061 7869 7331  nant(self, axis1
-0000bf50: 2c20 6178 6973 3229 3a0a 2020 2020 2020  , axis2):.      
-0000bf60: 2020 6966 2061 7869 7331 203c 2073 656c    if axis1 < sel
-0000bf70: 662e 6e64 696d 2d31 2061 6e64 2061 7869  f.ndim-1 and axi
-0000bf80: 7332 203c 2073 656c 662e 6e64 696d 2d31  s2 < self.ndim-1
-0000bf90: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000bfa0: 7475 726e 2049 6e73 6572 7441 7869 7328  turn InsertAxis(
-0000bfb0: 6465 7465 726d 696e 616e 7428 7365 6c66  determinant(self
-0000bfc0: 2e66 756e 632c 2028 6178 6973 312c 2061  .func, (axis1, a
-0000bfd0: 7869 7332 2929 2c20 7365 6c66 2e6c 656e  xis2)), self.len
-0000bfe0: 6774 6829 0a0a 2020 2020 6465 6620 5f69  gth)..    def _i
-0000bff0: 6e76 6572 7365 2873 656c 662c 2061 7869  nverse(self, axi
-0000c000: 7331 2c20 6178 6973 3229 3a0a 2020 2020  s1, axis2):.    
-0000c010: 2020 2020 6966 2061 7869 7331 203c 2073      if axis1 < s
-0000c020: 656c 662e 6e64 696d 2d31 2061 6e64 2061  elf.ndim-1 and a
-0000c030: 7869 7332 203c 2073 656c 662e 6e64 696d  xis2 < self.ndim
-0000c040: 2d31 3a0a 2020 2020 2020 2020 2020 2020  -1:.            
-0000c050: 7265 7475 726e 2049 6e73 6572 7441 7869  return InsertAxi
-0000c060: 7328 696e 7665 7273 6528 7365 6c66 2e66  s(inverse(self.f
-0000c070: 756e 632c 2028 6178 6973 312c 2061 7869  unc, (axis1, axi
-0000c080: 7332 2929 2c20 7365 6c66 2e6c 656e 6774  s2)), self.lengt
-0000c090: 6829 0a0a 2020 2020 6465 6620 5f6c 6f6f  h)..    def _loo
-0000c0a0: 7073 756d 2873 656c 662c 2069 6e64 6578  psum(self, index
-0000c0b0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0000c0c0: 6e20 496e 7365 7274 4178 6973 286c 6f6f  n InsertAxis(loo
-0000c0d0: 705f 7375 6d28 7365 6c66 2e66 756e 632c  p_sum(self.func,
-0000c0e0: 2069 6e64 6578 292c 2073 656c 662e 6c65   index), self.le
-0000c0f0: 6e67 7468 290a 0a20 2020 2040 6361 6368  ngth)..    @cach
-0000c100: 6564 5f70 726f 7065 7274 790a 2020 2020  ed_property.    
-0000c110: 6465 6620 5f61 7373 7061 7273 6528 7365  def _assparse(se
-0000c120: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
-0000c130: 7572 6e20 7475 706c 6528 282a 2849 6e73  urn tuple((*(Ins
-0000c140: 6572 7441 7869 7328 6964 782c 2073 656c  ertAxis(idx, sel
-0000c150: 662e 6c65 6e67 7468 2920 666f 7220 6964  f.length) for id
-0000c160: 7820 696e 2069 6e64 6963 6573 292c 2070  x in indices), p
-0000c170: 7265 7065 6e64 6178 6573 2852 616e 6765  rependaxes(Range
-0000c180: 2873 656c 662e 6c65 6e67 7468 292c 2076  (self.length), v
-0000c190: 616c 7565 732e 7368 6170 6529 2c20 496e  alues.shape), In
-0000c1a0: 7365 7274 4178 6973 2876 616c 7565 732c  sertAxis(values,
-0000c1b0: 2073 656c 662e 6c65 6e67 7468 2929 2066   self.length)) f
-0000c1c0: 6f72 202a 696e 6469 6365 732c 2076 616c  or *indices, val
-0000c1d0: 7565 7320 696e 2073 656c 662e 6675 6e63  ues in self.func
-0000c1e0: 2e5f 6173 7370 6172 7365 290a 0a20 2020  ._assparse)..   
-0000c1f0: 2064 6566 205f 696e 7462 6f75 6e64 735f   def _intbounds_
-0000c200: 696d 706c 2873 656c 6629 3a0a 2020 2020  impl(self):.    
-0000c210: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000c220: 6675 6e63 2e5f 696e 7462 6f75 6e64 730a  func._intbounds.
-0000c230: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-0000c240: 2020 2064 6566 205f 636f 6e73 745f 756e     def _const_un
-0000c250: 6966 6f72 6d28 7365 6c66 293a 0a20 2020  iform(self):.   
-0000c260: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0000c270: 2e66 756e 632e 5f63 6f6e 7374 5f75 6e69  .func._const_uni
-0000c280: 666f 726d 0a0a 0a63 6c61 7373 2054 7261  form...class Tra
-0000c290: 6e73 706f 7365 2841 7272 6179 293a 0a0a  nspose(Array):..
-0000c2a0: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
-0000c2b0: 0a20 2020 2064 6566 205f 6d6b 5f61 7865  .    def _mk_axe
-0000c2c0: 7328 636c 732c 206e 6469 6d2c 2061 7865  s(cls, ndim, axe
-0000c2d0: 732c 2069 6e76 6572 743d 4661 6c73 6529  s, invert=False)
-0000c2e0: 3a0a 2020 2020 2020 2020 6178 6573 203d  :.        axes =
-0000c2f0: 205b 6e75 6d65 7269 632e 6e6f 726d 6469   [numeric.normdi
-0000c300: 6d28 6e64 696d 2c20 6178 6973 2920 666f  m(ndim, axis) fo
-0000c310: 7220 6178 6973 2069 6e20 6178 6573 5d0a  r axis in axes].
-0000c320: 2020 2020 2020 2020 6966 2061 6c6c 2861          if all(a
-0000c330: 203d 3d20 6220 666f 7220 612c 2062 2069   == b for a, b i
-0000c340: 6e20 656e 756d 6572 6174 6528 6178 6573  n enumerate(axes
-0000c350: 2c20 7374 6172 743d 6e64 696d 2d6c 656e  , start=ndim-len
-0000c360: 2861 7865 7329 2929 3a0a 2020 2020 2020  (axes))):.      
-0000c370: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-0000c380: 2020 2020 2074 7261 6e73 203d 205b 6920       trans = [i 
-0000c390: 666f 7220 6920 696e 2072 616e 6765 286e  for i in range(n
-0000c3a0: 6469 6d29 2069 6620 6920 6e6f 7420 696e  dim) if i not in
-0000c3b0: 2061 7865 735d 0a20 2020 2020 2020 2074   axes].        t
-0000c3c0: 7261 6e73 2e65 7874 656e 6428 6178 6573  rans.extend(axes
-0000c3d0: 290a 2020 2020 2020 2020 6966 206c 656e  ).        if len
-0000c3e0: 2874 7261 6e73 2920 213d 206e 6469 6d3a  (trans) != ndim:
-0000c3f0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000c400: 7365 2045 7863 6570 7469 6f6e 2827 6475  se Exception('du
-0000c410: 706c 6963 6174 6520 6178 6573 2729 0a20  plicate axes'). 
-0000c420: 2020 2020 2020 2072 6574 7572 6e20 7475         return tu
-0000c430: 706c 6528 7472 616e 7329 0a0a 2020 2020  ple(trans)..    
-0000c440: 4063 6c61 7373 6d65 7468 6f64 0a20 2020  @classmethod.   
-0000c450: 2064 6566 2066 726f 6d5f 656e 6428 636c   def from_end(cl
-0000c460: 732c 2061 7272 6179 2c20 2a61 7865 7329  s, array, *axes)
-0000c470: 3a0a 2020 2020 2020 2020 7472 616e 7320  :.        trans 
-0000c480: 3d20 636c 732e 5f6d 6b5f 6178 6573 2861  = cls._mk_axes(a
-0000c490: 7272 6179 2e6e 6469 6d2c 2061 7865 7329  rray.ndim, axes)
-0000c4a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000c4b0: 636c 732e 696e 7628 6172 7261 792c 2074  cls.inv(array, t
-0000c4c0: 7261 6e73 2920 6966 2074 7261 6e73 2065  rans) if trans e
-0000c4d0: 6c73 6520 6172 7261 790a 0a20 2020 2040  lse array..    @
-0000c4e0: 636c 6173 736d 6574 686f 640a 2020 2020  classmethod.    
-0000c4f0: 6465 6620 746f 5f65 6e64 2863 6c73 2c20  def to_end(cls, 
-0000c500: 6172 7261 792c 202a 6178 6573 293a 0a20  array, *axes):. 
-0000c510: 2020 2020 2020 2074 7261 6e73 203d 2063         trans = c
-0000c520: 6c73 2e5f 6d6b 5f61 7865 7328 6172 7261  ls._mk_axes(arra
-0000c530: 792e 6e64 696d 2c20 6178 6573 290a 2020  y.ndim, axes).  
-0000c540: 2020 2020 2020 7265 7475 726e 2063 6c73        return cls
-0000c550: 2861 7272 6179 2c20 7472 616e 7329 2069  (array, trans) i
-0000c560: 6620 7472 616e 7320 656c 7365 2061 7272  f trans else arr
-0000c570: 6179 0a0a 2020 2020 4063 6c61 7373 6d65  ay..    @classme
-0000c580: 7468 6f64 0a20 2020 2064 6566 2069 6e76  thod.    def inv
-0000c590: 2863 6c73 2c20 6675 6e63 2c20 6178 6573  (cls, func, axes
-0000c5a0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0000c5b0: 6e20 636c 7328 6675 6e63 2c20 7475 706c  n cls(func, tupl
-0000c5c0: 6528 6e2e 5f5f 696e 6465 785f 5f28 2920  e(n.__index__() 
-0000c5d0: 666f 7220 6e20 696e 206e 756d 7079 2e61  for n in numpy.a
-0000c5e0: 7267 736f 7274 2861 7865 7329 2929 0a0a  rgsort(axes)))..
-0000c5f0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-0000c600: 2873 656c 662c 2066 756e 633a 2041 7272  (self, func: Arr
-0000c610: 6179 2c20 6178 6573 3a20 7479 7069 6e67  ay, axes: typing
-0000c620: 2e54 7570 6c65 5b69 6e74 2c20 2e2e 2e5d  .Tuple[int, ...]
-0000c630: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
-0000c640: 7420 6973 696e 7374 616e 6365 2866 756e  t isinstance(fun
-0000c650: 632c 2041 7272 6179 292c 2066 2766 756e  c, Array), f'fun
-0000c660: 633d 7b66 756e 6321 727d 270a 2020 2020  c={func!r}'.    
-0000c670: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0000c680: 7461 6e63 6528 6178 6573 2c20 7475 706c  tance(axes, tupl
-0000c690: 6529 2061 6e64 2061 6c6c 2869 7369 6e73  e) and all(isins
-0000c6a0: 7461 6e63 6528 6178 6973 2c20 696e 7429  tance(axis, int)
-0000c6b0: 2066 6f72 2061 7869 7320 696e 2061 7865   for axis in axe
-0000c6c0: 7329 2c20 6627 6178 6573 3d7b 6178 6573  s), f'axes={axes
-0000c6d0: 2172 7d27 0a20 2020 2020 2020 2061 7373  !r}'.        ass
-0000c6e0: 6572 7420 736f 7274 6564 2861 7865 7329  ert sorted(axes)
-0000c6f0: 203d 3d20 6c69 7374 2872 616e 6765 2866   == list(range(f
-0000c700: 756e 632e 6e64 696d 2929 0a20 2020 2020  unc.ndim)).     
-0000c710: 2020 2073 656c 662e 6675 6e63 203d 2066     self.func = f
-0000c720: 756e 630a 2020 2020 2020 2020 7365 6c66  unc.        self
-0000c730: 2e61 7865 7320 3d20 6178 6573 0a20 2020  .axes = axes.   
-0000c740: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
-0000c750: 6e69 745f 5f28 6172 6773 3d28 6675 6e63  nit__(args=(func
-0000c760: 2c29 2c20 7368 6170 653d 7475 706c 6528  ,), shape=tuple(
-0000c770: 6675 6e63 2e73 6861 7065 5b6e 5d20 666f  func.shape[n] fo
-0000c780: 7220 6e20 696e 2061 7865 7329 2c20 6474  r n in axes), dt
-0000c790: 7970 653d 6675 6e63 2e64 7479 7065 290a  ype=func.dtype).
-0000c7a0: 0a20 2020 2040 6361 6368 6564 5f70 726f  .    @cached_pro
-0000c7b0: 7065 7274 790a 2020 2020 6465 6620 5f64  perty.    def _d
-0000c7c0: 6961 676f 6e61 6c73 2873 656c 6629 3a0a  iagonals(self):.
-0000c7d0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-0000c7e0: 7570 6c65 2866 726f 7a65 6e73 6574 2873  uple(frozenset(s
-0000c7f0: 656c 662e 5f69 6e76 6178 6573 5b69 5d20  elf._invaxes[i] 
-0000c800: 666f 7220 6920 696e 2061 7865 7329 2066  for i in axes) f
-0000c810: 6f72 2061 7865 7320 696e 2073 656c 662e  or axes in self.
-0000c820: 6675 6e63 2e5f 6469 6167 6f6e 616c 7329  func._diagonals)
-0000c830: 0a0a 2020 2020 4063 6163 6865 645f 7072  ..    @cached_pr
-0000c840: 6f70 6572 7479 0a20 2020 2064 6566 205f  operty.    def _
-0000c850: 696e 666c 6174 696f 6e73 2873 656c 6629  inflations(self)
-0000c860: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000c870: 2074 7570 6c65 2828 7365 6c66 2e5f 696e   tuple((self._in
-0000c880: 7661 7865 735b 6178 6973 5d2c 2074 7970  vaxes[axis], typ
-0000c890: 6573 2e66 726f 7a65 6e64 6963 7428 2864  es.frozendict((d
-0000c8a0: 6f66 6d61 702c 2054 7261 6e73 706f 7365  ofmap, Transpose
-0000c8b0: 2866 756e 632c 2073 656c 662e 5f61 7865  (func, self._axe
-0000c8c0: 735f 666f 7228 646f 666d 6170 2e6e 6469  s_for(dofmap.ndi
-0000c8d0: 6d2c 2073 656c 662e 5f69 6e76 6178 6573  m, self._invaxes
-0000c8e0: 5b61 7869 735d 2929 2920 666f 7220 646f  [axis]))) for do
-0000c8f0: 666d 6170 2c20 6675 6e63 2069 6e20 7061  fmap, func in pa
-0000c900: 7274 732e 6974 656d 7328 2929 2920 666f  rts.items())) fo
-0000c910: 7220 6178 6973 2c20 7061 7274 7320 696e  r axis, parts in
-0000c920: 2073 656c 662e 6675 6e63 2e5f 696e 666c   self.func._infl
-0000c930: 6174 696f 6e73 290a 0a20 2020 2040 6361  ations)..    @ca
-0000c940: 6368 6564 5f70 726f 7065 7274 790a 2020  ched_property.  
-0000c950: 2020 6465 6620 5f75 6e61 6c69 676e 6564    def _unaligned
-0000c960: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000c970: 756e 616c 6967 6e65 642c 2077 6865 7265  unaligned, where
-0000c980: 203d 2075 6e61 6c69 676e 2873 656c 662e   = unalign(self.
-0000c990: 6675 6e63 290a 2020 2020 2020 2020 7265  func).        re
-0000c9a0: 7475 726e 2075 6e61 6c69 676e 6564 2c20  turn unaligned, 
-0000c9b0: 7475 706c 6528 7365 6c66 2e5f 696e 7661  tuple(self._inva
-0000c9c0: 7865 735b 695d 2066 6f72 2069 2069 6e20  xes[i] for i in 
-0000c9d0: 7768 6572 6529 0a0a 2020 2020 4063 6163  where)..    @cac
-0000c9e0: 6865 645f 7072 6f70 6572 7479 0a20 2020  hed_property.   
-0000c9f0: 2064 6566 205f 696e 7661 7865 7328 7365   def _invaxes(se
-0000ca00: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
-0000ca10: 7572 6e20 7475 706c 6528 6e2e 5f5f 696e  urn tuple(n.__in
-0000ca20: 6465 785f 5f28 2920 666f 7220 6e20 696e  dex__() for n in
-0000ca30: 206e 756d 7079 2e61 7267 736f 7274 2873   numpy.argsort(s
-0000ca40: 656c 662e 6178 6573 2929 0a0a 2020 2020  elf.axes))..    
-0000ca50: 6465 6620 5f73 696d 706c 6966 6965 6428  def _simplified(
-0000ca60: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
-0000ca70: 6620 7365 6c66 2e61 7865 7320 3d3d 2074  f self.axes == t
-0000ca80: 7570 6c65 2872 616e 6765 2873 656c 662e  uple(range(self.
-0000ca90: 6e64 696d 2929 3a0a 2020 2020 2020 2020  ndim)):.        
-0000caa0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000cab0: 6675 6e63 0a20 2020 2020 2020 2072 6574  func.        ret
-0000cac0: 7572 6e20 7365 6c66 2e66 756e 632e 5f74  urn self.func._t
-0000cad0: 7261 6e73 706f 7365 2873 656c 662e 6178  ranspose(self.ax
-0000cae0: 6573 290a 0a20 2020 2064 6566 2065 7661  es)..    def eva
-0000caf0: 6c66 2873 656c 662c 2061 7272 293a 0a20  lf(self, arr):. 
-0000cb00: 2020 2020 2020 2072 6574 7572 6e20 6172         return ar
-0000cb10: 722e 7472 616e 7370 6f73 6528 7365 6c66  r.transpose(self
-0000cb20: 2e61 7865 7329 0a0a 2020 2020 4070 726f  .axes)..    @pro
-0000cb30: 7065 7274 790a 2020 2020 6465 6620 5f6e  perty.    def _n
-0000cb40: 6f64 655f 6465 7461 696c 7328 7365 6c66  ode_details(self
-0000cb50: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0000cb60: 6e20 272c 272e 6a6f 696e 286d 6170 2873  n ','.join(map(s
-0000cb70: 7472 2c20 7365 6c66 2e61 7865 7329 290a  tr, self.axes)).
-0000cb80: 0a20 2020 2064 6566 205f 7472 616e 7370  .    def _transp
-0000cb90: 6f73 6528 7365 6c66 2c20 6178 6573 293a  ose(self, axes):
-0000cba0: 0a20 2020 2020 2020 2069 6620 6178 6573  .        if axes
-0000cbb0: 203d 3d20 7365 6c66 2e5f 696e 7661 7865   == self._invaxe
-0000cbc0: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
-0000cbd0: 204e 4f54 453a 2057 6869 6c65 2077 6520   NOTE: While we 
-0000cbe0: 636f 756c 6420 6c65 6176 6520 7468 6973  could leave this
-0000cbf0: 2070 6172 7469 6375 6c61 7220 7369 6d70   particular simp
-0000cc00: 6c69 6669 6361 7469 6f6e 2074 6f20 6265  lification to be
-0000cc10: 2064 6561 6c74 0a20 2020 2020 2020 2020   dealt.         
-0000cc20: 2020 2023 2077 6974 6820 6279 2054 7261     # with by Tra
-0000cc30: 6e73 706f 7365 2c20 7468 6520 6265 6e65  nspose, the bene
-0000cc40: 6669 7420 6f66 2068 616e 646c 696e 6720  fit of handling 
-0000cc50: 6974 2064 6972 6563 746c 7920 6973 2074  it directly is t
-0000cc60: 6861 7420 5f61 6464 2061 6e64 0a20 2020  hat _add and.   
-0000cc70: 2020 2020 2020 2020 2023 205f 6d75 6c74           # _mult
-0000cc80: 6970 6c79 2063 616e 2072 656c 7920 6f6e  iply can rely on
-0000cc90: 205f 7472 616e 7370 6f73 6520 666f 7220   _transpose for 
-0000cca0: 7468 6520 7269 6768 7420 6861 6e64 2073  the right hand s
-0000ccb0: 6964 6520 7769 7468 6f75 7420 6861 7669  ide without havi
-0000ccc0: 6e67 0a20 2020 2020 2020 2020 2020 2023  ng.            #
-0000ccd0: 2074 6f20 7365 7061 7261 7465 6c79 2061   to separately a
-0000cce0: 6363 6f75 6e74 2066 6f72 2074 6865 2074  ccount for the t
-0000ccf0: 7269 7669 616c 2063 6173 652e 0a20 2020  rivial case..   
-0000cd00: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000cd10: 7365 6c66 2e66 756e 630a 2020 2020 2020  self.func.      
-0000cd20: 2020 6e65 7761 7865 7320 3d20 7475 706c    newaxes = tupl
-0000cd30: 6528 7365 6c66 2e61 7865 735b 695d 2066  e(self.axes[i] f
-0000cd40: 6f72 2069 2069 6e20 6178 6573 290a 2020  or i in axes).  
-0000cd50: 2020 2020 2020 7265 7475 726e 2054 7261        return Tra
-0000cd60: 6e73 706f 7365 2873 656c 662e 6675 6e63  nspose(self.func
-0000cd70: 2c20 6e65 7761 7865 7329 0a0a 2020 2020  , newaxes)..    
-0000cd80: 6465 6620 5f74 616b 6564 6961 6728 7365  def _takediag(se
-0000cd90: 6c66 2c20 6178 6973 312c 2061 7869 7332  lf, axis1, axis2
-0000cda0: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
-0000cdb0: 7420 6178 6973 3120 3c20 6178 6973 320a  t axis1 < axis2.
-0000cdc0: 2020 2020 2020 2020 6f72 6967 312c 206f          orig1, o
-0000cdd0: 7269 6732 203d 2073 6f72 7465 6428 7365  rig2 = sorted(se
-0000cde0: 6c66 2e61 7865 735b 6178 6973 5d20 666f  lf.axes[axis] fo
-0000cdf0: 7220 6178 6973 2069 6e20 5b61 7869 7331  r axis in [axis1
-0000ce00: 2c20 6178 6973 325d 290a 2020 2020 2020  , axis2]).      
-0000ce10: 2020 6966 206f 7269 6731 203d 3d20 7365    if orig1 == se
-0000ce20: 6c66 2e6e 6469 6d2d 323a 0a20 2020 2020  lf.ndim-2:.     
-0000ce30: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-0000ce40: 616e 7370 6f73 6528 5461 6b65 4469 6167  anspose(TakeDiag
-0000ce50: 2873 656c 662e 6675 6e63 292c 2028 2a73  (self.func), (*s
-0000ce60: 656c 662e 6178 6573 5b3a 6178 6973 315d  elf.axes[:axis1]
-0000ce70: 2c20 2a73 656c 662e 6178 6573 5b61 7869  , *self.axes[axi
-0000ce80: 7331 2b31 3a61 7869 7332 5d2c 202a 7365  s1+1:axis2], *se
-0000ce90: 6c66 2e61 7865 735b 6178 6973 322b 313a  lf.axes[axis2+1:
-0000cea0: 5d2c 2073 656c 662e 6e64 696d 2d32 2929  ], self.ndim-2))
-0000ceb0: 0a20 2020 2020 2020 2074 7279 7461 6b65  .        trytake
-0000cec0: 6469 6167 203d 2073 656c 662e 6675 6e63  diag = self.func
-0000ced0: 2e5f 7461 6b65 6469 6167 286f 7269 6731  ._takediag(orig1
-0000cee0: 2c20 6f72 6967 3229 0a20 2020 2020 2020  , orig2).       
-0000cef0: 2069 6620 7472 7974 616b 6564 6961 6720   if trytakediag 
-0000cf00: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0000cf10: 2020 2020 2020 2020 2065 7863 6c75 6465           exclude
-0000cf20: 5f6f 7269 6720 3d20 5b61 782d 2861 7820  _orig = [ax-(ax 
-0000cf30: 3e20 6f72 6967 3129 2d28 6178 203e 206f  > orig1)-(ax > o
-0000cf40: 7269 6732 2920 666f 7220 6178 2069 6e20  rig2) for ax in 
-0000cf50: 7365 6c66 2e61 7865 735b 3a61 7869 7331  self.axes[:axis1
-0000cf60: 5d20 2b20 7365 6c66 2e61 7865 735b 6178  ] + self.axes[ax
-0000cf70: 6973 312b 313a 6178 6973 325d 202b 2073  is1+1:axis2] + s
-0000cf80: 656c 662e 6178 6573 5b61 7869 7332 2b31  elf.axes[axis2+1
-0000cf90: 3a5d 5d0a 2020 2020 2020 2020 2020 2020  :]].            
-0000cfa0: 7265 7475 726e 2054 7261 6e73 706f 7365  return Transpose
-0000cfb0: 2874 7279 7461 6b65 6469 6167 2c20 282a  (trytakediag, (*
-0000cfc0: 6578 636c 7564 655f 6f72 6967 2c20 7365  exclude_orig, se
-0000cfd0: 6c66 2e6e 6469 6d2d 3229 290a 0a20 2020  lf.ndim-2))..   
-0000cfe0: 2064 6566 205f 7375 6d28 7365 6c66 2c20   def _sum(self, 
-0000cff0: 6929 3a0a 2020 2020 2020 2020 6178 6973  i):.        axis
-0000d000: 203d 2073 656c 662e 6178 6573 5b69 5d0a   = self.axes[i].
-0000d010: 2020 2020 2020 2020 7472 7973 756d 203d          trysum =
-0000d020: 2073 656c 662e 6675 6e63 2e5f 7375 6d28   self.func._sum(
-0000d030: 6178 6973 290a 2020 2020 2020 2020 6966  axis).        if
-0000d040: 2074 7279 7375 6d20 6973 206e 6f74 204e   trysum is not N
-0000d050: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000d060: 2061 7865 7320 3d20 7475 706c 6528 6178   axes = tuple(ax
-0000d070: 2d28 6178 203e 2061 7869 7329 2066 6f72  -(ax > axis) for
-0000d080: 2061 7820 696e 2073 656c 662e 6178 6573   ax in self.axes
-0000d090: 2069 6620 6178 2021 3d20 6178 6973 290a   if ax != axis).
-0000d0a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000d0b0: 726e 2054 7261 6e73 706f 7365 2874 7279  rn Transpose(try
-0000d0c0: 7375 6d2c 2061 7865 7329 0a20 2020 2020  sum, axes).     
-0000d0d0: 2020 2069 6620 6178 6973 203d 3d20 7365     if axis == se
-0000d0e0: 6c66 2e6e 6469 6d20 2d20 313a 0a20 2020  lf.ndim - 1:.   
-0000d0f0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000d100: 5472 616e 7370 6f73 6528 5375 6d28 7365  Transpose(Sum(se
-0000d110: 6c66 2e66 756e 6329 2c20 7365 6c66 2e5f  lf.func), self._
-0000d120: 6178 6573 5f66 6f72 2830 2c20 6929 290a  axes_for(0, i)).
-0000d130: 0a20 2020 2064 6566 205f 6465 7269 7661  .    def _deriva
-0000d140: 7469 7665 2873 656c 662c 2076 6172 2c20  tive(self, var, 
-0000d150: 7365 656e 293a 0a20 2020 2020 2020 2072  seen):.        r
-0000d160: 6574 7572 6e20 7472 616e 7370 6f73 6528  eturn transpose(
-0000d170: 6465 7269 7661 7469 7665 2873 656c 662e  derivative(self.
-0000d180: 6675 6e63 2c20 7661 722c 2073 6565 6e29  func, var, seen)
-0000d190: 2c20 7365 6c66 2e61 7865 732b 7475 706c  , self.axes+tupl
-0000d1a0: 6528 7261 6e67 6528 7365 6c66 2e6e 6469  e(range(self.ndi
-0000d1b0: 6d2c 2073 656c 662e 6e64 696d 2b76 6172  m, self.ndim+var
-0000d1c0: 2e6e 6469 6d29 2929 0a0a 2020 2020 6465  .ndim)))..    de
-0000d1d0: 6620 5f6d 756c 7469 706c 7928 7365 6c66  f _multiply(self
-0000d1e0: 2c20 6f74 6865 7229 3a0a 2020 2020 2020  , other):.      
-0000d1f0: 2020 6f74 6865 725f 7472 616e 7320 3d20    other_trans = 
-0000d200: 6f74 6865 722e 5f74 7261 6e73 706f 7365  other._transpose
-0000d210: 2873 656c 662e 5f69 6e76 6178 6573 290a  (self._invaxes).
-0000d220: 2020 2020 2020 2020 6966 206f 7468 6572          if other
-0000d230: 5f74 7261 6e73 2069 7320 6e6f 7420 4e6f  _trans is not No
-0000d240: 6e65 2061 6e64 206e 6f74 2069 7369 6e73  ne and not isins
-0000d250: 7461 6e63 6528 6f74 6865 725f 7472 616e  tance(other_tran
-0000d260: 732c 2054 7261 6e73 706f 7365 293a 0a20  s, Transpose):. 
-0000d270: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-0000d280: 2073 6563 6f6e 6420 636c 6175 7365 2069   second clause i
-0000d290: 7320 746f 2061 766f 6964 2069 6e66 696e  s to avoid infin
-0000d2a0: 6974 6520 7265 6375 7273 696f 6e73 3b20  ite recursions; 
-0000d2b0: 7365 650a 2020 2020 2020 2020 2020 2020  see.            
-0000d2c0: 2320 7465 7374 732e 7465 7374 5f65 7661  # tests.test_eva
-0000d2d0: 6c75 6162 6c65 2e73 696d 706c 6966 792e  luable.simplify.
-0000d2e0: 7465 7374 5f6d 756c 7469 706c 795f 7472  test_multiply_tr
-0000d2f0: 616e 7370 6f73 652e 0a20 2020 2020 2020  anspose..       
-0000d300: 2020 2020 2072 6574 7572 6e20 5472 616e       return Tran
-0000d310: 7370 6f73 6528 6d75 6c74 6970 6c79 2873  spose(multiply(s
-0000d320: 656c 662e 6675 6e63 2c20 6f74 6865 725f  elf.func, other_
-0000d330: 7472 616e 7329 2c20 7365 6c66 2e61 7865  trans), self.axe
-0000d340: 7329 0a20 2020 2020 2020 2074 7279 6d75  s).        trymu
-0000d350: 6c74 6970 6c79 203d 2073 656c 662e 6675  ltiply = self.fu
-0000d360: 6e63 2e5f 6d75 6c74 6970 6c79 2854 7261  nc._multiply(Tra
-0000d370: 6e73 706f 7365 286f 7468 6572 2c20 7365  nspose(other, se
-0000d380: 6c66 2e5f 696e 7661 7865 7329 290a 2020  lf._invaxes)).  
-0000d390: 2020 2020 2020 6966 2074 7279 6d75 6c74        if trymult
-0000d3a0: 6970 6c79 2069 7320 6e6f 7420 4e6f 6e65  iply is not None
-0000d3b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000d3c0: 7475 726e 2054 7261 6e73 706f 7365 2874  turn Transpose(t
-0000d3d0: 7279 6d75 6c74 6970 6c79 2c20 7365 6c66  rymultiply, self
-0000d3e0: 2e61 7865 7329 0a0a 2020 2020 6465 6620  .axes)..    def 
-0000d3f0: 5f61 6464 2873 656c 662c 206f 7468 6572  _add(self, other
-0000d400: 293a 0a20 2020 2020 2020 206f 7468 6572  ):.        other
-0000d410: 5f74 7261 6e73 203d 206f 7468 6572 2e5f  _trans = other._
-0000d420: 7472 616e 7370 6f73 6528 7365 6c66 2e5f  transpose(self._
-0000d430: 696e 7661 7865 7329 0a20 2020 2020 2020  invaxes).       
-0000d440: 2069 6620 6f74 6865 725f 7472 616e 7320   if other_trans 
-0000d450: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-0000d460: 6e6f 7420 6973 696e 7374 616e 6365 286f  not isinstance(o
-0000d470: 7468 6572 5f74 7261 6e73 2c20 5472 616e  ther_trans, Tran
-0000d480: 7370 6f73 6529 3a0a 2020 2020 2020 2020  spose):.        
-0000d490: 2020 2020 2320 5468 6520 7365 636f 6e64      # The second
-0000d4a0: 2063 6c61 7573 6520 6973 2074 6f20 6176   clause is to av
-0000d4b0: 6f69 6420 696e 6669 6e69 7465 2072 6563  oid infinite rec
-0000d4c0: 7572 7369 6f6e 730a 2020 2020 2020 2020  ursions.        
-0000d4d0: 2020 2020 7265 7475 726e 2054 7261 6e73      return Trans
-0000d4e0: 706f 7365 2873 656c 662e 6675 6e63 202b  pose(self.func +
-0000d4f0: 206f 7468 6572 5f74 7261 6e73 2c20 7365   other_trans, se
-0000d500: 6c66 2e61 7865 7329 0a20 2020 2020 2020  lf.axes).       
-0000d510: 2074 7279 6164 6420 3d20 7365 6c66 2e66   tryadd = self.f
-0000d520: 756e 632e 5f61 6464 2854 7261 6e73 706f  unc._add(Transpo
-0000d530: 7365 286f 7468 6572 2c20 7365 6c66 2e5f  se(other, self._
-0000d540: 696e 7661 7865 7329 290a 2020 2020 2020  invaxes)).      
-0000d550: 2020 6966 2074 7279 6164 6420 6973 206e    if tryadd is n
-0000d560: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0000d570: 2020 2020 2072 6574 7572 6e20 5472 616e       return Tran
-0000d580: 7370 6f73 6528 7472 7961 6464 2c20 7365  spose(tryadd, se
-0000d590: 6c66 2e61 7865 7329 0a0a 2020 2020 6465  lf.axes)..    de
-0000d5a0: 6620 5f74 616b 6528 7365 6c66 2c20 696e  f _take(self, in
-0000d5b0: 6469 6365 732c 2061 7869 7329 3a0a 2020  dices, axis):.  
-0000d5c0: 2020 2020 2020 7472 7974 616b 6520 3d20        trytake = 
-0000d5d0: 7365 6c66 2e66 756e 632e 5f74 616b 6528  self.func._take(
-0000d5e0: 696e 6469 6365 732c 2073 656c 662e 6178  indices, self.ax
-0000d5f0: 6573 5b61 7869 735d 290a 2020 2020 2020  es[axis]).      
-0000d600: 2020 6966 2074 7279 7461 6b65 2069 7320    if trytake is 
-0000d610: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000d620: 2020 2020 2020 7265 7475 726e 2054 7261        return Tra
-0000d630: 6e73 706f 7365 2874 7279 7461 6b65 2c20  nspose(trytake, 
-0000d640: 7365 6c66 2e5f 6178 6573 5f66 6f72 2869  self._axes_for(i
-0000d650: 6e64 6963 6573 2e6e 6469 6d2c 2061 7869  ndices.ndim, axi
-0000d660: 7329 290a 2020 2020 2020 2020 6966 2073  s)).        if s
-0000d670: 656c 662e 6178 6573 5b61 7869 735d 203d  elf.axes[axis] =
-0000d680: 3d20 7365 6c66 2e6e 6469 6d20 2d20 313a  = self.ndim - 1:
-0000d690: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000d6a0: 7572 6e20 5472 616e 7370 6f73 6528 5461  urn Transpose(Ta
-0000d6b0: 6b65 2873 656c 662e 6675 6e63 2c20 696e  ke(self.func, in
-0000d6c0: 6469 6365 7329 2c20 7365 6c66 2e5f 6178  dices), self._ax
-0000d6d0: 6573 5f66 6f72 2869 6e64 6963 6573 2e6e  es_for(indices.n
-0000d6e0: 6469 6d2c 2061 7869 7329 290a 0a20 2020  dim, axis))..   
-0000d6f0: 2064 6566 205f 6178 6573 5f66 6f72 2873   def _axes_for(s
-0000d700: 656c 662c 206e 6469 6d2c 2061 7869 7329  elf, ndim, axis)
-0000d710: 3a0a 2020 2020 2020 2020 6675 6e63 6178  :.        funcax
-0000d720: 6973 203d 2073 656c 662e 6178 6573 5b61  is = self.axes[a
-0000d730: 7869 735d 0a20 2020 2020 2020 2061 7865  xis].        axe
-0000d740: 7320 3d20 5b61 782b 2861 7820 3e20 6675  s = [ax+(ax > fu
-0000d750: 6e63 6178 6973 292a 286e 6469 6d2d 3129  ncaxis)*(ndim-1)
-0000d760: 2066 6f72 2061 7820 696e 2073 656c 662e   for ax in self.
-0000d770: 6178 6573 2069 6620 6178 2021 3d20 6675  axes if ax != fu
-0000d780: 6e63 6178 6973 5d0a 2020 2020 2020 2020  ncaxis].        
-0000d790: 6178 6573 5b61 7869 733a 6178 6973 5d20  axes[axis:axis] 
-0000d7a0: 3d20 7261 6e67 6528 6675 6e63 6178 6973  = range(funcaxis
-0000d7b0: 2c20 6675 6e63 6178 6973 202b 206e 6469  , funcaxis + ndi
-0000d7c0: 6d29 0a20 2020 2020 2020 2072 6574 7572  m).        retur
-0000d7d0: 6e20 7475 706c 6528 6178 6573 290a 0a20  n tuple(axes).. 
-0000d7e0: 2020 2064 6566 205f 706f 7765 7228 7365     def _power(se
-0000d7f0: 6c66 2c20 6e29 3a0a 2020 2020 2020 2020  lf, n):.        
-0000d800: 6e5f 7472 616e 7320 3d20 5472 616e 7370  n_trans = Transp
-0000d810: 6f73 6528 6e2c 2073 656c 662e 5f69 6e76  ose(n, self._inv
-0000d820: 6178 6573 290a 2020 2020 2020 2020 7265  axes).        re
-0000d830: 7475 726e 2054 7261 6e73 706f 7365 2850  turn Transpose(P
-0000d840: 6f77 6572 2873 656c 662e 6675 6e63 2c20  ower(self.func, 
-0000d850: 6e5f 7472 616e 7329 2c20 7365 6c66 2e61  n_trans), self.a
-0000d860: 7865 7329 0a0a 2020 2020 6465 6620 5f73  xes)..    def _s
-0000d870: 6967 6e28 7365 6c66 293a 0a20 2020 2020  ign(self):.     
-0000d880: 2020 2072 6574 7572 6e20 5472 616e 7370     return Transp
-0000d890: 6f73 6528 5369 676e 2873 656c 662e 6675  ose(Sign(self.fu
-0000d8a0: 6e63 292c 2073 656c 662e 6178 6573 290a  nc), self.axes).
-0000d8b0: 0a20 2020 2064 6566 205f 756e 7261 7665  .    def _unrave
-0000d8c0: 6c28 7365 6c66 2c20 6178 6973 2c20 7368  l(self, axis, sh
-0000d8d0: 6170 6529 3a0a 2020 2020 2020 2020 6f72  ape):.        or
-0000d8e0: 6967 5f61 7869 7320 3d20 7365 6c66 2e61  ig_axis = self.a
-0000d8f0: 7865 735b 6178 6973 5d0a 2020 2020 2020  xes[axis].      
-0000d900: 2020 7472 7975 6e72 6176 656c 203d 2073    tryunravel = s
-0000d910: 656c 662e 6675 6e63 2e5f 756e 7261 7665  elf.func._unrave
-0000d920: 6c28 6f72 6967 5f61 7869 732c 2073 6861  l(orig_axis, sha
-0000d930: 7065 290a 2020 2020 2020 2020 6966 2074  pe).        if t
-0000d940: 7279 756e 7261 7665 6c20 6973 206e 6f74  ryunravel is not
-0000d950: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000d960: 2020 2061 7865 7320 3d20 5b61 7820 2b20     axes = [ax + 
-0000d970: 2861 7820 3e20 6f72 6967 5f61 7869 7329  (ax > orig_axis)
-0000d980: 2066 6f72 2061 7820 696e 2073 656c 662e   for ax in self.
-0000d990: 6178 6573 5d0a 2020 2020 2020 2020 2020  axes].          
-0000d9a0: 2020 6178 6573 2e69 6e73 6572 7428 6178    axes.insert(ax
-0000d9b0: 6973 2b31 2c20 6f72 6967 5f61 7869 732b  is+1, orig_axis+
-0000d9c0: 3129 0a20 2020 2020 2020 2020 2020 2072  1).            r
-0000d9d0: 6574 7572 6e20 5472 616e 7370 6f73 6528  eturn Transpose(
-0000d9e0: 7472 7975 6e72 6176 656c 2c20 7475 706c  tryunravel, tupl
-0000d9f0: 6528 6178 6573 2929 0a0a 2020 2020 6465  e(axes))..    de
-0000da00: 6620 5f70 726f 6475 6374 2873 656c 6629  f _product(self)
-0000da10: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
-0000da20: 662e 6178 6573 5b2d 315d 203d 3d20 7365  f.axes[-1] == se
-0000da30: 6c66 2e6e 6469 6d2d 313a 0a20 2020 2020  lf.ndim-1:.     
-0000da40: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-0000da50: 616e 7370 6f73 6528 5072 6f64 7563 7428  anspose(Product(
-0000da60: 7365 6c66 2e66 756e 6329 2c20 7365 6c66  self.func), self
-0000da70: 2e61 7865 735b 3a2d 315d 290a 0a20 2020  .axes[:-1])..   
-0000da80: 2064 6566 205f 6465 7465 726d 696e 616e   def _determinan
-0000da90: 7428 7365 6c66 2c20 6178 6973 312c 2061  t(self, axis1, a
-0000daa0: 7869 7332 293a 0a20 2020 2020 2020 206f  xis2):.        o
-0000dab0: 7269 6731 2c20 6f72 6967 3220 3d20 7365  rig1, orig2 = se
-0000dac0: 6c66 2e61 7865 735b 6178 6973 315d 2c20  lf.axes[axis1], 
-0000dad0: 7365 6c66 2e61 7865 735b 6178 6973 325d  self.axes[axis2]
-0000dae0: 0a20 2020 2020 2020 2074 7279 6465 7420  .        trydet 
-0000daf0: 3d20 7365 6c66 2e66 756e 632e 5f64 6574  = self.func._det
-0000db00: 6572 6d69 6e61 6e74 286f 7269 6731 2c20  erminant(orig1, 
-0000db10: 6f72 6967 3229 0a20 2020 2020 2020 2069  orig2).        i
-0000db20: 6620 7472 7964 6574 3a0a 2020 2020 2020  f trydet:.      
-0000db30: 2020 2020 2020 6178 6573 203d 2074 7570        axes = tup
-0000db40: 6c65 2861 782d 2861 7820 3e20 6f72 6967  le(ax-(ax > orig
-0000db50: 3129 2d28 6178 203e 206f 7269 6732 2920  1)-(ax > orig2) 
-0000db60: 666f 7220 6178 2069 6e20 7365 6c66 2e61  for ax in self.a
-0000db70: 7865 7320 6966 2061 7820 213d 206f 7269  xes if ax != ori
-0000db80: 6731 2061 6e64 2061 7820 213d 206f 7269  g1 and ax != ori
-0000db90: 6732 290a 2020 2020 2020 2020 2020 2020  g2).            
-0000dba0: 7265 7475 726e 2054 7261 6e73 706f 7365  return Transpose
-0000dbb0: 2874 7279 6465 742c 2061 7865 7329 0a0a  (trydet, axes)..
-0000dbc0: 2020 2020 6465 6620 5f69 6e76 6572 7365      def _inverse
-0000dbd0: 2873 656c 662c 2061 7869 7331 2c20 6178  (self, axis1, ax
-0000dbe0: 6973 3229 3a0a 2020 2020 2020 2020 7472  is2):.        tr
-0000dbf0: 7969 6e76 203d 2073 656c 662e 6675 6e63  yinv = self.func
-0000dc00: 2e5f 696e 7665 7273 6528 7365 6c66 2e61  ._inverse(self.a
-0000dc10: 7865 735b 6178 6973 315d 2c20 7365 6c66  xes[axis1], self
-0000dc20: 2e61 7865 735b 6178 6973 325d 290a 2020  .axes[axis2]).  
-0000dc30: 2020 2020 2020 6966 2074 7279 696e 763a        if tryinv:
-0000dc40: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000dc50: 7572 6e20 5472 616e 7370 6f73 6528 7472  urn Transpose(tr
-0000dc60: 7969 6e76 2c20 7365 6c66 2e61 7865 7329  yinv, self.axes)
-0000dc70: 0a0a 2020 2020 6465 6620 5f72 6176 656c  ..    def _ravel
-0000dc80: 2873 656c 662c 2061 7869 7329 3a0a 2020  (self, axis):.  
-0000dc90: 2020 2020 2020 6966 2073 656c 662e 6178        if self.ax
-0000dca0: 6573 5b61 7869 735d 203d 3d20 7365 6c66  es[axis] == self
-0000dcb0: 2e6e 6469 6d2d 3220 616e 6420 7365 6c66  .ndim-2 and self
-0000dcc0: 2e61 7865 735b 6178 6973 2b31 5d20 3d3d  .axes[axis+1] ==
-0000dcd0: 2073 656c 662e 6e64 696d 2d31 3a0a 2020   self.ndim-1:.  
-0000dce0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000dcf0: 2054 7261 6e73 706f 7365 2852 6176 656c   Transpose(Ravel
-0000dd00: 2873 656c 662e 6675 6e63 292c 2073 656c  (self.func), sel
-0000dd10: 662e 6178 6573 5b3a 2d31 5d29 0a0a 2020  f.axes[:-1])..  
-0000dd20: 2020 6465 6620 5f69 6e66 6c61 7465 2873    def _inflate(s
-0000dd30: 656c 662c 2064 6f66 6d61 702c 206c 656e  elf, dofmap, len
-0000dd40: 6774 682c 2061 7869 7329 3a0a 2020 2020  gth, axis):.    
-0000dd50: 2020 2020 6920 3d20 7365 6c66 2e61 7865      i = self.axe
-0000dd60: 735b 6178 6973 5d20 6966 2064 6f66 6d61  s[axis] if dofma
-0000dd70: 702e 6e64 696d 2065 6c73 6520 7365 6c66  p.ndim else self
-0000dd80: 2e66 756e 632e 6e64 696d 0a20 2020 2020  .func.ndim.     
-0000dd90: 2020 2069 6620 7365 6c66 2e61 7865 735b     if self.axes[
-0000dda0: 6178 6973 3a61 7869 732b 646f 666d 6170  axis:axis+dofmap
-0000ddb0: 2e6e 6469 6d5d 203d 3d20 7475 706c 6528  .ndim] == tuple(
-0000ddc0: 7261 6e67 6528 692c 2069 2b64 6f66 6d61  range(i, i+dofma
-0000ddd0: 702e 6e64 696d 2929 3a0a 2020 2020 2020  p.ndim)):.      
-0000dde0: 2020 2020 2020 7472 7969 6e66 6c61 7465        tryinflate
-0000ddf0: 203d 2073 656c 662e 6675 6e63 2e5f 696e   = self.func._in
-0000de00: 666c 6174 6528 646f 666d 6170 2c20 6c65  flate(dofmap, le
-0000de10: 6e67 7468 2c20 6929 0a20 2020 2020 2020  ngth, i).       
-0000de20: 2020 2020 2069 6620 7472 7969 6e66 6c61       if tryinfla
-0000de30: 7465 2069 7320 6e6f 7420 4e6f 6e65 3a0a  te is not None:.
-0000de40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de50: 6178 6573 203d 205b 6178 2d28 6178 203e  axes = [ax-(ax >
-0000de60: 2069 292a 2864 6f66 6d61 702e 6e64 696d   i)*(dofmap.ndim
-0000de70: 2d31 2920 666f 7220 6178 2069 6e20 7365  -1) for ax in se
-0000de80: 6c66 2e61 7865 735d 0a20 2020 2020 2020  lf.axes].       
-0000de90: 2020 2020 2020 2020 2061 7865 735b 6178           axes[ax
-0000dea0: 6973 3a61 7869 732b 646f 666d 6170 2e6e  is:axis+dofmap.n
-0000deb0: 6469 6d5d 203d 2069 2c0a 2020 2020 2020  dim] = i,.      
-0000dec0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000ded0: 2054 7261 6e73 706f 7365 2874 7279 696e   Transpose(tryin
-0000dee0: 666c 6174 652c 2074 7570 6c65 2861 7865  flate, tuple(axe
-0000def0: 7329 290a 0a20 2020 2064 6566 205f 6469  s))..    def _di
-0000df00: 6167 6f6e 616c 697a 6528 7365 6c66 2c20  agonalize(self, 
-0000df10: 6178 6973 293a 0a20 2020 2020 2020 2074  axis):.        t
-0000df20: 7279 6469 6167 6f6e 616c 697a 6520 3d20  rydiagonalize = 
-0000df30: 7365 6c66 2e66 756e 632e 5f64 6961 676f  self.func._diago
-0000df40: 6e61 6c69 7a65 2873 656c 662e 6178 6573  nalize(self.axes
-0000df50: 5b61 7869 735d 290a 2020 2020 2020 2020  [axis]).        
-0000df60: 6966 2074 7279 6469 6167 6f6e 616c 697a  if trydiagonaliz
-0000df70: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
-0000df80: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000df90: 6e20 5472 616e 7370 6f73 6528 7472 7964  n Transpose(tryd
-0000dfa0: 6961 676f 6e61 6c69 7a65 2c20 7365 6c66  iagonalize, self
-0000dfb0: 2e61 7865 7320 2b20 2873 656c 662e 6e64  .axes + (self.nd
-0000dfc0: 696d 2c29 290a 0a20 2020 2064 6566 205f  im,))..    def _
-0000dfd0: 696e 7365 7274 6178 6973 2873 656c 662c  insertaxis(self,
-0000dfe0: 2061 7869 732c 206c 656e 6774 6829 3a0a   axis, length):.
-0000dff0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-0000e000: 7261 6e73 706f 7365 2849 6e73 6572 7441  ranspose(InsertA
-0000e010: 7869 7328 7365 6c66 2e66 756e 632c 206c  xis(self.func, l
-0000e020: 656e 6774 6829 2c20 7365 6c66 2e61 7865  ength), self.axe
-0000e030: 735b 3a61 7869 735d 202b 2028 7365 6c66  s[:axis] + (self
-0000e040: 2e6e 6469 6d2c 2920 2b20 7365 6c66 2e61  .ndim,) + self.a
-0000e050: 7865 735b 6178 6973 3a5d 290a 0a20 2020  xes[axis:])..   
-0000e060: 2064 6566 205f 6c6f 6f70 7375 6d28 7365   def _loopsum(se
-0000e070: 6c66 2c20 696e 6465 7829 3a0a 2020 2020  lf, index):.    
-0000e080: 2020 2020 7265 7475 726e 2054 7261 6e73      return Trans
-0000e090: 706f 7365 286c 6f6f 705f 7375 6d28 7365  pose(loop_sum(se
-0000e0a0: 6c66 2e66 756e 632c 2069 6e64 6578 292c  lf.func, index),
-0000e0b0: 2073 656c 662e 6178 6573 290a 0a20 2020   self.axes)..   
-0000e0c0: 2040 6361 6368 6564 5f70 726f 7065 7274   @cached_propert
-0000e0d0: 790a 2020 2020 6465 6620 5f61 7373 7061  y.    def _asspa
-0000e0e0: 7273 6528 7365 6c66 293a 0a20 2020 2020  rse(self):.     
-0000e0f0: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
-0000e100: 282a 2869 6e64 6963 6573 5b69 5d20 666f  (*(indices[i] fo
-0000e110: 7220 6920 696e 2073 656c 662e 6178 6573  r i in self.axes
-0000e120: 292c 2076 616c 7565 7329 2066 6f72 202a  ), values) for *
-0000e130: 696e 6469 6365 732c 2076 616c 7565 7320  indices, values 
-0000e140: 696e 2073 656c 662e 6675 6e63 2e5f 6173  in self.func._as
-0000e150: 7370 6172 7365 290a 0a20 2020 2064 6566  sparse)..    def
-0000e160: 205f 696e 7462 6f75 6e64 735f 696d 706c   _intbounds_impl
-0000e170: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000e180: 7265 7475 726e 2073 656c 662e 6675 6e63  return self.func
-0000e190: 2e5f 696e 7462 6f75 6e64 730a 0a20 2020  ._intbounds..   
-0000e1a0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-0000e1b0: 6566 205f 636f 6e73 745f 756e 6966 6f72  ef _const_unifor
-0000e1c0: 6d28 7365 6c66 293a 0a20 2020 2020 2020  m(self):.       
-0000e1d0: 2072 6574 7572 6e20 7365 6c66 2e66 756e   return self.fun
-0000e1e0: 632e 5f63 6f6e 7374 5f75 6e69 666f 726d  c._const_uniform
-0000e1f0: 0a0a 0a63 6c61 7373 2050 726f 6475 6374  ...class Product
-0000e200: 2841 7272 6179 293a 0a0a 2020 2020 6465  (Array):..    de
-0000e210: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-0000e220: 2066 756e 633a 2041 7272 6179 293a 0a20   func: Array):. 
-0000e230: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-0000e240: 696e 7374 616e 6365 2866 756e 632c 2041  instance(func, A
-0000e250: 7272 6179 2920 616e 6420 6675 6e63 2e64  rray) and func.d
-0000e260: 7479 7065 2021 3d20 626f 6f6c 2c20 6627  type != bool, f'
-0000e270: 6675 6e63 3d7b 6675 6e63 2172 7d27 0a20  func={func!r}'. 
-0000e280: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
-0000e290: 203d 2066 756e 630a 2020 2020 2020 2020   = func.        
-0000e2a0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
-0000e2b0: 2861 7267 733d 2866 756e 632c 292c 2073  (args=(func,), s
-0000e2c0: 6861 7065 3d66 756e 632e 7368 6170 655b  hape=func.shape[
-0000e2d0: 3a2d 315d 2c20 6474 7970 653d 6675 6e63  :-1], dtype=func
-0000e2e0: 2e64 7479 7065 290a 0a20 2020 2064 6566  .dtype)..    def
-0000e2f0: 205f 7369 6d70 6c69 6669 6564 2873 656c   _simplified(sel
-0000e300: 6629 3a0a 2020 2020 2020 2020 6966 205f  f):.        if _
-0000e310: 6571 7561 6c73 5f73 6361 6c61 725f 636f  equals_scalar_co
-0000e320: 6e73 7461 6e74 2873 656c 662e 6675 6e63  nstant(self.func
-0000e330: 2e73 6861 7065 5b2d 315d 2c20 3129 3a0a  .shape[-1], 1):.
-0000e340: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000e350: 726e 2067 6574 2873 656c 662e 6675 6e63  rn get(self.func
-0000e360: 2c20 7365 6c66 2e6e 6469 6d2c 2063 6f6e  , self.ndim, con
-0000e370: 7374 616e 7428 3029 290a 2020 2020 2020  stant(0)).      
-0000e380: 2020 7265 7475 726e 2073 656c 662e 6675    return self.fu
-0000e390: 6e63 2e5f 7072 6f64 7563 7428 290a 0a20  nc._product().. 
-0000e3a0: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
-0000e3b0: 0a20 2020 2064 6566 2065 7661 6c66 2861  .    def evalf(a
-0000e3c0: 7272 293a 0a20 2020 2020 2020 2072 6574  rr):.        ret
-0000e3d0: 7572 6e20 6e75 6d70 792e 7072 6f64 7563  urn numpy.produc
-0000e3e0: 7428 6172 722c 2061 7869 733d 2d31 290a  t(arr, axis=-1).
-0000e3f0: 0a20 2020 2064 6566 205f 6465 7269 7661  .    def _deriva
-0000e400: 7469 7665 2873 656c 662c 2076 6172 2c20  tive(self, var, 
-0000e410: 7365 656e 293a 0a20 2020 2020 2020 2067  seen):.        g
-0000e420: 7261 6420 3d20 6465 7269 7661 7469 7665  rad = derivative
-0000e430: 2873 656c 662e 6675 6e63 2c20 7661 722c  (self.func, var,
-0000e440: 2073 6565 6e29 0a20 2020 2020 2020 2066   seen).        f
-0000e450: 756e 6373 203d 2050 726f 6475 6374 2869  uncs = Product(i
-0000e460: 6e73 6572 7461 7869 7328 7365 6c66 2e66  nsertaxis(self.f
-0000e470: 756e 632c 202d 322c 2073 656c 662e 6675  unc, -2, self.fu
-0000e480: 6e63 2e73 6861 7065 5b2d 315d 2920 2b20  nc.shape[-1]) + 
-0000e490: 4469 6167 6f6e 616c 697a 6528 3120 2d20  Diagonalize(1 - 
-0000e4a0: 7365 6c66 2e66 756e 6329 2920 2023 2072  self.func))  # r
-0000e4b0: 6570 6c61 6365 2064 6961 676f 6e61 6c20  eplace diagonal 
-0000e4c0: 656e 7472 6965 7320 6279 2031 0a20 2020  entries by 1.   
-0000e4d0: 2020 2020 2072 6574 7572 6e20 6569 6e73       return eins
-0000e4e0: 756d 2827 4169 2c41 6942 2d3e 4142 272c  um('Ai,AiB->AB',
-0000e4f0: 2066 756e 6373 2c20 6772 6164 290a 0a20   funcs, grad).. 
-0000e500: 2020 2064 6566 205f 7461 6b65 2873 656c     def _take(sel
-0000e510: 662c 2069 6e64 6963 6573 2c20 6178 6973  f, indices, axis
-0000e520: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0000e530: 6e20 5072 6f64 7563 7428 5f74 616b 6528  n Product(_take(
-0000e540: 7365 6c66 2e66 756e 632c 2069 6e64 6963  self.func, indic
-0000e550: 6573 2c20 6178 6973 2929 0a0a 2020 2020  es, axis))..    
-0000e560: 6465 6620 5f74 616b 6564 6961 6728 7365  def _takediag(se
-0000e570: 6c66 2c20 6178 6973 312c 2061 7869 7332  lf, axis1, axis2
-0000e580: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0000e590: 6e20 7072 6f64 7563 7428 5f74 616b 6564  n product(_taked
-0000e5a0: 6961 6728 7365 6c66 2e66 756e 632c 2061  iag(self.func, a
-0000e5b0: 7869 7331 2c20 6178 6973 3229 2c20 7365  xis1, axis2), se
-0000e5c0: 6c66 2e6e 6469 6d2d 3229 0a0a 0a63 6c61  lf.ndim-2)...cla
-0000e5d0: 7373 2049 6e76 6572 7365 2841 7272 6179  ss Inverse(Array
-0000e5e0: 293a 0a20 2020 2027 2727 0a20 2020 204d  ):.    '''.    M
-0000e5f0: 6174 7269 7820 696e 7665 7273 6520 6f66  atrix inverse of
-0000e600: 2060 6066 756e 6360 6020 6f76 6572 2074   ``func`` over t
-0000e610: 6865 206c 6173 7420 7477 6f20 6178 6573  he last two axes
-0000e620: 2e20 2041 6c6c 206f 7468 6572 2061 7865  .  All other axe
-0000e630: 7320 6172 650a 2020 2020 7472 6561 7465  s are.    treate
-0000e640: 6420 656c 656d 656e 742d 7769 7365 2e0a  d element-wise..
-0000e650: 2020 2020 2727 270a 0a20 2020 2064 6566      '''..    def
-0000e660: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-0000e670: 6675 6e63 3a20 4172 7261 7929 3a0a 2020  func: Array):.  
-0000e680: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-0000e690: 6e73 7461 6e63 6528 6675 6e63 2c20 4172  nstance(func, Ar
-0000e6a0: 7261 7929 2061 6e64 2066 756e 632e 6e64  ray) and func.nd
-0000e6b0: 696d 203e 3d20 3220 616e 6420 5f65 7175  im >= 2 and _equ
-0000e6c0: 616c 735f 7369 6d70 6c69 6669 6564 2866  als_simplified(f
-0000e6d0: 756e 632e 7368 6170 655b 2d31 5d2c 2066  unc.shape[-1], f
-0000e6e0: 756e 632e 7368 6170 655b 2d32 5d29 2c20  unc.shape[-2]), 
-0000e6f0: 6627 6675 6e63 3d7b 6675 6e63 2172 7d27  f'func={func!r}'
-0000e700: 0a20 2020 2020 2020 2073 656c 662e 6675  .        self.fu
-0000e710: 6e63 203d 2066 756e 630a 2020 2020 2020  nc = func.      
-0000e720: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
-0000e730: 5f5f 2861 7267 733d 2866 756e 632c 292c  __(args=(func,),
-0000e740: 2073 6861 7065 3d66 756e 632e 7368 6170   shape=func.shap
-0000e750: 652c 2064 7479 7065 3d63 6f6d 706c 6578  e, dtype=complex
-0000e760: 2069 6620 6675 6e63 2e64 7479 7065 203d   if func.dtype =
-0000e770: 3d20 636f 6d70 6c65 7820 656c 7365 2066  = complex else f
-0000e780: 6c6f 6174 290a 0a20 2020 2064 6566 205f  loat)..    def _
-0000e790: 7369 6d70 6c69 6669 6564 2873 656c 6629  simplified(self)
-0000e7a0: 3a0a 2020 2020 2020 2020 7265 7375 6c74  :.        result
-0000e7b0: 203d 2073 656c 662e 6675 6e63 2e5f 696e   = self.func._in
-0000e7c0: 7665 7273 6528 7365 6c66 2e6e 6469 6d2d  verse(self.ndim-
-0000e7d0: 322c 2073 656c 662e 6e64 696d 2d31 290a  2, self.ndim-1).
-0000e7e0: 2020 2020 2020 2020 6966 2072 6573 756c          if resul
-0000e7f0: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
-0000e800: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000e810: 6e20 7265 7375 6c74 0a20 2020 2020 2020  n result.       
-0000e820: 2069 6620 5f65 7175 616c 735f 7363 616c   if _equals_scal
-0000e830: 6172 5f63 6f6e 7374 616e 7428 7365 6c66  ar_constant(self
-0000e840: 2e66 756e 632e 7368 6170 655b 2d31 5d2c  .func.shape[-1],
-0000e850: 2031 293a 0a20 2020 2020 2020 2020 2020   1):.           
-0000e860: 2072 6574 7572 6e20 7265 6369 7072 6f63   return reciproc
-0000e870: 616c 2873 656c 662e 6675 6e63 290a 0a20  al(self.func).. 
-0000e880: 2020 2065 7661 6c66 203d 2073 7461 7469     evalf = stati
-0000e890: 636d 6574 686f 6428 6e75 6d65 7269 632e  cmethod(numeric.
-0000e8a0: 696e 7629 0a0a 2020 2020 6465 6620 5f64  inv)..    def _d
-0000e8b0: 6572 6976 6174 6976 6528 7365 6c66 2c20  erivative(self, 
-0000e8c0: 7661 722c 2073 6565 6e29 3a0a 2020 2020  var, seen):.    
-0000e8d0: 2020 2020 7265 7475 726e 202d 6569 6e73      return -eins
-0000e8e0: 756d 2827 4169 6a2c 416a 6b42 2c41 6b6c  um('Aij,AjkB,Akl
-0000e8f0: 2d3e 4169 6c42 272c 2073 656c 662c 2064  ->AilB', self, d
-0000e900: 6572 6976 6174 6976 6528 7365 6c66 2e66  erivative(self.f
-0000e910: 756e 632c 2076 6172 2c20 7365 656e 292c  unc, var, seen),
-0000e920: 2073 656c 6629 0a0a 2020 2020 6465 6620   self)..    def 
-0000e930: 5f65 6967 2873 656c 662c 2073 796d 6d65  _eig(self, symme
-0000e940: 7472 6963 293a 0a20 2020 2020 2020 2065  tric):.        e
-0000e950: 6967 7661 6c2c 2065 6967 7665 6320 3d20  igval, eigvec = 
-0000e960: 4569 6728 7365 6c66 2e66 756e 632c 2073  Eig(self.func, s
-0000e970: 796d 6d65 7472 6963 290a 2020 2020 2020  ymmetric).      
-0000e980: 2020 7265 7475 726e 2054 7570 6c65 2828    return Tuple((
-0000e990: 7265 6369 7072 6f63 616c 2865 6967 7661  reciprocal(eigva
-0000e9a0: 6c29 2c20 6569 6776 6563 2929 0a0a 2020  l), eigvec))..  
-0000e9b0: 2020 6465 6620 5f64 6574 6572 6d69 6e61    def _determina
-0000e9c0: 6e74 2873 656c 662c 2061 7869 7331 2c20  nt(self, axis1, 
-0000e9d0: 6178 6973 3229 3a0a 2020 2020 2020 2020  axis2):.        
-0000e9e0: 6966 2073 6f72 7465 6428 5b61 7869 7331  if sorted([axis1
-0000e9f0: 2c20 6178 6973 325d 2920 3d3d 205b 7365  , axis2]) == [se
-0000ea00: 6c66 2e6e 6469 6d2d 322c 2073 656c 662e  lf.ndim-2, self.
-0000ea10: 6e64 696d 2d31 5d3a 0a20 2020 2020 2020  ndim-1]:.       
-0000ea20: 2020 2020 2072 6574 7572 6e20 7265 6369       return reci
-0000ea30: 7072 6f63 616c 2844 6574 6572 6d69 6e61  procal(Determina
-0000ea40: 6e74 2873 656c 662e 6675 6e63 2929 0a0a  nt(self.func))..
-0000ea50: 2020 2020 6465 6620 5f74 616b 6528 7365      def _take(se
-0000ea60: 6c66 2c20 696e 6469 6365 732c 2061 7869  lf, indices, axi
-0000ea70: 7329 3a0a 2020 2020 2020 2020 6966 2061  s):.        if a
-0000ea80: 7869 7320 3c20 7365 6c66 2e6e 6469 6d20  xis < self.ndim 
-0000ea90: 2d20 323a 0a20 2020 2020 2020 2020 2020  - 2:.           
-0000eaa0: 2072 6574 7572 6e20 496e 7665 7273 6528   return Inverse(
-0000eab0: 5f74 616b 6528 7365 6c66 2e66 756e 632c  _take(self.func,
-0000eac0: 2069 6e64 6963 6573 2c20 6178 6973 2929   indices, axis))
-0000ead0: 0a0a 2020 2020 6465 6620 5f74 616b 6564  ..    def _taked
-0000eae0: 6961 6728 7365 6c66 2c20 6178 6973 312c  iag(self, axis1,
-0000eaf0: 2061 7869 7332 293a 0a20 2020 2020 2020   axis2):.       
-0000eb00: 2061 7373 6572 7420 6178 6973 3120 3c20   assert axis1 < 
-0000eb10: 6178 6973 320a 2020 2020 2020 2020 6966  axis2.        if
-0000eb20: 2061 7869 7332 203c 2073 656c 662e 6e64   axis2 < self.nd
-0000eb30: 696d 2d32 3a0a 2020 2020 2020 2020 2020  im-2:.          
-0000eb40: 2020 7265 7475 726e 2069 6e76 6572 7365    return inverse
-0000eb50: 285f 7461 6b65 6469 6167 2873 656c 662e  (_takediag(self.
-0000eb60: 6675 6e63 2c20 6178 6973 312c 2061 7869  func, axis1, axi
-0000eb70: 7332 292c 2028 7365 6c66 2e6e 6469 6d2d  s2), (self.ndim-
-0000eb80: 342c 2073 656c 662e 6e64 696d 2d33 2929  4, self.ndim-3))
-0000eb90: 0a0a 2020 2020 6465 6620 5f75 6e72 6176  ..    def _unrav
-0000eba0: 656c 2873 656c 662c 2061 7869 732c 2073  el(self, axis, s
-0000ebb0: 6861 7065 293a 0a20 2020 2020 2020 2069  hape):.        i
-0000ebc0: 6620 6178 6973 203c 2073 656c 662e 6e64  f axis < self.nd
-0000ebd0: 696d 2d32 3a0a 2020 2020 2020 2020 2020  im-2:.          
-0000ebe0: 2020 7265 7475 726e 2049 6e76 6572 7365    return Inverse
-0000ebf0: 2875 6e72 6176 656c 2873 656c 662e 6675  (unravel(self.fu
-0000ec00: 6e63 2c20 6178 6973 2c20 7368 6170 6529  nc, axis, shape)
-0000ec10: 290a 0a0a 636c 6173 7320 4465 7465 726d  )...class Determ
-0000ec20: 696e 616e 7428 4172 7261 7929 3a0a 0a20  inant(Array):.. 
-0000ec30: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-0000ec40: 7365 6c66 2c20 6675 6e63 3a20 4172 7261  self, func: Arra
-0000ec50: 7929 3a0a 2020 2020 2020 2020 6173 7365  y):.        asse
-0000ec60: 7274 2069 7361 7272 6179 2866 756e 6329  rt isarray(func)
-0000ec70: 2061 6e64 2066 756e 632e 6e64 696d 203e   and func.ndim >
-0000ec80: 3d20 3220 616e 6420 5f65 7175 616c 735f  = 2 and _equals_
-0000ec90: 7369 6d70 6c69 6669 6564 2866 756e 632e  simplified(func.
-0000eca0: 7368 6170 655b 2d31 5d2c 2066 756e 632e  shape[-1], func.
-0000ecb0: 7368 6170 655b 2d32 5d29 0a20 2020 2020  shape[-2]).     
-0000ecc0: 2020 2073 656c 662e 6675 6e63 203d 2066     self.func = f
-0000ecd0: 756e 630a 2020 2020 2020 2020 7375 7065  unc.        supe
-0000ece0: 7228 292e 5f5f 696e 6974 5f5f 2861 7267  r().__init__(arg
-0000ecf0: 733d 2866 756e 632c 292c 2073 6861 7065  s=(func,), shape
-0000ed00: 3d66 756e 632e 7368 6170 655b 3a2d 325d  =func.shape[:-2]
-0000ed10: 2c20 6474 7970 653d 636f 6d70 6c65 7820  , dtype=complex 
-0000ed20: 6966 2066 756e 632e 6474 7970 6520 3d3d  if func.dtype ==
-0000ed30: 2063 6f6d 706c 6578 2065 6c73 6520 666c   complex else fl
-0000ed40: 6f61 7429 0a0a 2020 2020 6465 6620 5f73  oat)..    def _s
-0000ed50: 696d 706c 6966 6965 6428 7365 6c66 293a  implified(self):
-0000ed60: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
-0000ed70: 3d20 7365 6c66 2e66 756e 632e 5f64 6574  = self.func._det
-0000ed80: 6572 6d69 6e61 6e74 2873 656c 662e 6e64  erminant(self.nd
-0000ed90: 696d 2c20 7365 6c66 2e6e 6469 6d2b 3129  im, self.ndim+1)
-0000eda0: 0a20 2020 2020 2020 2069 6620 7265 7375  .        if resu
-0000edb0: 6c74 2069 7320 6e6f 7420 4e6f 6e65 3a0a  lt is not None:.
-0000edc0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000edd0: 726e 2072 6573 756c 740a 2020 2020 2020  rn result.      
-0000ede0: 2020 6966 205f 6571 7561 6c73 5f73 6361    if _equals_sca
-0000edf0: 6c61 725f 636f 6e73 7461 6e74 2873 656c  lar_constant(sel
-0000ee00: 662e 6675 6e63 2e73 6861 7065 5b2d 315d  f.func.shape[-1]
-0000ee10: 2c20 3129 3a0a 2020 2020 2020 2020 2020  , 1):.          
-0000ee20: 2020 7265 7475 726e 2054 616b 6528 5461    return Take(Ta
-0000ee30: 6b65 2873 656c 662e 6675 6e63 2c20 7a65  ke(self.func, ze
-0000ee40: 726f 7328 2829 2c20 696e 7429 292c 207a  ros((), int)), z
-0000ee50: 6572 6f73 2828 292c 2069 6e74 2929 0a0a  eros((), int))..
-0000ee60: 2020 2020 6576 616c 6620 3d20 7374 6174      evalf = stat
-0000ee70: 6963 6d65 7468 6f64 286e 756d 7079 2e6c  icmethod(numpy.l
-0000ee80: 696e 616c 672e 6465 7429 0a0a 2020 2020  inalg.det)..    
-0000ee90: 6465 6620 5f64 6572 6976 6174 6976 6528  def _derivative(
-0000eea0: 7365 6c66 2c20 7661 722c 2073 6565 6e29  self, var, seen)
-0000eeb0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000eec0: 2065 696e 7375 6d28 2741 2c41 6a69 2c41   einsum('A,Aji,A
-0000eed0: 696a 422d 3e41 4227 2c20 7365 6c66 2c20  ijB->AB', self, 
-0000eee0: 696e 7665 7273 6528 7365 6c66 2e66 756e  inverse(self.fun
-0000eef0: 6329 2c20 6465 7269 7661 7469 7665 2873  c), derivative(s
-0000ef00: 656c 662e 6675 6e63 2c20 7661 722c 2073  elf.func, var, s
-0000ef10: 6565 6e29 290a 0a20 2020 2064 6566 205f  een))..    def _
-0000ef20: 7461 6b65 2873 656c 662c 2069 6e64 6578  take(self, index
-0000ef30: 2c20 6178 6973 293a 0a20 2020 2020 2020  , axis):.       
-0000ef40: 2072 6574 7572 6e20 4465 7465 726d 696e   return Determin
-0000ef50: 616e 7428 5f74 616b 6528 7365 6c66 2e66  ant(_take(self.f
-0000ef60: 756e 632c 2069 6e64 6578 2c20 6178 6973  unc, index, axis
-0000ef70: 2929 0a0a 2020 2020 6465 6620 5f74 616b  ))..    def _tak
-0000ef80: 6564 6961 6728 7365 6c66 2c20 6178 6973  ediag(self, axis
-0000ef90: 312c 2061 7869 7332 293a 0a20 2020 2020  1, axis2):.     
-0000efa0: 2020 2072 6574 7572 6e20 6465 7465 726d     return determ
-0000efb0: 696e 616e 7428 5f74 616b 6564 6961 6728  inant(_takediag(
-0000efc0: 7365 6c66 2e66 756e 632c 2061 7869 7331  self.func, axis1
-0000efd0: 2c20 6178 6973 3229 2c20 2873 656c 662e  , axis2), (self.
-0000efe0: 6e64 696d 2d32 2c20 7365 6c66 2e6e 6469  ndim-2, self.ndi
-0000eff0: 6d2d 3129 290a 0a0a 636c 6173 7320 4d75  m-1))...class Mu
-0000f000: 6c74 6970 6c79 2841 7272 6179 293a 0a0a  ltiply(Array):..
-0000f010: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-0000f020: 2873 656c 662c 2066 756e 6373 3a20 7479  (self, funcs: ty
-0000f030: 7065 732e 6672 6f7a 656e 6d75 6c74 6973  pes.frozenmultis
-0000f040: 6574 293a 0a20 2020 2020 2020 2061 7373  et):.        ass
-0000f050: 6572 7420 6973 696e 7374 616e 6365 2866  ert isinstance(f
-0000f060: 756e 6373 2c20 7479 7065 732e 6672 6f7a  uncs, types.froz
-0000f070: 656e 6d75 6c74 6973 6574 292c 2066 2766  enmultiset), f'f
-0000f080: 756e 6373 3d7b 6675 6e63 7321 727d 270a  uncs={funcs!r}'.
-0000f090: 2020 2020 2020 2020 7365 6c66 2e66 756e          self.fun
-0000f0a0: 6373 203d 2066 756e 6373 0a20 2020 2020  cs = funcs.     
-0000f0b0: 2020 2066 756e 6331 2c20 6675 6e63 3220     func1, func2 
-0000f0c0: 3d20 6675 6e63 730a 2020 2020 2020 2020  = funcs.        
-0000f0d0: 6173 7365 7274 2065 7175 616c 7368 6170  assert equalshap
-0000f0e0: 6528 6675 6e63 312e 7368 6170 652c 2066  e(func1.shape, f
-0000f0f0: 756e 6332 2e73 6861 7065 2920 616e 6420  unc2.shape) and 
-0000f100: 6675 6e63 312e 6474 7970 6520 3d3d 2066  func1.dtype == f
-0000f110: 756e 6332 2e64 7479 7065 2021 3d20 626f  unc2.dtype != bo
-0000f120: 6f6c 2c20 274d 756c 7469 706c 7928 7b7d  ol, 'Multiply({}
-0000f130: 2c20 7b7d 2927 2e66 6f72 6d61 7428 6675  , {})'.format(fu
-0000f140: 6e63 312c 2066 756e 6332 290a 2020 2020  nc1, func2).    
-0000f150: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-0000f160: 6974 5f5f 2861 7267 733d 7475 706c 6528  it__(args=tuple(
-0000f170: 7365 6c66 2e66 756e 6373 292c 2073 6861  self.funcs), sha
-0000f180: 7065 3d66 756e 6331 2e73 6861 7065 2c20  pe=func1.shape, 
-0000f190: 6474 7970 653d 6675 6e63 312e 6474 7970  dtype=func1.dtyp
-0000f1a0: 6529 0a0a 2020 2020 4070 726f 7065 7274  e)..    @propert
-0000f1b0: 790a 2020 2020 6465 6620 5f66 6163 746f  y.    def _facto
-0000f1c0: 7273 2873 656c 6629 3a0a 2020 2020 2020  rs(self):.      
-0000f1d0: 2020 666f 7220 6675 6e63 2069 6e20 7365    for func in se
-0000f1e0: 6c66 2e66 756e 6373 3a0a 2020 2020 2020  lf.funcs:.      
-0000f1f0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0000f200: 6e63 6528 6675 6e63 2c20 4d75 6c74 6970  nce(func, Multip
-0000f210: 6c79 293a 0a20 2020 2020 2020 2020 2020  ly):.           
-0000f220: 2020 2020 2079 6965 6c64 2066 726f 6d20       yield from 
-0000f230: 6675 6e63 2e5f 6661 6374 6f72 730a 2020  func._factors.  
-0000f240: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f260: 7969 656c 6420 6675 6e63 0a0a 2020 2020  yield func..    
-0000f270: 6465 6620 5f73 696d 706c 6966 6965 6428  def _simplified(
-0000f280: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
-0000f290: 6163 746f 7273 203d 2074 7570 6c65 2873  actors = tuple(s
-0000f2a0: 656c 662e 5f66 6163 746f 7273 290a 2020  elf._factors).  
-0000f2b0: 2020 2020 2020 666f 7220 6a2c 2066 6a20        for j, fj 
-0000f2c0: 696e 2065 6e75 6d65 7261 7465 2866 6163  in enumerate(fac
-0000f2d0: 746f 7273 293a 0a20 2020 2020 2020 2020  tors):.         
-0000f2e0: 2020 2069 6620 666a 2e5f 636f 6e73 745f     if fj._const_
-0000f2f0: 756e 6966 6f72 6d20 3d3d 2031 3a0a 2020  uniform == 1:.  
-0000f300: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000f310: 7475 726e 206d 756c 7469 706c 7928 2a66  turn multiply(*f
-0000f320: 6163 746f 7273 5b3a 6a5d 2c20 2a66 6163  actors[:j], *fac
-0000f330: 746f 7273 5b6a 2b31 3a5d 290a 2020 2020  tors[j+1:]).    
-0000f340: 2020 2020 2020 2020 666f 7220 692c 2070          for i, p
-0000f350: 6172 7473 2069 6e20 666a 2e5f 696e 666c  arts in fj._infl
-0000f360: 6174 696f 6e73 3a0a 2020 2020 2020 2020  ations:.        
-0000f370: 2020 2020 2020 2020 7265 7475 726e 2075          return u
-0000f380: 7469 6c2e 7375 6d28 5f69 6e66 6c61 7465  til.sum(_inflate
-0000f390: 286d 756c 7469 706c 7928 662c 202a 285f  (multiply(f, *(_
-0000f3a0: 7461 6b65 2866 692c 2064 6f66 6d61 702c  take(fi, dofmap,
-0000f3b0: 2069 2920 666f 7220 6669 2069 6e20 6661   i) for fi in fa
-0000f3c0: 6374 6f72 735b 3a6a 5d20 2b20 6661 6374  ctors[:j] + fact
-0000f3d0: 6f72 735b 6a2b 313a 5d29 292c 2064 6f66  ors[j+1:])), dof
-0000f3e0: 6d61 702c 2073 656c 662e 7368 6170 655b  map, self.shape[
-0000f3f0: 695d 2c20 6929 2066 6f72 2064 6f66 6d61  i], i) for dofma
-0000f400: 702c 2066 2069 6e20 7061 7274 732e 6974  p, f in parts.it
-0000f410: 656d 7328 2929 0a20 2020 2020 2020 2020  ems()).         
-0000f420: 2020 2066 6f72 2061 7869 7331 2c20 6178     for axis1, ax
-0000f430: 6973 322c 202a 6f74 6865 7220 696e 206d  is2, *other in m
-0000f440: 6170 2873 6f72 7465 642c 2066 6a2e 5f64  ap(sorted, fj._d
-0000f450: 6961 676f 6e61 6c73 293a 0a20 2020 2020  iagonals):.     
-0000f460: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000f470: 6e20 6469 6167 6f6e 616c 697a 6528 6d75  n diagonalize(mu
-0000f480: 6c74 6970 6c79 282a 2874 616b 6564 6961  ltiply(*(takedia
-0000f490: 6728 662c 2061 7869 7331 2c20 6178 6973  g(f, axis1, axis
-0000f4a0: 3229 2066 6f72 2066 2069 6e20 6661 6374  2) for f in fact
-0000f4b0: 6f72 7329 292c 2061 7869 7331 2c20 6178  ors)), axis1, ax
-0000f4c0: 6973 3229 0a20 2020 2020 2020 2020 2020  is2).           
-0000f4d0: 2066 6f72 2069 2c20 6669 2069 6e20 656e   for i, fi in en
-0000f4e0: 756d 6572 6174 6528 6661 6374 6f72 735b  umerate(factors[
-0000f4f0: 3a6a 5d29 3a0a 2020 2020 2020 2020 2020  :j]):.          
-0000f500: 2020 2020 2020 756e 616c 6967 6e65 6431        unaligned1
-0000f510: 2c20 756e 616c 6967 6e65 6432 2c20 7768  , unaligned2, wh
-0000f520: 6572 6520 3d20 756e 616c 6967 6e28 6669  ere = unalign(fi
-0000f530: 2c20 666a 290a 2020 2020 2020 2020 2020  , fj).          
-0000f540: 2020 2020 2020 6669 6a20 3d20 616c 6967        fij = alig
-0000f550: 6e28 756e 616c 6967 6e65 6431 202a 2075  n(unaligned1 * u
-0000f560: 6e61 6c69 676e 6564 322c 2077 6865 7265  naligned2, where
-0000f570: 2c20 7365 6c66 2e73 6861 7065 2920 6966  , self.shape) if
-0000f580: 206c 656e 2877 6865 7265 2920 213d 2073   len(where) != s
-0000f590: 656c 662e 6e64 696d 205c 0a20 2020 2020  elf.ndim \.     
-0000f5a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000f5b0: 6c73 6520 6669 2e5f 6d75 6c74 6970 6c79  lse fi._multiply
-0000f5c0: 2866 6a29 206f 7220 666a 2e5f 6d75 6c74  (fj) or fj._mult
-0000f5d0: 6970 6c79 2866 6929 0a20 2020 2020 2020  iply(fi).       
-0000f5e0: 2020 2020 2020 2020 2069 6620 6669 6a3a           if fij:
-0000f5f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f600: 2020 2020 2072 6574 7572 6e20 6d75 6c74       return mult
-0000f610: 6970 6c79 282a 6661 6374 6f72 735b 3a69  iply(*factors[:i
-0000f620: 5d2c 202a 6661 6374 6f72 735b 692b 313a  ], *factors[i+1:
-0000f630: 6a5d 2c20 2a66 6163 746f 7273 5b6a 2b31  j], *factors[j+1
-0000f640: 3a5d 2c20 6669 6a29 0a0a 2020 2020 6465  :], fij)..    de
-0000f650: 6620 5f6f 7074 696d 697a 6564 5f66 6f72  f _optimized_for
-0000f660: 5f6e 756d 7079 2873 656c 6629 3a0a 2020  _numpy(self):.  
-0000f670: 2020 2020 2020 6661 6374 6f72 7320 3d20        factors = 
-0000f680: 7475 706c 6528 7365 6c66 2e5f 6661 6374  tuple(self._fact
-0000f690: 6f72 7329 0a20 2020 2020 2020 2066 6f72  ors).        for
-0000f6a0: 2069 2c20 6669 2069 6e20 656e 756d 6572   i, fi in enumer
-0000f6b0: 6174 6528 6661 6374 6f72 7329 3a0a 2020  ate(factors):.  
-0000f6c0: 2020 2020 2020 2020 2020 6966 2066 692e            if fi.
-0000f6d0: 6474 7970 6520 213d 2062 6f6f 6c20 616e  dtype != bool an
-0000f6e0: 6420 6669 2e5f 636f 6e73 745f 756e 6966  d fi._const_unif
-0000f6f0: 6f72 6d20 3d3d 202d 313a 0a20 2020 2020  orm == -1:.     
-0000f700: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000f710: 6e20 4e65 6761 7469 7665 286d 756c 7469  n Negative(multi
-0000f720: 706c 7928 2a66 6163 746f 7273 5b3a 695d  ply(*factors[:i]
-0000f730: 2c20 2a66 6163 746f 7273 5b69 2b31 3a5d  , *factors[i+1:]
-0000f740: 2929 0a20 2020 2020 2020 2020 2020 2069  )).            i
-0000f750: 6620 6669 2e64 7479 7065 2021 3d20 636f  f fi.dtype != co
-0000f760: 6d70 6c65 7820 616e 6420 5369 676e 2866  mplex and Sign(f
-0000f770: 6929 2069 6e20 6661 6374 6f72 733a 0a20  i) in factors:. 
-0000f780: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000f790: 2c20 6a20 3d20 736f 7274 6564 285b 692c  , j = sorted([i,
-0000f7a0: 2066 6163 746f 7273 2e69 6e64 6578 2853   factors.index(S
-0000f7b0: 6967 6e28 6669 2929 5d29 0a20 2020 2020  ign(fi))]).     
-0000f7c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000f7d0: 6e20 6d75 6c74 6970 6c79 282a 6661 6374  n multiply(*fact
-0000f7e0: 6f72 735b 3a69 5d2c 202a 6661 6374 6f72  ors[:i], *factor
-0000f7f0: 735b 692b 313a 6a5d 2c20 2a66 6163 746f  s[i+1:j], *facto
-0000f800: 7273 5b6a 2b31 3a5d 2c20 4162 736f 6c75  rs[j+1:], Absolu
-0000f810: 7465 2866 6929 290a 2020 2020 2020 2020  te(fi)).        
-0000f820: 6966 2073 656c 662e 6e64 696d 3a0a 2020  if self.ndim:.  
-0000f830: 2020 2020 2020 2020 2020 6172 6773 2c20            args, 
-0000f840: 6172 6773 5f69 6478 203d 207a 6970 282a  args_idx = zip(*
-0000f850: 6d61 7028 756e 616c 6967 6e2c 2066 6163  map(unalign, fac
-0000f860: 746f 7273 2929 0a20 2020 2020 2020 2020  tors)).         
-0000f870: 2020 2072 6574 7572 6e20 4569 6e73 756d     return Einsum
-0000f880: 2861 7267 732c 2061 7267 735f 6964 782c  (args, args_idx,
-0000f890: 2074 7570 6c65 2872 616e 6765 2873 656c   tuple(range(sel
-0000f8a0: 662e 6e64 696d 2929 290a 0a20 2020 2065  f.ndim)))..    e
-0000f8b0: 7661 6c66 203d 2073 7461 7469 636d 6574  valf = staticmet
-0000f8c0: 686f 6428 6e75 6d70 792e 6d75 6c74 6970  hod(numpy.multip
-0000f8d0: 6c79 290a 0a20 2020 2064 6566 205f 7375  ly)..    def _su
-0000f8e0: 6d28 7365 6c66 2c20 6178 6973 293a 0a20  m(self, axis):. 
-0000f8f0: 2020 2020 2020 2066 6163 746f 7273 203d         factors =
-0000f900: 2074 7570 6c65 2873 656c 662e 5f66 6163   tuple(self._fac
-0000f910: 746f 7273 290a 2020 2020 2020 2020 666f  tors).        fo
-0000f920: 7220 692c 2066 6920 696e 2065 6e75 6d65  r i, fi in enume
-0000f930: 7261 7465 2866 6163 746f 7273 293a 0a20  rate(factors):. 
-0000f940: 2020 2020 2020 2020 2020 2075 6e61 6c69             unali
-0000f950: 676e 6564 2c20 7768 6572 6520 3d20 756e  gned, where = un
-0000f960: 616c 6967 6e28 6669 290a 2020 2020 2020  align(fi).      
-0000f970: 2020 2020 2020 6966 2061 7869 7320 6e6f        if axis no
-0000f980: 7420 696e 2077 6865 7265 3a0a 2020 2020  t in where:.    
-0000f990: 2020 2020 2020 2020 2020 2020 7375 6d6d              summ
-0000f9a0: 6564 203d 2073 756d 286d 756c 7469 706c  ed = sum(multipl
-0000f9b0: 7928 2a66 6163 746f 7273 5b3a 695d 2c20  y(*factors[:i], 
-0000f9c0: 2a66 6163 746f 7273 5b69 2b31 3a5d 292c  *factors[i+1:]),
-0000f9d0: 2061 7869 7329 0a20 2020 2020 2020 2020   axis).         
-0000f9e0: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
-0000f9f0: 6d6d 6564 202a 2061 6c69 676e 2875 6e61  mmed * align(una
-0000fa00: 6c69 676e 6564 2c20 5b69 2d28 6920 3e20  ligned, [i-(i > 
-0000fa10: 6178 6973 2920 666f 7220 6920 696e 2077  axis) for i in w
-0000fa20: 6865 7265 5d2c 2073 756d 6d65 642e 7368  here], summed.sh
-0000fa30: 6170 6529 0a0a 2020 2020 6465 6620 5f61  ape)..    def _a
-0000fa40: 6464 2873 656c 662c 206f 7468 6572 293a  dd(self, other):
-0000fa50: 0a20 2020 2020 2020 2066 6163 746f 7273  .        factors
-0000fa60: 203d 206c 6973 7428 7365 6c66 2e5f 6661   = list(self._fa
-0000fa70: 6374 6f72 7329 0a20 2020 2020 2020 206f  ctors).        o
-0000fa80: 7468 6572 5f66 6163 746f 7273 203d 205b  ther_factors = [
-0000fa90: 5d0a 2020 2020 2020 2020 636f 6d6d 6f6e  ].        common
-0000faa0: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
-0000fab0: 7220 6620 696e 206f 7468 6572 2e5f 6661  r f in other._fa
-0000fac0: 6374 6f72 7320 6966 2069 7369 6e73 7461  ctors if isinsta
-0000fad0: 6e63 6528 6f74 6865 722c 204d 756c 7469  nce(other, Multi
-0000fae0: 706c 7929 2065 6c73 6520 5b6f 7468 6572  ply) else [other
-0000faf0: 5d3a 0a20 2020 2020 2020 2020 2020 2069  ]:.            i
-0000fb00: 6620 6620 696e 2066 6163 746f 7273 3a0a  f f in factors:.
-0000fb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb20: 6661 6374 6f72 732e 7265 6d6f 7665 2866  factors.remove(f
-0000fb30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000fb40: 2020 636f 6d6d 6f6e 2e61 7070 656e 6428    common.append(
-0000fb50: 6629 0a20 2020 2020 2020 2020 2020 2065  f).            e
-0000fb60: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000fb70: 2020 2020 206f 7468 6572 5f66 6163 746f       other_facto
-0000fb80: 7273 2e61 7070 656e 6428 6629 0a20 2020  rs.append(f).   
-0000fb90: 2020 2020 2069 6620 6e6f 7420 636f 6d6d       if not comm
-0000fba0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-0000fbb0: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
-0000fbc0: 6620 6661 6374 6f72 7320 616e 6420 6f74  f factors and ot
-0000fbd0: 6865 725f 6661 6374 6f72 733a 0a20 2020  her_factors:.   
-0000fbe0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000fbf0: 6d75 6c74 6970 6c79 282a 636f 6d6d 6f6e  multiply(*common
-0000fc00: 2920 2a20 6164 6428 6d75 6c74 6970 6c79  ) * add(multiply
-0000fc10: 282a 6661 6374 6f72 7329 2c20 6d75 6c74  (*factors), mult
-0000fc20: 6970 6c79 282a 6f74 6865 725f 6661 6374  iply(*other_fact
-0000fc30: 6f72 7329 290a 2020 2020 2020 2020 6e7a  ors)).        nz
-0000fc40: 203d 2066 6163 746f 7273 206f 7220 6f74   = factors or ot
-0000fc50: 6865 725f 6661 6374 6f72 730a 2020 2020  her_factors.    
-0000fc60: 2020 2020 6966 206e 6f74 206e 7a3a 2023      if not nz: #
-0000fc70: 2073 656c 6620 6571 7561 6c73 206f 7468   self equals oth
-0000fc80: 6572 2028 7570 2074 6f20 6661 6374 6f72  er (up to factor
-0000fc90: 206f 7264 6572 696e 6729 0a20 2020 2020   ordering).     
-0000fca0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0000fcb0: 6c66 202a 2032 0a20 2020 2020 2020 2069  lf * 2.        i
-0000fcc0: 6620 6c65 6e28 6e7a 2920 3d3d 2031 2061  f len(nz) == 1 a
-0000fcd0: 6e64 2074 7570 6c65 286e 7a29 5b30 5d2e  nd tuple(nz)[0].
-0000fce0: 5f63 6f6e 7374 5f75 6e69 666f 726d 203d  _const_uniform =
-0000fcf0: 3d20 2d31 3a0a 2020 2020 2020 2020 2020  = -1:.          
-0000fd00: 2020 2320 5369 6e63 6520 7468 6520 7375    # Since the su
-0000fd10: 6274 7261 6374 696f 6e20 7820 2d20 7920  btraction x - y 
-0000fd20: 6973 2073 746f 7265 6420 6173 2078 202b  is stored as x +
-0000fd30: 202d 3120 2a20 792c 2074 6869 7320 6861   -1 * y, this ha
-0000fd40: 6e64 6c65 730a 2020 2020 2020 2020 2020  ndles.          
-0000fd50: 2020 2320 7468 6520 7369 6d70 6c69 6669    # the simplifi
-0000fd60: 6361 7469 6f6e 206f 6620 7820 2d20 7820  cation of x - x 
-0000fd70: 746f 2030 2e20 5768 696c 6520 7765 2063  to 0. While we c
-0000fd80: 6f75 6c64 2061 6c74 6572 6e61 7469 7665  ould alternative
-0000fd90: 6c79 0a20 2020 2020 2020 2020 2020 2023  ly.            #
-0000fda0: 2073 696d 706c 6966 7920 616c 6c20 7820   simplify all x 
-0000fdb0: 2b20 6120 2a20 7820 746f 2028 6120 2b20  + a * x to (a + 
-0000fdc0: 3129 202a 2078 2c20 6361 7074 7572 696e  1) * x, capturin
-0000fdd0: 6720 6120 3d3d 202d 3120 6173 2061 0a20  g a == -1 as a. 
-0000fde0: 2020 2020 2020 2020 2020 2023 2073 7065             # spe
-0000fdf0: 6369 616c 2063 6173 6520 7669 6120 436f  cial case via Co
-0000fe00: 6e73 7461 6e74 2e5f 6164 642c 2069 7420  nstant._add, it 
-0000fe10: 6973 206e 6f74 206f 6276 696f 7573 2074  is not obvious t
-0000fe20: 6861 7420 7468 6973 2069 7320 696e 0a20  hat this is in. 
-0000fe30: 2020 2020 2020 2020 2020 2023 2061 6c6c             # all
-0000fe40: 2073 6974 7561 7469 6f6e 7320 616e 2069   situations an i
-0000fe50: 6d70 726f 7665 6d65 6e74 2e0a 2020 2020  mprovement..    
-0000fe60: 2020 2020 2020 2020 7265 7475 726e 207a          return z
-0000fe70: 6572 6f73 5f6c 696b 6528 7365 6c66 290a  eros_like(self).
-0000fe80: 0a20 2020 2064 6566 205f 6465 7465 726d  .    def _determ
-0000fe90: 696e 616e 7428 7365 6c66 2c20 6178 6973  inant(self, axis
-0000fea0: 312c 2061 7869 7332 293a 0a20 2020 2020  1, axis2):.     
-0000feb0: 2020 2061 7869 7331 2c20 6178 6973 3220     axis1, axis2 
-0000fec0: 3d20 736f 7274 6564 285b 6178 6973 312c  = sorted([axis1,
-0000fed0: 2061 7869 7332 5d29 0a20 2020 2020 2020   axis2]).       
-0000fee0: 2066 6163 746f 7273 203d 2074 7570 6c65   factors = tuple
-0000fef0: 2873 656c 662e 5f66 6163 746f 7273 290a  (self._factors).
-0000ff00: 2020 2020 2020 2020 6966 2061 6c6c 285f          if all(_
-0000ff10: 6571 7561 6c73 5f73 6361 6c61 725f 636f  equals_scalar_co
-0000ff20: 6e73 7461 6e74 2873 656c 662e 7368 6170  nstant(self.shap
-0000ff30: 655b 6178 6973 5d2c 2031 2920 666f 7220  e[axis], 1) for 
-0000ff40: 6178 6973 2069 6e20 2861 7869 7331 2c20  axis in (axis1, 
-0000ff50: 6178 6973 3229 293a 0a20 2020 2020 2020  axis2)):.       
-0000ff60: 2020 2020 2072 6574 7572 6e20 6d75 6c74       return mult
-0000ff70: 6970 6c79 282a 5b64 6574 6572 6d69 6e61  iply(*[determina
-0000ff80: 6e74 2866 2c20 2861 7869 7331 2c20 6178  nt(f, (axis1, ax
-0000ff90: 6973 3229 2920 666f 7220 6620 696e 2066  is2)) for f in f
-0000ffa0: 6163 746f 7273 5d29 0a20 2020 2020 2020  actors]).       
-0000ffb0: 2066 6f72 2069 2c20 6669 2069 6e20 656e   for i, fi in en
-0000ffc0: 756d 6572 6174 6528 6661 6374 6f72 7329  umerate(factors)
-0000ffd0: 3a0a 2020 2020 2020 2020 2020 2020 756e  :.            un
-0000ffe0: 616c 6967 6e65 642c 2077 6865 7265 203d  aligned, where =
-0000fff0: 2075 6e61 6c69 676e 2866 6929 0a20 2020   unalign(fi).   
-00010000: 2020 2020 2020 2020 2069 6620 6178 6973           if axis
-00010010: 3120 6e6f 7420 696e 2077 6865 7265 2061  1 not in where a
-00010020: 6e64 2061 7869 7332 206e 6f74 2069 6e20  nd axis2 not in 
-00010030: 7768 6572 653a 0a20 2020 2020 2020 2020  where:.         
-00010040: 2020 2020 2020 2064 6574 203d 2064 6574         det = det
-00010050: 6572 6d69 6e61 6e74 286d 756c 7469 706c  erminant(multipl
-00010060: 7928 2a66 6163 746f 7273 5b3a 695d 2c20  y(*factors[:i], 
-00010070: 2a66 6163 746f 7273 5b69 2b31 3a5d 292c  *factors[i+1:]),
-00010080: 2028 6178 6973 312c 2061 7869 7332 2929   (axis1, axis2))
-00010090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000100a0: 2073 6361 6c65 203d 2061 6c69 676e 2875   scale = align(u
-000100b0: 6e61 6c69 676e 6564 2a2a 7365 6c66 2e73  naligned**self.s
-000100c0: 6861 7065 5b61 7869 7331 5d2c 205b 692d  hape[axis1], [i-
-000100d0: 2869 203e 2061 7869 7331 292d 2869 203e  (i > axis1)-(i >
-000100e0: 2061 7869 7332 2920 666f 7220 6920 696e   axis2) for i in
-000100f0: 2077 6865 7265 2069 6620 6920 6e6f 7420   where if i not 
-00010100: 696e 2028 6178 6973 312c 2061 7869 7332  in (axis1, axis2
-00010110: 295d 2c20 6465 742e 7368 6170 6529 0a20  )], det.shape). 
-00010120: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00010130: 6574 7572 6e20 6465 7420 2a20 7363 616c  eturn det * scal
-00010140: 650a 0a20 2020 2064 6566 205f 7072 6f64  e..    def _prod
-00010150: 7563 7428 7365 6c66 293a 0a20 2020 2020  uct(self):.     
-00010160: 2020 2072 6574 7572 6e20 6d75 6c74 6970     return multip
-00010170: 6c79 282a 5b50 726f 6475 6374 2866 2920  ly(*[Product(f) 
-00010180: 666f 7220 6620 696e 2073 656c 662e 5f66  for f in self._f
-00010190: 6163 746f 7273 5d29 0a0a 2020 2020 6465  actors])..    de
-000101a0: 6620 5f64 6572 6976 6174 6976 6528 7365  f _derivative(se
-000101b0: 6c66 2c20 7661 722c 2073 6565 6e29 3a0a  lf, var, seen):.
-000101c0: 2020 2020 2020 2020 6675 6e63 312c 2066          func1, f
-000101d0: 756e 6332 203d 2073 656c 662e 6675 6e63  unc2 = self.func
-000101e0: 730a 2020 2020 2020 2020 7265 7475 726e  s.        return
-000101f0: 2065 696e 7375 6d28 2741 2c41 422d 3e41   einsum('A,AB->A
-00010200: 4227 2c20 6675 6e63 312c 2064 6572 6976  B', func1, deriv
-00010210: 6174 6976 6528 6675 6e63 322c 2076 6172  ative(func2, var
-00010220: 2c20 7365 656e 2929 205c 0a20 2020 2020  , seen)) \.     
-00010230: 2020 2020 2020 202b 2065 696e 7375 6d28         + einsum(
-00010240: 2741 2c41 422d 3e41 4227 2c20 6675 6e63  'A,AB->AB', func
-00010250: 322c 2064 6572 6976 6174 6976 6528 6675  2, derivative(fu
-00010260: 6e63 312c 2076 6172 2c20 7365 656e 2929  nc1, var, seen))
-00010270: 0a0a 2020 2020 6465 6620 5f74 616b 6564  ..    def _taked
-00010280: 6961 6728 7365 6c66 2c20 6178 6973 312c  iag(self, axis1,
-00010290: 2061 7869 7332 293a 0a20 2020 2020 2020   axis2):.       
-000102a0: 2072 6574 7572 6e20 6d75 6c74 6970 6c79   return multiply
-000102b0: 282a 5b5f 7461 6b65 6469 6167 2866 2c20  (*[_takediag(f, 
-000102c0: 6178 6973 312c 2061 7869 7332 2920 666f  axis1, axis2) fo
-000102d0: 7220 6620 696e 2073 656c 662e 5f66 6163  r f in self._fac
-000102e0: 746f 7273 5d29 0a0a 2020 2020 6465 6620  tors])..    def 
-000102f0: 5f74 616b 6528 7365 6c66 2c20 696e 6465  _take(self, inde
-00010300: 782c 2061 7869 7329 3a0a 2020 2020 2020  x, axis):.      
-00010310: 2020 7265 7475 726e 206d 756c 7469 706c    return multipl
-00010320: 7928 2a5b 5f74 616b 6528 662c 2069 6e64  y(*[_take(f, ind
-00010330: 6578 2c20 6178 6973 2920 666f 7220 6620  ex, axis) for f 
-00010340: 696e 2073 656c 662e 5f66 6163 746f 7273  in self._factors
-00010350: 5d29 0a0a 2020 2020 6465 6620 5f73 6967  ])..    def _sig
-00010360: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-00010370: 2072 6574 7572 6e20 6d75 6c74 6970 6c79   return multiply
-00010380: 282a 5b53 6967 6e28 6629 2066 6f72 2066  (*[Sign(f) for f
-00010390: 2069 6e20 7365 6c66 2e5f 6661 6374 6f72   in self._factor
-000103a0: 735d 290a 0a20 2020 2064 6566 205f 756e  s])..    def _un
-000103b0: 7261 7665 6c28 7365 6c66 2c20 6178 6973  ravel(self, axis
-000103c0: 2c20 7368 6170 6529 3a0a 2020 2020 2020  , shape):.      
-000103d0: 2020 7265 7475 726e 206d 756c 7469 706c    return multipl
-000103e0: 7928 2a5b 756e 7261 7665 6c28 662c 2061  y(*[unravel(f, a
-000103f0: 7869 732c 2073 6861 7065 2920 666f 7220  xis, shape) for 
-00010400: 6620 696e 2073 656c 662e 5f66 6163 746f  f in self._facto
-00010410: 7273 5d29 0a0a 2020 2020 6465 6620 5f69  rs])..    def _i
-00010420: 6e76 6572 7365 2873 656c 662c 2061 7869  nverse(self, axi
-00010430: 7331 2c20 6178 6973 3229 3a0a 2020 2020  s1, axis2):.    
-00010440: 2020 2020 6661 6374 6f72 7320 3d20 7475      factors = tu
-00010450: 706c 6528 7365 6c66 2e5f 6661 6374 6f72  ple(self._factor
-00010460: 7329 0a20 2020 2020 2020 2066 6f72 2069  s).        for i
-00010470: 2c20 6669 2069 6e20 656e 756d 6572 6174  , fi in enumerat
-00010480: 6528 6661 6374 6f72 7329 3a0a 2020 2020  e(factors):.    
-00010490: 2020 2020 2020 2020 6966 2073 6574 2875          if set(u
-000104a0: 6e61 6c69 676e 2866 6929 5b31 5d29 2e69  nalign(fi)[1]).i
-000104b0: 7364 6973 6a6f 696e 7428 2861 7869 7331  sdisjoint((axis1
-000104c0: 2c20 6178 6973 3229 293a 0a20 2020 2020  , axis2)):.     
-000104d0: 2020 2020 2020 2020 2020 2069 6e76 203d             inv =
-000104e0: 2069 6e76 6572 7365 286d 756c 7469 706c   inverse(multipl
-000104f0: 7928 2a66 6163 746f 7273 5b3a 695d 2c20  y(*factors[:i], 
-00010500: 2a66 6163 746f 7273 5b69 2b31 3a5d 292c  *factors[i+1:]),
-00010510: 2028 6178 6973 312c 2061 7869 7332 2929   (axis1, axis2))
-00010520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010530: 2072 6574 7572 6e20 6469 7669 6465 2869   return divide(i
-00010540: 6e76 2c20 6669 290a 0a20 2020 2040 6361  nv, fi)..    @ca
-00010550: 6368 6564 5f70 726f 7065 7274 790a 2020  ched_property.  
-00010560: 2020 6465 6620 5f61 7373 7061 7273 6528    def _assparse(
-00010570: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
-00010580: 2046 6972 7374 2077 6520 636f 6c6c 6563   First we collec
-00010590: 7420 7468 6520 636c 7573 7465 7273 206f  t the clusters o
-000105a0: 6620 6661 6374 6f72 7320 7468 6174 2068  f factors that h
-000105b0: 6176 6520 6e6f 2072 6561 6c20 2869 2e65  ave no real (i.e
-000105c0: 2e20 6e6f 740a 2020 2020 2020 2020 2320  . not.        # 
-000105d0: 696e 7365 7274 6564 2920 6178 6573 2069  inserted) axes i
-000105e0: 6e20 636f 6d6d 6f6e 2077 6974 6820 7468  n common with th
-000105f0: 6520 6f74 6865 7220 636c 7573 7465 7273  e other clusters
-00010600: 2c20 616e 6420 7374 6f72 6520 7468 656d  , and store them
-00010610: 2069 6e0a 2020 2020 2020 2020 2320 756e   in.        # un
-00010620: 696e 7365 7274 6564 2066 6f72 6d2e 0a20  inserted form.. 
-00010630: 2020 2020 2020 2063 6c75 7374 6572 7320         clusters 
-00010640: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-00010650: 2066 2069 6e20 7365 6c66 2e5f 6661 6374   f in self._fact
-00010660: 6f72 733a 0a20 2020 2020 2020 2020 2020  ors:.           
-00010670: 2075 6e69 6e73 6572 7465 642c 2077 6865   uninserted, whe
-00010680: 7265 203d 2075 6e61 6c69 676e 2866 290a  re = unalign(f).
-00010690: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000106a0: 6920 696e 2072 6576 6572 7365 6428 7261  i in reversed(ra
-000106b0: 6e67 6528 6c65 6e28 636c 7573 7465 7273  nge(len(clusters
-000106c0: 2929 293a 0a20 2020 2020 2020 2020 2020  ))):.           
-000106d0: 2020 2020 2069 6620 7365 7428 7768 6572       if set(wher
-000106e0: 6529 2026 2073 6574 2863 6c75 7374 6572  e) & set(cluster
-000106f0: 735b 695d 5b31 5d29 3a0a 2020 2020 2020  s[i][1]):.      
-00010700: 2020 2020 2020 2020 2020 2020 2020 7720                w 
-00010710: 3d20 7768 6572 650a 2020 2020 2020 2020  = where.        
-00010720: 2020 2020 2020 2020 2020 2020 756e 696e              unin
-00010730: 735f 2c20 775f 203d 2063 6c75 7374 6572  s_, w_ = cluster
-00010740: 732e 706f 7028 6929 0a20 2020 2020 2020  s.pop(i).       
-00010750: 2020 2020 2020 2020 2020 2020 2077 6865               whe
-00010760: 7265 203d 206e 756d 7079 2e75 6e69 6f6e  re = numpy.union
-00010770: 3164 2877 2c20 775f 290a 2020 2020 2020  1d(w, w_).      
-00010780: 2020 2020 2020 2020 2020 2020 2020 7368                sh
-00010790: 6170 6520 3d20 7475 706c 6528 7365 6c66  ape = tuple(self
-000107a0: 2e73 6861 7065 5b69 5d20 666f 7220 6920  .shape[i] for i 
-000107b0: 696e 2077 6865 7265 290a 2020 2020 2020  in where).      
-000107c0: 2020 2020 2020 2020 2020 2020 2020 756e                un
-000107d0: 696e 7365 7274 6564 203d 2061 6c69 676e  inserted = align
-000107e0: 2875 6e69 6e73 6572 7465 642c 206e 756d  (uninserted, num
-000107f0: 7079 2e73 6561 7263 6873 6f72 7465 6428  py.searchsorted(
-00010800: 7768 6572 652c 2077 292c 2073 6861 7065  where, w), shape
-00010810: 2920 2a20 616c 6967 6e28 756e 696e 735f  ) * align(unins_
-00010820: 2c20 6e75 6d70 792e 7365 6172 6368 736f  , numpy.searchso
-00010830: 7274 6564 2877 6865 7265 2c20 775f 292c  rted(where, w_),
-00010840: 2073 6861 7065 290a 2020 2020 2020 2020   shape).        
-00010850: 2020 2020 636c 7573 7465 7273 2e61 7070      clusters.app
-00010860: 656e 6428 2875 6e69 6e73 6572 7465 642c  end((uninserted,
-00010870: 2077 6865 7265 2929 0a20 2020 2020 2020   where)).       
-00010880: 2023 2049 6620 7468 6572 6520 6973 206f   # If there is o
-00010890: 6e6c 7920 6f6e 6520 636c 7573 7465 7220  nly one cluster 
-000108a0: 7765 2066 616c 6c20 6261 636b 206f 6e20  we fall back on 
-000108b0: 7468 6520 6465 6661 756c 740a 2020 2020  the default.    
-000108c0: 2020 2020 2320 696d 706c 656d 656e 7461      # implementa
-000108d0: 7469 6f6e 2e0a 2020 2020 2020 2020 6966  tion..        if
-000108e0: 206c 656e 2863 6c75 7374 6572 7329 203d   len(clusters) =
-000108f0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-00010900: 2072 6574 7572 6e20 7375 7065 7228 292e   return super().
-00010910: 5f61 7373 7061 7273 650a 2020 2020 2020  _assparse.      
-00010920: 2020 2320 4966 2074 6865 7265 2061 7265    # If there are
-00010930: 2074 776f 206f 7220 6d6f 7265 2063 6c75   two or more clu
-00010940: 7374 6572 7320 7765 2077 7269 7465 2074  sters we write t
-00010950: 6865 2070 726f 6475 6374 206f 6620 6164  he product of ad
-00010960: 6469 7469 6f6e 730a 2020 2020 2020 2020  ditions.        
-00010970: 2320 6173 2061 6e20 6164 6469 7469 6f6e  # as an addition
-00010980: 206f 6620 7072 6f64 7563 7473 2e0a 2020   of products..  
-00010990: 2020 2020 2020 756e 696e 7365 7274 6564        uninserted
-000109a0: 732c 2077 6865 7265 7320 3d20 7a69 7028  s, wheres = zip(
-000109b0: 2a63 6c75 7374 6572 7329 0a20 2020 2020  *clusters).     
-000109c0: 2020 2073 7061 7273 6520 3d20 5b5d 0a20     sparse = []. 
-000109d0: 2020 2020 2020 2066 6f72 2069 7465 6d73         for items
-000109e0: 2069 6e20 6974 6572 746f 6f6c 732e 7072   in itertools.pr
-000109f0: 6f64 7563 7428 2a5b 752e 5f61 7373 7061  oduct(*[u._asspa
-00010a00: 7273 6520 666f 7220 7520 696e 2075 6e69  rse for u in uni
-00010a10: 6e73 6572 7465 6473 5d29 3a0a 2020 2020  nserteds]):.    
-00010a20: 2020 2020 2020 2020 7368 6170 6520 3d20          shape = 
-00010a30: 7574 696c 2e73 756d 2866 2e73 6861 7065  util.sum(f.shape
-00010a40: 2066 6f72 202a 696e 642c 2066 2069 6e20   for *ind, f in 
-00010a50: 6974 656d 7329 0a20 2020 2020 2020 2020  items).         
-00010a60: 2020 2069 6e64 6963 6573 203d 205b 4e6f     indices = [No
-00010a70: 6e65 5d20 2a20 7365 6c66 2e6e 6469 6d0a  ne] * self.ndim.
-00010a80: 2020 2020 2020 2020 2020 2020 6661 6374              fact
-00010a90: 6f72 7320 3d20 5b5d 0a20 2020 2020 2020  ors = [].       
-00010aa0: 2020 2020 2061 203d 2030 0a20 2020 2020       a = 0.     
-00010ab0: 2020 2020 2020 2066 6f72 2077 6865 7265         for where
-00010ac0: 2c20 282a 696e 642c 2066 2920 696e 207a  , (*ind, f) in z
-00010ad0: 6970 2877 6865 7265 732c 2069 7465 6d73  ip(wheres, items
-00010ae0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00010af0: 2020 2062 203d 2061 202b 2066 2e6e 6469     b = a + f.ndi
-00010b00: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
-00010b10: 2020 7220 3d20 6e75 6d70 792e 6172 616e    r = numpy.aran
-00010b20: 6765 2861 2c20 6229 0a20 2020 2020 2020  ge(a, b).       
-00010b30: 2020 2020 2020 2020 2066 6f72 2069 2c20           for i, 
-00010b40: 696e 6469 2069 6e20 7a69 7028 7768 6572  indi in zip(wher
-00010b50: 652c 2069 6e64 293a 0a20 2020 2020 2020  e, ind):.       
-00010b60: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
-00010b70: 6963 6573 5b69 5d20 3d20 616c 6967 6e28  ices[i] = align(
-00010b80: 696e 6469 2c20 722c 2073 6861 7065 290a  indi, r, shape).
-00010b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ba0: 6661 6374 6f72 732e 6170 7065 6e64 2861  factors.append(a
-00010bb0: 6c69 676e 2866 2c20 722c 2073 6861 7065  lign(f, r, shape
-00010bc0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00010bd0: 2020 2061 203d 2062 0a20 2020 2020 2020     a = b.       
-00010be0: 2020 2020 2073 7061 7273 652e 6170 7065       sparse.appe
-00010bf0: 6e64 2828 2a69 6e64 6963 6573 2c20 6d75  nd((*indices, mu
-00010c00: 6c74 6970 6c79 282a 6661 6374 6f72 7329  ltiply(*factors)
-00010c10: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
-00010c20: 6e20 7475 706c 6528 7370 6172 7365 290a  n tuple(sparse).
-00010c30: 0a20 2020 2064 6566 205f 696e 7462 6f75  .    def _intbou
-00010c40: 6e64 735f 696d 706c 2873 656c 6629 3a0a  nds_impl(self):.
-00010c50: 2020 2020 2020 2020 6675 6e63 312c 2066          func1, f
-00010c60: 756e 6332 203d 2073 656c 662e 6675 6e63  unc2 = self.func
-00010c70: 730a 2020 2020 2020 2020 6578 7472 656d  s.        extrem
-00010c80: 6120 3d20 5b62 3120 616e 6420 6232 2061  a = [b1 and b2 a
-00010c90: 6e64 2062 3120 2a20 6232 2066 6f72 2062  nd b1 * b2 for b
-00010ca0: 3120 696e 2066 756e 6331 2e5f 696e 7462  1 in func1._intb
-00010cb0: 6f75 6e64 7320 666f 7220 6232 2069 6e20  ounds for b2 in 
-00010cc0: 6675 6e63 322e 5f69 6e74 626f 756e 6473  func2._intbounds
-00010cd0: 5d0a 2020 2020 2020 2020 7265 7475 726e  ].        return
-00010ce0: 206d 696e 2865 7874 7265 6d61 292c 206d   min(extrema), m
-00010cf0: 6178 2865 7874 7265 6d61 290a 0a0a 636c  ax(extrema)...cl
-00010d00: 6173 7320 4164 6428 4172 7261 7929 3a0a  ass Add(Array):.
-00010d10: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00010d20: 5f28 7365 6c66 2c20 6675 6e63 733a 2074  _(self, funcs: t
-00010d30: 7970 6573 2e66 726f 7a65 6e6d 756c 7469  ypes.frozenmulti
-00010d40: 7365 7429 3a0a 2020 2020 2020 2020 6173  set):.        as
-00010d50: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-00010d60: 6675 6e63 732c 2074 7970 6573 2e66 726f  funcs, types.fro
-00010d70: 7a65 6e6d 756c 7469 7365 7429 2061 6e64  zenmultiset) and
-00010d80: 206c 656e 2866 756e 6373 2920 3d3d 2032   len(funcs) == 2
-00010d90: 2c20 6627 6675 6e63 733d 7b66 756e 6373  , f'funcs={funcs
-00010da0: 2172 7d27 0a20 2020 2020 2020 2073 656c  !r}'.        sel
-00010db0: 662e 6675 6e63 7320 3d20 6675 6e63 730a  f.funcs = funcs.
-00010dc0: 2020 2020 2020 2020 6675 6e63 312c 2066          func1, f
-00010dd0: 756e 6332 203d 2066 756e 6373 0a20 2020  unc2 = funcs.   
-00010de0: 2020 2020 2061 7373 6572 7420 6571 7561       assert equa
-00010df0: 6c73 6861 7065 2866 756e 6331 2e73 6861  lshape(func1.sha
-00010e00: 7065 2c20 6675 6e63 322e 7368 6170 6529  pe, func2.shape)
-00010e10: 2061 6e64 2066 756e 6331 2e64 7479 7065   and func1.dtype
-00010e20: 203d 3d20 6675 6e63 322e 6474 7970 6520   == func2.dtype 
-00010e30: 213d 2062 6f6f 6c2c 2027 4164 6428 7b7d  != bool, 'Add({}
-00010e40: 2c20 7b7d 2927 2e66 6f72 6d61 7428 6675  , {})'.format(fu
-00010e50: 6e63 312c 2066 756e 6332 290a 2020 2020  nc1, func2).    
-00010e60: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-00010e70: 6974 5f5f 2861 7267 733d 7475 706c 6528  it__(args=tuple(
-00010e80: 7365 6c66 2e66 756e 6373 292c 2073 6861  self.funcs), sha
-00010e90: 7065 3d66 756e 6331 2e73 6861 7065 2c20  pe=func1.shape, 
-00010ea0: 6474 7970 653d 6675 6e63 312e 6474 7970  dtype=func1.dtyp
-00010eb0: 6529 0a0a 2020 2020 4063 6163 6865 645f  e)..    @cached_
-00010ec0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00010ed0: 205f 696e 666c 6174 696f 6e73 2873 656c   _inflations(sel
-00010ee0: 6629 3a0a 2020 2020 2020 2020 6675 6e63  f):.        func
-00010ef0: 312c 2066 756e 6332 203d 2073 656c 662e  1, func2 = self.
-00010f00: 6675 6e63 730a 2020 2020 2020 2020 6675  funcs.        fu
-00010f10: 6e63 325f 696e 666c 6174 696f 6e73 203d  nc2_inflations =
-00010f20: 2064 6963 7428 6675 6e63 322e 5f69 6e66   dict(func2._inf
-00010f30: 6c61 7469 6f6e 7329 0a20 2020 2020 2020  lations).       
-00010f40: 2069 6e66 6c61 7469 6f6e 7320 3d20 5b5d   inflations = []
-00010f50: 0a20 2020 2020 2020 2066 6f72 2061 7869  .        for axi
-00010f60: 732c 2070 6172 7473 3120 696e 2066 756e  s, parts1 in fun
-00010f70: 6331 2e5f 696e 666c 6174 696f 6e73 3a0a  c1._inflations:.
-00010f80: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-00010f90: 7869 7320 6e6f 7420 696e 2066 756e 6332  xis not in func2
-00010fa0: 5f69 6e66 6c61 7469 6f6e 733a 0a20 2020  _inflations:.   
-00010fb0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00010fc0: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
-00010fd0: 2020 7061 7274 7332 203d 2066 756e 6332    parts2 = func2
-00010fe0: 5f69 6e66 6c61 7469 6f6e 735b 6178 6973  _inflations[axis
-00010ff0: 5d0a 2020 2020 2020 2020 2020 2020 646f  ].            do
-00011000: 666d 6170 7320 3d20 7365 7428 7061 7274  fmaps = set(part
-00011010: 7331 2920 7c20 7365 7428 7061 7274 7332  s1) | set(parts2
-00011020: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00011030: 2028 6c65 6e28 7061 7274 7331 2920 3c20   (len(parts1) < 
-00011040: 6c65 6e28 646f 666d 6170 7329 2061 6e64  len(dofmaps) and
-00011050: 206c 656e 2870 6172 7473 3229 203c 206c   len(parts2) < l
-00011060: 656e 2864 6f66 6d61 7073 2920 2023 206e  en(dofmaps)  # n
-00011070: 6569 7468 6572 2073 6574 2069 7320 6120  either set is a 
-00011080: 7375 6273 6574 206f 6620 7468 6520 6f74  subset of the ot
-00011090: 6865 723b 2074 6f74 616c 206d 6179 2062  her; total may b
-000110a0: 6520 6465 6e73 650a 2020 2020 2020 2020  e dense.        
-000110b0: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-000110c0: 7365 6c66 2e73 6861 7065 5b61 7869 735d  self.shape[axis]
-000110d0: 2e69 7363 6f6e 7374 616e 7420 616e 6420  .isconstant and 
-000110e0: 616c 6c28 646f 666d 6170 2e69 7363 6f6e  all(dofmap.iscon
-000110f0: 7374 616e 7420 666f 7220 646f 666d 6170  stant for dofmap
-00011100: 2069 6e20 646f 666d 6170 7329 293a 0a20   in dofmaps)):. 
-00011110: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00011120: 6173 6b20 3d20 6e75 6d70 792e 7a65 726f  ask = numpy.zero
-00011130: 7328 696e 7428 7365 6c66 2e73 6861 7065  s(int(self.shape
-00011140: 5b61 7869 735d 292c 2064 7479 7065 3d62  [axis]), dtype=b
-00011150: 6f6f 6c29 0a20 2020 2020 2020 2020 2020  ool).           
-00011160: 2020 2020 2066 6f72 2064 6f66 6d61 7020       for dofmap 
-00011170: 696e 2064 6f66 6d61 7073 3a0a 2020 2020  in dofmaps:.    
-00011180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011190: 6d61 736b 5b64 6f66 6d61 702e 6576 616c  mask[dofmap.eval
-000111a0: 2829 5d20 3d20 5472 7565 0a20 2020 2020  ()] = True.     
-000111b0: 2020 2020 2020 2020 2020 2069 6620 6d61             if ma
-000111c0: 736b 2e61 6c6c 2829 3a20 2023 2061 7869  sk.all():  # axi
-000111d0: 7320 6164 6473 2075 7020 746f 2064 656e  s adds up to den
-000111e0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-000111f0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-00011200: 2020 2020 2020 2020 2020 2020 696e 666c              infl
-00011210: 6174 696f 6e73 2e61 7070 656e 6428 2861  ations.append((a
-00011220: 7869 732c 2074 7970 6573 2e66 726f 7a65  xis, types.froze
-00011230: 6e64 6963 7428 2864 6f66 6d61 702c 2075  ndict((dofmap, u
-00011240: 7469 6c2e 7375 6d28 7061 7274 735b 646f  til.sum(parts[do
-00011250: 666d 6170 5d20 666f 7220 7061 7274 7320  fmap] for parts 
-00011260: 696e 2028 7061 7274 7331 2c20 7061 7274  in (parts1, part
-00011270: 7332 2920 6966 2064 6f66 6d61 7020 696e  s2) if dofmap in
-00011280: 2070 6172 7473 2929 2066 6f72 2064 6f66   parts)) for dof
-00011290: 6d61 7020 696e 2064 6f66 6d61 7073 2929  map in dofmaps))
-000112a0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000112b0: 2074 7570 6c65 2869 6e66 6c61 7469 6f6e   tuple(inflation
-000112c0: 7329 0a0a 2020 2020 4070 726f 7065 7274  s)..    @propert
-000112d0: 790a 2020 2020 6465 6620 5f74 6572 6d73  y.    def _terms
-000112e0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000112f0: 666f 7220 6675 6e63 2069 6e20 7365 6c66  for func in self
-00011300: 2e66 756e 6373 3a0a 2020 2020 2020 2020  .funcs:.        
-00011310: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00011320: 6528 6675 6e63 2c20 4164 6429 3a0a 2020  e(func, Add):.  
-00011330: 2020 2020 2020 2020 2020 2020 2020 7969                yi
-00011340: 656c 6420 6672 6f6d 2066 756e 632e 5f74  eld from func._t
-00011350: 6572 6d73 0a20 2020 2020 2020 2020 2020  erms.           
-00011360: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00011370: 2020 2020 2020 2079 6965 6c64 2066 756e         yield fun
-00011380: 630a 0a20 2020 2064 6566 205f 7369 6d70  c..    def _simp
-00011390: 6c69 6669 6564 2873 656c 6629 3a0a 2020  lified(self):.  
-000113a0: 2020 2020 2020 7465 726d 7320 3d20 7475        terms = tu
-000113b0: 706c 6528 7365 6c66 2e5f 7465 726d 7329  ple(self._terms)
-000113c0: 0a20 2020 2020 2020 2066 6f72 206a 2c20  .        for j, 
-000113d0: 666a 2069 6e20 656e 756d 6572 6174 6528  fj in enumerate(
-000113e0: 7465 726d 7329 3a0a 2020 2020 2020 2020  terms):.        
-000113f0: 2020 2020 666f 7220 692c 2066 6920 696e      for i, fi in
-00011400: 2065 6e75 6d65 7261 7465 2874 6572 6d73   enumerate(terms
-00011410: 5b3a 6a5d 293a 0a20 2020 2020 2020 2020  [:j]):.         
-00011420: 2020 2020 2020 2064 6961 6773 203d 205b         diags = [
-00011430: 736f 7274 6564 2861 7865 7369 2026 2061  sorted(axesi & a
-00011440: 7865 736a 295b 3a32 5d20 666f 7220 6178  xesj)[:2] for ax
-00011450: 6573 6920 696e 2066 692e 5f64 6961 676f  esi in fi._diago
-00011460: 6e61 6c73 2066 6f72 2061 7865 736a 2069  nals for axesj i
-00011470: 6e20 666a 2e5f 6469 6167 6f6e 616c 7320  n fj._diagonals 
-00011480: 6966 206c 656e 2861 7865 7369 2026 2061  if len(axesi & a
-00011490: 7865 736a 2920 3e3d 2032 5d0a 2020 2020  xesj) >= 2].    
-000114a0: 2020 2020 2020 2020 2020 2020 756e 616c              unal
-000114b0: 6967 6e65 6431 2c20 756e 616c 6967 6e65  igned1, unaligne
-000114c0: 6432 2c20 7768 6572 6520 3d20 756e 616c  d2, where = unal
-000114d0: 6967 6e28 6669 2c20 666a 290a 2020 2020  ign(fi, fj).    
-000114e0: 2020 2020 2020 2020 2020 2020 6669 6a20              fij 
-000114f0: 3d20 6469 6167 6f6e 616c 697a 6528 7461  = diagonalize(ta
-00011500: 6b65 6469 6167 2866 692c 202a 6469 6167  kediag(fi, *diag
-00011510: 735b 305d 2920 2b20 7461 6b65 6469 6167  s[0]) + takediag
-00011520: 2866 6a2c 202a 6469 6167 735b 305d 292c  (fj, *diags[0]),
-00011530: 202a 6469 6167 735b 305d 2920 6966 2064   *diags[0]) if d
-00011540: 6961 6773 205c 0a20 2020 2020 2020 2020  iags \.         
-00011550: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
-00011560: 616c 6967 6e28 756e 616c 6967 6e65 6431  align(unaligned1
-00011570: 202b 2075 6e61 6c69 676e 6564 322c 2077   + unaligned2, w
-00011580: 6865 7265 2c20 7365 6c66 2e73 6861 7065  here, self.shape
-00011590: 2920 6966 206c 656e 2877 6865 7265 2920  ) if len(where) 
-000115a0: 213d 2073 656c 662e 6e64 696d 205c 0a20  != self.ndim \. 
-000115b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115c0: 2020 2065 6c73 6520 6669 2e5f 6164 6428     else fi._add(
-000115d0: 666a 2920 6f72 2066 6a2e 5f61 6464 2866  fj) or fj._add(f
-000115e0: 6929 0a20 2020 2020 2020 2020 2020 2020  i).             
-000115f0: 2020 2069 6620 6669 6a3a 0a20 2020 2020     if fij:.     
-00011600: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00011610: 6574 7572 6e20 6164 6428 2a74 6572 6d73  eturn add(*terms
-00011620: 5b3a 695d 2c20 2a74 6572 6d73 5b69 2b31  [:i], *terms[i+1
-00011630: 3a6a 5d2c 202a 7465 726d 735b 6a2b 313a  :j], *terms[j+1:
-00011640: 5d2c 2066 696a 290a 2020 2020 2020 2020  ], fij).        
-00011650: 2320 4e4f 5445 3a20 5768 696c 6520 6974  # NOTE: While it
-00011660: 2069 7320 7465 6d70 7469 6e67 2074 6f20   is tempting to 
-00011670: 7573 6520 7468 6520 5f69 6e66 6c61 7469  use the _inflati
-00011680: 6f6e 7320 6174 7472 6962 7574 6520 746f  ons attribute to
-00011690: 2070 7573 680a 2020 2020 2020 2020 2320   push.        # 
-000116a0: 6164 6469 7469 6f6e 7320 7468 726f 7567  additions throug
-000116b0: 6820 636f 6d6d 6f6e 2069 6e66 6c61 7469  h common inflati
-000116c0: 6f6e 732c 2064 6f69 6e67 2073 6f20 6d61  ons, doing so ma
-000116d0: 7920 7265 7375 6c74 2069 6e20 696e 6669  y result in infi
-000116e0: 6e69 7465 0a20 2020 2020 2020 2023 2072  nite.        # r
-000116f0: 6563 7572 7369 6f6e 2069 6e20 6361 7365  ecursion in case
-00011700: 2074 776f 206f 7220 6d6f 7265 2061 7865   two or more axe
-00011710: 7320 6172 6520 696e 666c 6174 6564 2e20  s are inflated. 
-00011720: 5468 6973 206d 6563 6861 6e69 736d 2069  This mechanism i
-00011730: 730a 2020 2020 2020 2020 2320 696c 6c75  s.        # illu
-00011740: 7374 7261 7465 6420 696e 2074 6865 2066  strated in the f
-00011750: 6f6c 6c6f 7769 6e67 2073 6368 656d 6174  ollowing schemat
-00011760: 6963 2c20 696e 2077 6869 6368 203c 493e  ic, in which <I>
-00011770: 2061 6e64 203c 4a3e 2072 6570 7265 7365   and <J> represe
-00011780: 6e74 0a20 2020 2020 2020 2023 2069 6e66  nt.        # inf
-00011790: 6c61 7469 6f6e 7320 616c 6f6e 6720 6178  lations along ax
-000117a0: 6973 2031 2061 6e64 203c 4b3e 2061 6e64  is 1 and <K> and
-000117b0: 203c 4c3e 2069 6e66 6c61 7469 6f6e 7320   <L> inflations 
-000117c0: 616c 6f6e 6720 6178 6973 2032 3a0a 2020  along axis 2:.  
-000117d0: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
-000117e0: 2320 2020 2020 2020 2041 2020 2042 2020  #        A   B  
-000117f0: 2043 2020 2044 2020 2045 2020 2046 2020   C   D   E   F  
-00011800: 2047 2020 2048 0a20 2020 2020 2020 2023   G   H.        #
-00011810: 2020 2020 2020 203c 493e 203c 4a3e 203c         <I> <J> <
-00011820: 493e 203c 4a3e 203c 493e 203c 4a3e 203c  I> <J> <I> <J> <
-00011830: 493e 203c 4a3e 0a20 2020 2020 2020 2023  I> <J>.        #
-00011840: 2020 2e2d 2d20 2020 205c 2b2f 2020 2020    .--    \+/    
-00011850: 205c 2b2f 2020 2020 205c 2b2f 2020 2020   \+/     \+/    
-00011860: 205c 2b2f 2020 203c 2d2d 2e0a 2020 2020   \+/   <--..    
-00011870: 2020 2020 2320 207c 2020 2020 2020 205c      #  |       \
-00011880: 5f5f 3c4b 3e5f 5f2f 2020 2020 2020 205c  __<K>__/       \
-00011890: 5f5f 3c4c 3e5f 5f2f 2020 2020 2020 207c  __<L>__/       |
-000118a0: 0a20 2020 2020 2020 2023 2020 7c20 2020  .        #  |   
-000118b0: 2020 2020 2020 2020 5c5f 5f5f 5f5f 5f5f          \_______
-000118c0: 2b5f 5f5f 5f5f 5f5f 2f20 2020 2020 2020  +_______/       
-000118d0: 2020 2020 7c0a 2020 2020 2020 2020 2320      |.        # 
-000118e0: 207c 2020 2020 2020 2020 2020 2020 2020   |              
-000118f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011900: 2020 2020 2020 2020 207c 0a20 2020 2020           |.     
-00011910: 2020 2023 2020 7c20 2020 2020 4120 2020     #  |     A   
-00011920: 4520 2020 4320 2020 4720 2020 4220 2020  E   C   G   B   
-00011930: 4620 2020 4420 2020 4820 2020 2020 7c0a  F   D   H     |.
-00011940: 2020 2020 2020 2020 2320 207c 2020 2020          #  |    
-00011950: 3c4b 3e20 3c4c 3e20 3c4b 3e20 3c4c 3e20  <K> <L> <K> <L> 
-00011960: 3c4b 3e20 3c4c 3e20 3c4b 3e20 3c4c 3e20  <K> <L> <K> <L> 
-00011970: 2020 207c 0a20 2020 2020 2020 2023 2020     |.        #  
-00011980: 272d 2d3e 2020 205c 2b2f 2020 2020 205c  '-->   \+/     \
-00011990: 2b2f 2020 2020 205c 2b2f 2020 2020 205c  +/     \+/     \
-000119a0: 2b2f 2020 2020 2d2d 270a 2020 2020 2020  +/    --'.      
-000119b0: 2020 2320 2020 2020 2020 2020 205c 5f5f    #          \__
-000119c0: 3c49 3e5f 5f2f 2020 2020 2020 205c 5f5f  <I>__/       \__
-000119d0: 3c4a 3e5f 5f2f 0a20 2020 2020 2020 2023  <J>__/.        #
-000119e0: 2020 2020 2020 2020 2020 2020 2020 5c5f                \_
-000119f0: 5f5f 5f5f 5f5f 2b5f 5f5f 5f5f 5f5f 2f0a  ______+_______/.
-00011a00: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-00011a10: 2020 2320 5765 2069 6e73 7465 6164 2072    # We instead r
-00011a20: 656c 7920 6f6e 2049 6e66 6c61 7465 2e5f  ely on Inflate._
-00011a30: 6164 6420 746f 2068 616e 646c 6520 7468  add to handle th
-00011a40: 6973 2073 6974 7561 7469 6f6e 2e0a 0a20  is situation... 
-00011a50: 2020 2065 7661 6c66 203d 2073 7461 7469     evalf = stati
-00011a60: 636d 6574 686f 6428 6e75 6d70 792e 6164  cmethod(numpy.ad
-00011a70: 6429 0a0a 2020 2020 6465 6620 5f73 756d  d)..    def _sum
-00011a80: 2873 656c 662c 2061 7869 7329 3a0a 2020  (self, axis):.  
-00011a90: 2020 2020 2020 7265 7475 726e 2061 6464        return add
-00011aa0: 282a 5b73 756d 2866 2c20 6178 6973 2920  (*[sum(f, axis) 
-00011ab0: 666f 7220 6620 696e 2073 656c 662e 5f74  for f in self._t
-00011ac0: 6572 6d73 5d29 0a0a 2020 2020 6465 6620  erms])..    def 
-00011ad0: 5f64 6572 6976 6174 6976 6528 7365 6c66  _derivative(self
-00011ae0: 2c20 7661 722c 2073 6565 6e29 3a0a 2020  , var, seen):.  
-00011af0: 2020 2020 2020 7265 7475 726e 2061 6464        return add
-00011b00: 282a 5b64 6572 6976 6174 6976 6528 662c  (*[derivative(f,
-00011b10: 2076 6172 2c20 7365 656e 2920 666f 7220   var, seen) for 
-00011b20: 6620 696e 2073 656c 662e 5f74 6572 6d73  f in self._terms
-00011b30: 5d29 0a0a 2020 2020 6465 6620 5f74 616b  ])..    def _tak
-00011b40: 6564 6961 6728 7365 6c66 2c20 6178 6973  ediag(self, axis
-00011b50: 312c 2061 7869 7332 293a 0a20 2020 2020  1, axis2):.     
-00011b60: 2020 2072 6574 7572 6e20 6164 6428 2a5b     return add(*[
-00011b70: 5f74 616b 6564 6961 6728 662c 2061 7869  _takediag(f, axi
-00011b80: 7331 2c20 6178 6973 3229 2066 6f72 2066  s1, axis2) for f
-00011b90: 2069 6e20 7365 6c66 2e5f 7465 726d 735d   in self._terms]
-00011ba0: 290a 0a20 2020 2064 6566 205f 7461 6b65  )..    def _take
-00011bb0: 2873 656c 662c 2069 6e64 6578 2c20 6178  (self, index, ax
-00011bc0: 6973 293a 0a20 2020 2020 2020 2072 6574  is):.        ret
-00011bd0: 7572 6e20 6164 6428 2a5b 5f74 616b 6528  urn add(*[_take(
-00011be0: 662c 2069 6e64 6578 2c20 6178 6973 2920  f, index, axis) 
-00011bf0: 666f 7220 6620 696e 2073 656c 662e 5f74  for f in self._t
-00011c00: 6572 6d73 5d29 0a0a 2020 2020 6465 6620  erms])..    def 
-00011c10: 5f75 6e72 6176 656c 2873 656c 662c 2061  _unravel(self, a
-00011c20: 7869 732c 2073 6861 7065 293a 0a20 2020  xis, shape):.   
-00011c30: 2020 2020 2072 6574 7572 6e20 6164 6428       return add(
-00011c40: 2a5b 756e 7261 7665 6c28 662c 2061 7869  *[unravel(f, axi
-00011c50: 732c 2073 6861 7065 2920 666f 7220 6620  s, shape) for f 
-00011c60: 696e 2073 656c 662e 5f74 6572 6d73 5d29  in self._terms])
-00011c70: 0a0a 2020 2020 6465 6620 5f6c 6f6f 7073  ..    def _loops
-00011c80: 756d 2873 656c 662c 2069 6e64 6578 293a  um(self, index):
-00011c90: 0a20 2020 2020 2020 2064 6570 203d 205b  .        dep = [
-00011ca0: 5d0a 2020 2020 2020 2020 696e 6465 7020  ].        indep 
-00011cb0: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-00011cc0: 2066 2069 6e20 7365 6c66 2e5f 7465 726d   f in self._term
-00011cd0: 733a 0a20 2020 2020 2020 2020 2020 2028  s:.            (
-00011ce0: 6465 7020 6966 2069 6e64 6578 2069 6e20  dep if index in 
-00011cf0: 662e 6172 6775 6d65 6e74 7320 656c 7365  f.arguments else
-00011d00: 2069 6e64 6570 292e 6170 7065 6e64 2866   indep).append(f
-00011d10: 290a 2020 2020 2020 2020 6966 2069 6e64  ).        if ind
-00011d20: 6570 3a0a 2020 2020 2020 2020 2020 2020  ep:.            
-00011d30: 7265 7475 726e 2061 6464 282a 696e 6465  return add(*inde
-00011d40: 7029 202a 2069 6e64 6578 2e6c 656e 6774  p) * index.lengt
-00011d50: 6820 2b20 6c6f 6f70 5f73 756d 2861 6464  h + loop_sum(add
-00011d60: 282a 6465 7029 2c20 696e 6465 7829 0a0a  (*dep), index)..
-00011d70: 2020 2020 6465 6620 5f6d 756c 7469 706c      def _multipl
-00011d80: 7928 7365 6c66 2c20 6f74 6865 7229 3a0a  y(self, other):.
-00011d90: 2020 2020 2020 2020 665f 6f74 6865 7220          f_other 
-00011da0: 3d20 5b66 2e5f 6d75 6c74 6970 6c79 286f  = [f._multiply(o
-00011db0: 7468 6572 2920 6f72 206f 7468 6572 2e5f  ther) or other._
-00011dc0: 6d75 6c74 6970 6c79 2866 2920 6f72 2028  multiply(f) or (
-00011dd0: 662e 5f69 6e66 6c61 7469 6f6e 7320 6f72  f._inflations or
-00011de0: 2066 2e5f 6469 6167 6f6e 616c 7329 2061   f._diagonals) a
-00011df0: 6e64 2066 202a 206f 7468 6572 2066 6f72  nd f * other for
-00011e00: 2066 2069 6e20 7365 6c66 2e5f 7465 726d   f in self._term
-00011e10: 735d 0a20 2020 2020 2020 2069 6620 616c  s].        if al
-00011e20: 6c28 665f 6f74 6865 7229 3a0a 2020 2020  l(f_other):.    
-00011e30: 2020 2020 2020 2020 2320 4e4f 5445 3a20          # NOTE: 
-00011e40: 4173 2074 6869 7320 6f70 6572 6174 696f  As this operatio
-00011e50: 6e20 6973 2074 6865 2070 7265 6369 7365  n is the precise
-00011e60: 206f 7070 6f73 6974 6520 6f66 204d 756c   opposite of Mul
-00011e70: 7469 706c 792e 5f61 6464 2c20 7468 6572  tiply._add, ther
-00011e80: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00011e90: 6170 7065 6172 7320 746f 2062 6520 6120  appears to be a 
-00011ea0: 6772 6561 7420 7269 736b 206f 6620 7265  great risk of re
-00011eb0: 6375 7273 696f 6e2e 2048 6f77 6576 6572  cursion. However
-00011ec0: 2c20 7369 6e63 6520 626f 7468 2066 6163  , since both fac
-00011ed0: 746f 7273 0a20 2020 2020 2020 2020 2020  tors.           
-00011ee0: 2023 2061 7265 2073 7061 7273 652c 2077   # are sparse, w
-00011ef0: 6520 6361 6e20 6265 2063 6572 7461 696e  e can be certain
-00011f00: 2074 6861 7420 7375 6273 6571 7565 6e74   that subsequent
-00011f10: 2073 696d 7069 6669 6361 7469 6f6e 7320   simpifications 
-00011f20: 7769 6c6c 0a20 2020 2020 2020 2020 2020  will.           
-00011f30: 2023 2069 7272 6576 6572 7369 626c 7920   # irreversibly 
-00011f40: 7072 6f63 6573 7320 7468 6520 6e65 7720  process the new 
-00011f50: 7465 726d 7320 6265 666f 7265 2072 6561  terms before rea
-00011f60: 6368 696e 6720 7468 6973 2070 6f69 6e74  ching this point
-00011f70: 2e0a 2020 2020 2020 2020 2020 2020 7265  ..            re
-00011f80: 7475 726e 2061 6464 282a 665f 6f74 6865  turn add(*f_othe
-00011f90: 7229 0a0a 2020 2020 4063 6163 6865 645f  r)..    @cached_
-00011fa0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00011fb0: 205f 6173 7370 6172 7365 2873 656c 6629   _assparse(self)
-00011fc0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00011fd0: 205f 6761 7468 6572 7370 6172 7365 6368   _gathersparsech
-00011fe0: 756e 6b73 2869 7465 7274 6f6f 6c73 2e63  unks(itertools.c
-00011ff0: 6861 696e 282a 5b66 2e5f 6173 7370 6172  hain(*[f._asspar
-00012000: 7365 2066 6f72 2066 2069 6e20 7365 6c66  se for f in self
-00012010: 2e5f 7465 726d 735d 2929 0a0a 2020 2020  ._terms]))..    
-00012020: 6465 6620 5f69 6e74 626f 756e 6473 5f69  def _intbounds_i
-00012030: 6d70 6c28 7365 6c66 293a 0a20 2020 2020  mpl(self):.     
-00012040: 2020 206c 6f77 6572 732c 2075 7070 6572     lowers, upper
-00012050: 7320 3d20 7a69 7028 2a5b 662e 5f69 6e74  s = zip(*[f._int
-00012060: 626f 756e 6473 2066 6f72 2066 2069 6e20  bounds for f in 
-00012070: 7365 6c66 2e5f 7465 726d 735d 290a 2020  self._terms]).  
-00012080: 2020 2020 2020 7265 7475 726e 2062 7569        return bui
-00012090: 6c74 696e 732e 7375 6d28 6c6f 7765 7273  ltins.sum(lowers
-000120a0: 292c 2062 7569 6c74 696e 732e 7375 6d28  ), builtins.sum(
-000120b0: 7570 7065 7273 290a 0a0a 636c 6173 7320  uppers)...class 
-000120c0: 4569 6e73 756d 2841 7272 6179 293a 0a0a  Einsum(Array):..
-000120d0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-000120e0: 2873 656c 662c 2061 7267 733a 2074 7970  (self, args: typ
-000120f0: 696e 672e 5475 706c 655b 4172 7261 792c  ing.Tuple[Array,
-00012100: 202e 2e2e 5d2c 2061 7267 735f 6964 783a   ...], args_idx:
-00012110: 2074 7970 696e 672e 5475 706c 655b 7479   typing.Tuple[ty
-00012120: 7069 6e67 2e54 7570 6c65 5b69 6e74 2c20  ping.Tuple[int, 
-00012130: 2e2e 2e5d 2c20 2e2e 2e5d 2c20 6f75 745f  ...], ...], out_
-00012140: 6964 783a 2074 7970 696e 672e 5475 706c  idx: typing.Tupl
-00012150: 655b 696e 742c 202e 2e2e 5d29 3a0a 2020  e[int, ...]):.  
-00012160: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-00012170: 6e73 7461 6e63 6528 6172 6773 2c20 7475  nstance(args, tu
-00012180: 706c 6529 2061 6e64 2061 6c6c 2869 7369  ple) and all(isi
-00012190: 6e73 7461 6e63 6528 6172 672c 2041 7272  nstance(arg, Arr
-000121a0: 6179 2920 666f 7220 6172 6720 696e 2061  ay) for arg in a
-000121b0: 7267 7329 2c20 6627 6172 673d 7b61 7267  rgs), f'arg={arg
-000121c0: 2172 7d27 0a20 2020 2020 2020 2061 7373  !r}'.        ass
-000121d0: 6572 7420 6973 696e 7374 616e 6365 2861  ert isinstance(a
-000121e0: 7267 735f 6964 782c 2074 7570 6c65 2920  rgs_idx, tuple) 
-000121f0: 616e 6420 616c 6c28 6973 696e 7374 616e  and all(isinstan
-00012200: 6365 2861 7267 5f69 6478 2c20 7475 706c  ce(arg_idx, tupl
-00012210: 6529 2061 6e64 2061 6c6c 2869 7369 6e73  e) and all(isins
-00012220: 7461 6e63 6528 6e2c 2069 6e74 2920 666f  tance(n, int) fo
-00012230: 7220 6e20 696e 2061 7267 5f69 6478 2920  r n in arg_idx) 
-00012240: 666f 7220 6172 675f 6964 7820 696e 2061  for arg_idx in a
-00012250: 7267 735f 6964 7829 2c20 6627 6172 6773  rgs_idx), f'args
-00012260: 5f69 6478 3d7b 6172 6773 5f69 6478 2172  _idx={args_idx!r
-00012270: 7d27 0a20 2020 2020 2020 2061 7373 6572  }'.        asser
-00012280: 7420 6973 696e 7374 616e 6365 286f 7574  t isinstance(out
-00012290: 5f69 6478 2c20 7475 706c 6529 2061 6e64  _idx, tuple) and
-000122a0: 2061 6c6c 2869 7369 6e73 7461 6e63 6528   all(isinstance(
-000122b0: 6e2c 2069 6e74 2920 666f 7220 6e20 696e  n, int) for n in
-000122c0: 206f 7574 5f69 6478 2920 616e 6420 6c65   out_idx) and le
-000122d0: 6e28 6f75 745f 6964 7829 203d 3d20 6c65  n(out_idx) == le
-000122e0: 6e28 7365 7428 6f75 745f 6964 7829 292c  n(set(out_idx)),
-000122f0: 2066 276f 7574 5f69 6478 3d7b 6f75 745f   f'out_idx={out_
-00012300: 6964 7821 727d 270a 2020 2020 2020 2020  idx!r}'.        
-00012310: 6173 7365 7274 206c 656e 2861 7267 735f  assert len(args_
-00012320: 6964 7829 203d 3d20 6c65 6e28 6172 6773  idx) == len(args
-00012330: 2920 616e 6420 616c 6c28 6c65 6e28 6964  ) and all(len(id
-00012340: 7829 203d 3d20 6172 672e 6e64 696d 2066  x) == arg.ndim f
-00012350: 6f72 2069 6478 2c20 6172 6720 696e 207a  or idx, arg in z
-00012360: 6970 2861 7267 735f 6964 782c 2061 7267  ip(args_idx, arg
-00012370: 7329 292c 2066 276c 656e 2861 7267 735f  s)), f'len(args_
-00012380: 6964 7829 3d7b 6c65 6e28 6172 6773 5f69  idx)={len(args_i
-00012390: 6478 297d 2c20 6c65 6e28 6172 6773 293d  dx)}, len(args)=
-000123a0: 7b6c 656e 2861 7267 7329 7d27 0a20 2020  {len(args)}'.   
-000123b0: 2020 2020 2064 7479 7065 203d 2061 7267       dtype = arg
-000123c0: 735b 305d 2e64 7479 7065 0a20 2020 2020  s[0].dtype.     
-000123d0: 2020 2069 6620 6474 7970 6520 3d3d 2062     if dtype == b
-000123e0: 6f6f 6c20 6f72 2061 6e79 2861 7267 2e64  ool or any(arg.d
-000123f0: 7479 7065 2021 3d20 6474 7970 6520 666f  type != dtype fo
-00012400: 7220 6172 6720 696e 2061 7267 735b 313a  r arg in args[1:
-00012410: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-00012420: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00012430: 2827 496e 636f 6e73 6973 7465 6e74 206f  ('Inconsistent o
-00012440: 7220 696e 7661 6c69 6420 6474 7970 6573  r invalid dtypes
-00012450: 2e27 290a 2020 2020 2020 2020 6c65 6e67  .').        leng
-00012460: 7468 7320 3d20 7b7d 0a20 2020 2020 2020  ths = {}.       
-00012470: 2066 6f72 2069 6478 2c20 6172 6720 696e   for idx, arg in
-00012480: 207a 6970 2861 7267 735f 6964 782c 2061   zip(args_idx, a
-00012490: 7267 7329 3a0a 2020 2020 2020 2020 2020  rgs):.          
-000124a0: 2020 666f 7220 692c 206c 656e 6774 6820    for i, length 
-000124b0: 696e 207a 6970 2869 6478 2c20 6172 672e  in zip(idx, arg.
-000124c0: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
-000124d0: 2020 2020 2020 2020 6966 2069 206e 6f74          if i not
-000124e0: 2069 6e20 6c65 6e67 7468 733a 0a20 2020   in lengths:.   
-000124f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012500: 206c 656e 6774 6873 5b69 5d20 3d20 6c65   lengths[i] = le
-00012510: 6e67 7468 0a20 2020 2020 2020 2020 2020  ngth.           
-00012520: 2020 2020 2065 6c69 6620 6e6f 7420 5f65       elif not _e
-00012530: 7175 616c 735f 7369 6d70 6c69 6669 6564  quals_simplified
-00012540: 286c 656e 6774 6873 5b69 5d2c 206c 656e  (lengths[i], len
-00012550: 6774 6829 3a0a 2020 2020 2020 2020 2020  gth):.          
-00012560: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00012570: 5661 6c75 6545 7272 6f72 2827 4178 6573  ValueError('Axes
-00012580: 2077 6974 6820 696e 6465 7820 7b7d 2068   with index {} h
-00012590: 6176 6520 6469 6666 6572 656e 7420 6c65  ave different le
-000125a0: 6e67 7468 732e 272e 666f 726d 6174 2869  ngths.'.format(i
-000125b0: 2929 0a20 2020 2020 2020 2074 7279 3a0a  )).        try:.
-000125c0: 2020 2020 2020 2020 2020 2020 7368 6170              shap
-000125d0: 6520 3d20 7475 706c 6528 6c65 6e67 7468  e = tuple(length
-000125e0: 735b 695d 2066 6f72 2069 2069 6e20 6f75  s[i] for i in ou
-000125f0: 745f 6964 7829 0a20 2020 2020 2020 2065  t_idx).        e
-00012600: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
-00012610: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00012620: 6520 5661 6c75 6545 7272 6f72 2827 4f75  e ValueError('Ou
-00012630: 7470 7574 2061 7869 7320 7b7d 2069 7320  tput axis {} is 
-00012640: 6e6f 7420 6c69 7374 6564 2069 6e20 616e  not listed in an
-00012650: 7920 6f66 2074 6865 2061 7267 756d 656e  y of the argumen
-00012660: 7473 2e27 2e66 6f72 6d61 7428 272c 2027  ts.'.format(', '
-00012670: 2e6a 6f69 6e28 6920 666f 7220 6920 696e  .join(i for i in
-00012680: 206f 7574 5f69 6478 2069 6620 6920 6e6f   out_idx if i no
-00012690: 7420 696e 206c 656e 6774 6873 2929 290a  t in lengths))).
-000126a0: 2020 2020 2020 2020 7365 6c66 2e61 7267          self.arg
-000126b0: 7320 3d20 6172 6773 0a20 2020 2020 2020  s = args.       
-000126c0: 2073 656c 662e 6172 6773 5f69 6478 203d   self.args_idx =
-000126d0: 2061 7267 735f 6964 780a 2020 2020 2020   args_idx.      
-000126e0: 2020 7365 6c66 2e6f 7574 5f69 6478 203d    self.out_idx =
-000126f0: 206f 7574 5f69 6478 0a20 2020 2020 2020   out_idx.       
-00012700: 2073 656c 662e 5f65 696e 7375 6d66 6d74   self._einsumfmt
-00012710: 203d 2027 2c27 2e6a 6f69 6e28 2727 2e6a   = ','.join(''.j
-00012720: 6f69 6e28 6368 7228 3937 2b69 2920 666f  oin(chr(97+i) fo
-00012730: 7220 6920 696e 2069 6478 2920 666f 7220  r i in idx) for 
-00012740: 6964 7820 696e 2061 7267 735f 6964 7829  idx in args_idx)
-00012750: 202b 2027 2d3e 2720 2b20 2727 2e6a 6f69   + '->' + ''.joi
-00012760: 6e28 6368 7228 3937 2b69 2920 666f 7220  n(chr(97+i) for 
-00012770: 6920 696e 206f 7574 5f69 6478 290a 2020  i in out_idx).  
-00012780: 2020 2020 2020 7365 6c66 2e5f 6861 735f        self._has_
-00012790: 7375 6d6d 6564 5f61 7865 7320 3d20 6c65  summed_axes = le
-000127a0: 6e28 6c65 6e67 7468 7329 203e 206c 656e  n(lengths) > len
-000127b0: 286f 7574 5f69 6478 290a 2020 2020 2020  (out_idx).      
-000127c0: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
-000127d0: 5f5f 2861 7267 733d 7365 6c66 2e61 7267  __(args=self.arg
-000127e0: 732c 2073 6861 7065 3d73 6861 7065 2c20  s, shape=shape, 
-000127f0: 6474 7970 653d 6474 7970 6529 0a0a 2020  dtype=dtype)..  
-00012800: 2020 6465 6620 6576 616c 6628 7365 6c66    def evalf(self
-00012810: 2c20 2a61 7267 7329 3a0a 2020 2020 2020  , *args):.      
-00012820: 2020 6966 2073 656c 662e 5f68 6173 5f73    if self._has_s
-00012830: 756d 6d65 645f 6178 6573 3a0a 2020 2020  ummed_axes:.    
-00012840: 2020 2020 2020 2020 6172 6773 203d 2074          args = t
-00012850: 7570 6c65 286e 756d 7079 2e61 7361 7272  uple(numpy.asarr
-00012860: 6179 2861 7267 2c20 6f72 6465 723d 2746  ay(arg, order='F
-00012870: 2729 2066 6f72 2061 7267 2069 6e20 6172  ') for arg in ar
-00012880: 6773 290a 2020 2020 2020 2020 7265 7475  gs).        retu
-00012890: 726e 206e 756d 7079 2e63 6f72 652e 6d75  rn numpy.core.mu
-000128a0: 6c74 6961 7272 6179 2e63 5f65 696e 7375  ltiarray.c_einsu
-000128b0: 6d28 7365 6c66 2e5f 6569 6e73 756d 666d  m(self._einsumfm
-000128c0: 742c 202a 6172 6773 290a 0a20 2020 2040  t, *args)..    @
-000128d0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-000128e0: 205f 6e6f 6465 5f64 6574 6169 6c73 2873   _node_details(s
-000128f0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-00012900: 7475 726e 2073 656c 662e 5f65 696e 7375  turn self._einsu
-00012910: 6d66 6d74 0a0a 2020 2020 6465 6620 5f73  mfmt..    def _s
-00012920: 696d 706c 6966 6965 6428 7365 6c66 293a  implified(self):
-00012930: 0a20 2020 2020 2020 2066 6f72 2069 2c20  .        for i, 
-00012940: 6172 6720 696e 2065 6e75 6d65 7261 7465  arg in enumerate
-00012950: 2873 656c 662e 6172 6773 293a 0a20 2020  (self.args):.   
-00012960: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00012970: 7374 616e 6365 2861 7267 2c20 5472 616e  stance(arg, Tran
-00012980: 7370 6f73 6529 3a20 2023 2061 6273 6f72  spose):  # absor
-00012990: 6220 6054 7261 6e73 706f 7365 600a 2020  b `Transpose`.  
-000129a0: 2020 2020 2020 2020 2020 2020 2020 6964                id
-000129b0: 7820 3d20 7475 706c 6528 6d61 7028 7365  x = tuple(map(se
-000129c0: 6c66 2e61 7267 735f 6964 785b 695d 2e5f  lf.args_idx[i]._
-000129d0: 5f67 6574 6974 656d 5f5f 2c20 6e75 6d70  _getitem__, nump
-000129e0: 792e 6172 6773 6f72 7428 6172 672e 6178  y.argsort(arg.ax
-000129f0: 6573 2929 290a 2020 2020 2020 2020 2020  es))).          
-00012a00: 2020 2020 2020 7265 7475 726e 2045 696e        return Ein
-00012a10: 7375 6d28 7365 6c66 2e61 7267 735b 3a69  sum(self.args[:i
-00012a20: 5d2b 2861 7267 2e66 756e 632c 292b 7365  ]+(arg.func,)+se
-00012a30: 6c66 2e61 7267 735b 692b 313a 5d2c 2073  lf.args[i+1:], s
-00012a40: 656c 662e 6172 6773 5f69 6478 5b3a 695d  elf.args_idx[:i]
-00012a50: 2b28 6964 782c 292b 7365 6c66 2e61 7267  +(idx,)+self.arg
-00012a60: 735f 6964 785b 692b 313a 5d2c 2073 656c  s_idx[i+1:], sel
-00012a70: 662e 6f75 745f 6964 7829 0a0a 2020 2020  f.out_idx)..    
-00012a80: 6465 6620 5f73 756d 2873 656c 662c 2061  def _sum(self, a
-00012a90: 7869 7329 3a0a 2020 2020 2020 2020 6966  xis):.        if
-00012aa0: 206e 6f74 2028 3020 3c3d 2061 7869 7320   not (0 <= axis 
-00012ab0: 3c20 7365 6c66 2e6e 6469 6d29 3a0a 2020  < self.ndim):.  
-00012ac0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00012ad0: 496e 6465 7845 7272 6f72 2827 4178 6973  IndexError('Axis
-00012ae0: 206f 7574 206f 6620 7261 6e67 652e 2729   out of range.')
-00012af0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00012b00: 4569 6e73 756d 2873 656c 662e 6172 6773  Einsum(self.args
-00012b10: 2c20 7365 6c66 2e61 7267 735f 6964 782c  , self.args_idx,
-00012b20: 2073 656c 662e 6f75 745f 6964 785b 3a61   self.out_idx[:a
-00012b30: 7869 735d 202b 2073 656c 662e 6f75 745f  xis] + self.out_
-00012b40: 6964 785b 6178 6973 2b31 3a5d 290a 0a20  idx[axis+1:]).. 
-00012b50: 2020 2064 6566 205f 7461 6b65 6469 6167     def _takediag
-00012b60: 2873 656c 662c 2061 7869 7331 2c20 6178  (self, axis1, ax
-00012b70: 6973 3229 3a0a 2020 2020 2020 2020 6966  is2):.        if
-00012b80: 206e 6f74 2028 3020 3c3d 2061 7869 7331   not (0 <= axis1
-00012b90: 203c 2061 7869 7332 203c 2073 656c 662e   < axis2 < self.
-00012ba0: 6e64 696d 293a 0a20 2020 2020 2020 2020  ndim):.         
-00012bb0: 2020 2072 6169 7365 2049 6e64 6578 4572     raise IndexEr
-00012bc0: 726f 7228 2741 7869 7320 6f75 7420 6f66  ror('Axis out of
-00012bd0: 2072 616e 6765 2e27 290a 2020 2020 2020   range.').      
-00012be0: 2020 696b 6565 702c 2069 726d 203d 2073    ikeep, irm = s
-00012bf0: 656c 662e 6f75 745f 6964 785b 6178 6973  elf.out_idx[axis
-00012c00: 315d 2c20 7365 6c66 2e6f 7574 5f69 6478  1], self.out_idx
-00012c10: 5b61 7869 7332 5d0a 2020 2020 2020 2020  [axis2].        
-00012c20: 6172 6773 5f69 6478 203d 2074 7570 6c65  args_idx = tuple
-00012c30: 2874 7570 6c65 2869 6b65 6570 2069 6620  (tuple(ikeep if 
-00012c40: 6920 3d3d 2069 726d 2065 6c73 6520 6920  i == irm else i 
-00012c50: 666f 7220 6920 696e 2069 6478 2920 666f  for i in idx) fo
-00012c60: 7220 6964 7820 696e 2073 656c 662e 6172  r idx in self.ar
-00012c70: 6773 5f69 6478 290a 2020 2020 2020 2020  gs_idx).        
-00012c80: 7265 7475 726e 2045 696e 7375 6d28 7365  return Einsum(se
-00012c90: 6c66 2e61 7267 732c 2061 7267 735f 6964  lf.args, args_id
-00012ca0: 782c 2073 656c 662e 6f75 745f 6964 785b  x, self.out_idx[
-00012cb0: 3a61 7869 7331 5d20 2b20 7365 6c66 2e6f  :axis1] + self.o
-00012cc0: 7574 5f69 6478 5b61 7869 7331 2b31 3a61  ut_idx[axis1+1:a
-00012cd0: 7869 7332 5d20 2b20 7365 6c66 2e6f 7574  xis2] + self.out
-00012ce0: 5f69 6478 5b61 7869 7332 2b31 3a5d 202b  _idx[axis2+1:] +
-00012cf0: 2028 696b 6565 702c 2929 0a0a 0a63 6c61   (ikeep,))...cla
-00012d00: 7373 2053 756d 2841 7272 6179 293a 0a0a  ss Sum(Array):..
-00012d10: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-00012d20: 2873 656c 662c 2066 756e 633a 2041 7272  (self, func: Arr
-00012d30: 6179 293a 0a20 2020 2020 2020 2061 7373  ay):.        ass
-00012d40: 6572 7420 6973 696e 7374 616e 6365 2866  ert isinstance(f
-00012d50: 756e 632c 2041 7272 6179 292c 2066 2766  unc, Array), f'f
-00012d60: 756e 633d 7b66 756e 6321 727d 270a 2020  unc={func!r}'.  
-00012d70: 2020 2020 2020 6173 7365 7274 2066 756e        assert fun
-00012d80: 632e 6474 7970 6520 213d 2062 6f6f 6c2c  c.dtype != bool,
-00012d90: 2027 5375 6d28 7b7d 2927 2e66 6f72 6d61   'Sum({})'.forma
-00012da0: 7428 6675 6e63 290a 2020 2020 2020 2020  t(func).        
-00012db0: 7365 6c66 2e66 756e 6320 3d20 6675 6e63  self.func = func
-00012dc0: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
-00012dd0: 2e5f 5f69 6e69 745f 5f28 6172 6773 3d28  .__init__(args=(
-00012de0: 6675 6e63 2c29 2c20 7368 6170 653d 6675  func,), shape=fu
-00012df0: 6e63 2e73 6861 7065 5b3a 2d31 5d2c 2064  nc.shape[:-1], d
-00012e00: 7479 7065 3d66 756e 632e 6474 7970 6529  type=func.dtype)
-00012e10: 0a0a 2020 2020 6465 6620 5f73 696d 706c  ..    def _simpl
-00012e20: 6966 6965 6428 7365 6c66 293a 0a20 2020  ified(self):.   
-00012e30: 2020 2020 2069 6620 5f65 7175 616c 735f       if _equals_
-00012e40: 7363 616c 6172 5f63 6f6e 7374 616e 7428  scalar_constant(
-00012e50: 7365 6c66 2e66 756e 632e 7368 6170 655b  self.func.shape[
-00012e60: 2d31 5d2c 2031 293a 0a20 2020 2020 2020  -1], 1):.       
-00012e70: 2020 2020 2072 6574 7572 6e20 5461 6b65       return Take
-00012e80: 2873 656c 662e 6675 6e63 2c20 636f 6e73  (self.func, cons
-00012e90: 7461 6e74 2830 2929 0a20 2020 2020 2020  tant(0)).       
-00012ea0: 2072 6574 7572 6e20 7365 6c66 2e66 756e   return self.fun
-00012eb0: 632e 5f73 756d 2873 656c 662e 6e64 696d  c._sum(self.ndim
-00012ec0: 290a 0a20 2020 2040 7374 6174 6963 6d65  )..    @staticme
-00012ed0: 7468 6f64 0a20 2020 2064 6566 2065 7661  thod.    def eva
-00012ee0: 6c66 2861 7272 293a 0a20 2020 2020 2020  lf(arr):.       
-00012ef0: 2072 6574 7572 6e20 6e75 6d70 792e 7375   return numpy.su
-00012f00: 6d28 6172 722c 202d 3129 0a0a 2020 2020  m(arr, -1)..    
-00012f10: 6465 6620 5f73 756d 2873 656c 662c 2061  def _sum(self, a
-00012f20: 7869 7329 3a0a 2020 2020 2020 2020 7472  xis):.        tr
-00012f30: 7973 756d 203d 2073 656c 662e 6675 6e63  ysum = self.func
-00012f40: 2e5f 7375 6d28 6178 6973 290a 2020 2020  ._sum(axis).    
-00012f50: 2020 2020 6966 2074 7279 7375 6d20 6973      if trysum is
-00012f60: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00012f70: 2020 2020 2020 2072 6574 7572 6e20 5375         return Su
-00012f80: 6d28 7472 7973 756d 290a 0a20 2020 2064  m(trysum)..    d
-00012f90: 6566 205f 6465 7269 7661 7469 7665 2873  ef _derivative(s
-00012fa0: 656c 662c 2076 6172 2c20 7365 656e 293a  elf, var, seen):
-00012fb0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00012fc0: 7375 6d28 6465 7269 7661 7469 7665 2873  sum(derivative(s
-00012fd0: 656c 662e 6675 6e63 2c20 7661 722c 2073  elf.func, var, s
-00012fe0: 6565 6e29 2c20 7365 6c66 2e6e 6469 6d29  een), self.ndim)
-00012ff0: 0a0a 2020 2020 4063 6163 6865 645f 7072  ..    @cached_pr
-00013000: 6f70 6572 7479 0a20 2020 2064 6566 205f  operty.    def _
-00013010: 6173 7370 6172 7365 2873 656c 6629 3a0a  assparse(self):.
-00013020: 2020 2020 2020 2020 6368 756e 6b73 203d          chunks =
-00013030: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
-00013040: 2a69 6e64 6963 6573 2c20 5f72 6d69 6478  *indices, _rmidx
-00013050: 2c20 7661 6c75 6573 2069 6e20 7365 6c66  , values in self
-00013060: 2e66 756e 632e 5f61 7373 7061 7273 653a  .func._assparse:
-00013070: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00013080: 7365 6c66 2e6e 6469 6d20 3d3d 2030 3a0a  self.ndim == 0:.
-00013090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000130a0: 6e73 756d 203d 2076 616c 7565 732e 6e64  nsum = values.nd
-000130b0: 696d 0a20 2020 2020 2020 2020 2020 2065  im.            e
-000130c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000130d0: 2020 2020 202a 696e 6469 6365 732c 2077       *indices, w
-000130e0: 6865 7265 203d 2075 6e61 6c69 676e 282a  here = unalign(*
-000130f0: 696e 6469 6365 7329 0a20 2020 2020 2020  indices).       
-00013100: 2020 2020 2020 2020 2076 616c 7565 7320           values 
-00013110: 3d20 7472 616e 7370 6f73 6528 7661 6c75  = transpose(valu
-00013120: 6573 2c20 7768 6572 6520 2b20 7475 706c  es, where + tupl
-00013130: 6528 6920 666f 7220 6920 696e 2072 616e  e(i for i in ran
-00013140: 6765 2876 616c 7565 732e 6e64 696d 2920  ge(values.ndim) 
-00013150: 6966 2069 206e 6f74 2069 6e20 7768 6572  if i not in wher
-00013160: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-00013170: 2020 2020 6e73 756d 203d 2076 616c 7565      nsum = value
-00013180: 732e 6e64 696d 202d 206c 656e 2877 6865  s.ndim - len(whe
-00013190: 7265 290a 2020 2020 2020 2020 2020 2020  re).            
-000131a0: 666f 7220 6920 696e 2072 616e 6765 286e  for i in range(n
-000131b0: 7375 6d29 3a0a 2020 2020 2020 2020 2020  sum):.          
-000131c0: 2020 2020 2020 7661 6c75 6573 203d 2053        values = S
-000131d0: 756d 2876 616c 7565 7329 0a20 2020 2020  um(values).     
-000131e0: 2020 2020 2020 2063 6875 6e6b 732e 6170         chunks.ap
-000131f0: 7065 6e64 2828 2a69 6e64 6963 6573 2c20  pend((*indices, 
-00013200: 7661 6c75 6573 2929 0a20 2020 2020 2020  values)).       
-00013210: 2072 6574 7572 6e20 5f67 6174 6865 7273   return _gathers
-00013220: 7061 7273 6563 6875 6e6b 7328 6368 756e  parsechunks(chun
-00013230: 6b73 290a 0a20 2020 2064 6566 205f 696e  ks)..    def _in
-00013240: 7462 6f75 6e64 735f 696d 706c 2873 656c  tbounds_impl(sel
-00013250: 6629 3a0a 2020 2020 2020 2020 6c6f 7765  f):.        lowe
-00013260: 725f 6675 6e63 2c20 7570 7065 725f 6675  r_func, upper_fu
-00013270: 6e63 203d 2073 656c 662e 6675 6e63 2e5f  nc = self.func._
-00013280: 696e 7462 6f75 6e64 730a 2020 2020 2020  intbounds.      
-00013290: 2020 6c6f 7765 725f 6c65 6e67 7468 2c20    lower_length, 
-000132a0: 7570 7065 725f 6c65 6e67 7468 203d 2073  upper_length = s
-000132b0: 656c 662e 6675 6e63 2e73 6861 7065 5b2d  elf.func.shape[-
-000132c0: 315d 2e5f 696e 7462 6f75 6e64 730a 2020  1]._intbounds.  
-000132d0: 2020 2020 2020 6966 2075 7070 6572 5f6c        if upper_l
-000132e0: 656e 6774 6820 3d3d 2030 3a0a 2020 2020  ength == 0:.    
-000132f0: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
-00013300: 2c20 300a 2020 2020 2020 2020 656c 6966  , 0.        elif
-00013310: 206c 6f77 6572 5f6c 656e 6774 6820 3d3d   lower_length ==
-00013320: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00013330: 7265 7475 726e 206d 696e 2830 2c20 6c6f  return min(0, lo
-00013340: 7765 725f 6675 6e63 202a 2075 7070 6572  wer_func * upper
-00013350: 5f6c 656e 6774 6829 2c20 6d61 7828 302c  _length), max(0,
-00013360: 2075 7070 6572 5f66 756e 6320 2a20 7570   upper_func * up
-00013370: 7065 725f 6c65 6e67 7468 290a 2020 2020  per_length).    
-00013380: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00013390: 2020 2020 2020 7265 7475 726e 206d 696e        return min
-000133a0: 286c 6f77 6572 5f66 756e 6320 2a20 6c6f  (lower_func * lo
-000133b0: 7765 725f 6c65 6e67 7468 2c20 6c6f 7765  wer_length, lowe
-000133c0: 725f 6675 6e63 202a 2075 7070 6572 5f6c  r_func * upper_l
-000133d0: 656e 6774 6829 2c20 6d61 7828 7570 7065  ength), max(uppe
-000133e0: 725f 6675 6e63 202a 206c 6f77 6572 5f6c  r_func * lower_l
-000133f0: 656e 6774 682c 2075 7070 6572 5f66 756e  ength, upper_fun
+00003fd0: 2020 2020 2020 2020 6172 6773 203d 205b          args = [
+00003fe0: 6627 257b 697d 2720 666f 7220 6920 696e  f'%{i}' for i in
+00003ff0: 2069 6e64 6963 6573 5d0a 2020 2020 2020   indices].      
+00004000: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00004010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004020: 2020 2073 6967 203d 2069 6e73 7065 6374     sig = inspect
+00004030: 2e73 6967 6e61 7475 7265 286f 702e 6576  .signature(op.ev
+00004040: 616c 6629 0a20 2020 2020 2020 2020 2020  alf).           
+00004050: 2020 2020 2065 7863 6570 7420 5661 6c75       except Valu
+00004060: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+00004070: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+00004080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004090: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000040a0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+000040b0: 2c20 7061 7261 6d20 696e 2065 6e75 6d65  , param in enume
+000040c0: 7261 7465 2873 6967 2e70 6172 616d 6574  rate(sig.paramet
+000040d0: 6572 732e 7661 6c75 6573 2829 293a 0a20  ers.values()):. 
+000040e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000040f0: 2020 2020 2020 2069 6620 6920 3c20 6c65         if i < le
+00004100: 6e28 6172 6773 2920 616e 6420 7061 7261  n(args) and para
+00004110: 6d2e 6b69 6e64 203d 3d20 7061 7261 6d2e  m.kind == param.
+00004120: 504f 5349 5449 4f4e 414c 5f4f 525f 4b45  POSITIONAL_OR_KE
+00004130: 5957 4f52 443a 0a20 2020 2020 2020 2020  YWORD:.         
+00004140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004150: 2020 2061 7267 735b 695d 203d 2070 6172     args[i] = par
+00004160: 616d 2e6e 616d 6520 2b20 273d 2720 2b20  am.name + '=' + 
+00004170: 6172 6773 5b69 5d0a 2020 2020 2020 2020  args[i].        
+00004180: 2020 2020 2020 2020 732e 6578 7465 6e64          s.extend
+00004190: 2861 7267 7329 0a20 2020 2020 2020 2020  (args).         
+000041a0: 2020 2079 6965 6c64 2027 2027 2e6a 6f69     yield ' '.joi
+000041b0: 6e28 7329 0a0a 2020 2020 6465 6620 5f66  n(s)..    def _f
+000041c0: 6f72 6d61 745f 7374 6163 6b28 7365 6c66  ormat_stack(self
+000041d0: 2c20 7661 6c75 6573 2c20 6529 3a0a 2020  , values, e):.  
+000041e0: 2020 2020 2020 6c69 6e65 7320 3d20 5b66        lines = [f
+000041f0: 2765 7661 6c75 6174 696f 6e20 6661 696c  'evaluation fail
+00004200: 6564 2069 6e20 7374 6570 207b 6c65 6e28  ed in step {len(
+00004210: 7661 6c75 6573 297d 2f7b 6c65 6e28 7365  values)}/{len(se
+00004220: 6c66 2e64 6570 656e 6465 6e63 6965 7329  lf.dependencies)
+00004230: 2b31 7d27 5d0a 2020 2020 2020 2020 7374  +1}'].        st
+00004240: 6163 6b20 3d20 7365 6c66 2e5f 6974 6572  ack = self._iter
+00004250: 5f73 7461 636b 2829 0a20 2020 2020 2020  _stack().       
+00004260: 2066 6f72 2076 2c20 6f70 2069 6e20 7a69   for v, op in zi
+00004270: 7028 7661 6c75 6573 2c20 7374 6163 6b29  p(values, stack)
+00004280: 3a20 2320 4e4f 5445 2076 616c 7565 7320  : # NOTE values 
+00004290: 6d75 7374 2063 6f6d 6520 6669 7273 7420  must come first 
+000042a0: 746f 2061 766f 6964 2070 6f70 7069 6e67  to avoid popping
+000042b0: 206e 6578 7420 6974 656d 2066 726f 6d20   next item from 
+000042c0: 7374 6163 6b0a 2020 2020 2020 2020 2020  stack.          
+000042d0: 2020 7320 3d20 6627 7b74 7970 6528 7629    s = f'{type(v)
+000042e0: 2e5f 5f6e 616d 655f 5f7d 270a 2020 2020  .__name__}'.    
+000042f0: 2020 2020 2020 2020 6966 206e 756d 6572          if numer
+00004300: 6963 2e69 7361 7272 6179 2876 293a 0a20  ic.isarray(v):. 
+00004310: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00004320: 202b 3d20 6627 3c7b 762e 6474 7970 652e   += f'<{v.dtype.
+00004330: 6b69 6e64 7d3a 7b22 2c22 2e6a 6f69 6e28  kind}:{",".join(
+00004340: 7374 7228 6e29 2066 6f72 206e 2069 6e20  str(n) for n in 
+00004350: 762e 7368 6170 6529 7d3e 270a 2020 2020  v.shape)}>'.    
+00004360: 2020 2020 2020 2020 6c69 6e65 732e 6170          lines.ap
+00004370: 7065 6e64 2866 277b 6f70 7d20 2d2d 3e20  pend(f'{op} --> 
+00004380: 7b73 7d27 290a 2020 2020 2020 2020 6c69  {s}').        li
+00004390: 6e65 732e 6170 7065 6e64 2866 277b 6e65  nes.append(f'{ne
+000043a0: 7874 2873 7461 636b 297d 202d 2d3e 207b  xt(stack)} --> {
+000043b0: 657d 2729 0a20 2020 2020 2020 2072 6574  e}').        ret
+000043c0: 7572 6e20 275c 6e20 2027 2e6a 6f69 6e28  urn '\n  '.join(
+000043d0: 6c69 6e65 7329 0a0a 2020 2020 4070 726f  lines)..    @pro
+000043e0: 7065 7274 790a 2020 2020 4072 6570 6c61  perty.    @repla
+000043f0: 6365 2864 6570 7468 6669 7273 743d 5472  ce(depthfirst=Tr
+00004400: 7565 2c20 7265 6375 7273 6976 653d 5472  ue, recursive=Tr
+00004410: 7565 290a 2020 2020 6465 6620 7369 6d70  ue).    def simp
+00004420: 6c69 6669 6564 286f 626a 293a 0a20 2020  lified(obj):.   
+00004430: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00004440: 6365 286f 626a 2c20 4576 616c 7561 626c  ce(obj, Evaluabl
+00004450: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00004460: 7265 7476 616c 203d 206f 626a 2e5f 7369  retval = obj._si
+00004470: 6d70 6c69 6669 6564 2829 0a20 2020 2020  mplified().     
+00004480: 2020 2020 2020 2069 6620 7265 7476 616c         if retval
+00004490: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+000044a0: 2069 7369 6e73 7461 6e63 6528 6f62 6a2c   isinstance(obj,
+000044b0: 2041 7272 6179 293a 0a20 2020 2020 2020   Array):.       
+000044c0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000044d0: 6973 696e 7374 616e 6365 2872 6574 7661  isinstance(retva
+000044e0: 6c2c 2041 7272 6179 2920 616e 6420 6571  l, Array) and eq
+000044f0: 7561 6c73 6861 7065 2872 6574 7661 6c2e  ualshape(retval.
+00004500: 7368 6170 652c 206f 626a 2e73 6861 7065  shape, obj.shape
+00004510: 2920 616e 6420 7265 7476 616c 2e64 7479  ) and retval.dty
+00004520: 7065 203d 3d20 6f62 6a2e 6474 7970 652c  pe == obj.dtype,
+00004530: 2027 7b7d 202d 2d73 696d 706c 6966 792d   '{} --simplify-
+00004540: 2d3e 207b 7d27 2e66 6f72 6d61 7428 6f62  -> {}'.format(ob
+00004550: 6a2c 2072 6574 7661 6c29 0a20 2020 2020  j, retval).     
+00004560: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00004570: 7476 616c 0a0a 2020 2020 6465 6620 5f73  tval..    def _s
+00004580: 696d 706c 6966 6965 6428 7365 6c66 293a  implified(self):
+00004590: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+000045a0: 0a20 2020 2040 6361 6368 6564 5f70 726f  .    @cached_pro
+000045b0: 7065 7274 790a 2020 2020 6465 6620 6f70  perty.    def op
+000045c0: 7469 6d69 7a65 645f 666f 725f 6e75 6d70  timized_for_nump
+000045d0: 7928 7365 6c66 293a 0a20 2020 2020 2020  y(self):.       
+000045e0: 2072 6574 7661 6c20 3d20 7365 6c66 2e73   retval = self.s
+000045f0: 696d 706c 6966 6965 642e 5f6f 7074 696d  implified._optim
+00004600: 697a 6564 5f66 6f72 5f6e 756d 7079 3128  ized_for_numpy1(
+00004610: 2920 6f72 2073 656c 660a 2020 2020 2020  ) or self.      
+00004620: 2020 7265 7475 726e 2072 6574 7661 6c2e    return retval.
+00004630: 5f63 6f6d 6269 6e65 5f6c 6f6f 705f 636f  _combine_loop_co
+00004640: 6e63 6174 656e 6174 6573 2866 726f 7a65  ncatenates(froze
+00004650: 6e73 6574 2829 290a 0a20 2020 2040 7265  nset())..    @re
+00004660: 706c 6163 6528 6465 7074 6866 6972 7374  place(depthfirst
+00004670: 3d54 7275 652c 2072 6563 7572 7369 7665  =True, recursive
+00004680: 3d54 7275 6529 0a20 2020 2064 6566 205f  =True).    def _
+00004690: 6f70 7469 6d69 7a65 645f 666f 725f 6e75  optimized_for_nu
+000046a0: 6d70 7931 286f 626a 293a 0a20 2020 2020  mpy1(obj):.     
+000046b0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+000046c0: 286f 626a 2c20 4576 616c 7561 626c 6529  (obj, Evaluable)
+000046d0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000046e0: 7476 616c 203d 206f 626a 2e5f 7369 6d70  tval = obj._simp
+000046f0: 6c69 6669 6564 2829 206f 7220 6f62 6a2e  lified() or obj.
+00004700: 5f6f 7074 696d 697a 6564 5f66 6f72 5f6e  _optimized_for_n
+00004710: 756d 7079 2829 0a20 2020 2020 2020 2020  umpy().         
+00004720: 2020 2069 6620 7265 7476 616c 2069 7320     if retval is 
+00004730: 6e6f 7420 4e6f 6e65 2061 6e64 2069 7369  not None and isi
+00004740: 6e73 7461 6e63 6528 6f62 6a2c 2041 7272  nstance(obj, Arr
+00004750: 6179 293a 0a20 2020 2020 2020 2020 2020  ay):.           
+00004760: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+00004770: 7374 616e 6365 2872 6574 7661 6c2c 2041  stance(retval, A
+00004780: 7272 6179 2920 616e 6420 6571 7561 6c73  rray) and equals
+00004790: 6861 7065 2872 6574 7661 6c2e 7368 6170  hape(retval.shap
+000047a0: 652c 206f 626a 2e73 6861 7065 292c 2027  e, obj.shape), '
+000047b0: 7b30 7d2e 5f6f 7074 696d 697a 6564 5f66  {0}._optimized_f
+000047c0: 6f72 5f6e 756d 7079 206f 7220 7b30 7d2e  or_numpy or {0}.
+000047d0: 5f73 696d 706c 6966 6965 6420 7265 7375  _simplified resu
+000047e0: 6c74 6564 2069 6e20 7368 6170 6520 6368  lted in shape ch
+000047f0: 616e 6765 272e 666f 726d 6174 2874 7970  ange'.format(typ
+00004800: 6528 6f62 6a29 2e5f 5f6e 616d 655f 5f29  e(obj).__name__)
+00004810: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00004820: 7572 6e20 7265 7476 616c 0a0a 2020 2020  urn retval..    
+00004830: 6465 6620 5f6f 7074 696d 697a 6564 5f66  def _optimized_f
+00004840: 6f72 5f6e 756d 7079 2873 656c 6629 3a0a  or_numpy(self):.
+00004850: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00004860: 2020 2020 4063 6163 6865 645f 7072 6f70      @cached_prop
+00004870: 6572 7479 0a20 2020 2064 6566 205f 6c6f  erty.    def _lo
+00004880: 6f70 5f63 6f6e 6361 7465 6e61 7465 5f64  op_concatenate_d
+00004890: 6570 7328 7365 6c66 293a 0a20 2020 2020  eps(self):.     
+000048a0: 2020 2064 6570 7320 3d20 5b5d 0a20 2020     deps = [].   
+000048b0: 2020 2020 2066 6f72 2061 7267 2069 6e20       for arg in 
+000048c0: 7365 6c66 2e5f 5f61 7267 733a 0a20 2020  self.__args:.   
+000048d0: 2020 2020 2020 2020 2064 6570 7320 2b3d           deps +=
+000048e0: 205b 6465 7020 666f 7220 6465 7020 696e   [dep for dep in
+000048f0: 2061 7267 2e5f 6c6f 6f70 5f63 6f6e 6361   arg._loop_conca
+00004900: 7465 6e61 7465 5f64 6570 7320 6966 2064  tenate_deps if d
+00004910: 6570 206e 6f74 2069 6e20 6465 7073 5d0a  ep not in deps].
+00004920: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+00004930: 7570 6c65 2864 6570 7329 0a0a 2020 2020  uple(deps)..    
+00004940: 6465 6620 5f63 6f6d 6269 6e65 5f6c 6f6f  def _combine_loo
+00004950: 705f 636f 6e63 6174 656e 6174 6573 2873  p_concatenates(s
+00004960: 656c 662c 206f 7574 6572 5f65 7863 6c75  elf, outer_exclu
+00004970: 6465 293a 0a20 2020 2020 2020 2077 6869  de):.        whi
+00004980: 6c65 2054 7275 653a 0a20 2020 2020 2020  le True:.       
+00004990: 2020 2020 2065 7863 6c75 6465 203d 2073       exclude = s
+000049a0: 6574 286f 7574 6572 5f65 7863 6c75 6465  et(outer_exclude
+000049b0: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
+000049c0: 6d62 696e 6520 3d20 7b7d 0a20 2020 2020  mbine = {}.     
+000049d0: 2020 2020 2020 2023 2043 6f6c 6c65 6374         # Collect
+000049e0: 2061 6c6c 2074 6f70 2d6c 6576 656c 2060   all top-level `
+000049f0: 4c6f 6f70 436f 6e63 6174 656e 6174 6560  LoopConcatenate`
+00004a00: 2069 6e73 7461 6e63 6573 2069 6e20 6063   instances in `c
+00004a10: 6f6d 6269 6e65 6020 616e 6420 616c 6c0a  ombine` and all.
+00004a20: 2020 2020 2020 2020 2020 2020 2320 7468              # th
+00004a30: 6569 7220 6465 7065 6e64 656e 7420 604c  eir dependent `L
+00004a40: 6f6f 7043 6f6e 6361 7465 6e61 7465 6020  oopConcatenate` 
+00004a50: 696e 7374 616e 6365 7320 696e 2060 6578  instances in `ex
+00004a60: 636c 7564 6560 2e0a 2020 2020 2020 2020  clude`..        
+00004a70: 2020 2020 666f 7220 6c63 2069 6e20 7365      for lc in se
+00004a80: 6c66 2e5f 6c6f 6f70 5f63 6f6e 6361 7465  lf._loop_concate
+00004a90: 6e61 7465 5f64 6570 733a 0a20 2020 2020  nate_deps:.     
+00004aa0: 2020 2020 2020 2020 2020 206c 6373 203d             lcs =
+00004ab0: 2063 6f6d 6269 6e65 2e73 6574 6465 6661   combine.setdefa
+00004ac0: 756c 7428 6c63 2e69 6e64 6578 2c20 5b5d  ult(lc.index, []
+00004ad0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00004ae0: 2020 6966 206c 6320 6e6f 7420 696e 206c    if lc not in l
+00004af0: 6373 3a0a 2020 2020 2020 2020 2020 2020  cs:.            
+00004b00: 2020 2020 2020 2020 6c63 732e 6170 7065          lcs.appe
+00004b10: 6e64 286c 6329 0a20 2020 2020 2020 2020  nd(lc).         
+00004b20: 2020 2020 2020 2020 2020 2065 7863 6c75             exclu
+00004b30: 6465 2e75 7064 6174 6528 7365 7428 6c63  de.update(set(lc
+00004b40: 2e5f 6c6f 6f70 5f63 6f6e 6361 7465 6e61  ._loop_concatena
+00004b50: 7465 5f64 6570 7329 202d 207b 6c63 7d29  te_deps) - {lc})
+00004b60: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+00004b70: 6f6d 6269 6e65 2074 6f70 2d6c 6576 656c  ombine top-level
+00004b80: 2060 4c6f 6f70 436f 6e63 6174 656e 6174   `LoopConcatenat
+00004b90: 6560 2069 6e73 7461 6e63 6573 2065 7863  e` instances exc
+00004ba0: 6c75 6469 6e67 2074 686f 7365 2069 6e0a  luding those in.
+00004bb0: 2020 2020 2020 2020 2020 2020 2320 6065              # `e
+00004bc0: 7863 6c75 6465 602e 0a20 2020 2020 2020  xclude`..       
+00004bd0: 2020 2020 2072 6570 6c61 6365 6d65 6e74       replacement
+00004be0: 7320 3d20 7b7d 0a20 2020 2020 2020 2020  s = {}.         
+00004bf0: 2020 2066 6f72 2069 6e64 6578 2c20 6c63     for index, lc
+00004c00: 7320 696e 2063 6f6d 6269 6e65 2e69 7465  s in combine.ite
+00004c10: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00004c20: 2020 2020 2020 6c63 7320 3d20 5b6c 6320        lcs = [lc 
+00004c30: 666f 7220 6c63 2069 6e20 6c63 7320 6966  for lc in lcs if
+00004c40: 206c 6320 6e6f 7420 696e 2065 7863 6c75   lc not in exclu
+00004c50: 6465 5d0a 2020 2020 2020 2020 2020 2020  de].            
+00004c60: 2020 2020 6966 206e 6f74 206c 6373 3a0a      if not lcs:.
+00004c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c80: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+00004c90: 2020 2020 2020 2020 2020 2020 2023 2057               # W
+00004ca0: 6527 7265 2065 7874 7261 6374 696e 6720  e're extracting 
+00004cb0: 6461 7461 2066 726f 6d20 604c 6f6f 7043  data from `LoopC
+00004cc0: 6f6e 6361 7465 6e61 7465 6020 696e 2066  oncatenate` in f
+00004cd0: 6176 6f72 206f 6620 7573 696e 670a 2020  avor of using.  
+00004ce0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00004cf0: 606c 6f6f 705f 636f 6e63 6174 656e 6174  `loop_concatenat
+00004d00: 655f 636f 6d62 696e 6564 286c 6373 2c20  e_combined(lcs, 
+00004d10: 2e2e 2e29 6020 6265 6361 7573 6520 7468  ...)` because th
+00004d20: 6520 6c61 7465 7220 7265 7175 6972 6573  e later requires
+00004d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004d40: 2023 2072 6561 7070 6c79 696e 6720 7369   # reapplying si
+00004d50: 6d70 6c69 6669 6361 7469 6f6e 7320 7468  mplifications th
+00004d60: 6174 2061 7265 2061 6c72 6561 6479 2061  at are already a
+00004d70: 7070 6c69 6564 2069 6e20 7468 6520 666f  pplied in the fo
+00004d80: 726d 6572 2e0a 2020 2020 2020 2020 2020  rmer..          
+00004d90: 2020 2020 2020 2320 466f 7220 6578 616d        # For exam
+00004da0: 706c 652c 2069 6e20 606c 6f6f 705f 636f  ple, in `loop_co
+00004db0: 6e63 6174 656e 6174 655f 636f 6d62 696e  ncatenate_combin
+00004dc0: 6564 6020 7468 6520 6f66 6673 6574 7320  ed` the offsets 
+00004dd0: 2875 7365 6420 6279 0a20 2020 2020 2020  (used by.       
+00004de0: 2020 2020 2020 2020 2023 2073 7461 7274           # start
+00004df0: 2c20 7374 6f70 2061 6e64 2074 6865 2063  , stop and the c
+00004e00: 6f6e 6361 7465 6e61 7469 6f6e 206c 656e  oncatenation len
+00004e10: 6774 6829 2061 7265 2066 6f72 6d65 6420  gth) are formed 
+00004e20: 6279 0a20 2020 2020 2020 2020 2020 2020  by.             
+00004e30: 2020 2023 2060 6c6f 6f70 5f63 6f6e 6361     # `loop_conca
+00004e40: 7465 6e61 7465 602d 696e 6720 6066 756e  tenate`-ing `fun
+00004e50: 632e 7368 6170 655b 2d31 5d60 2e20 4966  c.shape[-1]`. If
+00004e60: 2074 6865 2073 6861 7065 2069 7320 636f   the shape is co
+00004e70: 6e73 7461 6e74 2c0a 2020 2020 2020 2020  nstant,.        
+00004e80: 2020 2020 2020 2020 2320 7468 6973 2063          # this c
+00004e90: 616e 2062 6520 7369 6d70 6c69 6669 6564  an be simplified
+00004ea0: 2074 6f20 6120 6052 616e 6765 602e 0a20   to a `Range`.. 
+00004eb0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00004ec0: 6174 6120 3d20 5475 706c 6528 7475 706c  ata = Tuple(tupl
+00004ed0: 6528 5475 706c 6528 6c63 2e66 756e 6364  e(Tuple(lc.funcd
+00004ee0: 6174 6129 2066 6f72 206c 6320 696e 206c  ata) for lc in l
+00004ef0: 6373 2929 0a20 2020 2020 2020 2020 2020  cs)).           
+00004f00: 2020 2020 2023 2043 6f6d 6269 6e65 2060       # Combine `
+00004f10: 4c6f 6f70 436f 6e63 6174 656e 6174 6560  LoopConcatenate`
+00004f20: 2069 6e73 7461 6e63 6573 2069 6e20 6064   instances in `d
+00004f30: 6174 6160 2065 7863 6c75 6469 6e67 0a20  ata` excluding. 
+00004f40: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00004f50: 2060 6f75 7465 725f 6578 636c 7564 6560   `outer_exclude`
+00004f60: 2061 6e64 2074 686f 7365 2074 6861 7420   and those that 
+00004f70: 7769 6c6c 2062 6520 7072 6f63 6573 7365  will be processe
+00004f80: 6420 696e 2061 2073 7562 7365 7175 656e  d in a subsequen
+00004f90: 7420 6c6f 6f70 0a20 2020 2020 2020 2020  t loop.         
+00004fa0: 2020 2020 2020 2023 2028 7468 6520 7265         # (the re
+00004fb0: 6d61 696e 6465 7220 6f66 2060 6578 636c  mainder of `excl
+00004fc0: 7564 6560 292e 2054 6865 206c 6174 7465  ude`). The latte
+00004fd0: 7220 636f 6e73 6973 7473 206f 6620 6c6f  r consists of lo
+00004fe0: 6f70 7320 7468 6174 2061 7265 0a20 2020  ops that are.   
+00004ff0: 2020 2020 2020 2020 2020 2020 2023 2069               # i
+00005000: 6e76 6172 6961 6e74 2077 2e72 2e74 2e20  nvariant w.r.t. 
+00005010: 7468 6520 6375 7272 656e 7420 6c6f 6f70  the current loop
+00005020: 2060 696e 6465 7860 2e0a 2020 2020 2020   `index`..      
+00005030: 2020 2020 2020 2020 2020 6461 7461 203d            data =
+00005040: 2064 6174 612e 5f63 6f6d 6269 6e65 5f6c   data._combine_l
+00005050: 6f6f 705f 636f 6e63 6174 656e 6174 6573  oop_concatenates
+00005060: 2865 7863 6c75 6465 290a 2020 2020 2020  (exclude).      
+00005070: 2020 2020 2020 2020 2020 636f 6d62 696e            combin
+00005080: 6564 203d 204c 6f6f 7043 6f6e 6361 7465  ed = LoopConcate
+00005090: 6e61 7465 436f 6d62 696e 6564 2874 7570  nateCombined(tup
+000050a0: 6c65 286d 6170 2874 7570 6c65 2c20 6461  le(map(tuple, da
+000050b0: 7461 2929 2c20 696e 6465 782e 5f6e 616d  ta)), index._nam
+000050c0: 652c 2069 6e64 6578 2e6c 656e 6774 6829  e, index.length)
+000050d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000050e0: 2066 6f72 2069 2c20 6c63 2069 6e20 656e   for i, lc in en
+000050f0: 756d 6572 6174 6528 6c63 7329 3a0a 2020  umerate(lcs):.  
+00005100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005110: 2020 696e 7462 6f75 6e64 7320 3d20 6469    intbounds = di
+00005120: 6374 287a 6970 2828 275f 6c6f 7765 7227  ct(zip(('_lower'
+00005130: 2c20 275f 7570 7065 7227 292c 206c 632e  , '_upper'), lc.
+00005140: 5f69 6e74 626f 756e 6473 2929 2069 6620  _intbounds)) if 
+00005150: 6c63 2e64 7479 7065 203d 3d20 696e 7420  lc.dtype == int 
+00005160: 656c 7365 207b 7d0a 2020 2020 2020 2020  else {}.        
+00005170: 2020 2020 2020 2020 2020 2020 7265 706c              repl
+00005180: 6163 656d 656e 7473 5b6c 635d 203d 2041  acements[lc] = A
+00005190: 7272 6179 4672 6f6d 5475 706c 6528 636f  rrayFromTuple(co
+000051a0: 6d62 696e 6564 2c20 692c 206c 632e 7368  mbined, i, lc.sh
+000051b0: 6170 652c 206c 632e 6474 7970 652c 202a  ape, lc.dtype, *
+000051c0: 2a69 6e74 626f 756e 6473 290a 2020 2020  *intbounds).    
+000051d0: 2020 2020 2020 2020 6966 2072 6570 6c61          if repla
+000051e0: 6365 6d65 6e74 733a 0a20 2020 2020 2020  cements:.       
+000051f0: 2020 2020 2020 2020 2073 656c 6620 3d20           self = 
+00005200: 7265 706c 6163 6528 6c61 6d62 6461 206b  replace(lambda k
+00005210: 6579 3a20 7265 706c 6163 656d 656e 7473  ey: replacements
+00005220: 2e67 6574 286b 6579 2920 6966 2069 7369  .get(key) if isi
+00005230: 6e73 7461 6e63 6528 6b65 792c 204c 6f6f  nstance(key, Loo
+00005240: 7043 6f6e 6361 7465 6e61 7465 2920 656c  pConcatenate) el
+00005250: 7365 204e 6f6e 652c 2072 6563 7572 7369  se None, recursi
+00005260: 7665 3d46 616c 7365 2c20 6465 7074 6866  ve=False, depthf
+00005270: 6972 7374 3d46 616c 7365 2928 7365 6c66  irst=False)(self
+00005280: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00005290: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000052a0: 2020 2020 7265 7475 726e 2073 656c 660a      return self.
+000052b0: 0a0a 636c 6173 7320 4556 414c 4152 4753  ..class EVALARGS
+000052c0: 2845 7661 6c75 6162 6c65 293a 0a20 2020  (Evaluable):.   
+000052d0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+000052e0: 6c66 293a 0a20 2020 2020 2020 2073 7570  lf):.        sup
+000052f0: 6572 2829 2e5f 5f69 6e69 745f 5f28 6172  er().__init__(ar
+00005300: 6773 3d28 2929 0a0a 2020 2020 6465 6620  gs=())..    def 
+00005310: 5f6e 6f64 6528 7365 6c66 2c20 6361 6368  _node(self, cach
+00005320: 652c 2073 7562 6772 6170 682c 2074 696d  e, subgraph, tim
+00005330: 6573 293a 0a20 2020 2020 2020 2072 6574  es):.        ret
+00005340: 7572 6e20 496e 7669 7369 626c 654e 6f64  urn InvisibleNod
+00005350: 6528 2874 7970 6528 7365 6c66 292e 5f5f  e((type(self).__
+00005360: 6e61 6d65 5f5f 2c20 5f53 7461 7473 2829  name__, _Stats()
+00005370: 2929 0a0a 0a45 5641 4c41 5247 5320 3d20  ))...EVALARGS = 
+00005380: 4556 414c 4152 4753 2829 0a0a 0a63 6c61  EVALARGS()...cla
+00005390: 7373 2045 7661 6c75 6162 6c65 436f 6e73  ss EvaluableCons
+000053a0: 7461 6e74 2845 7661 6c75 6162 6c65 293a  tant(Evaluable):
+000053b0: 0a20 2020 2027 2727 4576 616c 7561 7465  .    '''Evaluate
+000053c0: 2074 6f20 7468 6520 6769 7665 6e20 636f   to the given co
+000053d0: 6e73 7461 6e74 2076 616c 7565 2e0a 0a20  nstant value... 
+000053e0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+000053f0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00005400: 2076 616c 7565 0a20 2020 2020 2020 2054   value.        T
+00005410: 6865 2072 6574 7572 6e20 7661 6c75 6520  he return value 
+00005420: 6f66 2060 6065 7661 6c60 602e 0a20 2020  of ``eval``..   
+00005430: 2027 2727 0a0a 2020 2020 6465 6620 5f5f   '''..    def __
+00005440: 696e 6974 5f5f 2873 656c 662c 2076 616c  init__(self, val
+00005450: 7565 293a 0a20 2020 2020 2020 2073 656c  ue):.        sel
+00005460: 662e 7661 6c75 6520 3d20 7661 6c75 650a  f.value = value.
+00005470: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+00005480: 5f5f 696e 6974 5f5f 2828 2929 0a0a 2020  __init__(())..  
+00005490: 2020 6465 6620 6576 616c 6628 7365 6c66    def evalf(self
+000054a0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+000054b0: 6e20 7365 6c66 2e76 616c 7565 0a0a 2020  n self.value..  
+000054c0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+000054d0: 6465 6620 5f6e 6f64 655f 6465 7461 696c  def _node_detail
+000054e0: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+000054f0: 2073 203d 2072 6570 7228 7365 6c66 2e76   s = repr(self.v
+00005500: 616c 7565 290a 2020 2020 2020 2020 6966  alue).        if
+00005510: 2027 5c6e 2720 696e 2073 3a0a 2020 2020   '\n' in s:.    
+00005520: 2020 2020 2020 2020 7320 3d20 732e 7370          s = s.sp
+00005530: 6c69 7428 275c 6e27 2c20 3129 5b30 5d20  lit('\n', 1)[0] 
+00005540: 2b20 272e 2e2e 270a 2020 2020 2020 2020  + '...'.        
+00005550: 6966 206c 656e 2873 2920 3e20 3230 3a0a  if len(s) > 20:.
+00005560: 2020 2020 2020 2020 2020 2020 7320 3d20              s = 
+00005570: 735b 3a31 375d 202b 2027 2e2e 2e27 0a20  s[:17] + '...'. 
+00005580: 2020 2020 2020 2072 6574 7572 6e20 730a         return s.
+00005590: 0a0a 636c 6173 7320 5475 706c 6528 4576  ..class Tuple(Ev
+000055a0: 616c 7561 626c 6529 3a0a 0a20 2020 2064  aluable):..    d
+000055b0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+000055c0: 2c20 6974 656d 7329 3a0a 2020 2020 2020  , items):.      
+000055d0: 2020 7365 6c66 2e69 7465 6d73 203d 2069    self.items = i
+000055e0: 7465 6d73 0a20 2020 2020 2020 2073 7570  tems.        sup
+000055f0: 6572 2829 2e5f 5f69 6e69 745f 5f28 6974  er().__init__(it
+00005600: 656d 7329 0a0a 2020 2020 4073 7461 7469  ems)..    @stati
+00005610: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
+00005620: 6576 616c 6628 2a69 7465 6d73 293a 0a20  evalf(*items):. 
+00005630: 2020 2020 2020 2072 6574 7572 6e20 6974         return it
+00005640: 656d 730a 0a20 2020 2064 6566 205f 5f69  ems..    def __i
+00005650: 7465 725f 5f28 7365 6c66 293a 0a20 2020  ter__(self):.   
+00005660: 2020 2020 2027 6974 6572 6174 6527 0a0a       'iterate'..
+00005670: 2020 2020 2020 2020 7265 7475 726e 2069          return i
+00005680: 7465 7228 7365 6c66 2e69 7465 6d73 290a  ter(self.items).
+00005690: 0a20 2020 2064 6566 205f 5f6c 656e 5f5f  .    def __len__
+000056a0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000056b0: 276c 656e 6774 6827 0a0a 2020 2020 2020  'length'..      
+000056c0: 2020 7265 7475 726e 206c 656e 2873 656c    return len(sel
+000056d0: 662e 6974 656d 7329 0a0a 2020 2020 6465  f.items)..    de
+000056e0: 6620 5f5f 6765 7469 7465 6d5f 5f28 7365  f __getitem__(se
+000056f0: 6c66 2c20 6974 656d 293a 0a20 2020 2020  lf, item):.     
+00005700: 2020 2027 6765 7420 6974 656d 270a 0a20     'get item'.. 
+00005710: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00005720: 6c66 2e69 7465 6d73 5b69 7465 6d5d 0a0a  lf.items[item]..
+00005730: 2020 2020 6465 6620 5f5f 6164 645f 5f28      def __add__(
+00005740: 7365 6c66 2c20 6f74 6865 7229 3a0a 2020  self, other):.  
+00005750: 2020 2020 2020 2761 6464 270a 0a20 2020        'add'..   
+00005760: 2020 2020 2072 6574 7572 6e20 5475 706c       return Tupl
+00005770: 6528 7365 6c66 2e69 7465 6d73 202b 2074  e(self.items + t
+00005780: 7570 6c65 286f 7468 6572 2929 0a0a 2020  uple(other))..  
+00005790: 2020 6465 6620 5f5f 7261 6464 5f5f 2873    def __radd__(s
+000057a0: 656c 662c 206f 7468 6572 293a 0a20 2020  elf, other):.   
+000057b0: 2020 2020 2027 6164 6427 0a0a 2020 2020       'add'..    
+000057c0: 2020 2020 7265 7475 726e 2054 7570 6c65      return Tuple
+000057d0: 2874 7570 6c65 286f 7468 6572 2920 2b20  (tuple(other) + 
+000057e0: 7365 6c66 2e69 7465 6d73 290a 0a0a 2320  self.items)...# 
+000057f0: 4152 5241 5946 554e 430a 230a 2320 5468  ARRAYFUNC.#.# Th
+00005800: 6520 6d61 696e 2065 7661 6c75 6162 6c65  e main evaluable
+00005810: 2e20 436c 6f73 656c 7920 6d69 6d69 6373  . Closely mimics
+00005820: 2061 206e 756d 7079 2061 7272 6179 2e0a   a numpy array..
+00005830: 0a0a 6465 6620 6164 6428 6172 6730 2c20  ..def add(arg0, 
+00005840: 2a61 7267 7329 3a0a 2020 2020 666f 7220  *args):.    for 
+00005850: 6172 6731 2069 6e20 6172 6773 3a0a 2020  arg1 in args:.  
+00005860: 2020 2020 2020 6172 6730 203d 2041 6464        arg0 = Add
+00005870: 2874 7970 6573 2e66 726f 7a65 6e6d 756c  (types.frozenmul
+00005880: 7469 7365 7428 5f6e 756d 7079 5f61 6c69  tiset(_numpy_ali
+00005890: 676e 2861 7267 302c 2061 7267 3129 2929  gn(arg0, arg1)))
+000058a0: 0a20 2020 2072 6574 7572 6e20 6172 6730  .    return arg0
+000058b0: 0a0a 0a64 6566 206d 756c 7469 706c 7928  ...def multiply(
+000058c0: 6172 6730 2c20 2a61 7267 7329 3a0a 2020  arg0, *args):.  
+000058d0: 2020 666f 7220 6172 6731 2069 6e20 6172    for arg1 in ar
+000058e0: 6773 3a0a 2020 2020 2020 2020 6172 6730  gs:.        arg0
+000058f0: 203d 204d 756c 7469 706c 7928 7479 7065   = Multiply(type
+00005900: 732e 6672 6f7a 656e 6d75 6c74 6973 6574  s.frozenmultiset
+00005910: 285f 6e75 6d70 795f 616c 6967 6e28 6172  (_numpy_align(ar
+00005920: 6730 2c20 6172 6731 2929 290a 2020 2020  g0, arg1))).    
+00005930: 7265 7475 726e 2061 7267 300a 0a0a 6465  return arg0...de
+00005940: 6620 7375 6d28 6172 672c 2061 7869 733d  f sum(arg, axis=
+00005950: 4e6f 6e65 293a 0a20 2020 2027 2727 5375  None):.    '''Su
+00005960: 6d20 6172 7261 7920 656c 656d 656e 7473  m array elements
+00005970: 206f 7665 7220 6120 6769 7665 6e20 6178   over a given ax
+00005980: 6973 2e27 2727 0a0a 2020 2020 6966 2061  is.'''..    if a
+00005990: 7869 7320 6973 204e 6f6e 653a 0a20 2020  xis is None:.   
+000059a0: 2020 2020 2072 6574 7572 6e20 5375 6d28       return Sum(
+000059b0: 6172 6729 0a20 2020 2061 7865 7320 3d20  arg).    axes = 
+000059c0: 2861 7869 732c 2920 6966 206e 756d 6572  (axis,) if numer
+000059d0: 6963 2e69 7369 6e74 2861 7869 7329 2065  ic.isint(axis) e
+000059e0: 6c73 6520 6178 6973 0a20 2020 2073 756d  lse axis.    sum
+000059f0: 6d65 6420 3d20 5472 616e 7370 6f73 652e  med = Transpose.
+00005a00: 746f 5f65 6e64 2861 7267 2c20 2a61 7865  to_end(arg, *axe
+00005a10: 7329 0a20 2020 2066 6f72 2069 2069 6e20  s).    for i in 
+00005a20: 7261 6e67 6528 6c65 6e28 6178 6573 2929  range(len(axes))
+00005a30: 3a0a 2020 2020 2020 2020 7375 6d6d 6564  :.        summed
+00005a40: 203d 2053 756d 2873 756d 6d65 6429 0a20   = Sum(summed). 
+00005a50: 2020 2072 6574 7572 6e20 7375 6d6d 6564     return summed
+00005a60: 0a0a 0a64 6566 2070 726f 6475 6374 2861  ...def product(a
+00005a70: 7267 2c20 6178 6973 293a 0a20 2020 2072  rg, axis):.    r
+00005a80: 6574 7572 6e20 5072 6f64 7563 7428 5472  eturn Product(Tr
+00005a90: 616e 7370 6f73 652e 746f 5f65 6e64 2861  anspose.to_end(a
+00005aa0: 7267 2c20 6178 6973 2929 0a0a 0a64 6566  rg, axis))...def
+00005ab0: 2070 6f77 6572 2861 7267 2c20 6e29 3a0a   power(arg, n):.
+00005ac0: 2020 2020 6172 672c 206e 203d 205f 6e75      arg, n = _nu
+00005ad0: 6d70 795f 616c 6967 6e28 6172 672c 206e  mpy_align(arg, n
+00005ae0: 290a 2020 2020 7265 7475 726e 2050 6f77  ).    return Pow
+00005af0: 6572 2861 7267 2c20 6e29 0a0a 0a64 6566  er(arg, n)...def
+00005b00: 2064 6f74 2861 2c20 622c 2061 7865 7329   dot(a, b, axes)
+00005b10: 3a0a 2020 2020 2727 270a 2020 2020 436f  :.    '''.    Co
+00005b20: 6e74 7261 6374 2060 6061 6060 2061 6e64  ntract ``a`` and
+00005b30: 2060 6062 6060 2061 6c6f 6e67 2060 6061   ``b`` along ``a
+00005b40: 7865 7360 602e 0a20 2020 2027 2727 0a0a  xes``..    '''..
+00005b50: 2020 2020 7265 7475 726e 206d 756c 7469      return multi
+00005b60: 706c 7928 612c 2062 292e 7375 6d28 6178  ply(a, b).sum(ax
+00005b70: 6573 290a 0a0a 6465 6620 636f 6e6a 7567  es)...def conjug
+00005b80: 6174 6528 6172 6729 3a0a 2020 2020 6172  ate(arg):.    ar
+00005b90: 6720 3d20 6173 6172 7261 7928 6172 6729  g = asarray(arg)
+00005ba0: 0a20 2020 2069 6620 6172 672e 6474 7970  .    if arg.dtyp
+00005bb0: 6520 3d3d 2063 6f6d 706c 6578 3a0a 2020  e == complex:.  
+00005bc0: 2020 2020 2020 7265 7475 726e 2043 6f6e        return Con
+00005bd0: 6a75 6761 7465 2861 7267 290a 2020 2020  jugate(arg).    
+00005be0: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
+00005bf0: 7475 726e 2061 7267 0a0a 0a63 6f6e 6a75  turn arg...conju
+00005c00: 6761 7465 0a0a 0a64 6566 2072 6561 6c28  gate...def real(
+00005c10: 6172 6729 3a0a 2020 2020 6172 6720 3d20  arg):.    arg = 
+00005c20: 6173 6172 7261 7928 6172 6729 0a20 2020  asarray(arg).   
+00005c30: 2069 6620 6172 672e 6474 7970 6520 3d3d   if arg.dtype ==
+00005c40: 2063 6f6d 706c 6578 3a0a 2020 2020 2020   complex:.      
+00005c50: 2020 7265 7475 726e 2052 6561 6c28 6172    return Real(ar
+00005c60: 6729 0a20 2020 2065 6c73 653a 0a20 2020  g).    else:.   
+00005c70: 2020 2020 2072 6574 7572 6e20 6172 670a       return arg.
+00005c80: 0a0a 6465 6620 696d 6167 2861 7267 293a  ..def imag(arg):
+00005c90: 0a20 2020 2061 7267 203d 2061 7361 7272  .    arg = asarr
+00005ca0: 6179 2861 7267 290a 2020 2020 6966 2061  ay(arg).    if a
+00005cb0: 7267 2e64 7479 7065 203d 3d20 636f 6d70  rg.dtype == comp
+00005cc0: 6c65 783a 0a20 2020 2020 2020 2072 6574  lex:.        ret
+00005cd0: 7572 6e20 496d 6167 2861 7267 290a 2020  urn Imag(arg).  
+00005ce0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00005cf0: 7265 7475 726e 207a 6572 6f73 5f6c 696b  return zeros_lik
+00005d00: 6528 6172 6729 0a0a 0a64 6566 2074 7261  e(arg)...def tra
+00005d10: 6e73 706f 7365 2861 7267 2c20 7472 616e  nspose(arg, tran
+00005d20: 733d 4e6f 6e65 293a 0a20 2020 2061 7267  s=None):.    arg
+00005d30: 203d 2061 7361 7272 6179 2861 7267 290a   = asarray(arg).
+00005d40: 2020 2020 6966 2074 7261 6e73 2069 7320      if trans is 
+00005d50: 4e6f 6e65 3a0a 2020 2020 2020 2020 6e6f  None:.        no
+00005d60: 726d 7472 616e 7320 3d20 7475 706c 6528  rmtrans = tuple(
+00005d70: 7261 6e67 6528 6172 672e 6e64 696d 2d31  range(arg.ndim-1
+00005d80: 2c20 2d31 2c20 2d31 2929 0a20 2020 2065  , -1, -1)).    e
+00005d90: 6c73 653a 0a20 2020 2020 2020 206e 6f72  lse:.        nor
+00005da0: 6d74 7261 6e73 203d 2074 7570 6c65 286e  mtrans = tuple(n
+00005db0: 756d 6572 6963 2e6e 6f72 6d64 696d 2861  umeric.normdim(a
+00005dc0: 7267 2e6e 6469 6d2c 2073 6829 2e5f 5f69  rg.ndim, sh).__i
+00005dd0: 6e64 6578 5f5f 2829 2066 6f72 2073 6820  ndex__() for sh 
+00005de0: 696e 2074 7261 6e73 290a 2020 2020 2020  in trans).      
+00005df0: 2020 6173 7365 7274 2073 6f72 7465 6428    assert sorted(
+00005e00: 6e6f 726d 7472 616e 7329 203d 3d20 6c69  normtrans) == li
+00005e10: 7374 2872 616e 6765 2861 7267 2e6e 6469  st(range(arg.ndi
+00005e20: 6d29 290a 2020 2020 7265 7475 726e 2054  m)).    return T
+00005e30: 7261 6e73 706f 7365 2861 7267 2c20 6e6f  ranspose(arg, no
+00005e40: 726d 7472 616e 7329 0a0a 0a64 6566 2073  rmtrans)...def s
+00005e50: 7761 7061 7865 7328 6172 672c 2061 7869  wapaxes(arg, axi
+00005e60: 7331 2c20 6178 6973 3229 3a0a 2020 2020  s1, axis2):.    
+00005e70: 6172 6720 3d20 6173 6172 7261 7928 6172  arg = asarray(ar
+00005e80: 6729 0a20 2020 2074 7261 6e73 203d 206e  g).    trans = n
+00005e90: 756d 7079 2e61 7261 6e67 6528 6172 672e  umpy.arange(arg.
+00005ea0: 6e64 696d 290a 2020 2020 7472 616e 735b  ndim).    trans[
+00005eb0: 6178 6973 315d 2c20 7472 616e 735b 6178  axis1], trans[ax
+00005ec0: 6973 325d 203d 2074 7261 6e73 5b61 7869  is2] = trans[axi
+00005ed0: 7332 5d2c 2074 7261 6e73 5b61 7869 7331  s2], trans[axis1
+00005ee0: 5d0a 2020 2020 7265 7475 726e 2074 7261  ].    return tra
+00005ef0: 6e73 706f 7365 2861 7267 2c20 7472 616e  nspose(arg, tran
+00005f00: 7329 0a0a 0a64 6566 2061 6c69 676e 2861  s)...def align(a
+00005f10: 7267 2c20 7768 6572 652c 2073 6861 7065  rg, where, shape
+00005f20: 293a 0a20 2020 2027 2727 416c 6967 6e20  ):.    '''Align 
+00005f30: 6172 7261 7920 746f 2074 6172 6765 7420  array to target 
+00005f40: 7368 6170 652e 0a0a 2020 2020 5468 6520  shape...    The 
+00005f50: 616c 6967 6e20 6f70 6572 6174 696f 6e20  align operation 
+00005f60: 6361 6e20 6265 2063 6f6e 7369 6465 7265  can be considere
+00005f70: 6420 7468 6520 6f70 706f 7369 7465 206f  d the opposite o
+00005f80: 6620 7472 616e 7370 6f73 653a 2069 6e73  f transpose: ins
+00005f90: 7465 6164 206f 660a 2020 2020 7370 6563  tead of.    spec
+00005fa0: 6966 7969 6e67 2066 6f72 2065 6163 6820  ifying for each 
+00005fb0: 6178 6973 206f 6620 7468 6520 7265 7475  axis of the retu
+00005fc0: 726e 2076 616c 7565 2074 6865 206f 7269  rn value the ori
+00005fd0: 6769 6e61 6c20 706f 7369 7469 6f6e 2069  ginal position i
+00005fe0: 6e20 7468 650a 2020 2020 6172 6775 6d65  n the.    argume
+00005ff0: 6e74 2c20 616c 6967 6e20 7370 6563 6966  nt, align specif
+00006000: 6965 7320 666f 7220 6561 6368 2061 7869  ies for each axi
+00006010: 7320 6f66 2074 6865 2061 7267 756d 656e  s of the argumen
+00006020: 7420 7468 6520 6e65 7720 706f 7369 7469  t the new positi
+00006030: 6f6e 2069 6e0a 2020 2020 7468 6520 7265  on in.    the re
+00006040: 7475 726e 2076 616c 7565 2e20 496e 2061  turn value. In a
+00006050: 6464 6974 696f 6e2c 2074 6865 2072 6574  ddition, the ret
+00006060: 7572 6e20 7661 6c75 6520 6d61 7920 6265  urn value may be
+00006070: 206f 6620 6869 6768 6572 2064 696d 656e   of higher dimen
+00006080: 7369 6f6e 2c0a 2020 2020 7769 7468 206e  sion,.    with n
+00006090: 6577 2061 7865 7320 6265 696e 6720 696e  ew axes being in
+000060a0: 7365 7274 6564 2061 6363 6f72 6469 6e67  serted according
+000060b0: 2074 6f20 7468 6520 6060 7368 6170 6560   to the ``shape`
+000060c0: 6020 6172 6775 6d65 6e74 2e0a 0a20 2020  ` argument...   
+000060d0: 2041 7267 730a 2020 2020 2d2d 2d2d 0a20   Args.    ----. 
+000060e0: 2020 2061 7267 203a 203a 636c 6173 733a     arg : :class:
+000060f0: 6041 7272 6179 600a 2020 2020 2020 2020  `Array`.        
+00006100: 4f72 6967 696e 616c 2061 7272 6179 2e0a  Original array..
+00006110: 2020 2020 7768 6572 6520 3a20 3a63 6c61      where : :cla
+00006120: 7373 3a60 7475 706c 6560 206f 6620 696e  ss:`tuple` of in
+00006130: 7465 6765 7273 0a20 2020 2020 2020 204e  tegers.        N
+00006140: 6577 2061 7869 7320 706f 7369 7469 6f6e  ew axis position
+00006150: 732e 0a20 2020 2073 6861 7065 203a 203a  s..    shape : :
+00006160: 636c 6173 733a 6074 7570 6c65 600a 2020  class:`tuple`.  
+00006170: 2020 2020 2020 5368 6170 6520 6f66 2074        Shape of t
+00006180: 6865 2061 6c69 676e 6564 2061 7272 6179  he aligned array
+00006190: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
+000061a0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 203a     -------.    :
+000061b0: 636c 6173 733a 6041 7272 6179 600a 2020  class:`Array`.  
+000061c0: 2020 2020 2020 5468 6520 616c 6967 6e65        The aligne
+000061d0: 6420 6172 7261 792e 0a20 2020 2027 2727  d array..    '''
+000061e0: 0a0a 2020 2020 7768 6572 6520 3d20 6c69  ..    where = li
+000061f0: 7374 2877 6865 7265 290a 2020 2020 666f  st(where).    fo
+00006200: 7220 692c 206c 656e 6774 6820 696e 2065  r i, length in e
+00006210: 6e75 6d65 7261 7465 2873 6861 7065 293a  numerate(shape):
+00006220: 0a20 2020 2020 2020 2069 6620 6920 6e6f  .        if i no
+00006230: 7420 696e 2077 6865 7265 3a0a 2020 2020  t in where:.    
+00006240: 2020 2020 2020 2020 6172 6720 3d20 496e          arg = In
+00006250: 7365 7274 4178 6973 2861 7267 2c20 6c65  sertAxis(arg, le
+00006260: 6e67 7468 290a 2020 2020 2020 2020 2020  ngth).          
+00006270: 2020 7768 6572 652e 6170 7065 6e64 2869    where.append(i
+00006280: 290a 2020 2020 6966 2077 6865 7265 2021  ).    if where !
+00006290: 3d20 6c69 7374 2872 616e 6765 286c 656e  = list(range(len
+000062a0: 2873 6861 7065 2929 293a 0a20 2020 2020  (shape))):.     
+000062b0: 2020 2061 7267 203d 2054 7261 6e73 706f     arg = Transpo
+000062c0: 7365 2e69 6e76 2861 7267 2c20 7768 6572  se.inv(arg, wher
+000062d0: 6529 0a20 2020 2061 7373 6572 7420 6571  e).    assert eq
+000062e0: 7561 6c73 6861 7065 2861 7267 2e73 6861  ualshape(arg.sha
+000062f0: 7065 2c20 7368 6170 6529 2c20 6627 6172  pe, shape), f'ar
+00006300: 672e 7368 6170 653d 7b61 7267 2e73 6861  g.shape={arg.sha
+00006310: 7065 2172 7d2c 2073 6861 7065 3d7b 7368  pe!r}, shape={sh
+00006320: 6170 6521 727d 270a 2020 2020 7265 7475  ape!r}'.    retu
+00006330: 726e 2061 7267 0a0a 0a64 6566 2075 6e61  rn arg...def una
+00006340: 6c69 676e 282a 6172 6773 2c20 6e61 7865  lign(*args, naxe
+00006350: 733a 2069 6e74 203d 204e 6f6e 6529 3a0a  s: int = None):.
+00006360: 2020 2020 2727 2752 656d 6f76 6520 286a      '''Remove (j
+00006370: 6f69 6e74 2920 696e 7365 7274 6564 2061  oint) inserted a
+00006380: 7865 732e 0a0a 2020 2020 4769 7665 6e20  xes...    Given 
+00006390: 6f6e 6520 6f72 206d 6f72 6520 6172 7261  one or more arra
+000063a0: 7920 6172 6775 6d65 6e74 732c 2072 6574  y arguments, ret
+000063b0: 7572 6e20 7468 6520 7368 6f72 7465 7374  urn the shortest
+000063c0: 2063 6f6d 6d6f 6e20 6178 6973 2076 6563   common axis vec
+000063d0: 746f 720a 2020 2020 616c 6f6e 6720 7769  tor.    along wi
+000063e0: 7468 2066 756e 6374 696f 6e20 6172 6775  th function argu
+000063f0: 6d65 6e74 7320 7375 6368 2074 6861 7420  ments such that 
+00006400: 7468 6520 6f72 6967 696e 616c 2061 7272  the original arr
+00006410: 6179 7320 6361 6e20 6265 0a20 2020 2072  ays can be.    r
+00006420: 6563 6f76 6572 6564 2062 7920 3a66 756e  ecovered by :fun
+00006430: 633a 6061 6c69 676e 602e 2041 7865 7320  c:`align`. Axes 
+00006440: 6265 796f 6e64 2074 6865 2066 6972 7374  beyond the first
+00006450: 2060 606e 6178 6573 6060 2061 7265 206e   ``naxes`` are n
+00006460: 6f74 0a20 2020 2063 6f6e 7369 6465 7265  ot.    considere
+00006470: 6420 666f 7220 7265 6d6f 7661 6c2c 206b  d for removal, k
+00006480: 6565 7020 7468 6569 7220 706f 7369 7469  eep their positi
+00006490: 6f6e 2028 6173 2073 6565 6e20 6672 6f6d  on (as seen from
+000064a0: 2074 6865 2072 6967 6874 292c 2061 6e64   the right), and
+000064b0: 0a20 2020 2061 7265 206e 6f74 2070 6172  .    are not par
+000064c0: 7420 6f66 2074 6865 2063 6f6d 6d6f 6e20  t of the common 
+000064d0: 6178 6973 2076 6563 746f 722e 2054 686f  axis vector. Tho
+000064e0: 7365 2061 7865 7320 7368 6f75 6c64 2062  se axes should b
+000064f0: 6520 6164 6465 6420 746f 2074 6865 0a20  e added to the. 
+00006500: 2020 2061 7869 7320 7665 6374 6f72 2062     axis vector b
+00006510: 6566 6f72 6520 6361 6c6c 696e 6720 3a66  efore calling :f
+00006520: 756e 633a 6061 6c69 676e 602e 0a0a 2020  unc:`align`...  
+00006530: 2020 4966 2060 606e 6178 6573 6060 2069    If ``naxes`` i
+00006540: 7320 6060 4e6f 6e65 6060 2028 7468 6520  s ``None`` (the 
+00006550: 6465 6661 756c 7429 2c20 616c 6c20 6172  default), all ar
+00006560: 6775 6d65 6e74 7320 6d75 7374 2068 6176  guments must hav
+00006570: 6520 7468 6520 7361 6d65 0a20 2020 206e  e the same.    n
+00006580: 756d 6265 7220 6f66 2061 7865 7320 616e  umber of axes an
+00006590: 6420 6060 6e61 7865 7360 6020 6973 2073  d ``naxes`` is s
+000065a0: 6574 2074 6f20 7468 6973 206e 756d 6265  et to this numbe
+000065b0: 722e 0a20 2020 2027 2727 0a0a 2020 2020  r..    '''..    
+000065c0: 6173 7365 7274 2061 7267 730a 2020 2020  assert args.    
+000065d0: 6966 206c 656e 2861 7267 7329 203d 3d20  if len(args) == 
+000065e0: 3120 616e 6420 6e61 7865 7320 6973 204e  1 and naxes is N
+000065f0: 6f6e 653a 0a20 2020 2020 2020 2072 6574  one:.        ret
+00006600: 7572 6e20 6172 6773 5b30 5d2e 5f75 6e61  urn args[0]._una
+00006610: 6c69 676e 6564 0a20 2020 2069 6620 6e61  ligned.    if na
+00006620: 7865 7320 6973 204e 6f6e 653a 0a20 2020  xes is None:.   
+00006630: 2020 2020 2069 6620 616e 7928 6172 672e       if any(arg.
+00006640: 6e64 696d 2021 3d20 6172 6773 5b30 5d2e  ndim != args[0].
+00006650: 6e64 696d 2066 6f72 2061 7267 2069 6e20  ndim for arg in 
+00006660: 6172 6773 5b31 3a5d 293a 0a20 2020 2020  args[1:]):.     
+00006670: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00006680: 7565 4572 726f 7228 2776 6172 7969 6e67  ueError('varying
+00006690: 2064 696d 656e 7369 6f6e 7320 696e 2075   dimensions in u
+000066a0: 6e61 6c69 676e 2729 0a20 2020 2020 2020  nalign').       
+000066b0: 206e 6178 6573 203d 2061 7267 735b 305d   naxes = args[0]
+000066c0: 2e6e 6469 6d0a 2020 2020 656c 6966 2061  .ndim.    elif a
+000066d0: 6e79 2861 7267 2e6e 6469 6d20 3c20 6e61  ny(arg.ndim < na
+000066e0: 7865 7320 666f 7220 6172 6720 696e 2061  xes for arg in a
+000066f0: 7267 7329 3a0a 2020 2020 2020 2020 7261  rgs):.        ra
+00006700: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
+00006710: 6f6e 6520 6f72 206d 6f72 6520 6172 6775  one or more argu
+00006720: 6d65 6e74 7320 6861 7665 2066 6577 6572  ments have fewer
+00006730: 2061 7865 7320 7468 616e 2065 7870 6563   axes than expec
+00006740: 7465 6427 290a 2020 2020 6e6f 6e69 6e73  ted').    nonins
+00006750: 203d 2066 756e 6374 6f6f 6c73 2e72 6564   = functools.red
+00006760: 7563 6528 6f70 6572 6174 6f72 2e6f 725f  uce(operator.or_
+00006770: 2c20 5b73 6574 2861 7267 2e5f 756e 616c  , [set(arg._unal
+00006780: 6967 6e65 645b 315d 2920 666f 7220 6172  igned[1]) for ar
+00006790: 6720 696e 2061 7267 735d 2920 2620 7365  g in args]) & se
+000067a0: 7428 7261 6e67 6528 6e61 7865 7329 290a  t(range(naxes)).
+000067b0: 2020 2020 6966 206c 656e 286e 6f6e 696e      if len(nonin
+000067c0: 7329 203d 3d20 6e61 7865 733a 0a20 2020  s) == naxes:.   
+000067d0: 2020 2020 2072 6574 7572 6e20 282a 6172       return (*ar
+000067e0: 6773 2c20 7475 706c 6528 7261 6e67 6528  gs, tuple(range(
+000067f0: 6e61 7865 7329 2929 0a20 2020 2072 6574  naxes))).    ret
+00006800: 203d 205b 5d0a 2020 2020 666f 7220 6172   = [].    for ar
+00006810: 6720 696e 2061 7267 733a 0a20 2020 2020  g in args:.     
+00006820: 2020 2075 6e61 6c69 676e 6564 2c20 7768     unaligned, wh
+00006830: 6572 6520 3d20 6172 672e 5f75 6e61 6c69  ere = arg._unali
+00006840: 676e 6564 0a20 2020 2020 2020 206b 6565  gned.        kee
+00006850: 7020 3d20 7475 706c 6528 7261 6e67 6528  p = tuple(range(
+00006860: 6e61 7865 732c 2061 7267 2e6e 6469 6d29  naxes, arg.ndim)
+00006870: 290a 2020 2020 2020 2020 666f 7220 6920  ).        for i 
+00006880: 696e 2073 6f72 7465 6428 286e 6f6e 696e  in sorted((nonin
+00006890: 7320 7c20 7365 7428 6b65 6570 2929 202d  s | set(keep)) -
+000068a0: 2073 6574 2877 6865 7265 2929 3a0a 2020   set(where)):.  
+000068b0: 2020 2020 2020 2020 2020 756e 616c 6967            unalig
+000068c0: 6e65 6420 3d20 496e 7365 7274 4178 6973  ned = InsertAxis
+000068d0: 2875 6e61 6c69 676e 6564 2c20 6172 672e  (unaligned, arg.
+000068e0: 7368 6170 655b 695d 290a 2020 2020 2020  shape[i]).      
+000068f0: 2020 2020 2020 7768 6572 6520 2b3d 2069        where += i
+00006900: 2c0a 2020 2020 2020 2020 6966 206e 6f74  ,.        if not
+00006910: 2072 6574 3a20 2023 2066 6972 7374 2061   ret:  # first a
+00006920: 7267 756d 656e 740a 2020 2020 2020 2020  rgument.        
+00006930: 2020 2020 636f 6d6d 6f6e 7768 6572 6520      commonwhere 
+00006940: 3d20 7475 706c 6528 6920 666f 7220 6920  = tuple(i for i 
+00006950: 696e 2077 6865 7265 2069 6620 6920 3c20  in where if i < 
+00006960: 6e61 7865 7329 0a20 2020 2020 2020 2069  naxes).        i
+00006970: 6620 7768 6572 6520 213d 2063 6f6d 6d6f  f where != commo
+00006980: 6e77 6865 7265 202b 206b 6565 703a 0a20  nwhere + keep:. 
+00006990: 2020 2020 2020 2020 2020 2075 6e61 6c69             unali
+000069a0: 676e 6564 203d 2054 7261 6e73 706f 7365  gned = Transpose
+000069b0: 2875 6e61 6c69 676e 6564 2c20 7475 706c  (unaligned, tupl
+000069c0: 6528 7768 6572 652e 696e 6465 7828 6e29  e(where.index(n)
+000069d0: 2066 6f72 206e 2069 6e20 636f 6d6d 6f6e   for n in common
+000069e0: 7768 6572 6520 2b20 6b65 6570 2929 0a20  where + keep)). 
+000069f0: 2020 2020 2020 2072 6574 2e61 7070 656e         ret.appen
+00006a00: 6428 756e 616c 6967 6e65 6429 0a20 2020  d(unaligned).   
+00006a10: 2072 6574 7572 6e20 282a 7265 742c 2063   return (*ret, c
+00006a20: 6f6d 6d6f 6e77 6865 7265 290a 0a23 2041  ommonwhere)..# A
+00006a30: 5252 4159 530a 0a0a 5f41 7272 6179 4d65  RRAYS..._ArrayMe
+00006a40: 7461 203d 2074 7970 6528 4576 616c 7561  ta = type(Evalua
+00006a50: 626c 6529 0a0a 6966 2064 6562 7567 5f66  ble)..if debug_f
+00006a60: 6c61 6773 2e73 7061 7273 653a 0a20 2020  lags.sparse:.   
+00006a70: 2064 6566 205f 6368 756e 6b65 645f 6173   def _chunked_as
+00006a80: 7370 6172 7365 5f63 6865 636b 6572 286f  sparse_checker(o
+00006a90: 7269 6729 3a0a 2020 2020 2020 2020 6173  rig):.        as
+00006aa0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00006ab0: 6f72 6967 2c20 6361 6368 6564 5f70 726f  orig, cached_pro
+00006ac0: 7065 7274 7929 0a0a 2020 2020 2020 2020  perty)..        
+00006ad0: 4063 6163 6865 645f 7072 6f70 6572 7479  @cached_property
+00006ae0: 0a20 2020 2020 2020 2064 6566 205f 6173  .        def _as
+00006af0: 7370 6172 7365 2873 656c 6629 3a0a 2020  sparse(self):.  
+00006b00: 2020 2020 2020 2020 2020 6368 756e 6b73            chunks
+00006b10: 203d 206f 7269 672e 6675 6e63 2873 656c   = orig.func(sel
+00006b20: 6629 0a20 2020 2020 2020 2020 2020 2061  f).            a
+00006b30: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00006b40: 2863 6875 6e6b 732c 2074 7570 6c65 290a  (chunks, tuple).
+00006b50: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00006b60: 7274 2061 6c6c 2869 7369 6e73 7461 6e63  rt all(isinstanc
+00006b70: 6528 6368 756e 6b2c 2074 7570 6c65 2920  e(chunk, tuple) 
+00006b80: 666f 7220 6368 756e 6b20 696e 2063 6875  for chunk in chu
+00006b90: 6e6b 7329 0a20 2020 2020 2020 2020 2020  nks).           
+00006ba0: 2061 7373 6572 7420 616c 6c28 616c 6c28   assert all(all(
+00006bb0: 6973 696e 7374 616e 6365 2869 7465 6d2c  isinstance(item,
+00006bc0: 2041 7272 6179 2920 666f 7220 6974 656d   Array) for item
+00006bd0: 2069 6e20 6368 756e 6b29 2066 6f72 2063   in chunk) for c
+00006be0: 6875 6e6b 2069 6e20 6368 756e 6b73 290a  hunk in chunks).
+00006bf0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00006c00: 656c 662e 6e64 696d 3a0a 2020 2020 2020  elf.ndim:.      
+00006c10: 2020 2020 2020 2020 2020 666f 7220 2a69            for *i
+00006c20: 6e64 6963 6573 2c20 7661 6c75 6573 2069  ndices, values i
+00006c30: 6e20 6368 756e 6b73 3a0a 2020 2020 2020  n chunks:.      
+00006c40: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00006c50: 7365 7274 206c 656e 2869 6e64 6963 6573  sert len(indices
+00006c60: 2920 3d3d 2073 656c 662e 6e64 696d 0a20  ) == self.ndim. 
+00006c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c80: 2020 2061 7373 6572 7420 616c 6c28 6964     assert all(id
+00006c90: 782e 6474 7970 6520 3d3d 2069 6e74 2066  x.dtype == int f
+00006ca0: 6f72 2069 6478 2069 6e20 696e 6469 6365  or idx in indice
+00006cb0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00006cc0: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
+00006cd0: 6c28 6571 7561 6c73 6861 7065 2869 6478  l(equalshape(idx
+00006ce0: 2e73 6861 7065 2c20 7661 6c75 6573 2e73  .shape, values.s
+00006cf0: 6861 7065 2920 666f 7220 6964 7820 696e  hape) for idx in
+00006d00: 2069 6e64 6963 6573 290a 2020 2020 2020   indices).      
+00006d10: 2020 2020 2020 656c 6966 2063 6875 6e6b        elif chunk
+00006d20: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00006d30: 2020 2061 7373 6572 7420 6c65 6e28 6368     assert len(ch
+00006d40: 756e 6b73 2920 3d3d 2031 0a20 2020 2020  unks) == 1.     
+00006d50: 2020 2020 2020 2020 2020 2063 6875 6e6b             chunk
+00006d60: 2c20 3d20 6368 756e 6b73 0a20 2020 2020  , = chunks.     
+00006d70: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00006d80: 7420 6c65 6e28 6368 756e 6b29 203d 3d20  t len(chunk) == 
+00006d90: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00006da0: 2020 7661 6c75 6573 2c20 3d20 6368 756e    values, = chun
+00006db0: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
+00006dc0: 2020 6173 7365 7274 2076 616c 7565 732e    assert values.
+00006dd0: 7368 6170 6520 3d3d 2028 290a 2020 2020  shape == ().    
+00006de0: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+00006df0: 6875 6e6b 730a 2020 2020 2020 2020 7265  hunks.        re
+00006e00: 7475 726e 205f 6173 7370 6172 7365 0a0a  turn _assparse..
+00006e10: 2020 2020 636c 6173 7320 5f41 7272 6179      class _Array
+00006e20: 4d65 7461 285f 4172 7261 794d 6574 6129  Meta(_ArrayMeta)
+00006e30: 3a0a 2020 2020 2020 2020 6465 6620 5f5f  :.        def __
+00006e40: 6e65 775f 5f28 6d63 6c73 2c20 6e61 6d65  new__(mcls, name
+00006e50: 2c20 6261 7365 732c 206e 616d 6573 7061  , bases, namespa
+00006e60: 6365 293a 0a20 2020 2020 2020 2020 2020  ce):.           
+00006e70: 2069 6620 275f 6173 7370 6172 7365 2720   if '_assparse' 
+00006e80: 696e 206e 616d 6573 7061 6365 3a0a 2020  in namespace:.  
+00006e90: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+00006ea0: 6d65 7370 6163 655b 275f 6173 7370 6172  mespace['_asspar
+00006eb0: 7365 275d 203d 205f 6368 756e 6b65 645f  se'] = _chunked_
+00006ec0: 6173 7370 6172 7365 5f63 6865 636b 6572  assparse_checker
+00006ed0: 286e 616d 6573 7061 6365 5b27 5f61 7373  (namespace['_ass
+00006ee0: 7061 7273 6527 5d29 0a20 2020 2020 2020  parse']).       
+00006ef0: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
+00006f00: 7228 292e 5f5f 6e65 775f 5f28 6d63 6c73  r().__new__(mcls
+00006f10: 2c20 6e61 6d65 2c20 6261 7365 732c 206e  , name, bases, n
+00006f20: 616d 6573 7061 6365 290a 0a69 6620 6465  amespace)..if de
+00006f30: 6275 675f 666c 6167 732e 6576 616c 663a  bug_flags.evalf:
+00006f40: 0a20 2020 2063 6c61 7373 205f 6576 616c  .    class _eval
+00006f50: 665f 6368 6563 6b65 723a 0a20 2020 2020  f_checker:.     
+00006f60: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00006f70: 7365 6c66 2c20 6f72 6967 293a 0a20 2020  self, orig):.   
+00006f80: 2020 2020 2020 2020 2073 656c 662e 6f72           self.or
+00006f90: 6967 203d 206f 7269 670a 0a20 2020 2020  ig = orig..     
+00006fa0: 2020 2064 6566 205f 5f73 6574 5f6e 616d     def __set_nam
+00006fb0: 655f 5f28 7365 6c66 2c20 6f77 6e65 722c  e__(self, owner,
+00006fc0: 206e 616d 6529 3a0a 2020 2020 2020 2020   name):.        
+00006fd0: 2020 2020 6966 2068 6173 6174 7472 2873      if hasattr(s
+00006fe0: 656c 662e 6f72 6967 2c20 275f 5f73 6574  elf.orig, '__set
+00006ff0: 5f6e 616d 655f 5f27 293a 0a20 2020 2020  _name__'):.     
+00007000: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00007010: 6f72 6967 2e5f 5f73 6574 5f6e 616d 655f  orig.__set_name_
+00007020: 5f28 6f77 6e65 722c 206e 616d 6529 0a0a  _(owner, name)..
+00007030: 2020 2020 2020 2020 6465 6620 5f5f 6765          def __ge
+00007040: 745f 5f28 7365 6c66 2c20 696e 7374 616e  t__(self, instan
+00007050: 6365 2c20 6f77 6e65 7229 3a0a 2020 2020  ce, owner):.    
+00007060: 2020 2020 2020 2020 6576 616c 6620 3d20          evalf = 
+00007070: 7365 6c66 2e6f 7269 672e 5f5f 6765 745f  self.orig.__get_
+00007080: 5f28 696e 7374 616e 6365 2c20 6f77 6e65  _(instance, owne
+00007090: 7229 0a0a 2020 2020 2020 2020 2020 2020  r)..            
+000070a0: 4066 756e 6374 6f6f 6c73 2e77 7261 7073  @functools.wraps
+000070b0: 2865 7661 6c66 290a 2020 2020 2020 2020  (evalf).        
+000070c0: 2020 2020 6465 6620 6576 616c 665f 7769      def evalf_wi
+000070d0: 7468 5f63 6865 636b 282a 6172 6773 2c20  th_check(*args, 
+000070e0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+000070f0: 2020 2020 2020 2020 2020 2072 6573 203d             res =
+00007100: 2065 7661 6c66 282a 6172 6773 2c20 2a2a   evalf(*args, **
+00007110: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+00007120: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00007130: 6f74 2068 6173 6174 7472 2869 6e73 7461  ot hasattr(insta
+00007140: 6e63 652c 2027 6474 7970 6527 2920 6f72  nce, 'dtype') or
+00007150: 2061 7364 7479 7065 2872 6573 2e64 7479   asdtype(res.dty
+00007160: 7065 2920 3d3d 2069 6e73 7461 6e63 652e  pe) == instance.
+00007170: 6474 7970 652c 2028 2869 6e73 7461 6e63  dtype, ((instanc
+00007180: 652e 6474 7970 652c 2072 6573 2e64 7479  e.dtype, res.dty
+00007190: 7065 292c 2069 6e73 7461 6e63 652c 2072  pe), instance, r
+000071a0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+000071b0: 2020 2020 6173 7365 7274 206e 6f74 2068      assert not h
+000071c0: 6173 6174 7472 2869 6e73 7461 6e63 652c  asattr(instance,
+000071d0: 2027 6e64 696d 2729 206f 7220 7265 732e   'ndim') or res.
+000071e0: 6e64 696d 203d 3d20 696e 7374 616e 6365  ndim == instance
+000071f0: 2e6e 6469 6d0a 2020 2020 2020 2020 2020  .ndim.          
+00007200: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00007210: 2068 6173 6174 7472 2869 6e73 7461 6e63   hasattr(instanc
+00007220: 652c 2027 7368 6170 6527 2920 6f72 2061  e, 'shape') or a
+00007230: 6c6c 286d 203d 3d20 6e20 666f 7220 6d2c  ll(m == n for m,
+00007240: 206e 2069 6e20 7a69 7028 7265 732e 7368   n in zip(res.sh
+00007250: 6170 652c 2069 6e73 7461 6e63 652e 7368  ape, instance.sh
+00007260: 6170 6529 2069 6620 6973 696e 7374 616e  ape) if isinstan
+00007270: 6365 286e 2c20 696e 7429 292c 2027 7368  ce(n, int)), 'sh
+00007280: 6170 6520 6d69 736d 6174 6368 270a 2020  ape mismatch'.  
+00007290: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000072a0: 7475 726e 2072 6573 0a20 2020 2020 2020  turn res.       
+000072b0: 2020 2020 2072 6574 7572 6e20 6576 616c       return eval
+000072c0: 665f 7769 7468 5f63 6865 636b 0a0a 2020  f_with_check..  
+000072d0: 2020 636c 6173 7320 5f41 7272 6179 4d65    class _ArrayMe
+000072e0: 7461 285f 4172 7261 794d 6574 6129 3a0a  ta(_ArrayMeta):.
+000072f0: 2020 2020 2020 2020 6465 6620 5f5f 6e65          def __ne
+00007300: 775f 5f28 6d63 6c73 2c20 6e61 6d65 2c20  w__(mcls, name, 
+00007310: 6261 7365 732c 206e 616d 6573 7061 6365  bases, namespace
+00007320: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+00007330: 6620 2765 7661 6c66 2720 696e 206e 616d  f 'evalf' in nam
+00007340: 6573 7061 6365 3a0a 2020 2020 2020 2020  espace:.        
+00007350: 2020 2020 2020 2020 6e61 6d65 7370 6163          namespac
+00007360: 655b 2765 7661 6c66 275d 203d 205f 6576  e['evalf'] = _ev
+00007370: 616c 665f 6368 6563 6b65 7228 6e61 6d65  alf_checker(name
+00007380: 7370 6163 655b 2765 7661 6c66 275d 290a  space['evalf']).
+00007390: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000073a0: 726e 2073 7570 6572 2829 2e5f 5f6e 6577  rn super().__new
+000073b0: 5f5f 286d 636c 732c 206e 616d 652c 2062  __(mcls, name, b
+000073c0: 6173 6573 2c20 6e61 6d65 7370 6163 6529  ases, namespace)
+000073d0: 0a0a 0a63 6c61 7373 2041 7345 7661 6c75  ...class AsEvalu
+000073e0: 6162 6c65 4172 7261 7928 5072 6f74 6f63  ableArray(Protoc
+000073f0: 6f6c 293a 0a20 2020 2027 5072 6f74 6f63  ol):.    'Protoc
+00007400: 6f6c 2066 6f72 2063 6f6e 7665 7273 696f  ol for conversio
+00007410: 6e20 696e 746f 2061 6e20 3a63 6c61 7373  n into an :class
+00007420: 3a60 4172 7261 7960 2e27 0a0a 2020 2020  :`Array`.'..    
+00007430: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00007440: 6620 6173 5f65 7661 6c75 6162 6c65 5f61  f as_evaluable_a
+00007450: 7272 6179 2873 656c 6629 202d 3e20 2741  rray(self) -> 'A
+00007460: 7272 6179 273a 0a20 2020 2020 2020 2027  rray':.        '
+00007470: 4c6f 7765 7220 7468 6973 206f 626a 6563  Lower this objec
+00007480: 7420 746f 2061 203a 636c 6173 733a 606e  t to a :class:`n
+00007490: 7574 696c 732e 6576 616c 7561 626c 652e  utils.evaluable.
+000074a0: 4172 7261 7960 2e27 0a0a 0a63 6c61 7373  Array`.'...class
+000074b0: 2041 7272 6179 2845 7661 6c75 6162 6c65   Array(Evaluable
+000074c0: 2c20 6d65 7461 636c 6173 733d 5f41 7272  , metaclass=_Arr
+000074d0: 6179 4d65 7461 293a 0a20 2020 2027 2727  ayMeta):.    '''
+000074e0: 0a20 2020 2042 6173 6520 636c 6173 7320  .    Base class 
+000074f0: 666f 7220 6172 7261 7920 7661 6c75 6564  for array valued
+00007500: 2066 756e 6374 696f 6e73 2e0a 0a20 2020   functions...   
+00007510: 2041 7474 7269 6275 7465 730a 2020 2020   Attributes.    
+00007520: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2073  ----------.    s
+00007530: 6861 7065 203a 203a 636c 6173 733a 6074  hape : :class:`t
+00007540: 7570 6c65 6020 6f66 203a 636c 6173 733a  uple` of :class:
+00007550: 6069 6e74 605c 5c73 0a20 2020 2020 2020  `int`\\s.       
+00007560: 2054 6865 2073 6861 7065 206f 6620 7468   The shape of th
+00007570: 6973 2061 7272 6179 2066 756e 6374 696f  is array functio
+00007580: 6e2e 0a20 2020 206e 6469 6d20 3a20 3a63  n..    ndim : :c
+00007590: 6c61 7373 3a60 696e 7460 0a20 2020 2020  lass:`int`.     
+000075a0: 2020 2054 6865 206e 756d 6265 7220 6f66     The number of
+000075b0: 2064 696d 656e 7369 6f6e 7320 6f66 2074   dimensions of t
+000075c0: 6869 7320 6172 7261 7920 6172 7261 7920  his array array 
+000075d0: 6675 6e63 7469 6f6e 2e20 2045 7175 616c  function.  Equal
+000075e0: 2074 6f0a 2020 2020 2020 2020 6060 6c65   to.        ``le
+000075f0: 6e28 7368 6170 6529 6060 2e0a 2020 2020  n(shape)``..    
+00007600: 6474 7970 6520 3a20 3a63 6c61 7373 3a60  dtype : :class:`
+00007610: 696e 7460 2c20 3a63 6c61 7373 3a60 666c  int`, :class:`fl
+00007620: 6f61 7460 0a20 2020 2020 2020 2054 6865  oat`.        The
+00007630: 2064 7479 7065 206f 6620 7468 6520 6172   dtype of the ar
+00007640: 7261 7920 656c 656d 656e 7473 2e0a 2020  ray elements..  
+00007650: 2020 2727 270a 0a20 2020 205f 5f61 7272    '''..    __arr
+00007660: 6179 5f70 7269 6f72 6974 795f 5f20 3d20  ay_priority__ = 
+00007670: 312e 2020 2320 6874 7470 3a2f 2f73 7461  1.  # http://sta
+00007680: 636b 6f76 6572 666c 6f77 2e63 6f6d 2f71  ckoverflow.com/q
+00007690: 7565 7374 696f 6e73 2f37 3034 3234 3936  uestions/7042496
+000076a0: 2f6e 756d 7079 2d63 6f65 7263 696f 6e2d  /numpy-coercion-
+000076b0: 7072 6f62 6c65 6d2d 666f 722d 6c65 6674  problem-for-left
+000076c0: 2d73 6964 6564 2d62 696e 6172 792d 6f70  -sided-binary-op
+000076d0: 6572 6174 6f72 2f37 3035 3735 3330 2337  erator/7057530#7
+000076e0: 3035 3735 3330 0a0a 2020 2020 6465 6620  057530..    def 
+000076f0: 5f5f 696e 6974 5f5f 2873 656c 662c 2061  __init__(self, a
+00007700: 7267 732c 2073 6861 7065 3a20 7479 7069  rgs, shape: typi
+00007710: 6e67 2e54 7570 6c65 5b27 4172 7261 7927  ng.Tuple['Array'
+00007720: 2c20 2e2e 2e5d 2c20 6474 7970 653a 2044  , ...], dtype: D
+00007730: 7479 7065 293a 0a20 2020 2020 2020 2061  type):.        a
+00007740: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00007750: 2873 6861 7065 2c20 7475 706c 6529 2061  (shape, tuple) a
+00007760: 6e64 2061 6c6c 285f 6973 696e 6465 7828  nd all(_isindex(
+00007770: 6e29 2066 6f72 206e 2069 6e20 7368 6170  n) for n in shap
+00007780: 6529 2c20 6627 7368 6170 653d 7b73 6861  e), f'shape={sha
+00007790: 7065 2172 7d27 0a20 2020 2020 2020 2061  pe!r}'.        a
+000077a0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+000077b0: 2864 7479 7065 2c20 7479 7065 2920 616e  (dtype, type) an
+000077c0: 6420 6474 7970 6520 696e 205f 7479 7065  d dtype in _type
+000077d0: 5f6f 7264 6572 2c20 6627 6474 7970 653d  _order, f'dtype=
+000077e0: 7b64 7479 7065 2172 7d27 0a20 2020 2020  {dtype!r}'.     
+000077f0: 2020 2073 656c 662e 7368 6170 6520 3d20     self.shape = 
+00007800: 7368 6170 650a 2020 2020 2020 2020 7365  shape.        se
+00007810: 6c66 2e64 7479 7065 203d 2064 7479 7065  lf.dtype = dtype
+00007820: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+00007830: 2e5f 5f69 6e69 745f 5f28 6172 6773 3d61  .__init__(args=a
+00007840: 7267 7329 0a0a 2020 2020 4070 726f 7065  rgs)..    @prope
+00007850: 7274 790a 2020 2020 6465 6620 6e64 696d  rty.    def ndim
+00007860: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00007870: 7265 7475 726e 206c 656e 2873 656c 662e  return len(self.
+00007880: 7368 6170 6529 0a0a 2020 2020 6465 6620  shape)..    def 
+00007890: 5f5f 6765 7469 7465 6d5f 5f28 7365 6c66  __getitem__(self
+000078a0: 2c20 6974 656d 293a 0a20 2020 2020 2020  , item):.       
+000078b0: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
+000078c0: 6365 2869 7465 6d2c 2074 7570 6c65 293a  ce(item, tuple):
+000078d0: 0a20 2020 2020 2020 2020 2020 2069 7465  .            ite
+000078e0: 6d20 3d20 6974 656d 2c0a 2020 2020 2020  m = item,.      
+000078f0: 2020 6966 202e 2e2e 2069 6e20 6974 656d    if ... in item
+00007900: 3a0a 2020 2020 2020 2020 2020 2020 6965  :.            ie
+00007910: 6c6c 203d 2069 7465 6d2e 696e 6465 7828  ll = item.index(
+00007920: 2e2e 2e29 0a20 2020 2020 2020 2020 2020  ...).           
+00007930: 2069 6620 2e2e 2e20 696e 2069 7465 6d5b   if ... in item[
+00007940: 6965 6c6c 2b31 3a5d 3a0a 2020 2020 2020  iell+1:]:.      
+00007950: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00007960: 496e 6465 7845 7272 6f72 2827 616e 2069  IndexError('an i
+00007970: 6e64 6578 2063 616e 2068 6176 6520 6f6e  ndex can have on
+00007980: 6c79 2061 2073 696e 676c 6520 656c 6c69  ly a single elli
+00007990: 7073 6973 2729 0a20 2020 2020 2020 2020  psis').         
+000079a0: 2020 2023 2072 6570 6c61 6365 2065 6c6c     # replace ell
+000079b0: 6970 7369 7320 6279 2074 6865 2061 7070  ipsis by the app
+000079c0: 726f 7072 6961 7465 206e 756d 6265 7220  ropriate number 
+000079d0: 6f66 2073 6c69 6365 284e 6f6e 6529 0a20  of slice(None). 
+000079e0: 2020 2020 2020 2020 2020 2069 7465 6d20             item 
+000079f0: 3d20 6974 656d 5b3a 6965 6c6c 5d20 2b20  = item[:iell] + 
+00007a00: 2873 6c69 6365 284e 6f6e 6529 2c29 2a28  (slice(None),)*(
+00007a10: 7365 6c66 2e6e 6469 6d2d 6c65 6e28 6974  self.ndim-len(it
+00007a20: 656d 292b 3129 202b 2069 7465 6d5b 6965  em)+1) + item[ie
+00007a30: 6c6c 2b31 3a5d 0a20 2020 2020 2020 2069  ll+1:].        i
+00007a40: 6620 6c65 6e28 6974 656d 2920 3e20 7365  f len(item) > se
+00007a50: 6c66 2e6e 6469 6d3a 0a20 2020 2020 2020  lf.ndim:.       
+00007a60: 2020 2020 2072 6169 7365 2049 6e64 6578       raise Index
+00007a70: 4572 726f 7228 2774 6f6f 206d 616e 7920  Error('too many 
+00007a80: 696e 6469 6365 7320 666f 7220 6172 7261  indices for arra
+00007a90: 7927 290a 2020 2020 2020 2020 6172 7261  y').        arra
+00007aa0: 7920 3d20 7365 6c66 0a20 2020 2020 2020  y = self.       
+00007ab0: 2066 6f72 2061 7869 732c 2069 7420 696e   for axis, it in
+00007ac0: 2072 6576 6572 7365 6428 7475 706c 6528   reversed(tuple(
+00007ad0: 656e 756d 6572 6174 6528 6974 656d 2929  enumerate(item))
+00007ae0: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
+00007af0: 7272 6179 203d 2067 6574 2861 7272 6179  rray = get(array
+00007b00: 2c20 6178 6973 2c20 6974 656d 3d63 6f6e  , axis, item=con
+00007b10: 7374 616e 7428 6974 2929 2069 6620 6e75  stant(it)) if nu
+00007b20: 6d65 7269 632e 6973 696e 7428 6974 2920  meric.isint(it) 
+00007b30: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+00007b40: 2020 656c 7365 205f 7461 6b65 736c 6963    else _takeslic
+00007b50: 6528 6172 7261 792c 2069 742c 2061 7869  e(array, it, axi
+00007b60: 7329 2069 6620 6973 696e 7374 616e 6365  s) if isinstance
+00007b70: 2869 742c 2073 6c69 6365 2920 5c0a 2020  (it, slice) \.  
+00007b80: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00007b90: 7365 2074 616b 6528 6172 7261 792c 2069  se take(array, i
+00007ba0: 742c 2061 7869 7329 0a20 2020 2020 2020  t, axis).       
+00007bb0: 2072 6574 7572 6e20 6172 7261 790a 0a20   return array.. 
+00007bc0: 2020 2064 6566 205f 5f62 6f6f 6c5f 5f28     def __bool__(
+00007bd0: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
+00007be0: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
+00007bf0: 6465 6620 5f5f 6c65 6e5f 5f28 7365 6c66  def __len__(self
+00007c00: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
+00007c10: 6c66 2e6e 6469 6d20 3d3d 2030 3a0a 2020  lf.ndim == 0:.  
+00007c20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00007c30: 5479 7065 4572 726f 7228 276c 656e 2829  TypeError('len()
+00007c40: 206f 6620 756e 7369 7a65 6420 6f62 6a65   of unsized obje
+00007c50: 6374 2729 0a20 2020 2020 2020 2072 6574  ct').        ret
+00007c60: 7572 6e20 7365 6c66 2e73 6861 7065 5b30  urn self.shape[0
+00007c70: 5d0a 0a20 2020 2064 6566 205f 5f69 6e64  ]..    def __ind
+00007c80: 6578 5f5f 2873 656c 6629 3a0a 2020 2020  ex__(self):.    
+00007c90: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00007ca0: 2020 2020 2069 6e64 6578 203d 2073 656c       index = sel
+00007cb0: 662e 5f5f 696e 6465 780a 2020 2020 2020  f.__index.      
+00007cc0: 2020 6578 6365 7074 2041 7474 7269 6275    except Attribu
+00007cd0: 7465 4572 726f 723a 0a20 2020 2020 2020  teError:.       
+00007ce0: 2020 2020 2069 6620 7365 6c66 2e6e 6469       if self.ndi
+00007cf0: 6d20 6f72 2073 656c 662e 6474 7970 6520  m or self.dtype 
+00007d00: 6e6f 7420 696e 2028 696e 742c 2062 6f6f  not in (int, boo
+00007d10: 6c29 206f 7220 6e6f 7420 7365 6c66 2e69  l) or not self.i
+00007d20: 7363 6f6e 7374 616e 743a 0a20 2020 2020  sconstant:.     
+00007d30: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00007d40: 2054 7970 6545 7272 6f72 2827 6361 6e6e   TypeError('cann
+00007d50: 6f74 2063 6f6e 7665 7274 207b 2172 7d20  ot convert {!r} 
+00007d60: 746f 2069 6e74 272e 666f 726d 6174 2873  to int'.format(s
+00007d70: 656c 6629 290a 2020 2020 2020 2020 2020  elf)).          
+00007d80: 2020 696e 6465 7820 3d20 7365 6c66 2e5f    index = self._
+00007d90: 5f69 6e64 6578 203d 2069 6e74 2873 656c  _index = int(sel
+00007da0: 662e 7369 6d70 6c69 6669 6564 2e65 7661  f.simplified.eva
+00007db0: 6c28 2929 0a20 2020 2020 2020 2072 6574  l()).        ret
+00007dc0: 7572 6e20 696e 6465 780a 0a20 2020 2054  urn index..    T
+00007dd0: 203d 2070 726f 7065 7274 7928 6c61 6d62   = property(lamb
+00007de0: 6461 2073 656c 663a 2074 7261 6e73 706f  da self: transpo
+00007df0: 7365 2873 656c 6629 290a 0a20 2020 205f  se(self))..    _
+00007e00: 5f61 6464 5f5f 203d 205f 5f72 6164 645f  _add__ = __radd_
+00007e10: 5f20 3d20 6164 640a 2020 2020 5f5f 7375  _ = add.    __su
+00007e20: 625f 5f20 3d20 6c61 6d62 6461 2073 656c  b__ = lambda sel
+00007e30: 662c 206f 7468 6572 3a20 7375 6274 7261  f, other: subtra
+00007e40: 6374 2873 656c 662c 206f 7468 6572 290a  ct(self, other).
+00007e50: 2020 2020 5f5f 7273 7562 5f5f 203d 206c      __rsub__ = l
+00007e60: 616d 6264 6120 7365 6c66 2c20 6f74 6865  ambda self, othe
+00007e70: 723a 2073 7562 7472 6163 7428 6f74 6865  r: subtract(othe
+00007e80: 722c 2073 656c 6629 0a20 2020 205f 5f6d  r, self).    __m
+00007e90: 756c 5f5f 203d 205f 5f72 6d75 6c5f 5f20  ul__ = __rmul__ 
+00007ea0: 3d20 6d75 6c74 6970 6c79 0a20 2020 205f  = multiply.    _
+00007eb0: 5f74 7275 6564 6976 5f5f 203d 206c 616d  _truediv__ = lam
+00007ec0: 6264 6120 7365 6c66 2c20 6f74 6865 723a  bda self, other:
+00007ed0: 2064 6976 6964 6528 7365 6c66 2c20 6f74   divide(self, ot
+00007ee0: 6865 7229 0a20 2020 205f 5f72 7472 7565  her).    __rtrue
+00007ef0: 6469 765f 5f20 3d20 6c61 6d62 6461 2073  div__ = lambda s
+00007f00: 656c 662c 206f 7468 6572 3a20 6469 7669  elf, other: divi
+00007f10: 6465 286f 7468 6572 2c20 7365 6c66 290a  de(other, self).
+00007f20: 2020 2020 5f5f 706f 735f 5f20 3d20 6c61      __pos__ = la
+00007f30: 6d62 6461 2073 656c 663a 2073 656c 660a  mbda self: self.
+00007f40: 2020 2020 5f5f 6e65 675f 5f20 3d20 6c61      __neg__ = la
+00007f50: 6d62 6461 2073 656c 663a 206e 6567 6174  mbda self: negat
+00007f60: 6976 6528 7365 6c66 290a 2020 2020 5f5f  ive(self).    __
+00007f70: 706f 775f 5f20 3d20 706f 7765 720a 2020  pow__ = power.  
+00007f80: 2020 5f5f 6162 735f 5f20 3d20 6c61 6d62    __abs__ = lamb
+00007f90: 6461 2073 656c 663a 2061 6273 2873 656c  da self: abs(sel
+00007fa0: 6629 0a20 2020 205f 5f6d 6f64 5f5f 203d  f).    __mod__ =
+00007fb0: 206c 616d 6264 6120 7365 6c66 2c20 6f74   lambda self, ot
+00007fc0: 6865 723a 206d 6f64 2873 656c 662c 206f  her: mod(self, o
+00007fd0: 7468 6572 290a 2020 2020 5f5f 696e 745f  ther).    __int_
+00007fe0: 5f20 3d20 5f5f 696e 6465 785f 5f0a 2020  _ = __index__.  
+00007ff0: 2020 5f5f 7374 725f 5f20 3d20 5f5f 7265    __str__ = __re
+00008000: 7072 5f5f 203d 206c 616d 6264 6120 7365  pr__ = lambda se
+00008010: 6c66 3a20 277b 7d2e 7b7d 3c7b 7d3e 272e  lf: '{}.{}<{}>'.
+00008020: 666f 726d 6174 2874 7970 6528 7365 6c66  format(type(self
+00008030: 292e 5f5f 6d6f 6475 6c65 5f5f 2c20 7479  ).__module__, ty
+00008040: 7065 2873 656c 6629 2e5f 5f6e 616d 655f  pe(self).__name_
+00008050: 5f2c 2073 656c 662e 5f73 6861 7065 5f73  _, self._shape_s
+00008060: 7472 2866 6f72 6d3d 7374 7229 290a 0a20  tr(form=str)).. 
+00008070: 2020 2064 6566 205f 7368 6170 655f 7374     def _shape_st
+00008080: 7228 7365 6c66 2c20 666f 726d 293a 0a20  r(self, form):. 
+00008090: 2020 2020 2020 2064 7479 7065 203d 2073         dtype = s
+000080a0: 656c 662e 6474 7970 652e 5f5f 6e61 6d65  elf.dtype.__name
+000080b0: 5f5f 5b30 5d20 6966 2068 6173 6174 7472  __[0] if hasattr
+000080c0: 2873 656c 662c 2027 6474 7970 6527 2920  (self, 'dtype') 
+000080d0: 656c 7365 2027 3f27 0a20 2020 2020 2020  else '?'.       
+000080e0: 2073 6861 7065 203d 205b 7374 7228 6e2e   shape = [str(n.
+000080f0: 5f5f 696e 6465 785f 5f28 2929 2069 6620  __index__()) if 
+00008100: 6e2e 6973 636f 6e73 7461 6e74 2065 6c73  n.isconstant els
+00008110: 6520 273f 2720 666f 7220 6e20 696e 2073  e '?' for n in s
+00008120: 656c 662e 7368 6170 655d 0a20 2020 2020  elf.shape].     
+00008130: 2020 2066 6f72 2069 2069 6e20 7365 7428     for i in set(
+00008140: 7261 6e67 6528 7365 6c66 2e6e 6469 6d29  range(self.ndim)
+00008150: 2920 2d20 7365 7428 7365 6c66 2e5f 756e  ) - set(self._un
+00008160: 616c 6967 6e65 645b 315d 293a 0a20 2020  aligned[1]):.   
+00008170: 2020 2020 2020 2020 2073 6861 7065 5b69           shape[i
+00008180: 5d20 3d20 6627 287b 7368 6170 655b 695d  ] = f'({shape[i]
+00008190: 7d29 270a 2020 2020 2020 2020 666f 7220  })'.        for 
+000081a0: 692c 205f 2069 6e20 7365 6c66 2e5f 696e  i, _ in self._in
+000081b0: 666c 6174 696f 6e73 3a0a 2020 2020 2020  flations:.      
+000081c0: 2020 2020 2020 7368 6170 655b 695d 203d        shape[i] =
+000081d0: 2066 277e 7b73 6861 7065 5b69 5d7d 270a   f'~{shape[i]}'.
+000081e0: 2020 2020 2020 2020 666f 7220 6178 6573          for axes
+000081f0: 2069 6e20 7365 6c66 2e5f 6469 6167 6f6e   in self._diagon
+00008200: 616c 733a 0a20 2020 2020 2020 2020 2020  als:.           
+00008210: 2066 6f72 2069 2069 6e20 6178 6573 3a0a   for i in axes:.
+00008220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008230: 7368 6170 655b 695d 203d 2066 277b 7368  shape[i] = f'{sh
+00008240: 6170 655b 695d 7d2f 270a 2020 2020 2020  ape[i]}/'.      
+00008250: 2020 7265 7475 726e 2066 277b 6474 7970    return f'{dtyp
+00008260: 657d 3a7b 222c 222e 6a6f 696e 2873 6861  e}:{",".join(sha
+00008270: 7065 297d 270a 0a20 2020 2073 756d 203d  pe)}'..    sum =
+00008280: 2073 756d 0a20 2020 2070 726f 6420 3d20   sum.    prod = 
+00008290: 7072 6f64 7563 740a 2020 2020 646f 7420  product.    dot 
+000082a0: 3d20 646f 740a 2020 2020 7377 6170 6178  = dot.    swapax
+000082b0: 6573 203d 2073 7761 7061 7865 730a 2020  es = swapaxes.  
+000082c0: 2020 7472 616e 7370 6f73 6520 3d20 7472    transpose = tr
+000082d0: 616e 7370 6f73 650a 2020 2020 6368 6f6f  anspose.    choo
+000082e0: 7365 203d 206c 616d 6264 6120 7365 6c66  se = lambda self
+000082f0: 2c20 6368 6f69 6365 733a 2043 686f 6f73  , choices: Choos
+00008300: 6528 7365 6c66 2c20 2a63 686f 6963 6573  e(self, *choices
+00008310: 290a 2020 2020 636f 6e6a 7567 6174 6520  ).    conjugate 
+00008320: 3d20 636f 6e6a 7567 6174 650a 0a20 2020  = conjugate..   
+00008330: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00008340: 6566 2072 6561 6c28 7365 6c66 293a 0a20  ef real(self):. 
+00008350: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00008360: 616c 2873 656c 6629 0a0a 2020 2020 4070  al(self)..    @p
+00008370: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+00008380: 696d 6167 2873 656c 6629 3a0a 2020 2020  imag(self):.    
+00008390: 2020 2020 7265 7475 726e 2069 6d61 6728      return imag(
+000083a0: 7365 6c66 290a 0a20 2020 2040 6361 6368  self)..    @cach
+000083b0: 6564 5f70 726f 7065 7274 790a 2020 2020  ed_property.    
+000083c0: 6465 6620 5f61 7373 7061 7273 6528 7365  def _assparse(se
+000083d0: 6c66 293a 0a20 2020 2020 2020 2023 2043  lf):.        # C
+000083e0: 6f6e 7665 7274 2074 6f20 6120 7365 7175  onvert to a sequ
+000083f0: 656e 6365 206f 6620 7370 6172 7365 2043  ence of sparse C
+00008400: 4f4f 2061 7272 6179 732e 2054 6865 2072  OO arrays. The r
+00008410: 6574 7572 6e65 6420 6461 7461 2069 7320  eturned data is 
+00008420: 6120 7475 706c 650a 2020 2020 2020 2020  a tuple.        
+00008430: 2320 6f66 2060 282a 696e 6469 6365 732c  # of `(*indices,
+00008440: 2076 616c 7565 7329 6020 7475 706c 6573   values)` tuples
+00008450: 2c20 7768 6572 6520 6076 616c 7565 7360  , where `values`
+00008460: 2069 7320 616e 2060 4172 7261 7960 2077   is an `Array` w
+00008470: 6974 6820 7468 650a 2020 2020 2020 2020  ith the.        
+00008480: 2320 7361 6d65 2064 7479 7065 2061 7320  # same dtype as 
+00008490: 6073 656c 6660 2c20 6275 7420 7468 6973  `self`, but this
+000084a0: 2069 7320 6e6f 7420 656e 666f 7263 6564   is not enforced
+000084b0: 2079 6574 2c20 616e 6420 6561 6368 2069   yet, and each i
+000084c0: 6e64 6578 2069 6e0a 2020 2020 2020 2020  ndex in.        
+000084d0: 2320 6069 6e64 6963 6573 6020 6973 2061  # `indices` is a
+000084e0: 6e20 6041 7272 6179 6020 7769 7468 2064  n `Array` with d
+000084f0: 7479 7065 2060 696e 7460 2061 6e64 2074  type `int` and t
+00008500: 6865 2065 7861 6374 2073 616d 6520 7368  he exact same sh
+00008510: 6170 6520 6173 0a20 2020 2020 2020 2023  ape as.        #
+00008520: 2060 7661 6c75 6573 602e 2054 6865 206c   `values`. The l
+00008530: 656e 6774 6820 6f66 2060 696e 6469 6365  ength of `indice
+00008540: 7360 2065 7175 616c 7320 6073 656c 662e  s` equals `self.
+00008550: 6e64 696d 602e 2049 6e20 6164 6469 7469  ndim`. In additi
+00008560: 6f6e 2c20 6966 0a20 2020 2020 2020 2023  on, if.        #
+00008570: 2060 7365 6c66 6020 6973 2030 6420 7468   `self` is 0d th
+00008580: 6520 6c65 6e67 7468 206f 6620 6073 656c  e length of `sel
+00008590: 662e 5f61 7373 7061 7273 6560 2069 7320  f._assparse` is 
+000085a0: 6174 206d 6f73 7420 6f6e 6520 616e 6420  at most one and 
+000085b0: 7468 650a 2020 2020 2020 2020 2320 6076  the.        # `v
+000085c0: 616c 7565 7360 2061 7272 6179 206d 7573  alues` array mus
+000085d0: 7420 6265 2030 6420 6173 2077 656c 6c2e  t be 0d as well.
+000085e0: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
+000085f0: 2020 2023 2054 6865 2073 7061 7273 6520     # The sparse 
+00008600: 6461 7461 2063 616e 2062 6520 7265 6173  data can be reas
+00008610: 7365 6d62 6c65 6420 6166 7465 7220 6576  sembled after ev
+00008620: 616c 7561 7469 6f6e 2062 790a 2020 2020  aluation by.    
+00008630: 2020 2020 230a 2020 2020 2020 2020 2320      #.        # 
+00008640: 2020 2020 6465 6e73 6520 3d20 6e75 6d70      dense = nump
+00008650: 792e 7a65 726f 7328 7365 6c66 2e73 6861  y.zeros(self.sha
+00008660: 7065 290a 2020 2020 2020 2020 2320 2020  pe).        #   
+00008670: 2020 666f 7220 4930 2c2e 2e2e 2c49 6b2c    for I0,...,Ik,
+00008680: 5620 696e 2073 656c 662e 5f61 7373 7061  V in self._asspa
+00008690: 7273 653a 0a20 2020 2020 2020 2023 2020  rse:.        #  
+000086a0: 2020 2020 2066 6f72 2069 302c 2e2e 2e2c       for i0,...,
+000086b0: 696b 2c76 2069 6e20 7a69 7028 4930 2e65  ik,v in zip(I0.e
+000086c0: 7661 6c28 292e 7261 7665 6c28 292c 2e2e  val().ravel(),..
+000086d0: 2e2c 496b 2e65 7661 6c28 292e 7261 7665  .,Ik.eval().rave
+000086e0: 6c28 292c 562e 6576 616c 2829 2e72 6176  l(),V.eval().rav
+000086f0: 656c 2829 293a 0a20 2020 2020 2020 2023  el()):.        #
+00008700: 2020 2020 2020 2020 2064 656e 7365 5b69           dense[i
+00008710: 302c 2e2e 2e2c 696b 5d20 3d20 760a 0a20  0,...,ik] = v.. 
+00008720: 2020 2020 2020 2069 6e64 6963 6573 203d         indices =
+00008730: 205b 7072 6570 656e 6461 7865 7328 6170   [prependaxes(ap
+00008740: 7065 6e64 6178 6573 2852 616e 6765 286c  pendaxes(Range(l
+00008750: 656e 6774 6829 2c20 7365 6c66 2e73 6861  ength), self.sha
+00008760: 7065 5b69 2b31 3a5d 292c 2073 656c 662e  pe[i+1:]), self.
+00008770: 7368 6170 655b 3a69 5d29 2066 6f72 2069  shape[:i]) for i
+00008780: 2c20 6c65 6e67 7468 2069 6e20 656e 756d  , length in enum
+00008790: 6572 6174 6528 7365 6c66 2e73 6861 7065  erate(self.shape
+000087a0: 295d 0a20 2020 2020 2020 2072 6574 7572  )].        retur
+000087b0: 6e20 282a 696e 6469 6365 732c 2073 656c  n (*indices, sel
+000087c0: 6629 2c0a 0a20 2020 2064 6566 205f 6e6f  f),..    def _no
+000087d0: 6465 2873 656c 662c 2063 6163 6865 2c20  de(self, cache, 
+000087e0: 7375 6267 7261 7068 2c20 7469 6d65 7329  subgraph, times)
+000087f0: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
+00008800: 6620 696e 2063 6163 6865 3a0a 2020 2020  f in cache:.    
+00008810: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+00008820: 6163 6865 5b73 656c 665d 0a20 2020 2020  ache[self].     
+00008830: 2020 2061 7267 7320 3d20 7475 706c 6528     args = tuple(
+00008840: 6172 672e 5f6e 6f64 6528 6361 6368 652c  arg._node(cache,
+00008850: 2073 7562 6772 6170 682c 2074 696d 6573   subgraph, times
+00008860: 2920 666f 7220 6172 6720 696e 2073 656c  ) for arg in sel
+00008870: 662e 5f45 7661 6c75 6162 6c65 5f5f 6172  f._Evaluable__ar
+00008880: 6773 290a 2020 2020 2020 2020 626f 756e  gs).        boun
+00008890: 6473 203d 2027 5b7b 7d2c 7b7d 5d27 2e66  ds = '[{},{}]'.f
+000088a0: 6f72 6d61 7428 2a73 656c 662e 5f69 6e74  ormat(*self._int
+000088b0: 626f 756e 6473 2920 6966 2073 656c 662e  bounds) if self.
+000088c0: 6474 7970 6520 3d3d 2069 6e74 2065 6c73  dtype == int els
+000088d0: 6520 4e6f 6e65 0a20 2020 2020 2020 206c  e None.        l
+000088e0: 6162 656c 203d 2027 5c6e 272e 6a6f 696e  abel = '\n'.join
+000088f0: 2866 696c 7465 7228 4e6f 6e65 2c20 2874  (filter(None, (t
+00008900: 7970 6528 7365 6c66 292e 5f5f 6e61 6d65  ype(self).__name
+00008910: 5f5f 2c20 7365 6c66 2e5f 6e6f 6465 5f64  __, self._node_d
+00008920: 6574 6169 6c73 2c20 7365 6c66 2e5f 7368  etails, self._sh
+00008930: 6170 655f 7374 7228 666f 726d 3d72 6570  ape_str(form=rep
+00008940: 7229 2c20 626f 756e 6473 2929 290a 2020  r), bounds))).  
+00008950: 2020 2020 2020 6361 6368 655b 7365 6c66        cache[self
+00008960: 5d20 3d20 6e6f 6465 203d 2052 6567 756c  ] = node = Regul
+00008970: 6172 4e6f 6465 286c 6162 656c 2c20 6172  arNode(label, ar
+00008980: 6773 2c20 7b7d 2c20 2874 7970 6528 7365  gs, {}, (type(se
+00008990: 6c66 292e 5f5f 6e61 6d65 5f5f 2c20 7469  lf).__name__, ti
+000089a0: 6d65 735b 7365 6c66 5d29 2c20 7375 6267  mes[self]), subg
+000089b0: 7261 7068 290a 2020 2020 2020 2020 7265  raph).        re
+000089c0: 7475 726e 206e 6f64 650a 0a20 2020 2023  turn node..    #
+000089d0: 2073 696d 706c 6966 6963 6174 696f 6e73   simplifications
+000089e0: 0a20 2020 205f 6d75 6c74 6970 6c79 203d  .    _multiply =
+000089f0: 206c 616d 6264 6120 7365 6c66 2c20 6f74   lambda self, ot
+00008a00: 6865 723a 204e 6f6e 650a 2020 2020 5f74  her: None.    _t
+00008a10: 7261 6e73 706f 7365 203d 206c 616d 6264  ranspose = lambd
+00008a20: 6120 7365 6c66 2c20 6178 6573 3a20 4e6f  a self, axes: No
+00008a30: 6e65 0a20 2020 205f 696e 7365 7274 6178  ne.    _insertax
+00008a40: 6973 203d 206c 616d 6264 6120 7365 6c66  is = lambda self
+00008a50: 2c20 6178 6973 2c20 6c65 6e67 7468 3a20  , axis, length: 
+00008a60: 4e6f 6e65 0a20 2020 205f 706f 7765 7220  None.    _power 
+00008a70: 3d20 6c61 6d62 6461 2073 656c 662c 206e  = lambda self, n
+00008a80: 3a20 4e6f 6e65 0a20 2020 205f 6164 6420  : None.    _add 
+00008a90: 3d20 6c61 6d62 6461 2073 656c 662c 206f  = lambda self, o
+00008aa0: 7468 6572 3a20 4e6f 6e65 0a20 2020 205f  ther: None.    _
+00008ab0: 7375 6d20 3d20 6c61 6d62 6461 2073 656c  sum = lambda sel
+00008ac0: 662c 2061 7869 733a 204e 6f6e 650a 2020  f, axis: None.  
+00008ad0: 2020 5f74 616b 6520 3d20 6c61 6d62 6461    _take = lambda
+00008ae0: 2073 656c 662c 2069 6e64 6578 2c20 6178   self, index, ax
+00008af0: 6973 3a20 4e6f 6e65 0a20 2020 205f 7274  is: None.    _rt
+00008b00: 616b 6520 3d20 6c61 6d62 6461 2073 656c  ake = lambda sel
+00008b10: 662c 2069 6e64 6578 2c20 6178 6973 3a20  f, index, axis: 
+00008b20: 4e6f 6e65 0a20 2020 205f 6465 7465 726d  None.    _determ
+00008b30: 696e 616e 7420 3d20 6c61 6d62 6461 2073  inant = lambda s
+00008b40: 656c 662c 2061 7869 7331 2c20 6178 6973  elf, axis1, axis
+00008b50: 323a 204e 6f6e 650a 2020 2020 5f69 6e76  2: None.    _inv
+00008b60: 6572 7365 203d 206c 616d 6264 6120 7365  erse = lambda se
+00008b70: 6c66 2c20 6178 6973 312c 2061 7869 7332  lf, axis1, axis2
+00008b80: 3a20 4e6f 6e65 0a20 2020 205f 7461 6b65  : None.    _take
+00008b90: 6469 6167 203d 206c 616d 6264 6120 7365  diag = lambda se
+00008ba0: 6c66 2c20 6178 6973 312c 2061 7869 7332  lf, axis1, axis2
+00008bb0: 3a20 4e6f 6e65 0a20 2020 205f 6469 6167  : None.    _diag
+00008bc0: 6f6e 616c 697a 6520 3d20 6c61 6d62 6461  onalize = lambda
+00008bd0: 2073 656c 662c 2061 7869 733a 204e 6f6e   self, axis: Non
+00008be0: 650a 2020 2020 5f70 726f 6475 6374 203d  e.    _product =
+00008bf0: 206c 616d 6264 6120 7365 6c66 3a20 4e6f   lambda self: No
+00008c00: 6e65 0a20 2020 205f 7369 676e 203d 206c  ne.    _sign = l
+00008c10: 616d 6264 6120 7365 6c66 3a20 4e6f 6e65  ambda self: None
+00008c20: 0a20 2020 205f 6569 6720 3d20 6c61 6d62  .    _eig = lamb
+00008c30: 6461 2073 656c 662c 2073 796d 6d65 7472  da self, symmetr
+00008c40: 6963 3a20 4e6f 6e65 0a20 2020 205f 696e  ic: None.    _in
+00008c50: 666c 6174 6520 3d20 6c61 6d62 6461 2073  flate = lambda s
+00008c60: 656c 662c 2064 6f66 6d61 702c 206c 656e  elf, dofmap, len
+00008c70: 6774 682c 2061 7869 733a 204e 6f6e 650a  gth, axis: None.
+00008c80: 2020 2020 5f72 696e 666c 6174 6520 3d20      _rinflate = 
+00008c90: 6c61 6d62 6461 2073 656c 662c 2066 756e  lambda self, fun
+00008ca0: 632c 206c 656e 6774 682c 2061 7869 733a  c, length, axis:
+00008cb0: 204e 6f6e 650a 2020 2020 5f75 6e72 6176   None.    _unrav
+00008cc0: 656c 203d 206c 616d 6264 6120 7365 6c66  el = lambda self
+00008cd0: 2c20 6178 6973 2c20 7368 6170 653a 204e  , axis, shape: N
+00008ce0: 6f6e 650a 2020 2020 5f72 6176 656c 203d  one.    _ravel =
+00008cf0: 206c 616d 6264 6120 7365 6c66 2c20 6178   lambda self, ax
+00008d00: 6973 3a20 4e6f 6e65 0a20 2020 205f 6c6f  is: None.    _lo
+00008d10: 6f70 7375 6d20 3d20 6c61 6d62 6461 2073  opsum = lambda s
+00008d20: 656c 662c 206c 6f6f 705f 696e 6465 783a  elf, loop_index:
+00008d30: 204e 6f6e 6520 2023 204e 4f54 453a 2074   None  # NOTE: t
+00008d40: 7970 6520 6f66 2060 6c6f 6f70 5f69 6e64  ype of `loop_ind
+00008d50: 6578 6020 6973 2060 5f4c 6f6f 7049 6e64  ex` is `_LoopInd
+00008d60: 6578 600a 2020 2020 5f72 6561 6c20 3d20  ex`.    _real = 
+00008d70: 6c61 6d62 6461 2073 656c 663a 204e 6f6e  lambda self: Non
+00008d80: 650a 2020 2020 5f69 6d61 6720 3d20 6c61  e.    _imag = la
+00008d90: 6d62 6461 2073 656c 663a 204e 6f6e 650a  mbda self: None.
+00008da0: 2020 2020 5f63 6f6e 6a75 6761 7465 203d      _conjugate =
+00008db0: 206c 616d 6264 6120 7365 6c66 3a20 4e6f   lambda self: No
+00008dc0: 6e65 0a0a 2020 2020 4070 726f 7065 7274  ne..    @propert
+00008dd0: 790a 2020 2020 6465 6620 5f75 6e61 6c69  y.    def _unali
+00008de0: 676e 6564 2873 656c 6629 3a0a 2020 2020  gned(self):.    
+00008df0: 2020 2020 7265 7475 726e 2073 656c 662c      return self,
+00008e00: 2074 7570 6c65 2872 616e 6765 2873 656c   tuple(range(sel
+00008e10: 662e 6e64 696d 2929 0a0a 2020 2020 5f64  f.ndim))..    _d
+00008e20: 6961 676f 6e61 6c73 203d 2028 290a 2020  iagonals = ().  
+00008e30: 2020 5f69 6e66 6c61 7469 6f6e 7320 3d20    _inflations = 
+00008e40: 2829 0a0a 2020 2020 6465 6620 5f64 6572  ()..    def _der
+00008e50: 6976 6174 6976 6528 7365 6c66 2c20 7661  ivative(self, va
+00008e60: 722c 2073 6565 6e29 3a0a 2020 2020 2020  r, seen):.      
+00008e70: 2020 6966 2073 656c 662e 6474 7970 6520    if self.dtype 
+00008e80: 696e 2028 626f 6f6c 2c20 696e 7429 206f  in (bool, int) o
+00008e90: 7220 7661 7220 6e6f 7420 696e 2073 656c  r var not in sel
+00008ea0: 662e 6172 6775 6d65 6e74 733a 0a20 2020  f.arguments:.   
+00008eb0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00008ec0: 5a65 726f 7328 7365 6c66 2e73 6861 7065  Zeros(self.shape
+00008ed0: 202b 2076 6172 2e73 6861 7065 2c20 6474   + var.shape, dt
+00008ee0: 7970 653d 7365 6c66 2e64 7479 7065 290a  ype=self.dtype).
+00008ef0: 2020 2020 2020 2020 7261 6973 6520 4e6f          raise No
+00008f00: 7449 6d70 6c65 6d65 6e74 6564 4572 726f  tImplementedErro
+00008f10: 7228 2764 6572 6976 6174 6976 6520 6e6f  r('derivative no
+00008f20: 7420 6465 6669 6e65 6420 666f 7220 7b7d  t defined for {}
+00008f30: 272e 666f 726d 6174 2873 656c 662e 5f5f  '.format(self.__
+00008f40: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
+00008f50: 2929 0a0a 2020 2020 4070 726f 7065 7274  ))..    @propert
+00008f60: 790a 2020 2020 6465 6620 6173 5f65 7661  y.    def as_eva
+00008f70: 6c75 6162 6c65 5f61 7272 6179 2873 656c  luable_array(sel
+00008f80: 6629 3a0a 2020 2020 2020 2020 2772 6574  f):.        'ret
+00008f90: 7572 6e20 7365 6c66 270a 0a20 2020 2020  urn self'..     
+00008fa0: 2020 2072 6574 7572 6e20 7365 6c66 0a0a     return self..
+00008fb0: 2020 2020 4063 6163 6865 645f 7072 6f70      @cached_prop
+00008fc0: 6572 7479 0a20 2020 2064 6566 205f 696e  erty.    def _in
+00008fd0: 7462 6f75 6e64 7328 7365 6c66 293a 0a20  tbounds(self):. 
+00008fe0: 2020 2020 2020 2023 2069 6e63 6c75 7369         # inclusi
+00008ff0: 7665 206c 6f77 6572 2061 6e64 2075 7070  ve lower and upp
+00009000: 6572 2062 6f75 6e64 730a 2020 2020 2020  er bounds.      
+00009010: 2020 6966 2073 656c 662e 6e64 696d 203d    if self.ndim =
+00009020: 3d20 3020 616e 6420 7365 6c66 2e64 7479  = 0 and self.dty
+00009030: 7065 203d 3d20 696e 7420 616e 6420 7365  pe == int and se
+00009040: 6c66 2e69 7363 6f6e 7374 616e 743a 0a20  lf.isconstant:. 
+00009050: 2020 2020 2020 2020 2020 2076 616c 7565             value
+00009060: 203d 2073 656c 662e 5f5f 696e 6465 785f   = self.__index_
+00009070: 5f28 290a 2020 2020 2020 2020 2020 2020  _().            
+00009080: 7265 7475 726e 2076 616c 7565 2c20 7661  return value, va
+00009090: 6c75 650a 2020 2020 2020 2020 656c 7365  lue.        else
+000090a0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+000090b0: 7765 722c 2075 7070 6572 203d 2073 656c  wer, upper = sel
+000090c0: 662e 5f69 6e74 626f 756e 6473 5f69 6d70  f._intbounds_imp
+000090d0: 6c28 290a 2020 2020 2020 2020 2020 2020  l().            
+000090e0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+000090f0: 6528 6c6f 7765 722c 2069 6e74 2920 6f72  e(lower, int) or
+00009100: 206c 6f77 6572 203d 3d20 666c 6f61 7428   lower == float(
+00009110: 272d 696e 6627 2920 6f72 206c 6f77 6572  '-inf') or lower
+00009120: 203d 3d20 666c 6f61 7428 2769 6e66 2729   == float('inf')
+00009130: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00009140: 6572 7420 6973 696e 7374 616e 6365 2875  ert isinstance(u
+00009150: 7070 6572 2c20 696e 7429 206f 7220 7570  pper, int) or up
+00009160: 7065 7220 3d3d 2066 6c6f 6174 2827 2d69  per == float('-i
+00009170: 6e66 2729 206f 7220 7570 7065 7220 3d3d  nf') or upper ==
+00009180: 2066 6c6f 6174 2827 696e 6627 290a 2020   float('inf').  
+00009190: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000091a0: 206c 6f77 6572 203c 3d20 7570 7065 720a   lower <= upper.
+000091b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000091c0: 726e 206c 6f77 6572 2c20 7570 7065 720a  rn lower, upper.
+000091d0: 0a20 2020 2064 6566 205f 696e 7462 6f75  .    def _intbou
+000091e0: 6e64 735f 696d 706c 2873 656c 6629 3a0a  nds_impl(self):.
+000091f0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+00009200: 6c6f 6174 2827 2d69 6e66 2729 2c20 666c  loat('-inf'), fl
+00009210: 6f61 7428 2769 6e66 2729 0a0a 2020 2020  oat('inf')..    
+00009220: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00009230: 6620 5f63 6f6e 7374 5f75 6e69 666f 726d  f _const_uniform
+00009240: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00009250: 6966 2073 656c 662e 6474 7970 6520 3d3d  if self.dtype ==
+00009260: 2069 6e74 3a0a 2020 2020 2020 2020 2020   int:.          
+00009270: 2020 6c6f 7765 722c 2075 7070 6572 203d    lower, upper =
+00009280: 2073 656c 662e 5f69 6e74 626f 756e 6473   self._intbounds
+00009290: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000092a0: 7572 6e20 6c6f 7765 7220 6966 206c 6f77  urn lower if low
+000092b0: 6572 203d 3d20 7570 7065 7220 656c 7365  er == upper else
+000092c0: 204e 6f6e 650a 0a0a 636c 6173 7320 4e50   None...class NP
+000092d0: 6f69 6e74 7328 4172 7261 7929 3a0a 2020  oints(Array):.  
+000092e0: 2020 2754 6865 206c 656e 6774 6820 6f66    'The length of
+000092f0: 2074 6865 2070 6f69 6e74 7320 6178 6973   the points axis
+00009300: 2e27 0a0a 2020 2020 6465 6620 5f5f 696e  .'..    def __in
+00009310: 6974 5f5f 2873 656c 6629 3a0a 2020 2020  it__(self):.    
+00009320: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+00009330: 6974 5f5f 2861 7267 733d 2845 5641 4c41  it__(args=(EVALA
+00009340: 5247 532c 292c 2073 6861 7065 3d28 292c  RGS,), shape=(),
+00009350: 2064 7479 7065 3d69 6e74 290a 0a20 2020   dtype=int)..   
+00009360: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+00009370: 2020 2064 6566 2065 7661 6c66 2865 7661     def evalf(eva
+00009380: 6c61 7267 7329 3a0a 2020 2020 2020 2020  largs):.        
+00009390: 706f 696e 7473 203d 2065 7661 6c61 7267  points = evalarg
+000093a0: 735b 275f 706f 696e 7473 275d 2e63 6f6f  s['_points'].coo
+000093b0: 7264 730a 2020 2020 2020 2020 7265 7475  rds.        retu
+000093c0: 726e 2074 7970 6573 2e66 726f 7a65 6e61  rn types.frozena
+000093d0: 7272 6179 2870 6f69 6e74 732e 7368 6170  rray(points.shap
+000093e0: 655b 305d 290a 0a20 2020 2064 6566 205f  e[0])..    def _
+000093f0: 696e 7462 6f75 6e64 735f 696d 706c 2873  intbounds_impl(s
+00009400: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+00009410: 7475 726e 2030 2c20 666c 6f61 7428 2769  turn 0, float('i
+00009420: 6e66 2729 0a0a 0a63 6c61 7373 2050 6f69  nf')...class Poi
+00009430: 6e74 7328 4172 7261 7929 3a0a 0a20 2020  nts(Array):..   
+00009440: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00009450: 6c66 2c20 6e70 6f69 6e74 732c 206e 6469  lf, npoints, ndi
+00009460: 6d29 3a0a 2020 2020 2020 2020 7375 7065  m):.        supe
+00009470: 7228 292e 5f5f 696e 6974 5f5f 2861 7267  r().__init__(arg
+00009480: 733d 2845 5641 4c41 5247 532c 292c 2073  s=(EVALARGS,), s
+00009490: 6861 7065 3d28 6e70 6f69 6e74 732c 206e  hape=(npoints, n
+000094a0: 6469 6d29 2c20 6474 7970 653d 666c 6f61  dim), dtype=floa
+000094b0: 7429 0a0a 2020 2020 4073 7461 7469 636d  t)..    @staticm
+000094c0: 6574 686f 640a 2020 2020 6465 6620 6576  ethod.    def ev
+000094d0: 616c 6628 6576 616c 6172 6773 293a 0a20  alf(evalargs):. 
+000094e0: 2020 2020 2020 2072 6574 7572 6e20 6576         return ev
+000094f0: 616c 6172 6773 5b27 5f70 6f69 6e74 7327  alargs['_points'
+00009500: 5d2e 636f 6f72 6473 0a0a 0a63 6c61 7373  ].coords...class
+00009510: 2057 6569 6768 7473 2841 7272 6179 293a   Weights(Array):
+00009520: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00009530: 5f5f 2873 656c 662c 206e 706f 696e 7473  __(self, npoints
+00009540: 293a 0a20 2020 2020 2020 2073 7570 6572  ):.        super
+00009550: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
+00009560: 3d28 4556 414c 4152 4753 2c29 2c20 7368  =(EVALARGS,), sh
+00009570: 6170 653d 286e 706f 696e 7473 2c29 2c20  ape=(npoints,), 
+00009580: 6474 7970 653d 666c 6f61 7429 0a0a 2020  dtype=float)..  
+00009590: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+000095a0: 2020 2020 6465 6620 6576 616c 6628 6576      def evalf(ev
+000095b0: 616c 6172 6773 293a 0a20 2020 2020 2020  alargs):.       
+000095c0: 2077 6569 6768 7473 203d 2065 7661 6c61   weights = evala
+000095d0: 7267 735b 275f 706f 696e 7473 275d 2e77  rgs['_points'].w
+000095e0: 6569 6768 7473 0a20 2020 2020 2020 2061  eights.        a
+000095f0: 7373 6572 7420 6e75 6d65 7269 632e 6973  ssert numeric.is
+00009600: 6172 7261 7928 7765 6967 6874 7329 2061  array(weights) a
+00009610: 6e64 2077 6569 6768 7473 2e6e 6469 6d20  nd weights.ndim 
+00009620: 3d3d 2031 0a20 2020 2020 2020 2072 6574  == 1.        ret
+00009630: 7572 6e20 7765 6967 6874 730a 0a0a 636c  urn weights...cl
+00009640: 6173 7320 4f72 7468 6f6e 6f72 6d61 6c28  ass Orthonormal(
+00009650: 4172 7261 7929 3a0a 2020 2020 276d 616b  Array):.    'mak
+00009660: 6520 6120 7665 6374 6f72 206f 7274 686f  e a vector ortho
+00009670: 6e6f 726d 616c 2074 6f20 6120 7375 6273  normal to a subs
+00009680: 7061 6365 270a 0a20 2020 2064 6566 205f  pace'..    def _
+00009690: 5f69 6e69 745f 5f28 7365 6c66 2c20 6261  _init__(self, ba
+000096a0: 7369 733a 2041 7272 6179 2c20 7665 6374  sis: Array, vect
+000096b0: 6f72 3a20 4172 7261 7929 3a0a 2020 2020  or: Array):.    
+000096c0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+000096d0: 7461 6e63 6528 6261 7369 732c 2041 7272  tance(basis, Arr
+000096e0: 6179 2920 616e 6420 6261 7369 732e 6e64  ay) and basis.nd
+000096f0: 696d 203e 3d20 3220 616e 6420 6261 7369  im >= 2 and basi
+00009700: 732e 6474 7970 6520 213d 2063 6f6d 706c  s.dtype != compl
+00009710: 6578 2c20 6627 6261 7369 733d 7b62 6173  ex, f'basis={bas
+00009720: 6973 2172 7d27 0a20 2020 2020 2020 2061  is!r}'.        a
+00009730: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00009740: 2876 6563 746f 722c 2041 7272 6179 2920  (vector, Array) 
+00009750: 616e 6420 7665 6374 6f72 2e6e 6469 6d20  and vector.ndim 
+00009760: 3e3d 2031 2061 6e64 2076 6563 746f 722e  >= 1 and vector.
+00009770: 6474 7970 6520 213d 2063 6f6d 706c 6578  dtype != complex
+00009780: 2c20 6627 7665 6374 6f72 3d7b 7665 6374  , f'vector={vect
+00009790: 6f72 2172 7d27 0a20 2020 2020 2020 2061  or!r}'.        a
+000097a0: 7373 6572 7420 6571 7561 6c73 6861 7065  ssert equalshape
+000097b0: 2862 6173 6973 2e73 6861 7065 5b3a 2d31  (basis.shape[:-1
+000097c0: 5d2c 2076 6563 746f 722e 7368 6170 6529  ], vector.shape)
+000097d0: 0a20 2020 2020 2020 2073 656c 662e 5f62  .        self._b
+000097e0: 6173 6973 203d 2062 6173 6973 0a20 2020  asis = basis.   
+000097f0: 2020 2020 2073 656c 662e 5f76 6563 746f       self._vecto
+00009800: 7220 3d20 7665 6374 6f72 0a20 2020 2020  r = vector.     
+00009810: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00009820: 745f 5f28 6172 6773 3d28 6261 7369 732c  t__(args=(basis,
+00009830: 2076 6563 746f 7229 2c20 7368 6170 653d   vector), shape=
+00009840: 7665 6374 6f72 2e73 6861 7065 2c20 6474  vector.shape, dt
+00009850: 7970 653d 666c 6f61 7429 0a0a 2020 2020  ype=float)..    
+00009860: 6465 6620 5f73 696d 706c 6966 6965 6428  def _simplified(
+00009870: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
+00009880: 6620 5f65 7175 616c 735f 7363 616c 6172  f _equals_scalar
+00009890: 5f63 6f6e 7374 616e 7428 7365 6c66 2e73  _constant(self.s
+000098a0: 6861 7065 5b2d 315d 2c20 3129 3a0a 2020  hape[-1], 1):.  
+000098b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000098c0: 2053 6967 6e28 7365 6c66 2e5f 7665 6374   Sign(self._vect
+000098d0: 6f72 290a 2020 2020 2020 2020 6261 7369  or).        basi
+000098e0: 732c 2076 6563 746f 722c 2077 6865 7265  s, vector, where
+000098f0: 203d 2075 6e61 6c69 676e 2873 656c 662e   = unalign(self.
+00009900: 5f62 6173 6973 2c20 7365 6c66 2e5f 7665  _basis, self._ve
+00009910: 6374 6f72 2c20 6e61 7865 733d 7365 6c66  ctor, naxes=self
+00009920: 2e6e 6469 6d20 2d20 3129 0a20 2020 2020  .ndim - 1).     
+00009930: 2020 2069 6620 6c65 6e28 7768 6572 6529     if len(where)
+00009940: 203c 2073 656c 662e 6e64 696d 202d 2031   < self.ndim - 1
+00009950: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00009960: 7475 726e 2061 6c69 676e 284f 7274 686f  turn align(Ortho
+00009970: 6e6f 726d 616c 2862 6173 6973 2c20 7665  normal(basis, ve
+00009980: 6374 6f72 292c 2028 2a77 6865 7265 2c20  ctor), (*where, 
+00009990: 7365 6c66 2e6e 6469 6d20 2d20 3129 2c20  self.ndim - 1), 
+000099a0: 7365 6c66 2e73 6861 7065 290a 0a20 2020  self.shape)..   
+000099b0: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+000099c0: 2020 2064 6566 2065 7661 6c66 2847 2c20     def evalf(G, 
+000099d0: 6e29 3a0a 2020 2020 2020 2020 4747 203d  n):.        GG =
+000099e0: 206e 756d 7079 2e65 696e 7375 6d28 272e   numpy.einsum('.
+000099f0: 2e2e 6b69 2c2e 2e2e 6b6a 2d3e 2e2e 2e69  ..ki,...kj->...i
+00009a00: 6a27 2c20 472c 2047 290a 2020 2020 2020  j', G, G).      
+00009a10: 2020 7631 203d 206e 756d 7079 2e65 696e    v1 = numpy.ein
+00009a20: 7375 6d28 272e 2e2e 696a 2c2e 2e2e 692d  sum('...ij,...i-
+00009a30: 3e2e 2e2e 6a27 2c20 472c 206e 290a 2020  >...j', G, n).  
+00009a40: 2020 2020 2020 7632 203d 206e 756d 7079        v2 = numpy
+00009a50: 2e6c 696e 616c 672e 736f 6c76 6528 4747  .linalg.solve(GG
+00009a60: 2c20 7631 290a 2020 2020 2020 2020 7633  , v1).        v3
+00009a70: 203d 206e 756d 7079 2e65 696e 7375 6d28   = numpy.einsum(
+00009a80: 272e 2e2e 696a 2c2e 2e2e 6a2d 3e2e 2e2e  '...ij,...j->...
+00009a90: 6927 2c20 472c 2076 3229 0a20 2020 2020  i', G, v2).     
+00009aa0: 2020 2072 6574 7572 6e20 6e75 6d65 7269     return numeri
+00009ab0: 632e 6e6f 726d 616c 697a 6528 6e20 2d20  c.normalize(n - 
+00009ac0: 7633 290a 0a20 2020 2064 6566 205f 6465  v3)..    def _de
+00009ad0: 7269 7661 7469 7665 2873 656c 662c 2076  rivative(self, v
+00009ae0: 6172 2c20 7365 656e 293a 0a20 2020 2020  ar, seen):.     
+00009af0: 2020 2069 6620 5f65 7175 616c 735f 7363     if _equals_sc
+00009b00: 616c 6172 5f63 6f6e 7374 616e 7428 7365  alar_constant(se
+00009b10: 6c66 2e73 6861 7065 5b2d 315d 2c20 3129  lf.shape[-1], 1)
+00009b20: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00009b30: 7475 726e 207a 6572 6f73 2873 656c 662e  turn zeros(self.
+00009b40: 7368 6170 6520 2b20 7661 722e 7368 6170  shape + var.shap
+00009b50: 6529 0a0a 2020 2020 2020 2020 2320 6465  e)..        # de
+00009b60: 6669 6e69 7469 6f6e 733a 0a20 2020 2020  finitions:.     
+00009b70: 2020 2023 0a20 2020 2020 2020 2023 2050     #.        # P
+00009b80: 203a 3d20 4920 2d20 4720 2847 5e54 2047   := I - G (G^T G
+00009b90: 295e 2d31 2047 5e54 2028 6f72 7468 6f67  )^-1 G^T (orthog
+00009ba0: 6f6e 616c 2070 726f 6a65 6374 6f72 290a  onal projector).
+00009bb0: 2020 2020 2020 2020 2320 6e20 3a3d 2050          # n := P
+00009bc0: 2076 2028 6f72 7468 6f67 6f6e 616c 2070   v (orthogonal p
+00009bd0: 726f 6a65 6374 696f 6e20 6f66 2076 290a  rojection of v).
+00009be0: 2020 2020 2020 2020 2320 4e20 3a3d 206e          # N := n
+00009bf0: 202f 207c 6e7c 2028 7365 6c66 3a20 6f72   / |n| (self: or
+00009c00: 7468 6f6e 6f72 6d61 6c20 7072 6f6a 6563  thonormal projec
+00009c10: 7469 6f6e 206f 6620 7629 0a20 2020 2020  tion of v).     
+00009c20: 2020 2023 0a20 2020 2020 2020 2023 2069     #.        # i
+00009c30: 6465 6e74 6974 6965 733a 0a20 2020 2020  dentities:.     
+00009c40: 2020 2023 0a20 2020 2020 2020 2023 2020     #.        #  
+00009c50: 2050 5e54 203d 2050 2020 2020 2020 2020   P^T = P        
+00009c60: 2020 4e5e 5420 4e20 3d20 310a 2020 2020    N^T N = 1.    
+00009c70: 2020 2020 2320 2020 5020 5020 3d20 5020      #   P P = P 
+00009c80: 2020 2020 2020 2020 2050 204e 203d 204e           P N = N
+00009c90: 0a20 2020 2020 2020 2023 2020 2050 2047  .        #   P G
+00009ca0: 203d 2050 2051 203d 2030 2020 2020 475e   = P Q = 0    G^
+00009cb0: 5420 4e20 3d20 515e 5420 4e20 3d20 300a  T N = Q^T N = 0.
+00009cc0: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
+00009cd0: 2020 2320 6465 7269 7661 7469 7665 733a    # derivatives:
+00009ce0: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
+00009cf0: 2020 2023 2050 2720 3d20 5120 5020 2b20     # P' = Q P + 
+00009d00: 5020 515e 5420 7768 6572 6520 5120 3a3d  P Q^T where Q :=
+00009d10: 202d 4720 2847 5e54 2047 295e 2d31 2047   -G (G^T G)^-1 G
+00009d20: 275e 540a 2020 2020 2020 2020 2320 6e27  '^T.        # n'
+00009d30: 203d 2050 2720 7620 2b20 5020 7627 0a20   = P' v + P v'. 
+00009d40: 2020 2020 2020 2023 2020 2020 3d20 5120         #    = Q 
+00009d50: 6e20 2b20 5020 2851 5e54 2076 202b 2076  n + P (Q^T v + v
+00009d60: 2729 0a20 2020 2020 2020 2023 204e 2720  ').        # N' 
+00009d70: 3d20 2849 202d 204e 204e 5e54 2920 6e27  = (I - N N^T) n'
+00009d80: 202f 207c 6e7c 0a20 2020 2020 2020 2023   / |n|.        #
+00009d90: 2020 2020 3d20 2849 202d 204e 204e 5e54      = (I - N N^T
+00009da0: 2920 2851 206e 202f 207c 6e7c 202b 2050  ) (Q n / |n| + P
+00009db0: 2028 515e 5420 7620 2b20 7627 2920 2f20   (Q^T v + v') / 
+00009dc0: 7c6e 7c29 0a20 2020 2020 2020 2023 2020  |n|).        #  
+00009dd0: 2020 3d20 5120 4e20 2b20 2850 202d 204e    = Q N + (P - N
+00009de0: 204e 5e54 2920 2851 5e54 2076 202b 2076   N^T) (Q^T v + v
+00009df0: 2729 202f 207c 6e7c 0a0a 2020 2020 2020  ') / |n|..      
+00009e00: 2020 4720 3d20 7365 6c66 2e5f 6261 7369    G = self._basi
+00009e10: 730a 2020 2020 2020 2020 696e 7647 4720  s.        invGG 
+00009e20: 3d20 696e 7665 7273 6528 6569 6e73 756d  = inverse(einsum
+00009e30: 2827 416b 692c 416b 6a2d 3e41 696a 272c  ('Aki,Akj->Aij',
+00009e40: 2047 2c20 4729 290a 0a20 2020 2020 2020   G, G))..       
+00009e50: 2051 203d 202d 6569 6e73 756d 2827 4169   Q = -einsum('Ai
+00009e60: 6d2c 416d 6e2c 416a 6e42 2d3e 4169 6a42  m,Amn,AjnB->AijB
+00009e70: 272c 2047 2c20 696e 7647 472c 2064 6572  ', G, invGG, der
+00009e80: 6976 6174 6976 6528 472c 2076 6172 2c20  ivative(G, var, 
+00009e90: 7365 656e 2929 0a20 2020 2020 2020 2051  seen)).        Q
+00009ea0: 4e20 3d20 6569 6e73 756d 2827 4169 2c41  N = einsum('Ai,A
+00009eb0: 6a69 422d 3e41 6a42 272c 2073 656c 662c  jiB->AjB', self,
+00009ec0: 2051 290a 0a20 2020 2020 2020 2069 6620   Q)..        if 
+00009ed0: 5f65 7175 616c 735f 7369 6d70 6c69 6669  _equals_simplifi
+00009ee0: 6564 2847 2e73 6861 7065 5b2d 315d 2c20  ed(G.shape[-1], 
+00009ef0: 472e 7368 6170 655b 2d32 5d20 2d20 3129  G.shape[-2] - 1)
+00009f00: 3a20 2320 6469 6d28 6b65 726e 2847 2929  : # dim(kern(G))
+00009f10: 203d 2031 0a20 2020 2020 2020 2020 2020   = 1.           
+00009f20: 2023 2049 6e20 7468 6973 2073 6974 7561   # In this situa
+00009f30: 7469 6f6e 2c20 7369 6e63 6520 4e20 6973  tion, since N is
+00009f40: 2061 2062 6173 6973 2066 6f72 2074 6865   a basis for the
+00009f50: 206b 6572 6e65 6c20 6f66 2047 2c20 7765   kernel of G, we
+00009f60: 0a20 2020 2020 2020 2020 2020 2023 2068  .            # h
+00009f70: 6176 6520 7468 6520 6964 656e 7469 7479  ave the identity
+00009f80: 2050 203d 3d20 4e20 4e5e 5420 7768 6963   P == N N^T whic
+00009f90: 6820 6361 6e63 656c 7320 7468 6520 656e  h cancels the en
+00009fa0: 7469 7265 2073 6563 6f6e 6420 7465 726d  tire second term
+00009fb0: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
+00009fc0: 6620 4e27 2061 6c6f 6e67 2077 6974 6820  f N' along with 
+00009fd0: 616e 7920 7265 6665 7265 6e63 6520 746f  any reference to
+00009fe0: 2076 272c 2072 6564 7563 696e 6720 6974   v', reducing it
+00009ff0: 2074 6f20 4e27 203d 2051 204e 2e0a 2020   to N' = Q N..  
+0000a000: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000a010: 2051 4e0a 0a20 2020 2020 2020 2076 203d   QN..        v =
+0000a020: 2073 656c 662e 5f76 6563 746f 720a 2020   self._vector.  
+0000a030: 2020 2020 2020 5020 3d20 4469 6167 6f6e        P = Diagon
+0000a040: 616c 697a 6528 6f6e 6573 2873 656c 662e  alize(ones(self.
+0000a050: 7368 6170 6529 2920 2d20 6569 6e73 756d  shape)) - einsum
+0000a060: 2827 4169 6d2c 416d 6e2c 416a 6e2d 3e41  ('Aim,Amn,Ajn->A
+0000a070: 696a 272c 2047 2c20 696e 7647 472c 2047  ij', G, invGG, G
+0000a080: 290a 2020 2020 2020 2020 5a20 3d20 5020  ).        Z = P 
+0000a090: 2d20 6569 6e73 756d 2827 4169 2c41 6a2d  - einsum('Ai,Aj-
+0000a0a0: 3e41 696a 272c 2073 656c 662c 2073 656c  >Aij', self, sel
+0000a0b0: 6629 2023 2050 202d 204e 204e 5e54 0a0a  f) # P - N N^T..
+0000a0c0: 2020 2020 2020 2020 7265 7475 726e 2051          return Q
+0000a0d0: 4e20 2b20 6569 6e73 756d 2827 412c 4169  N + einsum('A,Ai
+0000a0e0: 422d 3e41 6942 272c 0a20 2020 2020 2020  B->AiB',.       
+0000a0f0: 2020 2020 2070 6f77 6572 2865 696e 7375       power(einsu
+0000a100: 6d28 2741 692c 4169 6a2c 416a 2d3e 4127  m('Ai,Aij,Aj->A'
+0000a110: 2c20 762c 2050 2c20 7629 2c20 2d2e 3529  , v, P, v), -.5)
+0000a120: 2c0a 2020 2020 2020 2020 2020 2020 6569  ,.            ei
+0000a130: 6e73 756d 2827 4169 6a2c 416a 422d 3e41  nsum('Aij,AjB->A
+0000a140: 6942 272c 205a 2c20 6569 6e73 756d 2827  iB', Z, einsum('
+0000a150: 4169 2c41 696a 422d 3e41 6a42 272c 2076  Ai,AijB->AjB', v
+0000a160: 2c20 5129 202b 2064 6572 6976 6174 6976  , Q) + derivativ
+0000a170: 6528 762c 2076 6172 2c20 7365 656e 2929  e(v, var, seen))
+0000a180: 290a 0a0a 636c 6173 7320 436f 6e73 7461  )...class Consta
+0000a190: 6e74 2841 7272 6179 293a 0a0a 2020 2020  nt(Array):..    
+0000a1a0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+0000a1b0: 662c 2076 616c 7565 3a20 7479 7065 732e  f, value: types.
+0000a1c0: 6172 7261 7964 6174 6129 3a0a 2020 2020  arraydata):.    
+0000a1d0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0000a1e0: 7461 6e63 6528 7661 6c75 652c 2074 7970  tance(value, typ
+0000a1f0: 6573 2e61 7272 6179 6461 7461 292c 2066  es.arraydata), f
+0000a200: 2776 616c 7565 3d7b 7661 6c75 6521 727d  'value={value!r}
+0000a210: 270a 2020 2020 2020 2020 7365 6c66 2e76  '.        self.v
+0000a220: 616c 7565 203d 206e 756d 7079 2e61 7361  alue = numpy.asa
+0000a230: 7272 6179 2876 616c 7565 290a 2020 2020  rray(value).    
+0000a240: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+0000a250: 6974 5f5f 2861 7267 733d 2829 2c20 7368  it__(args=(), sh
+0000a260: 6170 653d 7475 706c 6528 636f 6e73 7461  ape=tuple(consta
+0000a270: 6e74 286e 2920 666f 7220 6e20 696e 2076  nt(n) for n in v
+0000a280: 616c 7565 2e73 6861 7065 292c 2064 7479  alue.shape), dty
+0000a290: 7065 3d76 616c 7565 2e64 7479 7065 290a  pe=value.dtype).
+0000a2a0: 0a20 2020 2064 6566 205f 7369 6d70 6c69  .    def _simpli
+0000a2b0: 6669 6564 2873 656c 6629 3a0a 2020 2020  fied(self):.    
+0000a2c0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+0000a2d0: 7661 6c75 652e 616e 7928 293a 0a20 2020  value.any():.   
+0000a2e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000a2f0: 7a65 726f 735f 6c69 6b65 2873 656c 6629  zeros_like(self)
+0000a300: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0000a310: 2e6e 6469 6d20 3d3d 2031 2061 6e64 2073  .ndim == 1 and s
+0000a320: 656c 662e 6474 7970 6520 3d3d 2069 6e74  elf.dtype == int
+0000a330: 2061 6e64 206e 756d 7079 2e61 6c6c 2873   and numpy.all(s
+0000a340: 656c 662e 7661 6c75 6520 3d3d 206e 756d  elf.value == num
+0000a350: 7079 2e61 7261 6e67 6528 7365 6c66 2e76  py.arange(self.v
+0000a360: 616c 7565 2e73 6861 7065 5b30 5d29 293a  alue.shape[0])):
+0000a370: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000a380: 7572 6e20 5261 6e67 6528 7365 6c66 2e73  urn Range(self.s
+0000a390: 6861 7065 5b30 5d29 0a20 2020 2020 2020  hape[0]).       
+0000a3a0: 2066 6f72 2069 2c20 7368 2069 6e20 656e   for i, sh in en
+0000a3b0: 756d 6572 6174 6528 7365 6c66 2e73 6861  umerate(self.sha
+0000a3c0: 7065 293a 0a20 2020 2020 2020 2020 2020  pe):.           
+0000a3d0: 2023 2046 696e 6420 616e 6420 7265 706c   # Find and repl
+0000a3e0: 6163 6520 696e 7661 7269 616e 7420 6178  ace invariant ax
+0000a3f0: 6573 2077 6974 6820 496e 7365 7274 4178  es with InsertAx
+0000a400: 6973 2e20 5369 6e63 6520 6073 656c 662e  is. Since `self.
+0000a410: 7661 6c75 652e 616e 7928 2960 0a20 2020  value.any()`.   
+0000a420: 2020 2020 2020 2020 2023 2069 7320 4661           # is Fa
+0000a430: 6c73 6520 666f 7220 6172 7261 7973 2077  lse for arrays w
+0000a440: 6974 6820 6120 7a65 726f 2d6c 656e 6774  ith a zero-lengt
+0000a450: 6820 6178 6973 2c20 7765 2063 616e 2061  h axis, we can a
+0000a460: 7272 6976 6520 6865 7265 206f 6e6c 7920  rrive here only 
+0000a470: 6966 2061 6c6c 0a20 2020 2020 2020 2020  if all.         
+0000a480: 2020 2023 2061 7865 7320 6861 7665 2061     # axes have a
+0000a490: 7420 6c65 6173 7420 6c65 6e67 7468 206f  t least length o
+0000a4a0: 6e65 2c20 6865 6e63 6520 7468 6520 666f  ne, hence the fo
+0000a4b0: 6c6c 6f77 696e 6720 7374 6174 656d 656e  llowing statemen
+0000a4c0: 7420 7368 6f75 6c64 2077 6f72 6b2e 0a20  t should work.. 
+0000a4d0: 2020 2020 2020 2020 2020 2066 6972 7374             first
+0000a4e0: 2c20 2a6f 7468 6572 7320 3d20 6e75 6d70  , *others = nump
+0000a4f0: 792e 726f 6c6c 6178 6973 2873 656c 662e  y.rollaxis(self.
+0000a500: 7661 6c75 652c 2069 290a 2020 2020 2020  value, i).      
+0000a510: 2020 2020 2020 6966 2061 6c6c 286e 756d        if all(num
+0000a520: 7079 2e65 7175 616c 2866 6972 7374 2c20  py.equal(first, 
+0000a530: 6f74 6865 7229 2e61 6c6c 2829 2066 6f72  other).all() for
+0000a540: 206f 7468 6572 2069 6e20 6f74 6865 7273   other in others
+0000a550: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000a560: 2020 2072 6574 7572 6e20 696e 7365 7274     return insert
+0000a570: 6178 6973 2863 6f6e 7374 616e 7428 6669  axis(constant(fi
+0000a580: 7273 7429 2c20 692c 2073 6829 0a0a 2020  rst), i, sh)..  
+0000a590: 2020 6465 6620 6576 616c 6628 7365 6c66    def evalf(self
+0000a5a0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+0000a5b0: 6e20 7365 6c66 2e76 616c 7565 0a0a 2020  n self.value..  
+0000a5c0: 2020 6465 6620 5f6e 6f64 6528 7365 6c66    def _node(self
+0000a5d0: 2c20 6361 6368 652c 2073 7562 6772 6170  , cache, subgrap
+0000a5e0: 682c 2074 696d 6573 293a 0a20 2020 2020  h, times):.     
+0000a5f0: 2020 2069 6620 7365 6c66 2e6e 6469 6d3a     if self.ndim:
+0000a600: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000a610: 7572 6e20 7375 7065 7228 292e 5f6e 6f64  urn super()._nod
+0000a620: 6528 6361 6368 652c 2073 7562 6772 6170  e(cache, subgrap
+0000a630: 682c 2074 696d 6573 290a 2020 2020 2020  h, times).      
+0000a640: 2020 656c 6966 2073 656c 6620 696e 2063    elif self in c
+0000a650: 6163 6865 3a0a 2020 2020 2020 2020 2020  ache:.          
+0000a660: 2020 7265 7475 726e 2063 6163 6865 5b73    return cache[s
+0000a670: 656c 665d 0a20 2020 2020 2020 2065 6c73  elf].        els
+0000a680: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
+0000a690: 6162 656c 203d 2027 7b7d 272e 666f 726d  abel = '{}'.form
+0000a6a0: 6174 2873 656c 662e 7661 6c75 655b 2829  at(self.value[()
+0000a6b0: 5d29 0a20 2020 2020 2020 2020 2020 2069  ]).            i
+0000a6c0: 6620 6c65 6e28 6c61 6265 6c29 203e 2039  f len(label) > 9
+0000a6d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a6e0: 2020 6c61 6265 6c20 3d20 277e 7b3a 2e32    label = '~{:.2
+0000a6f0: 657d 272e 666f 726d 6174 2873 656c 662e  e}'.format(self.
+0000a700: 7661 6c75 655b 2829 5d29 0a20 2020 2020  value[()]).     
+0000a710: 2020 2020 2020 2063 6163 6865 5b73 656c         cache[sel
+0000a720: 665d 203d 206e 6f64 6520 3d20 4475 706c  f] = node = Dupl
+0000a730: 6963 6174 6564 4c65 6166 4e6f 6465 286c  icatedLeafNode(l
+0000a740: 6162 656c 2c20 2874 7970 6528 7365 6c66  abel, (type(self
+0000a750: 292e 5f5f 6e61 6d65 5f5f 2c20 7469 6d65  ).__name__, time
+0000a760: 735b 7365 6c66 5d29 290a 2020 2020 2020  s[self])).      
+0000a770: 2020 2020 2020 7265 7475 726e 206e 6f64        return nod
+0000a780: 650a 0a20 2020 2040 6361 6368 6564 5f70  e..    @cached_p
+0000a790: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+0000a7a0: 5f69 7375 6e69 7428 7365 6c66 293a 0a20  _isunit(self):. 
+0000a7b0: 2020 2020 2020 2072 6574 7572 6e20 6e75         return nu
+0000a7c0: 6d70 792e 6571 7561 6c28 7365 6c66 2e76  mpy.equal(self.v
+0000a7d0: 616c 7565 2c20 3129 2e61 6c6c 2829 0a0a  alue, 1).all()..
+0000a7e0: 2020 2020 6465 6620 5f74 7261 6e73 706f      def _transpo
+0000a7f0: 7365 2873 656c 662c 2061 7865 7329 3a0a  se(self, axes):.
+0000a800: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+0000a810: 6f6e 7374 616e 7428 7365 6c66 2e76 616c  onstant(self.val
+0000a820: 7565 2e74 7261 6e73 706f 7365 2861 7865  ue.transpose(axe
+0000a830: 7329 290a 0a20 2020 2064 6566 205f 7375  s))..    def _su
+0000a840: 6d28 7365 6c66 2c20 6178 6973 293a 0a20  m(self, axis):. 
+0000a850: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
+0000a860: 6e73 7461 6e74 286e 756d 7079 2e73 756d  nstant(numpy.sum
+0000a870: 2873 656c 662e 7661 6c75 652c 2061 7869  (self.value, axi
+0000a880: 7329 290a 0a20 2020 2064 6566 205f 6164  s))..    def _ad
+0000a890: 6428 7365 6c66 2c20 6f74 6865 7229 3a0a  d(self, other):.
+0000a8a0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0000a8b0: 7461 6e63 6528 6f74 6865 722c 2043 6f6e  tance(other, Con
+0000a8c0: 7374 616e 7429 3a0a 2020 2020 2020 2020  stant):.        
+0000a8d0: 2020 2020 7265 7475 726e 2063 6f6e 7374      return const
+0000a8e0: 616e 7428 6e75 6d70 792e 6164 6428 7365  ant(numpy.add(se
+0000a8f0: 6c66 2e76 616c 7565 2c20 6f74 6865 722e  lf.value, other.
+0000a900: 7661 6c75 6529 290a 0a20 2020 2064 6566  value))..    def
+0000a910: 205f 696e 7665 7273 6528 7365 6c66 2c20   _inverse(self, 
+0000a920: 6178 6973 312c 2061 7869 7332 293a 0a20  axis1, axis2):. 
+0000a930: 2020 2020 2020 2061 7373 6572 7420 3020         assert 0 
+0000a940: 3c3d 2061 7869 7331 203c 2061 7869 7332  <= axis1 < axis2
+0000a950: 203c 2073 656c 662e 6e64 696d 0a20 2020   < self.ndim.   
+0000a960: 2020 2020 2061 7865 7320 3d20 282a 7261       axes = (*ra
+0000a970: 6e67 6528 6178 6973 3129 2c20 2a72 616e  nge(axis1), *ran
+0000a980: 6765 2861 7869 7331 2b31 2c20 6178 6973  ge(axis1+1, axis
+0000a990: 3229 2c20 2a72 616e 6765 2861 7869 7332  2), *range(axis2
+0000a9a0: 2b31 2c20 7365 6c66 2e6e 6469 6d29 2c20  +1, self.ndim), 
+0000a9b0: 6178 6973 312c 2061 7869 7332 290a 2020  axis1, axis2).  
+0000a9c0: 2020 2020 2020 7661 6c75 6520 3d20 6e75        value = nu
+0000a9d0: 6d70 792e 7472 616e 7370 6f73 6528 7365  mpy.transpose(se
+0000a9e0: 6c66 2e76 616c 7565 2c20 6178 6573 290a  lf.value, axes).
+0000a9f0: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+0000aa00: 6f6e 7374 616e 7428 6e75 6d70 792e 7472  onstant(numpy.tr
+0000aa10: 616e 7370 6f73 6528 6e75 6d70 792e 6c69  anspose(numpy.li
+0000aa20: 6e61 6c67 2e69 6e76 2876 616c 7565 292c  nalg.inv(value),
+0000aa30: 206e 756d 7079 2e61 7267 736f 7274 2861   numpy.argsort(a
+0000aa40: 7865 7329 2929 0a0a 2020 2020 6465 6620  xes)))..    def 
+0000aa50: 5f70 726f 6475 6374 2873 656c 6629 3a0a  _product(self):.
+0000aa60: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+0000aa70: 6f6e 7374 616e 7428 7365 6c66 2e76 616c  onstant(self.val
+0000aa80: 7565 2e70 726f 6428 2d31 2929 0a0a 2020  ue.prod(-1))..  
+0000aa90: 2020 6465 6620 5f6d 756c 7469 706c 7928    def _multiply(
+0000aaa0: 7365 6c66 2c20 6f74 6865 7229 3a0a 2020  self, other):.  
+0000aab0: 2020 2020 2020 6966 2073 656c 662e 5f69        if self._i
+0000aac0: 7375 6e69 743a 0a20 2020 2020 2020 2020  sunit:.         
+0000aad0: 2020 2072 6574 7572 6e20 6f74 6865 720a     return other.
+0000aae0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0000aaf0: 7461 6e63 6528 6f74 6865 722c 2043 6f6e  tance(other, Con
+0000ab00: 7374 616e 7429 3a0a 2020 2020 2020 2020  stant):.        
+0000ab10: 2020 2020 7265 7475 726e 2063 6f6e 7374      return const
+0000ab20: 616e 7428 6e75 6d70 792e 6d75 6c74 6970  ant(numpy.multip
+0000ab30: 6c79 2873 656c 662e 7661 6c75 652c 206f  ly(self.value, o
+0000ab40: 7468 6572 2e76 616c 7565 2929 0a0a 2020  ther.value))..  
+0000ab50: 2020 6465 6620 5f74 616b 6564 6961 6728    def _takediag(
+0000ab60: 7365 6c66 2c20 6178 6973 312c 2061 7869  self, axis1, axi
+0000ab70: 7332 293a 0a20 2020 2020 2020 2061 7373  s2):.        ass
+0000ab80: 6572 7420 6178 6973 3120 3c20 6178 6973  ert axis1 < axis
+0000ab90: 320a 2020 2020 2020 2020 7265 7475 726e  2.        return
+0000aba0: 2063 6f6e 7374 616e 7428 6e75 6d70 792e   constant(numpy.
+0000abb0: 6569 6e73 756d 2827 2e2e 2e6b 6b2d 3e2e  einsum('...kk->.
+0000abc0: 2e2e 6b27 2c20 6e75 6d70 792e 7472 616e  ..k', numpy.tran
+0000abd0: 7370 6f73 6528 7365 6c66 2e76 616c 7565  spose(self.value
+0000abe0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000abf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac20: 2020 2020 2020 6c69 7374 2872 616e 6765        list(range
+0000ac30: 2861 7869 7331 2929 202b 206c 6973 7428  (axis1)) + list(
+0000ac40: 7261 6e67 6528 6178 6973 312b 312c 2061  range(axis1+1, a
+0000ac50: 7869 7332 2929 202b 206c 6973 7428 7261  xis2)) + list(ra
+0000ac60: 6e67 6528 6178 6973 322b 312c 2073 656c  nge(axis2+1, sel
+0000ac70: 662e 6e64 696d 2929 202b 205b 6178 6973  f.ndim)) + [axis
+0000ac80: 312c 2061 7869 7332 5d29 2929 0a0a 2020  1, axis2])))..  
+0000ac90: 2020 6465 6620 5f74 616b 6528 7365 6c66    def _take(self
+0000aca0: 2c20 696e 6465 782c 2061 7869 7329 3a0a  , index, axis):.
+0000acb0: 2020 2020 2020 2020 6966 2069 6e64 6578          if index
+0000acc0: 2e69 7363 6f6e 7374 616e 743a 0a20 2020  .isconstant:.   
+0000acd0: 2020 2020 2020 2020 2069 6e64 6578 5f20           index_ 
+0000ace0: 3d20 696e 6465 782e 6576 616c 2829 0a20  = index.eval(). 
+0000acf0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000ad00: 6e20 636f 6e73 7461 6e74 2873 656c 662e  n constant(self.
+0000ad10: 7661 6c75 652e 7461 6b65 2869 6e64 6578  value.take(index
+0000ad20: 5f2c 2061 7869 7329 290a 0a20 2020 2064  _, axis))..    d
+0000ad30: 6566 205f 706f 7765 7228 7365 6c66 2c20  ef _power(self, 
+0000ad40: 6e29 3a0a 2020 2020 2020 2020 6966 2069  n):.        if i
+0000ad50: 7369 6e73 7461 6e63 6528 6e2c 2043 6f6e  sinstance(n, Con
+0000ad60: 7374 616e 7429 3a0a 2020 2020 2020 2020  stant):.        
+0000ad70: 2020 2020 7265 7475 726e 2063 6f6e 7374      return const
+0000ad80: 616e 7428 6e75 6d70 792e 706f 7765 7228  ant(numpy.power(
+0000ad90: 7365 6c66 2e76 616c 7565 2c20 6e2e 7661  self.value, n.va
+0000ada0: 6c75 6529 290a 0a20 2020 2064 6566 205f  lue))..    def _
+0000adb0: 6569 6728 7365 6c66 2c20 7379 6d6d 6574  eig(self, symmet
+0000adc0: 7269 6329 3a0a 2020 2020 2020 2020 6569  ric):.        ei
+0000add0: 6776 616c 2c20 6569 6776 6563 203d 2028  gval, eigvec = (
+0000ade0: 6e75 6d70 792e 6c69 6e61 6c67 2e65 6967  numpy.linalg.eig
+0000adf0: 6820 6966 2073 796d 6d65 7472 6963 2065  h if symmetric e
+0000ae00: 6c73 6520 6e75 6d70 792e 6c69 6e61 6c67  lse numpy.linalg
+0000ae10: 2e65 6967 2928 7365 6c66 2e76 616c 7565  .eig)(self.value
+0000ae20: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+0000ae30: 2073 796d 6d65 7472 6963 3a0a 2020 2020   symmetric:.    
+0000ae40: 2020 2020 2020 2020 6569 6776 616c 203d          eigval =
+0000ae50: 2065 6967 7661 6c2e 6173 7479 7065 2863   eigval.astype(c
+0000ae60: 6f6d 706c 6578 2c20 636f 7079 3d46 616c  omplex, copy=Fal
+0000ae70: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+0000ae80: 6569 6776 6563 203d 2065 6967 7665 632e  eigvec = eigvec.
+0000ae90: 6173 7479 7065 2863 6f6d 706c 6578 2c20  astype(complex, 
+0000aea0: 636f 7079 3d46 616c 7365 290a 2020 2020  copy=False).    
+0000aeb0: 2020 2020 7265 7475 726e 2054 7570 6c65      return Tuple
+0000aec0: 2828 636f 6e73 7461 6e74 2865 6967 7661  ((constant(eigva
+0000aed0: 6c29 2c20 636f 6e73 7461 6e74 2865 6967  l), constant(eig
+0000aee0: 7665 6329 2929 0a0a 2020 2020 6465 6620  vec)))..    def 
+0000aef0: 5f73 6967 6e28 7365 6c66 293a 0a20 2020  _sign(self):.   
+0000af00: 2020 2020 2072 6574 7572 6e20 636f 6e73       return cons
+0000af10: 7461 6e74 286e 756d 7079 2e73 6967 6e28  tant(numpy.sign(
+0000af20: 7365 6c66 2e76 616c 7565 2929 0a0a 2020  self.value))..  
+0000af30: 2020 6465 6620 5f75 6e72 6176 656c 2873    def _unravel(s
+0000af40: 656c 662c 2061 7869 732c 2073 6861 7065  elf, axis, shape
+0000af50: 293a 0a20 2020 2020 2020 2073 6861 7065  ):.        shape
+0000af60: 203d 2073 656c 662e 7661 6c75 652e 7368   = self.value.sh
+0000af70: 6170 655b 3a61 7869 735d 202b 2073 6861  ape[:axis] + sha
+0000af80: 7065 202b 2073 656c 662e 7661 6c75 652e  pe + self.value.
+0000af90: 7368 6170 655b 6178 6973 2b31 3a5d 0a20  shape[axis+1:]. 
+0000afa0: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
+0000afb0: 6e73 7461 6e74 2873 656c 662e 7661 6c75  nstant(self.valu
+0000afc0: 652e 7265 7368 6170 6528 7368 6170 6529  e.reshape(shape)
+0000afd0: 290a 0a20 2020 2064 6566 205f 6465 7465  )..    def _dete
+0000afe0: 726d 696e 616e 7428 7365 6c66 2c20 6178  rminant(self, ax
+0000aff0: 6973 312c 2061 7869 7332 293a 0a20 2020  is1, axis2):.   
+0000b000: 2020 2020 2076 616c 7565 203d 206e 756d       value = num
+0000b010: 7079 2e74 7261 6e73 706f 7365 2873 656c  py.transpose(sel
+0000b020: 662e 7661 6c75 652c 2074 7570 6c65 2869  f.value, tuple(i
+0000b030: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+0000b040: 7365 6c66 2e6e 6469 6d29 2069 6620 6920  self.ndim) if i 
+0000b050: 213d 2061 7869 7331 2061 6e64 2069 2021  != axis1 and i !
+0000b060: 3d20 6178 6973 3229 202b 2028 6178 6973  = axis2) + (axis
+0000b070: 312c 2061 7869 7332 2929 0a20 2020 2020  1, axis2)).     
+0000b080: 2020 2072 6574 7572 6e20 636f 6e73 7461     return consta
+0000b090: 6e74 286e 756d 7079 2e6c 696e 616c 672e  nt(numpy.linalg.
+0000b0a0: 6465 7428 7661 6c75 6529 290a 0a20 2020  det(value))..   
+0000b0b0: 2064 6566 205f 696e 7462 6f75 6e64 735f   def _intbounds_
+0000b0c0: 696d 706c 2873 656c 6629 3a0a 2020 2020  impl(self):.    
+0000b0d0: 2020 2020 6966 2073 656c 662e 6474 7970      if self.dtyp
+0000b0e0: 6520 3d3d 2069 6e74 2061 6e64 2073 656c  e == int and sel
+0000b0f0: 662e 7661 6c75 652e 7369 7a65 3a0a 2020  f.value.size:.  
+0000b100: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000b110: 2069 6e74 2873 656c 662e 7661 6c75 652e   int(self.value.
+0000b120: 6d69 6e28 2929 2c20 696e 7428 7365 6c66  min()), int(self
+0000b130: 2e76 616c 7565 2e6d 6178 2829 290a 2020  .value.max()).  
+0000b140: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000b150: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0000b160: 7570 6572 2829 2e5f 696e 7462 6f75 6e64  uper()._intbound
+0000b170: 735f 696d 706c 2829 0a0a 2020 2020 4070  s_impl()..    @p
+0000b180: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+0000b190: 5f63 6f6e 7374 5f75 6e69 666f 726d 2873  _const_uniform(s
+0000b1a0: 656c 6629 3a0a 2020 2020 2020 2020 6966  elf):.        if
+0000b1b0: 2073 656c 662e 6e64 696d 203d 3d20 303a   self.ndim == 0:
+0000b1c0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000b1d0: 7572 6e20 7365 6c66 2e64 7479 7065 2873  urn self.dtype(s
+0000b1e0: 656c 662e 7661 6c75 655b 2829 5d29 0a0a  elf.value[()])..
+0000b1f0: 0a63 6c61 7373 2049 6e73 6572 7441 7869  .class InsertAxi
+0000b200: 7328 4172 7261 7929 3a0a 0a20 2020 2064  s(Array):..    d
+0000b210: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+0000b220: 2c20 6675 6e63 3a20 4172 7261 792c 206c  , func: Array, l
+0000b230: 656e 6774 683a 2041 7272 6179 293a 0a20  ength: Array):. 
+0000b240: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+0000b250: 696e 7374 616e 6365 2866 756e 632c 2041  instance(func, A
+0000b260: 7272 6179 292c 2066 2766 756e 633d 7b66  rray), f'func={f
+0000b270: 756e 6321 727d 270a 2020 2020 2020 2020  unc!r}'.        
+0000b280: 6173 7365 7274 205f 6973 696e 6465 7828  assert _isindex(
+0000b290: 6c65 6e67 7468 292c 2066 276c 656e 6774  length), f'lengt
+0000b2a0: 683d 7b6c 656e 6774 6821 727d 270a 2020  h={length!r}'.  
+0000b2b0: 2020 2020 2020 7365 6c66 2e66 756e 6320        self.func 
+0000b2c0: 3d20 6675 6e63 0a20 2020 2020 2020 2073  = func.        s
+0000b2d0: 656c 662e 6c65 6e67 7468 203d 206c 656e  elf.length = len
+0000b2e0: 6774 680a 2020 2020 2020 2020 7375 7065  gth.        supe
+0000b2f0: 7228 292e 5f5f 696e 6974 5f5f 2861 7267  r().__init__(arg
+0000b300: 733d 2866 756e 632c 206c 656e 6774 6829  s=(func, length)
+0000b310: 2c20 7368 6170 653d 282a 6675 6e63 2e73  , shape=(*func.s
+0000b320: 6861 7065 2c20 6c65 6e67 7468 292c 2064  hape, length), d
+0000b330: 7479 7065 3d66 756e 632e 6474 7970 6529  type=func.dtype)
+0000b340: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+0000b350: 2020 2020 6465 6620 5f64 6961 676f 6e61      def _diagona
+0000b360: 6c73 2873 656c 6629 3a0a 2020 2020 2020  ls(self):.      
+0000b370: 2020 7265 7475 726e 2073 656c 662e 6675    return self.fu
+0000b380: 6e63 2e5f 6469 6167 6f6e 616c 730a 0a20  nc._diagonals.. 
+0000b390: 2020 2040 6361 6368 6564 5f70 726f 7065     @cached_prope
+0000b3a0: 7274 790a 2020 2020 6465 6620 5f69 6e66  rty.    def _inf
+0000b3b0: 6c61 7469 6f6e 7328 7365 6c66 293a 0a20  lations(self):. 
+0000b3c0: 2020 2020 2020 2072 6574 7572 6e20 7475         return tu
+0000b3d0: 706c 6528 2861 7869 732c 2074 7970 6573  ple((axis, types
+0000b3e0: 2e66 726f 7a65 6e64 6963 7428 2864 6f66  .frozendict((dof
+0000b3f0: 6d61 702c 2049 6e73 6572 7441 7869 7328  map, InsertAxis(
+0000b400: 6675 6e63 2c20 7365 6c66 2e6c 656e 6774  func, self.lengt
+0000b410: 6829 2920 666f 7220 646f 666d 6170 2c20  h)) for dofmap, 
+0000b420: 6675 6e63 2069 6e20 7061 7274 732e 6974  func in parts.it
+0000b430: 656d 7328 2929 2920 666f 7220 6178 6973  ems())) for axis
+0000b440: 2c20 7061 7274 7320 696e 2073 656c 662e  , parts in self.
+0000b450: 6675 6e63 2e5f 696e 666c 6174 696f 6e73  func._inflations
+0000b460: 290a 0a20 2020 2040 6361 6368 6564 5f70  )..    @cached_p
+0000b470: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+0000b480: 5f75 6e61 6c69 676e 6564 2873 656c 6629  _unaligned(self)
+0000b490: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000b4a0: 2073 656c 662e 6675 6e63 2e5f 756e 616c   self.func._unal
+0000b4b0: 6967 6e65 640a 0a20 2020 2064 6566 205f  igned..    def _
+0000b4c0: 7369 6d70 6c69 6669 6564 2873 656c 6629  simplified(self)
+0000b4d0: 3a0a 2020 2020 2020 2020 6966 205f 6571  :.        if _eq
+0000b4e0: 7561 6c73 5f73 6361 6c61 725f 636f 6e73  uals_scalar_cons
+0000b4f0: 7461 6e74 2873 656c 662e 6c65 6e67 7468  tant(self.length
+0000b500: 2c20 3029 3a0a 2020 2020 2020 2020 2020  , 0):.          
+0000b510: 2020 7265 7475 726e 207a 6572 6f73 5f6c    return zeros_l
+0000b520: 696b 6528 7365 6c66 290a 2020 2020 2020  ike(self).      
+0000b530: 2020 7265 7475 726e 2073 656c 662e 6675    return self.fu
+0000b540: 6e63 2e5f 696e 7365 7274 6178 6973 2873  nc._insertaxis(s
+0000b550: 656c 662e 6e64 696d 2d31 2c20 7365 6c66  elf.ndim-1, self
+0000b560: 2e6c 656e 6774 6829 0a0a 2020 2020 4073  .length)..    @s
+0000b570: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
+0000b580: 6465 6620 6576 616c 6628 6675 6e63 2c20  def evalf(func, 
+0000b590: 6c65 6e67 7468 293a 0a20 2020 2020 2020  length):.       
+0000b5a0: 2069 6620 6c65 6e67 7468 203d 3d20 313a   if length == 1:
+0000b5b0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000b5c0: 7572 6e20 6675 6e63 5b2e 2e2e 2c20 6e75  urn func[..., nu
+0000b5d0: 6d70 792e 6e65 7761 7869 735d 0a20 2020  mpy.newaxis].   
+0000b5e0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000b5f0: 2020 2020 2020 7265 7475 726e 206e 756d        return num
+0000b600: 7079 2e6e 6461 7272 6179 2862 7566 6665  py.ndarray(buffe
+0000b610: 723d 6675 6e63 2c20 6474 7970 653d 6675  r=func, dtype=fu
+0000b620: 6e63 2e64 7479 7065 2c20 7368 6170 653d  nc.dtype, shape=
+0000b630: 282a 6675 6e63 2e73 6861 7065 2c20 6c65  (*func.shape, le
+0000b640: 6e67 7468 292c 2073 7472 6964 6573 3d28  ngth), strides=(
+0000b650: 2a66 756e 632e 7374 7269 6465 732c 2030  *func.strides, 0
+0000b660: 2929 0a20 2020 2020 2020 2065 7863 6570  )).        excep
+0000b670: 7420 5661 6c75 6545 7272 6f72 3a20 2023  t ValueError:  #
+0000b680: 206e 6f6e 2d63 6f6e 7469 6775 6f75 7320   non-contiguous 
+0000b690: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+0000b6a0: 2072 6574 7572 6e20 6e75 6d70 792e 7265   return numpy.re
+0000b6b0: 7065 6174 2866 756e 635b 2e2e 2e2c 206e  peat(func[..., n
+0000b6c0: 756d 7079 2e6e 6577 6178 6973 5d2c 206c  umpy.newaxis], l
+0000b6d0: 656e 6774 682c 202d 3129 0a0a 2020 2020  ength, -1)..    
+0000b6e0: 6465 6620 5f64 6572 6976 6174 6976 6528  def _derivative(
+0000b6f0: 7365 6c66 2c20 7661 722c 2073 6565 6e29  self, var, seen)
+0000b700: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000b710: 2069 6e73 6572 7461 7869 7328 6465 7269   insertaxis(deri
+0000b720: 7661 7469 7665 2873 656c 662e 6675 6e63  vative(self.func
+0000b730: 2c20 7661 722c 2073 6565 6e29 2c20 7365  , var, seen), se
+0000b740: 6c66 2e6e 6469 6d2d 312c 2073 656c 662e  lf.ndim-1, self.
+0000b750: 6c65 6e67 7468 290a 0a20 2020 2064 6566  length)..    def
+0000b760: 205f 7375 6d28 7365 6c66 2c20 6929 3a0a   _sum(self, i):.
+0000b770: 2020 2020 2020 2020 6966 2069 203d 3d20          if i == 
+0000b780: 7365 6c66 2e6e 6469 6d20 2d20 313a 0a20  self.ndim - 1:. 
+0000b790: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000b7a0: 6e20 7365 6c66 2e66 756e 6320 2a20 7365  n self.func * se
+0000b7b0: 6c66 2e6c 656e 6774 680a 2020 2020 2020  lf.length.      
+0000b7c0: 2020 7265 7475 726e 2049 6e73 6572 7441    return InsertA
+0000b7d0: 7869 7328 7375 6d28 7365 6c66 2e66 756e  xis(sum(self.fun
+0000b7e0: 632c 2069 292c 2073 656c 662e 6c65 6e67  c, i), self.leng
+0000b7f0: 7468 290a 0a20 2020 2064 6566 205f 7072  th)..    def _pr
+0000b800: 6f64 7563 7428 7365 6c66 293a 0a20 2020  oduct(self):.   
+0000b810: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0000b820: 2e66 756e 632a 2a73 656c 662e 6c65 6e67  .func**self.leng
+0000b830: 7468 0a0a 2020 2020 6465 6620 5f70 6f77  th..    def _pow
+0000b840: 6572 2873 656c 662c 206e 293a 0a20 2020  er(self, n):.   
+0000b850: 2020 2020 2075 6e61 6c69 676e 6564 312c       unaligned1,
+0000b860: 2075 6e61 6c69 676e 6564 322c 2077 6865   unaligned2, whe
+0000b870: 7265 203d 2075 6e61 6c69 676e 2873 656c  re = unalign(sel
+0000b880: 662c 206e 290a 2020 2020 2020 2020 6966  f, n).        if
+0000b890: 206c 656e 2877 6865 7265 2920 213d 2073   len(where) != s
+0000b8a0: 656c 662e 6e64 696d 3a0a 2020 2020 2020  elf.ndim:.      
+0000b8b0: 2020 2020 2020 7265 7475 726e 2061 6c69        return ali
+0000b8c0: 676e 2875 6e61 6c69 676e 6564 3120 2a2a  gn(unaligned1 **
+0000b8d0: 2075 6e61 6c69 676e 6564 322c 2077 6865   unaligned2, whe
+0000b8e0: 7265 2c20 7365 6c66 2e73 6861 7065 290a  re, self.shape).
+0000b8f0: 0a20 2020 2064 6566 205f 6164 6428 7365  .    def _add(se
+0000b900: 6c66 2c20 6f74 6865 7229 3a0a 2020 2020  lf, other):.    
+0000b910: 2020 2020 756e 616c 6967 6e65 6431 2c20      unaligned1, 
+0000b920: 756e 616c 6967 6e65 6432 2c20 7768 6572  unaligned2, wher
+0000b930: 6520 3d20 756e 616c 6967 6e28 7365 6c66  e = unalign(self
+0000b940: 2c20 6f74 6865 7229 0a20 2020 2020 2020  , other).       
+0000b950: 2069 6620 6c65 6e28 7768 6572 6529 2021   if len(where) !
+0000b960: 3d20 7365 6c66 2e6e 6469 6d3a 0a20 2020  = self.ndim:.   
+0000b970: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000b980: 616c 6967 6e28 756e 616c 6967 6e65 6431  align(unaligned1
+0000b990: 202b 2075 6e61 6c69 676e 6564 322c 2077   + unaligned2, w
+0000b9a0: 6865 7265 2c20 7365 6c66 2e73 6861 7065  here, self.shape
+0000b9b0: 290a 0a20 2020 2064 6566 205f 6d75 6c74  )..    def _mult
+0000b9c0: 6970 6c79 2873 656c 662c 206f 7468 6572  iply(self, other
+0000b9d0: 293a 0a20 2020 2020 2020 2075 6e61 6c69  ):.        unali
+0000b9e0: 676e 6564 312c 2075 6e61 6c69 676e 6564  gned1, unaligned
+0000b9f0: 322c 2077 6865 7265 203d 2075 6e61 6c69  2, where = unali
+0000ba00: 676e 2873 656c 662c 206f 7468 6572 290a  gn(self, other).
+0000ba10: 2020 2020 2020 2020 6966 206c 656e 2877          if len(w
+0000ba20: 6865 7265 2920 213d 2073 656c 662e 6e64  here) != self.nd
+0000ba30: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
+0000ba40: 7265 7475 726e 2061 6c69 676e 2875 6e61  return align(una
+0000ba50: 6c69 676e 6564 3120 2a20 756e 616c 6967  ligned1 * unalig
+0000ba60: 6e65 6432 2c20 7768 6572 652c 2073 656c  ned2, where, sel
+0000ba70: 662e 7368 6170 6529 0a0a 2020 2020 6465  f.shape)..    de
+0000ba80: 6620 5f64 6961 676f 6e61 6c69 7a65 2873  f _diagonalize(s
+0000ba90: 656c 662c 2061 7869 7329 3a0a 2020 2020  elf, axis):.    
+0000baa0: 2020 2020 6966 2061 7869 7320 3c20 7365      if axis < se
+0000bab0: 6c66 2e6e 6469 6d20 2d20 313a 0a20 2020  lf.ndim - 1:.   
+0000bac0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000bad0: 696e 7365 7274 6178 6973 2864 6961 676f  insertaxis(diago
+0000bae0: 6e61 6c69 7a65 2873 656c 662e 6675 6e63  nalize(self.func
+0000baf0: 2c20 6178 6973 2c20 7365 6c66 2e6e 6469  , axis, self.ndi
+0000bb00: 6d20 2d20 3129 2c20 7365 6c66 2e6e 6469  m - 1), self.ndi
+0000bb10: 6d20 2d20 312c 2073 656c 662e 6c65 6e67  m - 1, self.leng
+0000bb20: 7468 290a 0a20 2020 2064 6566 205f 696e  th)..    def _in
+0000bb30: 666c 6174 6528 7365 6c66 2c20 646f 666d  flate(self, dofm
+0000bb40: 6170 2c20 6c65 6e67 7468 2c20 6178 6973  ap, length, axis
+0000bb50: 293a 0a20 2020 2020 2020 2069 6620 6178  ):.        if ax
+0000bb60: 6973 202b 2064 6f66 6d61 702e 6e64 696d  is + dofmap.ndim
+0000bb70: 203c 2073 656c 662e 6e64 696d 3a0a 2020   < self.ndim:.  
+0000bb80: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000bb90: 2049 6e73 6572 7441 7869 7328 5f69 6e66   InsertAxis(_inf
+0000bba0: 6c61 7465 2873 656c 662e 6675 6e63 2c20  late(self.func, 
+0000bbb0: 646f 666d 6170 2c20 6c65 6e67 7468 2c20  dofmap, length, 
+0000bbc0: 6178 6973 292c 2073 656c 662e 6c65 6e67  axis), self.leng
+0000bbd0: 7468 290a 2020 2020 2020 2020 656c 6966  th).        elif
+0000bbe0: 2061 7869 7320 3d3d 2073 656c 662e 6e64   axis == self.nd
+0000bbf0: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
+0000bc00: 7265 7475 726e 2069 6e73 6572 7461 7869  return insertaxi
+0000bc10: 7328 496e 666c 6174 6528 7365 6c66 2e66  s(Inflate(self.f
+0000bc20: 756e 632c 2064 6f66 6d61 702c 206c 656e  unc, dofmap, len
+0000bc30: 6774 6829 2c20 7365 6c66 2e6e 6469 6d20  gth), self.ndim 
+0000bc40: 2d20 312c 2073 656c 662e 6c65 6e67 7468  - 1, self.length
+0000bc50: 290a 0a20 2020 2064 6566 205f 696e 7365  )..    def _inse
+0000bc60: 7274 6178 6973 2873 656c 662c 2061 7869  rtaxis(self, axi
+0000bc70: 732c 206c 656e 6774 6829 3a0a 2020 2020  s, length):.    
+0000bc80: 2020 2020 6966 2061 7869 7320 3d3d 2073      if axis == s
+0000bc90: 656c 662e 6e64 696d 202d 2031 3a0a 2020  elf.ndim - 1:.  
+0000bca0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000bcb0: 2049 6e73 6572 7441 7869 7328 496e 7365   InsertAxis(Inse
+0000bcc0: 7274 4178 6973 2873 656c 662e 6675 6e63  rtAxis(self.func
+0000bcd0: 2c20 6c65 6e67 7468 292c 2073 656c 662e  , length), self.
+0000bce0: 6c65 6e67 7468 290a 0a20 2020 2064 6566  length)..    def
+0000bcf0: 205f 7461 6b65 2873 656c 662c 2069 6e64   _take(self, ind
+0000bd00: 6578 2c20 6178 6973 293a 0a20 2020 2020  ex, axis):.     
+0000bd10: 2020 2069 6620 6178 6973 203d 3d20 7365     if axis == se
+0000bd20: 6c66 2e6e 6469 6d20 2d20 313a 0a20 2020  lf.ndim - 1:.   
+0000bd30: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000bd40: 6170 7065 6e64 6178 6573 2873 656c 662e  appendaxes(self.
+0000bd50: 6675 6e63 2c20 696e 6465 782e 7368 6170  func, index.shap
+0000bd60: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
+0000bd70: 6e20 496e 7365 7274 4178 6973 285f 7461  n InsertAxis(_ta
+0000bd80: 6b65 2873 656c 662e 6675 6e63 2c20 696e  ke(self.func, in
+0000bd90: 6465 782c 2061 7869 7329 2c20 7365 6c66  dex, axis), self
+0000bda0: 2e6c 656e 6774 6829 0a0a 2020 2020 6465  .length)..    de
+0000bdb0: 6620 5f74 616b 6564 6961 6728 7365 6c66  f _takediag(self
+0000bdc0: 2c20 6178 6973 312c 2061 7869 7332 293a  , axis1, axis2):
+0000bdd0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0000bde0: 6178 6973 3120 3c20 6178 6973 320a 2020  axis1 < axis2.  
+0000bdf0: 2020 2020 2020 6966 2061 7869 7332 203d        if axis2 =
+0000be00: 3d20 7365 6c66 2e6e 6469 6d2d 313a 0a20  = self.ndim-1:. 
+0000be10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000be20: 6e20 5472 616e 7370 6f73 652e 746f 5f65  n Transpose.to_e
+0000be30: 6e64 2873 656c 662e 6675 6e63 2c20 6178  nd(self.func, ax
+0000be40: 6973 3129 0a20 2020 2020 2020 2065 6c73  is1).        els
+0000be50: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0000be60: 6574 7572 6e20 696e 7365 7274 6178 6973  eturn insertaxis
+0000be70: 285f 7461 6b65 6469 6167 2873 656c 662e  (_takediag(self.
+0000be80: 6675 6e63 2c20 6178 6973 312c 2061 7869  func, axis1, axi
+0000be90: 7332 292c 2073 656c 662e 6e64 696d 2d33  s2), self.ndim-3
+0000bea0: 2c20 7365 6c66 2e6c 656e 6774 6829 0a0a  , self.length)..
+0000beb0: 2020 2020 6465 6620 5f75 6e72 6176 656c      def _unravel
+0000bec0: 2873 656c 662c 2061 7869 732c 2073 6861  (self, axis, sha
+0000bed0: 7065 293a 0a20 2020 2020 2020 2069 6620  pe):.        if 
+0000bee0: 6178 6973 203d 3d20 7365 6c66 2e6e 6469  axis == self.ndi
+0000bef0: 6d20 2d20 313a 0a20 2020 2020 2020 2020  m - 1:.         
+0000bf00: 2020 2072 6574 7572 6e20 496e 7365 7274     return Insert
+0000bf10: 4178 6973 2849 6e73 6572 7441 7869 7328  Axis(InsertAxis(
+0000bf20: 7365 6c66 2e66 756e 632c 2073 6861 7065  self.func, shape
+0000bf30: 5b30 5d29 2c20 7368 6170 655b 315d 290a  [0]), shape[1]).
+0000bf40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000bf50: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000bf60: 2049 6e73 6572 7441 7869 7328 756e 7261   InsertAxis(unra
+0000bf70: 7665 6c28 7365 6c66 2e66 756e 632c 2061  vel(self.func, a
+0000bf80: 7869 732c 2073 6861 7065 292c 2073 656c  xis, shape), sel
+0000bf90: 662e 6c65 6e67 7468 290a 0a20 2020 2064  f.length)..    d
+0000bfa0: 6566 205f 7369 676e 2873 656c 6629 3a0a  ef _sign(self):.
+0000bfb0: 2020 2020 2020 2020 7265 7475 726e 2049          return I
+0000bfc0: 6e73 6572 7441 7869 7328 5369 676e 2873  nsertAxis(Sign(s
+0000bfd0: 656c 662e 6675 6e63 292c 2073 656c 662e  elf.func), self.
+0000bfe0: 6c65 6e67 7468 290a 0a20 2020 2064 6566  length)..    def
+0000bff0: 205f 6465 7465 726d 696e 616e 7428 7365   _determinant(se
+0000c000: 6c66 2c20 6178 6973 312c 2061 7869 7332  lf, axis1, axis2
+0000c010: 293a 0a20 2020 2020 2020 2069 6620 6178  ):.        if ax
+0000c020: 6973 3120 3c20 7365 6c66 2e6e 6469 6d2d  is1 < self.ndim-
+0000c030: 3120 616e 6420 6178 6973 3220 3c20 7365  1 and axis2 < se
+0000c040: 6c66 2e6e 6469 6d2d 313a 0a20 2020 2020  lf.ndim-1:.     
+0000c050: 2020 2020 2020 2072 6574 7572 6e20 496e         return In
+0000c060: 7365 7274 4178 6973 2864 6574 6572 6d69  sertAxis(determi
+0000c070: 6e61 6e74 2873 656c 662e 6675 6e63 2c20  nant(self.func, 
+0000c080: 2861 7869 7331 2c20 6178 6973 3229 292c  (axis1, axis2)),
+0000c090: 2073 656c 662e 6c65 6e67 7468 290a 0a20   self.length).. 
+0000c0a0: 2020 2064 6566 205f 696e 7665 7273 6528     def _inverse(
+0000c0b0: 7365 6c66 2c20 6178 6973 312c 2061 7869  self, axis1, axi
+0000c0c0: 7332 293a 0a20 2020 2020 2020 2069 6620  s2):.        if 
+0000c0d0: 6178 6973 3120 3c20 7365 6c66 2e6e 6469  axis1 < self.ndi
+0000c0e0: 6d2d 3120 616e 6420 6178 6973 3220 3c20  m-1 and axis2 < 
+0000c0f0: 7365 6c66 2e6e 6469 6d2d 313a 0a20 2020  self.ndim-1:.   
+0000c100: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000c110: 496e 7365 7274 4178 6973 2869 6e76 6572  InsertAxis(inver
+0000c120: 7365 2873 656c 662e 6675 6e63 2c20 2861  se(self.func, (a
+0000c130: 7869 7331 2c20 6178 6973 3229 292c 2073  xis1, axis2)), s
+0000c140: 656c 662e 6c65 6e67 7468 290a 0a20 2020  elf.length)..   
+0000c150: 2064 6566 205f 6c6f 6f70 7375 6d28 7365   def _loopsum(se
+0000c160: 6c66 2c20 696e 6465 7829 3a0a 2020 2020  lf, index):.    
+0000c170: 2020 2020 7265 7475 726e 2049 6e73 6572      return Inser
+0000c180: 7441 7869 7328 6c6f 6f70 5f73 756d 2873  tAxis(loop_sum(s
+0000c190: 656c 662e 6675 6e63 2c20 696e 6465 7829  elf.func, index)
+0000c1a0: 2c20 7365 6c66 2e6c 656e 6774 6829 0a0a  , self.length)..
+0000c1b0: 2020 2020 4063 6163 6865 645f 7072 6f70      @cached_prop
+0000c1c0: 6572 7479 0a20 2020 2064 6566 205f 6173  erty.    def _as
+0000c1d0: 7370 6172 7365 2873 656c 6629 3a0a 2020  sparse(self):.  
+0000c1e0: 2020 2020 2020 7265 7475 726e 2074 7570        return tup
+0000c1f0: 6c65 2828 2a28 496e 7365 7274 4178 6973  le((*(InsertAxis
+0000c200: 2869 6478 2c20 7365 6c66 2e6c 656e 6774  (idx, self.lengt
+0000c210: 6829 2066 6f72 2069 6478 2069 6e20 696e  h) for idx in in
+0000c220: 6469 6365 7329 2c20 7072 6570 656e 6461  dices), prependa
+0000c230: 7865 7328 5261 6e67 6528 7365 6c66 2e6c  xes(Range(self.l
+0000c240: 656e 6774 6829 2c20 7661 6c75 6573 2e73  ength), values.s
+0000c250: 6861 7065 292c 2049 6e73 6572 7441 7869  hape), InsertAxi
+0000c260: 7328 7661 6c75 6573 2c20 7365 6c66 2e6c  s(values, self.l
+0000c270: 656e 6774 6829 2920 666f 7220 2a69 6e64  ength)) for *ind
+0000c280: 6963 6573 2c20 7661 6c75 6573 2069 6e20  ices, values in 
+0000c290: 7365 6c66 2e66 756e 632e 5f61 7373 7061  self.func._asspa
+0000c2a0: 7273 6529 0a0a 2020 2020 6465 6620 5f69  rse)..    def _i
+0000c2b0: 6e74 626f 756e 6473 5f69 6d70 6c28 7365  ntbounds_impl(se
+0000c2c0: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
+0000c2d0: 7572 6e20 7365 6c66 2e66 756e 632e 5f69  urn self.func._i
+0000c2e0: 6e74 626f 756e 6473 0a0a 2020 2020 4070  ntbounds..    @p
+0000c2f0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+0000c300: 5f63 6f6e 7374 5f75 6e69 666f 726d 2873  _const_uniform(s
+0000c310: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+0000c320: 7475 726e 2073 656c 662e 6675 6e63 2e5f  turn self.func._
+0000c330: 636f 6e73 745f 756e 6966 6f72 6d0a 0a0a  const_uniform...
+0000c340: 636c 6173 7320 5472 616e 7370 6f73 6528  class Transpose(
+0000c350: 4172 7261 7929 3a0a 0a20 2020 2040 636c  Array):..    @cl
+0000c360: 6173 736d 6574 686f 640a 2020 2020 6465  assmethod.    de
+0000c370: 6620 5f6d 6b5f 6178 6573 2863 6c73 2c20  f _mk_axes(cls, 
+0000c380: 6e64 696d 2c20 6178 6573 2c20 696e 7665  ndim, axes, inve
+0000c390: 7274 3d46 616c 7365 293a 0a20 2020 2020  rt=False):.     
+0000c3a0: 2020 2061 7865 7320 3d20 5b6e 756d 6572     axes = [numer
+0000c3b0: 6963 2e6e 6f72 6d64 696d 286e 6469 6d2c  ic.normdim(ndim,
+0000c3c0: 2061 7869 7329 2066 6f72 2061 7869 7320   axis) for axis 
+0000c3d0: 696e 2061 7865 735d 0a20 2020 2020 2020  in axes].       
+0000c3e0: 2069 6620 616c 6c28 6120 3d3d 2062 2066   if all(a == b f
+0000c3f0: 6f72 2061 2c20 6220 696e 2065 6e75 6d65  or a, b in enume
+0000c400: 7261 7465 2861 7865 732c 2073 7461 7274  rate(axes, start
+0000c410: 3d6e 6469 6d2d 6c65 6e28 6178 6573 2929  =ndim-len(axes))
+0000c420: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0000c430: 6574 7572 6e0a 2020 2020 2020 2020 7472  eturn.        tr
+0000c440: 616e 7320 3d20 5b69 2066 6f72 2069 2069  ans = [i for i i
+0000c450: 6e20 7261 6e67 6528 6e64 696d 2920 6966  n range(ndim) if
+0000c460: 2069 206e 6f74 2069 6e20 6178 6573 5d0a   i not in axes].
+0000c470: 2020 2020 2020 2020 7472 616e 732e 6578          trans.ex
+0000c480: 7465 6e64 2861 7865 7329 0a20 2020 2020  tend(axes).     
+0000c490: 2020 2069 6620 6c65 6e28 7472 616e 7329     if len(trans)
+0000c4a0: 2021 3d20 6e64 696d 3a0a 2020 2020 2020   != ndim:.      
+0000c4b0: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
+0000c4c0: 7074 696f 6e28 2764 7570 6c69 6361 7465  ption('duplicate
+0000c4d0: 2061 7865 7327 290a 2020 2020 2020 2020   axes').        
+0000c4e0: 7265 7475 726e 2074 7570 6c65 2874 7261  return tuple(tra
+0000c4f0: 6e73 290a 0a20 2020 2040 636c 6173 736d  ns)..    @classm
+0000c500: 6574 686f 640a 2020 2020 6465 6620 6672  ethod.    def fr
+0000c510: 6f6d 5f65 6e64 2863 6c73 2c20 6172 7261  om_end(cls, arra
+0000c520: 792c 202a 6178 6573 293a 0a20 2020 2020  y, *axes):.     
+0000c530: 2020 2074 7261 6e73 203d 2063 6c73 2e5f     trans = cls._
+0000c540: 6d6b 5f61 7865 7328 6172 7261 792e 6e64  mk_axes(array.nd
+0000c550: 696d 2c20 6178 6573 290a 2020 2020 2020  im, axes).      
+0000c560: 2020 7265 7475 726e 2063 6c73 2e69 6e76    return cls.inv
+0000c570: 2861 7272 6179 2c20 7472 616e 7329 2069  (array, trans) i
+0000c580: 6620 7472 616e 7320 656c 7365 2061 7272  f trans else arr
+0000c590: 6179 0a0a 2020 2020 4063 6c61 7373 6d65  ay..    @classme
+0000c5a0: 7468 6f64 0a20 2020 2064 6566 2074 6f5f  thod.    def to_
+0000c5b0: 656e 6428 636c 732c 2061 7272 6179 2c20  end(cls, array, 
+0000c5c0: 2a61 7865 7329 3a0a 2020 2020 2020 2020  *axes):.        
+0000c5d0: 7472 616e 7320 3d20 636c 732e 5f6d 6b5f  trans = cls._mk_
+0000c5e0: 6178 6573 2861 7272 6179 2e6e 6469 6d2c  axes(array.ndim,
+0000c5f0: 2061 7865 7329 0a20 2020 2020 2020 2072   axes).        r
+0000c600: 6574 7572 6e20 636c 7328 6172 7261 792c  eturn cls(array,
+0000c610: 2074 7261 6e73 2920 6966 2074 7261 6e73   trans) if trans
+0000c620: 2065 6c73 6520 6172 7261 790a 0a20 2020   else array..   
+0000c630: 2040 636c 6173 736d 6574 686f 640a 2020   @classmethod.  
+0000c640: 2020 6465 6620 696e 7628 636c 732c 2066    def inv(cls, f
+0000c650: 756e 632c 2061 7865 7329 3a0a 2020 2020  unc, axes):.    
+0000c660: 2020 2020 7265 7475 726e 2063 6c73 2866      return cls(f
+0000c670: 756e 632c 2074 7570 6c65 286e 2e5f 5f69  unc, tuple(n.__i
+0000c680: 6e64 6578 5f5f 2829 2066 6f72 206e 2069  ndex__() for n i
+0000c690: 6e20 6e75 6d70 792e 6172 6773 6f72 7428  n numpy.argsort(
+0000c6a0: 6178 6573 2929 290a 0a20 2020 2064 6566  axes)))..    def
+0000c6b0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+0000c6c0: 6675 6e63 3a20 4172 7261 792c 2061 7865  func: Array, axe
+0000c6d0: 733a 2074 7970 696e 672e 5475 706c 655b  s: typing.Tuple[
+0000c6e0: 696e 742c 202e 2e2e 5d29 3a0a 2020 2020  int, ...]):.    
+0000c6f0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0000c700: 7461 6e63 6528 6675 6e63 2c20 4172 7261  tance(func, Arra
+0000c710: 7929 2c20 6627 6675 6e63 3d7b 6675 6e63  y), f'func={func
+0000c720: 2172 7d27 0a20 2020 2020 2020 2061 7373  !r}'.        ass
+0000c730: 6572 7420 6973 696e 7374 616e 6365 2861  ert isinstance(a
+0000c740: 7865 732c 2074 7570 6c65 2920 616e 6420  xes, tuple) and 
+0000c750: 616c 6c28 6973 696e 7374 616e 6365 2861  all(isinstance(a
+0000c760: 7869 732c 2069 6e74 2920 666f 7220 6178  xis, int) for ax
+0000c770: 6973 2069 6e20 6178 6573 292c 2066 2761  is in axes), f'a
+0000c780: 7865 733d 7b61 7865 7321 727d 270a 2020  xes={axes!r}'.  
+0000c790: 2020 2020 2020 6173 7365 7274 2073 6f72        assert sor
+0000c7a0: 7465 6428 6178 6573 2920 3d3d 206c 6973  ted(axes) == lis
+0000c7b0: 7428 7261 6e67 6528 6675 6e63 2e6e 6469  t(range(func.ndi
+0000c7c0: 6d29 290a 2020 2020 2020 2020 7365 6c66  m)).        self
+0000c7d0: 2e66 756e 6320 3d20 6675 6e63 0a20 2020  .func = func.   
+0000c7e0: 2020 2020 2073 656c 662e 6178 6573 203d       self.axes =
+0000c7f0: 2061 7865 730a 2020 2020 2020 2020 7375   axes.        su
+0000c800: 7065 7228 292e 5f5f 696e 6974 5f5f 2861  per().__init__(a
+0000c810: 7267 733d 2866 756e 632c 292c 2073 6861  rgs=(func,), sha
+0000c820: 7065 3d74 7570 6c65 2866 756e 632e 7368  pe=tuple(func.sh
+0000c830: 6170 655b 6e5d 2066 6f72 206e 2069 6e20  ape[n] for n in 
+0000c840: 6178 6573 292c 2064 7479 7065 3d66 756e  axes), dtype=fun
+0000c850: 632e 6474 7970 6529 0a0a 2020 2020 4063  c.dtype)..    @c
+0000c860: 6163 6865 645f 7072 6f70 6572 7479 0a20  ached_property. 
+0000c870: 2020 2064 6566 205f 6469 6167 6f6e 616c     def _diagonal
+0000c880: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0000c890: 2072 6574 7572 6e20 7475 706c 6528 6672   return tuple(fr
+0000c8a0: 6f7a 656e 7365 7428 7365 6c66 2e5f 696e  ozenset(self._in
+0000c8b0: 7661 7865 735b 695d 2066 6f72 2069 2069  vaxes[i] for i i
+0000c8c0: 6e20 6178 6573 2920 666f 7220 6178 6573  n axes) for axes
+0000c8d0: 2069 6e20 7365 6c66 2e66 756e 632e 5f64   in self.func._d
+0000c8e0: 6961 676f 6e61 6c73 290a 0a20 2020 2040  iagonals)..    @
+0000c8f0: 6361 6368 6564 5f70 726f 7065 7274 790a  cached_property.
+0000c900: 2020 2020 6465 6620 5f69 6e66 6c61 7469      def _inflati
+0000c910: 6f6e 7328 7365 6c66 293a 0a20 2020 2020  ons(self):.     
+0000c920: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
+0000c930: 2873 656c 662e 5f69 6e76 6178 6573 5b61  (self._invaxes[a
+0000c940: 7869 735d 2c20 7479 7065 732e 6672 6f7a  xis], types.froz
+0000c950: 656e 6469 6374 2828 646f 666d 6170 2c20  endict((dofmap, 
+0000c960: 5472 616e 7370 6f73 6528 6675 6e63 2c20  Transpose(func, 
+0000c970: 7365 6c66 2e5f 6178 6573 5f66 6f72 2864  self._axes_for(d
+0000c980: 6f66 6d61 702e 6e64 696d 2c20 7365 6c66  ofmap.ndim, self
+0000c990: 2e5f 696e 7661 7865 735b 6178 6973 5d29  ._invaxes[axis])
+0000c9a0: 2929 2066 6f72 2064 6f66 6d61 702c 2066  )) for dofmap, f
+0000c9b0: 756e 6320 696e 2070 6172 7473 2e69 7465  unc in parts.ite
+0000c9c0: 6d73 2829 2929 2066 6f72 2061 7869 732c  ms())) for axis,
+0000c9d0: 2070 6172 7473 2069 6e20 7365 6c66 2e66   parts in self.f
+0000c9e0: 756e 632e 5f69 6e66 6c61 7469 6f6e 7329  unc._inflations)
+0000c9f0: 0a0a 2020 2020 4063 6163 6865 645f 7072  ..    @cached_pr
+0000ca00: 6f70 6572 7479 0a20 2020 2064 6566 205f  operty.    def _
+0000ca10: 756e 616c 6967 6e65 6428 7365 6c66 293a  unaligned(self):
+0000ca20: 0a20 2020 2020 2020 2075 6e61 6c69 676e  .        unalign
+0000ca30: 6564 2c20 7768 6572 6520 3d20 756e 616c  ed, where = unal
+0000ca40: 6967 6e28 7365 6c66 2e66 756e 6329 0a20  ign(self.func). 
+0000ca50: 2020 2020 2020 2072 6574 7572 6e20 756e         return un
+0000ca60: 616c 6967 6e65 642c 2074 7570 6c65 2873  aligned, tuple(s
+0000ca70: 656c 662e 5f69 6e76 6178 6573 5b69 5d20  elf._invaxes[i] 
+0000ca80: 666f 7220 6920 696e 2077 6865 7265 290a  for i in where).
+0000ca90: 0a20 2020 2040 6361 6368 6564 5f70 726f  .    @cached_pro
+0000caa0: 7065 7274 790a 2020 2020 6465 6620 5f69  perty.    def _i
+0000cab0: 6e76 6178 6573 2873 656c 6629 3a0a 2020  nvaxes(self):.  
+0000cac0: 2020 2020 2020 7265 7475 726e 2074 7570        return tup
+0000cad0: 6c65 286e 2e5f 5f69 6e64 6578 5f5f 2829  le(n.__index__()
+0000cae0: 2066 6f72 206e 2069 6e20 6e75 6d70 792e   for n in numpy.
+0000caf0: 6172 6773 6f72 7428 7365 6c66 2e61 7865  argsort(self.axe
+0000cb00: 7329 290a 0a20 2020 2064 6566 205f 7369  s))..    def _si
+0000cb10: 6d70 6c69 6669 6564 2873 656c 6629 3a0a  mplified(self):.
+0000cb20: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000cb30: 6178 6573 203d 3d20 7475 706c 6528 7261  axes == tuple(ra
+0000cb40: 6e67 6528 7365 6c66 2e6e 6469 6d29 293a  nge(self.ndim)):
+0000cb50: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000cb60: 7572 6e20 7365 6c66 2e66 756e 630a 2020  urn self.func.  
+0000cb70: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0000cb80: 662e 6675 6e63 2e5f 7472 616e 7370 6f73  f.func._transpos
+0000cb90: 6528 7365 6c66 2e61 7865 7329 0a0a 2020  e(self.axes)..  
+0000cba0: 2020 6465 6620 6576 616c 6628 7365 6c66    def evalf(self
+0000cbb0: 2c20 6172 7229 3a0a 2020 2020 2020 2020  , arr):.        
+0000cbc0: 7265 7475 726e 2061 7272 2e74 7261 6e73  return arr.trans
+0000cbd0: 706f 7365 2873 656c 662e 6178 6573 290a  pose(self.axes).
+0000cbe0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+0000cbf0: 2020 2064 6566 205f 6e6f 6465 5f64 6574     def _node_det
+0000cc00: 6169 6c73 2873 656c 6629 3a0a 2020 2020  ails(self):.    
+0000cc10: 2020 2020 7265 7475 726e 2027 2c27 2e6a      return ','.j
+0000cc20: 6f69 6e28 6d61 7028 7374 722c 2073 656c  oin(map(str, sel
+0000cc30: 662e 6178 6573 2929 0a0a 2020 2020 6465  f.axes))..    de
+0000cc40: 6620 5f74 7261 6e73 706f 7365 2873 656c  f _transpose(sel
+0000cc50: 662c 2061 7865 7329 3a0a 2020 2020 2020  f, axes):.      
+0000cc60: 2020 6966 2061 7865 7320 3d3d 2073 656c    if axes == sel
+0000cc70: 662e 5f69 6e76 6178 6573 3a0a 2020 2020  f._invaxes:.    
+0000cc80: 2020 2020 2020 2020 2320 4e4f 5445 3a20          # NOTE: 
+0000cc90: 5768 696c 6520 7765 2063 6f75 6c64 206c  While we could l
+0000cca0: 6561 7665 2074 6869 7320 7061 7274 6963  eave this partic
+0000ccb0: 756c 6172 2073 696d 706c 6966 6963 6174  ular simplificat
+0000ccc0: 696f 6e20 746f 2062 6520 6465 616c 740a  ion to be dealt.
+0000ccd0: 2020 2020 2020 2020 2020 2020 2320 7769              # wi
+0000cce0: 7468 2062 7920 5472 616e 7370 6f73 652c  th by Transpose,
+0000ccf0: 2074 6865 2062 656e 6566 6974 206f 6620   the benefit of 
+0000cd00: 6861 6e64 6c69 6e67 2069 7420 6469 7265  handling it dire
+0000cd10: 6374 6c79 2069 7320 7468 6174 205f 6164  ctly is that _ad
+0000cd20: 6420 616e 640a 2020 2020 2020 2020 2020  d and.          
+0000cd30: 2020 2320 5f6d 756c 7469 706c 7920 6361    # _multiply ca
+0000cd40: 6e20 7265 6c79 206f 6e20 5f74 7261 6e73  n rely on _trans
+0000cd50: 706f 7365 2066 6f72 2074 6865 2072 6967  pose for the rig
+0000cd60: 6874 2068 616e 6420 7369 6465 2077 6974  ht hand side wit
+0000cd70: 686f 7574 2068 6176 696e 670a 2020 2020  hout having.    
+0000cd80: 2020 2020 2020 2020 2320 746f 2073 6570          # to sep
+0000cd90: 6172 6174 656c 7920 6163 636f 756e 7420  arately account 
+0000cda0: 666f 7220 7468 6520 7472 6976 6961 6c20  for the trivial 
+0000cdb0: 6361 7365 2e0a 2020 2020 2020 2020 2020  case..          
+0000cdc0: 2020 7265 7475 726e 2073 656c 662e 6675    return self.fu
+0000cdd0: 6e63 0a20 2020 2020 2020 206e 6577 6178  nc.        newax
+0000cde0: 6573 203d 2074 7570 6c65 2873 656c 662e  es = tuple(self.
+0000cdf0: 6178 6573 5b69 5d20 666f 7220 6920 696e  axes[i] for i in
+0000ce00: 2061 7865 7329 0a20 2020 2020 2020 2072   axes).        r
+0000ce10: 6574 7572 6e20 5472 616e 7370 6f73 6528  eturn Transpose(
+0000ce20: 7365 6c66 2e66 756e 632c 206e 6577 6178  self.func, newax
+0000ce30: 6573 290a 0a20 2020 2064 6566 205f 7461  es)..    def _ta
+0000ce40: 6b65 6469 6167 2873 656c 662c 2061 7869  kediag(self, axi
+0000ce50: 7331 2c20 6178 6973 3229 3a0a 2020 2020  s1, axis2):.    
+0000ce60: 2020 2020 6173 7365 7274 2061 7869 7331      assert axis1
+0000ce70: 203c 2061 7869 7332 0a20 2020 2020 2020   < axis2.       
+0000ce80: 206f 7269 6731 2c20 6f72 6967 3220 3d20   orig1, orig2 = 
+0000ce90: 736f 7274 6564 2873 656c 662e 6178 6573  sorted(self.axes
+0000cea0: 5b61 7869 735d 2066 6f72 2061 7869 7320  [axis] for axis 
+0000ceb0: 696e 205b 6178 6973 312c 2061 7869 7332  in [axis1, axis2
+0000cec0: 5d29 0a20 2020 2020 2020 2069 6620 6f72  ]).        if or
+0000ced0: 6967 3120 3d3d 2073 656c 662e 6e64 696d  ig1 == self.ndim
+0000cee0: 2d32 3a0a 2020 2020 2020 2020 2020 2020  -2:.            
+0000cef0: 7265 7475 726e 2054 7261 6e73 706f 7365  return Transpose
+0000cf00: 2854 616b 6544 6961 6728 7365 6c66 2e66  (TakeDiag(self.f
+0000cf10: 756e 6329 2c20 282a 7365 6c66 2e61 7865  unc), (*self.axe
+0000cf20: 735b 3a61 7869 7331 5d2c 202a 7365 6c66  s[:axis1], *self
+0000cf30: 2e61 7865 735b 6178 6973 312b 313a 6178  .axes[axis1+1:ax
+0000cf40: 6973 325d 2c20 2a73 656c 662e 6178 6573  is2], *self.axes
+0000cf50: 5b61 7869 7332 2b31 3a5d 2c20 7365 6c66  [axis2+1:], self
+0000cf60: 2e6e 6469 6d2d 3229 290a 2020 2020 2020  .ndim-2)).      
+0000cf70: 2020 7472 7974 616b 6564 6961 6720 3d20    trytakediag = 
+0000cf80: 7365 6c66 2e66 756e 632e 5f74 616b 6564  self.func._taked
+0000cf90: 6961 6728 6f72 6967 312c 206f 7269 6732  iag(orig1, orig2
+0000cfa0: 290a 2020 2020 2020 2020 6966 2074 7279  ).        if try
+0000cfb0: 7461 6b65 6469 6167 2069 7320 6e6f 7420  takediag is not 
+0000cfc0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000cfd0: 2020 6578 636c 7564 655f 6f72 6967 203d    exclude_orig =
+0000cfe0: 205b 6178 2d28 6178 203e 206f 7269 6731   [ax-(ax > orig1
+0000cff0: 292d 2861 7820 3e20 6f72 6967 3229 2066  )-(ax > orig2) f
+0000d000: 6f72 2061 7820 696e 2073 656c 662e 6178  or ax in self.ax
+0000d010: 6573 5b3a 6178 6973 315d 202b 2073 656c  es[:axis1] + sel
+0000d020: 662e 6178 6573 5b61 7869 7331 2b31 3a61  f.axes[axis1+1:a
+0000d030: 7869 7332 5d20 2b20 7365 6c66 2e61 7865  xis2] + self.axe
+0000d040: 735b 6178 6973 322b 313a 5d5d 0a20 2020  s[axis2+1:]].   
+0000d050: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000d060: 5472 616e 7370 6f73 6528 7472 7974 616b  Transpose(trytak
+0000d070: 6564 6961 672c 2028 2a65 7863 6c75 6465  ediag, (*exclude
+0000d080: 5f6f 7269 672c 2073 656c 662e 6e64 696d  _orig, self.ndim
+0000d090: 2d32 2929 0a0a 2020 2020 6465 6620 5f73  -2))..    def _s
+0000d0a0: 756d 2873 656c 662c 2069 293a 0a20 2020  um(self, i):.   
+0000d0b0: 2020 2020 2061 7869 7320 3d20 7365 6c66       axis = self
+0000d0c0: 2e61 7865 735b 695d 0a20 2020 2020 2020  .axes[i].       
+0000d0d0: 2074 7279 7375 6d20 3d20 7365 6c66 2e66   trysum = self.f
+0000d0e0: 756e 632e 5f73 756d 2861 7869 7329 0a20  unc._sum(axis). 
+0000d0f0: 2020 2020 2020 2069 6620 7472 7973 756d         if trysum
+0000d100: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0000d110: 2020 2020 2020 2020 2020 6178 6573 203d            axes =
+0000d120: 2074 7570 6c65 2861 782d 2861 7820 3e20   tuple(ax-(ax > 
+0000d130: 6178 6973 2920 666f 7220 6178 2069 6e20  axis) for ax in 
+0000d140: 7365 6c66 2e61 7865 7320 6966 2061 7820  self.axes if ax 
+0000d150: 213d 2061 7869 7329 0a20 2020 2020 2020  != axis).       
+0000d160: 2020 2020 2072 6574 7572 6e20 5472 616e       return Tran
+0000d170: 7370 6f73 6528 7472 7973 756d 2c20 6178  spose(trysum, ax
+0000d180: 6573 290a 2020 2020 2020 2020 6966 2061  es).        if a
+0000d190: 7869 7320 3d3d 2073 656c 662e 6e64 696d  xis == self.ndim
+0000d1a0: 202d 2031 3a0a 2020 2020 2020 2020 2020   - 1:.          
+0000d1b0: 2020 7265 7475 726e 2054 7261 6e73 706f    return Transpo
+0000d1c0: 7365 2853 756d 2873 656c 662e 6675 6e63  se(Sum(self.func
+0000d1d0: 292c 2073 656c 662e 5f61 7865 735f 666f  ), self._axes_fo
+0000d1e0: 7228 302c 2069 2929 0a0a 2020 2020 6465  r(0, i))..    de
+0000d1f0: 6620 5f64 6572 6976 6174 6976 6528 7365  f _derivative(se
+0000d200: 6c66 2c20 7661 722c 2073 6565 6e29 3a0a  lf, var, seen):.
+0000d210: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+0000d220: 7261 6e73 706f 7365 2864 6572 6976 6174  ranspose(derivat
+0000d230: 6976 6528 7365 6c66 2e66 756e 632c 2076  ive(self.func, v
+0000d240: 6172 2c20 7365 656e 292c 2073 656c 662e  ar, seen), self.
+0000d250: 6178 6573 2b74 7570 6c65 2872 616e 6765  axes+tuple(range
+0000d260: 2873 656c 662e 6e64 696d 2c20 7365 6c66  (self.ndim, self
+0000d270: 2e6e 6469 6d2b 7661 722e 6e64 696d 2929  .ndim+var.ndim))
+0000d280: 290a 0a20 2020 2064 6566 205f 6d75 6c74  )..    def _mult
+0000d290: 6970 6c79 2873 656c 662c 206f 7468 6572  iply(self, other
+0000d2a0: 293a 0a20 2020 2020 2020 206f 7468 6572  ):.        other
+0000d2b0: 5f74 7261 6e73 203d 206f 7468 6572 2e5f  _trans = other._
+0000d2c0: 7472 616e 7370 6f73 6528 7365 6c66 2e5f  transpose(self._
+0000d2d0: 696e 7661 7865 7329 0a20 2020 2020 2020  invaxes).       
+0000d2e0: 2069 6620 6f74 6865 725f 7472 616e 7320   if other_trans 
+0000d2f0: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0000d300: 6e6f 7420 6973 696e 7374 616e 6365 286f  not isinstance(o
+0000d310: 7468 6572 5f74 7261 6e73 2c20 5472 616e  ther_trans, Tran
+0000d320: 7370 6f73 6529 3a0a 2020 2020 2020 2020  spose):.        
+0000d330: 2020 2020 2320 5468 6520 7365 636f 6e64      # The second
+0000d340: 2063 6c61 7573 6520 6973 2074 6f20 6176   clause is to av
+0000d350: 6f69 6420 696e 6669 6e69 7465 2072 6563  oid infinite rec
+0000d360: 7572 7369 6f6e 733b 2073 6565 0a20 2020  ursions; see.   
+0000d370: 2020 2020 2020 2020 2023 2074 6573 7473           # tests
+0000d380: 2e74 6573 745f 6576 616c 7561 626c 652e  .test_evaluable.
+0000d390: 7369 6d70 6c69 6679 2e74 6573 745f 6d75  simplify.test_mu
+0000d3a0: 6c74 6970 6c79 5f74 7261 6e73 706f 7365  ltiply_transpose
+0000d3b0: 2e0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+0000d3c0: 7475 726e 2054 7261 6e73 706f 7365 286d  turn Transpose(m
+0000d3d0: 756c 7469 706c 7928 7365 6c66 2e66 756e  ultiply(self.fun
+0000d3e0: 632c 206f 7468 6572 5f74 7261 6e73 292c  c, other_trans),
+0000d3f0: 2073 656c 662e 6178 6573 290a 2020 2020   self.axes).    
+0000d400: 2020 2020 7472 796d 756c 7469 706c 7920      trymultiply 
+0000d410: 3d20 7365 6c66 2e66 756e 632e 5f6d 756c  = self.func._mul
+0000d420: 7469 706c 7928 5472 616e 7370 6f73 6528  tiply(Transpose(
+0000d430: 6f74 6865 722c 2073 656c 662e 5f69 6e76  other, self._inv
+0000d440: 6178 6573 2929 0a20 2020 2020 2020 2069  axes)).        i
+0000d450: 6620 7472 796d 756c 7469 706c 7920 6973  f trymultiply is
+0000d460: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0000d470: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+0000d480: 616e 7370 6f73 6528 7472 796d 756c 7469  anspose(trymulti
+0000d490: 706c 792c 2073 656c 662e 6178 6573 290a  ply, self.axes).
+0000d4a0: 0a20 2020 2064 6566 205f 6164 6428 7365  .    def _add(se
+0000d4b0: 6c66 2c20 6f74 6865 7229 3a0a 2020 2020  lf, other):.    
+0000d4c0: 2020 2020 6f74 6865 725f 7472 616e 7320      other_trans 
+0000d4d0: 3d20 6f74 6865 722e 5f74 7261 6e73 706f  = other._transpo
+0000d4e0: 7365 2873 656c 662e 5f69 6e76 6178 6573  se(self._invaxes
+0000d4f0: 290a 2020 2020 2020 2020 6966 206f 7468  ).        if oth
+0000d500: 6572 5f74 7261 6e73 2069 7320 6e6f 7420  er_trans is not 
+0000d510: 4e6f 6e65 2061 6e64 206e 6f74 2069 7369  None and not isi
+0000d520: 6e73 7461 6e63 6528 6f74 6865 725f 7472  nstance(other_tr
+0000d530: 616e 732c 2054 7261 6e73 706f 7365 293a  ans, Transpose):
+0000d540: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+0000d550: 6865 2073 6563 6f6e 6420 636c 6175 7365  he second clause
+0000d560: 2069 7320 746f 2061 766f 6964 2069 6e66   is to avoid inf
+0000d570: 696e 6974 6520 7265 6375 7273 696f 6e73  inite recursions
+0000d580: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000d590: 7572 6e20 5472 616e 7370 6f73 6528 7365  urn Transpose(se
+0000d5a0: 6c66 2e66 756e 6320 2b20 6f74 6865 725f  lf.func + other_
+0000d5b0: 7472 616e 732c 2073 656c 662e 6178 6573  trans, self.axes
+0000d5c0: 290a 2020 2020 2020 2020 7472 7961 6464  ).        tryadd
+0000d5d0: 203d 2073 656c 662e 6675 6e63 2e5f 6164   = self.func._ad
+0000d5e0: 6428 5472 616e 7370 6f73 6528 6f74 6865  d(Transpose(othe
+0000d5f0: 722c 2073 656c 662e 5f69 6e76 6178 6573  r, self._invaxes
+0000d600: 2929 0a20 2020 2020 2020 2069 6620 7472  )).        if tr
+0000d610: 7961 6464 2069 7320 6e6f 7420 4e6f 6e65  yadd is not None
+0000d620: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000d630: 7475 726e 2054 7261 6e73 706f 7365 2874  turn Transpose(t
+0000d640: 7279 6164 642c 2073 656c 662e 6178 6573  ryadd, self.axes
+0000d650: 290a 0a20 2020 2064 6566 205f 7461 6b65  )..    def _take
+0000d660: 2873 656c 662c 2069 6e64 6963 6573 2c20  (self, indices, 
+0000d670: 6178 6973 293a 0a20 2020 2020 2020 2074  axis):.        t
+0000d680: 7279 7461 6b65 203d 2073 656c 662e 6675  rytake = self.fu
+0000d690: 6e63 2e5f 7461 6b65 2869 6e64 6963 6573  nc._take(indices
+0000d6a0: 2c20 7365 6c66 2e61 7865 735b 6178 6973  , self.axes[axis
+0000d6b0: 5d29 0a20 2020 2020 2020 2069 6620 7472  ]).        if tr
+0000d6c0: 7974 616b 6520 6973 206e 6f74 204e 6f6e  ytake is not Non
+0000d6d0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0000d6e0: 6574 7572 6e20 5472 616e 7370 6f73 6528  eturn Transpose(
+0000d6f0: 7472 7974 616b 652c 2073 656c 662e 5f61  trytake, self._a
+0000d700: 7865 735f 666f 7228 696e 6469 6365 732e  xes_for(indices.
+0000d710: 6e64 696d 2c20 6178 6973 2929 0a20 2020  ndim, axis)).   
+0000d720: 2020 2020 2069 6620 7365 6c66 2e61 7865       if self.axe
+0000d730: 735b 6178 6973 5d20 3d3d 2073 656c 662e  s[axis] == self.
+0000d740: 6e64 696d 202d 2031 3a0a 2020 2020 2020  ndim - 1:.      
+0000d750: 2020 2020 2020 7265 7475 726e 2054 7261        return Tra
+0000d760: 6e73 706f 7365 2854 616b 6528 7365 6c66  nspose(Take(self
+0000d770: 2e66 756e 632c 2069 6e64 6963 6573 292c  .func, indices),
+0000d780: 2073 656c 662e 5f61 7865 735f 666f 7228   self._axes_for(
+0000d790: 696e 6469 6365 732e 6e64 696d 2c20 6178  indices.ndim, ax
+0000d7a0: 6973 2929 0a0a 2020 2020 6465 6620 5f61  is))..    def _a
+0000d7b0: 7865 735f 666f 7228 7365 6c66 2c20 6e64  xes_for(self, nd
+0000d7c0: 696d 2c20 6178 6973 293a 0a20 2020 2020  im, axis):.     
+0000d7d0: 2020 2066 756e 6361 7869 7320 3d20 7365     funcaxis = se
+0000d7e0: 6c66 2e61 7865 735b 6178 6973 5d0a 2020  lf.axes[axis].  
+0000d7f0: 2020 2020 2020 6178 6573 203d 205b 6178        axes = [ax
+0000d800: 2b28 6178 203e 2066 756e 6361 7869 7329  +(ax > funcaxis)
+0000d810: 2a28 6e64 696d 2d31 2920 666f 7220 6178  *(ndim-1) for ax
+0000d820: 2069 6e20 7365 6c66 2e61 7865 7320 6966   in self.axes if
+0000d830: 2061 7820 213d 2066 756e 6361 7869 735d   ax != funcaxis]
+0000d840: 0a20 2020 2020 2020 2061 7865 735b 6178  .        axes[ax
+0000d850: 6973 3a61 7869 735d 203d 2072 616e 6765  is:axis] = range
+0000d860: 2866 756e 6361 7869 732c 2066 756e 6361  (funcaxis, funca
+0000d870: 7869 7320 2b20 6e64 696d 290a 2020 2020  xis + ndim).    
+0000d880: 2020 2020 7265 7475 726e 2074 7570 6c65      return tuple
+0000d890: 2861 7865 7329 0a0a 2020 2020 6465 6620  (axes)..    def 
+0000d8a0: 5f70 6f77 6572 2873 656c 662c 206e 293a  _power(self, n):
+0000d8b0: 0a20 2020 2020 2020 206e 5f74 7261 6e73  .        n_trans
+0000d8c0: 203d 2054 7261 6e73 706f 7365 286e 2c20   = Transpose(n, 
+0000d8d0: 7365 6c66 2e5f 696e 7661 7865 7329 0a20  self._invaxes). 
+0000d8e0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+0000d8f0: 616e 7370 6f73 6528 506f 7765 7228 7365  anspose(Power(se
+0000d900: 6c66 2e66 756e 632c 206e 5f74 7261 6e73  lf.func, n_trans
+0000d910: 292c 2073 656c 662e 6178 6573 290a 0a20  ), self.axes).. 
+0000d920: 2020 2064 6566 205f 7369 676e 2873 656c     def _sign(sel
+0000d930: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
+0000d940: 726e 2054 7261 6e73 706f 7365 2853 6967  rn Transpose(Sig
+0000d950: 6e28 7365 6c66 2e66 756e 6329 2c20 7365  n(self.func), se
+0000d960: 6c66 2e61 7865 7329 0a0a 2020 2020 6465  lf.axes)..    de
+0000d970: 6620 5f75 6e72 6176 656c 2873 656c 662c  f _unravel(self,
+0000d980: 2061 7869 732c 2073 6861 7065 293a 0a20   axis, shape):. 
+0000d990: 2020 2020 2020 206f 7269 675f 6178 6973         orig_axis
+0000d9a0: 203d 2073 656c 662e 6178 6573 5b61 7869   = self.axes[axi
+0000d9b0: 735d 0a20 2020 2020 2020 2074 7279 756e  s].        tryun
+0000d9c0: 7261 7665 6c20 3d20 7365 6c66 2e66 756e  ravel = self.fun
+0000d9d0: 632e 5f75 6e72 6176 656c 286f 7269 675f  c._unravel(orig_
+0000d9e0: 6178 6973 2c20 7368 6170 6529 0a20 2020  axis, shape).   
+0000d9f0: 2020 2020 2069 6620 7472 7975 6e72 6176       if tryunrav
+0000da00: 656c 2069 7320 6e6f 7420 4e6f 6e65 3a0a  el is not None:.
+0000da10: 2020 2020 2020 2020 2020 2020 6178 6573              axes
+0000da20: 203d 205b 6178 202b 2028 6178 203e 206f   = [ax + (ax > o
+0000da30: 7269 675f 6178 6973 2920 666f 7220 6178  rig_axis) for ax
+0000da40: 2069 6e20 7365 6c66 2e61 7865 735d 0a20   in self.axes]. 
+0000da50: 2020 2020 2020 2020 2020 2061 7865 732e             axes.
+0000da60: 696e 7365 7274 2861 7869 732b 312c 206f  insert(axis+1, o
+0000da70: 7269 675f 6178 6973 2b31 290a 2020 2020  rig_axis+1).    
+0000da80: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+0000da90: 7261 6e73 706f 7365 2874 7279 756e 7261  ranspose(tryunra
+0000daa0: 7665 6c2c 2074 7570 6c65 2861 7865 7329  vel, tuple(axes)
+0000dab0: 290a 0a20 2020 2064 6566 205f 7072 6f64  )..    def _prod
+0000dac0: 7563 7428 7365 6c66 293a 0a20 2020 2020  uct(self):.     
+0000dad0: 2020 2069 6620 7365 6c66 2e61 7865 735b     if self.axes[
+0000dae0: 2d31 5d20 3d3d 2073 656c 662e 6e64 696d  -1] == self.ndim
+0000daf0: 2d31 3a0a 2020 2020 2020 2020 2020 2020  -1:.            
+0000db00: 7265 7475 726e 2054 7261 6e73 706f 7365  return Transpose
+0000db10: 2850 726f 6475 6374 2873 656c 662e 6675  (Product(self.fu
+0000db20: 6e63 292c 2073 656c 662e 6178 6573 5b3a  nc), self.axes[:
+0000db30: 2d31 5d29 0a0a 2020 2020 6465 6620 5f64  -1])..    def _d
+0000db40: 6574 6572 6d69 6e61 6e74 2873 656c 662c  eterminant(self,
+0000db50: 2061 7869 7331 2c20 6178 6973 3229 3a0a   axis1, axis2):.
+0000db60: 2020 2020 2020 2020 6f72 6967 312c 206f          orig1, o
+0000db70: 7269 6732 203d 2073 656c 662e 6178 6573  rig2 = self.axes
+0000db80: 5b61 7869 7331 5d2c 2073 656c 662e 6178  [axis1], self.ax
+0000db90: 6573 5b61 7869 7332 5d0a 2020 2020 2020  es[axis2].      
+0000dba0: 2020 7472 7964 6574 203d 2073 656c 662e    trydet = self.
+0000dbb0: 6675 6e63 2e5f 6465 7465 726d 696e 616e  func._determinan
+0000dbc0: 7428 6f72 6967 312c 206f 7269 6732 290a  t(orig1, orig2).
+0000dbd0: 2020 2020 2020 2020 6966 2074 7279 6465          if tryde
+0000dbe0: 743a 0a20 2020 2020 2020 2020 2020 2061  t:.            a
+0000dbf0: 7865 7320 3d20 7475 706c 6528 6178 2d28  xes = tuple(ax-(
+0000dc00: 6178 203e 206f 7269 6731 292d 2861 7820  ax > orig1)-(ax 
+0000dc10: 3e20 6f72 6967 3229 2066 6f72 2061 7820  > orig2) for ax 
+0000dc20: 696e 2073 656c 662e 6178 6573 2069 6620  in self.axes if 
+0000dc30: 6178 2021 3d20 6f72 6967 3120 616e 6420  ax != orig1 and 
+0000dc40: 6178 2021 3d20 6f72 6967 3229 0a20 2020  ax != orig2).   
+0000dc50: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000dc60: 5472 616e 7370 6f73 6528 7472 7964 6574  Transpose(trydet
+0000dc70: 2c20 6178 6573 290a 0a20 2020 2064 6566  , axes)..    def
+0000dc80: 205f 696e 7665 7273 6528 7365 6c66 2c20   _inverse(self, 
+0000dc90: 6178 6973 312c 2061 7869 7332 293a 0a20  axis1, axis2):. 
+0000dca0: 2020 2020 2020 2074 7279 696e 7620 3d20         tryinv = 
+0000dcb0: 7365 6c66 2e66 756e 632e 5f69 6e76 6572  self.func._inver
+0000dcc0: 7365 2873 656c 662e 6178 6573 5b61 7869  se(self.axes[axi
+0000dcd0: 7331 5d2c 2073 656c 662e 6178 6573 5b61  s1], self.axes[a
+0000dce0: 7869 7332 5d29 0a20 2020 2020 2020 2069  xis2]).        i
+0000dcf0: 6620 7472 7969 6e76 3a0a 2020 2020 2020  f tryinv:.      
+0000dd00: 2020 2020 2020 7265 7475 726e 2054 7261        return Tra
+0000dd10: 6e73 706f 7365 2874 7279 696e 762c 2073  nspose(tryinv, s
+0000dd20: 656c 662e 6178 6573 290a 0a20 2020 2064  elf.axes)..    d
+0000dd30: 6566 205f 7261 7665 6c28 7365 6c66 2c20  ef _ravel(self, 
+0000dd40: 6178 6973 293a 0a20 2020 2020 2020 2069  axis):.        i
+0000dd50: 6620 7365 6c66 2e61 7865 735b 6178 6973  f self.axes[axis
+0000dd60: 5d20 3d3d 2073 656c 662e 6e64 696d 2d32  ] == self.ndim-2
+0000dd70: 2061 6e64 2073 656c 662e 6178 6573 5b61   and self.axes[a
+0000dd80: 7869 732b 315d 203d 3d20 7365 6c66 2e6e  xis+1] == self.n
+0000dd90: 6469 6d2d 313a 0a20 2020 2020 2020 2020  dim-1:.         
+0000dda0: 2020 2072 6574 7572 6e20 5472 616e 7370     return Transp
+0000ddb0: 6f73 6528 5261 7665 6c28 7365 6c66 2e66  ose(Ravel(self.f
+0000ddc0: 756e 6329 2c20 7365 6c66 2e61 7865 735b  unc), self.axes[
+0000ddd0: 3a2d 315d 290a 0a20 2020 2064 6566 205f  :-1])..    def _
+0000dde0: 696e 666c 6174 6528 7365 6c66 2c20 646f  inflate(self, do
+0000ddf0: 666d 6170 2c20 6c65 6e67 7468 2c20 6178  fmap, length, ax
+0000de00: 6973 293a 0a20 2020 2020 2020 2069 203d  is):.        i =
+0000de10: 2073 656c 662e 6178 6573 5b61 7869 735d   self.axes[axis]
+0000de20: 2069 6620 646f 666d 6170 2e6e 6469 6d20   if dofmap.ndim 
+0000de30: 656c 7365 2073 656c 662e 6675 6e63 2e6e  else self.func.n
+0000de40: 6469 6d0a 2020 2020 2020 2020 6966 2073  dim.        if s
+0000de50: 656c 662e 6178 6573 5b61 7869 733a 6178  elf.axes[axis:ax
+0000de60: 6973 2b64 6f66 6d61 702e 6e64 696d 5d20  is+dofmap.ndim] 
+0000de70: 3d3d 2074 7570 6c65 2872 616e 6765 2869  == tuple(range(i
+0000de80: 2c20 692b 646f 666d 6170 2e6e 6469 6d29  , i+dofmap.ndim)
+0000de90: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+0000dea0: 7279 696e 666c 6174 6520 3d20 7365 6c66  ryinflate = self
+0000deb0: 2e66 756e 632e 5f69 6e66 6c61 7465 2864  .func._inflate(d
+0000dec0: 6f66 6d61 702c 206c 656e 6774 682c 2069  ofmap, length, i
+0000ded0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0000dee0: 2074 7279 696e 666c 6174 6520 6973 206e   tryinflate is n
+0000def0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000df00: 2020 2020 2020 2020 2061 7865 7320 3d20           axes = 
+0000df10: 5b61 782d 2861 7820 3e20 6929 2a28 646f  [ax-(ax > i)*(do
+0000df20: 666d 6170 2e6e 6469 6d2d 3129 2066 6f72  fmap.ndim-1) for
+0000df30: 2061 7820 696e 2073 656c 662e 6178 6573   ax in self.axes
+0000df40: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0000df50: 2020 6178 6573 5b61 7869 733a 6178 6973    axes[axis:axis
+0000df60: 2b64 6f66 6d61 702e 6e64 696d 5d20 3d20  +dofmap.ndim] = 
+0000df70: 692c 0a20 2020 2020 2020 2020 2020 2020  i,.             
+0000df80: 2020 2072 6574 7572 6e20 5472 616e 7370     return Transp
+0000df90: 6f73 6528 7472 7969 6e66 6c61 7465 2c20  ose(tryinflate, 
+0000dfa0: 7475 706c 6528 6178 6573 2929 0a0a 2020  tuple(axes))..  
+0000dfb0: 2020 6465 6620 5f64 6961 676f 6e61 6c69    def _diagonali
+0000dfc0: 7a65 2873 656c 662c 2061 7869 7329 3a0a  ze(self, axis):.
+0000dfd0: 2020 2020 2020 2020 7472 7964 6961 676f          trydiago
+0000dfe0: 6e61 6c69 7a65 203d 2073 656c 662e 6675  nalize = self.fu
+0000dff0: 6e63 2e5f 6469 6167 6f6e 616c 697a 6528  nc._diagonalize(
+0000e000: 7365 6c66 2e61 7865 735b 6178 6973 5d29  self.axes[axis])
+0000e010: 0a20 2020 2020 2020 2069 6620 7472 7964  .        if tryd
+0000e020: 6961 676f 6e61 6c69 7a65 2069 7320 6e6f  iagonalize is no
+0000e030: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0000e040: 2020 2020 7265 7475 726e 2054 7261 6e73      return Trans
+0000e050: 706f 7365 2874 7279 6469 6167 6f6e 616c  pose(trydiagonal
+0000e060: 697a 652c 2073 656c 662e 6178 6573 202b  ize, self.axes +
+0000e070: 2028 7365 6c66 2e6e 6469 6d2c 2929 0a0a   (self.ndim,))..
+0000e080: 2020 2020 6465 6620 5f69 6e73 6572 7461      def _inserta
+0000e090: 7869 7328 7365 6c66 2c20 6178 6973 2c20  xis(self, axis, 
+0000e0a0: 6c65 6e67 7468 293a 0a20 2020 2020 2020  length):.       
+0000e0b0: 2072 6574 7572 6e20 5472 616e 7370 6f73   return Transpos
+0000e0c0: 6528 496e 7365 7274 4178 6973 2873 656c  e(InsertAxis(sel
+0000e0d0: 662e 6675 6e63 2c20 6c65 6e67 7468 292c  f.func, length),
+0000e0e0: 2073 656c 662e 6178 6573 5b3a 6178 6973   self.axes[:axis
+0000e0f0: 5d20 2b20 2873 656c 662e 6e64 696d 2c29  ] + (self.ndim,)
+0000e100: 202b 2073 656c 662e 6178 6573 5b61 7869   + self.axes[axi
+0000e110: 733a 5d29 0a0a 2020 2020 6465 6620 5f6c  s:])..    def _l
+0000e120: 6f6f 7073 756d 2873 656c 662c 2069 6e64  oopsum(self, ind
+0000e130: 6578 293a 0a20 2020 2020 2020 2072 6574  ex):.        ret
+0000e140: 7572 6e20 5472 616e 7370 6f73 6528 6c6f  urn Transpose(lo
+0000e150: 6f70 5f73 756d 2873 656c 662e 6675 6e63  op_sum(self.func
+0000e160: 2c20 696e 6465 7829 2c20 7365 6c66 2e61  , index), self.a
+0000e170: 7865 7329 0a0a 2020 2020 4063 6163 6865  xes)..    @cache
+0000e180: 645f 7072 6f70 6572 7479 0a20 2020 2064  d_property.    d
+0000e190: 6566 205f 6173 7370 6172 7365 2873 656c  ef _assparse(sel
+0000e1a0: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
+0000e1b0: 726e 2074 7570 6c65 2828 2a28 696e 6469  rn tuple((*(indi
+0000e1c0: 6365 735b 695d 2066 6f72 2069 2069 6e20  ces[i] for i in 
+0000e1d0: 7365 6c66 2e61 7865 7329 2c20 7661 6c75  self.axes), valu
+0000e1e0: 6573 2920 666f 7220 2a69 6e64 6963 6573  es) for *indices
+0000e1f0: 2c20 7661 6c75 6573 2069 6e20 7365 6c66  , values in self
+0000e200: 2e66 756e 632e 5f61 7373 7061 7273 6529  .func._assparse)
+0000e210: 0a0a 2020 2020 6465 6620 5f69 6e74 626f  ..    def _intbo
+0000e220: 756e 6473 5f69 6d70 6c28 7365 6c66 293a  unds_impl(self):
+0000e230: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000e240: 7365 6c66 2e66 756e 632e 5f69 6e74 626f  self.func._intbo
+0000e250: 756e 6473 0a0a 2020 2020 4070 726f 7065  unds..    @prope
+0000e260: 7274 790a 2020 2020 6465 6620 5f63 6f6e  rty.    def _con
+0000e270: 7374 5f75 6e69 666f 726d 2873 656c 6629  st_uniform(self)
+0000e280: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000e290: 2073 656c 662e 6675 6e63 2e5f 636f 6e73   self.func._cons
+0000e2a0: 745f 756e 6966 6f72 6d0a 0a0a 636c 6173  t_uniform...clas
+0000e2b0: 7320 5072 6f64 7563 7428 4172 7261 7929  s Product(Array)
+0000e2c0: 3a0a 0a20 2020 2064 6566 205f 5f69 6e69  :..    def __ini
+0000e2d0: 745f 5f28 7365 6c66 2c20 6675 6e63 3a20  t__(self, func: 
+0000e2e0: 4172 7261 7929 3a0a 2020 2020 2020 2020  Array):.        
+0000e2f0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0000e300: 6528 6675 6e63 2c20 4172 7261 7929 2061  e(func, Array) a
+0000e310: 6e64 2066 756e 632e 6474 7970 6520 213d  nd func.dtype !=
+0000e320: 2062 6f6f 6c2c 2066 2766 756e 633d 7b66   bool, f'func={f
+0000e330: 756e 6321 727d 270a 2020 2020 2020 2020  unc!r}'.        
+0000e340: 7365 6c66 2e66 756e 6320 3d20 6675 6e63  self.func = func
+0000e350: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+0000e360: 2e5f 5f69 6e69 745f 5f28 6172 6773 3d28  .__init__(args=(
+0000e370: 6675 6e63 2c29 2c20 7368 6170 653d 6675  func,), shape=fu
+0000e380: 6e63 2e73 6861 7065 5b3a 2d31 5d2c 2064  nc.shape[:-1], d
+0000e390: 7479 7065 3d66 756e 632e 6474 7970 6529  type=func.dtype)
+0000e3a0: 0a0a 2020 2020 6465 6620 5f73 696d 706c  ..    def _simpl
+0000e3b0: 6966 6965 6428 7365 6c66 293a 0a20 2020  ified(self):.   
+0000e3c0: 2020 2020 2069 6620 5f65 7175 616c 735f       if _equals_
+0000e3d0: 7363 616c 6172 5f63 6f6e 7374 616e 7428  scalar_constant(
+0000e3e0: 7365 6c66 2e66 756e 632e 7368 6170 655b  self.func.shape[
+0000e3f0: 2d31 5d2c 2031 293a 0a20 2020 2020 2020  -1], 1):.       
+0000e400: 2020 2020 2072 6574 7572 6e20 6765 7428       return get(
+0000e410: 7365 6c66 2e66 756e 632c 2073 656c 662e  self.func, self.
+0000e420: 6e64 696d 2c20 636f 6e73 7461 6e74 2830  ndim, constant(0
+0000e430: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
+0000e440: 6e20 7365 6c66 2e66 756e 632e 5f70 726f  n self.func._pro
+0000e450: 6475 6374 2829 0a0a 2020 2020 4073 7461  duct()..    @sta
+0000e460: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+0000e470: 6620 6576 616c 6628 6172 7229 3a0a 2020  f evalf(arr):.  
+0000e480: 2020 2020 2020 7265 7475 726e 206e 756d        return num
+0000e490: 7079 2e70 726f 6475 6374 2861 7272 2c20  py.product(arr, 
+0000e4a0: 6178 6973 3d2d 3129 0a0a 2020 2020 6465  axis=-1)..    de
+0000e4b0: 6620 5f64 6572 6976 6174 6976 6528 7365  f _derivative(se
+0000e4c0: 6c66 2c20 7661 722c 2073 6565 6e29 3a0a  lf, var, seen):.
+0000e4d0: 2020 2020 2020 2020 6772 6164 203d 2064          grad = d
+0000e4e0: 6572 6976 6174 6976 6528 7365 6c66 2e66  erivative(self.f
+0000e4f0: 756e 632c 2076 6172 2c20 7365 656e 290a  unc, var, seen).
+0000e500: 2020 2020 2020 2020 6675 6e63 7320 3d20          funcs = 
+0000e510: 5072 6f64 7563 7428 696e 7365 7274 6178  Product(insertax
+0000e520: 6973 2873 656c 662e 6675 6e63 2c20 2d32  is(self.func, -2
+0000e530: 2c20 7365 6c66 2e66 756e 632e 7368 6170  , self.func.shap
+0000e540: 655b 2d31 5d29 202b 2044 6961 676f 6e61  e[-1]) + Diagona
+0000e550: 6c69 7a65 2831 202d 2073 656c 662e 6675  lize(1 - self.fu
+0000e560: 6e63 2929 2020 2320 7265 706c 6163 6520  nc))  # replace 
+0000e570: 6469 6167 6f6e 616c 2065 6e74 7269 6573  diagonal entries
+0000e580: 2062 7920 310a 2020 2020 2020 2020 7265   by 1.        re
+0000e590: 7475 726e 2065 696e 7375 6d28 2741 692c  turn einsum('Ai,
+0000e5a0: 4169 422d 3e41 4227 2c20 6675 6e63 732c  AiB->AB', funcs,
+0000e5b0: 2067 7261 6429 0a0a 2020 2020 6465 6620   grad)..    def 
+0000e5c0: 5f74 616b 6528 7365 6c66 2c20 696e 6469  _take(self, indi
+0000e5d0: 6365 732c 2061 7869 7329 3a0a 2020 2020  ces, axis):.    
+0000e5e0: 2020 2020 7265 7475 726e 2050 726f 6475      return Produ
+0000e5f0: 6374 285f 7461 6b65 2873 656c 662e 6675  ct(_take(self.fu
+0000e600: 6e63 2c20 696e 6469 6365 732c 2061 7869  nc, indices, axi
+0000e610: 7329 290a 0a20 2020 2064 6566 205f 7461  s))..    def _ta
+0000e620: 6b65 6469 6167 2873 656c 662c 2061 7869  kediag(self, axi
+0000e630: 7331 2c20 6178 6973 3229 3a0a 2020 2020  s1, axis2):.    
+0000e640: 2020 2020 7265 7475 726e 2070 726f 6475      return produ
+0000e650: 6374 285f 7461 6b65 6469 6167 2873 656c  ct(_takediag(sel
+0000e660: 662e 6675 6e63 2c20 6178 6973 312c 2061  f.func, axis1, a
+0000e670: 7869 7332 292c 2073 656c 662e 6e64 696d  xis2), self.ndim
+0000e680: 2d32 290a 0a0a 636c 6173 7320 496e 7665  -2)...class Inve
+0000e690: 7273 6528 4172 7261 7929 3a0a 2020 2020  rse(Array):.    
+0000e6a0: 2727 270a 2020 2020 4d61 7472 6978 2069  '''.    Matrix i
+0000e6b0: 6e76 6572 7365 206f 6620 6060 6675 6e63  nverse of ``func
+0000e6c0: 6060 206f 7665 7220 7468 6520 6c61 7374  `` over the last
+0000e6d0: 2074 776f 2061 7865 732e 2020 416c 6c20   two axes.  All 
+0000e6e0: 6f74 6865 7220 6178 6573 2061 7265 0a20  other axes are. 
+0000e6f0: 2020 2074 7265 6174 6564 2065 6c65 6d65     treated eleme
+0000e700: 6e74 2d77 6973 652e 0a20 2020 2027 2727  nt-wise..    '''
+0000e710: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+0000e720: 5f5f 2873 656c 662c 2066 756e 633a 2041  __(self, func: A
+0000e730: 7272 6179 293a 0a20 2020 2020 2020 2061  rray):.        a
+0000e740: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+0000e750: 2866 756e 632c 2041 7272 6179 2920 616e  (func, Array) an
+0000e760: 6420 6675 6e63 2e6e 6469 6d20 3e3d 2032  d func.ndim >= 2
+0000e770: 2061 6e64 205f 6571 7561 6c73 5f73 696d   and _equals_sim
+0000e780: 706c 6966 6965 6428 6675 6e63 2e73 6861  plified(func.sha
+0000e790: 7065 5b2d 315d 2c20 6675 6e63 2e73 6861  pe[-1], func.sha
+0000e7a0: 7065 5b2d 325d 292c 2066 2766 756e 633d  pe[-2]), f'func=
+0000e7b0: 7b66 756e 6321 727d 270a 2020 2020 2020  {func!r}'.      
+0000e7c0: 2020 7365 6c66 2e66 756e 6320 3d20 6675    self.func = fu
+0000e7d0: 6e63 0a20 2020 2020 2020 2073 7570 6572  nc.        super
+0000e7e0: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
+0000e7f0: 3d28 6675 6e63 2c29 2c20 7368 6170 653d  =(func,), shape=
+0000e800: 6675 6e63 2e73 6861 7065 2c20 6474 7970  func.shape, dtyp
+0000e810: 653d 636f 6d70 6c65 7820 6966 2066 756e  e=complex if fun
+0000e820: 632e 6474 7970 6520 3d3d 2063 6f6d 706c  c.dtype == compl
+0000e830: 6578 2065 6c73 6520 666c 6f61 7429 0a0a  ex else float)..
+0000e840: 2020 2020 6465 6620 5f73 696d 706c 6966      def _simplif
+0000e850: 6965 6428 7365 6c66 293a 0a20 2020 2020  ied(self):.     
+0000e860: 2020 2072 6573 756c 7420 3d20 7365 6c66     result = self
+0000e870: 2e66 756e 632e 5f69 6e76 6572 7365 2873  .func._inverse(s
+0000e880: 656c 662e 6e64 696d 2d32 2c20 7365 6c66  elf.ndim-2, self
+0000e890: 2e6e 6469 6d2d 3129 0a20 2020 2020 2020  .ndim-1).       
+0000e8a0: 2069 6620 7265 7375 6c74 2069 7320 6e6f   if result is no
+0000e8b0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0000e8c0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0000e8d0: 740a 2020 2020 2020 2020 6966 205f 6571  t.        if _eq
+0000e8e0: 7561 6c73 5f73 6361 6c61 725f 636f 6e73  uals_scalar_cons
+0000e8f0: 7461 6e74 2873 656c 662e 6675 6e63 2e73  tant(self.func.s
+0000e900: 6861 7065 5b2d 315d 2c20 3129 3a0a 2020  hape[-1], 1):.  
+0000e910: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000e920: 2072 6563 6970 726f 6361 6c28 7365 6c66   reciprocal(self
+0000e930: 2e66 756e 6329 0a0a 2020 2020 6576 616c  .func)..    eval
+0000e940: 6620 3d20 7374 6174 6963 6d65 7468 6f64  f = staticmethod
+0000e950: 286e 756d 6572 6963 2e69 6e76 290a 0a20  (numeric.inv).. 
+0000e960: 2020 2064 6566 205f 6465 7269 7661 7469     def _derivati
+0000e970: 7665 2873 656c 662c 2076 6172 2c20 7365  ve(self, var, se
+0000e980: 656e 293a 0a20 2020 2020 2020 2072 6574  en):.        ret
+0000e990: 7572 6e20 2d65 696e 7375 6d28 2741 696a  urn -einsum('Aij
+0000e9a0: 2c41 6a6b 422c 416b 6c2d 3e41 696c 4227  ,AjkB,Akl->AilB'
+0000e9b0: 2c20 7365 6c66 2c20 6465 7269 7661 7469  , self, derivati
+0000e9c0: 7665 2873 656c 662e 6675 6e63 2c20 7661  ve(self.func, va
+0000e9d0: 722c 2073 6565 6e29 2c20 7365 6c66 290a  r, seen), self).
+0000e9e0: 0a20 2020 2064 6566 205f 6569 6728 7365  .    def _eig(se
+0000e9f0: 6c66 2c20 7379 6d6d 6574 7269 6329 3a0a  lf, symmetric):.
+0000ea00: 2020 2020 2020 2020 6569 6776 616c 2c20          eigval, 
+0000ea10: 6569 6776 6563 203d 2045 6967 2873 656c  eigvec = Eig(sel
+0000ea20: 662e 6675 6e63 2c20 7379 6d6d 6574 7269  f.func, symmetri
+0000ea30: 6329 0a20 2020 2020 2020 2072 6574 7572  c).        retur
+0000ea40: 6e20 5475 706c 6528 2872 6563 6970 726f  n Tuple((recipro
+0000ea50: 6361 6c28 6569 6776 616c 292c 2065 6967  cal(eigval), eig
+0000ea60: 7665 6329 290a 0a20 2020 2064 6566 205f  vec))..    def _
+0000ea70: 6465 7465 726d 696e 616e 7428 7365 6c66  determinant(self
+0000ea80: 2c20 6178 6973 312c 2061 7869 7332 293a  , axis1, axis2):
+0000ea90: 0a20 2020 2020 2020 2069 6620 736f 7274  .        if sort
+0000eaa0: 6564 285b 6178 6973 312c 2061 7869 7332  ed([axis1, axis2
+0000eab0: 5d29 203d 3d20 5b73 656c 662e 6e64 696d  ]) == [self.ndim
+0000eac0: 2d32 2c20 7365 6c66 2e6e 6469 6d2d 315d  -2, self.ndim-1]
+0000ead0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000eae0: 7475 726e 2072 6563 6970 726f 6361 6c28  turn reciprocal(
+0000eaf0: 4465 7465 726d 696e 616e 7428 7365 6c66  Determinant(self
+0000eb00: 2e66 756e 6329 290a 0a20 2020 2064 6566  .func))..    def
+0000eb10: 205f 7461 6b65 2873 656c 662c 2069 6e64   _take(self, ind
+0000eb20: 6963 6573 2c20 6178 6973 293a 0a20 2020  ices, axis):.   
+0000eb30: 2020 2020 2069 6620 6178 6973 203c 2073       if axis < s
+0000eb40: 656c 662e 6e64 696d 202d 2032 3a0a 2020  elf.ndim - 2:.  
+0000eb50: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000eb60: 2049 6e76 6572 7365 285f 7461 6b65 2873   Inverse(_take(s
+0000eb70: 656c 662e 6675 6e63 2c20 696e 6469 6365  elf.func, indice
+0000eb80: 732c 2061 7869 7329 290a 0a20 2020 2064  s, axis))..    d
+0000eb90: 6566 205f 7461 6b65 6469 6167 2873 656c  ef _takediag(sel
+0000eba0: 662c 2061 7869 7331 2c20 6178 6973 3229  f, axis1, axis2)
+0000ebb0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+0000ebc0: 2061 7869 7331 203c 2061 7869 7332 0a20   axis1 < axis2. 
+0000ebd0: 2020 2020 2020 2069 6620 6178 6973 3220         if axis2 
+0000ebe0: 3c20 7365 6c66 2e6e 6469 6d2d 323a 0a20  < self.ndim-2:. 
+0000ebf0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000ec00: 6e20 696e 7665 7273 6528 5f74 616b 6564  n inverse(_taked
+0000ec10: 6961 6728 7365 6c66 2e66 756e 632c 2061  iag(self.func, a
+0000ec20: 7869 7331 2c20 6178 6973 3229 2c20 2873  xis1, axis2), (s
+0000ec30: 656c 662e 6e64 696d 2d34 2c20 7365 6c66  elf.ndim-4, self
+0000ec40: 2e6e 6469 6d2d 3329 290a 0a20 2020 2064  .ndim-3))..    d
+0000ec50: 6566 205f 756e 7261 7665 6c28 7365 6c66  ef _unravel(self
+0000ec60: 2c20 6178 6973 2c20 7368 6170 6529 3a0a  , axis, shape):.
+0000ec70: 2020 2020 2020 2020 6966 2061 7869 7320          if axis 
+0000ec80: 3c20 7365 6c66 2e6e 6469 6d2d 323a 0a20  < self.ndim-2:. 
+0000ec90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000eca0: 6e20 496e 7665 7273 6528 756e 7261 7665  n Inverse(unrave
+0000ecb0: 6c28 7365 6c66 2e66 756e 632c 2061 7869  l(self.func, axi
+0000ecc0: 732c 2073 6861 7065 2929 0a0a 0a63 6c61  s, shape))...cla
+0000ecd0: 7373 2044 6574 6572 6d69 6e61 6e74 2841  ss Determinant(A
+0000ece0: 7272 6179 293a 0a0a 2020 2020 6465 6620  rray):..    def 
+0000ecf0: 5f5f 696e 6974 5f5f 2873 656c 662c 2066  __init__(self, f
+0000ed00: 756e 633a 2041 7272 6179 293a 0a20 2020  unc: Array):.   
+0000ed10: 2020 2020 2061 7373 6572 7420 6973 6172       assert isar
+0000ed20: 7261 7928 6675 6e63 2920 616e 6420 6675  ray(func) and fu
+0000ed30: 6e63 2e6e 6469 6d20 3e3d 2032 2061 6e64  nc.ndim >= 2 and
+0000ed40: 205f 6571 7561 6c73 5f73 696d 706c 6966   _equals_simplif
+0000ed50: 6965 6428 6675 6e63 2e73 6861 7065 5b2d  ied(func.shape[-
+0000ed60: 315d 2c20 6675 6e63 2e73 6861 7065 5b2d  1], func.shape[-
+0000ed70: 325d 290a 2020 2020 2020 2020 7365 6c66  2]).        self
+0000ed80: 2e66 756e 6320 3d20 6675 6e63 0a20 2020  .func = func.   
+0000ed90: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+0000eda0: 6e69 745f 5f28 6172 6773 3d28 6675 6e63  nit__(args=(func
+0000edb0: 2c29 2c20 7368 6170 653d 6675 6e63 2e73  ,), shape=func.s
+0000edc0: 6861 7065 5b3a 2d32 5d2c 2064 7479 7065  hape[:-2], dtype
+0000edd0: 3d63 6f6d 706c 6578 2069 6620 6675 6e63  =complex if func
+0000ede0: 2e64 7479 7065 203d 3d20 636f 6d70 6c65  .dtype == comple
+0000edf0: 7820 656c 7365 2066 6c6f 6174 290a 0a20  x else float).. 
+0000ee00: 2020 2064 6566 205f 7369 6d70 6c69 6669     def _simplifi
+0000ee10: 6564 2873 656c 6629 3a0a 2020 2020 2020  ed(self):.      
+0000ee20: 2020 7265 7375 6c74 203d 2073 656c 662e    result = self.
+0000ee30: 6675 6e63 2e5f 6465 7465 726d 696e 616e  func._determinan
+0000ee40: 7428 7365 6c66 2e6e 6469 6d2c 2073 656c  t(self.ndim, sel
+0000ee50: 662e 6e64 696d 2b31 290a 2020 2020 2020  f.ndim+1).      
+0000ee60: 2020 6966 2072 6573 756c 7420 6973 206e    if result is n
+0000ee70: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000ee80: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
+0000ee90: 6c74 0a20 2020 2020 2020 2069 6620 5f65  lt.        if _e
+0000eea0: 7175 616c 735f 7363 616c 6172 5f63 6f6e  quals_scalar_con
+0000eeb0: 7374 616e 7428 7365 6c66 2e66 756e 632e  stant(self.func.
+0000eec0: 7368 6170 655b 2d31 5d2c 2031 293a 0a20  shape[-1], 1):. 
+0000eed0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000eee0: 6e20 5461 6b65 2854 616b 6528 7365 6c66  n Take(Take(self
+0000eef0: 2e66 756e 632c 207a 6572 6f73 2828 292c  .func, zeros((),
+0000ef00: 2069 6e74 2929 2c20 7a65 726f 7328 2829   int)), zeros(()
+0000ef10: 2c20 696e 7429 290a 0a20 2020 2065 7661  , int))..    eva
+0000ef20: 6c66 203d 2073 7461 7469 636d 6574 686f  lf = staticmetho
+0000ef30: 6428 6e75 6d70 792e 6c69 6e61 6c67 2e64  d(numpy.linalg.d
+0000ef40: 6574 290a 0a20 2020 2064 6566 205f 6465  et)..    def _de
+0000ef50: 7269 7661 7469 7665 2873 656c 662c 2076  rivative(self, v
+0000ef60: 6172 2c20 7365 656e 293a 0a20 2020 2020  ar, seen):.     
+0000ef70: 2020 2072 6574 7572 6e20 6569 6e73 756d     return einsum
+0000ef80: 2827 412c 416a 692c 4169 6a42 2d3e 4142  ('A,Aji,AijB->AB
+0000ef90: 272c 2073 656c 662c 2069 6e76 6572 7365  ', self, inverse
+0000efa0: 2873 656c 662e 6675 6e63 292c 2064 6572  (self.func), der
+0000efb0: 6976 6174 6976 6528 7365 6c66 2e66 756e  ivative(self.fun
+0000efc0: 632c 2076 6172 2c20 7365 656e 2929 0a0a  c, var, seen))..
+0000efd0: 2020 2020 6465 6620 5f74 616b 6528 7365      def _take(se
+0000efe0: 6c66 2c20 696e 6465 782c 2061 7869 7329  lf, index, axis)
+0000eff0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000f000: 2044 6574 6572 6d69 6e61 6e74 285f 7461   Determinant(_ta
+0000f010: 6b65 2873 656c 662e 6675 6e63 2c20 696e  ke(self.func, in
+0000f020: 6465 782c 2061 7869 7329 290a 0a20 2020  dex, axis))..   
+0000f030: 2064 6566 205f 7461 6b65 6469 6167 2873   def _takediag(s
+0000f040: 656c 662c 2061 7869 7331 2c20 6178 6973  elf, axis1, axis
+0000f050: 3229 3a0a 2020 2020 2020 2020 7265 7475  2):.        retu
+0000f060: 726e 2064 6574 6572 6d69 6e61 6e74 285f  rn determinant(_
+0000f070: 7461 6b65 6469 6167 2873 656c 662e 6675  takediag(self.fu
+0000f080: 6e63 2c20 6178 6973 312c 2061 7869 7332  nc, axis1, axis2
+0000f090: 292c 2028 7365 6c66 2e6e 6469 6d2d 322c  ), (self.ndim-2,
+0000f0a0: 2073 656c 662e 6e64 696d 2d31 2929 0a0a   self.ndim-1))..
+0000f0b0: 0a63 6c61 7373 204d 756c 7469 706c 7928  .class Multiply(
+0000f0c0: 4172 7261 7929 3a0a 0a20 2020 2064 6566  Array):..    def
+0000f0d0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+0000f0e0: 6675 6e63 733a 2074 7970 6573 2e66 726f  funcs: types.fro
+0000f0f0: 7a65 6e6d 756c 7469 7365 7429 3a0a 2020  zenmultiset):.  
+0000f100: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+0000f110: 6e73 7461 6e63 6528 6675 6e63 732c 2074  nstance(funcs, t
+0000f120: 7970 6573 2e66 726f 7a65 6e6d 756c 7469  ypes.frozenmulti
+0000f130: 7365 7429 2c20 6627 6675 6e63 733d 7b66  set), f'funcs={f
+0000f140: 756e 6373 2172 7d27 0a20 2020 2020 2020  uncs!r}'.       
+0000f150: 2073 656c 662e 6675 6e63 7320 3d20 6675   self.funcs = fu
+0000f160: 6e63 730a 2020 2020 2020 2020 6675 6e63  ncs.        func
+0000f170: 312c 2066 756e 6332 203d 2066 756e 6373  1, func2 = funcs
+0000f180: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0000f190: 6571 7561 6c73 6861 7065 2866 756e 6331  equalshape(func1
+0000f1a0: 2e73 6861 7065 2c20 6675 6e63 322e 7368  .shape, func2.sh
+0000f1b0: 6170 6529 2061 6e64 2066 756e 6331 2e64  ape) and func1.d
+0000f1c0: 7479 7065 203d 3d20 6675 6e63 322e 6474  type == func2.dt
+0000f1d0: 7970 6520 213d 2062 6f6f 6c2c 2027 4d75  ype != bool, 'Mu
+0000f1e0: 6c74 6970 6c79 287b 7d2c 207b 7d29 272e  ltiply({}, {})'.
+0000f1f0: 666f 726d 6174 2866 756e 6331 2c20 6675  format(func1, fu
+0000f200: 6e63 3229 0a20 2020 2020 2020 2073 7570  nc2).        sup
+0000f210: 6572 2829 2e5f 5f69 6e69 745f 5f28 6172  er().__init__(ar
+0000f220: 6773 3d74 7570 6c65 2873 656c 662e 6675  gs=tuple(self.fu
+0000f230: 6e63 7329 2c20 7368 6170 653d 6675 6e63  ncs), shape=func
+0000f240: 312e 7368 6170 652c 2064 7479 7065 3d66  1.shape, dtype=f
+0000f250: 756e 6331 2e64 7479 7065 290a 0a20 2020  unc1.dtype)..   
+0000f260: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+0000f270: 6566 205f 6661 6374 6f72 7328 7365 6c66  ef _factors(self
+0000f280: 293a 0a20 2020 2020 2020 2066 6f72 2066  ):.        for f
+0000f290: 756e 6320 696e 2073 656c 662e 6675 6e63  unc in self.func
+0000f2a0: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+0000f2b0: 6620 6973 696e 7374 616e 6365 2866 756e  f isinstance(fun
+0000f2c0: 632c 204d 756c 7469 706c 7929 3a0a 2020  c, Multiply):.  
+0000f2d0: 2020 2020 2020 2020 2020 2020 2020 7969                yi
+0000f2e0: 656c 6420 6672 6f6d 2066 756e 632e 5f66  eld from func._f
+0000f2f0: 6163 746f 7273 0a20 2020 2020 2020 2020  actors.         
+0000f300: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000f310: 2020 2020 2020 2020 2079 6965 6c64 2066           yield f
+0000f320: 756e 630a 0a20 2020 2064 6566 205f 7369  unc..    def _si
+0000f330: 6d70 6c69 6669 6564 2873 656c 6629 3a0a  mplified(self):.
+0000f340: 2020 2020 2020 2020 6661 6374 6f72 7320          factors 
+0000f350: 3d20 7475 706c 6528 7365 6c66 2e5f 6661  = tuple(self._fa
+0000f360: 6374 6f72 7329 0a20 2020 2020 2020 2066  ctors).        f
+0000f370: 6f72 206a 2c20 666a 2069 6e20 656e 756d  or j, fj in enum
+0000f380: 6572 6174 6528 6661 6374 6f72 7329 3a0a  erate(factors):.
+0000f390: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+0000f3a0: 6a2e 5f63 6f6e 7374 5f75 6e69 666f 726d  j._const_uniform
+0000f3b0: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
+0000f3c0: 2020 2020 2020 2072 6574 7572 6e20 6d75         return mu
+0000f3d0: 6c74 6970 6c79 282a 6661 6374 6f72 735b  ltiply(*factors[
+0000f3e0: 3a6a 5d2c 202a 6661 6374 6f72 735b 6a2b  :j], *factors[j+
+0000f3f0: 313a 5d29 0a20 2020 2020 2020 2020 2020  1:]).           
+0000f400: 2066 6f72 2069 2c20 7061 7274 7320 696e   for i, parts in
+0000f410: 2066 6a2e 5f69 6e66 6c61 7469 6f6e 733a   fj._inflations:
+0000f420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f430: 2072 6574 7572 6e20 7574 696c 2e73 756d   return util.sum
+0000f440: 285f 696e 666c 6174 6528 6d75 6c74 6970  (_inflate(multip
+0000f450: 6c79 2866 2c20 2a28 5f74 616b 6528 6669  ly(f, *(_take(fi
+0000f460: 2c20 646f 666d 6170 2c20 6929 2066 6f72  , dofmap, i) for
+0000f470: 2066 6920 696e 2066 6163 746f 7273 5b3a   fi in factors[:
+0000f480: 6a5d 202b 2066 6163 746f 7273 5b6a 2b31  j] + factors[j+1
+0000f490: 3a5d 2929 2c20 646f 666d 6170 2c20 7365  :])), dofmap, se
+0000f4a0: 6c66 2e73 6861 7065 5b69 5d2c 2069 2920  lf.shape[i], i) 
+0000f4b0: 666f 7220 646f 666d 6170 2c20 6620 696e  for dofmap, f in
+0000f4c0: 2070 6172 7473 2e69 7465 6d73 2829 290a   parts.items()).
+0000f4d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000f4e0: 6178 6973 312c 2061 7869 7332 2c20 2a6f  axis1, axis2, *o
+0000f4f0: 7468 6572 2069 6e20 6d61 7028 736f 7274  ther in map(sort
+0000f500: 6564 2c20 666a 2e5f 6469 6167 6f6e 616c  ed, fj._diagonal
+0000f510: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0000f520: 2020 2020 7265 7475 726e 2064 6961 676f      return diago
+0000f530: 6e61 6c69 7a65 286d 756c 7469 706c 7928  nalize(multiply(
+0000f540: 2a28 7461 6b65 6469 6167 2866 2c20 6178  *(takediag(f, ax
+0000f550: 6973 312c 2061 7869 7332 2920 666f 7220  is1, axis2) for 
+0000f560: 6620 696e 2066 6163 746f 7273 2929 2c20  f in factors)), 
+0000f570: 6178 6973 312c 2061 7869 7332 290a 2020  axis1, axis2).  
+0000f580: 2020 2020 2020 2020 2020 666f 7220 692c            for i,
+0000f590: 2066 6920 696e 2065 6e75 6d65 7261 7465   fi in enumerate
+0000f5a0: 2866 6163 746f 7273 5b3a 6a5d 293a 0a20  (factors[:j]):. 
+0000f5b0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+0000f5c0: 6e61 6c69 676e 6564 312c 2075 6e61 6c69  naligned1, unali
+0000f5d0: 676e 6564 322c 2077 6865 7265 203d 2075  gned2, where = u
+0000f5e0: 6e61 6c69 676e 2866 692c 2066 6a29 0a20  nalign(fi, fj). 
+0000f5f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000f600: 696a 203d 2061 6c69 676e 2875 6e61 6c69  ij = align(unali
+0000f610: 676e 6564 3120 2a20 756e 616c 6967 6e65  gned1 * unaligne
+0000f620: 6432 2c20 7768 6572 652c 2073 656c 662e  d2, where, self.
+0000f630: 7368 6170 6529 2069 6620 6c65 6e28 7768  shape) if len(wh
+0000f640: 6572 6529 2021 3d20 7365 6c66 2e6e 6469  ere) != self.ndi
+0000f650: 6d20 5c0a 2020 2020 2020 2020 2020 2020  m \.            
+0000f660: 2020 2020 2020 2020 656c 7365 2066 692e          else fi.
+0000f670: 5f6d 756c 7469 706c 7928 666a 2920 6f72  _multiply(fj) or
+0000f680: 2066 6a2e 5f6d 756c 7469 706c 7928 6669   fj._multiply(fi
+0000f690: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f6a0: 2020 6966 2066 696a 3a0a 2020 2020 2020    if fij:.      
+0000f6b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000f6c0: 7475 726e 206d 756c 7469 706c 7928 2a66  turn multiply(*f
+0000f6d0: 6163 746f 7273 5b3a 695d 2c20 2a66 6163  actors[:i], *fac
+0000f6e0: 746f 7273 5b69 2b31 3a6a 5d2c 202a 6661  tors[i+1:j], *fa
+0000f6f0: 6374 6f72 735b 6a2b 313a 5d2c 2066 696a  ctors[j+1:], fij
+0000f700: 290a 0a20 2020 2064 6566 205f 6f70 7469  )..    def _opti
+0000f710: 6d69 7a65 645f 666f 725f 6e75 6d70 7928  mized_for_numpy(
+0000f720: 7365 6c66 293a 0a20 2020 2020 2020 2066  self):.        f
+0000f730: 6163 746f 7273 203d 2074 7570 6c65 2873  actors = tuple(s
+0000f740: 656c 662e 5f66 6163 746f 7273 290a 2020  elf._factors).  
+0000f750: 2020 2020 2020 666f 7220 692c 2066 6920        for i, fi 
+0000f760: 696e 2065 6e75 6d65 7261 7465 2866 6163  in enumerate(fac
+0000f770: 746f 7273 293a 0a20 2020 2020 2020 2020  tors):.         
+0000f780: 2020 2069 6620 6669 2e64 7479 7065 2021     if fi.dtype !
+0000f790: 3d20 626f 6f6c 2061 6e64 2066 692e 5f63  = bool and fi._c
+0000f7a0: 6f6e 7374 5f75 6e69 666f 726d 203d 3d20  onst_uniform == 
+0000f7b0: 2d31 3a0a 2020 2020 2020 2020 2020 2020  -1:.            
+0000f7c0: 2020 2020 7265 7475 726e 204e 6567 6174      return Negat
+0000f7d0: 6976 6528 6d75 6c74 6970 6c79 282a 6661  ive(multiply(*fa
+0000f7e0: 6374 6f72 735b 3a69 5d2c 202a 6661 6374  ctors[:i], *fact
+0000f7f0: 6f72 735b 692b 313a 5d29 290a 2020 2020  ors[i+1:])).    
+0000f800: 2020 2020 2020 2020 6966 2066 692e 6474          if fi.dt
+0000f810: 7970 6520 213d 2063 6f6d 706c 6578 2061  ype != complex a
+0000f820: 6e64 2053 6967 6e28 6669 2920 696e 2066  nd Sign(fi) in f
+0000f830: 6163 746f 7273 3a0a 2020 2020 2020 2020  actors:.        
+0000f840: 2020 2020 2020 2020 692c 206a 203d 2073          i, j = s
+0000f850: 6f72 7465 6428 5b69 2c20 6661 6374 6f72  orted([i, factor
+0000f860: 732e 696e 6465 7828 5369 676e 2866 6929  s.index(Sign(fi)
+0000f870: 295d 290a 2020 2020 2020 2020 2020 2020  )]).            
+0000f880: 2020 2020 7265 7475 726e 206d 756c 7469      return multi
+0000f890: 706c 7928 2a66 6163 746f 7273 5b3a 695d  ply(*factors[:i]
+0000f8a0: 2c20 2a66 6163 746f 7273 5b69 2b31 3a6a  , *factors[i+1:j
+0000f8b0: 5d2c 202a 6661 6374 6f72 735b 6a2b 313a  ], *factors[j+1:
+0000f8c0: 5d2c 2041 6273 6f6c 7574 6528 6669 2929  ], Absolute(fi))
+0000f8d0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0000f8e0: 2e6e 6469 6d3a 0a20 2020 2020 2020 2020  .ndim:.         
+0000f8f0: 2020 2061 7267 732c 2061 7267 735f 6964     args, args_id
+0000f900: 7820 3d20 7a69 7028 2a6d 6170 2875 6e61  x = zip(*map(una
+0000f910: 6c69 676e 2c20 6661 6374 6f72 7329 290a  lign, factors)).
+0000f920: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000f930: 726e 2045 696e 7375 6d28 6172 6773 2c20  rn Einsum(args, 
+0000f940: 6172 6773 5f69 6478 2c20 7475 706c 6528  args_idx, tuple(
+0000f950: 7261 6e67 6528 7365 6c66 2e6e 6469 6d29  range(self.ndim)
+0000f960: 2929 0a0a 2020 2020 6576 616c 6620 3d20  ))..    evalf = 
+0000f970: 7374 6174 6963 6d65 7468 6f64 286e 756d  staticmethod(num
+0000f980: 7079 2e6d 756c 7469 706c 7929 0a0a 2020  py.multiply)..  
+0000f990: 2020 6465 6620 5f73 756d 2873 656c 662c    def _sum(self,
+0000f9a0: 2061 7869 7329 3a0a 2020 2020 2020 2020   axis):.        
+0000f9b0: 6661 6374 6f72 7320 3d20 7475 706c 6528  factors = tuple(
+0000f9c0: 7365 6c66 2e5f 6661 6374 6f72 7329 0a20  self._factors). 
+0000f9d0: 2020 2020 2020 2066 6f72 2069 2c20 6669         for i, fi
+0000f9e0: 2069 6e20 656e 756d 6572 6174 6528 6661   in enumerate(fa
+0000f9f0: 6374 6f72 7329 3a0a 2020 2020 2020 2020  ctors):.        
+0000fa00: 2020 2020 756e 616c 6967 6e65 642c 2077      unaligned, w
+0000fa10: 6865 7265 203d 2075 6e61 6c69 676e 2866  here = unalign(f
+0000fa20: 6929 0a20 2020 2020 2020 2020 2020 2069  i).            i
+0000fa30: 6620 6178 6973 206e 6f74 2069 6e20 7768  f axis not in wh
+0000fa40: 6572 653a 0a20 2020 2020 2020 2020 2020  ere:.           
+0000fa50: 2020 2020 2073 756d 6d65 6420 3d20 7375       summed = su
+0000fa60: 6d28 6d75 6c74 6970 6c79 282a 6661 6374  m(multiply(*fact
+0000fa70: 6f72 735b 3a69 5d2c 202a 6661 6374 6f72  ors[:i], *factor
+0000fa80: 735b 692b 313a 5d29 2c20 6178 6973 290a  s[i+1:]), axis).
+0000fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000faa0: 7265 7475 726e 2073 756d 6d65 6420 2a20  return summed * 
+0000fab0: 616c 6967 6e28 756e 616c 6967 6e65 642c  align(unaligned,
+0000fac0: 205b 692d 2869 203e 2061 7869 7329 2066   [i-(i > axis) f
+0000fad0: 6f72 2069 2069 6e20 7768 6572 655d 2c20  or i in where], 
+0000fae0: 7375 6d6d 6564 2e73 6861 7065 290a 0a20  summed.shape).. 
+0000faf0: 2020 2064 6566 205f 6164 6428 7365 6c66     def _add(self
+0000fb00: 2c20 6f74 6865 7229 3a0a 2020 2020 2020  , other):.      
+0000fb10: 2020 6661 6374 6f72 7320 3d20 6c69 7374    factors = list
+0000fb20: 2873 656c 662e 5f66 6163 746f 7273 290a  (self._factors).
+0000fb30: 2020 2020 2020 2020 6f74 6865 725f 6661          other_fa
+0000fb40: 6374 6f72 7320 3d20 5b5d 0a20 2020 2020  ctors = [].     
+0000fb50: 2020 2063 6f6d 6d6f 6e20 3d20 5b5d 0a20     common = []. 
+0000fb60: 2020 2020 2020 2066 6f72 2066 2069 6e20         for f in 
+0000fb70: 6f74 6865 722e 5f66 6163 746f 7273 2069  other._factors i
+0000fb80: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
+0000fb90: 6572 2c20 4d75 6c74 6970 6c79 2920 656c  er, Multiply) el
+0000fba0: 7365 205b 6f74 6865 725d 3a0a 2020 2020  se [other]:.    
+0000fbb0: 2020 2020 2020 2020 6966 2066 2069 6e20          if f in 
+0000fbc0: 6661 6374 6f72 733a 0a20 2020 2020 2020  factors:.       
+0000fbd0: 2020 2020 2020 2020 2066 6163 746f 7273           factors
+0000fbe0: 2e72 656d 6f76 6528 6629 0a20 2020 2020  .remove(f).     
+0000fbf0: 2020 2020 2020 2020 2020 2063 6f6d 6d6f             commo
+0000fc00: 6e2e 6170 7065 6e64 2866 290a 2020 2020  n.append(f).    
+0000fc10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000fc20: 2020 2020 2020 2020 2020 2020 2020 6f74                ot
+0000fc30: 6865 725f 6661 6374 6f72 732e 6170 7065  her_factors.appe
+0000fc40: 6e64 2866 290a 2020 2020 2020 2020 6966  nd(f).        if
+0000fc50: 206e 6f74 2063 6f6d 6d6f 6e3a 0a20 2020   not common:.   
+0000fc60: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0000fc70: 2020 2020 2020 2020 6966 2066 6163 746f          if facto
+0000fc80: 7273 2061 6e64 206f 7468 6572 5f66 6163  rs and other_fac
+0000fc90: 746f 7273 3a0a 2020 2020 2020 2020 2020  tors:.          
+0000fca0: 2020 7265 7475 726e 206d 756c 7469 706c    return multipl
+0000fcb0: 7928 2a63 6f6d 6d6f 6e29 202a 2061 6464  y(*common) * add
+0000fcc0: 286d 756c 7469 706c 7928 2a66 6163 746f  (multiply(*facto
+0000fcd0: 7273 292c 206d 756c 7469 706c 7928 2a6f  rs), multiply(*o
+0000fce0: 7468 6572 5f66 6163 746f 7273 2929 0a20  ther_factors)). 
+0000fcf0: 2020 2020 2020 206e 7a20 3d20 6661 6374         nz = fact
+0000fd00: 6f72 7320 6f72 206f 7468 6572 5f66 6163  ors or other_fac
+0000fd10: 746f 7273 0a20 2020 2020 2020 2069 6620  tors.        if 
+0000fd20: 6e6f 7420 6e7a 3a20 2320 7365 6c66 2065  not nz: # self e
+0000fd30: 7175 616c 7320 6f74 6865 7220 2875 7020  quals other (up 
+0000fd40: 746f 2066 6163 746f 7220 6f72 6465 7269  to factor orderi
+0000fd50: 6e67 290a 2020 2020 2020 2020 2020 2020  ng).            
+0000fd60: 7265 7475 726e 2073 656c 6620 2a20 320a  return self * 2.
+0000fd70: 2020 2020 2020 2020 6966 206c 656e 286e          if len(n
+0000fd80: 7a29 203d 3d20 3120 616e 6420 7475 706c  z) == 1 and tupl
+0000fd90: 6528 6e7a 295b 305d 2e5f 636f 6e73 745f  e(nz)[0]._const_
+0000fda0: 756e 6966 6f72 6d20 3d3d 202d 313a 0a20  uniform == -1:. 
+0000fdb0: 2020 2020 2020 2020 2020 2023 2053 696e             # Sin
+0000fdc0: 6365 2074 6865 2073 7562 7472 6163 7469  ce the subtracti
+0000fdd0: 6f6e 2078 202d 2079 2069 7320 7374 6f72  on x - y is stor
+0000fde0: 6564 2061 7320 7820 2b20 2d31 202a 2079  ed as x + -1 * y
+0000fdf0: 2c20 7468 6973 2068 616e 646c 6573 0a20  , this handles. 
+0000fe00: 2020 2020 2020 2020 2020 2023 2074 6865             # the
+0000fe10: 2073 696d 706c 6966 6963 6174 696f 6e20   simplification 
+0000fe20: 6f66 2078 202d 2078 2074 6f20 302e 2057  of x - x to 0. W
+0000fe30: 6869 6c65 2077 6520 636f 756c 6420 616c  hile we could al
+0000fe40: 7465 726e 6174 6976 656c 790a 2020 2020  ternatively.    
+0000fe50: 2020 2020 2020 2020 2320 7369 6d70 6c69          # simpli
+0000fe60: 6679 2061 6c6c 2078 202b 2061 202a 2078  fy all x + a * x
+0000fe70: 2074 6f20 2861 202b 2031 2920 2a20 782c   to (a + 1) * x,
+0000fe80: 2063 6170 7475 7269 6e67 2061 203d 3d20   capturing a == 
+0000fe90: 2d31 2061 7320 610a 2020 2020 2020 2020  -1 as a.        
+0000fea0: 2020 2020 2320 7370 6563 6961 6c20 6361      # special ca
+0000feb0: 7365 2076 6961 2043 6f6e 7374 616e 742e  se via Constant.
+0000fec0: 5f61 6464 2c20 6974 2069 7320 6e6f 7420  _add, it is not 
+0000fed0: 6f62 7669 6f75 7320 7468 6174 2074 6869  obvious that thi
+0000fee0: 7320 6973 2069 6e0a 2020 2020 2020 2020  s is in.        
+0000fef0: 2020 2020 2320 616c 6c20 7369 7475 6174      # all situat
+0000ff00: 696f 6e73 2061 6e20 696d 7072 6f76 656d  ions an improvem
+0000ff10: 656e 742e 0a20 2020 2020 2020 2020 2020  ent..           
+0000ff20: 2072 6574 7572 6e20 7a65 726f 735f 6c69   return zeros_li
+0000ff30: 6b65 2873 656c 6629 0a0a 2020 2020 6465  ke(self)..    de
+0000ff40: 6620 5f64 6574 6572 6d69 6e61 6e74 2873  f _determinant(s
+0000ff50: 656c 662c 2061 7869 7331 2c20 6178 6973  elf, axis1, axis
+0000ff60: 3229 3a0a 2020 2020 2020 2020 6178 6973  2):.        axis
+0000ff70: 312c 2061 7869 7332 203d 2073 6f72 7465  1, axis2 = sorte
+0000ff80: 6428 5b61 7869 7331 2c20 6178 6973 325d  d([axis1, axis2]
+0000ff90: 290a 2020 2020 2020 2020 6661 6374 6f72  ).        factor
+0000ffa0: 7320 3d20 7475 706c 6528 7365 6c66 2e5f  s = tuple(self._
+0000ffb0: 6661 6374 6f72 7329 0a20 2020 2020 2020  factors).       
+0000ffc0: 2069 6620 616c 6c28 5f65 7175 616c 735f   if all(_equals_
+0000ffd0: 7363 616c 6172 5f63 6f6e 7374 616e 7428  scalar_constant(
+0000ffe0: 7365 6c66 2e73 6861 7065 5b61 7869 735d  self.shape[axis]
+0000fff0: 2c20 3129 2066 6f72 2061 7869 7320 696e  , 1) for axis in
+00010000: 2028 6178 6973 312c 2061 7869 7332 2929   (axis1, axis2))
+00010010: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00010020: 7475 726e 206d 756c 7469 706c 7928 2a5b  turn multiply(*[
+00010030: 6465 7465 726d 696e 616e 7428 662c 2028  determinant(f, (
+00010040: 6178 6973 312c 2061 7869 7332 2929 2066  axis1, axis2)) f
+00010050: 6f72 2066 2069 6e20 6661 6374 6f72 735d  or f in factors]
+00010060: 290a 2020 2020 2020 2020 666f 7220 692c  ).        for i,
+00010070: 2066 6920 696e 2065 6e75 6d65 7261 7465   fi in enumerate
+00010080: 2866 6163 746f 7273 293a 0a20 2020 2020  (factors):.     
+00010090: 2020 2020 2020 2075 6e61 6c69 676e 6564         unaligned
+000100a0: 2c20 7768 6572 6520 3d20 756e 616c 6967  , where = unalig
+000100b0: 6e28 6669 290a 2020 2020 2020 2020 2020  n(fi).          
+000100c0: 2020 6966 2061 7869 7331 206e 6f74 2069    if axis1 not i
+000100d0: 6e20 7768 6572 6520 616e 6420 6178 6973  n where and axis
+000100e0: 3220 6e6f 7420 696e 2077 6865 7265 3a0a  2 not in where:.
+000100f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010100: 6465 7420 3d20 6465 7465 726d 696e 616e  det = determinan
+00010110: 7428 6d75 6c74 6970 6c79 282a 6661 6374  t(multiply(*fact
+00010120: 6f72 735b 3a69 5d2c 202a 6661 6374 6f72  ors[:i], *factor
+00010130: 735b 692b 313a 5d29 2c20 2861 7869 7331  s[i+1:]), (axis1
+00010140: 2c20 6178 6973 3229 290a 2020 2020 2020  , axis2)).      
+00010150: 2020 2020 2020 2020 2020 7363 616c 6520            scale 
+00010160: 3d20 616c 6967 6e28 756e 616c 6967 6e65  = align(unaligne
+00010170: 642a 2a73 656c 662e 7368 6170 655b 6178  d**self.shape[ax
+00010180: 6973 315d 2c20 5b69 2d28 6920 3e20 6178  is1], [i-(i > ax
+00010190: 6973 3129 2d28 6920 3e20 6178 6973 3229  is1)-(i > axis2)
+000101a0: 2066 6f72 2069 2069 6e20 7768 6572 6520   for i in where 
+000101b0: 6966 2069 206e 6f74 2069 6e20 2861 7869  if i not in (axi
+000101c0: 7331 2c20 6178 6973 3229 5d2c 2064 6574  s1, axis2)], det
+000101d0: 2e73 6861 7065 290a 2020 2020 2020 2020  .shape).        
+000101e0: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+000101f0: 6574 202a 2073 6361 6c65 0a0a 2020 2020  et * scale..    
+00010200: 6465 6620 5f70 726f 6475 6374 2873 656c  def _product(sel
+00010210: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
+00010220: 726e 206d 756c 7469 706c 7928 2a5b 5072  rn multiply(*[Pr
+00010230: 6f64 7563 7428 6629 2066 6f72 2066 2069  oduct(f) for f i
+00010240: 6e20 7365 6c66 2e5f 6661 6374 6f72 735d  n self._factors]
+00010250: 290a 0a20 2020 2064 6566 205f 6465 7269  )..    def _deri
+00010260: 7661 7469 7665 2873 656c 662c 2076 6172  vative(self, var
+00010270: 2c20 7365 656e 293a 0a20 2020 2020 2020  , seen):.       
+00010280: 2066 756e 6331 2c20 6675 6e63 3220 3d20   func1, func2 = 
+00010290: 7365 6c66 2e66 756e 6373 0a20 2020 2020  self.funcs.     
+000102a0: 2020 2072 6574 7572 6e20 6569 6e73 756d     return einsum
+000102b0: 2827 412c 4142 2d3e 4142 272c 2066 756e  ('A,AB->AB', fun
+000102c0: 6331 2c20 6465 7269 7661 7469 7665 2866  c1, derivative(f
+000102d0: 756e 6332 2c20 7661 722c 2073 6565 6e29  unc2, var, seen)
+000102e0: 2920 5c0a 2020 2020 2020 2020 2020 2020  ) \.            
+000102f0: 2b20 6569 6e73 756d 2827 412c 4142 2d3e  + einsum('A,AB->
+00010300: 4142 272c 2066 756e 6332 2c20 6465 7269  AB', func2, deri
+00010310: 7661 7469 7665 2866 756e 6331 2c20 7661  vative(func1, va
+00010320: 722c 2073 6565 6e29 290a 0a20 2020 2064  r, seen))..    d
+00010330: 6566 205f 7461 6b65 6469 6167 2873 656c  ef _takediag(sel
+00010340: 662c 2061 7869 7331 2c20 6178 6973 3229  f, axis1, axis2)
+00010350: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00010360: 206d 756c 7469 706c 7928 2a5b 5f74 616b   multiply(*[_tak
+00010370: 6564 6961 6728 662c 2061 7869 7331 2c20  ediag(f, axis1, 
+00010380: 6178 6973 3229 2066 6f72 2066 2069 6e20  axis2) for f in 
+00010390: 7365 6c66 2e5f 6661 6374 6f72 735d 290a  self._factors]).
+000103a0: 0a20 2020 2064 6566 205f 7461 6b65 2873  .    def _take(s
+000103b0: 656c 662c 2069 6e64 6578 2c20 6178 6973  elf, index, axis
+000103c0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+000103d0: 6e20 6d75 6c74 6970 6c79 282a 5b5f 7461  n multiply(*[_ta
+000103e0: 6b65 2866 2c20 696e 6465 782c 2061 7869  ke(f, index, axi
+000103f0: 7329 2066 6f72 2066 2069 6e20 7365 6c66  s) for f in self
+00010400: 2e5f 6661 6374 6f72 735d 290a 0a20 2020  ._factors])..   
+00010410: 2064 6566 205f 7369 676e 2873 656c 6629   def _sign(self)
+00010420: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00010430: 206d 756c 7469 706c 7928 2a5b 5369 676e   multiply(*[Sign
+00010440: 2866 2920 666f 7220 6620 696e 2073 656c  (f) for f in sel
+00010450: 662e 5f66 6163 746f 7273 5d29 0a0a 2020  f._factors])..  
+00010460: 2020 6465 6620 5f75 6e72 6176 656c 2873    def _unravel(s
+00010470: 656c 662c 2061 7869 732c 2073 6861 7065  elf, axis, shape
+00010480: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00010490: 6e20 6d75 6c74 6970 6c79 282a 5b75 6e72  n multiply(*[unr
+000104a0: 6176 656c 2866 2c20 6178 6973 2c20 7368  avel(f, axis, sh
+000104b0: 6170 6529 2066 6f72 2066 2069 6e20 7365  ape) for f in se
+000104c0: 6c66 2e5f 6661 6374 6f72 735d 290a 0a20  lf._factors]).. 
+000104d0: 2020 2064 6566 205f 696e 7665 7273 6528     def _inverse(
+000104e0: 7365 6c66 2c20 6178 6973 312c 2061 7869  self, axis1, axi
+000104f0: 7332 293a 0a20 2020 2020 2020 2066 6163  s2):.        fac
+00010500: 746f 7273 203d 2074 7570 6c65 2873 656c  tors = tuple(sel
+00010510: 662e 5f66 6163 746f 7273 290a 2020 2020  f._factors).    
+00010520: 2020 2020 666f 7220 692c 2066 6920 696e      for i, fi in
+00010530: 2065 6e75 6d65 7261 7465 2866 6163 746f   enumerate(facto
+00010540: 7273 293a 0a20 2020 2020 2020 2020 2020  rs):.           
+00010550: 2069 6620 7365 7428 756e 616c 6967 6e28   if set(unalign(
+00010560: 6669 295b 315d 292e 6973 6469 736a 6f69  fi)[1]).isdisjoi
+00010570: 6e74 2828 6178 6973 312c 2061 7869 7332  nt((axis1, axis2
+00010580: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00010590: 2020 2020 696e 7620 3d20 696e 7665 7273      inv = invers
+000105a0: 6528 6d75 6c74 6970 6c79 282a 6661 6374  e(multiply(*fact
+000105b0: 6f72 735b 3a69 5d2c 202a 6661 6374 6f72  ors[:i], *factor
+000105c0: 735b 692b 313a 5d29 2c20 2861 7869 7331  s[i+1:]), (axis1
+000105d0: 2c20 6178 6973 3229 290a 2020 2020 2020  , axis2)).      
+000105e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000105f0: 2064 6976 6964 6528 696e 762c 2066 6929   divide(inv, fi)
+00010600: 0a0a 2020 2020 4063 6163 6865 645f 7072  ..    @cached_pr
+00010610: 6f70 6572 7479 0a20 2020 2064 6566 205f  operty.    def _
+00010620: 6173 7370 6172 7365 2873 656c 6629 3a0a  assparse(self):.
+00010630: 2020 2020 2020 2020 2320 4669 7273 7420          # First 
+00010640: 7765 2063 6f6c 6c65 6374 2074 6865 2063  we collect the c
+00010650: 6c75 7374 6572 7320 6f66 2066 6163 746f  lusters of facto
+00010660: 7273 2074 6861 7420 6861 7665 206e 6f20  rs that have no 
+00010670: 7265 616c 2028 692e 652e 206e 6f74 0a20  real (i.e. not. 
+00010680: 2020 2020 2020 2023 2069 6e73 6572 7465         # inserte
+00010690: 6429 2061 7865 7320 696e 2063 6f6d 6d6f  d) axes in commo
+000106a0: 6e20 7769 7468 2074 6865 206f 7468 6572  n with the other
+000106b0: 2063 6c75 7374 6572 732c 2061 6e64 2073   clusters, and s
+000106c0: 746f 7265 2074 6865 6d20 696e 0a20 2020  tore them in.   
+000106d0: 2020 2020 2023 2075 6e69 6e73 6572 7465       # uninserte
+000106e0: 6420 666f 726d 2e0a 2020 2020 2020 2020  d form..        
+000106f0: 636c 7573 7465 7273 203d 205b 5d0a 2020  clusters = [].  
+00010700: 2020 2020 2020 666f 7220 6620 696e 2073        for f in s
+00010710: 656c 662e 5f66 6163 746f 7273 3a0a 2020  elf._factors:.  
+00010720: 2020 2020 2020 2020 2020 756e 696e 7365            uninse
+00010730: 7274 6564 2c20 7768 6572 6520 3d20 756e  rted, where = un
+00010740: 616c 6967 6e28 6629 0a20 2020 2020 2020  align(f).       
+00010750: 2020 2020 2066 6f72 2069 2069 6e20 7265       for i in re
+00010760: 7665 7273 6564 2872 616e 6765 286c 656e  versed(range(len
+00010770: 2863 6c75 7374 6572 7329 2929 3a0a 2020  (clusters))):.  
+00010780: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00010790: 2073 6574 2877 6865 7265 2920 2620 7365   set(where) & se
+000107a0: 7428 636c 7573 7465 7273 5b69 5d5b 315d  t(clusters[i][1]
+000107b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000107c0: 2020 2020 2020 2077 203d 2077 6865 7265         w = where
+000107d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000107e0: 2020 2020 2075 6e69 6e73 5f2c 2077 5f20       unins_, w_ 
+000107f0: 3d20 636c 7573 7465 7273 2e70 6f70 2869  = clusters.pop(i
+00010800: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010810: 2020 2020 2020 7768 6572 6520 3d20 6e75        where = nu
+00010820: 6d70 792e 756e 696f 6e31 6428 772c 2077  mpy.union1d(w, w
+00010830: 5f29 0a20 2020 2020 2020 2020 2020 2020  _).             
+00010840: 2020 2020 2020 2073 6861 7065 203d 2074         shape = t
+00010850: 7570 6c65 2873 656c 662e 7368 6170 655b  uple(self.shape[
+00010860: 695d 2066 6f72 2069 2069 6e20 7768 6572  i] for i in wher
+00010870: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00010880: 2020 2020 2020 2075 6e69 6e73 6572 7465         uninserte
+00010890: 6420 3d20 616c 6967 6e28 756e 696e 7365  d = align(uninse
+000108a0: 7274 6564 2c20 6e75 6d70 792e 7365 6172  rted, numpy.sear
+000108b0: 6368 736f 7274 6564 2877 6865 7265 2c20  chsorted(where, 
+000108c0: 7729 2c20 7368 6170 6529 202a 2061 6c69  w), shape) * ali
+000108d0: 676e 2875 6e69 6e73 5f2c 206e 756d 7079  gn(unins_, numpy
+000108e0: 2e73 6561 7263 6873 6f72 7465 6428 7768  .searchsorted(wh
+000108f0: 6572 652c 2077 5f29 2c20 7368 6170 6529  ere, w_), shape)
+00010900: 0a20 2020 2020 2020 2020 2020 2063 6c75  .            clu
+00010910: 7374 6572 732e 6170 7065 6e64 2828 756e  sters.append((un
+00010920: 696e 7365 7274 6564 2c20 7768 6572 6529  inserted, where)
+00010930: 290a 2020 2020 2020 2020 2320 4966 2074  ).        # If t
+00010940: 6865 7265 2069 7320 6f6e 6c79 206f 6e65  here is only one
+00010950: 2063 6c75 7374 6572 2077 6520 6661 6c6c   cluster we fall
+00010960: 2062 6163 6b20 6f6e 2074 6865 2064 6566   back on the def
+00010970: 6175 6c74 0a20 2020 2020 2020 2023 2069  ault.        # i
+00010980: 6d70 6c65 6d65 6e74 6174 696f 6e2e 0a20  mplementation.. 
+00010990: 2020 2020 2020 2069 6620 6c65 6e28 636c         if len(cl
+000109a0: 7573 7465 7273 2920 3d3d 2031 3a0a 2020  usters) == 1:.  
+000109b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000109c0: 2073 7570 6572 2829 2e5f 6173 7370 6172   super()._asspar
+000109d0: 7365 0a20 2020 2020 2020 2023 2049 6620  se.        # If 
+000109e0: 7468 6572 6520 6172 6520 7477 6f20 6f72  there are two or
+000109f0: 206d 6f72 6520 636c 7573 7465 7273 2077   more clusters w
+00010a00: 6520 7772 6974 6520 7468 6520 7072 6f64  e write the prod
+00010a10: 7563 7420 6f66 2061 6464 6974 696f 6e73  uct of additions
+00010a20: 0a20 2020 2020 2020 2023 2061 7320 616e  .        # as an
+00010a30: 2061 6464 6974 696f 6e20 6f66 2070 726f   addition of pro
+00010a40: 6475 6374 732e 0a20 2020 2020 2020 2075  ducts..        u
+00010a50: 6e69 6e73 6572 7465 6473 2c20 7768 6572  ninserteds, wher
+00010a60: 6573 203d 207a 6970 282a 636c 7573 7465  es = zip(*cluste
+00010a70: 7273 290a 2020 2020 2020 2020 7370 6172  rs).        spar
+00010a80: 7365 203d 205b 5d0a 2020 2020 2020 2020  se = [].        
+00010a90: 666f 7220 6974 656d 7320 696e 2069 7465  for items in ite
+00010aa0: 7274 6f6f 6c73 2e70 726f 6475 6374 282a  rtools.product(*
+00010ab0: 5b75 2e5f 6173 7370 6172 7365 2066 6f72  [u._assparse for
+00010ac0: 2075 2069 6e20 756e 696e 7365 7274 6564   u in uninserted
+00010ad0: 735d 293a 0a20 2020 2020 2020 2020 2020  s]):.           
+00010ae0: 2073 6861 7065 203d 2075 7469 6c2e 7375   shape = util.su
+00010af0: 6d28 662e 7368 6170 6520 666f 7220 2a69  m(f.shape for *i
+00010b00: 6e64 2c20 6620 696e 2069 7465 6d73 290a  nd, f in items).
+00010b10: 2020 2020 2020 2020 2020 2020 696e 6469              indi
+00010b20: 6365 7320 3d20 5b4e 6f6e 655d 202a 2073  ces = [None] * s
+00010b30: 656c 662e 6e64 696d 0a20 2020 2020 2020  elf.ndim.       
+00010b40: 2020 2020 2066 6163 746f 7273 203d 205b       factors = [
+00010b50: 5d0a 2020 2020 2020 2020 2020 2020 6120  ].            a 
+00010b60: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+00010b70: 666f 7220 7768 6572 652c 2028 2a69 6e64  for where, (*ind
+00010b80: 2c20 6629 2069 6e20 7a69 7028 7768 6572  , f) in zip(wher
+00010b90: 6573 2c20 6974 656d 7329 3a0a 2020 2020  es, items):.    
+00010ba0: 2020 2020 2020 2020 2020 2020 6220 3d20              b = 
+00010bb0: 6120 2b20 662e 6e64 696d 0a20 2020 2020  a + f.ndim.     
+00010bc0: 2020 2020 2020 2020 2020 2072 203d 206e             r = n
+00010bd0: 756d 7079 2e61 7261 6e67 6528 612c 2062  umpy.arange(a, b
+00010be0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010bf0: 2020 666f 7220 692c 2069 6e64 6920 696e    for i, indi in
+00010c00: 207a 6970 2877 6865 7265 2c20 696e 6429   zip(where, ind)
+00010c10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010c20: 2020 2020 2020 696e 6469 6365 735b 695d        indices[i]
+00010c30: 203d 2061 6c69 676e 2869 6e64 692c 2072   = align(indi, r
+00010c40: 2c20 7368 6170 6529 0a20 2020 2020 2020  , shape).       
+00010c50: 2020 2020 2020 2020 2066 6163 746f 7273           factors
+00010c60: 2e61 7070 656e 6428 616c 6967 6e28 662c  .append(align(f,
+00010c70: 2072 2c20 7368 6170 6529 290a 2020 2020   r, shape)).    
+00010c80: 2020 2020 2020 2020 2020 2020 6120 3d20              a = 
+00010c90: 620a 2020 2020 2020 2020 2020 2020 7370  b.            sp
+00010ca0: 6172 7365 2e61 7070 656e 6428 282a 696e  arse.append((*in
+00010cb0: 6469 6365 732c 206d 756c 7469 706c 7928  dices, multiply(
+00010cc0: 2a66 6163 746f 7273 2929 290a 2020 2020  *factors))).    
+00010cd0: 2020 2020 7265 7475 726e 2074 7570 6c65      return tuple
+00010ce0: 2873 7061 7273 6529 0a0a 2020 2020 6465  (sparse)..    de
+00010cf0: 6620 5f69 6e74 626f 756e 6473 5f69 6d70  f _intbounds_imp
+00010d00: 6c28 7365 6c66 293a 0a20 2020 2020 2020  l(self):.       
+00010d10: 2066 756e 6331 2c20 6675 6e63 3220 3d20   func1, func2 = 
+00010d20: 7365 6c66 2e66 756e 6373 0a20 2020 2020  self.funcs.     
+00010d30: 2020 2065 7874 7265 6d61 203d 205b 6231     extrema = [b1
+00010d40: 2061 6e64 2062 3220 616e 6420 6231 202a   and b2 and b1 *
+00010d50: 2062 3220 666f 7220 6231 2069 6e20 6675   b2 for b1 in fu
+00010d60: 6e63 312e 5f69 6e74 626f 756e 6473 2066  nc1._intbounds f
+00010d70: 6f72 2062 3220 696e 2066 756e 6332 2e5f  or b2 in func2._
+00010d80: 696e 7462 6f75 6e64 735d 0a20 2020 2020  intbounds].     
+00010d90: 2020 2072 6574 7572 6e20 6d69 6e28 6578     return min(ex
+00010da0: 7472 656d 6129 2c20 6d61 7828 6578 7472  trema), max(extr
+00010db0: 656d 6129 0a0a 0a63 6c61 7373 2041 6464  ema)...class Add
+00010dc0: 2841 7272 6179 293a 0a0a 2020 2020 6465  (Array):..    de
+00010dd0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00010de0: 2066 756e 6373 3a20 7479 7065 732e 6672   funcs: types.fr
+00010df0: 6f7a 656e 6d75 6c74 6973 6574 293a 0a20  ozenmultiset):. 
+00010e00: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+00010e10: 696e 7374 616e 6365 2866 756e 6373 2c20  instance(funcs, 
+00010e20: 7479 7065 732e 6672 6f7a 656e 6d75 6c74  types.frozenmult
+00010e30: 6973 6574 2920 616e 6420 6c65 6e28 6675  iset) and len(fu
+00010e40: 6e63 7329 203d 3d20 322c 2066 2766 756e  ncs) == 2, f'fun
+00010e50: 6373 3d7b 6675 6e63 7321 727d 270a 2020  cs={funcs!r}'.  
+00010e60: 2020 2020 2020 7365 6c66 2e66 756e 6373        self.funcs
+00010e70: 203d 2066 756e 6373 0a20 2020 2020 2020   = funcs.       
+00010e80: 2066 756e 6331 2c20 6675 6e63 3220 3d20   func1, func2 = 
+00010e90: 6675 6e63 730a 2020 2020 2020 2020 6173  funcs.        as
+00010ea0: 7365 7274 2065 7175 616c 7368 6170 6528  sert equalshape(
+00010eb0: 6675 6e63 312e 7368 6170 652c 2066 756e  func1.shape, fun
+00010ec0: 6332 2e73 6861 7065 2920 616e 6420 6675  c2.shape) and fu
+00010ed0: 6e63 312e 6474 7970 6520 3d3d 2066 756e  nc1.dtype == fun
+00010ee0: 6332 2e64 7479 7065 2021 3d20 626f 6f6c  c2.dtype != bool
+00010ef0: 2c20 2741 6464 287b 7d2c 207b 7d29 272e  , 'Add({}, {})'.
+00010f00: 666f 726d 6174 2866 756e 6331 2c20 6675  format(func1, fu
+00010f10: 6e63 3229 0a20 2020 2020 2020 2073 7570  nc2).        sup
+00010f20: 6572 2829 2e5f 5f69 6e69 745f 5f28 6172  er().__init__(ar
+00010f30: 6773 3d74 7570 6c65 2873 656c 662e 6675  gs=tuple(self.fu
+00010f40: 6e63 7329 2c20 7368 6170 653d 6675 6e63  ncs), shape=func
+00010f50: 312e 7368 6170 652c 2064 7479 7065 3d66  1.shape, dtype=f
+00010f60: 756e 6331 2e64 7479 7065 290a 0a20 2020  unc1.dtype)..   
+00010f70: 2040 6361 6368 6564 5f70 726f 7065 7274   @cached_propert
+00010f80: 790a 2020 2020 6465 6620 5f69 6e66 6c61  y.    def _infla
+00010f90: 7469 6f6e 7328 7365 6c66 293a 0a20 2020  tions(self):.   
+00010fa0: 2020 2020 2066 756e 6331 2c20 6675 6e63       func1, func
+00010fb0: 3220 3d20 7365 6c66 2e66 756e 6373 0a20  2 = self.funcs. 
+00010fc0: 2020 2020 2020 2066 756e 6332 5f69 6e66         func2_inf
+00010fd0: 6c61 7469 6f6e 7320 3d20 6469 6374 2866  lations = dict(f
+00010fe0: 756e 6332 2e5f 696e 666c 6174 696f 6e73  unc2._inflations
+00010ff0: 290a 2020 2020 2020 2020 696e 666c 6174  ).        inflat
+00011000: 696f 6e73 203d 205b 5d0a 2020 2020 2020  ions = [].      
+00011010: 2020 666f 7220 6178 6973 2c20 7061 7274    for axis, part
+00011020: 7331 2069 6e20 6675 6e63 312e 5f69 6e66  s1 in func1._inf
+00011030: 6c61 7469 6f6e 733a 0a20 2020 2020 2020  lations:.       
+00011040: 2020 2020 2069 6620 6178 6973 206e 6f74       if axis not
+00011050: 2069 6e20 6675 6e63 325f 696e 666c 6174   in func2_inflat
+00011060: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+00011070: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00011080: 2020 2020 2020 2020 2020 2070 6172 7473             parts
+00011090: 3220 3d20 6675 6e63 325f 696e 666c 6174  2 = func2_inflat
+000110a0: 696f 6e73 5b61 7869 735d 0a20 2020 2020  ions[axis].     
+000110b0: 2020 2020 2020 2064 6f66 6d61 7073 203d         dofmaps =
+000110c0: 2073 6574 2870 6172 7473 3129 207c 2073   set(parts1) | s
+000110d0: 6574 2870 6172 7473 3229 0a20 2020 2020  et(parts2).     
+000110e0: 2020 2020 2020 2069 6620 286c 656e 2870         if (len(p
+000110f0: 6172 7473 3129 203c 206c 656e 2864 6f66  arts1) < len(dof
+00011100: 6d61 7073 2920 616e 6420 6c65 6e28 7061  maps) and len(pa
+00011110: 7274 7332 2920 3c20 6c65 6e28 646f 666d  rts2) < len(dofm
+00011120: 6170 7329 2020 2320 6e65 6974 6865 7220  aps)  # neither 
+00011130: 7365 7420 6973 2061 2073 7562 7365 7420  set is a subset 
+00011140: 6f66 2074 6865 206f 7468 6572 3b20 746f  of the other; to
+00011150: 7461 6c20 6d61 7920 6265 2064 656e 7365  tal may be dense
+00011160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011170: 2020 2020 2061 6e64 2073 656c 662e 7368       and self.sh
+00011180: 6170 655b 6178 6973 5d2e 6973 636f 6e73  ape[axis].iscons
+00011190: 7461 6e74 2061 6e64 2061 6c6c 2864 6f66  tant and all(dof
+000111a0: 6d61 702e 6973 636f 6e73 7461 6e74 2066  map.isconstant f
+000111b0: 6f72 2064 6f66 6d61 7020 696e 2064 6f66  or dofmap in dof
+000111c0: 6d61 7073 2929 3a0a 2020 2020 2020 2020  maps)):.        
+000111d0: 2020 2020 2020 2020 6d61 736b 203d 206e          mask = n
+000111e0: 756d 7079 2e7a 6572 6f73 2869 6e74 2873  umpy.zeros(int(s
+000111f0: 656c 662e 7368 6170 655b 6178 6973 5d29  elf.shape[axis])
+00011200: 2c20 6474 7970 653d 626f 6f6c 290a 2020  , dtype=bool).  
+00011210: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00011220: 7220 646f 666d 6170 2069 6e20 646f 666d  r dofmap in dofm
+00011230: 6170 733a 0a20 2020 2020 2020 2020 2020  aps:.           
+00011240: 2020 2020 2020 2020 206d 6173 6b5b 646f           mask[do
+00011250: 666d 6170 2e65 7661 6c28 295d 203d 2054  fmap.eval()] = T
+00011260: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+00011270: 2020 2020 6966 206d 6173 6b2e 616c 6c28      if mask.all(
+00011280: 293a 2020 2320 6178 6973 2061 6464 7320  ):  # axis adds 
+00011290: 7570 2074 6f20 6465 6e73 650a 2020 2020  up to dense.    
+000112a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000112b0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+000112c0: 2020 2020 2069 6e66 6c61 7469 6f6e 732e       inflations.
+000112d0: 6170 7065 6e64 2828 6178 6973 2c20 7479  append((axis, ty
+000112e0: 7065 732e 6672 6f7a 656e 6469 6374 2828  pes.frozendict((
+000112f0: 646f 666d 6170 2c20 7574 696c 2e73 756d  dofmap, util.sum
+00011300: 2870 6172 7473 5b64 6f66 6d61 705d 2066  (parts[dofmap] f
+00011310: 6f72 2070 6172 7473 2069 6e20 2870 6172  or parts in (par
+00011320: 7473 312c 2070 6172 7473 3229 2069 6620  ts1, parts2) if 
+00011330: 646f 666d 6170 2069 6e20 7061 7274 7329  dofmap in parts)
+00011340: 2920 666f 7220 646f 666d 6170 2069 6e20  ) for dofmap in 
+00011350: 646f 666d 6170 7329 2929 0a20 2020 2020  dofmaps))).     
+00011360: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
+00011370: 696e 666c 6174 696f 6e73 290a 0a20 2020  inflations)..   
+00011380: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00011390: 6566 205f 7465 726d 7328 7365 6c66 293a  ef _terms(self):
+000113a0: 0a20 2020 2020 2020 2066 6f72 2066 756e  .        for fun
+000113b0: 6320 696e 2073 656c 662e 6675 6e63 733a  c in self.funcs:
+000113c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000113d0: 6973 696e 7374 616e 6365 2866 756e 632c  isinstance(func,
+000113e0: 2041 6464 293a 0a20 2020 2020 2020 2020   Add):.         
+000113f0: 2020 2020 2020 2079 6965 6c64 2066 726f         yield fro
+00011400: 6d20 6675 6e63 2e5f 7465 726d 730a 2020  m func._terms.  
+00011410: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00011420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011430: 7969 656c 6420 6675 6e63 0a0a 2020 2020  yield func..    
+00011440: 6465 6620 5f73 696d 706c 6966 6965 6428  def _simplified(
+00011450: 7365 6c66 293a 0a20 2020 2020 2020 2074  self):.        t
+00011460: 6572 6d73 203d 2074 7570 6c65 2873 656c  erms = tuple(sel
+00011470: 662e 5f74 6572 6d73 290a 2020 2020 2020  f._terms).      
+00011480: 2020 666f 7220 6a2c 2066 6a20 696e 2065    for j, fj in e
+00011490: 6e75 6d65 7261 7465 2874 6572 6d73 293a  numerate(terms):
+000114a0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000114b0: 2069 2c20 6669 2069 6e20 656e 756d 6572   i, fi in enumer
+000114c0: 6174 6528 7465 726d 735b 3a6a 5d29 3a0a  ate(terms[:j]):.
+000114d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000114e0: 6469 6167 7320 3d20 5b73 6f72 7465 6428  diags = [sorted(
+000114f0: 6178 6573 6920 2620 6178 6573 6a29 5b3a  axesi & axesj)[:
+00011500: 325d 2066 6f72 2061 7865 7369 2069 6e20  2] for axesi in 
+00011510: 6669 2e5f 6469 6167 6f6e 616c 7320 666f  fi._diagonals fo
+00011520: 7220 6178 6573 6a20 696e 2066 6a2e 5f64  r axesj in fj._d
+00011530: 6961 676f 6e61 6c73 2069 6620 6c65 6e28  iagonals if len(
+00011540: 6178 6573 6920 2620 6178 6573 6a29 203e  axesi & axesj) >
+00011550: 3d20 325d 0a20 2020 2020 2020 2020 2020  = 2].           
+00011560: 2020 2020 2075 6e61 6c69 676e 6564 312c       unaligned1,
+00011570: 2075 6e61 6c69 676e 6564 322c 2077 6865   unaligned2, whe
+00011580: 7265 203d 2075 6e61 6c69 676e 2866 692c  re = unalign(fi,
+00011590: 2066 6a29 0a20 2020 2020 2020 2020 2020   fj).           
+000115a0: 2020 2020 2066 696a 203d 2064 6961 676f       fij = diago
+000115b0: 6e61 6c69 7a65 2874 616b 6564 6961 6728  nalize(takediag(
+000115c0: 6669 2c20 2a64 6961 6773 5b30 5d29 202b  fi, *diags[0]) +
+000115d0: 2074 616b 6564 6961 6728 666a 2c20 2a64   takediag(fj, *d
+000115e0: 6961 6773 5b30 5d29 2c20 2a64 6961 6773  iags[0]), *diags
+000115f0: 5b30 5d29 2069 6620 6469 6167 7320 5c0a  [0]) if diags \.
+00011600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011610: 2020 2020 656c 7365 2061 6c69 676e 2875      else align(u
+00011620: 6e61 6c69 676e 6564 3120 2b20 756e 616c  naligned1 + unal
+00011630: 6967 6e65 6432 2c20 7768 6572 652c 2073  igned2, where, s
+00011640: 656c 662e 7368 6170 6529 2069 6620 6c65  elf.shape) if le
+00011650: 6e28 7768 6572 6529 2021 3d20 7365 6c66  n(where) != self
+00011660: 2e6e 6469 6d20 5c0a 2020 2020 2020 2020  .ndim \.        
+00011670: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00011680: 2066 692e 5f61 6464 2866 6a29 206f 7220   fi._add(fj) or 
+00011690: 666a 2e5f 6164 6428 6669 290a 2020 2020  fj._add(fi).    
+000116a0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+000116b0: 696a 3a0a 2020 2020 2020 2020 2020 2020  ij:.            
+000116c0: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+000116d0: 6464 282a 7465 726d 735b 3a69 5d2c 202a  dd(*terms[:i], *
+000116e0: 7465 726d 735b 692b 313a 6a5d 2c20 2a74  terms[i+1:j], *t
+000116f0: 6572 6d73 5b6a 2b31 3a5d 2c20 6669 6a29  erms[j+1:], fij)
+00011700: 0a20 2020 2020 2020 2023 204e 4f54 453a  .        # NOTE:
+00011710: 2057 6869 6c65 2069 7420 6973 2074 656d   While it is tem
+00011720: 7074 696e 6720 746f 2075 7365 2074 6865  pting to use the
+00011730: 205f 696e 666c 6174 696f 6e73 2061 7474   _inflations att
+00011740: 7269 6275 7465 2074 6f20 7075 7368 0a20  ribute to push. 
+00011750: 2020 2020 2020 2023 2061 6464 6974 696f         # additio
+00011760: 6e73 2074 6872 6f75 6768 2063 6f6d 6d6f  ns through commo
+00011770: 6e20 696e 666c 6174 696f 6e73 2c20 646f  n inflations, do
+00011780: 696e 6720 736f 206d 6179 2072 6573 756c  ing so may resul
+00011790: 7420 696e 2069 6e66 696e 6974 650a 2020  t in infinite.  
+000117a0: 2020 2020 2020 2320 7265 6375 7273 696f        # recursio
+000117b0: 6e20 696e 2063 6173 6520 7477 6f20 6f72  n in case two or
+000117c0: 206d 6f72 6520 6178 6573 2061 7265 2069   more axes are i
+000117d0: 6e66 6c61 7465 642e 2054 6869 7320 6d65  nflated. This me
+000117e0: 6368 616e 6973 6d20 6973 0a20 2020 2020  chanism is.     
+000117f0: 2020 2023 2069 6c6c 7573 7472 6174 6564     # illustrated
+00011800: 2069 6e20 7468 6520 666f 6c6c 6f77 696e   in the followin
+00011810: 6720 7363 6865 6d61 7469 632c 2069 6e20  g schematic, in 
+00011820: 7768 6963 6820 3c49 3e20 616e 6420 3c4a  which <I> and <J
+00011830: 3e20 7265 7072 6573 656e 740a 2020 2020  > represent.    
+00011840: 2020 2020 2320 696e 666c 6174 696f 6e73      # inflations
+00011850: 2061 6c6f 6e67 2061 7869 7320 3120 616e   along axis 1 an
+00011860: 6420 3c4b 3e20 616e 6420 3c4c 3e20 696e  d <K> and <L> in
+00011870: 666c 6174 696f 6e73 2061 6c6f 6e67 2061  flations along a
+00011880: 7869 7320 323a 0a20 2020 2020 2020 2023  xis 2:.        #
+00011890: 0a20 2020 2020 2020 2023 2020 2020 2020  .        #      
+000118a0: 2020 4120 2020 4220 2020 4320 2020 4420    A   B   C   D 
+000118b0: 2020 4520 2020 4620 2020 4720 2020 480a    E   F   G   H.
+000118c0: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+000118d0: 3c49 3e20 3c4a 3e20 3c49 3e20 3c4a 3e20  <I> <J> <I> <J> 
+000118e0: 3c49 3e20 3c4a 3e20 3c49 3e20 3c4a 3e0a  <I> <J> <I> <J>.
+000118f0: 2020 2020 2020 2020 2320 202e 2d2d 2020          #  .--  
+00011900: 2020 5c2b 2f20 2020 2020 5c2b 2f20 2020    \+/     \+/   
+00011910: 2020 5c2b 2f20 2020 2020 5c2b 2f20 2020    \+/     \+/   
+00011920: 3c2d 2d2e 0a20 2020 2020 2020 2023 2020  <--..        #  
+00011930: 7c20 2020 2020 2020 5c5f 5f3c 4b3e 5f5f  |       \__<K>__
+00011940: 2f20 2020 2020 2020 5c5f 5f3c 4c3e 5f5f  /       \__<L>__
+00011950: 2f20 2020 2020 2020 7c0a 2020 2020 2020  /       |.      
+00011960: 2020 2320 207c 2020 2020 2020 2020 2020    #  |          
+00011970: 205c 5f5f 5f5f 5f5f 5f2b 5f5f 5f5f 5f5f   \_______+______
+00011980: 5f2f 2020 2020 2020 2020 2020 207c 0a20  _/           |. 
+00011990: 2020 2020 2020 2023 2020 7c20 2020 2020         #  |     
+000119a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000119b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000119c0: 2020 7c0a 2020 2020 2020 2020 2320 207c    |.        #  |
+000119d0: 2020 2020 2041 2020 2045 2020 2043 2020       A   E   C  
+000119e0: 2047 2020 2042 2020 2046 2020 2044 2020   G   B   F   D  
+000119f0: 2048 2020 2020 207c 0a20 2020 2020 2020   H     |.       
+00011a00: 2023 2020 7c20 2020 203c 4b3e 203c 4c3e   #  |    <K> <L>
+00011a10: 203c 4b3e 203c 4c3e 203c 4b3e 203c 4c3e   <K> <L> <K> <L>
+00011a20: 203c 4b3e 203c 4c3e 2020 2020 7c0a 2020   <K> <L>    |.  
+00011a30: 2020 2020 2020 2320 2027 2d2d 3e20 2020        #  '-->   
+00011a40: 5c2b 2f20 2020 2020 5c2b 2f20 2020 2020  \+/     \+/     
+00011a50: 5c2b 2f20 2020 2020 5c2b 2f20 2020 202d  \+/     \+/    -
+00011a60: 2d27 0a20 2020 2020 2020 2023 2020 2020  -'.        #    
+00011a70: 2020 2020 2020 5c5f 5f3c 493e 5f5f 2f20        \__<I>__/ 
+00011a80: 2020 2020 2020 5c5f 5f3c 4a3e 5f5f 2f0a        \__<J>__/.
+00011a90: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+00011aa0: 2020 2020 2020 205c 5f5f 5f5f 5f5f 5f2b         \_______+
+00011ab0: 5f5f 5f5f 5f5f 5f2f 0a20 2020 2020 2020  _______/.       
+00011ac0: 2023 0a20 2020 2020 2020 2023 2057 6520   #.        # We 
+00011ad0: 696e 7374 6561 6420 7265 6c79 206f 6e20  instead rely on 
+00011ae0: 496e 666c 6174 652e 5f61 6464 2074 6f20  Inflate._add to 
+00011af0: 6861 6e64 6c65 2074 6869 7320 7369 7475  handle this situ
+00011b00: 6174 696f 6e2e 0a0a 2020 2020 6576 616c  ation...    eval
+00011b10: 6620 3d20 7374 6174 6963 6d65 7468 6f64  f = staticmethod
+00011b20: 286e 756d 7079 2e61 6464 290a 0a20 2020  (numpy.add)..   
+00011b30: 2064 6566 205f 7375 6d28 7365 6c66 2c20   def _sum(self, 
+00011b40: 6178 6973 293a 0a20 2020 2020 2020 2072  axis):.        r
+00011b50: 6574 7572 6e20 6164 6428 2a5b 7375 6d28  eturn add(*[sum(
+00011b60: 662c 2061 7869 7329 2066 6f72 2066 2069  f, axis) for f i
+00011b70: 6e20 7365 6c66 2e5f 7465 726d 735d 290a  n self._terms]).
+00011b80: 0a20 2020 2064 6566 205f 6465 7269 7661  .    def _deriva
+00011b90: 7469 7665 2873 656c 662c 2076 6172 2c20  tive(self, var, 
+00011ba0: 7365 656e 293a 0a20 2020 2020 2020 2072  seen):.        r
+00011bb0: 6574 7572 6e20 6164 6428 2a5b 6465 7269  eturn add(*[deri
+00011bc0: 7661 7469 7665 2866 2c20 7661 722c 2073  vative(f, var, s
+00011bd0: 6565 6e29 2066 6f72 2066 2069 6e20 7365  een) for f in se
+00011be0: 6c66 2e5f 7465 726d 735d 290a 0a20 2020  lf._terms])..   
+00011bf0: 2064 6566 205f 7461 6b65 6469 6167 2873   def _takediag(s
+00011c00: 656c 662c 2061 7869 7331 2c20 6178 6973  elf, axis1, axis
+00011c10: 3229 3a0a 2020 2020 2020 2020 7265 7475  2):.        retu
+00011c20: 726e 2061 6464 282a 5b5f 7461 6b65 6469  rn add(*[_takedi
+00011c30: 6167 2866 2c20 6178 6973 312c 2061 7869  ag(f, axis1, axi
+00011c40: 7332 2920 666f 7220 6620 696e 2073 656c  s2) for f in sel
+00011c50: 662e 5f74 6572 6d73 5d29 0a0a 2020 2020  f._terms])..    
+00011c60: 6465 6620 5f74 616b 6528 7365 6c66 2c20  def _take(self, 
+00011c70: 696e 6465 782c 2061 7869 7329 3a0a 2020  index, axis):.  
+00011c80: 2020 2020 2020 7265 7475 726e 2061 6464        return add
+00011c90: 282a 5b5f 7461 6b65 2866 2c20 696e 6465  (*[_take(f, inde
+00011ca0: 782c 2061 7869 7329 2066 6f72 2066 2069  x, axis) for f i
+00011cb0: 6e20 7365 6c66 2e5f 7465 726d 735d 290a  n self._terms]).
+00011cc0: 0a20 2020 2064 6566 205f 756e 7261 7665  .    def _unrave
+00011cd0: 6c28 7365 6c66 2c20 6178 6973 2c20 7368  l(self, axis, sh
+00011ce0: 6170 6529 3a0a 2020 2020 2020 2020 7265  ape):.        re
+00011cf0: 7475 726e 2061 6464 282a 5b75 6e72 6176  turn add(*[unrav
+00011d00: 656c 2866 2c20 6178 6973 2c20 7368 6170  el(f, axis, shap
+00011d10: 6529 2066 6f72 2066 2069 6e20 7365 6c66  e) for f in self
+00011d20: 2e5f 7465 726d 735d 290a 0a20 2020 2064  ._terms])..    d
+00011d30: 6566 205f 6c6f 6f70 7375 6d28 7365 6c66  ef _loopsum(self
+00011d40: 2c20 696e 6465 7829 3a0a 2020 2020 2020  , index):.      
+00011d50: 2020 6465 7020 3d20 5b5d 0a20 2020 2020    dep = [].     
+00011d60: 2020 2069 6e64 6570 203d 205b 5d0a 2020     indep = [].  
+00011d70: 2020 2020 2020 666f 7220 6620 696e 2073        for f in s
+00011d80: 656c 662e 5f74 6572 6d73 3a0a 2020 2020  elf._terms:.    
+00011d90: 2020 2020 2020 2020 2864 6570 2069 6620          (dep if 
+00011da0: 696e 6465 7820 696e 2066 2e61 7267 756d  index in f.argum
+00011db0: 656e 7473 2065 6c73 6520 696e 6465 7029  ents else indep)
+00011dc0: 2e61 7070 656e 6428 6629 0a20 2020 2020  .append(f).     
+00011dd0: 2020 2069 6620 696e 6465 703a 0a20 2020     if indep:.   
+00011de0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00011df0: 6164 6428 2a69 6e64 6570 2920 2a20 696e  add(*indep) * in
+00011e00: 6465 782e 6c65 6e67 7468 202b 206c 6f6f  dex.length + loo
+00011e10: 705f 7375 6d28 6164 6428 2a64 6570 292c  p_sum(add(*dep),
+00011e20: 2069 6e64 6578 290a 0a20 2020 2064 6566   index)..    def
+00011e30: 205f 6d75 6c74 6970 6c79 2873 656c 662c   _multiply(self,
+00011e40: 206f 7468 6572 293a 0a20 2020 2020 2020   other):.       
+00011e50: 2066 5f6f 7468 6572 203d 205b 662e 5f6d   f_other = [f._m
+00011e60: 756c 7469 706c 7928 6f74 6865 7229 206f  ultiply(other) o
+00011e70: 7220 6f74 6865 722e 5f6d 756c 7469 706c  r other._multipl
+00011e80: 7928 6629 206f 7220 2866 2e5f 696e 666c  y(f) or (f._infl
+00011e90: 6174 696f 6e73 206f 7220 662e 5f64 6961  ations or f._dia
+00011ea0: 676f 6e61 6c73 2920 616e 6420 6620 2a20  gonals) and f * 
+00011eb0: 6f74 6865 7220 666f 7220 6620 696e 2073  other for f in s
+00011ec0: 656c 662e 5f74 6572 6d73 5d0a 2020 2020  elf._terms].    
+00011ed0: 2020 2020 6966 2061 6c6c 2866 5f6f 7468      if all(f_oth
+00011ee0: 6572 293a 0a20 2020 2020 2020 2020 2020  er):.           
+00011ef0: 2023 204e 4f54 453a 2041 7320 7468 6973   # NOTE: As this
+00011f00: 206f 7065 7261 7469 6f6e 2069 7320 7468   operation is th
+00011f10: 6520 7072 6563 6973 6520 6f70 706f 7369  e precise opposi
+00011f20: 7465 206f 6620 4d75 6c74 6970 6c79 2e5f  te of Multiply._
+00011f30: 6164 642c 2074 6865 7265 0a20 2020 2020  add, there.     
+00011f40: 2020 2020 2020 2023 2061 7070 6561 7273         # appears
+00011f50: 2074 6f20 6265 2061 2067 7265 6174 2072   to be a great r
+00011f60: 6973 6b20 6f66 2072 6563 7572 7369 6f6e  isk of recursion
+00011f70: 2e20 486f 7765 7665 722c 2073 696e 6365  . However, since
+00011f80: 2062 6f74 6820 6661 6374 6f72 730a 2020   both factors.  
+00011f90: 2020 2020 2020 2020 2020 2320 6172 6520            # are 
+00011fa0: 7370 6172 7365 2c20 7765 2063 616e 2062  sparse, we can b
+00011fb0: 6520 6365 7274 6169 6e20 7468 6174 2073  e certain that s
+00011fc0: 7562 7365 7175 656e 7420 7369 6d70 6966  ubsequent simpif
+00011fd0: 6963 6174 696f 6e73 2077 696c 6c0a 2020  ications will.  
+00011fe0: 2020 2020 2020 2020 2020 2320 6972 7265            # irre
+00011ff0: 7665 7273 6962 6c79 2070 726f 6365 7373  versibly process
+00012000: 2074 6865 206e 6577 2074 6572 6d73 2062   the new terms b
+00012010: 6566 6f72 6520 7265 6163 6869 6e67 2074  efore reaching t
+00012020: 6869 7320 706f 696e 742e 0a20 2020 2020  his point..     
+00012030: 2020 2020 2020 2072 6574 7572 6e20 6164         return ad
+00012040: 6428 2a66 5f6f 7468 6572 290a 0a20 2020  d(*f_other)..   
+00012050: 2040 6361 6368 6564 5f70 726f 7065 7274   @cached_propert
+00012060: 790a 2020 2020 6465 6620 5f61 7373 7061  y.    def _asspa
+00012070: 7273 6528 7365 6c66 293a 0a20 2020 2020  rse(self):.     
+00012080: 2020 2072 6574 7572 6e20 5f67 6174 6865     return _gathe
+00012090: 7273 7061 7273 6563 6875 6e6b 7328 6974  rsparsechunks(it
+000120a0: 6572 746f 6f6c 732e 6368 6169 6e28 2a5b  ertools.chain(*[
+000120b0: 662e 5f61 7373 7061 7273 6520 666f 7220  f._assparse for 
+000120c0: 6620 696e 2073 656c 662e 5f74 6572 6d73  f in self._terms
+000120d0: 5d29 290a 0a20 2020 2064 6566 205f 696e  ]))..    def _in
+000120e0: 7462 6f75 6e64 735f 696d 706c 2873 656c  tbounds_impl(sel
+000120f0: 6629 3a0a 2020 2020 2020 2020 6c6f 7765  f):.        lowe
+00012100: 7273 2c20 7570 7065 7273 203d 207a 6970  rs, uppers = zip
+00012110: 282a 5b66 2e5f 696e 7462 6f75 6e64 7320  (*[f._intbounds 
+00012120: 666f 7220 6620 696e 2073 656c 662e 5f74  for f in self._t
+00012130: 6572 6d73 5d29 0a20 2020 2020 2020 2072  erms]).        r
+00012140: 6574 7572 6e20 6275 696c 7469 6e73 2e73  eturn builtins.s
+00012150: 756d 286c 6f77 6572 7329 2c20 6275 696c  um(lowers), buil
+00012160: 7469 6e73 2e73 756d 2875 7070 6572 7329  tins.sum(uppers)
+00012170: 0a0a 0a63 6c61 7373 2045 696e 7375 6d28  ...class Einsum(
+00012180: 4172 7261 7929 3a0a 0a20 2020 2064 6566  Array):..    def
+00012190: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+000121a0: 6172 6773 3a20 7479 7069 6e67 2e54 7570  args: typing.Tup
+000121b0: 6c65 5b41 7272 6179 2c20 2e2e 2e5d 2c20  le[Array, ...], 
+000121c0: 6172 6773 5f69 6478 3a20 7479 7069 6e67  args_idx: typing
+000121d0: 2e54 7570 6c65 5b74 7970 696e 672e 5475  .Tuple[typing.Tu
+000121e0: 706c 655b 696e 742c 202e 2e2e 5d2c 202e  ple[int, ...], .
+000121f0: 2e2e 5d2c 206f 7574 5f69 6478 3a20 7479  ..], out_idx: ty
+00012200: 7069 6e67 2e54 7570 6c65 5b69 6e74 2c20  ping.Tuple[int, 
+00012210: 2e2e 2e5d 293a 0a20 2020 2020 2020 2061  ...]):.        a
+00012220: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00012230: 2861 7267 732c 2074 7570 6c65 2920 616e  (args, tuple) an
+00012240: 6420 616c 6c28 6973 696e 7374 616e 6365  d all(isinstance
+00012250: 2861 7267 2c20 4172 7261 7929 2066 6f72  (arg, Array) for
+00012260: 2061 7267 2069 6e20 6172 6773 292c 2066   arg in args), f
+00012270: 2761 7267 3d7b 6172 6721 727d 270a 2020  'arg={arg!r}'.  
+00012280: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+00012290: 6e73 7461 6e63 6528 6172 6773 5f69 6478  nstance(args_idx
+000122a0: 2c20 7475 706c 6529 2061 6e64 2061 6c6c  , tuple) and all
+000122b0: 2869 7369 6e73 7461 6e63 6528 6172 675f  (isinstance(arg_
+000122c0: 6964 782c 2074 7570 6c65 2920 616e 6420  idx, tuple) and 
+000122d0: 616c 6c28 6973 696e 7374 616e 6365 286e  all(isinstance(n
+000122e0: 2c20 696e 7429 2066 6f72 206e 2069 6e20  , int) for n in 
+000122f0: 6172 675f 6964 7829 2066 6f72 2061 7267  arg_idx) for arg
+00012300: 5f69 6478 2069 6e20 6172 6773 5f69 6478  _idx in args_idx
+00012310: 292c 2066 2761 7267 735f 6964 783d 7b61  ), f'args_idx={a
+00012320: 7267 735f 6964 7821 727d 270a 2020 2020  rgs_idx!r}'.    
+00012330: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+00012340: 7461 6e63 6528 6f75 745f 6964 782c 2074  tance(out_idx, t
+00012350: 7570 6c65 2920 616e 6420 616c 6c28 6973  uple) and all(is
+00012360: 696e 7374 616e 6365 286e 2c20 696e 7429  instance(n, int)
+00012370: 2066 6f72 206e 2069 6e20 6f75 745f 6964   for n in out_id
+00012380: 7829 2061 6e64 206c 656e 286f 7574 5f69  x) and len(out_i
+00012390: 6478 2920 3d3d 206c 656e 2873 6574 286f  dx) == len(set(o
+000123a0: 7574 5f69 6478 2929 2c20 6627 6f75 745f  ut_idx)), f'out_
+000123b0: 6964 783d 7b6f 7574 5f69 6478 2172 7d27  idx={out_idx!r}'
+000123c0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000123d0: 6c65 6e28 6172 6773 5f69 6478 2920 3d3d  len(args_idx) ==
+000123e0: 206c 656e 2861 7267 7329 2061 6e64 2061   len(args) and a
+000123f0: 6c6c 286c 656e 2869 6478 2920 3d3d 2061  ll(len(idx) == a
+00012400: 7267 2e6e 6469 6d20 666f 7220 6964 782c  rg.ndim for idx,
+00012410: 2061 7267 2069 6e20 7a69 7028 6172 6773   arg in zip(args
+00012420: 5f69 6478 2c20 6172 6773 2929 2c20 6627  _idx, args)), f'
+00012430: 6c65 6e28 6172 6773 5f69 6478 293d 7b6c  len(args_idx)={l
+00012440: 656e 2861 7267 735f 6964 7829 7d2c 206c  en(args_idx)}, l
+00012450: 656e 2861 7267 7329 3d7b 6c65 6e28 6172  en(args)={len(ar
+00012460: 6773 297d 270a 2020 2020 2020 2020 6474  gs)}'.        dt
+00012470: 7970 6520 3d20 6172 6773 5b30 5d2e 6474  ype = args[0].dt
+00012480: 7970 650a 2020 2020 2020 2020 6966 2064  ype.        if d
+00012490: 7479 7065 203d 3d20 626f 6f6c 206f 7220  type == bool or 
+000124a0: 616e 7928 6172 672e 6474 7970 6520 213d  any(arg.dtype !=
+000124b0: 2064 7479 7065 2066 6f72 2061 7267 2069   dtype for arg i
+000124c0: 6e20 6172 6773 5b31 3a5d 293a 0a20 2020  n args[1:]):.   
+000124d0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+000124e0: 616c 7565 4572 726f 7228 2749 6e63 6f6e  alueError('Incon
+000124f0: 7369 7374 656e 7420 6f72 2069 6e76 616c  sistent or inval
+00012500: 6964 2064 7479 7065 732e 2729 0a20 2020  id dtypes.').   
+00012510: 2020 2020 206c 656e 6774 6873 203d 207b       lengths = {
+00012520: 7d0a 2020 2020 2020 2020 666f 7220 6964  }.        for id
+00012530: 782c 2061 7267 2069 6e20 7a69 7028 6172  x, arg in zip(ar
+00012540: 6773 5f69 6478 2c20 6172 6773 293a 0a20  gs_idx, args):. 
+00012550: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+00012560: 2c20 6c65 6e67 7468 2069 6e20 7a69 7028  , length in zip(
+00012570: 6964 782c 2061 7267 2e73 6861 7065 293a  idx, arg.shape):
+00012580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012590: 2069 6620 6920 6e6f 7420 696e 206c 656e   if i not in len
+000125a0: 6774 6873 3a0a 2020 2020 2020 2020 2020  gths:.          
+000125b0: 2020 2020 2020 2020 2020 6c65 6e67 7468            length
+000125c0: 735b 695d 203d 206c 656e 6774 680a 2020  s[i] = length.  
+000125d0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000125e0: 6966 206e 6f74 205f 6571 7561 6c73 5f73  if not _equals_s
+000125f0: 696d 706c 6966 6965 6428 6c65 6e67 7468  implified(length
+00012600: 735b 695d 2c20 6c65 6e67 7468 293a 0a20  s[i], length):. 
+00012610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012620: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00012630: 726f 7228 2741 7865 7320 7769 7468 2069  ror('Axes with i
+00012640: 6e64 6578 207b 7d20 6861 7665 2064 6966  ndex {} have dif
+00012650: 6665 7265 6e74 206c 656e 6774 6873 2e27  ferent lengths.'
+00012660: 2e66 6f72 6d61 7428 6929 290a 2020 2020  .format(i)).    
+00012670: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00012680: 2020 2020 2073 6861 7065 203d 2074 7570       shape = tup
+00012690: 6c65 286c 656e 6774 6873 5b69 5d20 666f  le(lengths[i] fo
+000126a0: 7220 6920 696e 206f 7574 5f69 6478 290a  r i in out_idx).
+000126b0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+000126c0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+000126d0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+000126e0: 4572 726f 7228 274f 7574 7075 7420 6178  Error('Output ax
+000126f0: 6973 207b 7d20 6973 206e 6f74 206c 6973  is {} is not lis
+00012700: 7465 6420 696e 2061 6e79 206f 6620 7468  ted in any of th
+00012710: 6520 6172 6775 6d65 6e74 732e 272e 666f  e arguments.'.fo
+00012720: 726d 6174 2827 2c20 272e 6a6f 696e 2869  rmat(', '.join(i
+00012730: 2066 6f72 2069 2069 6e20 6f75 745f 6964   for i in out_id
+00012740: 7820 6966 2069 206e 6f74 2069 6e20 6c65  x if i not in le
+00012750: 6e67 7468 7329 2929 0a20 2020 2020 2020  ngths))).       
+00012760: 2073 656c 662e 6172 6773 203d 2061 7267   self.args = arg
+00012770: 730a 2020 2020 2020 2020 7365 6c66 2e61  s.        self.a
+00012780: 7267 735f 6964 7820 3d20 6172 6773 5f69  rgs_idx = args_i
+00012790: 6478 0a20 2020 2020 2020 2073 656c 662e  dx.        self.
+000127a0: 6f75 745f 6964 7820 3d20 6f75 745f 6964  out_idx = out_id
+000127b0: 780a 2020 2020 2020 2020 7365 6c66 2e5f  x.        self._
+000127c0: 6569 6e73 756d 666d 7420 3d20 272c 272e  einsumfmt = ','.
+000127d0: 6a6f 696e 2827 272e 6a6f 696e 2863 6872  join(''.join(chr
+000127e0: 2839 372b 6929 2066 6f72 2069 2069 6e20  (97+i) for i in 
+000127f0: 6964 7829 2066 6f72 2069 6478 2069 6e20  idx) for idx in 
+00012800: 6172 6773 5f69 6478 2920 2b20 272d 3e27  args_idx) + '->'
+00012810: 202b 2027 272e 6a6f 696e 2863 6872 2839   + ''.join(chr(9
+00012820: 372b 6929 2066 6f72 2069 2069 6e20 6f75  7+i) for i in ou
+00012830: 745f 6964 7829 0a20 2020 2020 2020 2073  t_idx).        s
+00012840: 656c 662e 5f68 6173 5f73 756d 6d65 645f  elf._has_summed_
+00012850: 6178 6573 203d 206c 656e 286c 656e 6774  axes = len(lengt
+00012860: 6873 2920 3e20 6c65 6e28 6f75 745f 6964  hs) > len(out_id
+00012870: 7829 0a20 2020 2020 2020 2073 7570 6572  x).        super
+00012880: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
+00012890: 3d73 656c 662e 6172 6773 2c20 7368 6170  =self.args, shap
+000128a0: 653d 7368 6170 652c 2064 7479 7065 3d64  e=shape, dtype=d
+000128b0: 7479 7065 290a 0a20 2020 2064 6566 2065  type)..    def e
+000128c0: 7661 6c66 2873 656c 662c 202a 6172 6773  valf(self, *args
+000128d0: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
+000128e0: 6c66 2e5f 6861 735f 7375 6d6d 6564 5f61  lf._has_summed_a
+000128f0: 7865 733a 0a20 2020 2020 2020 2020 2020  xes:.           
+00012900: 2061 7267 7320 3d20 7475 706c 6528 6e75   args = tuple(nu
+00012910: 6d70 792e 6173 6172 7261 7928 6172 672c  mpy.asarray(arg,
+00012920: 206f 7264 6572 3d27 4627 2920 666f 7220   order='F') for 
+00012930: 6172 6720 696e 2061 7267 7329 0a20 2020  arg in args).   
+00012940: 2020 2020 2072 6574 7572 6e20 6e75 6d70       return nump
+00012950: 792e 636f 7265 2e6d 756c 7469 6172 7261  y.core.multiarra
+00012960: 792e 635f 6569 6e73 756d 2873 656c 662e  y.c_einsum(self.
+00012970: 5f65 696e 7375 6d66 6d74 2c20 2a61 7267  _einsumfmt, *arg
+00012980: 7329 0a0a 2020 2020 4070 726f 7065 7274  s)..    @propert
+00012990: 790a 2020 2020 6465 6620 5f6e 6f64 655f  y.    def _node_
+000129a0: 6465 7461 696c 7328 7365 6c66 293a 0a20  details(self):. 
+000129b0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000129c0: 6c66 2e5f 6569 6e73 756d 666d 740a 0a20  lf._einsumfmt.. 
+000129d0: 2020 2064 6566 205f 7369 6d70 6c69 6669     def _simplifi
+000129e0: 6564 2873 656c 6629 3a0a 2020 2020 2020  ed(self):.      
+000129f0: 2020 666f 7220 692c 2061 7267 2069 6e20    for i, arg in 
+00012a00: 656e 756d 6572 6174 6528 7365 6c66 2e61  enumerate(self.a
+00012a10: 7267 7329 3a0a 2020 2020 2020 2020 2020  rgs):.          
+00012a20: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00012a30: 6172 672c 2054 7261 6e73 706f 7365 293a  arg, Transpose):
+00012a40: 2020 2320 6162 736f 7262 2060 5472 616e    # absorb `Tran
+00012a50: 7370 6f73 6560 0a20 2020 2020 2020 2020  spose`.         
+00012a60: 2020 2020 2020 2069 6478 203d 2074 7570         idx = tup
+00012a70: 6c65 286d 6170 2873 656c 662e 6172 6773  le(map(self.args
+00012a80: 5f69 6478 5b69 5d2e 5f5f 6765 7469 7465  _idx[i].__getite
+00012a90: 6d5f 5f2c 206e 756d 7079 2e61 7267 736f  m__, numpy.argso
+00012aa0: 7274 2861 7267 2e61 7865 7329 2929 0a20  rt(arg.axes))). 
+00012ab0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00012ac0: 6574 7572 6e20 4569 6e73 756d 2873 656c  eturn Einsum(sel
+00012ad0: 662e 6172 6773 5b3a 695d 2b28 6172 672e  f.args[:i]+(arg.
+00012ae0: 6675 6e63 2c29 2b73 656c 662e 6172 6773  func,)+self.args
+00012af0: 5b69 2b31 3a5d 2c20 7365 6c66 2e61 7267  [i+1:], self.arg
+00012b00: 735f 6964 785b 3a69 5d2b 2869 6478 2c29  s_idx[:i]+(idx,)
+00012b10: 2b73 656c 662e 6172 6773 5f69 6478 5b69  +self.args_idx[i
+00012b20: 2b31 3a5d 2c20 7365 6c66 2e6f 7574 5f69  +1:], self.out_i
+00012b30: 6478 290a 0a20 2020 2064 6566 205f 7375  dx)..    def _su
+00012b40: 6d28 7365 6c66 2c20 6178 6973 293a 0a20  m(self, axis):. 
+00012b50: 2020 2020 2020 2069 6620 6e6f 7420 2830         if not (0
+00012b60: 203c 3d20 6178 6973 203c 2073 656c 662e   <= axis < self.
+00012b70: 6e64 696d 293a 0a20 2020 2020 2020 2020  ndim):.         
+00012b80: 2020 2072 6169 7365 2049 6e64 6578 4572     raise IndexEr
+00012b90: 726f 7228 2741 7869 7320 6f75 7420 6f66  ror('Axis out of
+00012ba0: 2072 616e 6765 2e27 290a 2020 2020 2020   range.').      
+00012bb0: 2020 7265 7475 726e 2045 696e 7375 6d28    return Einsum(
+00012bc0: 7365 6c66 2e61 7267 732c 2073 656c 662e  self.args, self.
+00012bd0: 6172 6773 5f69 6478 2c20 7365 6c66 2e6f  args_idx, self.o
+00012be0: 7574 5f69 6478 5b3a 6178 6973 5d20 2b20  ut_idx[:axis] + 
+00012bf0: 7365 6c66 2e6f 7574 5f69 6478 5b61 7869  self.out_idx[axi
+00012c00: 732b 313a 5d29 0a0a 2020 2020 6465 6620  s+1:])..    def 
+00012c10: 5f74 616b 6564 6961 6728 7365 6c66 2c20  _takediag(self, 
+00012c20: 6178 6973 312c 2061 7869 7332 293a 0a20  axis1, axis2):. 
+00012c30: 2020 2020 2020 2069 6620 6e6f 7420 2830         if not (0
+00012c40: 203c 3d20 6178 6973 3120 3c20 6178 6973   <= axis1 < axis
+00012c50: 3220 3c20 7365 6c66 2e6e 6469 6d29 3a0a  2 < self.ndim):.
+00012c60: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00012c70: 6520 496e 6465 7845 7272 6f72 2827 4178  e IndexError('Ax
+00012c80: 6973 206f 7574 206f 6620 7261 6e67 652e  is out of range.
+00012c90: 2729 0a20 2020 2020 2020 2069 6b65 6570  ').        ikeep
+00012ca0: 2c20 6972 6d20 3d20 7365 6c66 2e6f 7574  , irm = self.out
+00012cb0: 5f69 6478 5b61 7869 7331 5d2c 2073 656c  _idx[axis1], sel
+00012cc0: 662e 6f75 745f 6964 785b 6178 6973 325d  f.out_idx[axis2]
+00012cd0: 0a20 2020 2020 2020 2061 7267 735f 6964  .        args_id
+00012ce0: 7820 3d20 7475 706c 6528 7475 706c 6528  x = tuple(tuple(
+00012cf0: 696b 6565 7020 6966 2069 203d 3d20 6972  ikeep if i == ir
+00012d00: 6d20 656c 7365 2069 2066 6f72 2069 2069  m else i for i i
+00012d10: 6e20 6964 7829 2066 6f72 2069 6478 2069  n idx) for idx i
+00012d20: 6e20 7365 6c66 2e61 7267 735f 6964 7829  n self.args_idx)
+00012d30: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00012d40: 4569 6e73 756d 2873 656c 662e 6172 6773  Einsum(self.args
+00012d50: 2c20 6172 6773 5f69 6478 2c20 7365 6c66  , args_idx, self
+00012d60: 2e6f 7574 5f69 6478 5b3a 6178 6973 315d  .out_idx[:axis1]
+00012d70: 202b 2073 656c 662e 6f75 745f 6964 785b   + self.out_idx[
+00012d80: 6178 6973 312b 313a 6178 6973 325d 202b  axis1+1:axis2] +
+00012d90: 2073 656c 662e 6f75 745f 6964 785b 6178   self.out_idx[ax
+00012da0: 6973 322b 313a 5d20 2b20 2869 6b65 6570  is2+1:] + (ikeep
+00012db0: 2c29 290a 0a0a 636c 6173 7320 5375 6d28  ,))...class Sum(
+00012dc0: 4172 7261 7929 3a0a 0a20 2020 2064 6566  Array):..    def
+00012dd0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00012de0: 6675 6e63 3a20 4172 7261 7929 3a0a 2020  func: Array):.  
+00012df0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+00012e00: 6e73 7461 6e63 6528 6675 6e63 2c20 4172  nstance(func, Ar
+00012e10: 7261 7929 2c20 6627 6675 6e63 3d7b 6675  ray), f'func={fu
+00012e20: 6e63 2172 7d27 0a20 2020 2020 2020 2061  nc!r}'.        a
+00012e30: 7373 6572 7420 6675 6e63 2e64 7479 7065  ssert func.dtype
+00012e40: 2021 3d20 626f 6f6c 2c20 2753 756d 287b   != bool, 'Sum({
+00012e50: 7d29 272e 666f 726d 6174 2866 756e 6329  })'.format(func)
+00012e60: 0a20 2020 2020 2020 2073 656c 662e 6675  .        self.fu
+00012e70: 6e63 203d 2066 756e 630a 2020 2020 2020  nc = func.      
+00012e80: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00012e90: 5f5f 2861 7267 733d 2866 756e 632c 292c  __(args=(func,),
+00012ea0: 2073 6861 7065 3d66 756e 632e 7368 6170   shape=func.shap
+00012eb0: 655b 3a2d 315d 2c20 6474 7970 653d 6675  e[:-1], dtype=fu
+00012ec0: 6e63 2e64 7479 7065 290a 0a20 2020 2064  nc.dtype)..    d
+00012ed0: 6566 205f 7369 6d70 6c69 6669 6564 2873  ef _simplified(s
+00012ee0: 656c 6629 3a0a 2020 2020 2020 2020 6966  elf):.        if
+00012ef0: 205f 6571 7561 6c73 5f73 6361 6c61 725f   _equals_scalar_
+00012f00: 636f 6e73 7461 6e74 2873 656c 662e 6675  constant(self.fu
+00012f10: 6e63 2e73 6861 7065 5b2d 315d 2c20 3129  nc.shape[-1], 1)
+00012f20: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00012f30: 7475 726e 2054 616b 6528 7365 6c66 2e66  turn Take(self.f
+00012f40: 756e 632c 2063 6f6e 7374 616e 7428 3029  unc, constant(0)
+00012f50: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00012f60: 2073 656c 662e 6675 6e63 2e5f 7375 6d28   self.func._sum(
+00012f70: 7365 6c66 2e6e 6469 6d29 0a0a 2020 2020  self.ndim)..    
+00012f80: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+00012f90: 2020 6465 6620 6576 616c 6628 6172 7229    def evalf(arr)
+00012fa0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00012fb0: 206e 756d 7079 2e73 756d 2861 7272 2c20   numpy.sum(arr, 
+00012fc0: 2d31 290a 0a20 2020 2064 6566 205f 7375  -1)..    def _su
+00012fd0: 6d28 7365 6c66 2c20 6178 6973 293a 0a20  m(self, axis):. 
+00012fe0: 2020 2020 2020 2074 7279 7375 6d20 3d20         trysum = 
+00012ff0: 7365 6c66 2e66 756e 632e 5f73 756d 2861  self.func._sum(a
+00013000: 7869 7329 0a20 2020 2020 2020 2069 6620  xis).        if 
+00013010: 7472 7973 756d 2069 7320 6e6f 7420 4e6f  trysum is not No
+00013020: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00013030: 7265 7475 726e 2053 756d 2874 7279 7375  return Sum(trysu
+00013040: 6d29 0a0a 2020 2020 6465 6620 5f64 6572  m)..    def _der
+00013050: 6976 6174 6976 6528 7365 6c66 2c20 7661  ivative(self, va
+00013060: 722c 2073 6565 6e29 3a0a 2020 2020 2020  r, seen):.      
+00013070: 2020 7265 7475 726e 2073 756d 2864 6572    return sum(der
+00013080: 6976 6174 6976 6528 7365 6c66 2e66 756e  ivative(self.fun
+00013090: 632c 2076 6172 2c20 7365 656e 292c 2073  c, var, seen), s
+000130a0: 656c 662e 6e64 696d 290a 0a20 2020 2040  elf.ndim)..    @
+000130b0: 6361 6368 6564 5f70 726f 7065 7274 790a  cached_property.
+000130c0: 2020 2020 6465 6620 5f61 7373 7061 7273      def _asspars
+000130d0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+000130e0: 2063 6875 6e6b 7320 3d20 5b5d 0a20 2020   chunks = [].   
+000130f0: 2020 2020 2066 6f72 202a 696e 6469 6365       for *indice
+00013100: 732c 205f 726d 6964 782c 2076 616c 7565  s, _rmidx, value
+00013110: 7320 696e 2073 656c 662e 6675 6e63 2e5f  s in self.func._
+00013120: 6173 7370 6172 7365 3a0a 2020 2020 2020  assparse:.      
+00013130: 2020 2020 2020 6966 2073 656c 662e 6e64        if self.nd
+00013140: 696d 203d 3d20 303a 0a20 2020 2020 2020  im == 0:.       
+00013150: 2020 2020 2020 2020 206e 7375 6d20 3d20           nsum = 
+00013160: 7661 6c75 6573 2e6e 6469 6d0a 2020 2020  values.ndim.    
+00013170: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00013180: 2020 2020 2020 2020 2020 2020 2020 2a69                *i
+00013190: 6e64 6963 6573 2c20 7768 6572 6520 3d20  ndices, where = 
+000131a0: 756e 616c 6967 6e28 2a69 6e64 6963 6573  unalign(*indices
+000131b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000131c0: 2020 7661 6c75 6573 203d 2074 7261 6e73    values = trans
+000131d0: 706f 7365 2876 616c 7565 732c 2077 6865  pose(values, whe
+000131e0: 7265 202b 2074 7570 6c65 2869 2066 6f72  re + tuple(i for
+000131f0: 2069 2069 6e20 7261 6e67 6528 7661 6c75   i in range(valu
+00013200: 6573 2e6e 6469 6d29 2069 6620 6920 6e6f  es.ndim) if i no
+00013210: 7420 696e 2077 6865 7265 2929 0a20 2020  t in where)).   
+00013220: 2020 2020 2020 2020 2020 2020 206e 7375               nsu
+00013230: 6d20 3d20 7661 6c75 6573 2e6e 6469 6d20  m = values.ndim 
+00013240: 2d20 6c65 6e28 7768 6572 6529 0a20 2020  - len(where).   
+00013250: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
+00013260: 6e20 7261 6e67 6528 6e73 756d 293a 0a20  n range(nsum):. 
+00013270: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+00013280: 616c 7565 7320 3d20 5375 6d28 7661 6c75  alues = Sum(valu
+00013290: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+000132a0: 6368 756e 6b73 2e61 7070 656e 6428 282a  chunks.append((*
+000132b0: 696e 6469 6365 732c 2076 616c 7565 7329  indices, values)
+000132c0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+000132d0: 205f 6761 7468 6572 7370 6172 7365 6368   _gathersparsech
+000132e0: 756e 6b73 2863 6875 6e6b 7329 0a0a 2020  unks(chunks)..  
+000132f0: 2020 6465 6620 5f69 6e74 626f 756e 6473    def _intbounds
+00013300: 5f69 6d70 6c28 7365 6c66 293a 0a20 2020  _impl(self):.   
+00013310: 2020 2020 206c 6f77 6572 5f66 756e 632c       lower_func,
+00013320: 2075 7070 6572 5f66 756e 6320 3d20 7365   upper_func = se
+00013330: 6c66 2e66 756e 632e 5f69 6e74 626f 756e  lf.func._intboun
+00013340: 6473 0a20 2020 2020 2020 206c 6f77 6572  ds.        lower
+00013350: 5f6c 656e 6774 682c 2075 7070 6572 5f6c  _length, upper_l
+00013360: 656e 6774 6820 3d20 7365 6c66 2e66 756e  ength = self.fun
+00013370: 632e 7368 6170 655b 2d31 5d2e 5f69 6e74  c.shape[-1]._int
+00013380: 626f 756e 6473 0a20 2020 2020 2020 2069  bounds.        i
+00013390: 6620 7570 7065 725f 6c65 6e67 7468 203d  f upper_length =
+000133a0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+000133b0: 2072 6574 7572 6e20 302c 2030 0a20 2020   return 0, 0.   
+000133c0: 2020 2020 2065 6c69 6620 6c6f 7765 725f       elif lower_
+000133d0: 6c65 6e67 7468 203d 3d20 303a 0a20 2020  length == 0:.   
+000133e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000133f0: 6d69 6e28 302c 206c 6f77 6572 5f66 756e  min(0, lower_fun
 00013400: 6320 2a20 7570 7065 725f 6c65 6e67 7468  c * upper_length
-00013410: 290a 0a0a 636c 6173 7320 5461 6b65 4469  )...class TakeDi
-00013420: 6167 2841 7272 6179 293a 0a0a 2020 2020  ag(Array):..    
-00013430: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-00013440: 662c 2066 756e 633a 2041 7272 6179 293a  f, func: Array):
-00013450: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00013460: 6973 696e 7374 616e 6365 2866 756e 632c  isinstance(func,
-00013470: 2041 7272 6179 2920 616e 6420 6675 6e63   Array) and func
-00013480: 2e6e 6469 6d20 3e3d 2032 2061 6e64 205f  .ndim >= 2 and _
-00013490: 6571 7561 6c73 5f73 696d 706c 6966 6965  equals_simplifie
-000134a0: 6428 2a66 756e 632e 7368 6170 655b 2d32  d(*func.shape[-2
-000134b0: 3a5d 292c 2066 2766 756e 633d 7b66 756e  :]), f'func={fun
-000134c0: 6321 727d 270a 2020 2020 2020 2020 7365  c!r}'.        se
-000134d0: 6c66 2e66 756e 6320 3d20 6675 6e63 0a20  lf.func = func. 
-000134e0: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
-000134f0: 5f69 6e69 745f 5f28 6172 6773 3d28 6675  _init__(args=(fu
-00013500: 6e63 2c29 2c20 7368 6170 653d 6675 6e63  nc,), shape=func
-00013510: 2e73 6861 7065 5b3a 2d31 5d2c 2064 7479  .shape[:-1], dty
-00013520: 7065 3d66 756e 632e 6474 7970 6529 0a0a  pe=func.dtype)..
-00013530: 2020 2020 6465 6620 5f73 696d 706c 6966      def _simplif
-00013540: 6965 6428 7365 6c66 293a 0a20 2020 2020  ied(self):.     
-00013550: 2020 2069 6620 5f65 7175 616c 735f 7363     if _equals_sc
-00013560: 616c 6172 5f63 6f6e 7374 616e 7428 7365  alar_constant(se
-00013570: 6c66 2e73 6861 7065 5b2d 315d 2c20 3129  lf.shape[-1], 1)
-00013580: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00013590: 7475 726e 2054 616b 6528 7365 6c66 2e66  turn Take(self.f
-000135a0: 756e 632c 2063 6f6e 7374 616e 7428 3029  unc, constant(0)
-000135b0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000135c0: 2073 656c 662e 6675 6e63 2e5f 7461 6b65   self.func._take
-000135d0: 6469 6167 2873 656c 662e 6e64 696d 2d31  diag(self.ndim-1
-000135e0: 2c20 7365 6c66 2e6e 6469 6d29 0a0a 2020  , self.ndim)..  
-000135f0: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
-00013600: 2020 2020 6465 6620 6576 616c 6628 6172      def evalf(ar
-00013610: 7229 3a0a 2020 2020 2020 2020 7265 7475  r):.        retu
-00013620: 726e 206e 756d 7079 2e65 696e 7375 6d28  rn numpy.einsum(
-00013630: 272e 2e2e 6b6b 2d3e 2e2e 2e6b 272c 2061  '...kk->...k', a
-00013640: 7272 2c20 6f70 7469 6d69 7a65 3d46 616c  rr, optimize=Fal
-00013650: 7365 290a 0a20 2020 2064 6566 205f 6465  se)..    def _de
-00013660: 7269 7661 7469 7665 2873 656c 662c 2076  rivative(self, v
-00013670: 6172 2c20 7365 656e 293a 0a20 2020 2020  ar, seen):.     
-00013680: 2020 2072 6574 7572 6e20 7461 6b65 6469     return takedi
-00013690: 6167 2864 6572 6976 6174 6976 6528 7365  ag(derivative(se
-000136a0: 6c66 2e66 756e 632c 2076 6172 2c20 7365  lf.func, var, se
-000136b0: 656e 292c 2073 656c 662e 6e64 696d 2d31  en), self.ndim-1
-000136c0: 2c20 7365 6c66 2e6e 6469 6d29 0a0a 2020  , self.ndim)..  
-000136d0: 2020 6465 6620 5f74 616b 6528 7365 6c66    def _take(self
-000136e0: 2c20 696e 6465 782c 2061 7869 7329 3a0a  , index, axis):.
-000136f0: 2020 2020 2020 2020 6966 2061 7869 7320          if axis 
-00013700: 3c20 7365 6c66 2e6e 6469 6d20 2d20 313a  < self.ndim - 1:
-00013710: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00013720: 7572 6e20 5461 6b65 4469 6167 285f 7461  urn TakeDiag(_ta
-00013730: 6b65 2873 656c 662e 6675 6e63 2c20 696e  ke(self.func, in
-00013740: 6465 782c 2061 7869 7329 290a 2020 2020  dex, axis)).    
-00013750: 2020 2020 6675 6e63 203d 205f 7461 6b65      func = _take
-00013760: 2854 616b 6528 7365 6c66 2e66 756e 632c  (Take(self.func,
-00013770: 2069 6e64 6578 292c 2069 6e64 6578 2c20   index), index, 
-00013780: 7365 6c66 2e6e 6469 6d2d 3129 0a20 2020  self.ndim-1).   
-00013790: 2020 2020 2066 6f72 2069 2069 6e20 7265       for i in re
-000137a0: 7665 7273 6564 2872 616e 6765 2873 656c  versed(range(sel
-000137b0: 662e 6e64 696d 2d31 2c20 7365 6c66 2e6e  f.ndim-1, self.n
-000137c0: 6469 6d2d 312b 696e 6465 782e 6e64 696d  dim-1+index.ndim
-000137d0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-000137e0: 6675 6e63 203d 2074 616b 6564 6961 6728  func = takediag(
-000137f0: 6675 6e63 2c20 692c 2069 2b69 6e64 6578  func, i, i+index
-00013800: 2e6e 6469 6d29 0a20 2020 2020 2020 2072  .ndim).        r
-00013810: 6574 7572 6e20 6675 6e63 0a0a 2020 2020  eturn func..    
-00013820: 6465 6620 5f73 756d 2873 656c 662c 2061  def _sum(self, a
-00013830: 7869 7329 3a0a 2020 2020 2020 2020 6966  xis):.        if
-00013840: 2061 7869 7320 213d 2073 656c 662e 6e64   axis != self.nd
-00013850: 696d 202d 2031 3a0a 2020 2020 2020 2020  im - 1:.        
-00013860: 2020 2020 7265 7475 726e 2054 616b 6544      return TakeD
-00013870: 6961 6728 7375 6d28 7365 6c66 2e66 756e  iag(sum(self.fun
-00013880: 632c 2061 7869 7329 290a 0a20 2020 2064  c, axis))..    d
-00013890: 6566 205f 696e 7462 6f75 6e64 735f 696d  ef _intbounds_im
-000138a0: 706c 2873 656c 6629 3a0a 2020 2020 2020  pl(self):.      
-000138b0: 2020 7265 7475 726e 2073 656c 662e 6675    return self.fu
-000138c0: 6e63 2e5f 696e 7462 6f75 6e64 730a 0a0a  nc._intbounds...
-000138d0: 636c 6173 7320 5461 6b65 2841 7272 6179  class Take(Array
-000138e0: 293a 0a0a 2020 2020 6465 6620 5f5f 696e  ):..    def __in
-000138f0: 6974 5f5f 2873 656c 662c 2066 756e 633a  it__(self, func:
-00013900: 2041 7272 6179 2c20 696e 6469 6365 733a   Array, indices:
-00013910: 2041 7272 6179 293a 0a20 2020 2020 2020   Array):.       
-00013920: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00013930: 6365 2866 756e 632c 2041 7272 6179 2920  ce(func, Array) 
-00013940: 616e 6420 6675 6e63 2e6e 6469 6d20 3e20  and func.ndim > 
-00013950: 302c 2066 2766 756e 633d 7b66 756e 6321  0, f'func={func!
-00013960: 727d 270a 2020 2020 2020 2020 6173 7365  r}'.        asse
-00013970: 7274 2069 7369 6e73 7461 6e63 6528 696e  rt isinstance(in
-00013980: 6469 6365 732c 2041 7272 6179 2920 616e  dices, Array) an
-00013990: 6420 696e 6469 6365 732e 6474 7970 6520  d indices.dtype 
-000139a0: 3d3d 2069 6e74 2c20 6627 696e 6469 6365  == int, f'indice
-000139b0: 733d 7b69 6e64 6963 6573 2172 7d27 0a20  s={indices!r}'. 
-000139c0: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
-000139d0: 203d 2066 756e 630a 2020 2020 2020 2020   = func.        
-000139e0: 7365 6c66 2e69 6e64 6963 6573 203d 2069  self.indices = i
-000139f0: 6e64 6963 6573 0a20 2020 2020 2020 2073  ndices.        s
-00013a00: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
-00013a10: 6172 6773 3d28 6675 6e63 2c20 696e 6469  args=(func, indi
-00013a20: 6365 7329 2c20 7368 6170 653d 6675 6e63  ces), shape=func
-00013a30: 2e73 6861 7065 5b3a 2d31 5d2b 696e 6469  .shape[:-1]+indi
-00013a40: 6365 732e 7368 6170 652c 2064 7479 7065  ces.shape, dtype
-00013a50: 3d66 756e 632e 6474 7970 6529 0a0a 2020  =func.dtype)..  
-00013a60: 2020 6465 6620 5f73 696d 706c 6966 6965    def _simplifie
-00013a70: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-00013a80: 2069 6620 616e 7928 6973 7a65 726f 286e   if any(iszero(n
-00013a90: 2920 666f 7220 6e20 696e 2073 656c 662e  ) for n in self.
-00013aa0: 696e 6469 6365 732e 7368 6170 6529 3a0a  indices.shape):.
-00013ab0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00013ac0: 726e 207a 6572 6f73 5f6c 696b 6528 7365  rn zeros_like(se
-00013ad0: 6c66 290a 2020 2020 2020 2020 756e 616c  lf).        unal
-00013ae0: 6967 6e65 642c 2077 6865 7265 203d 2075  igned, where = u
-00013af0: 6e61 6c69 676e 2873 656c 662e 696e 6469  nalign(self.indi
-00013b00: 6365 7329 0a20 2020 2020 2020 2069 6620  ces).        if 
-00013b10: 6c65 6e28 7768 6572 6529 203c 2073 656c  len(where) < sel
-00013b20: 662e 696e 6469 6365 732e 6e64 696d 3a0a  f.indices.ndim:.
-00013b30: 2020 2020 2020 2020 2020 2020 6e20 3d20              n = 
-00013b40: 7365 6c66 2e66 756e 632e 6e64 696d 2d31  self.func.ndim-1
-00013b50: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00013b60: 7572 6e20 616c 6967 6e28 5461 6b65 2873  urn align(Take(s
-00013b70: 656c 662e 6675 6e63 2c20 756e 616c 6967  elf.func, unalig
-00013b80: 6e65 6429 2c20 282a 7261 6e67 6528 6e29  ned), (*range(n)
-00013b90: 2c20 2a28 6e2b 6920 666f 7220 6920 696e  , *(n+i for i in
-00013ba0: 2077 6865 7265 2929 2c20 7365 6c66 2e73   where)), self.s
-00013bb0: 6861 7065 290a 2020 2020 2020 2020 7472  hape).        tr
-00013bc0: 7974 616b 6520 3d20 7365 6c66 2e66 756e  ytake = self.fun
-00013bd0: 632e 5f74 616b 6528 7365 6c66 2e69 6e64  c._take(self.ind
-00013be0: 6963 6573 2c20 7365 6c66 2e66 756e 632e  ices, self.func.
-00013bf0: 6e64 696d 2d31 2920 6f72 205c 0a20 2020  ndim-1) or \.   
-00013c00: 2020 2020 2020 2020 2073 656c 662e 696e           self.in
-00013c10: 6469 6365 732e 5f72 7461 6b65 2873 656c  dices._rtake(sel
-00013c20: 662e 6675 6e63 2c20 7365 6c66 2e66 756e  f.func, self.fun
-00013c30: 632e 6e64 696d 2d31 290a 2020 2020 2020  c.ndim-1).      
-00013c40: 2020 6966 2074 7279 7461 6b65 3a0a 2020    if trytake:.  
-00013c50: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00013c60: 2074 7279 7461 6b65 0a20 2020 2020 2020   trytake.       
-00013c70: 2066 6f72 2061 7869 732c 2070 6172 7473   for axis, parts
-00013c80: 2069 6e20 7365 6c66 2e66 756e 632e 5f69   in self.func._i
-00013c90: 6e66 6c61 7469 6f6e 733a 0a20 2020 2020  nflations:.     
-00013ca0: 2020 2020 2020 2069 6620 6178 6973 203d         if axis =
-00013cb0: 3d20 7365 6c66 2e66 756e 632e 6e64 696d  = self.func.ndim
-00013cc0: 202d 2031 3a0a 2020 2020 2020 2020 2020   - 1:.          
-00013cd0: 2020 2020 2020 7265 7475 726e 2075 7469        return uti
-00013ce0: 6c2e 7375 6d28 496e 666c 6174 6528 6675  l.sum(Inflate(fu
-00013cf0: 6e63 2c20 646f 666d 6170 2c20 7365 6c66  nc, dofmap, self
-00013d00: 2e66 756e 632e 7368 6170 655b 2d31 5d29  .func.shape[-1])
-00013d10: 2e5f 7461 6b65 2873 656c 662e 696e 6469  ._take(self.indi
-00013d20: 6365 732c 2073 656c 662e 6675 6e63 2e6e  ces, self.func.n
-00013d30: 6469 6d20 2d20 3129 2066 6f72 2064 6f66  dim - 1) for dof
-00013d40: 6d61 702c 2066 756e 6320 696e 2070 6172  map, func in par
-00013d50: 7473 2e69 7465 6d73 2829 290a 0a20 2020  ts.items())..   
-00013d60: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-00013d70: 2020 2064 6566 2065 7661 6c66 2861 7272     def evalf(arr
-00013d80: 2c20 696e 6469 6365 7329 3a0a 2020 2020  , indices):.    
-00013d90: 2020 2020 7265 7475 726e 2061 7272 5b2e      return arr[.
-00013da0: 2e2e 2c20 696e 6469 6365 735d 0a0a 2020  .., indices]..  
-00013db0: 2020 6465 6620 5f64 6572 6976 6174 6976    def _derivativ
-00013dc0: 6528 7365 6c66 2c20 7661 722c 2073 6565  e(self, var, see
-00013dd0: 6e29 3a0a 2020 2020 2020 2020 7265 7475  n):.        retu
-00013de0: 726e 205f 7461 6b65 2864 6572 6976 6174  rn _take(derivat
-00013df0: 6976 6528 7365 6c66 2e66 756e 632c 2076  ive(self.func, v
-00013e00: 6172 2c20 7365 656e 292c 2073 656c 662e  ar, seen), self.
-00013e10: 696e 6469 6365 732c 2073 656c 662e 6675  indices, self.fu
-00013e20: 6e63 2e6e 6469 6d2d 3129 0a0a 2020 2020  nc.ndim-1)..    
-00013e30: 6465 6620 5f74 616b 6528 7365 6c66 2c20  def _take(self, 
-00013e40: 696e 6465 782c 2061 7869 7329 3a0a 2020  index, axis):.  
-00013e50: 2020 2020 2020 6966 2061 7869 7320 3e3d        if axis >=
-00013e60: 2073 656c 662e 6675 6e63 2e6e 6469 6d2d   self.func.ndim-
-00013e70: 313a 0a20 2020 2020 2020 2020 2020 2072  1:.            r
-00013e80: 6574 7572 6e20 5461 6b65 2873 656c 662e  eturn Take(self.
-00013e90: 6675 6e63 2c20 5f74 616b 6528 7365 6c66  func, _take(self
-00013ea0: 2e69 6e64 6963 6573 2c20 696e 6465 782c  .indices, index,
-00013eb0: 2061 7869 732d 7365 6c66 2e66 756e 632e   axis-self.func.
-00013ec0: 6e64 696d 2b31 2929 0a20 2020 2020 2020  ndim+1)).       
-00013ed0: 2074 7279 7461 6b65 203d 2073 656c 662e   trytake = self.
-00013ee0: 6675 6e63 2e5f 7461 6b65 2869 6e64 6578  func._take(index
-00013ef0: 2c20 6178 6973 290a 2020 2020 2020 2020  , axis).        
-00013f00: 6966 2074 7279 7461 6b65 2069 7320 6e6f  if trytake is no
-00013f10: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00013f20: 2020 2020 7265 7475 726e 2054 616b 6528      return Take(
-00013f30: 7472 7974 616b 652c 2073 656c 662e 696e  trytake, self.in
-00013f40: 6469 6365 7329 0a0a 2020 2020 6465 6620  dices)..    def 
-00013f50: 5f73 756d 2873 656c 662c 2061 7869 7329  _sum(self, axis)
-00013f60: 3a0a 2020 2020 2020 2020 6966 2061 7869  :.        if axi
-00013f70: 7320 3c20 7365 6c66 2e66 756e 632e 6e64  s < self.func.nd
-00013f80: 696d 202d 2031 3a0a 2020 2020 2020 2020  im - 1:.        
-00013f90: 2020 2020 7265 7475 726e 2054 616b 6528      return Take(
-00013fa0: 7375 6d28 7365 6c66 2e66 756e 632c 2061  sum(self.func, a
-00013fb0: 7869 7329 2c20 7365 6c66 2e69 6e64 6963  xis), self.indic
-00013fc0: 6573 290a 0a20 2020 2064 6566 205f 696e  es)..    def _in
-00013fd0: 7462 6f75 6e64 735f 696d 706c 2873 656c  tbounds_impl(sel
-00013fe0: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
-00013ff0: 726e 2073 656c 662e 6675 6e63 2e5f 696e  rn self.func._in
-00014000: 7462 6f75 6e64 730a 0a0a 636c 6173 7320  tbounds...class 
-00014010: 506f 7765 7228 4172 7261 7929 3a0a 0a20  Power(Array):.. 
-00014020: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00014030: 7365 6c66 2c20 6675 6e63 3a20 4172 7261  self, func: Arra
-00014040: 792c 2070 6f77 6572 3a20 4172 7261 7929  y, power: Array)
-00014050: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-00014060: 2069 7369 6e73 7461 6e63 6528 6675 6e63   isinstance(func
-00014070: 2c20 4172 7261 7929 2c20 6627 6675 6e63  , Array), f'func
-00014080: 3d7b 6675 6e63 2172 7d27 0a20 2020 2020  ={func!r}'.     
-00014090: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-000140a0: 616e 6365 2870 6f77 6572 2c20 4172 7261  ance(power, Arra
-000140b0: 7929 2061 6e64 2028 706f 7765 722e 6474  y) and (power.dt
-000140c0: 7970 6520 696e 2028 666c 6f61 742c 2063  ype in (float, c
-000140d0: 6f6d 706c 6578 2920 6f72 2070 6f77 6572  omplex) or power
-000140e0: 2e64 7479 7065 203d 3d20 696e 7420 616e  .dtype == int an
-000140f0: 6420 706f 7765 722e 5f69 6e74 626f 756e  d power._intboun
-00014100: 6473 5b30 5d20 3e3d 2030 292c 2066 2770  ds[0] >= 0), f'p
-00014110: 6f77 6572 3d7b 706f 7765 7221 727d 270a  ower={power!r}'.
-00014120: 2020 2020 2020 2020 6173 7365 7274 2065          assert e
-00014130: 7175 616c 7368 6170 6528 6675 6e63 2e73  qualshape(func.s
-00014140: 6861 7065 2c20 706f 7765 722e 7368 6170  hape, power.shap
-00014150: 6529 2061 6e64 2066 756e 632e 6474 7970  e) and func.dtyp
-00014160: 6520 3d3d 2070 6f77 6572 2e64 7479 7065  e == power.dtype
-00014170: 2c20 2750 6f77 6572 287b 7d2c 207b 7d29  , 'Power({}, {})
-00014180: 272e 666f 726d 6174 2866 756e 632c 2070  '.format(func, p
-00014190: 6f77 6572 290a 2020 2020 2020 2020 7365  ower).        se
-000141a0: 6c66 2e66 756e 6320 3d20 6675 6e63 0a20  lf.func = func. 
-000141b0: 2020 2020 2020 2073 656c 662e 706f 7765         self.powe
-000141c0: 7220 3d20 706f 7765 720a 2020 2020 2020  r = power.      
-000141d0: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
-000141e0: 5f5f 2861 7267 733d 2866 756e 632c 2070  __(args=(func, p
-000141f0: 6f77 6572 292c 2073 6861 7065 3d66 756e  ower), shape=fun
-00014200: 632e 7368 6170 652c 2064 7479 7065 3d66  c.shape, dtype=f
-00014210: 756e 632e 6474 7970 6529 0a0a 2020 2020  unc.dtype)..    
-00014220: 6465 6620 5f73 696d 706c 6966 6965 6428  def _simplified(
-00014230: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
-00014240: 6620 6973 7a65 726f 2873 656c 662e 706f  f iszero(self.po
-00014250: 7765 7229 3a0a 2020 2020 2020 2020 2020  wer):.          
-00014260: 2020 7265 7475 726e 206f 6e65 735f 6c69    return ones_li
-00014270: 6b65 2873 656c 6629 0a20 2020 2020 2020  ke(self).       
-00014280: 2070 203d 2073 656c 662e 706f 7765 722e   p = self.power.
-00014290: 5f63 6f6e 7374 5f75 6e69 666f 726d 0a20  _const_uniform. 
-000142a0: 2020 2020 2020 2069 6620 7020 3d3d 2031         if p == 1
-000142b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000142c0: 7475 726e 2073 656c 662e 6675 6e63 0a20  turn self.func. 
-000142d0: 2020 2020 2020 2065 6c69 6620 7020 3d3d         elif p ==
-000142e0: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
-000142f0: 7265 7475 726e 2073 656c 662e 6675 6e63  return self.func
-00014300: 202a 2073 656c 662e 6675 6e63 0a20 2020   * self.func.   
-00014310: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00014320: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00014330: 6c66 2e66 756e 632e 5f70 6f77 6572 2873  lf.func._power(s
-00014340: 656c 662e 706f 7765 7229 0a0a 2020 2020  elf.power)..    
-00014350: 6465 6620 5f6f 7074 696d 697a 6564 5f66  def _optimized_f
-00014360: 6f72 5f6e 756d 7079 2873 656c 6629 3a0a  or_numpy(self):.
-00014370: 2020 2020 2020 2020 7020 3d20 7365 6c66          p = self
-00014380: 2e70 6f77 6572 2e5f 636f 6e73 745f 756e  .power._const_un
-00014390: 6966 6f72 6d0a 2020 2020 2020 2020 6966  iform.        if
-000143a0: 2070 203d 3d20 2d31 3a0a 2020 2020 2020   p == -1:.      
-000143b0: 2020 2020 2020 7265 7475 726e 2052 6563        return Rec
-000143c0: 6970 726f 6361 6c28 7365 6c66 2e66 756e  iprocal(self.fun
-000143d0: 6329 0a20 2020 2020 2020 2065 6c69 6620  c).        elif 
-000143e0: 7020 3d3d 202d 323a 0a20 2020 2020 2020  p == -2:.       
-000143f0: 2020 2020 2072 6574 7572 6e20 5265 6369       return Reci
-00014400: 7072 6f63 616c 2873 656c 662e 6675 6e63  procal(self.func
-00014410: 202a 2073 656c 662e 6675 6e63 290a 2020   * self.func).  
-00014420: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00014430: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00014440: 656c 662e 5f73 696d 706c 6966 6965 6428  elf._simplified(
-00014450: 290a 0a20 2020 2065 7661 6c66 203d 2073  )..    evalf = s
-00014460: 7461 7469 636d 6574 686f 6428 6e75 6d70  taticmethod(nump
-00014470: 792e 706f 7765 7229 0a0a 2020 2020 6465  y.power)..    de
-00014480: 6620 5f64 6572 6976 6174 6976 6528 7365  f _derivative(se
-00014490: 6c66 2c20 7661 722c 2073 6565 6e29 3a0a  lf, var, seen):.
-000144a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000144b0: 706f 7765 722e 6973 636f 6e73 7461 6e74  power.isconstant
-000144c0: 3a0a 2020 2020 2020 2020 2020 2020 7020  :.            p 
-000144d0: 3d20 7365 6c66 2e70 6f77 6572 2e65 7661  = self.power.eva
-000144e0: 6c28 290a 2020 2020 2020 2020 2020 2020  l().            
-000144f0: 7265 7475 726e 2065 696e 7375 6d28 2741  return einsum('A
-00014500: 2c41 2c41 422d 3e41 4227 2c20 636f 6e73  ,A,AB->AB', cons
-00014510: 7461 6e74 2870 292c 2070 6f77 6572 2873  tant(p), power(s
-00014520: 656c 662e 6675 6e63 2c20 7020 2d20 2870  elf.func, p - (p
-00014530: 2021 3d20 3029 292c 2064 6572 6976 6174   != 0)), derivat
-00014540: 6976 6528 7365 6c66 2e66 756e 632c 2076  ive(self.func, v
-00014550: 6172 2c20 7365 656e 2929 0a20 2020 2020  ar, seen)).     
-00014560: 2020 2069 6620 7365 6c66 2e64 7479 7065     if self.dtype
-00014570: 203d 3d20 636f 6d70 6c65 783a 0a20 2020   == complex:.   
-00014580: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
-00014590: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
-000145a0: 6f72 2827 5468 6520 636f 6d70 6c65 7820  or('The complex 
-000145b0: 6465 7269 7661 7469 7665 2069 7320 6e6f  derivative is no
-000145c0: 7420 696d 706c 656d 656e 7465 642e 2729  t implemented.')
-000145d0: 0a20 2020 2020 2020 2023 2073 656c 6620  .        # self 
-000145e0: 3d20 6675 6e63 2a2a 706f 7765 720a 2020  = func**power.  
-000145f0: 2020 2020 2020 2320 6c6e 2073 656c 6620        # ln self 
-00014600: 3d20 706f 7765 7220 2a20 6c6e 2066 756e  = power * ln fun
-00014610: 630a 2020 2020 2020 2020 2320 7365 6c66  c.        # self
-00014620: 6020 2f20 7365 6c66 203d 2070 6f77 6572  ` / self = power
-00014630: 6020 2a20 6c6e 2066 756e 6320 2b20 706f  ` * ln func + po
-00014640: 7765 7220 2a20 6675 6e63 6020 2f20 6675  wer * func` / fu
-00014650: 6e63 0a20 2020 2020 2020 2023 2073 656c  nc.        # sel
-00014660: 6660 203d 2070 6f77 6572 6020 2a20 6c6e  f` = power` * ln
-00014670: 2066 756e 6320 2a20 7365 6c66 202b 2070   func * self + p
-00014680: 6f77 6572 202a 2066 756e 6360 202a 2066  ower * func` * f
-00014690: 756e 632a 2a28 706f 7765 722d 3129 0a20  unc**(power-1). 
-000146a0: 2020 2020 2020 2072 6574 7572 6e20 6569         return ei
-000146b0: 6e73 756d 2827 412c 412c 4142 2d3e 4142  nsum('A,A,AB->AB
-000146c0: 272c 2073 656c 662e 706f 7765 722c 2070  ', self.power, p
-000146d0: 6f77 6572 2873 656c 662e 6675 6e63 2c20  ower(self.func, 
-000146e0: 7365 6c66 2e70 6f77 6572 202d 2031 292c  self.power - 1),
-000146f0: 2064 6572 6976 6174 6976 6528 7365 6c66   derivative(self
-00014700: 2e66 756e 632c 2076 6172 2c20 7365 656e  .func, var, seen
-00014710: 2929 205c 0a20 2020 2020 2020 2020 2020  )) \.           
-00014720: 202b 2065 696e 7375 6d28 2741 2c41 2c41   + einsum('A,A,A
-00014730: 422d 3e41 4227 2c20 6c6e 2873 656c 662e  B->AB', ln(self.
-00014740: 6675 6e63 292c 2073 656c 662c 2064 6572  func), self, der
-00014750: 6976 6174 6976 6528 7365 6c66 2e70 6f77  ivative(self.pow
-00014760: 6572 2c20 7661 722c 2073 6565 6e29 290a  er, var, seen)).
-00014770: 0a20 2020 2064 6566 205f 706f 7765 7228  .    def _power(
-00014780: 7365 6c66 2c20 6e29 3a0a 2020 2020 2020  self, n):.      
-00014790: 2020 6966 2073 656c 662e 6474 7970 6520    if self.dtype 
-000147a0: 3d3d 2063 6f6d 706c 6578 206f 7220 6e2e  == complex or n.
-000147b0: 6474 7970 6520 3d3d 2063 6f6d 706c 6578  dtype == complex
-000147c0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000147d0: 7475 726e 0a20 2020 2020 2020 2066 756e  turn.        fun
-000147e0: 6320 3d20 7365 6c66 2e66 756e 630a 2020  c = self.func.  
-000147f0: 2020 2020 2020 6e65 7770 6f77 6572 203d        newpower =
-00014800: 206d 756c 7469 706c 7928 7365 6c66 2e70   multiply(self.p
-00014810: 6f77 6572 2c20 6e29 0a20 2020 2020 2020  ower, n).       
-00014820: 2069 6620 6973 7a65 726f 2873 656c 662e   if iszero(self.
-00014830: 706f 7765 7220 2520 3229 2061 6e64 206e  power % 2) and n
-00014840: 6f74 2069 737a 6572 6f28 6e65 7770 6f77  ot iszero(newpow
-00014850: 6572 2025 2032 293a 0a20 2020 2020 2020  er % 2):.       
-00014860: 2020 2020 2066 756e 6320 3d20 6162 7328       func = abs(
-00014870: 6675 6e63 290a 2020 2020 2020 2020 7265  func).        re
-00014880: 7475 726e 2050 6f77 6572 2866 756e 632c  turn Power(func,
-00014890: 206e 6577 706f 7765 7229 0a0a 2020 2020   newpower)..    
-000148a0: 6465 6620 5f74 616b 6564 6961 6728 7365  def _takediag(se
-000148b0: 6c66 2c20 6178 6973 312c 2061 7869 7332  lf, axis1, axis2
-000148c0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-000148d0: 6e20 506f 7765 7228 5f74 616b 6564 6961  n Power(_takedia
-000148e0: 6728 7365 6c66 2e66 756e 632c 2061 7869  g(self.func, axi
-000148f0: 7331 2c20 6178 6973 3229 2c20 5f74 616b  s1, axis2), _tak
-00014900: 6564 6961 6728 7365 6c66 2e70 6f77 6572  ediag(self.power
-00014910: 2c20 6178 6973 312c 2061 7869 7332 2929  , axis1, axis2))
-00014920: 0a0a 2020 2020 6465 6620 5f74 616b 6528  ..    def _take(
-00014930: 7365 6c66 2c20 696e 6465 782c 2061 7869  self, index, axi
-00014940: 7329 3a0a 2020 2020 2020 2020 7265 7475  s):.        retu
-00014950: 726e 2050 6f77 6572 285f 7461 6b65 2873  rn Power(_take(s
-00014960: 656c 662e 6675 6e63 2c20 696e 6465 782c  elf.func, index,
-00014970: 2061 7869 7329 2c20 5f74 616b 6528 7365   axis), _take(se
-00014980: 6c66 2e70 6f77 6572 2c20 696e 6465 782c  lf.power, index,
-00014990: 2061 7869 7329 290a 0a20 2020 2064 6566   axis))..    def
-000149a0: 205f 756e 7261 7665 6c28 7365 6c66 2c20   _unravel(self, 
-000149b0: 6178 6973 2c20 7368 6170 6529 3a0a 2020  axis, shape):.  
-000149c0: 2020 2020 2020 7265 7475 726e 2050 6f77        return Pow
-000149d0: 6572 2875 6e72 6176 656c 2873 656c 662e  er(unravel(self.
-000149e0: 6675 6e63 2c20 6178 6973 2c20 7368 6170  func, axis, shap
-000149f0: 6529 2c20 756e 7261 7665 6c28 7365 6c66  e), unravel(self
-00014a00: 2e70 6f77 6572 2c20 6178 6973 2c20 7368  .power, axis, sh
-00014a10: 6170 6529 290a 0a0a 636c 6173 7320 506f  ape))...class Po
-00014a20: 696e 7477 6973 6528 4172 7261 7929 3a0a  intwise(Array):.
-00014a30: 2020 2020 2727 270a 2020 2020 4162 7374      '''.    Abst
-00014a40: 7261 6374 2062 6173 6520 636c 6173 7320  ract base class 
-00014a50: 666f 7220 706f 696e 7477 6973 6520 6172  for pointwise ar
-00014a60: 7261 7920 6675 6e63 7469 6f6e 732e 0a20  ray functions.. 
-00014a70: 2020 2027 2727 0a0a 2020 2020 6465 7269     '''..    deri
-00014a80: 7620 3d20 4e6f 6e65 0a20 2020 2063 6f6d  v = None.    com
-00014a90: 706c 6578 5f64 6572 6976 203d 204e 6f6e  plex_deriv = Non
-00014aa0: 650a 2020 2020 7265 7475 726e 5f74 7970  e.    return_typ
-00014ab0: 6520 3d20 4e6f 6e65 0a0a 2020 2020 6465  e = None..    de
-00014ac0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-00014ad0: 202a 6172 6773 3a20 4172 7261 792c 202a   *args: Array, *
-00014ae0: 2a70 6172 616d 7329 3a0a 2020 2020 2020  *params):.      
-00014af0: 2020 6173 7365 7274 2061 6c6c 2869 7369    assert all(isi
-00014b00: 6e73 7461 6e63 6528 6172 672c 2041 7272  nstance(arg, Arr
-00014b10: 6179 2920 666f 7220 6172 6720 696e 2061  ay) for arg in a
-00014b20: 7267 7329 2c20 6627 6172 6773 3d7b 6172  rgs), f'args={ar
-00014b30: 6773 2172 7d27 0a20 2020 2020 2020 2064  gs!r}'.        d
-00014b40: 7479 7065 203d 2073 656c 662e 5f5f 636c  type = self.__cl
-00014b50: 6173 735f 5f2e 7265 7475 726e 5f74 7970  ass__.return_typ
-00014b60: 6528 2a5b 6172 672e 6474 7970 6520 666f  e(*[arg.dtype fo
-00014b70: 7220 6172 6720 696e 2061 7267 735d 2c20  r arg in args], 
-00014b80: 2a2a 7061 7261 6d73 290a 2020 2020 2020  **params).      
-00014b90: 2020 7368 6170 6530 203d 2061 7267 735b    shape0 = args[
-00014ba0: 305d 2e73 6861 7065 0a20 2020 2020 2020  0].shape.       
-00014bb0: 2061 7373 6572 7420 616c 6c28 6571 7561   assert all(equa
-00014bc0: 6c73 6861 7065 2861 7267 2e73 6861 7065  lshape(arg.shape
-00014bd0: 2c20 7368 6170 6530 2920 666f 7220 6172  , shape0) for ar
-00014be0: 6720 696e 2061 7267 735b 313a 5d29 2c20  g in args[1:]), 
-00014bf0: 2770 6f69 6e74 7769 7365 2061 7267 756d  'pointwise argum
-00014c00: 656e 7473 2068 6176 6520 696e 636f 6e73  ents have incons
-00014c10: 6973 7465 6e74 2073 6861 7065 7327 0a20  istent shapes'. 
-00014c20: 2020 2020 2020 2073 656c 662e 6172 6773         self.args
-00014c30: 203d 2061 7267 730a 2020 2020 2020 2020   = args.        
-00014c40: 7365 6c66 2e70 6172 616d 7320 3d20 7061  self.params = pa
-00014c50: 7261 6d73 0a20 2020 2020 2020 2069 6620  rams.        if 
-00014c60: 7061 7261 6d73 3a0a 2020 2020 2020 2020  params:.        
-00014c70: 2020 2020 7365 6c66 2e65 7661 6c66 203d      self.evalf =
-00014c80: 2066 756e 6374 6f6f 6c73 2e70 6172 7469   functools.parti
-00014c90: 616c 2873 656c 662e 6576 616c 662c 202a  al(self.evalf, *
-00014ca0: 2a70 6172 616d 7329 0a20 2020 2020 2020  *params).       
-00014cb0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
-00014cc0: 5f28 6172 6773 3d61 7267 732c 2073 6861  _(args=args, sha
-00014cd0: 7065 3d73 6861 7065 302c 2064 7479 7065  pe=shape0, dtype
-00014ce0: 3d64 7479 7065 290a 0a20 2020 2064 6566  =dtype)..    def
-00014cf0: 205f 6e65 7761 7267 7328 7365 6c66 2c20   _newargs(self, 
-00014d00: 2a61 7267 7329 3a0a 2020 2020 2020 2020  *args):.        
-00014d10: 2727 270a 2020 2020 2020 2020 5265 696e  '''.        Rein
-00014d20: 7374 616e 7469 6174 6520 7365 6c66 2077  stantiate self w
-00014d30: 6974 6820 6469 6666 6572 656e 7420 6172  ith different ar
-00014d40: 6775 6d65 6e74 732e 2050 6172 616d 6574  guments. Paramet
-00014d50: 6572 7320 6172 6520 7072 6573 6572 7665  ers are preserve
-00014d60: 642c 0a20 2020 2020 2020 2061 7320 7468  d,.        as th
-00014d70: 6573 6520 6172 6520 636f 6e73 6964 6572  ese are consider
-00014d80: 6564 2070 6172 7420 6f66 2074 6865 2074  ed part of the t
-00014d90: 7970 652e 0a20 2020 2020 2020 2027 2727  ype..        '''
-00014da0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00014db0: 2073 656c 662e 5f5f 636c 6173 735f 5f28   self.__class__(
-00014dc0: 2a61 7267 732c 202a 2a73 656c 662e 7061  *args, **self.pa
-00014dd0: 7261 6d73 290a 0a20 2020 2040 636c 6173  rams)..    @clas
-00014de0: 736d 6574 686f 640a 2020 2020 6465 6620  smethod.    def 
-00014df0: 6f75 7465 7228 636c 732c 202a 6172 6773  outer(cls, *args
-00014e00: 293a 0a20 2020 2020 2020 2027 2727 416c  ):.        '''Al
-00014e10: 7465 726e 6174 6976 6520 636f 6e73 7472  ternative constr
-00014e20: 7563 746f 7220 7468 6174 206f 7574 6572  uctor that outer
-00014e30: 2d61 6c69 676e 7320 7468 6520 6172 6775  -aligns the argu
-00014e40: 6d65 6e74 732e 0a0a 2020 2020 2020 2020  ments...        
-00014e50: 5468 6520 6f75 7470 7574 2073 6861 7065  The output shape
-00014e60: 206f 6620 7468 6973 2070 6f69 6e74 7769   of this pointwi
-00014e70: 7365 2066 756e 6374 696f 6e20 6973 2074  se function is t
-00014e80: 6865 2073 756d 206f 6620 616c 6c20 7368  he sum of all sh
-00014e90: 6170 6573 206f 6620 6974 730a 2020 2020  apes of its.    
-00014ea0: 2020 2020 6172 6775 6d65 6e74 732e 2057      arguments. W
-00014eb0: 6865 6e20 6361 6c6c 6564 2077 6974 6820  hen called with 
-00014ec0: 6d75 6c74 6970 6c65 2061 7267 756d 656e  multiple argumen
-00014ed0: 7473 2c20 7468 6520 6669 7273 7420 6172  ts, the first ar
-00014ee0: 6775 6d65 6e74 2077 696c 6c20 6265 0a20  gument will be. 
-00014ef0: 2020 2020 2020 2061 7070 656e 6465 6420         appended 
-00014f00: 7769 7468 2073 696e 676c 6574 6f6e 2061  with singleton a
-00014f10: 7865 7320 746f 206d 6174 6368 2074 6865  xes to match the
-00014f20: 206f 7574 7075 7420 7368 6170 652c 2074   output shape, t
-00014f30: 6865 2073 6563 6f6e 6420 6172 6775 6d65  he second argume
-00014f40: 6e74 0a20 2020 2020 2020 2077 696c 6c20  nt.        will 
-00014f50: 6265 2070 7265 7065 6e64 6564 2077 6974  be prepended wit
-00014f60: 6820 6173 206d 616e 7920 7369 6e67 6c65  h as many single
-00014f70: 746f 6e20 6178 6573 2061 7320 7468 6520  ton axes as the 
-00014f80: 6469 6d65 6e73 696f 6e20 6f66 2074 6865  dimension of the
-00014f90: 0a20 2020 2020 2020 206f 7269 6769 6e61  .        origina
-00014fa0: 6c20 6669 7273 7420 6172 6775 6d65 6e74  l first argument
-00014fb0: 2061 6e64 2061 7070 656e 6465 6420 746f   and appended to
-00014fc0: 206d 6174 6368 2074 6865 206f 7574 7075   match the outpu
-00014fd0: 7420 7368 6170 652c 2061 6e64 2073 6f0a  t shape, and so.
-00014fe0: 2020 2020 2020 2020 666f 7274 6820 616e          forth an
-00014ff0: 6420 736f 206f 6e2e 0a20 2020 2020 2020  d so on..       
-00015000: 2027 2727 0a0a 2020 2020 2020 2020 6172   '''..        ar
-00015010: 6773 203d 2074 7570 6c65 286d 6170 2861  gs = tuple(map(a
-00015020: 7361 7272 6179 2c20 6172 6773 2929 0a20  sarray, args)). 
-00015030: 2020 2020 2020 2073 6861 7065 203d 2062         shape = b
-00015040: 7569 6c74 696e 732e 7375 6d28 2861 7267  uiltins.sum((arg
-00015050: 2e73 6861 7065 2066 6f72 2061 7267 2069  .shape for arg i
-00015060: 6e20 6172 6773 292c 2028 2929 0a20 2020  n args), ()).   
-00015070: 2020 2020 206f 6666 7365 7473 203d 206e       offsets = n
-00015080: 756d 7079 2e63 756d 7375 6d28 5b30 5d2b  umpy.cumsum([0]+
-00015090: 5b61 7267 2e6e 6469 6d20 666f 7220 6172  [arg.ndim for ar
-000150a0: 6720 696e 2061 7267 735d 290a 2020 2020  g in args]).    
-000150b0: 2020 2020 7265 7475 726e 2063 6c73 282a      return cls(*
-000150c0: 2870 7265 7065 6e64 6178 6573 2861 7070  (prependaxes(app
-000150d0: 656e 6461 7865 7328 6172 672c 2073 6861  endaxes(arg, sha
-000150e0: 7065 5b72 3a5d 292c 2073 6861 7065 5b3a  pe[r:]), shape[:
-000150f0: 6c5d 2920 666f 7220 6172 672c 206c 2c20  l]) for arg, l, 
-00015100: 7220 696e 207a 6970 2861 7267 732c 206f  r in zip(args, o
-00015110: 6666 7365 7473 5b3a 2d31 5d2c 206f 6666  ffsets[:-1], off
-00015120: 7365 7473 5b31 3a5d 2929 290a 0a20 2020  sets[1:])))..   
-00015130: 2064 6566 205f 7369 6d70 6c69 6669 6564   def _simplified
-00015140: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00015150: 6966 206c 656e 2873 656c 662e 6172 6773  if len(self.args
-00015160: 2920 3d3d 2031 2061 6e64 2069 7369 6e73  ) == 1 and isins
-00015170: 7461 6e63 6528 7365 6c66 2e61 7267 735b  tance(self.args[
-00015180: 305d 2c20 5472 616e 7370 6f73 6529 3a0a  0], Transpose):.
-00015190: 2020 2020 2020 2020 2020 2020 6172 672c              arg,
-000151a0: 203d 2073 656c 662e 6172 6773 0a20 2020   = self.args.   
-000151b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000151c0: 5472 616e 7370 6f73 6528 7365 6c66 2e5f  Transpose(self._
-000151d0: 6e65 7761 7267 7328 6172 672e 6675 6e63  newargs(arg.func
-000151e0: 292c 2061 7267 2e61 7865 7329 0a20 2020  ), arg.axes).   
-000151f0: 2020 2020 202a 756e 696e 7365 7274 6564       *uninserted
-00015200: 2c20 7768 6572 6520 3d20 756e 616c 6967  , where = unalig
-00015210: 6e28 2a73 656c 662e 6172 6773 290a 2020  n(*self.args).  
-00015220: 2020 2020 2020 6966 206c 656e 2877 6865        if len(whe
-00015230: 7265 2920 213d 2073 656c 662e 6e64 696d  re) != self.ndim
-00015240: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00015250: 7475 726e 2061 6c69 676e 2873 656c 662e  turn align(self.
-00015260: 5f6e 6577 6172 6773 282a 756e 696e 7365  _newargs(*uninse
-00015270: 7274 6564 292c 2077 6865 7265 2c20 7365  rted), where, se
-00015280: 6c66 2e73 6861 7065 290a 0a20 2020 2064  lf.shape)..    d
-00015290: 6566 205f 6f70 7469 6d69 7a65 645f 666f  ef _optimized_fo
-000152a0: 725f 6e75 6d70 7928 7365 6c66 293a 0a20  r_numpy(self):. 
-000152b0: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-000152c0: 7363 6f6e 7374 616e 743a 0a20 2020 2020  sconstant:.     
-000152d0: 2020 2020 2020 2072 6574 7661 6c20 3d20         retval = 
-000152e0: 7365 6c66 2e65 7661 6c28 290a 2020 2020  self.eval().    
-000152f0: 2020 2020 2020 2020 7265 7475 726e 2063          return c
-00015300: 6f6e 7374 616e 7428 7265 7476 616c 290a  onstant(retval).
-00015310: 0a20 2020 2064 6566 205f 6465 7269 7661  .    def _deriva
-00015320: 7469 7665 2873 656c 662c 2076 6172 2c20  tive(self, var, 
-00015330: 7365 656e 293a 0a20 2020 2020 2020 2069  seen):.        i
-00015340: 6620 7365 6c66 2e63 6f6d 706c 6578 5f64  f self.complex_d
-00015350: 6572 6976 2069 7320 6e6f 7420 4e6f 6e65  eriv is not None
-00015360: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00015370: 7475 726e 2075 7469 6c2e 7375 6d28 6569  turn util.sum(ei
-00015380: 6e73 756d 2827 412c 4142 2d3e 4142 272c  nsum('A,AB->AB',
-00015390: 2064 6572 6976 282a 7365 6c66 2e61 7267   deriv(*self.arg
-000153a0: 732c 202a 2a73 656c 662e 7061 7261 6d73  s, **self.params
-000153b0: 292c 2064 6572 6976 6174 6976 6528 6172  ), derivative(ar
-000153c0: 672c 2076 6172 2c20 7365 656e 2929 2066  g, var, seen)) f
-000153d0: 6f72 2061 7267 2c20 6465 7269 7620 696e  or arg, deriv in
-000153e0: 207a 6970 2873 656c 662e 6172 6773 2c20   zip(self.args, 
-000153f0: 7365 6c66 2e63 6f6d 706c 6578 5f64 6572  self.complex_der
-00015400: 6976 2929 0a20 2020 2020 2020 2065 6c69  iv)).        eli
-00015410: 6620 7365 6c66 2e64 7479 7065 203d 3d20  f self.dtype == 
-00015420: 636f 6d70 6c65 7820 6f72 2076 6172 2e64  complex or var.d
-00015430: 7479 7065 203d 3d20 636f 6d70 6c65 783a  type == complex:
-00015440: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00015450: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
-00015460: 6445 7272 6f72 2827 5468 6520 636f 6d70  dError('The comp
-00015470: 6c65 7820 6465 7269 7661 7469 7665 2069  lex derivative i
-00015480: 7320 6e6f 7420 696d 706c 656d 656e 7465  s not implemente
-00015490: 642e 2729 0a20 2020 2020 2020 2065 6c69  d.').        eli
-000154a0: 6620 7365 6c66 2e64 6572 6976 2069 7320  f self.deriv is 
-000154b0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-000154c0: 2020 2020 2020 7265 7475 726e 2075 7469        return uti
-000154d0: 6c2e 7375 6d28 6569 6e73 756d 2827 412c  l.sum(einsum('A,
-000154e0: 4142 2d3e 4142 272c 2064 6572 6976 282a  AB->AB', deriv(*
-000154f0: 7365 6c66 2e61 7267 732c 202a 2a73 656c  self.args, **sel
-00015500: 662e 7061 7261 6d73 292c 2064 6572 6976  f.params), deriv
-00015510: 6174 6976 6528 6172 672c 2076 6172 2c20  ative(arg, var, 
-00015520: 7365 656e 2929 2066 6f72 2061 7267 2c20  seen)) for arg, 
-00015530: 6465 7269 7620 696e 207a 6970 2873 656c  deriv in zip(sel
-00015540: 662e 6172 6773 2c20 7365 6c66 2e64 6572  f.args, self.der
-00015550: 6976 2929 0a20 2020 2020 2020 2065 6c73  iv)).        els
-00015560: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00015570: 6574 7572 6e20 7375 7065 7228 292e 5f64  eturn super()._d
-00015580: 6572 6976 6174 6976 6528 7661 722c 2073  erivative(var, s
-00015590: 6565 6e29 0a0a 2020 2020 6465 6620 5f74  een)..    def _t
-000155a0: 616b 6564 6961 6728 7365 6c66 2c20 6178  akediag(self, ax
-000155b0: 6973 312c 2061 7869 7332 293a 0a20 2020  is1, axis2):.   
-000155c0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-000155d0: 2e5f 6e65 7761 7267 7328 2a5b 5f74 616b  ._newargs(*[_tak
-000155e0: 6564 6961 6728 6172 672c 2061 7869 7331  ediag(arg, axis1
-000155f0: 2c20 6178 6973 3229 2066 6f72 2061 7267  , axis2) for arg
-00015600: 2069 6e20 7365 6c66 2e61 7267 735d 290a   in self.args]).
-00015610: 0a20 2020 2064 6566 205f 7461 6b65 2873  .    def _take(s
-00015620: 656c 662c 2069 6e64 6578 2c20 6178 6973  elf, index, axis
-00015630: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00015640: 6e20 7365 6c66 2e5f 6e65 7761 7267 7328  n self._newargs(
-00015650: 2a5b 5f74 616b 6528 6172 672c 2069 6e64  *[_take(arg, ind
-00015660: 6578 2c20 6178 6973 2920 666f 7220 6172  ex, axis) for ar
-00015670: 6720 696e 2073 656c 662e 6172 6773 5d29  g in self.args])
-00015680: 0a0a 2020 2020 6465 6620 5f75 6e72 6176  ..    def _unrav
-00015690: 656c 2873 656c 662c 2061 7869 732c 2073  el(self, axis, s
-000156a0: 6861 7065 293a 0a20 2020 2020 2020 2072  hape):.        r
-000156b0: 6574 7572 6e20 7365 6c66 2e5f 6e65 7761  eturn self._newa
-000156c0: 7267 7328 2a5b 756e 7261 7665 6c28 6172  rgs(*[unravel(ar
-000156d0: 672c 2061 7869 732c 2073 6861 7065 2920  g, axis, shape) 
-000156e0: 666f 7220 6172 6720 696e 2073 656c 662e  for arg in self.
-000156f0: 6172 6773 5d29 0a0a 0a63 6c61 7373 2052  args])...class R
-00015700: 6563 6970 726f 6361 6c28 506f 696e 7477  eciprocal(Pointw
-00015710: 6973 6529 3a0a 2020 2020 6576 616c 6620  ise):.    evalf 
-00015720: 3d20 7374 6174 6963 6d65 7468 6f64 286e  = staticmethod(n
-00015730: 756d 7079 2e72 6563 6970 726f 6361 6c29  umpy.reciprocal)
-00015740: 0a20 2020 2072 6574 7572 6e5f 7479 7065  .    return_type
-00015750: 203d 206c 616d 6264 6120 543a 2063 6f6d   = lambda T: com
-00015760: 706c 6578 2069 6620 5420 3d3d 2063 6f6d  plex if T == com
-00015770: 706c 6578 2065 6c73 6520 666c 6f61 740a  plex else float.
-00015780: 0a0a 636c 6173 7320 4e65 6761 7469 7665  ..class Negative
-00015790: 2850 6f69 6e74 7769 7365 293a 0a20 2020  (Pointwise):.   
-000157a0: 2065 7661 6c66 203d 2073 7461 7469 636d   evalf = staticm
-000157b0: 6574 686f 6428 6e75 6d70 792e 6e65 6761  ethod(numpy.nega
-000157c0: 7469 7665 290a 2020 2020 6465 6620 7265  tive).    def re
-000157d0: 7475 726e 5f74 7970 6528 5429 3a0a 2020  turn_type(T):.  
-000157e0: 2020 2020 2020 6966 2054 203d 3d20 626f        if T == bo
-000157f0: 6f6c 3a0a 2020 2020 2020 2020 2020 2020  ol:.            
-00015800: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00015810: 2827 626f 6f6c 6561 6e20 7661 6c75 6573  ('boolean values
-00015820: 2063 616e 6e6f 7420 6265 206e 6567 6174   cannot be negat
-00015830: 6564 2729 0a20 2020 2020 2020 2072 6574  ed').        ret
-00015840: 7572 6e20 540a 0a20 2020 2064 6566 205f  urn T..    def _
-00015850: 696e 7462 6f75 6e64 735f 696d 706c 2873  intbounds_impl(s
-00015860: 656c 6629 3a0a 2020 2020 2020 2020 6c6f  elf):.        lo
-00015870: 7765 722c 2075 7070 6572 203d 2073 656c  wer, upper = sel
-00015880: 662e 6172 6773 5b30 5d2e 5f69 6e74 626f  f.args[0]._intbo
-00015890: 756e 6473 0a20 2020 2020 2020 2072 6574  unds.        ret
-000158a0: 7572 6e20 2d75 7070 6572 2c20 2d6c 6f77  urn -upper, -low
-000158b0: 6572 0a0a 0a63 6c61 7373 2046 6c6f 6f72  er...class Floor
-000158c0: 4469 7669 6465 2850 6f69 6e74 7769 7365  Divide(Pointwise
-000158d0: 293a 0a20 2020 2065 7661 6c66 203d 2073  ):.    evalf = s
-000158e0: 7461 7469 636d 6574 686f 6428 6e75 6d70  taticmethod(nump
-000158f0: 792e 666c 6f6f 725f 6469 7669 6465 290a  y.floor_divide).
-00015900: 2020 2020 7265 7475 726e 5f74 7970 6520      return_type 
-00015910: 3d20 6c61 6d62 6461 2054 312c 2054 323a  = lambda T1, T2:
-00015920: 2063 6f6d 706c 6578 2069 6620 636f 6d70   complex if comp
-00015930: 6c65 7820 696e 2028 5431 2c20 5432 2920  lex in (T1, T2) 
-00015940: 656c 7365 2066 6c6f 6174 2069 6620 666c  else float if fl
-00015950: 6f61 7420 696e 2028 5431 2c20 5432 2920  oat in (T1, T2) 
-00015960: 656c 7365 2069 6e74 0a0a 0a63 6c61 7373  else int...class
-00015970: 2041 6273 6f6c 7574 6528 506f 696e 7477   Absolute(Pointw
-00015980: 6973 6529 3a0a 2020 2020 6576 616c 6620  ise):.    evalf 
-00015990: 3d20 7374 6174 6963 6d65 7468 6f64 286e  = staticmethod(n
-000159a0: 756d 7079 2e61 6273 6f6c 7574 6529 0a20  umpy.absolute). 
-000159b0: 2020 2072 6574 7572 6e5f 7479 7065 203d     return_type =
-000159c0: 206c 616d 6264 6120 543a 2066 6c6f 6174   lambda T: float
-000159d0: 2069 6620 5420 696e 2028 666c 6f61 742c   if T in (float,
-000159e0: 2063 6f6d 706c 6578 2920 656c 7365 2069   complex) else i
-000159f0: 6e74 0a0a 2020 2020 6465 6620 5f69 6e74  nt..    def _int
-00015a00: 626f 756e 6473 5f69 6d70 6c28 7365 6c66  bounds_impl(self
-00015a10: 293a 0a20 2020 2020 2020 206c 6f77 6572  ):.        lower
-00015a20: 2c20 7570 7065 7220 3d20 7365 6c66 2e61  , upper = self.a
-00015a30: 7267 735b 305d 2e5f 696e 7462 6f75 6e64  rgs[0]._intbound
-00015a40: 730a 2020 2020 2020 2020 6578 7472 656d  s.        extrem
-00015a50: 6120 3d20 6275 696c 7469 6e73 2e61 6273  a = builtins.abs
-00015a60: 286c 6f77 6572 292c 2062 7569 6c74 696e  (lower), builtin
-00015a70: 732e 6162 7328 7570 7065 7229 0a20 2020  s.abs(upper).   
-00015a80: 2020 2020 2069 6620 6c6f 7765 7220 3c3d       if lower <=
-00015a90: 2030 2061 6e64 2075 7070 6572 203e 3d20   0 and upper >= 
-00015aa0: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
-00015ab0: 6574 7572 6e20 302c 206d 6178 2865 7874  eturn 0, max(ext
-00015ac0: 7265 6d61 290a 2020 2020 2020 2020 656c  rema).        el
-00015ad0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00015ae0: 7265 7475 726e 206d 696e 2865 7874 7265  return min(extre
-00015af0: 6d61 292c 206d 6178 2865 7874 7265 6d61  ma), max(extrema
-00015b00: 290a 0a0a 636c 6173 7320 436f 7328 506f  )...class Cos(Po
-00015b10: 696e 7477 6973 6529 3a0a 2020 2020 2743  intwise):.    'C
-00015b20: 6f73 696e 652c 2065 6c65 6d65 6e74 2d77  osine, element-w
-00015b30: 6973 652e 270a 2020 2020 6576 616c 6620  ise.'.    evalf 
-00015b40: 3d20 7374 6174 6963 6d65 7468 6f64 286e  = staticmethod(n
-00015b50: 756d 7079 2e63 6f73 290a 2020 2020 636f  umpy.cos).    co
-00015b60: 6d70 6c65 785f 6465 7269 7620 3d20 6c61  mplex_deriv = la
-00015b70: 6d62 6461 2078 3a20 2d53 696e 2878 292c  mbda x: -Sin(x),
-00015b80: 0a20 2020 2072 6574 7572 6e5f 7479 7065  .    return_type
-00015b90: 203d 206c 616d 6264 6120 543a 2063 6f6d   = lambda T: com
-00015ba0: 706c 6578 2069 6620 5420 3d3d 2063 6f6d  plex if T == com
-00015bb0: 706c 6578 2065 6c73 6520 666c 6f61 740a  plex else float.
-00015bc0: 0a20 2020 2064 6566 205f 7369 6d70 6c69  .    def _simpli
-00015bd0: 6669 6564 2873 656c 6629 3a0a 2020 2020  fied(self):.    
-00015be0: 2020 2020 6172 672c 203d 2073 656c 662e      arg, = self.
-00015bf0: 6172 6773 0a20 2020 2020 2020 2069 6620  args.        if 
-00015c00: 6973 7a65 726f 2861 7267 293a 0a20 2020  iszero(arg):.   
-00015c10: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00015c20: 6f6e 6573 2873 656c 662e 7368 6170 652c  ones(self.shape,
-00015c30: 2064 7479 7065 3d73 656c 662e 6474 7970   dtype=self.dtyp
-00015c40: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
-00015c50: 6e20 7375 7065 7228 292e 5f73 696d 706c  n super()._simpl
-00015c60: 6966 6965 6428 290a 0a0a 636c 6173 7320  ified()...class 
-00015c70: 5369 6e28 506f 696e 7477 6973 6529 3a0a  Sin(Pointwise):.
-00015c80: 2020 2020 2753 696e 652c 2065 6c65 6d65      'Sine, eleme
-00015c90: 6e74 2d77 6973 652e 270a 2020 2020 6576  nt-wise.'.    ev
-00015ca0: 616c 6620 3d20 7374 6174 6963 6d65 7468  alf = staticmeth
-00015cb0: 6f64 286e 756d 7079 2e73 696e 290a 2020  od(numpy.sin).  
-00015cc0: 2020 636f 6d70 6c65 785f 6465 7269 7620    complex_deriv 
-00015cd0: 3d20 436f 732c 0a20 2020 2072 6574 7572  = Cos,.    retur
-00015ce0: 6e5f 7479 7065 203d 206c 616d 6264 6120  n_type = lambda 
-00015cf0: 543a 2063 6f6d 706c 6578 2069 6620 5420  T: complex if T 
-00015d00: 3d3d 2063 6f6d 706c 6578 2065 6c73 6520  == complex else 
-00015d10: 666c 6f61 740a 0a20 2020 2064 6566 205f  float..    def _
-00015d20: 7369 6d70 6c69 6669 6564 2873 656c 6629  simplified(self)
-00015d30: 3a0a 2020 2020 2020 2020 6172 672c 203d  :.        arg, =
-00015d40: 2073 656c 662e 6172 6773 0a20 2020 2020   self.args.     
-00015d50: 2020 2069 6620 6973 7a65 726f 2861 7267     if iszero(arg
-00015d60: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00015d70: 6574 7572 6e20 7a65 726f 7328 7365 6c66  eturn zeros(self
-00015d80: 2e73 6861 7065 2c20 6474 7970 653d 7365  .shape, dtype=se
-00015d90: 6c66 2e64 7479 7065 290a 2020 2020 2020  lf.dtype).      
-00015da0: 2020 7265 7475 726e 2073 7570 6572 2829    return super()
-00015db0: 2e5f 7369 6d70 6c69 6669 6564 2829 0a0a  ._simplified()..
-00015dc0: 0a63 6c61 7373 2054 616e 2850 6f69 6e74  .class Tan(Point
-00015dd0: 7769 7365 293a 0a20 2020 2027 5461 6e67  wise):.    'Tang
-00015de0: 656e 742c 2065 6c65 6d65 6e74 2d77 6973  ent, element-wis
-00015df0: 652e 270a 2020 2020 6576 616c 6620 3d20  e.'.    evalf = 
-00015e00: 7374 6174 6963 6d65 7468 6f64 286e 756d  staticmethod(num
-00015e10: 7079 2e74 616e 290a 2020 2020 636f 6d70  py.tan).    comp
-00015e20: 6c65 785f 6465 7269 7620 3d20 6c61 6d62  lex_deriv = lamb
-00015e30: 6461 2078 3a20 436f 7328 7829 2a2a 2d32  da x: Cos(x)**-2
-00015e40: 2c0a 2020 2020 7265 7475 726e 5f74 7970  ,.    return_typ
-00015e50: 6520 3d20 6c61 6d62 6461 2054 3a20 636f  e = lambda T: co
-00015e60: 6d70 6c65 7820 6966 2054 203d 3d20 636f  mplex if T == co
-00015e70: 6d70 6c65 7820 656c 7365 2066 6c6f 6174  mplex else float
-00015e80: 0a0a 0a63 6c61 7373 2041 7263 5369 6e28  ...class ArcSin(
-00015e90: 506f 696e 7477 6973 6529 3a0a 2020 2020  Pointwise):.    
-00015ea0: 2749 6e76 6572 7365 2073 696e 652c 2065  'Inverse sine, e
-00015eb0: 6c65 6d65 6e74 2d77 6973 652e 270a 2020  lement-wise.'.  
-00015ec0: 2020 6576 616c 6620 3d20 7374 6174 6963    evalf = static
-00015ed0: 6d65 7468 6f64 286e 756d 7079 2e61 7263  method(numpy.arc
-00015ee0: 7369 6e29 0a20 2020 2063 6f6d 706c 6578  sin).    complex
-00015ef0: 5f64 6572 6976 203d 206c 616d 6264 6120  _deriv = lambda 
-00015f00: 783a 2072 6563 6970 726f 6361 6c28 7371  x: reciprocal(sq
-00015f10: 7274 2831 2d78 2a2a 3229 292c 0a20 2020  rt(1-x**2)),.   
-00015f20: 2072 6574 7572 6e5f 7479 7065 203d 206c   return_type = l
-00015f30: 616d 6264 6120 543a 2063 6f6d 706c 6578  ambda T: complex
-00015f40: 2069 6620 5420 3d3d 2063 6f6d 706c 6578   if T == complex
-00015f50: 2065 6c73 6520 666c 6f61 740a 0a0a 636c   else float...cl
-00015f60: 6173 7320 4172 6343 6f73 2850 6f69 6e74  ass ArcCos(Point
-00015f70: 7769 7365 293a 0a20 2020 2027 496e 7665  wise):.    'Inve
-00015f80: 7273 6520 636f 7369 6e65 2c20 656c 656d  rse cosine, elem
-00015f90: 656e 742d 7769 7365 2e27 0a20 2020 2065  ent-wise.'.    e
-00015fa0: 7661 6c66 203d 2073 7461 7469 636d 6574  valf = staticmet
-00015fb0: 686f 6428 6e75 6d70 792e 6172 6363 6f73  hod(numpy.arccos
-00015fc0: 290a 2020 2020 636f 6d70 6c65 785f 6465  ).    complex_de
-00015fd0: 7269 7620 3d20 6c61 6d62 6461 2078 3a20  riv = lambda x: 
-00015fe0: 2d72 6563 6970 726f 6361 6c28 7371 7274  -reciprocal(sqrt
-00015ff0: 2831 2d78 2a2a 3229 292c 0a20 2020 2072  (1-x**2)),.    r
-00016000: 6574 7572 6e5f 7479 7065 203d 206c 616d  eturn_type = lam
-00016010: 6264 6120 543a 2063 6f6d 706c 6578 2069  bda T: complex i
-00016020: 6620 5420 3d3d 2063 6f6d 706c 6578 2065  f T == complex e
-00016030: 6c73 6520 666c 6f61 740a 0a0a 636c 6173  lse float...clas
-00016040: 7320 4172 6354 616e 2850 6f69 6e74 7769  s ArcTan(Pointwi
-00016050: 7365 293a 0a20 2020 2027 496e 7665 7273  se):.    'Invers
-00016060: 6520 7461 6e67 656e 742c 2065 6c65 6d65  e tangent, eleme
-00016070: 6e74 2d77 6973 652e 270a 2020 2020 6576  nt-wise.'.    ev
-00016080: 616c 6620 3d20 7374 6174 6963 6d65 7468  alf = staticmeth
-00016090: 6f64 286e 756d 7079 2e61 7263 7461 6e29  od(numpy.arctan)
-000160a0: 0a20 2020 2063 6f6d 706c 6578 5f64 6572  .    complex_der
-000160b0: 6976 203d 206c 616d 6264 6120 783a 2072  iv = lambda x: r
-000160c0: 6563 6970 726f 6361 6c28 312b 782a 2a32  eciprocal(1+x**2
-000160d0: 292c 0a20 2020 2072 6574 7572 6e5f 7479  ),.    return_ty
-000160e0: 7065 203d 206c 616d 6264 6120 543a 2063  pe = lambda T: c
-000160f0: 6f6d 706c 6578 2069 6620 5420 3d3d 2063  omplex if T == c
-00016100: 6f6d 706c 6578 2065 6c73 6520 666c 6f61  omplex else floa
-00016110: 740a 0a0a 636c 6173 7320 5369 6e63 2850  t...class Sinc(P
-00016120: 6f69 6e74 7769 7365 293a 0a20 2020 2065  ointwise):.    e
-00016130: 7661 6c66 203d 2073 7461 7469 636d 6574  valf = staticmet
-00016140: 686f 6428 6e75 6d65 7269 632e 7369 6e63  hod(numeric.sinc
-00016150: 290a 2020 2020 636f 6d70 6c65 785f 6465  ).    complex_de
-00016160: 7269 7620 3d20 6c61 6d62 6461 2078 2c20  riv = lambda x, 
-00016170: 6e3a 2053 696e 6328 782c 206e 3d6e 2b31  n: Sinc(x, n=n+1
-00016180: 292c 0a20 2020 2072 6574 7572 6e5f 7479  ),.    return_ty
-00016190: 7065 203d 206c 616d 6264 6120 542c 206e  pe = lambda T, n
-000161a0: 3a20 636f 6d70 6c65 7820 6966 2054 203d  : complex if T =
-000161b0: 3d20 636f 6d70 6c65 7820 656c 7365 2066  = complex else f
-000161c0: 6c6f 6174 0a0a 0a63 6c61 7373 2043 6f73  loat...class Cos
-000161d0: 4828 506f 696e 7477 6973 6529 3a0a 2020  H(Pointwise):.  
-000161e0: 2020 2748 7970 6572 626f 6c69 6320 636f    'Hyperbolic co
-000161f0: 7369 6e65 2c20 656c 656d 656e 742d 7769  sine, element-wi
-00016200: 7365 2e27 0a20 2020 2065 7661 6c66 203d  se.'.    evalf =
-00016210: 2073 7461 7469 636d 6574 686f 6428 6e75   staticmethod(nu
-00016220: 6d70 792e 636f 7368 290a 2020 2020 636f  mpy.cosh).    co
-00016230: 6d70 6c65 785f 6465 7269 7620 3d20 6c61  mplex_deriv = la
-00016240: 6d62 6461 2078 3a20 5369 6e48 2878 292c  mbda x: SinH(x),
-00016250: 0a20 2020 2072 6574 7572 6e5f 7479 7065  .    return_type
-00016260: 203d 206c 616d 6264 6120 543a 2063 6f6d   = lambda T: com
-00016270: 706c 6578 2069 6620 5420 3d3d 2063 6f6d  plex if T == com
-00016280: 706c 6578 2065 6c73 6520 666c 6f61 740a  plex else float.
-00016290: 0a0a 636c 6173 7320 5369 6e48 2850 6f69  ..class SinH(Poi
-000162a0: 6e74 7769 7365 293a 0a20 2020 2027 4879  ntwise):.    'Hy
-000162b0: 7065 7262 6f6c 6963 2073 696e 652c 2065  perbolic sine, e
-000162c0: 6c65 6d65 6e74 2d77 6973 652e 270a 2020  lement-wise.'.  
-000162d0: 2020 6576 616c 6620 3d20 7374 6174 6963    evalf = static
-000162e0: 6d65 7468 6f64 286e 756d 7079 2e73 696e  method(numpy.sin
-000162f0: 6829 0a20 2020 2063 6f6d 706c 6578 5f64  h).    complex_d
-00016300: 6572 6976 203d 2043 6f73 482c 0a20 2020  eriv = CosH,.   
-00016310: 2072 6574 7572 6e5f 7479 7065 203d 206c   return_type = l
-00016320: 616d 6264 6120 543a 2063 6f6d 706c 6578  ambda T: complex
-00016330: 2069 6620 5420 3d3d 2063 6f6d 706c 6578   if T == complex
-00016340: 2065 6c73 6520 666c 6f61 740a 0a0a 636c   else float...cl
-00016350: 6173 7320 5461 6e48 2850 6f69 6e74 7769  ass TanH(Pointwi
-00016360: 7365 293a 0a20 2020 2027 4879 7065 7262  se):.    'Hyperb
-00016370: 6f6c 6963 2074 616e 6765 6e74 2c20 656c  olic tangent, el
-00016380: 656d 656e 742d 7769 7365 2e27 0a20 2020  ement-wise.'.   
-00016390: 2065 7661 6c66 203d 2073 7461 7469 636d   evalf = staticm
-000163a0: 6574 686f 6428 6e75 6d70 792e 7461 6e68  ethod(numpy.tanh
-000163b0: 290a 2020 2020 636f 6d70 6c65 785f 6465  ).    complex_de
-000163c0: 7269 7620 3d20 6c61 6d62 6461 2078 3a20  riv = lambda x: 
-000163d0: 3120 2d20 5461 6e48 2878 292a 2a32 2c0a  1 - TanH(x)**2,.
-000163e0: 2020 2020 7265 7475 726e 5f74 7970 6520      return_type 
-000163f0: 3d20 6c61 6d62 6461 2054 3a20 636f 6d70  = lambda T: comp
-00016400: 6c65 7820 6966 2054 203d 3d20 636f 6d70  lex if T == comp
-00016410: 6c65 7820 656c 7365 2066 6c6f 6174 0a0a  lex else float..
-00016420: 0a63 6c61 7373 2041 7263 5461 6e48 2850  .class ArcTanH(P
-00016430: 6f69 6e74 7769 7365 293a 0a20 2020 2027  ointwise):.    '
-00016440: 496e 7665 7273 6520 6879 7065 7262 6f6c  Inverse hyperbol
-00016450: 6963 2074 616e 6765 6e74 2c20 656c 656d  ic tangent, elem
-00016460: 656e 742d 7769 7365 2e27 0a20 2020 2065  ent-wise.'.    e
-00016470: 7661 6c66 203d 2073 7461 7469 636d 6574  valf = staticmet
-00016480: 686f 6428 6e75 6d70 792e 6172 6374 616e  hod(numpy.arctan
-00016490: 6829 0a20 2020 2063 6f6d 706c 6578 5f64  h).    complex_d
-000164a0: 6572 6976 203d 206c 616d 6264 6120 783a  eriv = lambda x:
-000164b0: 2072 6563 6970 726f 6361 6c28 312d 782a   reciprocal(1-x*
-000164c0: 2a32 292c 0a20 2020 2072 6574 7572 6e5f  *2),.    return_
-000164d0: 7479 7065 203d 206c 616d 6264 6120 543a  type = lambda T:
-000164e0: 2063 6f6d 706c 6578 2069 6620 5420 3d3d   complex if T ==
-000164f0: 2063 6f6d 706c 6578 2065 6c73 6520 666c   complex else fl
-00016500: 6f61 740a 0a0a 636c 6173 7320 4578 7028  oat...class Exp(
-00016510: 506f 696e 7477 6973 6529 3a0a 2020 2020  Pointwise):.    
-00016520: 6576 616c 6620 3d20 7374 6174 6963 6d65  evalf = staticme
-00016530: 7468 6f64 286e 756d 7079 2e65 7870 290a  thod(numpy.exp).
-00016540: 2020 2020 636f 6d70 6c65 785f 6465 7269      complex_deri
-00016550: 7620 3d20 6c61 6d62 6461 2078 3a20 4578  v = lambda x: Ex
-00016560: 7028 7829 2c0a 2020 2020 7265 7475 726e  p(x),.    return
-00016570: 5f74 7970 6520 3d20 6c61 6d62 6461 2054  _type = lambda T
-00016580: 3a20 636f 6d70 6c65 7820 6966 2054 203d  : complex if T =
-00016590: 3d20 636f 6d70 6c65 7820 656c 7365 2066  = complex else f
-000165a0: 6c6f 6174 0a0a 0a63 6c61 7373 204c 6f67  loat...class Log
-000165b0: 2850 6f69 6e74 7769 7365 293a 0a20 2020  (Pointwise):.   
-000165c0: 2065 7661 6c66 203d 2073 7461 7469 636d   evalf = staticm
-000165d0: 6574 686f 6428 6e75 6d70 792e 6c6f 6729  ethod(numpy.log)
-000165e0: 0a20 2020 2063 6f6d 706c 6578 5f64 6572  .    complex_der
-000165f0: 6976 203d 206c 616d 6264 6120 783a 2072  iv = lambda x: r
-00016600: 6563 6970 726f 6361 6c28 7829 2c0a 2020  eciprocal(x),.  
-00016610: 2020 7265 7475 726e 5f74 7970 6520 3d20    return_type = 
-00016620: 6c61 6d62 6461 2054 3a20 636f 6d70 6c65  lambda T: comple
-00016630: 7820 6966 2054 203d 3d20 636f 6d70 6c65  x if T == comple
-00016640: 7820 656c 7365 2066 6c6f 6174 0a0a 0a63  x else float...c
-00016650: 6c61 7373 204d 6f64 2850 6f69 6e74 7769  lass Mod(Pointwi
-00016660: 7365 293a 0a20 2020 2065 7661 6c66 203d  se):.    evalf =
-00016670: 2073 7461 7469 636d 6574 686f 6428 6e75   staticmethod(nu
-00016680: 6d70 792e 6d6f 6429 0a20 2020 2064 6566  mpy.mod).    def
-00016690: 2072 6574 7572 6e5f 7479 7065 2854 312c   return_type(T1,
-000166a0: 2054 3229 3a0a 2020 2020 2020 2020 6966   T2):.        if
-000166b0: 2054 3120 3d3d 2063 6f6d 706c 6578 206f   T1 == complex o
-000166c0: 7220 5432 203d 3d20 636f 6d70 6c65 783a  r T2 == complex:
-000166d0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000166e0: 7365 2056 616c 7565 4572 726f 7228 276d  se ValueError('m
-000166f0: 6f64 2069 7320 6e6f 7420 6465 6669 6e65  od is not define
-00016700: 6420 666f 7220 636f 6d70 6c65 7820 6e75  d for complex nu
-00016710: 6d62 6572 7327 290a 2020 2020 2020 2020  mbers').        
-00016720: 7265 7475 726e 2066 6c6f 6174 2069 6620  return float if 
-00016730: 666c 6f61 7420 696e 2028 5431 2c20 5432  float in (T1, T2
-00016740: 2920 656c 7365 2069 6e74 0a0a 2020 2020  ) else int..    
-00016750: 6465 6620 5f69 6e74 626f 756e 6473 5f69  def _intbounds_i
-00016760: 6d70 6c28 7365 6c66 293a 0a20 2020 2020  mpl(self):.     
-00016770: 2020 2064 6976 6964 656e 642c 2064 6976     dividend, div
-00016780: 6973 6f72 203d 2073 656c 662e 6172 6773  isor = self.args
-00016790: 0a20 2020 2020 2020 206c 6f77 6572 5f64  .        lower_d
-000167a0: 6976 6973 6f72 2c20 7570 7065 725f 6469  ivisor, upper_di
-000167b0: 7669 736f 7220 3d20 6469 7669 736f 722e  visor = divisor.
-000167c0: 5f69 6e74 626f 756e 6473 0a20 2020 2020  _intbounds.     
-000167d0: 2020 2069 6620 6c6f 7765 725f 6469 7669     if lower_divi
-000167e0: 736f 7220 3e20 303a 0a20 2020 2020 2020  sor > 0:.       
-000167f0: 2020 2020 206c 6f77 6572 5f64 6976 6964       lower_divid
-00016800: 656e 642c 2075 7070 6572 5f64 6976 6964  end, upper_divid
-00016810: 656e 6420 3d20 6469 7669 6465 6e64 2e5f  end = dividend._
-00016820: 696e 7462 6f75 6e64 730a 2020 2020 2020  intbounds.      
-00016830: 2020 2020 2020 6966 2030 203c 3d20 6c6f        if 0 <= lo
-00016840: 7765 725f 6469 7669 6465 6e64 2061 6e64  wer_dividend and
-00016850: 2075 7070 6572 5f64 6976 6964 656e 6420   upper_dividend 
-00016860: 3c20 6c6f 7765 725f 6469 7669 736f 723a  < lower_divisor:
-00016870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016880: 2072 6574 7572 6e20 6c6f 7765 725f 6469   return lower_di
-00016890: 7669 6465 6e64 2c20 7570 7065 725f 6469  vidend, upper_di
-000168a0: 7669 6465 6e64 0a20 2020 2020 2020 2020  vidend.         
-000168b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000168c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000168d0: 302c 2075 7070 6572 5f64 6976 6973 6f72  0, upper_divisor
-000168e0: 202d 2031 0a20 2020 2020 2020 2065 6c73   - 1.        els
-000168f0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00016900: 6574 7572 6e20 7375 7065 7228 292e 5f69  eturn super()._i
-00016910: 6e74 626f 756e 6473 5f69 6d70 6c28 290a  ntbounds_impl().
-00016920: 0a20 2020 2064 6566 205f 7369 6d70 6c69  .    def _simpli
-00016930: 6669 6564 2873 656c 6629 3a0a 2020 2020  fied(self):.    
-00016940: 2020 2020 6469 7669 6465 6e64 2c20 6469      dividend, di
-00016950: 7669 736f 7220 3d20 7365 6c66 2e61 7267  visor = self.arg
-00016960: 730a 2020 2020 2020 2020 6c6f 7765 725f  s.        lower_
-00016970: 6469 7669 736f 722c 2075 7070 6572 5f64  divisor, upper_d
-00016980: 6976 6973 6f72 203d 2064 6976 6973 6f72  ivisor = divisor
-00016990: 2e5f 696e 7462 6f75 6e64 730a 2020 2020  ._intbounds.    
-000169a0: 2020 2020 6966 206c 6f77 6572 5f64 6976      if lower_div
-000169b0: 6973 6f72 203e 2030 3a0a 2020 2020 2020  isor > 0:.      
-000169c0: 2020 2020 2020 6c6f 7765 725f 6469 7669        lower_divi
-000169d0: 6465 6e64 2c20 7570 7065 725f 6469 7669  dend, upper_divi
-000169e0: 6465 6e64 203d 2064 6976 6964 656e 642e  dend = dividend.
-000169f0: 5f69 6e74 626f 756e 6473 0a20 2020 2020  _intbounds.     
-00016a00: 2020 2020 2020 2069 6620 3020 3c3d 206c         if 0 <= l
-00016a10: 6f77 6572 5f64 6976 6964 656e 6420 616e  ower_dividend an
-00016a20: 6420 7570 7065 725f 6469 7669 6465 6e64  d upper_dividend
-00016a30: 203c 206c 6f77 6572 5f64 6976 6973 6f72   < lower_divisor
-00016a40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00016a50: 2020 7265 7475 726e 2064 6976 6964 656e    return dividen
-00016a60: 640a 0a0a 636c 6173 7320 4172 6354 616e  d...class ArcTan
-00016a70: 3228 506f 696e 7477 6973 6529 3a0a 2020  2(Pointwise):.  
-00016a80: 2020 6576 616c 6620 3d20 7374 6174 6963    evalf = static
-00016a90: 6d65 7468 6f64 286e 756d 7079 2e61 7263  method(numpy.arc
-00016aa0: 7461 6e32 290a 2020 2020 6465 7269 7620  tan2).    deriv 
-00016ab0: 3d20 6c61 6d62 6461 2078 2c20 793a 2079  = lambda x, y: y
-00016ac0: 202f 2028 782a 2a32 202b 2079 2a2a 3229   / (x**2 + y**2)
-00016ad0: 2c20 6c61 6d62 6461 2078 2c20 793a 202d  , lambda x, y: -
-00016ae0: 7820 2f20 2878 2a2a 3220 2b20 792a 2a32  x / (x**2 + y**2
-00016af0: 290a 2020 2020 6465 6620 7265 7475 726e  ).    def return
-00016b00: 5f74 7970 6528 5431 2c20 5432 293a 0a20  _type(T1, T2):. 
-00016b10: 2020 2020 2020 2069 6620 5431 203d 3d20         if T1 == 
-00016b20: 636f 6d70 6c65 7820 6f72 2054 3220 3d3d  complex or T2 ==
-00016b30: 2063 6f6d 706c 6578 3a0a 2020 2020 2020   complex:.      
-00016b40: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00016b50: 6545 7272 6f72 2827 6172 6374 616e 3220  eError('arctan2 
-00016b60: 6973 206e 6f74 2064 6566 696e 6564 2066  is not defined f
-00016b70: 6f72 2063 6f6d 706c 6578 206e 756d 6265  or complex numbe
-00016b80: 7273 2729 0a20 2020 2020 2020 2072 6574  rs').        ret
-00016b90: 7572 6e20 666c 6f61 740a 0a0a 636c 6173  urn float...clas
-00016ba0: 7320 4772 6561 7465 7228 506f 696e 7477  s Greater(Pointw
-00016bb0: 6973 6529 3a0a 2020 2020 6576 616c 6620  ise):.    evalf 
-00016bc0: 3d20 7374 6174 6963 6d65 7468 6f64 286e  = staticmethod(n
-00016bd0: 756d 7079 2e67 7265 6174 6572 290a 2020  umpy.greater).  
-00016be0: 2020 6465 6620 7265 7475 726e 5f74 7970    def return_typ
-00016bf0: 6528 5431 2c20 5432 293a 0a20 2020 2020  e(T1, T2):.     
-00016c00: 2020 2069 6620 5431 203d 3d20 636f 6d70     if T1 == comp
-00016c10: 6c65 7820 6f72 2054 3220 3d3d 2063 6f6d  lex or T2 == com
-00016c20: 706c 6578 3a0a 2020 2020 2020 2020 2020  plex:.          
-00016c30: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00016c40: 6f72 2827 436f 6d70 6c65 7820 6e75 6d62  or('Complex numb
-00016c50: 6572 7320 6861 7665 206e 6f20 746f 7461  ers have no tota
-00016c60: 6c20 6f72 6465 722e 2729 0a20 2020 2020  l order.').     
-00016c70: 2020 2072 6574 7572 6e20 626f 6f6c 0a0a     return bool..
-00016c80: 0a63 6c61 7373 2045 7175 616c 2850 6f69  .class Equal(Poi
-00016c90: 6e74 7769 7365 293a 0a20 2020 2065 7661  ntwise):.    eva
-00016ca0: 6c66 203d 2073 7461 7469 636d 6574 686f  lf = staticmetho
-00016cb0: 6428 6e75 6d70 792e 6571 7561 6c29 0a20  d(numpy.equal). 
-00016cc0: 2020 2072 6574 7572 6e5f 7479 7065 203d     return_type =
-00016cd0: 206c 616d 6264 6120 5431 2c20 5432 3a20   lambda T1, T2: 
-00016ce0: 626f 6f6c 0a0a 2020 2020 6465 6620 5f73  bool..    def _s
-00016cf0: 696d 706c 6966 6965 6428 7365 6c66 293a  implified(self):
-00016d00: 0a20 2020 2020 2020 2061 312c 2061 3220  .        a1, a2 
-00016d10: 3d20 7365 6c66 2e61 7267 730a 2020 2020  = self.args.    
-00016d20: 2020 2020 6966 2061 3120 3d3d 2061 323a      if a1 == a2:
-00016d30: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00016d40: 7572 6e20 6f6e 6573 2873 656c 662e 7368  urn ones(self.sh
-00016d50: 6170 652c 2062 6f6f 6c29 0a20 2020 2020  ape, bool).     
-00016d60: 2020 2069 6620 7365 6c66 2e6e 6469 6d20     if self.ndim 
-00016d70: 3d3d 2032 3a0a 2020 2020 2020 2020 2020  == 2:.          
-00016d80: 2020 7531 2c20 7731 203d 2075 6e61 6c69    u1, w1 = unali
-00016d90: 676e 2861 3129 0a20 2020 2020 2020 2020  gn(a1).         
-00016da0: 2020 2075 322c 2077 3220 3d20 756e 616c     u2, w2 = unal
-00016db0: 6967 6e28 6132 290a 2020 2020 2020 2020  ign(a2).        
-00016dc0: 2020 2020 6966 2075 3120 3d3d 2075 3220      if u1 == u2 
-00016dd0: 616e 6420 6973 696e 7374 616e 6365 2875  and isinstance(u
-00016de0: 312c 2052 616e 6765 293a 0a20 2020 2020  1, Range):.     
-00016df0: 2020 2020 2020 2020 2020 2023 204e 4f54             # NOT
-00016e00: 453a 204f 6e63 6520 7765 2069 6e74 726f  E: Once we intro
-00016e10: 6475 6365 2069 7375 6e69 7175 6520 7765  duce isunique we
-00016e20: 2063 616e 2072 656c 6178 2074 6865 2052   can relax the R
-00016e30: 616e 6765 2062 6f75 6e64 0a20 2020 2020  ange bound.     
-00016e40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00016e50: 6e20 4469 6167 6f6e 616c 697a 6528 6f6e  n Diagonalize(on
-00016e60: 6573 2875 312e 7368 6170 652c 2062 6f6f  es(u1.shape, boo
-00016e70: 6c29 290a 2020 2020 2020 2020 7265 7475  l)).        retu
-00016e80: 726e 2073 7570 6572 2829 2e5f 7369 6d70  rn super()._simp
-00016e90: 6c69 6669 6564 2829 0a0a 0a63 6c61 7373  lified()...class
-00016ea0: 204c 6573 7328 506f 696e 7477 6973 6529   Less(Pointwise)
-00016eb0: 3a0a 2020 2020 6576 616c 6620 3d20 7374  :.    evalf = st
-00016ec0: 6174 6963 6d65 7468 6f64 286e 756d 7079  aticmethod(numpy
-00016ed0: 2e6c 6573 7329 0a20 2020 2064 6566 2072  .less).    def r
-00016ee0: 6574 7572 6e5f 7479 7065 2854 312c 2054  eturn_type(T1, T
-00016ef0: 3229 3a0a 2020 2020 2020 2020 6966 2054  2):.        if T
-00016f00: 3120 3d3d 2063 6f6d 706c 6578 206f 7220  1 == complex or 
-00016f10: 5432 203d 3d20 636f 6d70 6c65 783a 0a20  T2 == complex:. 
-00016f20: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00016f30: 2056 616c 7565 4572 726f 7228 2743 6f6d   ValueError('Com
-00016f40: 706c 6578 206e 756d 6265 7273 2068 6176  plex numbers hav
-00016f50: 6520 6e6f 2074 6f74 616c 206f 7264 6572  e no total order
-00016f60: 2e27 290a 2020 2020 2020 2020 7265 7475  .').        retu
-00016f70: 726e 2062 6f6f 6c0a 0a0a 636c 6173 7320  rn bool...class 
-00016f80: 4d69 6e69 6d75 6d28 506f 696e 7477 6973  Minimum(Pointwis
-00016f90: 6529 3a0a 2020 2020 6576 616c 6620 3d20  e):.    evalf = 
-00016fa0: 7374 6174 6963 6d65 7468 6f64 286e 756d  staticmethod(num
-00016fb0: 7079 2e6d 696e 696d 756d 290a 2020 2020  py.minimum).    
-00016fc0: 6465 7269 7620 3d20 6c61 6d62 6461 2078  deriv = lambda x
-00016fd0: 2c20 793a 202e 3520 2d20 2e35 202a 2053  , y: .5 - .5 * S
-00016fe0: 6967 6e28 7820 2d20 7929 2c20 6c61 6d62  ign(x - y), lamb
-00016ff0: 6461 2078 2c20 793a 202e 3520 2b20 2e35  da x, y: .5 + .5
-00017000: 202a 2053 6967 6e28 7820 2d20 7929 0a20   * Sign(x - y). 
-00017010: 2020 2064 6566 2072 6574 7572 6e5f 7479     def return_ty
-00017020: 7065 2854 312c 2054 3229 3a0a 2020 2020  pe(T1, T2):.    
-00017030: 2020 2020 6966 2054 3120 3d3d 2063 6f6d      if T1 == com
-00017040: 706c 6578 206f 7220 5432 203d 3d20 636f  plex or T2 == co
-00017050: 6d70 6c65 783a 0a20 2020 2020 2020 2020  mplex:.         
-00017060: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00017070: 726f 7228 2743 6f6d 706c 6578 206e 756d  ror('Complex num
-00017080: 6265 7273 2068 6176 6520 6e6f 2074 6f74  bers have no tot
-00017090: 616c 206f 7264 6572 2e27 290a 2020 2020  al order.').    
-000170a0: 2020 2020 7265 7475 726e 2066 6c6f 6174      return float
-000170b0: 2069 6620 666c 6f61 7420 696e 2028 5431   if float in (T1
-000170c0: 2c20 5432 2920 656c 7365 2069 6e74 2069  , T2) else int i
-000170d0: 6620 696e 7420 696e 2028 5431 2c20 5432  f int in (T1, T2
-000170e0: 2920 656c 7365 2062 6f6f 6c0a 0a20 2020  ) else bool..   
-000170f0: 2064 6566 205f 7369 6d70 6c69 6669 6564   def _simplified
-00017100: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00017110: 6966 2073 656c 662e 6474 7970 6520 3d3d  if self.dtype ==
-00017120: 2069 6e74 3a0a 2020 2020 2020 2020 2020   int:.          
-00017130: 2020 6c6f 7765 7231 2c20 7570 7065 7231    lower1, upper1
-00017140: 203d 2073 656c 662e 6172 6773 5b30 5d2e   = self.args[0].
-00017150: 5f69 6e74 626f 756e 6473 0a20 2020 2020  _intbounds.     
-00017160: 2020 2020 2020 206c 6f77 6572 322c 2075         lower2, u
-00017170: 7070 6572 3220 3d20 7365 6c66 2e61 7267  pper2 = self.arg
-00017180: 735b 315d 2e5f 696e 7462 6f75 6e64 730a  s[1]._intbounds.
-00017190: 2020 2020 2020 2020 2020 2020 6966 2075              if u
-000171a0: 7070 6572 3120 3c3d 206c 6f77 6572 323a  pper1 <= lower2:
-000171b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000171c0: 2072 6574 7572 6e20 7365 6c66 2e61 7267   return self.arg
-000171d0: 735b 305d 0a20 2020 2020 2020 2020 2020  s[0].           
-000171e0: 2065 6c69 6620 7570 7065 7232 203c 3d20   elif upper2 <= 
-000171f0: 6c6f 7765 7231 3a0a 2020 2020 2020 2020  lower1:.        
-00017200: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00017210: 656c 662e 6172 6773 5b31 5d0a 2020 2020  elf.args[1].    
-00017220: 2020 2020 7265 7475 726e 2073 7570 6572      return super
-00017230: 2829 2e5f 7369 6d70 6c69 6669 6564 2829  ()._simplified()
-00017240: 0a0a 2020 2020 6465 6620 5f69 6e74 626f  ..    def _intbo
-00017250: 756e 6473 5f69 6d70 6c28 7365 6c66 293a  unds_impl(self):
-00017260: 0a20 2020 2020 2020 206c 6f77 6572 312c  .        lower1,
-00017270: 2075 7070 6572 3120 3d20 7365 6c66 2e61   upper1 = self.a
-00017280: 7267 735b 305d 2e5f 696e 7462 6f75 6e64  rgs[0]._intbound
-00017290: 730a 2020 2020 2020 2020 6c6f 7765 7232  s.        lower2
-000172a0: 2c20 7570 7065 7232 203d 2073 656c 662e  , upper2 = self.
-000172b0: 6172 6773 5b31 5d2e 5f69 6e74 626f 756e  args[1]._intboun
-000172c0: 6473 0a20 2020 2020 2020 2072 6574 7572  ds.        retur
-000172d0: 6e20 6d69 6e28 6c6f 7765 7231 2c20 6c6f  n min(lower1, lo
-000172e0: 7765 7232 292c 206d 696e 2875 7070 6572  wer2), min(upper
-000172f0: 312c 2075 7070 6572 3229 0a0a 0a63 6c61  1, upper2)...cla
-00017300: 7373 204d 6178 696d 756d 2850 6f69 6e74  ss Maximum(Point
-00017310: 7769 7365 293a 0a20 2020 2065 7661 6c66  wise):.    evalf
-00017320: 203d 2073 7461 7469 636d 6574 686f 6428   = staticmethod(
-00017330: 6e75 6d70 792e 6d61 7869 6d75 6d29 0a20  numpy.maximum). 
-00017340: 2020 2064 6572 6976 203d 206c 616d 6264     deriv = lambd
-00017350: 6120 782c 2079 3a20 2e35 202b 202e 3520  a x, y: .5 + .5 
-00017360: 2a20 5369 676e 2878 202d 2079 292c 206c  * Sign(x - y), l
-00017370: 616d 6264 6120 782c 2079 3a20 2e35 202d  ambda x, y: .5 -
-00017380: 202e 3520 2a20 5369 676e 2878 202d 2079   .5 * Sign(x - y
-00017390: 290a 2020 2020 6465 6620 7265 7475 726e  ).    def return
-000173a0: 5f74 7970 6528 5431 2c20 5432 293a 0a20  _type(T1, T2):. 
-000173b0: 2020 2020 2020 2069 6620 5431 203d 3d20         if T1 == 
-000173c0: 636f 6d70 6c65 7820 6f72 2054 3220 3d3d  complex or T2 ==
-000173d0: 2063 6f6d 706c 6578 3a0a 2020 2020 2020   complex:.      
-000173e0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-000173f0: 6545 7272 6f72 2827 436f 6d70 6c65 7820  eError('Complex 
-00017400: 6e75 6d62 6572 7320 6861 7665 206e 6f20  numbers have no 
-00017410: 746f 7461 6c20 6f72 6465 722e 2729 0a20  total order.'). 
-00017420: 2020 2020 2020 2072 6574 7572 6e20 666c         return fl
-00017430: 6f61 7420 6966 2066 6c6f 6174 2069 6e20  oat if float in 
-00017440: 2854 312c 2054 3229 2065 6c73 6520 696e  (T1, T2) else in
-00017450: 7420 6966 2069 6e74 2069 6e20 2854 312c  t if int in (T1,
-00017460: 2054 3229 2065 6c73 6520 626f 6f6c 0a0a   T2) else bool..
-00017470: 2020 2020 6465 6620 5f73 696d 706c 6966      def _simplif
-00017480: 6965 6428 7365 6c66 293a 0a20 2020 2020  ied(self):.     
-00017490: 2020 2069 6620 7365 6c66 2e64 7479 7065     if self.dtype
-000174a0: 203d 3d20 696e 743a 0a20 2020 2020 2020   == int:.       
-000174b0: 2020 2020 206c 6f77 6572 312c 2075 7070       lower1, upp
-000174c0: 6572 3120 3d20 7365 6c66 2e61 7267 735b  er1 = self.args[
-000174d0: 305d 2e5f 696e 7462 6f75 6e64 730a 2020  0]._intbounds.  
-000174e0: 2020 2020 2020 2020 2020 6c6f 7765 7232            lower2
-000174f0: 2c20 7570 7065 7232 203d 2073 656c 662e  , upper2 = self.
-00017500: 6172 6773 5b31 5d2e 5f69 6e74 626f 756e  args[1]._intboun
-00017510: 6473 0a20 2020 2020 2020 2020 2020 2069  ds.            i
-00017520: 6620 7570 7065 7232 203c 3d20 6c6f 7765  f upper2 <= lowe
-00017530: 7231 3a0a 2020 2020 2020 2020 2020 2020  r1:.            
-00017540: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00017550: 6172 6773 5b30 5d0a 2020 2020 2020 2020  args[0].        
-00017560: 2020 2020 656c 6966 2075 7070 6572 3120      elif upper1 
-00017570: 3c3d 206c 6f77 6572 323a 0a20 2020 2020  <= lower2:.     
-00017580: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00017590: 6e20 7365 6c66 2e61 7267 735b 315d 0a20  n self.args[1]. 
-000175a0: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
-000175b0: 7065 7228 292e 5f73 696d 706c 6966 6965  per()._simplifie
-000175c0: 6428 290a 0a20 2020 2064 6566 205f 696e  d()..    def _in
-000175d0: 7462 6f75 6e64 735f 696d 706c 2873 656c  tbounds_impl(sel
-000175e0: 6629 3a0a 2020 2020 2020 2020 6c6f 7765  f):.        lowe
-000175f0: 7231 2c20 7570 7065 7231 203d 2073 656c  r1, upper1 = sel
-00017600: 662e 6172 6773 5b30 5d2e 5f69 6e74 626f  f.args[0]._intbo
-00017610: 756e 6473 0a20 2020 2020 2020 206c 6f77  unds.        low
-00017620: 6572 322c 2075 7070 6572 3220 3d20 7365  er2, upper2 = se
-00017630: 6c66 2e61 7267 735b 315d 2e5f 696e 7462  lf.args[1]._intb
-00017640: 6f75 6e64 730a 2020 2020 2020 2020 7265  ounds.        re
-00017650: 7475 726e 206d 6178 286c 6f77 6572 312c  turn max(lower1,
-00017660: 206c 6f77 6572 3229 2c20 6d61 7828 7570   lower2), max(up
-00017670: 7065 7231 2c20 7570 7065 7232 290a 0a0a  per1, upper2)...
-00017680: 636c 6173 7320 436f 6e6a 7567 6174 6528  class Conjugate(
-00017690: 506f 696e 7477 6973 6529 3a0a 2020 2020  Pointwise):.    
-000176a0: 6576 616c 6620 3d20 7374 6174 6963 6d65  evalf = staticme
-000176b0: 7468 6f64 286e 756d 7079 2e63 6f6e 6a75  thod(numpy.conju
-000176c0: 6761 7465 290a 2020 2020 7265 7475 726e  gate).    return
-000176d0: 5f74 7970 6520 3d20 6c61 6d62 6461 2054  _type = lambda T
-000176e0: 3a20 696e 7420 6966 2054 203d 3d20 626f  : int if T == bo
-000176f0: 6f6c 2065 6c73 6520 540a 0a20 2020 2064  ol else T..    d
-00017700: 6566 205f 7369 6d70 6c69 6669 6564 2873  ef _simplified(s
-00017710: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-00017720: 7476 616c 203d 2073 656c 662e 6172 6773  tval = self.args
-00017730: 5b30 5d2e 5f63 6f6e 6a75 6761 7465 2829  [0]._conjugate()
-00017740: 0a20 2020 2020 2020 2069 6620 7265 7476  .        if retv
-00017750: 616c 2069 7320 6e6f 7420 4e6f 6e65 3a0a  al is not None:.
-00017760: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017770: 726e 2072 6574 7661 6c0a 2020 2020 2020  rn retval.      
-00017780: 2020 7265 7475 726e 2073 7570 6572 2829    return super()
-00017790: 2e5f 7369 6d70 6c69 6669 6564 2829 0a0a  ._simplified()..
-000177a0: 0a63 6c61 7373 2052 6561 6c28 506f 696e  .class Real(Poin
-000177b0: 7477 6973 6529 3a0a 2020 2020 6576 616c  twise):.    eval
-000177c0: 6620 3d20 7374 6174 6963 6d65 7468 6f64  f = staticmethod
-000177d0: 286e 756d 7079 2e72 6561 6c29 0a20 2020  (numpy.real).   
-000177e0: 2072 6574 7572 6e5f 7479 7065 203d 206c   return_type = l
-000177f0: 616d 6264 6120 543a 2066 6c6f 6174 2069  ambda T: float i
-00017800: 6620 5420 3d3d 2063 6f6d 706c 6578 2065  f T == complex e
-00017810: 6c73 6520 540a 0a20 2020 2064 6566 205f  lse T..    def _
-00017820: 7369 6d70 6c69 6669 6564 2873 656c 6629  simplified(self)
-00017830: 3a0a 2020 2020 2020 2020 7265 7476 616c  :.        retval
-00017840: 203d 2073 656c 662e 6172 6773 5b30 5d2e   = self.args[0].
-00017850: 5f72 6561 6c28 290a 2020 2020 2020 2020  _real().        
-00017860: 6966 2072 6574 7661 6c20 6973 206e 6f74  if retval is not
-00017870: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00017880: 2020 2072 6574 7572 6e20 7265 7476 616c     return retval
-00017890: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000178a0: 7375 7065 7228 292e 5f73 696d 706c 6966  super()._simplif
-000178b0: 6965 6428 290a 0a0a 636c 6173 7320 496d  ied()...class Im
-000178c0: 6167 2850 6f69 6e74 7769 7365 293a 0a20  ag(Pointwise):. 
-000178d0: 2020 2065 7661 6c66 203d 2073 7461 7469     evalf = stati
-000178e0: 636d 6574 686f 6428 6e75 6d70 792e 696d  cmethod(numpy.im
-000178f0: 6167 290a 2020 2020 7265 7475 726e 5f74  ag).    return_t
-00017900: 7970 6520 3d20 6c61 6d62 6461 2054 3a20  ype = lambda T: 
-00017910: 666c 6f61 7420 6966 2054 203d 3d20 636f  float if T == co
-00017920: 6d70 6c65 7820 656c 7365 2054 0a0a 2020  mplex else T..  
-00017930: 2020 6465 6620 5f73 696d 706c 6966 6965    def _simplifie
-00017940: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-00017950: 2072 6574 7661 6c20 3d20 7365 6c66 2e61   retval = self.a
-00017960: 7267 735b 305d 2e5f 696d 6167 2829 0a20  rgs[0]._imag(). 
-00017970: 2020 2020 2020 2069 6620 7265 7476 616c         if retval
-00017980: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00017990: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000179a0: 2072 6574 7661 6c0a 2020 2020 2020 2020   retval.        
-000179b0: 7265 7475 726e 2073 7570 6572 2829 2e5f  return super()._
-000179c0: 7369 6d70 6c69 6669 6564 2829 0a0a 0a63  simplified()...c
-000179d0: 6c61 7373 2043 6173 7428 506f 696e 7477  lass Cast(Pointw
-000179e0: 6973 6529 3a0a 0a20 2020 2064 6566 2065  ise):..    def e
-000179f0: 7661 6c66 2873 656c 662c 2061 7267 293a  valf(self, arg):
-00017a00: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00017a10: 6e75 6d70 792e 6172 7261 7928 6172 672c  numpy.array(arg,
-00017a20: 2064 7479 7065 3d73 656c 662e 6474 7970   dtype=self.dtyp
-00017a30: 6529 0a0a 2020 2020 6465 6620 5f73 696d  e)..    def _sim
-00017a40: 706c 6966 6965 6428 7365 6c66 293a 0a20  plified(self):. 
-00017a50: 2020 2020 2020 2061 7267 2c20 3d20 7365         arg, = se
-00017a60: 6c66 2e61 7267 730a 2020 2020 2020 2020  lf.args.        
-00017a70: 6966 2069 737a 6572 6f28 6172 6729 3a0a  if iszero(arg):.
-00017a80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017a90: 726e 207a 6572 6f73 5f6c 696b 6528 7365  rn zeros_like(se
-00017aa0: 6c66 290a 2020 2020 2020 2020 666f 7220  lf).        for 
-00017ab0: 6178 6973 2c20 7061 7274 7320 696e 2061  axis, parts in a
-00017ac0: 7267 2e5f 696e 666c 6174 696f 6e73 3a0a  rg._inflations:.
-00017ad0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017ae0: 726e 2075 7469 6c2e 7375 6d28 5f69 6e66  rn util.sum(_inf
-00017af0: 6c61 7465 2873 656c 662e 5f6e 6577 6172  late(self._newar
-00017b00: 6773 2866 756e 6329 2c20 646f 666d 6170  gs(func), dofmap
-00017b10: 2c20 7365 6c66 2e73 6861 7065 5b61 7869  , self.shape[axi
-00017b20: 735d 2c20 6178 6973 2920 666f 7220 646f  s], axis) for do
-00017b30: 666d 6170 2c20 6675 6e63 2069 6e20 7061  fmap, func in pa
-00017b40: 7274 732e 6974 656d 7328 2929 0a20 2020  rts.items()).   
-00017b50: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
-00017b60: 7228 292e 5f73 696d 706c 6966 6965 6428  r()._simplified(
-00017b70: 290a 0a20 2020 2064 6566 205f 696e 7462  )..    def _intb
-00017b80: 6f75 6e64 735f 696d 706c 2873 656c 6629  ounds_impl(self)
-00017b90: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
-00017ba0: 662e 6172 6773 5b30 5d2e 6474 7970 6520  f.args[0].dtype 
-00017bb0: 3d3d 2062 6f6f 6c3a 0a20 2020 2020 2020  == bool:.       
-00017bc0: 2020 2020 2072 6574 7572 6e20 302c 2031       return 0, 1
-00017bd0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00017be0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00017bf0: 6e20 7365 6c66 2e61 7267 735b 305d 2e5f  n self.args[0]._
-00017c00: 696e 7462 6f75 6e64 730a 0a20 2020 2040  intbounds..    @
-00017c10: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00017c20: 205f 636f 6e73 745f 756e 6966 6f72 6d28   _const_uniform(
-00017c30: 7365 6c66 293a 0a20 2020 2020 2020 2076  self):.        v
-00017c40: 616c 7565 203d 2073 656c 662e 6172 6773  alue = self.args
-00017c50: 5b30 5d2e 5f63 6f6e 7374 5f75 6e69 666f  [0]._const_unifo
-00017c60: 726d 0a20 2020 2020 2020 2069 6620 7661  rm.        if va
-00017c70: 6c75 6520 6973 206e 6f74 204e 6f6e 653a  lue is not None:
-00017c80: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00017c90: 7572 6e20 7365 6c66 2e64 7479 7065 2876  urn self.dtype(v
-00017ca0: 616c 7565 290a 0a0a 636c 6173 7320 426f  alue)...class Bo
-00017cb0: 6f6c 546f 496e 7428 4361 7374 293a 0a20  olToInt(Cast):. 
-00017cc0: 2020 2064 6566 2072 6574 7572 6e5f 7479     def return_ty
-00017cd0: 7065 2854 293a 0a20 2020 2020 2020 2069  pe(T):.        i
-00017ce0: 6620 5420 213d 2062 6f6f 6c3a 0a20 2020  f T != bool:.   
-00017cf0: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
-00017d00: 7970 6545 7272 6f72 2866 2745 7870 6563  ypeError(f'Expec
-00017d10: 7465 6420 616e 2061 7272 6179 2077 6974  ted an array wit
-00017d20: 6820 6474 7970 6520 626f 6f6c 2062 7574  h dtype bool but
-00017d30: 2067 6f74 207b 542e 5f5f 6e61 6d65 5f5f   got {T.__name__
-00017d40: 7d2e 2729 0a20 2020 2020 2020 2072 6574  }.').        ret
-00017d50: 7572 6e20 696e 740a 0a0a 636c 6173 7320  urn int...class 
-00017d60: 496e 7454 6f46 6c6f 6174 2843 6173 7429  IntToFloat(Cast)
-00017d70: 3a0a 2020 2020 6465 6620 7265 7475 726e  :.    def return
-00017d80: 5f74 7970 6528 5429 3a0a 2020 2020 2020  _type(T):.      
-00017d90: 2020 6966 2054 2021 3d20 696e 743a 0a20    if T != int:. 
-00017da0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00017db0: 2054 7970 6545 7272 6f72 2866 2745 7870   TypeError(f'Exp
-00017dc0: 6563 7465 6420 616e 2061 7272 6179 2077  ected an array w
-00017dd0: 6974 6820 6474 7970 6520 696e 7420 6275  ith dtype int bu
-00017de0: 7420 676f 7420 7b54 2e5f 5f6e 616d 655f  t got {T.__name_
-00017df0: 5f7d 2e27 290a 2020 2020 2020 2020 7265  _}.').        re
-00017e00: 7475 726e 2066 6c6f 6174 0a0a 2020 2020  turn float..    
-00017e10: 6465 6620 5f61 6464 2873 656c 662c 206f  def _add(self, o
-00017e20: 7468 6572 293a 0a20 2020 2020 2020 2069  ther):.        i
-00017e30: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
-00017e40: 6572 2c20 5f5f 636c 6173 735f 5f29 3a0a  er, __class__):.
-00017e50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017e60: 726e 2073 656c 662e 5f6e 6577 6172 6773  rn self._newargs
-00017e70: 2873 656c 662e 6172 6773 5b30 5d20 2b20  (self.args[0] + 
-00017e80: 6f74 6865 722e 6172 6773 5b30 5d29 0a0a  other.args[0])..
-00017e90: 2020 2020 6465 6620 5f6d 756c 7469 706c      def _multipl
-00017ea0: 7928 7365 6c66 2c20 6f74 6865 7229 3a0a  y(self, other):.
-00017eb0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00017ec0: 7461 6e63 6528 6f74 6865 722c 205f 5f63  tance(other, __c
-00017ed0: 6c61 7373 5f5f 293a 0a20 2020 2020 2020  lass__):.       
-00017ee0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00017ef0: 2e5f 6e65 7761 7267 7328 7365 6c66 2e61  ._newargs(self.a
-00017f00: 7267 735b 305d 202a 206f 7468 6572 2e61  rgs[0] * other.a
-00017f10: 7267 735b 305d 290a 0a20 2020 2064 6566  rgs[0])..    def
-00017f20: 205f 7375 6d28 7365 6c66 2c20 6178 6973   _sum(self, axis
-00017f30: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00017f40: 6e20 7365 6c66 2e5f 6e65 7761 7267 7328  n self._newargs(
-00017f50: 7375 6d28 7365 6c66 2e61 7267 735b 305d  sum(self.args[0]
-00017f60: 2c20 6178 6973 2929 0a0a 2020 2020 6465  , axis))..    de
-00017f70: 6620 5f70 726f 6475 6374 2873 656c 6629  f _product(self)
-00017f80: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00017f90: 2073 656c 662e 5f6e 6577 6172 6773 2870   self._newargs(p
-00017fa0: 726f 6475 6374 2873 656c 662e 6172 6773  roduct(self.args
-00017fb0: 5b30 5d2c 202d 3129 290a 0a20 2020 2064  [0], -1))..    d
-00017fc0: 6566 205f 7369 676e 2873 656c 6629 3a0a  ef _sign(self):.
-00017fd0: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
-00017fe0: 656c 662e 6474 7970 6520 213d 2063 6f6d  elf.dtype != com
-00017ff0: 706c 6578 0a20 2020 2020 2020 2072 6574  plex.        ret
-00018000: 7572 6e20 7365 6c66 2e5f 6e65 7761 7267  urn self._newarg
-00018010: 7328 7369 676e 2873 656c 662e 6172 6773  s(sign(self.args
-00018020: 5b30 5d29 290a 0a20 2020 2064 6566 205f  [0]))..    def _
-00018030: 6465 7269 7661 7469 7665 2873 656c 662c  derivative(self,
-00018040: 2076 6172 2c20 7365 656e 293a 0a20 2020   var, seen):.   
-00018050: 2020 2020 2072 6574 7572 6e20 5a65 726f       return Zero
-00018060: 7328 7365 6c66 2e73 6861 7065 202b 2076  s(self.shape + v
-00018070: 6172 2e73 6861 7065 2c20 6474 7970 653d  ar.shape, dtype=
-00018080: 7365 6c66 2e64 7479 7065 290a 0a0a 636c  self.dtype)...cl
-00018090: 6173 7320 466c 6f61 7454 6f43 6f6d 706c  ass FloatToCompl
-000180a0: 6578 2843 6173 7429 3a0a 2020 2020 6465  ex(Cast):.    de
-000180b0: 6620 7265 7475 726e 5f74 7970 6528 5429  f return_type(T)
-000180c0: 3a0a 2020 2020 2020 2020 6966 2054 2021  :.        if T !
-000180d0: 3d20 666c 6f61 743a 0a20 2020 2020 2020  = float:.       
-000180e0: 2020 2020 2072 6169 7365 2054 7970 6545       raise TypeE
-000180f0: 7272 6f72 2866 2745 7870 6563 7465 6420  rror(f'Expected 
-00018100: 616e 2061 7272 6179 2077 6974 6820 6474  an array with dt
-00018110: 7970 6520 666c 6f61 7420 6275 7420 676f  ype float but go
-00018120: 7420 7b54 2e5f 5f6e 616d 655f 5f7d 2e27  t {T.__name__}.'
-00018130: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00018140: 2063 6f6d 706c 6578 0a0a 2020 2020 6465   complex..    de
-00018150: 6620 5f61 6464 2873 656c 662c 206f 7468  f _add(self, oth
-00018160: 6572 293a 0a20 2020 2020 2020 2069 6620  er):.        if 
-00018170: 6973 696e 7374 616e 6365 286f 7468 6572  isinstance(other
-00018180: 2c20 5f5f 636c 6173 735f 5f29 3a0a 2020  , __class__):.  
-00018190: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000181a0: 2073 656c 662e 5f6e 6577 6172 6773 2873   self._newargs(s
-000181b0: 656c 662e 6172 6773 5b30 5d20 2b20 6f74  elf.args[0] + ot
-000181c0: 6865 722e 6172 6773 5b30 5d29 0a0a 2020  her.args[0])..  
-000181d0: 2020 6465 6620 5f6d 756c 7469 706c 7928    def _multiply(
-000181e0: 7365 6c66 2c20 6f74 6865 7229 3a0a 2020  self, other):.  
-000181f0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00018200: 6e63 6528 6f74 6865 722c 205f 5f63 6c61  nce(other, __cla
-00018210: 7373 5f5f 293a 0a20 2020 2020 2020 2020  ss__):.         
-00018220: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-00018230: 6e65 7761 7267 7328 7365 6c66 2e61 7267  newargs(self.arg
-00018240: 735b 305d 202a 206f 7468 6572 2e61 7267  s[0] * other.arg
-00018250: 735b 305d 290a 0a20 2020 2064 6566 205f  s[0])..    def _
-00018260: 7375 6d28 7365 6c66 2c20 6178 6973 293a  sum(self, axis):
-00018270: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00018280: 7365 6c66 2e5f 6e65 7761 7267 7328 7375  self._newargs(su
-00018290: 6d28 7365 6c66 2e61 7267 735b 305d 2c20  m(self.args[0], 
-000182a0: 6178 6973 2929 0a0a 2020 2020 6465 6620  axis))..    def 
-000182b0: 5f70 726f 6475 6374 2873 656c 6629 3a0a  _product(self):.
-000182c0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000182d0: 656c 662e 5f6e 6577 6172 6773 2870 726f  elf._newargs(pro
-000182e0: 6475 6374 2873 656c 662e 6172 6773 5b30  duct(self.args[0
-000182f0: 5d2c 202d 3129 290a 0a20 2020 2064 6566  ], -1))..    def
-00018300: 205f 7265 616c 2873 656c 6629 3a0a 2020   _real(self):.  
-00018310: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00018320: 662e 6172 6773 5b30 5d0a 0a20 2020 2064  f.args[0]..    d
-00018330: 6566 205f 696d 6167 2873 656c 6629 3a0a  ef _imag(self):.
-00018340: 2020 2020 2020 2020 7265 7475 726e 207a          return z
-00018350: 6572 6f73 5f6c 696b 6528 7365 6c66 2e61  eros_like(self.a
-00018360: 7267 735b 305d 290a 0a20 2020 2064 6566  rgs[0])..    def
-00018370: 205f 636f 6e6a 7567 6174 6528 7365 6c66   _conjugate(self
-00018380: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00018390: 6e20 7365 6c66 0a0a 2020 2020 6465 6620  n self..    def 
-000183a0: 5f64 6572 6976 6174 6976 6528 7365 6c66  _derivative(self
-000183b0: 2c20 7661 722c 2073 6565 6e29 3a0a 2020  , var, seen):.  
-000183c0: 2020 2020 2020 6966 2076 6172 2e64 7479        if var.dty
-000183d0: 7065 203d 3d20 636f 6d70 6c65 783a 0a20  pe == complex:. 
-000183e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000183f0: 2056 616c 7565 4572 726f 7228 2754 6865   ValueError('The
-00018400: 2063 6f6d 706c 6578 2064 6572 6976 6174   complex derivat
-00018410: 6976 6520 646f 6573 206e 6f74 2065 7869  ive does not exi
-00018420: 7374 2e27 290a 2020 2020 2020 2020 6172  st.').        ar
-00018430: 672c 203d 2073 656c 662e 6172 6773 0a20  g, = self.args. 
-00018440: 2020 2020 2020 2072 6574 7572 6e20 466c         return Fl
-00018450: 6f61 7454 6f43 6f6d 706c 6578 2864 6572  oatToComplex(der
-00018460: 6976 6174 6976 6528 6172 672c 2076 6172  ivative(arg, var
-00018470: 2c20 7365 656e 2929 0a0a 0a64 6566 2061  , seen))...def a
-00018480: 7374 7970 6528 6172 672c 2064 7479 7065  stype(arg, dtype
-00018490: 293a 0a20 2020 2061 7267 203d 2061 7361  ):.    arg = asa
-000184a0: 7272 6179 2861 7267 290a 2020 2020 6920  rray(arg).    i 
-000184b0: 3d20 5f74 7970 655f 6f72 6465 722e 696e  = _type_order.in
-000184c0: 6465 7828 6172 672e 6474 7970 6529 0a20  dex(arg.dtype). 
-000184d0: 2020 206a 203d 205f 7479 7065 5f6f 7264     j = _type_ord
-000184e0: 6572 2e69 6e64 6578 2864 7479 7065 290a  er.index(dtype).
-000184f0: 2020 2020 6966 2069 203e 206a 3a0a 2020      if i > j:.  
-00018500: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
-00018510: 4572 726f 7228 2744 6f77 6e63 6173 7469  Error('Downcasti
-00018520: 6e67 2069 7320 666f 7262 6964 6465 6e2e  ng is forbidden.
-00018530: 2729 0a20 2020 2066 6f72 2063 6173 7420  ').    for cast 
-00018540: 696e 2028 426f 6f6c 546f 496e 742c 2049  in (BoolToInt, I
-00018550: 6e74 546f 466c 6f61 742c 2046 6c6f 6174  ntToFloat, Float
-00018560: 546f 436f 6d70 6c65 7829 5b69 3a6a 5d3a  ToComplex)[i:j]:
-00018570: 0a20 2020 2020 2020 2061 7267 203d 2063  .        arg = c
-00018580: 6173 7428 6172 6729 0a20 2020 2072 6574  ast(arg).    ret
-00018590: 7572 6e20 6172 670a 0a0a 636c 6173 7320  urn arg...class 
-000185a0: 5369 676e 2841 7272 6179 293a 0a0a 2020  Sign(Array):..  
-000185b0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-000185c0: 656c 662c 2066 756e 633a 2041 7272 6179  elf, func: Array
-000185d0: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
-000185e0: 7420 6973 696e 7374 616e 6365 2866 756e  t isinstance(fun
-000185f0: 632c 2041 7272 6179 2920 616e 6420 6675  c, Array) and fu
-00018600: 6e63 2e64 7479 7065 2021 3d20 636f 6d70  nc.dtype != comp
-00018610: 6c65 782c 2066 2766 756e 633d 7b66 756e  lex, f'func={fun
-00018620: 6321 727d 270a 2020 2020 2020 2020 7365  c!r}'.        se
-00018630: 6c66 2e66 756e 6320 3d20 6675 6e63 0a20  lf.func = func. 
-00018640: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
-00018650: 5f69 6e69 745f 5f28 6172 6773 3d28 6675  _init__(args=(fu
-00018660: 6e63 2c29 2c20 7368 6170 653d 6675 6e63  nc,), shape=func
-00018670: 2e73 6861 7065 2c20 6474 7970 653d 6675  .shape, dtype=fu
-00018680: 6e63 2e64 7479 7065 290a 0a20 2020 2064  nc.dtype)..    d
-00018690: 6566 205f 7369 6d70 6c69 6669 6564 2873  ef _simplified(s
-000186a0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-000186b0: 7475 726e 2073 656c 662e 6675 6e63 2e5f  turn self.func._
-000186c0: 7369 676e 2829 0a0a 2020 2020 6576 616c  sign()..    eval
-000186d0: 6620 3d20 7374 6174 6963 6d65 7468 6f64  f = staticmethod
-000186e0: 286e 756d 7079 2e73 6967 6e29 0a0a 2020  (numpy.sign)..  
-000186f0: 2020 6465 6620 5f74 616b 6564 6961 6728    def _takediag(
-00018700: 7365 6c66 2c20 6178 6973 312c 2061 7869  self, axis1, axi
-00018710: 7332 293a 0a20 2020 2020 2020 2072 6574  s2):.        ret
-00018720: 7572 6e20 5369 676e 285f 7461 6b65 6469  urn Sign(_takedi
-00018730: 6167 2873 656c 662e 6675 6e63 2c20 6178  ag(self.func, ax
-00018740: 6973 312c 2061 7869 7332 2929 0a0a 2020  is1, axis2))..  
-00018750: 2020 6465 6620 5f74 616b 6528 7365 6c66    def _take(self
-00018760: 2c20 696e 6465 782c 2061 7869 7329 3a0a  , index, axis):.
-00018770: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-00018780: 6967 6e28 5f74 616b 6528 7365 6c66 2e66  ign(_take(self.f
-00018790: 756e 632c 2069 6e64 6578 2c20 6178 6973  unc, index, axis
-000187a0: 2929 0a0a 2020 2020 6465 6620 5f73 6967  ))..    def _sig
-000187b0: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-000187c0: 2072 6574 7572 6e20 7365 6c66 0a0a 2020   return self..  
-000187d0: 2020 6465 6620 5f75 6e72 6176 656c 2873    def _unravel(s
-000187e0: 656c 662c 2061 7869 732c 2073 6861 7065  elf, axis, shape
-000187f0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00018800: 6e20 5369 676e 2875 6e72 6176 656c 2873  n Sign(unravel(s
-00018810: 656c 662e 6675 6e63 2c20 6178 6973 2c20  elf.func, axis, 
-00018820: 7368 6170 6529 290a 0a20 2020 2064 6566  shape))..    def
-00018830: 205f 6465 7269 7661 7469 7665 2873 656c   _derivative(sel
-00018840: 662c 2076 6172 2c20 7365 656e 293a 0a20  f, var, seen):. 
-00018850: 2020 2020 2020 2072 6574 7572 6e20 5a65         return Ze
-00018860: 726f 7328 7365 6c66 2e73 6861 7065 202b  ros(self.shape +
-00018870: 2076 6172 2e73 6861 7065 2c20 6474 7970   var.shape, dtyp
-00018880: 653d 7365 6c66 2e64 7479 7065 290a 0a20  e=self.dtype).. 
-00018890: 2020 2064 6566 205f 696e 7462 6f75 6e64     def _intbound
-000188a0: 735f 696d 706c 2873 656c 6629 3a0a 2020  s_impl(self):.  
-000188b0: 2020 2020 2020 6c6f 7765 722c 2075 7070        lower, upp
-000188c0: 6572 203d 2073 656c 662e 6675 6e63 2e5f  er = self.func._
-000188d0: 696e 7462 6f75 6e64 730a 2020 2020 2020  intbounds.      
-000188e0: 2020 7265 7475 726e 2069 6e74 286e 756d    return int(num
-000188f0: 7079 2e73 6967 6e28 6c6f 7765 7229 292c  py.sign(lower)),
-00018900: 2069 6e74 286e 756d 7079 2e73 6967 6e28   int(numpy.sign(
-00018910: 7570 7065 7229 290a 0a0a 636c 6173 7320  upper))...class 
-00018920: 5361 6d70 6c65 6428 4172 7261 7929 3a0a  Sampled(Array):.
-00018930: 2020 2020 2727 2742 6173 6973 2d6c 696b      '''Basis-lik
-00018940: 6520 6964 656e 7469 7479 206f 7065 7261  e identity opera
-00018950: 746f 722e 0a0a 2020 2020 4261 7369 732d  tor...    Basis-
-00018960: 6c69 6b65 2066 756e 6374 696f 6e20 7468  like function th
-00018970: 6174 2066 6f72 2065 7665 7279 2070 6f69  at for every poi
-00018980: 6e74 2065 7661 6c75 6174 6573 2074 6f20  nt evaluates to 
-00018990: 6120 7061 7274 6974 696f 6e20 6f66 2075  a partition of u
-000189a0: 6e69 7479 0a20 2020 206f 6620 6120 7072  nity.    of a pr
-000189b0: 6564 6566 696e 6564 2073 6574 2062 6173  edefined set bas
-000189c0: 6564 206f 6e20 7468 6520 7365 6c65 6374  ed on the select
-000189d0: 6564 2069 6e74 6572 706f 6c61 7469 6f6e  ed interpolation
-000189e0: 2073 6368 656d 652e 0a0a 2020 2020 4172   scheme...    Ar
-000189f0: 6773 0a20 2020 202d 2d2d 2d0a 2020 2020  gs.    ----.    
-00018a00: 706f 696e 7473 203a 2032 6420 3a63 6c61  points : 2d :cla
-00018a10: 7373 3a60 4172 7261 7960 0a20 2020 2020  ss:`Array`.     
-00018a20: 2020 2050 7265 7365 6e74 2070 6f69 6e74     Present point
-00018a30: 2063 6f6f 7264 696e 6174 6573 2e0a 2020   coordinates..  
-00018a40: 2020 7461 7267 6574 203a 2032 6420 3a63    target : 2d :c
-00018a50: 6c61 7373 3a60 4172 7261 7960 0a20 2020  lass:`Array`.   
-00018a60: 2020 2020 2045 6c65 6d65 6e74 7769 7365       Elementwise
-00018a70: 2063 6f6e 7374 616e 7420 7468 6174 2065   constant that e
-00018a80: 7661 6c75 6174 6573 2074 6f20 7468 6520  valuates to the 
-00018a90: 7461 7267 6574 2070 6f69 6e74 2063 6f6f  target point coo
-00018aa0: 7264 696e 6174 6573 2e0a 2020 2020 696e  rdinates..    in
-00018ab0: 7465 7270 6f6c 6174 696f 6e20 3a20 3a63  terpolation : :c
-00018ac0: 6c61 7373 3a60 7374 7260 0a20 2020 2020  lass:`str`.     
-00018ad0: 2020 2049 6e74 6572 706f 6c61 7469 6f6e     Interpolation
-00018ae0: 2073 6368 656d 6520 746f 206d 6170 2070   scheme to map p
-00018af0: 6f69 6e74 7320 746f 2074 6172 6765 743a  oints to target:
-00018b00: 2022 6e6f 6e65 2220 6f72 2022 6e65 6172   "none" or "near
-00018b10: 6573 7422 2e0a 2020 2020 2727 270a 0a20  est"..    '''.. 
-00018b20: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00018b30: 7365 6c66 2c20 706f 696e 7473 3a20 4172  self, points: Ar
-00018b40: 7261 792c 2074 6172 6765 743a 2041 7272  ray, target: Arr
-00018b50: 6179 2c20 696e 7465 7270 6f6c 6174 696f  ay, interpolatio
-00018b60: 6e3a 2073 7472 293a 0a20 2020 2020 2020  n: str):.       
-00018b70: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00018b80: 6365 2870 6f69 6e74 732c 2041 7272 6179  ce(points, Array
-00018b90: 2920 616e 6420 706f 696e 7473 2e6e 6469  ) and points.ndi
-00018ba0: 6d20 3d3d 2032 2c20 6627 706f 696e 7473  m == 2, f'points
-00018bb0: 3d7b 706f 696e 7473 2172 7d27 0a20 2020  ={points!r}'.   
-00018bc0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-00018bd0: 7374 616e 6365 2874 6172 6765 742c 2041  stance(target, A
-00018be0: 7272 6179 2920 616e 6420 7461 7267 6574  rray) and target
-00018bf0: 2e6e 6469 6d20 3d3d 2032 2c20 6627 7461  .ndim == 2, f'ta
-00018c00: 7267 6574 3d7b 7461 7267 6574 2172 7d27  rget={target!r}'
-00018c10: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00018c20: 706f 696e 7473 2e73 6861 7065 5b31 5d20  points.shape[1] 
-00018c30: 3d3d 2074 6172 6765 742e 7368 6170 655b  == target.shape[
-00018c40: 315d 0a20 2020 2020 2020 2069 6620 696e  1].        if in
-00018c50: 7465 7270 6f6c 6174 696f 6e20 3d3d 2027  terpolation == '
-00018c60: 6e6f 6e65 273a 0a20 2020 2020 2020 2020  none':.         
-00018c70: 2020 2073 656c 662e 6576 616c 6620 3d20     self.evalf = 
-00018c80: 7365 6c66 2e65 7661 6c66 5f6e 6f6e 650a  self.evalf_none.
-00018c90: 2020 2020 2020 2020 656c 6966 2069 6e74          elif int
-00018ca0: 6572 706f 6c61 7469 6f6e 203d 3d20 276e  erpolation == 'n
-00018cb0: 6561 7265 7374 273a 0a20 2020 2020 2020  earest':.       
-00018cc0: 2020 2020 2073 656c 662e 6576 616c 6620       self.evalf 
-00018cd0: 3d20 7365 6c66 2e65 7661 6c66 5f6e 6561  = self.evalf_nea
-00018ce0: 7265 7374 0a20 2020 2020 2020 2065 6c73  rest.        els
-00018cf0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00018d00: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00018d10: 6627 696e 7661 6c69 6420 696e 7465 7270  f'invalid interp
-00018d20: 6f6c 6174 696f 6e20 7b69 6e74 6572 706f  olation {interpo
-00018d30: 6c61 7469 6f6e 2172 7d3b 2076 616c 6964  lation!r}; valid
-00018d40: 2076 616c 7565 7320 6172 6520 226e 6f6e   values are "non
-00018d50: 6522 2061 6e64 2022 6e65 6172 6573 7422  e" and "nearest"
-00018d60: 2729 0a20 2020 2020 2020 2073 7570 6572  ').        super
-00018d70: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
-00018d80: 3d28 706f 696e 7473 2c20 7461 7267 6574  =(points, target
-00018d90: 292c 2073 6861 7065 3d28 706f 696e 7473  ), shape=(points
-00018da0: 2e73 6861 7065 5b30 5d2c 2074 6172 6765  .shape[0], targe
-00018db0: 742e 7368 6170 655b 305d 292c 2064 7479  t.shape[0]), dty
-00018dc0: 7065 3d66 6c6f 6174 290a 0a20 2020 2040  pe=float)..    @
-00018dd0: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-00018de0: 2064 6566 2065 7661 6c66 5f6e 6f6e 6528   def evalf_none(
-00018df0: 706f 696e 7473 2c20 7461 7267 6574 293a  points, target):
-00018e00: 0a20 2020 2020 2020 2069 6620 706f 696e  .        if poin
-00018e10: 7473 2e73 6861 7065 2021 3d20 7461 7267  ts.shape != targ
-00018e20: 6574 2e73 6861 7065 206f 7220 6e6f 7420  et.shape or not 
-00018e30: 6e75 6d70 792e 6571 7561 6c28 706f 696e  numpy.equal(poin
-00018e40: 7473 2c20 7461 7267 6574 292e 616c 6c28  ts, target).all(
-00018e50: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00018e60: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00018e70: 2770 6f69 6e74 7320 646f 206e 6f74 2063  'points do not c
-00018e80: 6f72 7265 7370 6f6e 6420 746f 2074 6865  orrespond to the
-00018e90: 2074 6172 6765 7420 7361 6d70 6c65 3b20   target sample; 
-00018ea0: 636f 6e73 6964 6572 2075 7369 6e67 2022  consider using "
-00018eb0: 6e65 6172 6573 7422 2069 6e74 6572 706f  nearest" interpo
-00018ec0: 6c61 7469 6f6e 2069 6620 7468 6973 2069  lation if this i
-00018ed0: 7320 6465 7369 7265 6427 290a 2020 2020  s desired').    
-00018ee0: 2020 2020 7265 7475 726e 206e 756d 7079      return numpy
-00018ef0: 2e65 7965 286c 656e 2870 6f69 6e74 7329  .eye(len(points)
-00018f00: 290a 0a20 2020 2040 7374 6174 6963 6d65  )..    @staticme
-00018f10: 7468 6f64 0a20 2020 2064 6566 2065 7661  thod.    def eva
-00018f20: 6c66 5f6e 6561 7265 7374 2870 6f69 6e74  lf_nearest(point
-00018f30: 732c 2074 6172 6765 7429 3a0a 2020 2020  s, target):.    
-00018f40: 2020 2020 6e65 6172 6573 7420 3d20 6e75      nearest = nu
-00018f50: 6d70 792e 6c69 6e61 6c67 2e6e 6f72 6d28  mpy.linalg.norm(
-00018f60: 706f 696e 7473 5b3a 2c6e 756d 7079 2e6e  points[:,numpy.n
-00018f70: 6577 6178 6973 2c3a 5d20 2d20 7461 7267  ewaxis,:] - targ
-00018f80: 6574 5b6e 756d 7079 2e6e 6577 6178 6973  et[numpy.newaxis
-00018f90: 2c3a 2c3a 5d2c 2061 7869 733d 3229 2e61  ,:,:], axis=2).a
-00018fa0: 7267 6d69 6e28 6178 6973 3d31 290a 2020  rgmin(axis=1).  
-00018fb0: 2020 2020 2020 7265 7475 726e 206e 756d        return num
-00018fc0: 7079 2e65 7965 286c 656e 2874 6172 6765  py.eye(len(targe
-00018fd0: 7429 295b 6e65 6172 6573 745d 0a0a 0a64  t))[nearest]...d
-00018fe0: 6566 2045 6c65 6d77 6973 6528 6461 7461  ef Elemwise(data
-00018ff0: 3a20 7479 7069 6e67 2e54 7570 6c65 5b74  : typing.Tuple[t
-00019000: 7970 6573 2e61 7272 6179 6461 7461 2c20  ypes.arraydata, 
-00019010: 2e2e 2e5d 2c20 696e 6465 783a 2041 7272  ...], index: Arr
-00019020: 6179 2c20 6474 7970 653a 2044 7479 7065  ay, dtype: Dtype
-00019030: 293a 0a20 2020 2061 7373 6572 7420 6973  ):.    assert is
-00019040: 696e 7374 616e 6365 2864 6174 612c 2074  instance(data, t
-00019050: 7570 6c65 2920 616e 6420 616c 6c28 6973  uple) and all(is
-00019060: 696e 7374 616e 6365 2864 2c20 7479 7065  instance(d, type
-00019070: 732e 6172 7261 7964 6174 6129 2061 6e64  s.arraydata) and
-00019080: 2064 2e64 7479 7065 203d 3d20 6474 7970   d.dtype == dtyp
-00019090: 6520 666f 7220 6420 696e 2064 6174 6129  e for d in data)
-000190a0: 2c20 6627 6461 7461 3d7b 6461 7461 2172  , f'data={data!r
-000190b0: 7d27 0a20 2020 2061 7373 6572 7420 6973  }'.    assert is
-000190c0: 696e 7374 616e 6365 2869 6e64 6578 2c20  instance(index, 
-000190d0: 4172 7261 7929 2061 6e64 2069 6e64 6578  Array) and index
-000190e0: 2e6e 6469 6d20 3d3d 2030 2061 6e64 2069  .ndim == 0 and i
-000190f0: 6e64 6578 2e64 7479 7065 203d 3d20 696e  ndex.dtype == in
-00019100: 742c 2066 2769 6e64 6578 3d7b 696e 6465  t, f'index={inde
-00019110: 7821 727d 270a 2020 2020 756e 6971 7565  x!r}'.    unique
-00019120: 2c20 696e 6469 6365 7320 3d20 7574 696c  , indices = util
-00019130: 2e75 6e69 7175 6528 6461 7461 290a 2020  .unique(data).  
-00019140: 2020 6966 206c 656e 2875 6e69 7175 6529    if len(unique)
-00019150: 203d 3d20 313a 0a20 2020 2020 2020 2072   == 1:.        r
-00019160: 6574 7572 6e20 436f 6e73 7461 6e74 2875  eturn Constant(u
-00019170: 6e69 7175 655b 305d 290a 2020 2020 2320  nique[0]).    # 
-00019180: 4372 6561 7465 2073 6861 7065 2066 726f  Create shape fro
-00019190: 6d20 6461 7461 2061 6e64 2069 6e64 6578  m data and index
-000191a0: 2c20 7261 7468 6572 2074 6861 6e20 756e  , rather than un
-000191b0: 6971 7565 2061 6e64 2074 6865 206d 6f64  ique and the mod
-000191c0: 6966 6965 640a 2020 2020 2320 696e 6465  ified.    # inde
-000191d0: 782c 2069 6e20 6f72 6465 7220 746f 2061  x, in order to a
-000191e0: 766f 6964 2070 6f74 656e 7469 616c 2073  void potential s
-000191f0: 6861 7065 2069 6e63 6f6e 7369 7374 656e  hape inconsisten
-00019200: 6369 6573 206c 6174 6572 206f 6e2e 0a20  cies later on.. 
-00019210: 2020 2073 6861 7065 7320 3d20 6e75 6d70     shapes = nump
-00019220: 792e 6172 7261 7928 5b64 2e73 6861 7065  y.array([d.shape
-00019230: 2066 6f72 2064 2069 6e20 6461 7461 5d29   for d in data])
-00019240: 0a20 2020 2073 6861 7065 203d 205b 5461  .    shape = [Ta
-00019250: 6b65 2863 6f6e 7374 616e 7428 7329 2c20  ke(constant(s), 
-00019260: 696e 6465 7829 2066 6f72 2073 2069 6e20  index) for s in 
-00019270: 7368 6170 6573 2e54 5d0a 2020 2020 6966  shapes.T].    if
-00019280: 206c 656e 2875 6e69 7175 6529 203c 206c   len(unique) < l
-00019290: 656e 2864 6174 6129 3a0a 2020 2020 2020  en(data):.      
-000192a0: 2020 696e 6465 7820 3d20 5461 6b65 2863    index = Take(c
-000192b0: 6f6e 7374 616e 7428 696e 6469 6365 7329  onstant(indices)
-000192c0: 2c20 696e 6465 7829 0a20 2020 2023 204d  , index).    # M
-000192d0: 6f76 6520 616c 6c20 6178 6573 2077 6974  ove all axes wit
-000192e0: 6820 636f 6e73 7461 6e74 2073 6861 7065  h constant shape
-000192f0: 2074 6f20 7468 6520 6c65 6674 2061 6e64   to the left and
-00019300: 2072 6176 656c 2074 6865 2072 656d 6169   ravel the remai
-00019310: 6e64 6572 2e0a 2020 2020 6973 5f63 6f6e  nder..    is_con
-00019320: 7374 616e 7420 3d20 6e75 6d70 792e 616c  stant = numpy.al
-00019330: 6c28 7368 6170 6573 5b31 3a5d 203d 3d20  l(shapes[1:] == 
-00019340: 7368 6170 6573 5b30 5d2c 2061 7869 733d  shapes[0], axis=
-00019350: 3029 0a20 2020 206e 636f 6e73 7461 6e74  0).    nconstant
-00019360: 203d 2069 735f 636f 6e73 7461 6e74 2e73   = is_constant.s
-00019370: 756d 2829 0a20 2020 2072 656f 7264 6572  um().    reorder
-00019380: 203d 206e 756d 7079 2e61 7267 736f 7274   = numpy.argsort
-00019390: 287e 6973 5f63 6f6e 7374 616e 7429 0a20  (~is_constant). 
-000193a0: 2020 2072 6176 656c 6564 203d 205b 6e75     raveled = [nu
-000193b0: 6d70 792e 7472 616e 7370 6f73 6528 642c  mpy.transpose(d,
-000193c0: 2072 656f 7264 6572 292e 7265 7368 6170   reorder).reshap
-000193d0: 6528 2a73 6861 7065 735b 302c 2072 656f  e(*shapes[0, reo
-000193e0: 7264 6572 5b3a 6e63 6f6e 7374 616e 745d  rder[:nconstant]
-000193f0: 5d2c 202d 3129 2066 6f72 2064 2069 6e20  ], -1) for d in 
-00019400: 756e 6971 7565 5d0a 2020 2020 2320 436f  unique].    # Co
-00019410: 6e63 6174 656e 6174 6520 7468 6520 7261  ncatenate the ra
-00019420: 7665 6c65 6420 6178 6973 2c20 7461 6b65  veled axis, take
-00019430: 2073 6c69 6365 732c 2075 6e72 6176 656c   slices, unravel
-00019440: 2061 6e64 2072 656f 7264 6572 2074 6865   and reorder the
-00019450: 2061 7865 7320 746f 0a20 2020 2023 2074   axes to.    # t
-00019460: 6865 206f 7269 6769 6e61 6c20 706f 7369  he original posi
-00019470: 7469 6f6e 2e0a 2020 2020 636f 6e63 6174  tion..    concat
-00019480: 203d 2063 6f6e 7374 616e 7428 6e75 6d70   = constant(nump
-00019490: 792e 636f 6e63 6174 656e 6174 6528 7261  y.concatenate(ra
-000194a0: 7665 6c65 642c 2061 7869 733d 2d31 2929  veled, axis=-1))
-000194b0: 0a20 2020 2069 6620 6973 5f63 6f6e 7374  .    if is_const
-000194c0: 616e 742e 616c 6c28 293a 0a20 2020 2020  ant.all():.     
-000194d0: 2020 2072 6574 7572 6e20 5461 6b65 2863     return Take(c
-000194e0: 6f6e 6361 742c 2069 6e64 6578 290a 2020  oncat, index).  
-000194f0: 2020 7661 725f 7368 6170 6520 3d20 7475    var_shape = tu
-00019500: 706c 6528 7368 6170 655b 695d 2066 6f72  ple(shape[i] for
-00019510: 2069 2069 6e20 7265 6f72 6465 725b 6e63   i in reorder[nc
-00019520: 6f6e 7374 616e 743a 5d29 0a20 2020 2063  onstant:]).    c
-00019530: 756d 7072 6f64 203d 206c 6973 7428 7661  umprod = list(va
-00019540: 725f 7368 6170 6529 0a20 2020 2066 6f72  r_shape).    for
-00019550: 2069 2069 6e20 7265 7665 7273 6564 2872   i in reversed(r
-00019560: 616e 6765 286c 656e 2876 6172 5f73 6861  ange(len(var_sha
-00019570: 7065 292d 3129 293a 0a20 2020 2020 2020  pe)-1)):.       
-00019580: 2063 756d 7072 6f64 5b69 5d20 2a3d 2063   cumprod[i] *= c
-00019590: 756d 7072 6f64 5b69 2b31 5d20 2023 2077  umprod[i+1]  # w
-000195a0: 6f72 6b20 6261 636b 7761 7264 7320 736f  ork backwards so
-000195b0: 2074 6861 7420 7468 6520 7368 6170 6520   that the shape 
-000195c0: 6368 6563 6b20 6d61 7463 6865 7320 696e  check matches in
-000195d0: 2055 6e72 6176 656c 0a20 2020 206f 6666   Unravel.    off
-000195e0: 7365 7473 203d 205f 5369 7a65 7354 6f4f  sets = _SizesToO
-000195f0: 6666 7365 7473 2861 7361 7272 6179 285b  ffsets(asarray([
-00019600: 642e 7368 6170 655b 2d31 5d20 666f 7220  d.shape[-1] for 
-00019610: 6420 696e 2072 6176 656c 6564 5d29 290a  d in raveled])).
-00019620: 2020 2020 656c 656d 7769 7365 203d 2054      elemwise = T
-00019630: 616b 6528 636f 6e63 6174 2c20 5261 6e67  ake(concat, Rang
-00019640: 6528 6375 6d70 726f 645b 305d 2920 2b20  e(cumprod[0]) + 
-00019650: 5461 6b65 286f 6666 7365 7473 2c20 696e  Take(offsets, in
-00019660: 6465 7829 290a 2020 2020 666f 7220 6920  dex)).    for i 
-00019670: 696e 2072 616e 6765 286c 656e 2876 6172  in range(len(var
-00019680: 5f73 6861 7065 292d 3129 3a0a 2020 2020  _shape)-1):.    
-00019690: 2020 2020 656c 656d 7769 7365 203d 2055      elemwise = U
-000196a0: 6e72 6176 656c 2865 6c65 6d77 6973 652c  nravel(elemwise,
-000196b0: 2076 6172 5f73 6861 7065 5b69 5d2c 2063   var_shape[i], c
-000196c0: 756d 7072 6f64 5b69 2b31 5d29 0a20 2020  umprod[i+1]).   
-000196d0: 2072 6574 7572 6e20 5472 616e 7370 6f73   return Transpos
-000196e0: 652e 696e 7628 656c 656d 7769 7365 2c20  e.inv(elemwise, 
-000196f0: 7265 6f72 6465 7229 0a0a 0a63 6c61 7373  reorder)...class
-00019700: 2045 6967 2845 7661 6c75 6162 6c65 293a   Eig(Evaluable):
-00019710: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-00019720: 5f5f 2873 656c 662c 2066 756e 633a 2041  __(self, func: A
-00019730: 7272 6179 2c20 7379 6d6d 6574 7269 633a  rray, symmetric:
-00019740: 2062 6f6f 6c20 3d20 4661 6c73 6529 3a0a   bool = False):.
-00019750: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-00019760: 7369 6e73 7461 6e63 6528 6675 6e63 2c20  sinstance(func, 
-00019770: 4172 7261 7929 2061 6e64 2066 756e 632e  Array) and func.
-00019780: 6e64 696d 203e 3d20 3220 616e 6420 5f65  ndim >= 2 and _e
-00019790: 7175 616c 735f 7369 6d70 6c69 6669 6564  quals_simplified
-000197a0: 2866 756e 632e 7368 6170 655b 2d31 5d2c  (func.shape[-1],
-000197b0: 2066 756e 632e 7368 6170 655b 2d32 5d29   func.shape[-2])
-000197c0: 2c20 6627 6675 6e63 3d7b 6675 6e63 2172  , f'func={func!r
-000197d0: 7d27 0a20 2020 2020 2020 2061 7373 6572  }'.        asser
-000197e0: 7420 6973 696e 7374 616e 6365 2873 796d  t isinstance(sym
-000197f0: 6d65 7472 6963 2c20 626f 6f6c 292c 2066  metric, bool), f
-00019800: 2773 796d 6d65 7472 6963 3d7b 7379 6d6d  'symmetric={symm
-00019810: 6574 7269 6321 727d 270a 2020 2020 2020  etric!r}'.      
-00019820: 2020 7365 6c66 2e73 796d 6d65 7472 6963    self.symmetric
-00019830: 203d 2073 796d 6d65 7472 6963 0a20 2020   = symmetric.   
-00019840: 2020 2020 2073 656c 662e 6675 6e63 203d       self.func =
-00019850: 2066 756e 630a 2020 2020 2020 2020 7365   func.        se
-00019860: 6c66 2e5f 775f 6474 7970 6520 3d20 666c  lf._w_dtype = fl
-00019870: 6f61 7420 6966 2073 796d 6d65 7472 6963  oat if symmetric
-00019880: 2065 6c73 6520 636f 6d70 6c65 780a 2020   else complex.  
-00019890: 2020 2020 2020 7365 6c66 2e5f 7674 5f64        self._vt_d
-000198a0: 7479 7065 203d 2066 6c6f 6174 2069 6620  type = float if 
-000198b0: 7379 6d6d 6574 7269 6320 616e 6420 6675  symmetric and fu
-000198c0: 6e63 2e64 7479 7065 2021 3d20 636f 6d70  nc.dtype != comp
-000198d0: 6c65 7820 656c 7365 2063 6f6d 706c 6578  lex else complex
-000198e0: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
-000198f0: 2e5f 5f69 6e69 745f 5f28 6172 6773 3d28  .__init__(args=(
-00019900: 6675 6e63 2c29 290a 0a20 2020 2064 6566  func,))..    def
-00019910: 205f 5f6c 656e 5f5f 2873 656c 6629 3a0a   __len__(self):.
-00019920: 2020 2020 2020 2020 7265 7475 726e 2032          return 2
-00019930: 0a0a 2020 2020 6465 6620 5f5f 6765 7469  ..    def __geti
-00019940: 7465 6d5f 5f28 7365 6c66 2c20 696e 6465  tem__(self, inde
-00019950: 7829 3a0a 2020 2020 2020 2020 6966 2069  x):.        if i
-00019960: 6e64 6578 203d 3d20 303a 0a20 2020 2020  ndex == 0:.     
-00019970: 2020 2020 2020 2073 6861 7065 203d 2073         shape = s
-00019980: 656c 662e 6675 6e63 2e73 6861 7065 5b3a  elf.func.shape[:
-00019990: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
-000199a0: 6474 7970 6520 3d20 7365 6c66 2e5f 775f  dtype = self._w_
-000199b0: 6474 7970 650a 2020 2020 2020 2020 656c  dtype.        el
-000199c0: 6966 2069 6e64 6578 203d 3d20 313a 0a20  if index == 1:. 
-000199d0: 2020 2020 2020 2020 2020 2073 6861 7065             shape
-000199e0: 3d73 656c 662e 6675 6e63 2e73 6861 7065  =self.func.shape
-000199f0: 0a20 2020 2020 2020 2020 2020 2064 7479  .            dty
-00019a00: 7065 3d73 656c 662e 5f76 745f 6474 7970  pe=self._vt_dtyp
-00019a10: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-00019a20: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00019a30: 6520 496e 6465 7845 7272 6f72 0a20 2020  e IndexError.   
-00019a40: 2020 2020 2072 6574 7572 6e20 4172 7261       return Arra
-00019a50: 7946 726f 6d54 7570 6c65 2873 656c 662c  yFromTuple(self,
-00019a60: 2069 6e64 6578 3d69 6e64 6578 2c20 7368   index=index, sh
-00019a70: 6170 653d 7368 6170 652c 2064 7479 7065  ape=shape, dtype
-00019a80: 3d64 7479 7065 290a 0a20 2020 2064 6566  =dtype)..    def
-00019a90: 205f 7369 6d70 6c69 6669 6564 2873 656c   _simplified(sel
-00019aa0: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
-00019ab0: 726e 2073 656c 662e 6675 6e63 2e5f 6569  rn self.func._ei
-00019ac0: 6728 7365 6c66 2e73 796d 6d65 7472 6963  g(self.symmetric
-00019ad0: 290a 0a20 2020 2064 6566 2065 7661 6c66  )..    def evalf
-00019ae0: 2873 656c 662c 2061 7272 293a 0a20 2020  (self, arr):.   
-00019af0: 2020 2020 2077 2c20 7674 203d 2028 6e75       w, vt = (nu
-00019b00: 6d70 792e 6c69 6e61 6c67 2e65 6967 6820  mpy.linalg.eigh 
-00019b10: 6966 2073 656c 662e 7379 6d6d 6574 7269  if self.symmetri
-00019b20: 6320 656c 7365 206e 756d 7079 2e6c 696e  c else numpy.lin
-00019b30: 616c 672e 6569 6729 2861 7272 290a 2020  alg.eig)(arr).  
-00019b40: 2020 2020 2020 7720 3d20 772e 6173 7479        w = w.asty
-00019b50: 7065 2873 656c 662e 5f77 5f64 7479 7065  pe(self._w_dtype
-00019b60: 2c20 636f 7079 3d46 616c 7365 290a 2020  , copy=False).  
-00019b70: 2020 2020 2020 7674 203d 2076 742e 6173        vt = vt.as
-00019b80: 7479 7065 2873 656c 662e 5f76 745f 6474  type(self._vt_dt
-00019b90: 7970 652c 2063 6f70 793d 4661 6c73 6529  ype, copy=False)
-00019ba0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00019bb0: 2877 2c20 7674 290a 0a0a 636c 6173 7320  (w, vt)...class 
-00019bc0: 4172 7261 7946 726f 6d54 7570 6c65 2841  ArrayFromTuple(A
-00019bd0: 7272 6179 293a 0a0a 2020 2020 6465 6620  rray):..    def 
-00019be0: 5f5f 696e 6974 5f5f 2873 656c 662c 2061  __init__(self, a
-00019bf0: 7272 6179 733a 2045 7661 6c75 6162 6c65  rrays: Evaluable
-00019c00: 2c20 696e 6465 783a 2069 6e74 2c20 7368  , index: int, sh
-00019c10: 6170 653a 2074 7970 696e 672e 5475 706c  ape: typing.Tupl
-00019c20: 655b 4172 7261 792c 202e 2e2e 5d2c 2064  e[Array, ...], d
-00019c30: 7479 7065 3a20 4474 7970 652c 202a 2c20  type: Dtype, *, 
-00019c40: 5f6c 6f77 6572 3d66 6c6f 6174 2827 2d69  _lower=float('-i
-00019c50: 6e66 2729 2c20 5f75 7070 6572 3d66 6c6f  nf'), _upper=flo
-00019c60: 6174 2827 696e 6627 2929 3a0a 2020 2020  at('inf')):.    
-00019c70: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-00019c80: 7461 6e63 6528 6172 7261 7973 2c20 4576  tance(arrays, Ev
-00019c90: 616c 7561 626c 6529 2c20 6627 6172 7261  aluable), f'arra
-00019ca0: 7973 3d7b 6172 7261 7973 2172 7d27 0a20  ys={arrays!r}'. 
-00019cb0: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-00019cc0: 696e 7374 616e 6365 2869 6e64 6578 2c20  instance(index, 
-00019cd0: 696e 7429 2c20 6627 696e 6465 783d 667b  int), f'index=f{
-00019ce0: 696e 6465 787d 270a 2020 2020 2020 2020  index}'.        
-00019cf0: 7365 6c66 2e61 7272 6179 7320 3d20 6172  self.arrays = ar
-00019d00: 7261 7973 0a20 2020 2020 2020 2073 656c  rays.        sel
-00019d10: 662e 696e 6465 7820 3d20 696e 6465 780a  f.index = index.
-00019d20: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-00019d30: 7765 7220 3d20 5f6c 6f77 6572 0a20 2020  wer = _lower.   
-00019d40: 2020 2020 2073 656c 662e 5f75 7070 6572       self._upper
-00019d50: 203d 205f 7570 7065 720a 2020 2020 2020   = _upper.      
-00019d60: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
-00019d70: 5f5f 2861 7267 733d 2861 7272 6179 732c  __(args=(arrays,
-00019d80: 292c 2073 6861 7065 3d73 6861 7065 2c20  ), shape=shape, 
-00019d90: 6474 7970 653d 6474 7970 6529 0a0a 2020  dtype=dtype)..  
-00019da0: 2020 6465 6620 5f73 696d 706c 6966 6965    def _simplifie
-00019db0: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
-00019dc0: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
-00019dd0: 656c 662e 6172 7261 7973 2c20 5475 706c  elf.arrays, Tupl
-00019de0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00019df0: 2320 5468 6973 2061 6c6c 6f77 7320 7468  # This allows th
-00019e00: 6520 7365 6c66 2e61 7272 6179 7320 6576  e self.arrays ev
-00019e10: 616c 7561 626c 6520 746f 2073 696d 706c  aluable to simpl
-00019e20: 6966 7920 6974 7365 6c66 2069 6e74 6f20  ify itself into 
-00019e30: 610a 2020 2020 2020 2020 2020 2020 2320  a.            # 
-00019e40: 5475 706c 6520 616e 6420 6974 7320 636f  Tuple and its co
-00019e50: 6d70 6f6e 656e 7473 2062 6520 6578 706f  mponents be expo
-00019e60: 7365 6420 746f 2074 6865 2066 756e 6374  sed to the funct
-00019e70: 696f 6e20 7472 6565 2e0a 2020 2020 2020  ion tree..      
-00019e80: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00019e90: 662e 6172 7261 7973 5b73 656c 662e 696e  f.arrays[self.in
-00019ea0: 6465 785d 0a0a 2020 2020 6465 6620 6576  dex]..    def ev
-00019eb0: 616c 6628 7365 6c66 2c20 6172 7261 7973  alf(self, arrays
-00019ec0: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
-00019ed0: 7420 6973 696e 7374 616e 6365 2861 7272  t isinstance(arr
-00019ee0: 6179 732c 2074 7570 6c65 290a 2020 2020  ays, tuple).    
-00019ef0: 2020 2020 7265 7475 726e 2061 7272 6179      return array
-00019f00: 735b 7365 6c66 2e69 6e64 6578 5d0a 0a20  s[self.index].. 
-00019f10: 2020 2064 6566 205f 6e6f 6465 2873 656c     def _node(sel
-00019f20: 662c 2063 6163 6865 2c20 7375 6267 7261  f, cache, subgra
-00019f30: 7068 2c20 7469 6d65 7329 3a0a 2020 2020  ph, times):.    
-00019f40: 2020 2020 6966 2073 656c 6620 696e 2063      if self in c
-00019f50: 6163 6865 3a0a 2020 2020 2020 2020 2020  ache:.          
-00019f60: 2020 7265 7475 726e 2063 6163 6865 5b73    return cache[s
-00019f70: 656c 665d 0a20 2020 2020 2020 2065 6c69  elf].        eli
-00019f80: 6620 6861 7361 7474 7228 7365 6c66 2e61  f hasattr(self.a
-00019f90: 7272 6179 732c 2027 5f6e 6f64 655f 7475  rrays, '_node_tu
-00019fa0: 706c 6527 293a 0a20 2020 2020 2020 2020  ple'):.         
-00019fb0: 2020 2063 6163 6865 5b73 656c 665d 203d     cache[self] =
-00019fc0: 206e 6f64 6520 3d20 7365 6c66 2e61 7272   node = self.arr
-00019fd0: 6179 732e 5f6e 6f64 655f 7475 706c 6528  ays._node_tuple(
-00019fe0: 6361 6368 652c 2073 7562 6772 6170 682c  cache, subgraph,
-00019ff0: 2074 696d 6573 295b 7365 6c66 2e69 6e64   times)[self.ind
-0001a000: 6578 5d0a 2020 2020 2020 2020 2020 2020  ex].            
-0001a010: 7265 7475 726e 206e 6f64 650a 2020 2020  return node.    
-0001a020: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001a030: 2020 2020 2020 7265 7475 726e 2073 7570        return sup
-0001a040: 6572 2829 2e5f 6e6f 6465 2863 6163 6865  er()._node(cache
-0001a050: 2c20 7375 6267 7261 7068 2c20 7469 6d65  , subgraph, time
-0001a060: 7329 0a0a 2020 2020 6465 6620 5f69 6e74  s)..    def _int
-0001a070: 626f 756e 6473 5f69 6d70 6c28 7365 6c66  bounds_impl(self
-0001a080: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0001a090: 6e20 7365 6c66 2e5f 6c6f 7765 722c 2073  n self._lower, s
-0001a0a0: 656c 662e 5f75 7070 6572 0a0a 0a63 6c61  elf._upper...cla
-0001a0b0: 7373 205a 6572 6f73 2841 7272 6179 293a  ss Zeros(Array):
-0001a0c0: 0a20 2020 2027 7a65 726f 270a 0a20 2020  .    'zero'..   
-0001a0d0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-0001a0e0: 6c66 2c20 7368 6170 652c 2064 7479 7065  lf, shape, dtype
-0001a0f0: 293a 0a20 2020 2020 2020 2073 7570 6572  ):.        super
-0001a100: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
-0001a110: 3d73 6861 7065 2c20 7368 6170 653d 7368  =shape, shape=sh
-0001a120: 6170 652c 2064 7479 7065 3d64 7479 7065  ape, dtype=dtype
-0001a130: 290a 0a20 2020 2040 6361 6368 6564 5f70  )..    @cached_p
-0001a140: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0001a150: 5f75 6e61 6c69 676e 6564 2873 656c 6629  _unaligned(self)
-0001a160: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0001a170: 205a 6572 6f73 2828 292c 2073 656c 662e   Zeros((), self.
-0001a180: 6474 7970 6529 2c20 2829 0a0a 2020 2020  dtype), ()..    
-0001a190: 6465 6620 6576 616c 6628 7365 6c66 2c20  def evalf(self, 
-0001a1a0: 2a73 6861 7065 293a 0a20 2020 2020 2020  *shape):.       
-0001a1b0: 2072 6574 7572 6e20 6e75 6d70 792e 7a65   return numpy.ze
-0001a1c0: 726f 7328 7368 6170 652c 2064 7479 7065  ros(shape, dtype
-0001a1d0: 3d73 656c 662e 6474 7970 6529 0a0a 2020  =self.dtype)..  
-0001a1e0: 2020 6465 6620 5f6e 6f64 6528 7365 6c66    def _node(self
-0001a1f0: 2c20 6361 6368 652c 2073 7562 6772 6170  , cache, subgrap
-0001a200: 682c 2074 696d 6573 293a 0a20 2020 2020  h, times):.     
-0001a210: 2020 2069 6620 7365 6c66 2e6e 6469 6d3a     if self.ndim:
-0001a220: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001a230: 7572 6e20 7375 7065 7228 292e 5f6e 6f64  urn super()._nod
-0001a240: 6528 6361 6368 652c 2073 7562 6772 6170  e(cache, subgrap
-0001a250: 682c 2074 696d 6573 290a 2020 2020 2020  h, times).      
-0001a260: 2020 656c 6966 2073 656c 6620 696e 2063    elif self in c
-0001a270: 6163 6865 3a0a 2020 2020 2020 2020 2020  ache:.          
-0001a280: 2020 7265 7475 726e 2063 6163 6865 5b73    return cache[s
-0001a290: 656c 665d 0a20 2020 2020 2020 2065 6c73  elf].        els
-0001a2a0: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
-0001a2b0: 6163 6865 5b73 656c 665d 203d 206e 6f64  ache[self] = nod
-0001a2c0: 6520 3d20 4475 706c 6963 6174 6564 4c65  e = DuplicatedLe
-0001a2d0: 6166 4e6f 6465 2827 3027 2c20 2874 7970  afNode('0', (typ
-0001a2e0: 6528 7365 6c66 292e 5f5f 6e61 6d65 5f5f  e(self).__name__
-0001a2f0: 2c20 7469 6d65 735b 7365 6c66 5d29 290a  , times[self])).
-0001a300: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001a310: 726e 206e 6f64 650a 0a20 2020 2064 6566  rn node..    def
-0001a320: 205f 6164 6428 7365 6c66 2c20 6f74 6865   _add(self, othe
-0001a330: 7229 3a0a 2020 2020 2020 2020 7265 7475  r):.        retu
-0001a340: 726e 206f 7468 6572 0a0a 2020 2020 6465  rn other..    de
-0001a350: 6620 5f6d 756c 7469 706c 7928 7365 6c66  f _multiply(self
-0001a360: 2c20 6f74 6865 7229 3a0a 2020 2020 2020  , other):.      
-0001a370: 2020 7265 7475 726e 2073 656c 660a 0a20    return self.. 
-0001a380: 2020 2064 6566 205f 6469 6167 6f6e 616c     def _diagonal
-0001a390: 697a 6528 7365 6c66 2c20 6178 6973 293a  ize(self, axis):
-0001a3a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001a3b0: 5a65 726f 7328 7365 6c66 2e73 6861 7065  Zeros(self.shape
-0001a3c0: 2b28 7365 6c66 2e73 6861 7065 5b61 7869  +(self.shape[axi
-0001a3d0: 735d 2c29 2c20 6474 7970 653d 7365 6c66  s],), dtype=self
-0001a3e0: 2e64 7479 7065 290a 0a20 2020 2064 6566  .dtype)..    def
-0001a3f0: 205f 7375 6d28 7365 6c66 2c20 6178 6973   _sum(self, axis
-0001a400: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0001a410: 6e20 5a65 726f 7328 7365 6c66 2e73 6861  n Zeros(self.sha
-0001a420: 7065 5b3a 6178 6973 5d20 2b20 7365 6c66  pe[:axis] + self
-0001a430: 2e73 6861 7065 5b61 7869 732b 313a 5d2c  .shape[axis+1:],
-0001a440: 2064 7479 7065 3d69 6e74 2069 6620 7365   dtype=int if se
-0001a450: 6c66 2e64 7479 7065 203d 3d20 626f 6f6c  lf.dtype == bool
-0001a460: 2065 6c73 6520 7365 6c66 2e64 7479 7065   else self.dtype
-0001a470: 290a 0a20 2020 2064 6566 205f 7472 616e  )..    def _tran
-0001a480: 7370 6f73 6528 7365 6c66 2c20 6178 6573  spose(self, axes
-0001a490: 293a 0a20 2020 2020 2020 2073 6861 7065  ):.        shape
-0001a4a0: 203d 2074 7570 6c65 2873 656c 662e 7368   = tuple(self.sh
-0001a4b0: 6170 655b 6e5d 2066 6f72 206e 2069 6e20  ape[n] for n in 
-0001a4c0: 6178 6573 290a 2020 2020 2020 2020 7265  axes).        re
-0001a4d0: 7475 726e 205a 6572 6f73 2873 6861 7065  turn Zeros(shape
-0001a4e0: 2c20 6474 7970 653d 7365 6c66 2e64 7479  , dtype=self.dty
-0001a4f0: 7065 290a 0a20 2020 2064 6566 205f 696e  pe)..    def _in
-0001a500: 7365 7274 6178 6973 2873 656c 662c 2061  sertaxis(self, a
-0001a510: 7869 732c 206c 656e 6774 6829 3a0a 2020  xis, length):.  
-0001a520: 2020 2020 2020 7265 7475 726e 205a 6572        return Zer
-0001a530: 6f73 2873 656c 662e 7368 6170 655b 3a61  os(self.shape[:a
-0001a540: 7869 735d 2b28 6c65 6e67 7468 2c29 2b73  xis]+(length,)+s
-0001a550: 656c 662e 7368 6170 655b 6178 6973 3a5d  elf.shape[axis:]
-0001a560: 2c20 7365 6c66 2e64 7479 7065 290a 0a20  , self.dtype).. 
-0001a570: 2020 2064 6566 205f 7461 6b65 6469 6167     def _takediag
-0001a580: 2873 656c 662c 2061 7869 7331 2c20 6178  (self, axis1, ax
-0001a590: 6973 3229 3a0a 2020 2020 2020 2020 7265  is2):.        re
-0001a5a0: 7475 726e 205a 6572 6f73 2873 656c 662e  turn Zeros(self.
-0001a5b0: 7368 6170 655b 3a61 7869 7331 5d2b 7365  shape[:axis1]+se
-0001a5c0: 6c66 2e73 6861 7065 5b61 7869 7331 2b31  lf.shape[axis1+1
-0001a5d0: 3a61 7869 7332 5d2b 7365 6c66 2e73 6861  :axis2]+self.sha
-0001a5e0: 7065 5b61 7869 7332 2b31 3a73 656c 662e  pe[axis2+1:self.
-0001a5f0: 6e64 696d 5d2b 2873 656c 662e 7368 6170  ndim]+(self.shap
-0001a600: 655b 6178 6973 315d 2c29 2c20 6474 7970  e[axis1],), dtyp
-0001a610: 653d 7365 6c66 2e64 7479 7065 290a 0a20  e=self.dtype).. 
-0001a620: 2020 2064 6566 205f 7461 6b65 2873 656c     def _take(sel
-0001a630: 662c 2069 6e64 6578 2c20 6178 6973 293a  f, index, axis):
-0001a640: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001a650: 5a65 726f 7328 7365 6c66 2e73 6861 7065  Zeros(self.shape
-0001a660: 5b3a 6178 6973 5d20 2b20 696e 6465 782e  [:axis] + index.
-0001a670: 7368 6170 6520 2b20 7365 6c66 2e73 6861  shape + self.sha
-0001a680: 7065 5b61 7869 732b 313a 5d2c 2064 7479  pe[axis+1:], dty
-0001a690: 7065 3d73 656c 662e 6474 7970 6529 0a0a  pe=self.dtype)..
-0001a6a0: 2020 2020 6465 6620 5f69 6e66 6c61 7465      def _inflate
-0001a6b0: 2873 656c 662c 2064 6f66 6d61 702c 206c  (self, dofmap, l
-0001a6c0: 656e 6774 682c 2061 7869 7329 3a0a 2020  ength, axis):.  
-0001a6d0: 2020 2020 2020 7265 7475 726e 205a 6572        return Zer
-0001a6e0: 6f73 2873 656c 662e 7368 6170 655b 3a61  os(self.shape[:a
-0001a6f0: 7869 735d 202b 2028 6c65 6e67 7468 2c29  xis] + (length,)
-0001a700: 202b 2073 656c 662e 7368 6170 655b 6178   + self.shape[ax
-0001a710: 6973 2b64 6f66 6d61 702e 6e64 696d 3a5d  is+dofmap.ndim:]
-0001a720: 2c20 6474 7970 653d 7365 6c66 2e64 7479  , dtype=self.dty
-0001a730: 7065 290a 0a20 2020 2064 6566 205f 756e  pe)..    def _un
-0001a740: 7261 7665 6c28 7365 6c66 2c20 6178 6973  ravel(self, axis
-0001a750: 2c20 7368 6170 6529 3a0a 2020 2020 2020  , shape):.      
-0001a760: 2020 7368 6170 6520 3d20 7365 6c66 2e73    shape = self.s
-0001a770: 6861 7065 5b3a 6178 6973 5d20 2b20 7368  hape[:axis] + sh
-0001a780: 6170 6520 2b20 7365 6c66 2e73 6861 7065  ape + self.shape
-0001a790: 5b61 7869 732b 313a 5d0a 2020 2020 2020  [axis+1:].      
-0001a7a0: 2020 7265 7475 726e 205a 6572 6f73 2873    return Zeros(s
-0001a7b0: 6861 7065 2c20 6474 7970 653d 7365 6c66  hape, dtype=self
-0001a7c0: 2e64 7479 7065 290a 0a20 2020 2064 6566  .dtype)..    def
-0001a7d0: 205f 7261 7665 6c28 7365 6c66 2c20 6178   _ravel(self, ax
-0001a7e0: 6973 293a 0a20 2020 2020 2020 2072 6574  is):.        ret
-0001a7f0: 7572 6e20 5a65 726f 7328 7365 6c66 2e73  urn Zeros(self.s
-0001a800: 6861 7065 5b3a 6178 6973 5d20 2b20 2873  hape[:axis] + (s
-0001a810: 656c 662e 7368 6170 655b 6178 6973 5d2a  elf.shape[axis]*
-0001a820: 7365 6c66 2e73 6861 7065 5b61 7869 732b  self.shape[axis+
-0001a830: 315d 2c29 202b 2073 656c 662e 7368 6170  1],) + self.shap
-0001a840: 655b 6178 6973 2b32 3a5d 2c20 7365 6c66  e[axis+2:], self
-0001a850: 2e64 7479 7065 290a 0a20 2020 2064 6566  .dtype)..    def
-0001a860: 205f 6465 7465 726d 696e 616e 7428 7365   _determinant(se
-0001a870: 6c66 2c20 6178 6973 312c 2061 7869 7332  lf, axis1, axis2
-0001a880: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
-0001a890: 7420 6178 6973 3120 213d 2061 7869 7332  t axis1 != axis2
-0001a8a0: 0a20 2020 2020 2020 206c 656e 6774 6820  .        length 
-0001a8b0: 3d20 7365 6c66 2e73 6861 7065 5b61 7869  = self.shape[axi
-0001a8c0: 7331 5d0a 2020 2020 2020 2020 6173 7365  s1].        asse
-0001a8d0: 7274 206c 656e 6774 6820 3d3d 2073 656c  rt length == sel
-0001a8e0: 662e 7368 6170 655b 6178 6973 325d 0a20  f.shape[axis2]. 
-0001a8f0: 2020 2020 2020 2069 2c20 6a20 3d20 736f         i, j = so
-0001a900: 7274 6564 285b 6178 6973 312c 2061 7869  rted([axis1, axi
-0001a910: 7332 5d29 0a20 2020 2020 2020 2073 6861  s2]).        sha
-0001a920: 7065 203d 2028 2a73 656c 662e 7368 6170  pe = (*self.shap
-0001a930: 655b 3a69 5d2c 202a 7365 6c66 2e73 6861  e[:i], *self.sha
-0001a940: 7065 5b69 2b31 3a6a 5d2c 202a 7365 6c66  pe[i+1:j], *self
-0001a950: 2e73 6861 7065 5b6a 2b31 3a5d 290a 2020  .shape[j+1:]).  
-0001a960: 2020 2020 2020 6474 7970 6520 3d20 636f        dtype = co
-0001a970: 6d70 6c65 7820 6966 2073 656c 662e 6474  mplex if self.dt
-0001a980: 7970 6520 3d3d 2063 6f6d 706c 6578 2065  ype == complex e
-0001a990: 6c73 6520 666c 6f61 740a 2020 2020 2020  lse float.      
-0001a9a0: 2020 6966 2069 737a 6572 6f28 6c65 6e67    if iszero(leng
-0001a9b0: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
-0001a9c0: 2072 6574 7572 6e20 6f6e 6573 2873 6861   return ones(sha
-0001a9d0: 7065 2c20 6474 7970 6529 0a20 2020 2020  pe, dtype).     
-0001a9e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001a9f0: 2020 2020 2072 6574 7572 6e20 5a65 726f       return Zero
-0001aa00: 7328 7368 6170 652c 2064 7479 7065 290a  s(shape, dtype).
-0001aa10: 0a20 2020 2040 6361 6368 6564 5f70 726f  .    @cached_pro
-0001aa20: 7065 7274 790a 2020 2020 6465 6620 5f61  perty.    def _a
-0001aa30: 7373 7061 7273 6528 7365 6c66 293a 0a20  ssparse(self):. 
-0001aa40: 2020 2020 2020 2072 6574 7572 6e20 2829         return ()
-0001aa50: 0a0a 2020 2020 6465 6620 5f69 6e74 626f  ..    def _intbo
-0001aa60: 756e 6473 5f69 6d70 6c28 7365 6c66 293a  unds_impl(self):
-0001aa70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001aa80: 302c 2030 0a0a 0a63 6c61 7373 2049 6e66  0, 0...class Inf
-0001aa90: 6c61 7465 2841 7272 6179 293a 0a0a 2020  late(Array):..  
-0001aaa0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-0001aab0: 656c 662c 2066 756e 633a 2041 7272 6179  elf, func: Array
-0001aac0: 2c20 646f 666d 6170 3a20 4172 7261 792c  , dofmap: Array,
-0001aad0: 206c 656e 6774 683a 2041 7272 6179 293a   length: Array):
-0001aae0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001aaf0: 6973 696e 7374 616e 6365 2866 756e 632c  isinstance(func,
-0001ab00: 2041 7272 6179 292c 2066 2766 756e 633d   Array), f'func=
-0001ab10: 7b66 756e 6321 727d 270a 2020 2020 2020  {func!r}'.      
-0001ab20: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-0001ab30: 6e63 6528 646f 666d 6170 2c20 4172 7261  nce(dofmap, Arra
-0001ab40: 7929 2c20 6627 646f 666d 6170 3d7b 646f  y), f'dofmap={do
-0001ab50: 666d 6170 2172 7d27 0a20 2020 2020 2020  fmap!r}'.       
-0001ab60: 2061 7373 6572 7420 5f69 7369 6e64 6578   assert _isindex
-0001ab70: 286c 656e 6774 6829 2c20 6627 6c65 6e67  (length), f'leng
-0001ab80: 7468 3d7b 6c65 6e67 7468 2172 7d27 0a20  th={length!r}'. 
-0001ab90: 2020 2020 2020 2061 7373 6572 7420 6571         assert eq
-0001aba0: 7561 6c73 6861 7065 2866 756e 632e 7368  ualshape(func.sh
-0001abb0: 6170 655b 6675 6e63 2e6e 6469 6d2d 646f  ape[func.ndim-do
-0001abc0: 666d 6170 2e6e 6469 6d3a 5d2c 2064 6f66  fmap.ndim:], dof
-0001abd0: 6d61 702e 7368 6170 6529 2c20 6627 6675  map.shape), f'fu
-0001abe0: 6e63 2e73 6861 7065 3d7b 6675 6e63 2e73  nc.shape={func.s
-0001abf0: 6861 7065 2172 7d2c 2064 6f66 6d61 702e  hape!r}, dofmap.
-0001ac00: 7368 6170 653d 7b64 6f66 6d61 702e 7368  shape={dofmap.sh
-0001ac10: 6170 6521 727d 270a 2020 2020 2020 2020  ape!r}'.        
-0001ac20: 7365 6c66 2e66 756e 6320 3d20 6675 6e63  self.func = func
-0001ac30: 0a20 2020 2020 2020 2073 656c 662e 646f  .        self.do
-0001ac40: 666d 6170 203d 2064 6f66 6d61 700a 2020  fmap = dofmap.  
-0001ac50: 2020 2020 2020 7365 6c66 2e6c 656e 6774        self.lengt
-0001ac60: 6820 3d20 6c65 6e67 7468 0a20 2020 2020  h = length.     
-0001ac70: 2020 2073 656c 662e 7761 726e 203d 206e     self.warn = n
-0001ac80: 6f74 2064 6f66 6d61 702e 6973 636f 6e73  ot dofmap.iscons
-0001ac90: 7461 6e74 0a20 2020 2020 2020 2073 7570  tant.        sup
-0001aca0: 6572 2829 2e5f 5f69 6e69 745f 5f28 6172  er().__init__(ar
-0001acb0: 6773 3d28 6675 6e63 2c20 646f 666d 6170  gs=(func, dofmap
-0001acc0: 2c20 6c65 6e67 7468 292c 2073 6861 7065  , length), shape
-0001acd0: 3d28 2a66 756e 632e 7368 6170 655b 3a66  =(*func.shape[:f
-0001ace0: 756e 632e 6e64 696d 2d64 6f66 6d61 702e  unc.ndim-dofmap.
-0001acf0: 6e64 696d 5d2c 206c 656e 6774 6829 2c20  ndim], length), 
-0001ad00: 6474 7970 653d 6675 6e63 2e64 7479 7065  dtype=func.dtype
-0001ad10: 290a 0a20 2020 2040 6361 6368 6564 5f70  )..    @cached_p
-0001ad20: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0001ad30: 5f64 6961 676f 6e61 6c73 2873 656c 6629  _diagonals(self)
-0001ad40: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0001ad50: 2074 7570 6c65 2861 7865 7320 666f 7220   tuple(axes for 
-0001ad60: 6178 6573 2069 6e20 7365 6c66 2e66 756e  axes in self.fun
-0001ad70: 632e 5f64 6961 676f 6e61 6c73 2069 6620  c._diagonals if 
-0001ad80: 616c 6c28 6178 6973 203c 2073 656c 662e  all(axis < self.
-0001ad90: 6e64 696d 2d31 2066 6f72 2061 7869 7320  ndim-1 for axis 
-0001ada0: 696e 2061 7865 7329 290a 0a20 2020 2040  in axes))..    @
-0001adb0: 6361 6368 6564 5f70 726f 7065 7274 790a  cached_property.
-0001adc0: 2020 2020 6465 6620 5f69 6e66 6c61 7469      def _inflati
-0001add0: 6f6e 7328 7365 6c66 293a 0a20 2020 2020  ons(self):.     
-0001ade0: 2020 2069 6e66 6c61 7469 6f6e 7320 3d20     inflations = 
-0001adf0: 5b28 7365 6c66 2e6e 6469 6d2d 312c 2074  [(self.ndim-1, t
-0001ae00: 7970 6573 2e66 726f 7a65 6e64 6963 7428  ypes.frozendict(
-0001ae10: 7b73 656c 662e 646f 666d 6170 3a20 7365  {self.dofmap: se
-0001ae20: 6c66 2e66 756e 637d 2929 5d0a 2020 2020  lf.func}))].    
-0001ae30: 2020 2020 666f 7220 6178 6973 2c20 7061      for axis, pa
-0001ae40: 7274 7320 696e 2073 656c 662e 6675 6e63  rts in self.func
-0001ae50: 2e5f 696e 666c 6174 696f 6e73 3a0a 2020  ._inflations:.  
-0001ae60: 2020 2020 2020 2020 2020 696e 666c 6174            inflat
-0001ae70: 696f 6e73 2e61 7070 656e 6428 2861 7869  ions.append((axi
-0001ae80: 732c 2074 7970 6573 2e66 726f 7a65 6e64  s, types.frozend
-0001ae90: 6963 7428 2864 6f66 6d61 702c 2049 6e66  ict((dofmap, Inf
-0001aea0: 6c61 7465 2866 756e 632c 2073 656c 662e  late(func, self.
-0001aeb0: 646f 666d 6170 2c20 7365 6c66 2e6c 656e  dofmap, self.len
-0001aec0: 6774 6829 2920 666f 7220 646f 666d 6170  gth)) for dofmap
-0001aed0: 2c20 6675 6e63 2069 6e20 7061 7274 732e  , func in parts.
-0001aee0: 6974 656d 7328 2929 2929 0a20 2020 2020  items()))).     
-0001aef0: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
-0001af00: 696e 666c 6174 696f 6e73 290a 0a20 2020  inflations)..   
-0001af10: 2064 6566 205f 7369 6d70 6c69 6669 6564   def _simplified
-0001af20: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0001af30: 666f 7220 6178 6973 2069 6e20 7261 6e67  for axis in rang
-0001af40: 6528 7365 6c66 2e64 6f66 6d61 702e 6e64  e(self.dofmap.nd
-0001af50: 696d 293a 0a20 2020 2020 2020 2020 2020  im):.           
-0001af60: 2069 6620 5f65 7175 616c 735f 7363 616c   if _equals_scal
-0001af70: 6172 5f63 6f6e 7374 616e 7428 7365 6c66  ar_constant(self
-0001af80: 2e64 6f66 6d61 702e 7368 6170 655b 6178  .dofmap.shape[ax
-0001af90: 6973 5d2c 2031 293a 0a20 2020 2020 2020  is], 1):.       
-0001afa0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001afb0: 496e 666c 6174 6528 5f74 616b 6528 7365  Inflate(_take(se
-0001afc0: 6c66 2e66 756e 632c 2063 6f6e 7374 616e  lf.func, constan
-0001afd0: 7428 3029 2c20 7365 6c66 2e66 756e 632e  t(0), self.func.
-0001afe0: 6e64 696d 2d73 656c 662e 646f 666d 6170  ndim-self.dofmap
-0001aff0: 2e6e 6469 6d2b 6178 6973 292c 205f 7461  .ndim+axis), _ta
-0001b000: 6b65 2873 656c 662e 646f 666d 6170 2c20  ke(self.dofmap, 
-0001b010: 636f 6e73 7461 6e74 2830 292c 2061 7869  constant(0), axi
-0001b020: 7329 2c20 7365 6c66 2e6c 656e 6774 6829  s), self.length)
-0001b030: 0a20 2020 2020 2020 2066 6f72 2061 7869  .        for axi
-0001b040: 732c 2070 6172 7473 2069 6e20 7365 6c66  s, parts in self
-0001b050: 2e66 756e 632e 5f69 6e66 6c61 7469 6f6e  .func._inflation
-0001b060: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-0001b070: 203d 2061 7869 7320 2d20 2873 656c 662e   = axis - (self.
-0001b080: 6e64 696d 2d31 290a 2020 2020 2020 2020  ndim-1).        
-0001b090: 2020 2020 6966 2069 203e 3d20 303a 0a20      if i >= 0:. 
-0001b0a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001b0b0: 6574 7572 6e20 7574 696c 2e73 756d 2849  eturn util.sum(I
-0001b0c0: 6e66 6c61 7465 2866 2c20 5f74 616b 6528  nflate(f, _take(
-0001b0d0: 7365 6c66 2e64 6f66 6d61 702c 2069 6e64  self.dofmap, ind
-0001b0e0: 2c20 6929 2c20 7365 6c66 2e6c 656e 6774  , i), self.lengt
-0001b0f0: 6829 2066 6f72 2069 6e64 2c20 6620 696e  h) for ind, f in
-0001b100: 2070 6172 7473 2e69 7465 6d73 2829 290a   parts.items()).
-0001b110: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001b120: 646f 666d 6170 2e6e 6469 6d20 3d3d 2030  dofmap.ndim == 0
-0001b130: 2061 6e64 205f 6571 7561 6c73 5f73 6361   and _equals_sca
-0001b140: 6c61 725f 636f 6e73 7461 6e74 2873 656c  lar_constant(sel
-0001b150: 662e 646f 666d 6170 2c20 3029 2061 6e64  f.dofmap, 0) and
-0001b160: 205f 6571 7561 6c73 5f73 6361 6c61 725f   _equals_scalar_
-0001b170: 636f 6e73 7461 6e74 2873 656c 662e 6c65  constant(self.le
-0001b180: 6e67 7468 2c20 3129 3a0a 2020 2020 2020  ngth, 1):.      
-0001b190: 2020 2020 2020 7265 7475 726e 2049 6e73        return Ins
-0001b1a0: 6572 7441 7869 7328 7365 6c66 2e66 756e  ertAxis(self.fun
-0001b1b0: 632c 2063 6f6e 7374 616e 7428 3129 290a  c, constant(1)).
-0001b1c0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0001b1d0: 656c 662e 6675 6e63 2e5f 696e 666c 6174  elf.func._inflat
-0001b1e0: 6528 7365 6c66 2e64 6f66 6d61 702c 2073  e(self.dofmap, s
-0001b1f0: 656c 662e 6c65 6e67 7468 2c20 7365 6c66  elf.length, self
-0001b200: 2e6e 6469 6d2d 3129 205c 0a20 2020 2020  .ndim-1) \.     
-0001b210: 2020 2020 2020 206f 7220 7365 6c66 2e64         or self.d
-0001b220: 6f66 6d61 702e 5f72 696e 666c 6174 6528  ofmap._rinflate(
-0001b230: 7365 6c66 2e66 756e 632c 2073 656c 662e  self.func, self.
-0001b240: 6c65 6e67 7468 2c20 7365 6c66 2e6e 6469  length, self.ndi
-0001b250: 6d2d 3129 0a0a 2020 2020 6465 6620 6576  m-1)..    def ev
-0001b260: 616c 6628 7365 6c66 2c20 6172 7261 792c  alf(self, array,
-0001b270: 2069 6e64 6963 6573 2c20 6c65 6e67 7468   indices, length
-0001b280: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
-0001b290: 7420 696e 6469 6365 732e 6e64 696d 203d  t indices.ndim =
-0001b2a0: 3d20 7365 6c66 2e64 6f66 6d61 702e 6e64  = self.dofmap.nd
-0001b2b0: 696d 0a20 2020 2020 2020 2061 7373 6572  im.        asser
-0001b2c0: 7420 6c65 6e67 7468 2e6e 6469 6d20 3d3d  t length.ndim ==
-0001b2d0: 2030 0a20 2020 2020 2020 2069 6620 7365   0.        if se
-0001b2e0: 6c66 2e77 6172 6e20 616e 6420 696e 7428  lf.warn and int(
-0001b2f0: 6c65 6e67 7468 2920 3e20 696e 6469 6365  length) > indice
-0001b300: 732e 7369 7a65 3a0a 2020 2020 2020 2020  s.size:.        
-0001b310: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
-0001b320: 6e28 2775 7369 6e67 2065 7870 6c69 6369  n('using explici
-0001b330: 7420 696e 666c 6174 696f 6e3b 2074 6869  t inflation; thi
-0001b340: 7320 6973 2075 7375 616c 6c79 2061 2062  s is usually a b
-0001b350: 7567 2e27 2c20 4578 7065 6e73 6976 6545  ug.', ExpensiveE
-0001b360: 7661 6c75 6174 696f 6e57 6172 6e69 6e67  valuationWarning
-0001b370: 290a 2020 2020 2020 2020 696e 666c 6174  ).        inflat
-0001b380: 6564 203d 206e 756d 7079 2e7a 6572 6f73  ed = numpy.zeros
-0001b390: 2861 7272 6179 2e73 6861 7065 5b3a 6172  (array.shape[:ar
-0001b3a0: 7261 792e 6e64 696d 2d69 6e64 6963 6573  ray.ndim-indices
-0001b3b0: 2e6e 6469 6d5d 202b 2028 6c65 6e67 7468  .ndim] + (length
-0001b3c0: 2c29 2c20 6474 7970 653d 7365 6c66 2e64  ,), dtype=self.d
-0001b3d0: 7479 7065 290a 2020 2020 2020 2020 6e75  type).        nu
-0001b3e0: 6d70 792e 6164 642e 6174 2869 6e66 6c61  mpy.add.at(infla
-0001b3f0: 7465 642c 2028 736c 6963 6528 4e6f 6e65  ted, (slice(None
-0001b400: 292c 292a 2873 656c 662e 6e64 696d 2d31  ),)*(self.ndim-1
-0001b410: 292b 2869 6e64 6963 6573 2c29 2c20 6172  )+(indices,), ar
-0001b420: 7261 7929 0a20 2020 2020 2020 2072 6574  ray).        ret
-0001b430: 7572 6e20 696e 666c 6174 6564 0a0a 2020  urn inflated..  
-0001b440: 2020 6465 6620 5f69 6e66 6c61 7465 2873    def _inflate(s
-0001b450: 656c 662c 2064 6f66 6d61 702c 206c 656e  elf, dofmap, len
-0001b460: 6774 682c 2061 7869 7329 3a0a 2020 2020  gth, axis):.    
-0001b470: 2020 2020 6966 2064 6f66 6d61 702e 6e64      if dofmap.nd
-0001b480: 696d 203d 3d20 3020 616e 6420 646f 666d  im == 0 and dofm
-0001b490: 6170 203d 3d20 7365 6c66 2e64 6f66 6d61  ap == self.dofma
-0001b4a0: 7020 616e 6420 6c65 6e67 7468 203d 3d20  p and length == 
-0001b4b0: 7365 6c66 2e6c 656e 6774 683a 0a20 2020  self.length:.   
-0001b4c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001b4d0: 6469 6167 6f6e 616c 697a 6528 7365 6c66  diagonalize(self
-0001b4e0: 2c20 2d31 2c20 6178 6973 290a 0a20 2020  , -1, axis)..   
-0001b4f0: 2064 6566 205f 6465 7269 7661 7469 7665   def _derivative
-0001b500: 2873 656c 662c 2076 6172 2c20 7365 656e  (self, var, seen
-0001b510: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0001b520: 6e20 5f69 6e66 6c61 7465 2864 6572 6976  n _inflate(deriv
-0001b530: 6174 6976 6528 7365 6c66 2e66 756e 632c  ative(self.func,
-0001b540: 2076 6172 2c20 7365 656e 292c 2073 656c   var, seen), sel
-0001b550: 662e 646f 666d 6170 2c20 7365 6c66 2e6c  f.dofmap, self.l
-0001b560: 656e 6774 682c 2073 656c 662e 6e64 696d  ength, self.ndim
-0001b570: 2d31 290a 0a20 2020 2064 6566 205f 6d75  -1)..    def _mu
-0001b580: 6c74 6970 6c79 2873 656c 662c 206f 7468  ltiply(self, oth
-0001b590: 6572 293a 0a20 2020 2020 2020 2072 6574  er):.        ret
-0001b5a0: 7572 6e20 496e 666c 6174 6528 6d75 6c74  urn Inflate(mult
-0001b5b0: 6970 6c79 2873 656c 662e 6675 6e63 2c20  iply(self.func, 
-0001b5c0: 5461 6b65 286f 7468 6572 2c20 7365 6c66  Take(other, self
-0001b5d0: 2e64 6f66 6d61 7029 292c 2073 656c 662e  .dofmap)), self.
-0001b5e0: 646f 666d 6170 2c20 7365 6c66 2e6c 656e  dofmap, self.len
-0001b5f0: 6774 6829 0a0a 2020 2020 6465 6620 5f61  gth)..    def _a
-0001b600: 6464 2873 656c 662c 206f 7468 6572 293a  dd(self, other):
-0001b610: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0001b620: 7374 616e 6365 286f 7468 6572 2c20 496e  stance(other, In
-0001b630: 666c 6174 6529 2061 6e64 2073 656c 662e  flate) and self.
-0001b640: 646f 666d 6170 203d 3d20 6f74 6865 722e  dofmap == other.
-0001b650: 646f 666d 6170 3a0a 2020 2020 2020 2020  dofmap:.        
-0001b660: 2020 2020 7265 7475 726e 2049 6e66 6c61      return Infla
-0001b670: 7465 2861 6464 2873 656c 662e 6675 6e63  te(add(self.func
-0001b680: 2c20 6f74 6865 722e 6675 6e63 292c 2073  , other.func), s
-0001b690: 656c 662e 646f 666d 6170 2c20 7365 6c66  elf.dofmap, self
-0001b6a0: 2e6c 656e 6774 6829 0a0a 2020 2020 6465  .length)..    de
-0001b6b0: 6620 5f74 616b 6564 6961 6728 7365 6c66  f _takediag(self
-0001b6c0: 2c20 6178 6973 312c 2061 7869 7332 293a  , axis1, axis2):
-0001b6d0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001b6e0: 6178 6973 3120 3c20 6178 6973 320a 2020  axis1 < axis2.  
-0001b6f0: 2020 2020 2020 6966 2061 7869 7332 203d        if axis2 =
-0001b700: 3d20 7365 6c66 2e6e 6469 6d2d 313a 0a20  = self.ndim-1:. 
-0001b710: 2020 2020 2020 2020 2020 2066 756e 6320             func 
-0001b720: 3d20 5f74 616b 6528 7365 6c66 2e66 756e  = _take(self.fun
-0001b730: 632c 2073 656c 662e 646f 666d 6170 2c20  c, self.dofmap, 
-0001b740: 6178 6973 3129 0a20 2020 2020 2020 2020  axis1).         
-0001b750: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-0001b760: 6528 7365 6c66 2e64 6f66 6d61 702e 6e64  e(self.dofmap.nd
-0001b770: 696d 293a 0a20 2020 2020 2020 2020 2020  im):.           
-0001b780: 2020 2020 2066 756e 6320 3d20 5f74 616b       func = _tak
-0001b790: 6564 6961 6728 6675 6e63 2c20 6178 6973  ediag(func, axis
-0001b7a0: 312c 2061 7869 7332 2b73 656c 662e 646f  1, axis2+self.do
-0001b7b0: 666d 6170 2e6e 6469 6d2d 312d 6929 0a20  fmap.ndim-1-i). 
-0001b7c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001b7d0: 6e20 496e 666c 6174 6528 6675 6e63 2c20  n Inflate(func, 
-0001b7e0: 7365 6c66 2e64 6f66 6d61 702c 2073 656c  self.dofmap, sel
-0001b7f0: 662e 6c65 6e67 7468 290a 2020 2020 2020  f.length).      
-0001b800: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001b810: 2020 2020 7265 7475 726e 205f 696e 666c      return _infl
-0001b820: 6174 6528 5f74 616b 6564 6961 6728 7365  ate(_takediag(se
-0001b830: 6c66 2e66 756e 632c 2061 7869 7331 2c20  lf.func, axis1, 
-0001b840: 6178 6973 3229 2c20 7365 6c66 2e64 6f66  axis2), self.dof
-0001b850: 6d61 702c 2073 656c 662e 6c65 6e67 7468  map, self.length
-0001b860: 2c20 7365 6c66 2e6e 6469 6d2d 3329 0a0a  , self.ndim-3)..
-0001b870: 2020 2020 6465 6620 5f74 616b 6528 7365      def _take(se
-0001b880: 6c66 2c20 696e 6465 782c 2061 7869 7329  lf, index, axis)
-0001b890: 3a0a 2020 2020 2020 2020 6966 2061 7869  :.        if axi
-0001b8a0: 7320 213d 2073 656c 662e 6e64 696d 2d31  s != self.ndim-1
-0001b8b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001b8c0: 7475 726e 2049 6e66 6c61 7465 285f 7461  turn Inflate(_ta
-0001b8d0: 6b65 2873 656c 662e 6675 6e63 2c20 696e  ke(self.func, in
-0001b8e0: 6465 782c 2061 7869 7329 2c20 7365 6c66  dex, axis), self
-0001b8f0: 2e64 6f66 6d61 702c 2073 656c 662e 6c65  .dofmap, self.le
-0001b900: 6e67 7468 290a 2020 2020 2020 2020 6e65  ngth).        ne
-0001b910: 7769 6e64 6578 2c20 6e65 7764 6f66 6d61  windex, newdofma
-0001b920: 7020 3d20 5377 6170 496e 666c 6174 6554  p = SwapInflateT
-0001b930: 616b 6528 7365 6c66 2e64 6f66 6d61 702c  ake(self.dofmap,
-0001b940: 2069 6e64 6578 290a 2020 2020 2020 2020   index).        
-0001b950: 6966 2073 656c 662e 646f 666d 6170 2e6e  if self.dofmap.n
-0001b960: 6469 6d3a 0a20 2020 2020 2020 2020 2020  dim:.           
-0001b970: 2066 756e 6320 3d20 7365 6c66 2e66 756e   func = self.fun
-0001b980: 630a 2020 2020 2020 2020 2020 2020 666f  c.            fo
-0001b990: 7220 6920 696e 2072 616e 6765 2873 656c  r i in range(sel
-0001b9a0: 662e 646f 666d 6170 2e6e 6469 6d2d 3129  f.dofmap.ndim-1)
-0001b9b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001b9c0: 2020 6675 6e63 203d 2052 6176 656c 2866    func = Ravel(f
-0001b9d0: 756e 6329 0a20 2020 2020 2020 2020 2020  unc).           
-0001b9e0: 2069 6e74 6572 7365 6374 696f 6e20 3d20   intersection = 
-0001b9f0: 5461 6b65 2866 756e 632c 206e 6577 696e  Take(func, newin
-0001ba00: 6465 7829 0a20 2020 2020 2020 2065 6c73  dex).        els
-0001ba10: 653a 2020 2320 6b72 6f6e 6563 6b65 723b  e:  # kronecker;
-0001ba20: 206e 6577 696e 6465 7820 6973 2061 6c6c   newindex is all
-0001ba30: 207a 6572 6f73 2028 6275 7420 6f66 2076   zeros (but of v
-0001ba40: 6172 7969 6e67 206c 656e 6774 6829 0a20  arying length). 
-0001ba50: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
-0001ba60: 7365 6374 696f 6e20 3d20 496e 7365 7274  section = Insert
-0001ba70: 4178 6973 2873 656c 662e 6675 6e63 2c20  Axis(self.func, 
-0001ba80: 6e65 7769 6e64 6578 2e73 6861 7065 5b30  newindex.shape[0
-0001ba90: 5d29 0a20 2020 2020 2020 2069 6620 696e  ]).        if in
-0001baa0: 6465 782e 6e64 696d 3a0a 2020 2020 2020  dex.ndim:.      
-0001bab0: 2020 2020 2020 7377 6170 7065 6420 3d20        swapped = 
-0001bac0: 496e 666c 6174 6528 696e 7465 7273 6563  Inflate(intersec
-0001bad0: 7469 6f6e 2c20 6e65 7764 6f66 6d61 702c  tion, newdofmap,
-0001bae0: 2075 7469 6c2e 7072 6f64 7563 7428 696e   util.product(in
-0001baf0: 6465 782e 7368 6170 6529 290a 2020 2020  dex.shape)).    
-0001bb00: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-0001bb10: 2072 616e 6765 2869 6e64 6578 2e6e 6469   range(index.ndi
-0001bb20: 6d2d 3129 3a0a 2020 2020 2020 2020 2020  m-1):.          
-0001bb30: 2020 2020 2020 7377 6170 7065 6420 3d20        swapped = 
-0001bb40: 556e 7261 7665 6c28 7377 6170 7065 642c  Unravel(swapped,
-0001bb50: 2069 6e64 6578 2e73 6861 7065 5b69 5d2c   index.shape[i],
-0001bb60: 2075 7469 6c2e 7072 6f64 7563 7428 696e   util.product(in
-0001bb70: 6465 782e 7368 6170 655b 692b 313a 5d29  dex.shape[i+1:])
-0001bb80: 290a 2020 2020 2020 2020 656c 7365 3a20  ).        else: 
-0001bb90: 2023 2067 6574 3b20 6e65 7764 6f66 6d61   # get; newdofma
-0001bba0: 7020 6973 2061 6c6c 207a 6572 6f73 2028  p is all zeros (
-0001bbb0: 6275 7420 6f66 2076 6172 7969 6e67 206c  but of varying l
-0001bbc0: 656e 6774 6829 0a20 2020 2020 2020 2020  ength).         
-0001bbd0: 2020 2073 7761 7070 6564 203d 2053 756d     swapped = Sum
-0001bbe0: 2869 6e74 6572 7365 6374 696f 6e29 0a20  (intersection). 
-0001bbf0: 2020 2020 2020 2072 6574 7572 6e20 7377         return sw
-0001bc00: 6170 7065 640a 0a20 2020 2064 6566 205f  apped..    def _
-0001bc10: 6469 6167 6f6e 616c 697a 6528 7365 6c66  diagonalize(self
-0001bc20: 2c20 6178 6973 293a 0a20 2020 2020 2020  , axis):.       
-0001bc30: 2069 6620 6178 6973 2021 3d20 7365 6c66   if axis != self
-0001bc40: 2e6e 6469 6d2d 313a 0a20 2020 2020 2020  .ndim-1:.       
-0001bc50: 2020 2020 2072 6574 7572 6e20 5f69 6e66       return _inf
-0001bc60: 6c61 7465 2864 6961 676f 6e61 6c69 7a65  late(diagonalize
-0001bc70: 2873 656c 662e 6675 6e63 2c20 6178 6973  (self.func, axis
-0001bc80: 292c 2073 656c 662e 646f 666d 6170 2c20  ), self.dofmap, 
-0001bc90: 7365 6c66 2e6c 656e 6774 682c 2073 656c  self.length, sel
-0001bca0: 662e 6e64 696d 2d31 290a 0a20 2020 2064  f.ndim-1)..    d
-0001bcb0: 6566 205f 7375 6d28 7365 6c66 2c20 6178  ef _sum(self, ax
-0001bcc0: 6973 293a 0a20 2020 2020 2020 2069 6620  is):.        if 
-0001bcd0: 6178 6973 203d 3d20 7365 6c66 2e6e 6469  axis == self.ndi
-0001bce0: 6d2d 313a 0a20 2020 2020 2020 2020 2020  m-1:.           
-0001bcf0: 2066 756e 6320 3d20 7365 6c66 2e66 756e   func = self.fun
-0001bd00: 630a 2020 2020 2020 2020 2020 2020 666f  c.            fo
-0001bd10: 7220 6920 696e 2072 616e 6765 2873 656c  r i in range(sel
-0001bd20: 662e 646f 666d 6170 2e6e 6469 6d29 3a0a  f.dofmap.ndim):.
-0001bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bd40: 6675 6e63 203d 2053 756d 2866 756e 6329  func = Sum(func)
-0001bd50: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001bd60: 7572 6e20 6675 6e63 0a20 2020 2020 2020  urn func.       
-0001bd70: 2072 6574 7572 6e20 496e 666c 6174 6528   return Inflate(
-0001bd80: 7375 6d28 7365 6c66 2e66 756e 632c 2061  sum(self.func, a
-0001bd90: 7869 7329 2c20 7365 6c66 2e64 6f66 6d61  xis), self.dofma
-0001bda0: 702c 2073 656c 662e 6c65 6e67 7468 290a  p, self.length).
-0001bdb0: 0a20 2020 2064 6566 205f 756e 7261 7665  .    def _unrave
-0001bdc0: 6c28 7365 6c66 2c20 6178 6973 2c20 7368  l(self, axis, sh
-0001bdd0: 6170 6529 3a0a 2020 2020 2020 2020 6966  ape):.        if
-0001bde0: 2061 7869 7320 213d 2073 656c 662e 6e64   axis != self.nd
-0001bdf0: 696d 2d31 3a0a 2020 2020 2020 2020 2020  im-1:.          
-0001be00: 2020 7265 7475 726e 2049 6e66 6c61 7465    return Inflate
-0001be10: 2875 6e72 6176 656c 2873 656c 662e 6675  (unravel(self.fu
-0001be20: 6e63 2c20 6178 6973 2c20 7368 6170 6529  nc, axis, shape)
-0001be30: 2c20 7365 6c66 2e64 6f66 6d61 702c 2073  , self.dofmap, s
-0001be40: 656c 662e 6c65 6e67 7468 290a 0a20 2020  elf.length)..   
-0001be50: 2064 6566 205f 7369 676e 2873 656c 6629   def _sign(self)
-0001be60: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
-0001be70: 662e 646f 666d 6170 2e69 7363 6f6e 7374  f.dofmap.isconst
-0001be80: 616e 7420 616e 6420 5f69 7375 6e69 7175  ant and _isuniqu
-0001be90: 6528 7365 6c66 2e64 6f66 6d61 702e 6576  e(self.dofmap.ev
-0001bea0: 616c 2829 293a 0a20 2020 2020 2020 2020  al()):.         
-0001beb0: 2020 2072 6574 7572 6e20 496e 666c 6174     return Inflat
-0001bec0: 6528 5369 676e 2873 656c 662e 6675 6e63  e(Sign(self.func
-0001bed0: 292c 2073 656c 662e 646f 666d 6170 2c20  ), self.dofmap, 
-0001bee0: 7365 6c66 2e6c 656e 6774 6829 0a0a 2020  self.length)..  
-0001bef0: 2020 4063 6163 6865 645f 7072 6f70 6572    @cached_proper
-0001bf00: 7479 0a20 2020 2064 6566 205f 6173 7370  ty.    def _assp
-0001bf10: 6172 7365 2873 656c 6629 3a0a 2020 2020  arse(self):.    
-0001bf20: 2020 2020 6368 756e 6b73 203d 205b 5d0a      chunks = [].
-0001bf30: 2020 2020 2020 2020 666c 6174 5f64 6f66          flat_dof
-0001bf40: 6d61 7020 3d20 5f66 6c61 7428 7365 6c66  map = _flat(self
-0001bf50: 2e64 6f66 6d61 7029 0a20 2020 2020 2020  .dofmap).       
-0001bf60: 206b 6565 705f 6469 6d20 3d20 7365 6c66   keep_dim = self
-0001bf70: 2e66 756e 632e 6e64 696d 202d 2073 656c  .func.ndim - sel
-0001bf80: 662e 646f 666d 6170 2e6e 6469 6d0a 2020  f.dofmap.ndim.  
-0001bf90: 2020 2020 2020 7374 7269 6465 7320 3d20        strides = 
-0001bfa0: 2831 2c20 2a69 7465 7274 6f6f 6c73 2e61  (1, *itertools.a
-0001bfb0: 6363 756d 756c 6174 6528 7365 6c66 2e64  ccumulate(self.d
-0001bfc0: 6f66 6d61 702e 7368 6170 655b 3a30 3a2d  ofmap.shape[:0:-
-0001bfd0: 315d 2c20 6f70 6572 6174 6f72 2e6d 756c  1], operator.mul
-0001bfe0: 2929 5b3a 3a2d 315d 0a20 2020 2020 2020  ))[::-1].       
-0001bff0: 2066 6f72 202a 696e 6469 6365 732c 2076   for *indices, v
-0001c000: 616c 7565 7320 696e 2073 656c 662e 6675  alues in self.fu
-0001c010: 6e63 2e5f 6173 7370 6172 7365 3a0a 2020  nc._assparse:.  
-0001c020: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0001c030: 662e 646f 666d 6170 2e6e 6469 6d3a 0a20  f.dofmap.ndim:. 
-0001c040: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001c050: 6e66 6c61 7465 5f69 6e64 6963 6573 203d  nflate_indices =
-0001c060: 2054 616b 6528 666c 6174 5f64 6f66 6d61   Take(flat_dofma
-0001c070: 702c 2066 756e 6374 6f6f 6c73 2e72 6564  p, functools.red
-0001c080: 7563 6528 6f70 6572 6174 6f72 2e61 6464  uce(operator.add
-0001c090: 2c20 6d61 7028 6f70 6572 6174 6f72 2e6d  , map(operator.m
-0001c0a0: 756c 2c20 696e 6469 6365 735b 6b65 6570  ul, indices[keep
-0001c0b0: 5f64 696d 3a5d 2c20 7374 7269 6465 7329  _dim:], strides)
-0001c0c0: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
-0001c0d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001c0e0: 2020 2020 2069 6e66 6c61 7465 5f69 6e64       inflate_ind
-0001c0f0: 6963 6573 203d 2061 7070 656e 6461 7865  ices = appendaxe
-0001c100: 7328 7365 6c66 2e64 6f66 6d61 702c 2076  s(self.dofmap, v
-0001c110: 616c 7565 732e 7368 6170 6529 0a20 2020  alues.shape).   
-0001c120: 2020 2020 2020 2020 2063 6875 6e6b 732e           chunks.
-0001c130: 6170 7065 6e64 2828 2a69 6e64 6963 6573  append((*indices
-0001c140: 5b3a 6b65 6570 5f64 696d 5d2c 2069 6e66  [:keep_dim], inf
-0001c150: 6c61 7465 5f69 6e64 6963 6573 2c20 7661  late_indices, va
-0001c160: 6c75 6573 2929 0a20 2020 2020 2020 2072  lues)).        r
-0001c170: 6574 7572 6e20 7475 706c 6528 6368 756e  eturn tuple(chun
-0001c180: 6b73 290a 0a20 2020 2064 6566 205f 696e  ks)..    def _in
-0001c190: 7462 6f75 6e64 735f 696d 706c 2873 656c  tbounds_impl(sel
-0001c1a0: 6629 3a0a 2020 2020 2020 2020 6c6f 7765  f):.        lowe
-0001c1b0: 722c 2075 7070 6572 203d 2073 656c 662e  r, upper = self.
-0001c1c0: 6675 6e63 2e5f 696e 7462 6f75 6e64 730a  func._intbounds.
-0001c1d0: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-0001c1e0: 696e 286c 6f77 6572 2c20 3029 2c20 6d61  in(lower, 0), ma
-0001c1f0: 7828 7570 7065 722c 2030 290a 0a0a 636c  x(upper, 0)...cl
-0001c200: 6173 7320 5377 6170 496e 666c 6174 6554  ass SwapInflateT
-0001c210: 616b 6528 4576 616c 7561 626c 6529 3a0a  ake(Evaluable):.
-0001c220: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-0001c230: 5f28 7365 6c66 2c20 696e 666c 6174 6569  _(self, inflatei
-0001c240: 6478 2c20 7461 6b65 6964 7829 3a0a 2020  dx, takeidx):.  
-0001c250: 2020 2020 2020 7365 6c66 2e69 6e66 6c61        self.infla
-0001c260: 7465 6964 7820 3d20 696e 666c 6174 6569  teidx = inflatei
-0001c270: 6478 0a20 2020 2020 2020 2073 656c 662e  dx.        self.
-0001c280: 7461 6b65 6964 7820 3d20 7461 6b65 6964  takeidx = takeid
-0001c290: 780a 2020 2020 2020 2020 7375 7065 7228  x.        super(
-0001c2a0: 292e 5f5f 696e 6974 5f5f 2861 7267 733d  ).__init__(args=
-0001c2b0: 2869 6e66 6c61 7465 6964 782c 2074 616b  (inflateidx, tak
-0001c2c0: 6569 6478 2929 0a0a 2020 2020 6465 6620  eidx))..    def 
-0001c2d0: 5f73 696d 706c 6966 6965 6428 7365 6c66  _simplified(self
-0001c2e0: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
-0001c2f0: 6c66 2e69 7363 6f6e 7374 616e 743a 0a20  lf.isconstant:. 
-0001c300: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001c310: 6e20 5475 706c 6528 7475 706c 6528 6d61  n Tuple(tuple(ma
-0001c320: 7028 636f 6e73 7461 6e74 2c20 7365 6c66  p(constant, self
-0001c330: 2e65 7661 6c28 2929 2929 0a0a 2020 2020  .eval())))..    
-0001c340: 6465 6620 5f5f 6974 6572 5f5f 2873 656c  def __iter__(sel
-0001c350: 6629 3a0a 2020 2020 2020 2020 7368 6170  f):.        shap
-0001c360: 6520 3d20 4172 7261 7946 726f 6d54 7570  e = ArrayFromTup
-0001c370: 6c65 2873 656c 662c 2069 6e64 6578 3d32  le(self, index=2
-0001c380: 2c20 7368 6170 653d 2829 2c20 6474 7970  , shape=(), dtyp
-0001c390: 653d 696e 742c 205f 6c6f 7765 723d 3029  e=int, _lower=0)
-0001c3a0: 2c0a 2020 2020 2020 2020 7265 7475 726e  ,.        return
-0001c3b0: 2028 4172 7261 7946 726f 6d54 7570 6c65   (ArrayFromTuple
-0001c3c0: 2873 656c 662c 2069 6e64 6578 3d69 6e64  (self, index=ind
-0001c3d0: 6578 2c20 7368 6170 653d 7368 6170 652c  ex, shape=shape,
-0001c3e0: 2064 7479 7065 3d69 6e74 2c20 5f6c 6f77   dtype=int, _low
-0001c3f0: 6572 3d30 2920 666f 7220 696e 6465 7820  er=0) for index 
-0001c400: 696e 2072 616e 6765 2832 2929 0a0a 2020  in range(2))..  
-0001c410: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
-0001c420: 2020 2020 6465 6620 6576 616c 6628 696e      def evalf(in
-0001c430: 666c 6174 6569 6478 2c20 7461 6b65 6964  flateidx, takeid
-0001c440: 7829 3a0a 2020 2020 2020 2020 756e 6971  x):.        uniq
-0001c450: 7565 696e 666c 6174 6520 3d20 5f69 7375  ueinflate = _isu
-0001c460: 6e69 7175 6528 696e 666c 6174 6569 6478  nique(inflateidx
-0001c470: 290a 2020 2020 2020 2020 756e 6971 7565  ).        unique
-0001c480: 7461 6b65 203d 205f 6973 756e 6971 7565  take = _isunique
-0001c490: 2874 616b 6569 6478 290a 2020 2020 2020  (takeidx).      
-0001c4a0: 2020 756e 6971 7565 203d 2075 6e69 7175    unique = uniqu
-0001c4b0: 6569 6e66 6c61 7465 2061 6e64 2075 6e69  einflate and uni
-0001c4c0: 7175 6574 616b 650a 2020 2020 2020 2020  quetake.        
-0001c4d0: 2320 4966 2062 6f74 6820 696e 6469 6365  # If both indice
-0001c4e0: 7320 6172 6520 756e 6971 7565 2028 692e  s are unique (i.
-0001c4f0: 652e 2074 6865 7920 646f 206e 6f74 2063  e. they do not c
-0001c500: 6f6e 7461 696e 2064 7570 6c69 6361 7465  ontain duplicate
-0001c510: 7329 2074 6865 6e20 7468 650a 2020 2020  s) then the.    
-0001c520: 2020 2020 2320 7461 6b65 2061 6e64 2069      # take and i
-0001c530: 6e66 6c61 7465 206f 7065 7261 7469 6f6e  nflate operation
-0001c540: 7320 6361 6e20 7369 6d70 6c79 2062 6520  s can simply be 
-0001c550: 7265 7374 7269 6374 6564 2074 6f20 7468  restricted to th
-0001c560: 6520 696e 7465 7273 6563 7469 6f6e 2c0a  e intersection,.
-0001c570: 2020 2020 2020 2020 2320 7769 7468 2074          # with t
-0001c580: 6865 2074 6865 206c 6f63 6174 696f 6e20  he the location 
-0001c590: 6f66 2074 6865 2069 6e74 6572 7365 6374  of the intersect
-0001c5a0: 696f 6e20 696e 2074 6865 206f 7269 6769  ion in the origi
-0001c5b0: 6e61 6c20 696e 6465 7820 7665 6374 6f72  nal index vector
-0001c5c0: 730a 2020 2020 2020 2020 2320 6265 696e  s.        # bein
-0001c5d0: 6720 7468 6520 6e65 7720 696e 6469 6365  g the new indice
-0001c5e0: 7320 666f 7220 7468 6520 7377 6170 7065  s for the swappe
-0001c5f0: 6420 6f70 6572 6174 696f 6e73 2e0a 2020  d operations..  
-0001c600: 2020 2020 2020 696e 7465 7273 6563 7469        intersecti
-0001c610: 6f6e 2c20 7375 6269 6e66 6c61 7465 2c20  on, subinflate, 
-0001c620: 7375 6274 616b 6520 3d20 6e75 6d70 792e  subtake = numpy.
-0001c630: 696e 7465 7273 6563 7431 6428 696e 666c  intersect1d(infl
-0001c640: 6174 6569 6478 2c20 7461 6b65 6964 782c  ateidx, takeidx,
-0001c650: 2072 6574 7572 6e5f 696e 6469 6365 733d   return_indices=
-0001c660: 5472 7565 2c20 6173 7375 6d65 5f75 6e69  True, assume_uni
-0001c670: 7175 653d 756e 6971 7565 290a 2020 2020  que=unique).    
-0001c680: 2020 2020 6966 2075 6e69 7175 653a 0a20      if unique:. 
-0001c690: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001c6a0: 6e20 7375 6269 6e66 6c61 7465 2c20 7375  n subinflate, su
-0001c6b0: 6274 616b 652c 206e 756d 7079 2e61 7272  btake, numpy.arr
-0001c6c0: 6179 286c 656e 2869 6e74 6572 7365 6374  ay(len(intersect
-0001c6d0: 696f 6e29 290a 2020 2020 2020 2020 2320  ion)).        # 
-0001c6e0: 4f74 6865 7277 6973 652c 2077 6869 6c65  Otherwise, while
-0001c6f0: 2073 7469 6c6c 206c 696d 6974 696e 6720   still limiting 
-0001c700: 7468 6520 6f70 6572 6174 696f 6e73 2074  the operations t
-0001c710: 6f20 7468 6520 696e 7465 7273 6563 7469  o the intersecti
-0001c720: 6f6e 2c20 7765 0a20 2020 2020 2020 2023  on, we.        #
-0001c730: 206e 6565 6420 746f 2061 6464 2074 6865   need to add the
-0001c740: 2061 7070 726f 7072 6961 7465 2064 7570   appropriate dup
-0001c750: 6c69 6361 7469 6f6e 7320 6f6e 2065 6974  lications on eit
-0001c760: 6865 7220 7369 6465 2e20 5468 6520 6561  her side. The ea
-0001c770: 7369 6573 7420 7761 790a 2020 2020 2020  siest way.      
-0001c780: 2020 2320 746f 2064 6f20 7468 6973 2069    # to do this i
-0001c790: 7320 746f 2066 6f72 6d20 7468 6520 7065  s to form the pe
-0001c7a0: 726d 7574 6174 696f 6e20 6d61 7472 6978  rmutation matrix
-0001c7b0: 2041 2066 6f72 2074 616b 6520 286d 6179   A for take (may
-0001c7c0: 2063 6f6e 7461 696e 0a20 2020 2020 2020   contain.       
-0001c7d0: 2023 206d 756c 7469 706c 6520 6974 656d   # multiple item
-0001c7e0: 7320 7065 7220 636f 6c75 6d6e 2920 616e  s per column) an
-0001c7f0: 6420 4220 666f 7220 696e 666c 6174 6520  d B for inflate 
-0001c800: 286d 6179 2063 6f6e 7461 696e 2073 6576  (may contain sev
-0001c810: 6572 616c 2069 7465 6d73 0a20 2020 2020  eral items.     
-0001c820: 2020 2023 2070 6572 2072 6f77 2920 616e     # per row) an
-0001c830: 6420 7461 6b65 2074 6865 2070 726f 6475  d take the produ
-0001c840: 6374 2041 4220 666f 7220 7468 6520 636f  ct AB for the co
-0001c850: 6d62 696e 6564 206f 7065 7261 7469 6f6e  mbined operation
-0001c860: 2e20 546f 2074 6865 6e0a 2020 2020 2020  . To then.      
-0001c870: 2020 2320 6465 636f 6d70 6f73 6520 4142    # decompose AB
-0001c880: 2069 6e74 6f20 7468 6520 6571 7569 7661   into the equiva
-0001c890: 6c65 6e74 2074 616b 6520 666f 6c6c 6f77  lent take follow
-0001c8a0: 6564 2062 7920 696e 666c 6174 6520 7765  ed by inflate we
-0001c8b0: 2063 616e 2073 696d 706c 790a 2020 2020   can simply.    
-0001c8c0: 2020 2020 2320 7461 6b65 2074 6865 2074      # take the t
-0001c8d0: 776f 2069 6e64 6578 2076 6563 746f 7273  wo index vectors
-0001c8e0: 2066 726f 6d20 4142 2e6e 6f6e 7a65 726f   from AB.nonzero
-0001c8f0: 2829 2061 6e64 2066 6f72 6d20 4344 203d  () and form CD =
-0001c900: 2041 422e 2054 6865 0a20 2020 2020 2020   AB. The.       
-0001c910: 2023 2061 6c67 6f72 6974 686d 2062 656c   # algorithm bel
-0001c920: 6f77 2064 6f65 7320 7072 6563 6973 656c  ow does precisel
-0001c930: 7920 7468 6973 2077 6974 686f 7574 2066  y this without f
-0001c940: 6f72 6d69 6e67 2041 4220 6578 706c 6963  orming AB explic
-0001c950: 6974 6c79 2e0a 2020 2020 2020 2020 6e65  itly..        ne
-0001c960: 7769 6e66 6c61 7465 203d 205b 5d0a 2020  winflate = [].  
-0001c970: 2020 2020 2020 6e65 7774 616b 6520 3d20        newtake = 
-0001c980: 5b5d 0a20 2020 2020 2020 2066 6f72 206b  [].        for k
-0001c990: 2c20 6e20 696e 2065 6e75 6d65 7261 7465  , n in enumerate
-0001c9a0: 2869 6e74 6572 7365 6374 696f 6e29 3a0a  (intersection):.
-0001c9b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001c9c0: 6920 696e 205b 7375 6274 616b 655b 6b5d  i in [subtake[k]
-0001c9d0: 5d20 6966 2075 6e69 7175 6574 616b 6520  ] if uniquetake 
-0001c9e0: 656c 7365 206e 756d 7079 2e65 7175 616c  else numpy.equal
-0001c9f0: 2874 616b 6569 6478 2e72 6176 656c 2829  (takeidx.ravel()
-0001ca00: 2c20 6e29 2e6e 6f6e 7a65 726f 2829 5b30  , n).nonzero()[0
-0001ca10: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-0001ca20: 2020 2066 6f72 206a 2069 6e20 5b73 7562     for j in [sub
-0001ca30: 696e 666c 6174 655b 6b5d 5d20 6966 2075  inflate[k]] if u
-0001ca40: 6e69 7175 6569 6e66 6c61 7465 2065 6c73  niqueinflate els
-0001ca50: 6520 6e75 6d70 792e 6571 7561 6c28 696e  e numpy.equal(in
-0001ca60: 666c 6174 6569 6478 2e72 6176 656c 2829  flateidx.ravel()
-0001ca70: 2c20 6e29 2e6e 6f6e 7a65 726f 2829 5b30  , n).nonzero()[0
-0001ca80: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-0001ca90: 2020 2020 2020 206e 6577 696e 666c 6174         newinflat
-0001caa0: 652e 6170 7065 6e64 2869 290a 2020 2020  e.append(i).    
-0001cab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cac0: 6e65 7774 616b 652e 6170 7065 6e64 286a  newtake.append(j
-0001cad0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0001cae0: 206e 756d 7079 2e61 7272 6179 286e 6577   numpy.array(new
-0001caf0: 7461 6b65 2c20 6474 7970 653d 696e 7429  take, dtype=int)
-0001cb00: 2c20 6e75 6d70 792e 6172 7261 7928 6e65  , numpy.array(ne
-0001cb10: 7769 6e66 6c61 7465 2c20 6474 7970 653d  winflate, dtype=
-0001cb20: 696e 7429 2c20 6e75 6d70 792e 6172 7261  int), numpy.arra
-0001cb30: 7928 6c65 6e28 6e65 7774 616b 6529 2c20  y(len(newtake), 
-0001cb40: 6474 7970 653d 696e 7429 0a0a 0a63 6c61  dtype=int)...cla
-0001cb50: 7373 2044 6961 676f 6e61 6c69 7a65 2841  ss Diagonalize(A
-0001cb60: 7272 6179 293a 0a0a 2020 2020 6465 6620  rray):..    def 
-0001cb70: 5f5f 696e 6974 5f5f 2873 656c 662c 2066  __init__(self, f
-0001cb80: 756e 633a 2041 7272 6179 293a 0a20 2020  unc: Array):.   
-0001cb90: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-0001cba0: 7374 616e 6365 2866 756e 632c 2041 7272  stance(func, Arr
-0001cbb0: 6179 2920 616e 6420 6675 6e63 2e6e 6469  ay) and func.ndi
-0001cbc0: 6d20 3e20 302c 2066 2766 756e 633d 7b66  m > 0, f'func={f
-0001cbd0: 756e 6321 727d 270a 2020 2020 2020 2020  unc!r}'.        
-0001cbe0: 7365 6c66 2e66 756e 6320 3d20 6675 6e63  self.func = func
-0001cbf0: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
-0001cc00: 2e5f 5f69 6e69 745f 5f28 6172 6773 3d28  .__init__(args=(
-0001cc10: 6675 6e63 2c29 2c20 7368 6170 653d 282a  func,), shape=(*
-0001cc20: 6675 6e63 2e73 6861 7065 2c20 6675 6e63  func.shape, func
-0001cc30: 2e73 6861 7065 5b2d 315d 292c 2064 7479  .shape[-1]), dty
-0001cc40: 7065 3d66 756e 632e 6474 7970 6529 0a0a  pe=func.dtype)..
-0001cc50: 2020 2020 4063 6163 6865 645f 7072 6f70      @cached_prop
-0001cc60: 6572 7479 0a20 2020 2064 6566 205f 6469  erty.    def _di
-0001cc70: 6167 6f6e 616c 7328 7365 6c66 293a 0a20  agonals(self):. 
-0001cc80: 2020 2020 2020 2064 6961 676f 6e61 6c73         diagonals
-0001cc90: 203d 205b 6672 6f7a 656e 7365 7428 5b73   = [frozenset([s
-0001cca0: 656c 662e 6e64 696d 2d32 2c20 7365 6c66  elf.ndim-2, self
-0001ccb0: 2e6e 6469 6d2d 315d 295d 0a20 2020 2020  .ndim-1])].     
-0001ccc0: 2020 2066 6f72 2061 7865 7320 696e 2073     for axes in s
-0001ccd0: 656c 662e 6675 6e63 2e5f 6469 6167 6f6e  elf.func._diagon
-0001cce0: 616c 733a 0a20 2020 2020 2020 2020 2020  als:.           
-0001ccf0: 2069 6620 6178 6573 2026 2064 6961 676f   if axes & diago
-0001cd00: 6e61 6c73 5b30 5d3a 0a20 2020 2020 2020  nals[0]:.       
-0001cd10: 2020 2020 2020 2020 2064 6961 676f 6e61           diagona
-0001cd20: 6c73 5b30 5d20 7c3d 2061 7865 730a 2020  ls[0] |= axes.  
-0001cd30: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001cd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd50: 6469 6167 6f6e 616c 732e 6170 7065 6e64  diagonals.append
-0001cd60: 2861 7865 7329 0a20 2020 2020 2020 2072  (axes).        r
-0001cd70: 6574 7572 6e20 7475 706c 6528 6469 6167  eturn tuple(diag
-0001cd80: 6f6e 616c 7329 0a0a 2020 2020 4070 726f  onals)..    @pro
-0001cd90: 7065 7274 790a 2020 2020 6465 6620 5f69  perty.    def _i
-0001cda0: 6e66 6c61 7469 6f6e 7328 7365 6c66 293a  nflations(self):
-0001cdb0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001cdc0: 7475 706c 6528 2861 7869 732c 2074 7970  tuple((axis, typ
-0001cdd0: 6573 2e66 726f 7a65 6e64 6963 7428 2864  es.frozendict((d
-0001cde0: 6f66 6d61 702c 2044 6961 676f 6e61 6c69  ofmap, Diagonali
-0001cdf0: 7a65 2866 756e 6329 2920 666f 7220 646f  ze(func)) for do
-0001ce00: 666d 6170 2c20 6675 6e63 2069 6e20 7061  fmap, func in pa
-0001ce10: 7274 732e 6974 656d 7328 2929 290a 2020  rts.items())).  
-0001ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce30: 2020 2066 6f72 2061 7869 732c 2070 6172     for axis, par
-0001ce40: 7473 2069 6e20 7365 6c66 2e66 756e 632e  ts in self.func.
-0001ce50: 5f69 6e66 6c61 7469 6f6e 730a 2020 2020  _inflations.    
-0001ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce70: 2069 6620 6178 6973 203c 2073 656c 662e   if axis < self.
-0001ce80: 6e64 696d 2d32 290a 0a20 2020 2064 6566  ndim-2)..    def
-0001ce90: 205f 7369 6d70 6c69 6669 6564 2873 656c   _simplified(sel
-0001cea0: 6629 3a0a 2020 2020 2020 2020 6966 2073  f):.        if s
-0001ceb0: 656c 662e 7368 6170 655b 2d31 5d20 3d3d  elf.shape[-1] ==
-0001cec0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-0001ced0: 7265 7475 726e 2049 6e73 6572 7441 7869  return InsertAxi
-0001cee0: 7328 7365 6c66 2e66 756e 632c 2031 290a  s(self.func, 1).
-0001cef0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0001cf00: 656c 662e 6675 6e63 2e5f 6469 6167 6f6e  elf.func._diagon
-0001cf10: 616c 697a 6528 7365 6c66 2e6e 6469 6d2d  alize(self.ndim-
-0001cf20: 3229 0a0a 2020 2020 4073 7461 7469 636d  2)..    @staticm
-0001cf30: 6574 686f 640a 2020 2020 6465 6620 6576  ethod.    def ev
-0001cf40: 616c 6628 6172 7229 3a0a 2020 2020 2020  alf(arr):.      
-0001cf50: 2020 7265 7375 6c74 203d 206e 756d 7079    result = numpy
-0001cf60: 2e7a 6572 6f73 2861 7272 2e73 6861 7065  .zeros(arr.shape
-0001cf70: 2b28 6172 722e 7368 6170 655b 2d31 5d2c  +(arr.shape[-1],
-0001cf80: 292c 2064 7479 7065 3d61 7272 2e64 7479  ), dtype=arr.dty
-0001cf90: 7065 2c20 6f72 6465 723d 2746 2729 0a20  pe, order='F'). 
-0001cfa0: 2020 2020 2020 2064 6961 6720 3d20 6e75         diag = nu
-0001cfb0: 6d70 792e 636f 7265 2e6d 756c 7469 6172  mpy.core.multiar
-0001cfc0: 7261 792e 635f 6569 6e73 756d 2827 2e2e  ray.c_einsum('..
-0001cfd0: 2e69 692d 3e2e 2e2e 6927 2c20 7265 7375  .ii->...i', resu
-0001cfe0: 6c74 290a 2020 2020 2020 2020 6469 6167  lt).        diag
-0001cff0: 5b3a 5d20 3d20 6172 720a 2020 2020 2020  [:] = arr.      
-0001d000: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
-0001d010: 0a20 2020 2064 6566 205f 6465 7269 7661  .    def _deriva
-0001d020: 7469 7665 2873 656c 662c 2076 6172 2c20  tive(self, var, 
-0001d030: 7365 656e 293a 0a20 2020 2020 2020 2072  seen):.        r
-0001d040: 6574 7572 6e20 6469 6167 6f6e 616c 697a  eturn diagonaliz
-0001d050: 6528 6465 7269 7661 7469 7665 2873 656c  e(derivative(sel
-0001d060: 662e 6675 6e63 2c20 7661 722c 2073 6565  f.func, var, see
-0001d070: 6e29 2c20 7365 6c66 2e6e 6469 6d2d 322c  n), self.ndim-2,
-0001d080: 2073 656c 662e 6e64 696d 2d31 290a 0a20   self.ndim-1).. 
-0001d090: 2020 2064 6566 205f 696e 7665 7273 6528     def _inverse(
-0001d0a0: 7365 6c66 2c20 6178 6973 312c 2061 7869  self, axis1, axi
-0001d0b0: 7332 293a 0a20 2020 2020 2020 2069 6620  s2):.        if 
-0001d0c0: 736f 7274 6564 285b 6178 6973 312c 2061  sorted([axis1, a
-0001d0d0: 7869 7332 5d29 203d 3d20 5b73 656c 662e  xis2]) == [self.
-0001d0e0: 6e64 696d 2d32 2c20 7365 6c66 2e6e 6469  ndim-2, self.ndi
-0001d0f0: 6d2d 315d 3a0a 2020 2020 2020 2020 2020  m-1]:.          
-0001d100: 2020 7265 7475 726e 2044 6961 676f 6e61    return Diagona
-0001d110: 6c69 7a65 2872 6563 6970 726f 6361 6c28  lize(reciprocal(
-0001d120: 7365 6c66 2e66 756e 6329 290a 0a20 2020  self.func))..   
-0001d130: 2064 6566 205f 6465 7465 726d 696e 616e   def _determinan
-0001d140: 7428 7365 6c66 2c20 6178 6973 312c 2061  t(self, axis1, a
-0001d150: 7869 7332 293a 0a20 2020 2020 2020 2069  xis2):.        i
-0001d160: 6620 736f 7274 6564 285b 6178 6973 312c  f sorted([axis1,
-0001d170: 2061 7869 7332 5d29 203d 3d20 5b73 656c   axis2]) == [sel
-0001d180: 662e 6e64 696d 2d32 2c20 7365 6c66 2e6e  f.ndim-2, self.n
-0001d190: 6469 6d2d 315d 3a0a 2020 2020 2020 2020  dim-1]:.        
-0001d1a0: 2020 2020 7265 7475 726e 2050 726f 6475      return Produ
-0001d1b0: 6374 2873 656c 662e 6675 6e63 290a 2020  ct(self.func).  
-0001d1c0: 2020 2020 2020 656c 6966 2061 7869 7331        elif axis1
-0001d1d0: 203c 2073 656c 662e 6e64 696d 2d32 2061   < self.ndim-2 a
-0001d1e0: 6e64 2061 7869 7332 203c 2073 656c 662e  nd axis2 < self.
-0001d1f0: 6e64 696d 2d32 3a0a 2020 2020 2020 2020  ndim-2:.        
-0001d200: 2020 2020 7265 7475 726e 2044 6961 676f      return Diago
-0001d210: 6e61 6c69 7a65 2864 6574 6572 6d69 6e61  nalize(determina
-0001d220: 6e74 2873 656c 662e 6675 6e63 2c20 2861  nt(self.func, (a
-0001d230: 7869 7331 2c20 6178 6973 3229 2929 0a0a  xis1, axis2)))..
-0001d240: 2020 2020 6465 6620 5f73 756d 2873 656c      def _sum(sel
-0001d250: 662c 2061 7869 7329 3a0a 2020 2020 2020  f, axis):.      
-0001d260: 2020 6966 2061 7869 7320 3e3d 2073 656c    if axis >= sel
-0001d270: 662e 6e64 696d 202d 2032 3a0a 2020 2020  f.ndim - 2:.    
-0001d280: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0001d290: 656c 662e 6675 6e63 0a20 2020 2020 2020  elf.func.       
-0001d2a0: 2072 6574 7572 6e20 4469 6167 6f6e 616c   return Diagonal
-0001d2b0: 697a 6528 7375 6d28 7365 6c66 2e66 756e  ize(sum(self.fun
-0001d2c0: 632c 2061 7869 7329 290a 0a20 2020 2064  c, axis))..    d
-0001d2d0: 6566 205f 7461 6b65 6469 6167 2873 656c  ef _takediag(sel
-0001d2e0: 662c 2061 7869 7331 2c20 6178 6973 3229  f, axis1, axis2)
-0001d2f0: 3a0a 2020 2020 2020 2020 6966 2061 7869  :.        if axi
-0001d300: 7331 203d 3d20 7365 6c66 2e6e 6469 6d2d  s1 == self.ndim-
-0001d310: 323a 2020 2320 6178 6973 3220 3d3d 2073  2:  # axis2 == s
-0001d320: 656c 662e 6e64 696d 2d31 0a20 2020 2020  elf.ndim-1.     
-0001d330: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0001d340: 6c66 2e66 756e 630a 2020 2020 2020 2020  lf.func.        
-0001d350: 656c 6966 2061 7869 7332 203e 3d20 7365  elif axis2 >= se
-0001d360: 6c66 2e6e 6469 6d2d 323a 0a20 2020 2020  lf.ndim-2:.     
-0001d370: 2020 2020 2020 2072 6574 7572 6e20 6469         return di
-0001d380: 6167 6f6e 616c 697a 6528 5f74 616b 6564  agonalize(_taked
-0001d390: 6961 6728 7365 6c66 2e66 756e 632c 2061  iag(self.func, a
-0001d3a0: 7869 7331 2c20 7365 6c66 2e6e 6469 6d2d  xis1, self.ndim-
-0001d3b0: 3229 2c20 7365 6c66 2e6e 6469 6d2d 332c  2), self.ndim-3,
-0001d3c0: 2073 656c 662e 6e64 696d 2d32 290a 2020   self.ndim-2).  
-0001d3d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001d3e0: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-0001d3f0: 6961 676f 6e61 6c69 7a65 285f 7461 6b65  iagonalize(_take
-0001d400: 6469 6167 2873 656c 662e 6675 6e63 2c20  diag(self.func, 
-0001d410: 6178 6973 312c 2061 7869 7332 292c 2073  axis1, axis2), s
-0001d420: 656c 662e 6e64 696d 2d34 2c20 7365 6c66  elf.ndim-4, self
-0001d430: 2e6e 6469 6d2d 3329 0a0a 2020 2020 6465  .ndim-3)..    de
-0001d440: 6620 5f74 616b 6528 7365 6c66 2c20 696e  f _take(self, in
-0001d450: 6465 782c 2061 7869 7329 3a0a 2020 2020  dex, axis):.    
-0001d460: 2020 2020 6966 2061 7869 7320 3c20 7365      if axis < se
-0001d470: 6c66 2e6e 6469 6d20 2d20 323a 0a20 2020  lf.ndim - 2:.   
-0001d480: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001d490: 4469 6167 6f6e 616c 697a 6528 5f74 616b  Diagonalize(_tak
-0001d4a0: 6528 7365 6c66 2e66 756e 632c 2069 6e64  e(self.func, ind
-0001d4b0: 6578 2c20 6178 6973 2929 0a20 2020 2020  ex, axis)).     
-0001d4c0: 2020 2066 756e 6320 3d20 5f74 616b 6528     func = _take(
-0001d4d0: 7365 6c66 2e66 756e 632c 2069 6e64 6578  self.func, index
-0001d4e0: 2c20 7365 6c66 2e6e 6469 6d2d 3229 0a20  , self.ndim-2). 
-0001d4f0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-0001d500: 7261 6e67 6528 696e 6465 782e 6e64 696d  range(index.ndim
-0001d510: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
-0001d520: 756e 6320 3d20 6469 6167 6f6e 616c 697a  unc = diagonaliz
-0001d530: 6528 6675 6e63 2c20 7365 6c66 2e6e 6469  e(func, self.ndi
-0001d540: 6d2d 322b 6929 0a20 2020 2020 2020 2072  m-2+i).        r
-0001d550: 6574 7572 6e20 5f69 6e66 6c61 7465 2866  eturn _inflate(f
-0001d560: 756e 632c 2069 6e64 6578 2c20 7365 6c66  unc, index, self
-0001d570: 2e66 756e 632e 7368 6170 655b 2d31 5d2c  .func.shape[-1],
-0001d580: 2073 656c 662e 6e64 696d 2d32 2069 6620   self.ndim-2 if 
-0001d590: 6178 6973 203d 3d20 7365 6c66 2e6e 6469  axis == self.ndi
-0001d5a0: 6d2d 3120 656c 7365 2073 656c 662e 6e64  m-1 else self.nd
-0001d5b0: 696d 2d32 2b69 6e64 6578 2e6e 6469 6d29  im-2+index.ndim)
-0001d5c0: 0a0a 2020 2020 6465 6620 5f75 6e72 6176  ..    def _unrav
-0001d5d0: 656c 2873 656c 662c 2061 7869 732c 2073  el(self, axis, s
-0001d5e0: 6861 7065 293a 0a20 2020 2020 2020 2069  hape):.        i
-0001d5f0: 6620 6178 6973 203e 3d20 7365 6c66 2e6e  f axis >= self.n
-0001d600: 6469 6d20 2d20 323a 0a20 2020 2020 2020  dim - 2:.       
-0001d610: 2020 2020 2064 6961 6720 3d20 6469 6167       diag = diag
-0001d620: 6f6e 616c 697a 6528 6469 6167 6f6e 616c  onalize(diagonal
-0001d630: 697a 6528 556e 7261 7665 6c28 7365 6c66  ize(Unravel(self
-0001d640: 2e66 756e 632c 202a 7368 6170 6529 2c20  .func, *shape), 
-0001d650: 7365 6c66 2e6e 6469 6d2d 322c 2073 656c  self.ndim-2, sel
-0001d660: 662e 6e64 696d 292c 2073 656c 662e 6e64  f.ndim), self.nd
-0001d670: 696d 2d31 2c20 7365 6c66 2e6e 6469 6d2b  im-1, self.ndim+
-0001d680: 3129 0a20 2020 2020 2020 2020 2020 2072  1).            r
-0001d690: 6574 7572 6e20 7261 7665 6c28 6469 6167  eturn ravel(diag
-0001d6a0: 2c20 7365 6c66 2e6e 6469 6d20 6966 2061  , self.ndim if a
-0001d6b0: 7869 7320 3d3d 2073 656c 662e 6e64 696d  xis == self.ndim
-0001d6c0: 2d32 2065 6c73 6520 7365 6c66 2e6e 6469  -2 else self.ndi
-0001d6d0: 6d2d 3229 0a20 2020 2020 2020 2065 6c73  m-2).        els
-0001d6e0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0001d6f0: 6574 7572 6e20 4469 6167 6f6e 616c 697a  eturn Diagonaliz
-0001d700: 6528 756e 7261 7665 6c28 7365 6c66 2e66  e(unravel(self.f
-0001d710: 756e 632c 2061 7869 732c 2073 6861 7065  unc, axis, shape
-0001d720: 2929 0a0a 2020 2020 6465 6620 5f73 6967  ))..    def _sig
-0001d730: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-0001d740: 2072 6574 7572 6e20 4469 6167 6f6e 616c   return Diagonal
-0001d750: 697a 6528 5369 676e 2873 656c 662e 6675  ize(Sign(self.fu
-0001d760: 6e63 2929 0a0a 2020 2020 6465 6620 5f70  nc))..    def _p
-0001d770: 726f 6475 6374 2873 656c 6629 3a0a 2020  roduct(self):.  
-0001d780: 2020 2020 2020 6966 206e 756d 6572 6963        if numeric
-0001d790: 2e69 7369 6e74 2873 656c 662e 7368 6170  .isint(self.shap
-0001d7a0: 655b 2d31 5d29 2061 6e64 2073 656c 662e  e[-1]) and self.
-0001d7b0: 7368 6170 655b 2d31 5d20 3e20 313a 0a20  shape[-1] > 1:. 
-0001d7c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001d7d0: 6e20 5a65 726f 7328 7365 6c66 2e73 6861  n Zeros(self.sha
-0001d7e0: 7065 5b3a 2d31 5d2c 2064 7479 7065 3d73  pe[:-1], dtype=s
-0001d7f0: 656c 662e 6474 7970 6529 0a0a 2020 2020  elf.dtype)..    
-0001d800: 6465 6620 5f6c 6f6f 7073 756d 2873 656c  def _loopsum(sel
-0001d810: 662c 2069 6e64 6578 293a 0a20 2020 2020  f, index):.     
-0001d820: 2020 2072 6574 7572 6e20 4469 6167 6f6e     return Diagon
-0001d830: 616c 697a 6528 6c6f 6f70 5f73 756d 2873  alize(loop_sum(s
-0001d840: 656c 662e 6675 6e63 2c20 696e 6465 7829  elf.func, index)
-0001d850: 290a 0a20 2020 2040 6361 6368 6564 5f70  )..    @cached_p
-0001d860: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0001d870: 5f61 7373 7061 7273 6528 7365 6c66 293a  _assparse(self):
-0001d880: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001d890: 7475 706c 6528 282a 696e 6469 6365 732c  tuple((*indices,
-0001d8a0: 2069 6e64 6963 6573 5b2d 315d 2c20 7661   indices[-1], va
-0001d8b0: 6c75 6573 2920 666f 7220 2a69 6e64 6963  lues) for *indic
-0001d8c0: 6573 2c20 7661 6c75 6573 2069 6e20 7365  es, values in se
-0001d8d0: 6c66 2e66 756e 632e 5f61 7373 7061 7273  lf.func._asspars
-0001d8e0: 6529 0a0a 0a63 6c61 7373 2047 7561 7264  e)...class Guard
-0001d8f0: 2841 7272 6179 293a 0a20 2020 2027 6261  (Array):.    'ba
-0001d900: 7220 616c 6c20 7369 6d70 6c69 6669 6361  r all simplifica
-0001d910: 7469 6f6e 7327 0a0a 2020 2020 6465 6620  tions'..    def 
-0001d920: 5f5f 696e 6974 5f5f 2873 656c 662c 2066  __init__(self, f
-0001d930: 756e 3a20 4172 7261 7929 3a0a 2020 2020  un: Array):.    
-0001d940: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0001d950: 7461 6e63 6528 6675 6e2c 2041 7272 6179  tance(fun, Array
-0001d960: 292c 2066 2766 756e 3d7b 6675 6e21 727d  ), f'fun={fun!r}
-0001d970: 270a 2020 2020 2020 2020 7365 6c66 2e66  '.        self.f
-0001d980: 756e 203d 2066 756e 0a20 2020 2020 2020  un = fun.       
-0001d990: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
-0001d9a0: 5f28 6172 6773 3d28 6675 6e2c 292c 2073  _(args=(fun,), s
-0001d9b0: 6861 7065 3d66 756e 2e73 6861 7065 2c20  hape=fun.shape, 
-0001d9c0: 6474 7970 653d 6675 6e2e 6474 7970 6529  dtype=fun.dtype)
-0001d9d0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-0001d9e0: 2020 2020 6465 6620 6973 636f 6e73 7461      def isconsta
-0001d9f0: 6e74 2873 656c 6629 3a0a 2020 2020 2020  nt(self):.      
-0001da00: 2020 7265 7475 726e 2046 616c 7365 2020    return False  
-0001da10: 2320 6176 6f69 6420 7369 6d70 6c69 6669  # avoid simplifi
-0001da20: 6361 7469 6f6e 7320 6261 7365 6420 6f6e  cations based on
-0001da30: 2066 756e 2062 6569 6e67 2063 6f6e 7374   fun being const
-0001da40: 616e 740a 0a20 2020 2040 7374 6174 6963  ant..    @static
-0001da50: 6d65 7468 6f64 0a20 2020 2064 6566 2065  method.    def e
-0001da60: 7661 6c66 2864 6174 293a 0a20 2020 2020  valf(dat):.     
-0001da70: 2020 2072 6574 7572 6e20 6461 740a 0a20     return dat.. 
-0001da80: 2020 2064 6566 205f 6465 7269 7661 7469     def _derivati
-0001da90: 7665 2873 656c 662c 2076 6172 2c20 7365  ve(self, var, se
-0001daa0: 656e 293a 0a20 2020 2020 2020 2072 6574  en):.        ret
-0001dab0: 7572 6e20 4775 6172 6428 6465 7269 7661  urn Guard(deriva
-0001dac0: 7469 7665 2873 656c 662e 6675 6e2c 2076  tive(self.fun, v
-0001dad0: 6172 2c20 7365 656e 2929 0a0a 0a63 6c61  ar, seen))...cla
-0001dae0: 7373 2046 696e 6428 4172 7261 7929 3a0a  ss Find(Array):.
-0001daf0: 2020 2020 2769 6e64 6963 6573 206f 6620      'indices of 
-0001db00: 626f 6f6c 6561 6e20 696e 6465 7820 7665  boolean index ve
-0001db10: 6374 6f72 270a 0a20 2020 2064 6566 205f  ctor'..    def _
-0001db20: 5f69 6e69 745f 5f28 7365 6c66 2c20 7768  _init__(self, wh
-0001db30: 6572 653a 2041 7272 6179 293a 0a20 2020  ere: Array):.   
-0001db40: 2020 2020 2061 7373 6572 7420 6973 6172       assert isar
-0001db50: 7261 7928 7768 6572 6529 2061 6e64 2077  ray(where) and w
-0001db60: 6865 7265 2e6e 6469 6d20 3d3d 2031 2061  here.ndim == 1 a
-0001db70: 6e64 2077 6865 7265 2e64 7479 7065 203d  nd where.dtype =
-0001db80: 3d20 626f 6f6c 0a20 2020 2020 2020 2073  = bool.        s
-0001db90: 656c 662e 7768 6572 6520 3d20 7768 6572  elf.where = wher
-0001dba0: 650a 2020 2020 2020 2020 7375 7065 7228  e.        super(
-0001dbb0: 292e 5f5f 696e 6974 5f5f 2861 7267 733d  ).__init__(args=
-0001dbc0: 2877 6865 7265 2c29 2c20 7368 6170 653d  (where,), shape=
-0001dbd0: 2853 756d 2842 6f6f 6c54 6f49 6e74 2877  (Sum(BoolToInt(w
-0001dbe0: 6865 7265 2929 2c29 2c20 6474 7970 653d  here)),), dtype=
-0001dbf0: 696e 7429 0a0a 2020 2020 4073 7461 7469  int)..    @stati
-0001dc00: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
-0001dc10: 6576 616c 6628 7768 6572 6529 3a0a 2020  evalf(where):.  
-0001dc20: 2020 2020 2020 7265 7475 726e 2077 6865        return whe
-0001dc30: 7265 2e6e 6f6e 7a65 726f 2829 5b30 5d0a  re.nonzero()[0].
-0001dc40: 0a20 2020 2064 6566 205f 7369 6d70 6c69  .    def _simpli
-0001dc50: 6669 6564 2873 656c 6629 3a0a 2020 2020  fied(self):.    
-0001dc60: 2020 2020 6966 2073 656c 662e 6973 636f      if self.isco
-0001dc70: 6e73 7461 6e74 3a0a 2020 2020 2020 2020  nstant:.        
-0001dc80: 2020 2020 7265 7475 726e 2063 6f6e 7374      return const
-0001dc90: 616e 7428 7365 6c66 2e65 7661 6c28 2929  ant(self.eval())
-0001dca0: 0a0a 0a63 6c61 7373 2044 6572 6976 6174  ...class Derivat
-0001dcb0: 6976 6554 6172 6765 7442 6173 6528 4172  iveTargetBase(Ar
-0001dcc0: 7261 7929 3a0a 2020 2020 2762 6173 6520  ray):.    'base 
-0001dcd0: 636c 6173 7320 666f 7220 6465 7269 7661  class for deriva
-0001dce0: 7469 7665 2074 6172 6765 7473 270a 0a20  tive targets'.. 
-0001dcf0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-0001dd00: 2064 6566 2069 7363 6f6e 7374 616e 7428   def isconstant(
-0001dd10: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
-0001dd20: 6574 7572 6e20 4661 6c73 650a 0a0a 636c  eturn False...cl
-0001dd30: 6173 7320 5769 7468 4465 7269 7661 7469  ass WithDerivati
-0001dd40: 7665 2841 7272 6179 293a 0a20 2020 2027  ve(Array):.    '
-0001dd50: 2727 5772 6170 2074 6865 2067 6976 656e  ''Wrap the given
-0001dd60: 2066 756e 6374 696f 6e20 616e 6420 6465   function and de
-0001dd70: 6669 6e65 2074 6865 2064 6572 6976 6174  fine the derivat
-0001dd80: 6976 6520 746f 2061 2074 6172 6765 742e  ive to a target.
-0001dd90: 0a0a 2020 2020 5468 6520 7772 6170 7065  ..    The wrappe
-0001dda0: 7220 6973 2074 7970 6963 616c 6c79 2075  r is typically u
-0001ddb0: 7365 6420 746f 6765 7468 6572 2077 6974  sed together wit
-0001ddc0: 6820 6120 7669 7274 7561 6c20 6465 7269  h a virtual deri
-0001ddd0: 7661 7469 7665 2074 6172 6765 7420 6c69  vative target li
-0001dde0: 6b65 0a20 2020 203a 636c 6173 733a 6049  ke.    :class:`I
-0001ddf0: 6465 6e74 6966 6965 7244 6572 6976 6174  dentifierDerivat
-0001de00: 6976 6554 6172 6765 7460 2e20 5468 6520  iveTarget`. The 
-0001de10: 7772 6170 7065 7220 6973 2072 656d 6f76  wrapper is remov
-0001de20: 6564 2069 6e20 7468 6520 7369 6d70 6c69  ed in the simpli
-0001de30: 6669 6564 0a20 2020 2066 6f72 6d2e 0a0a  fied.    form...
-0001de40: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-0001de50: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-0001de60: 2020 6675 6e63 203a 203a 636c 6173 733a    func : :class:
-0001de70: 6041 7272 6179 600a 2020 2020 2020 2020  `Array`.        
-0001de80: 5468 6520 6675 6e63 7469 6f6e 2074 6f20  The function to 
-0001de90: 7772 6170 2e0a 2020 2020 7661 7220 3a20  wrap..    var : 
-0001dea0: 3a63 6c61 7373 3a60 4465 7269 7661 7469  :class:`Derivati
-0001deb0: 7665 5461 7267 6574 4261 7365 600a 2020  veTargetBase`.  
-0001dec0: 2020 2020 2020 5468 6520 6465 7269 7661        The deriva
-0001ded0: 7469 7665 2074 6172 6765 742e 0a20 2020  tive target..   
-0001dee0: 2064 6572 6976 6174 6976 6520 3a20 3a63   derivative : :c
-0001def0: 6c61 7373 3a60 4172 7261 7960 0a20 2020  lass:`Array`.   
-0001df00: 2020 2020 2054 6865 2064 6572 6976 6174       The derivat
-0001df10: 6976 6520 7769 7468 2073 6861 7065 2060  ive with shape `
-0001df20: 6066 756e 632e 7368 6170 6520 2b20 7661  `func.shape + va
-0001df30: 722e 7368 6170 6560 602e 0a0a 2020 2020  r.shape``...    
-0001df40: 5365 6520 416c 736f 0a20 2020 202d 2d2d  See Also.    ---
-0001df50: 2d2d 2d2d 2d0a 2020 2020 3a63 6c61 7373  -----.    :class
-0001df60: 3a60 4964 656e 7469 6669 6572 4465 7269  :`IdentifierDeri
-0001df70: 7661 7469 7665 5461 7267 6574 6020 3a20  vativeTarget` : 
-0001df80: 6120 7669 7274 7561 6c20 6465 7269 7661  a virtual deriva
-0001df90: 7469 7665 2074 6172 6765 740a 2020 2020  tive target.    
-0001dfa0: 2727 270a 0a20 2020 2064 6566 205f 5f69  '''..    def __i
-0001dfb0: 6e69 745f 5f28 7365 6c66 2c20 6675 6e63  nit__(self, func
-0001dfc0: 3a20 4172 7261 792c 2076 6172 3a20 4465  : Array, var: De
-0001dfd0: 7269 7661 7469 7665 5461 7267 6574 4261  rivativeTargetBa
-0001dfe0: 7365 2c20 6465 7269 7661 7469 7665 3a20  se, derivative: 
-0001dff0: 4172 7261 7929 202d 3e20 4e6f 6e65 3a0a  Array) -> None:.
-0001e000: 2020 2020 2020 2020 7365 6c66 2e5f 6675          self._fu
-0001e010: 6e63 203d 2066 756e 630a 2020 2020 2020  nc = func.      
-0001e020: 2020 7365 6c66 2e5f 7661 7220 3d20 7661    self._var = va
-0001e030: 720a 2020 2020 2020 2020 7365 6c66 2e5f  r.        self._
-0001e040: 6465 7269 7620 3d20 6465 7269 7661 7469  deriv = derivati
-0001e050: 7665 0a20 2020 2020 2020 2073 7570 6572  ve.        super
-0001e060: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
-0001e070: 3d28 6675 6e63 2c29 2c20 7368 6170 653d  =(func,), shape=
-0001e080: 6675 6e63 2e73 6861 7065 2c20 6474 7970  func.shape, dtyp
-0001e090: 653d 6675 6e63 2e64 7479 7065 290a 0a20  e=func.dtype).. 
-0001e0a0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-0001e0b0: 2064 6566 2061 7267 756d 656e 7473 2873   def arguments(s
-0001e0c0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-0001e0d0: 7475 726e 2073 656c 662e 5f66 756e 632e  turn self._func.
-0001e0e0: 6172 6775 6d65 6e74 7320 7c20 7b73 656c  arguments | {sel
-0001e0f0: 662e 5f76 6172 7d0a 0a20 2020 2040 7374  f._var}..    @st
-0001e100: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-0001e110: 6566 2065 7661 6c66 2866 756e 633a 206e  ef evalf(func: n
-0001e120: 756d 7079 2e6e 6461 7272 6179 2920 2d3e  umpy.ndarray) ->
-0001e130: 206e 756d 7079 2e6e 6461 7272 6179 3a0a   numpy.ndarray:.
-0001e140: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-0001e150: 756e 630a 0a20 2020 2064 6566 205f 6465  unc..    def _de
-0001e160: 7269 7661 7469 7665 2873 656c 662c 2076  rivative(self, v
-0001e170: 6172 3a20 4465 7269 7661 7469 7665 5461  ar: DerivativeTa
-0001e180: 7267 6574 4261 7365 2c20 7365 656e 2920  rgetBase, seen) 
-0001e190: 2d3e 2041 7272 6179 3a0a 2020 2020 2020  -> Array:.      
-0001e1a0: 2020 6966 2076 6172 203d 3d20 7365 6c66    if var == self
-0001e1b0: 2e5f 7661 723a 0a20 2020 2020 2020 2020  ._var:.         
-0001e1c0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-0001e1d0: 6465 7269 760a 2020 2020 2020 2020 656c  deriv.        el
-0001e1e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001e1f0: 7265 7475 726e 2064 6572 6976 6174 6976  return derivativ
-0001e200: 6528 7365 6c66 2e5f 6675 6e63 2c20 7661  e(self._func, va
-0001e210: 722c 2073 6565 6e29 0a0a 2020 2020 6465  r, seen)..    de
-0001e220: 6620 5f73 696d 706c 6966 6965 6428 7365  f _simplified(se
-0001e230: 6c66 2920 2d3e 2041 7272 6179 3a0a 2020  lf) -> Array:.  
-0001e240: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0001e250: 662e 5f66 756e 630a 0a0a 636c 6173 7320  f._func...class 
-0001e260: 4172 6775 6d65 6e74 2844 6572 6976 6174  Argument(Derivat
-0001e270: 6976 6554 6172 6765 7442 6173 6529 3a0a  iveTargetBase):.
-0001e280: 2020 2020 2727 2741 7272 6179 2061 7267      '''Array arg
-0001e290: 756d 656e 742c 2074 6f20 6265 2073 7562  ument, to be sub
-0001e2a0: 7374 6974 7574 6564 2062 6566 6f72 6520  stituted before 
-0001e2b0: 6576 616c 7561 7469 6f6e 2e0a 0a20 2020  evaluation...   
-0001e2c0: 2054 6865 203a 636c 6173 733a 6041 7267   The :class:`Arg
-0001e2d0: 756d 656e 7460 2069 7320 616e 203a 636c  ument` is an :cl
-0001e2e0: 6173 733a 6041 7272 6179 6020 7769 7468  ass:`Array` with
-0001e2f0: 2061 206b 6e6f 776e 2073 6861 7065 2c20   a known shape, 
-0001e300: 6275 7420 7768 6f73 650a 2020 2020 7661  but whose.    va
-0001e310: 6c75 6573 2061 7265 2074 6f20 6265 2064  lues are to be d
-0001e320: 6566 696e 6564 206c 6174 6572 2c20 6265  efined later, be
-0001e330: 666f 7265 2065 7661 6c75 6174 696f 6e2c  fore evaluation,
-0001e340: 2065 2e67 2e20 7573 696e 670a 2020 2020   e.g. using.    
-0001e350: 3a66 756e 633a 6072 6570 6c61 6365 5f61  :func:`replace_a
-0001e360: 7267 756d 656e 7473 602e 0a0a 2020 2020  rguments`...    
-0001e370: 4974 2069 7320 706f 7373 6962 6c65 2074  It is possible t
-0001e380: 6f20 7461 6b65 2074 6865 2064 6572 6976  o take the deriv
-0001e390: 6174 6976 6520 6f66 2061 6e20 3a63 6c61  ative of an :cla
-0001e3a0: 7373 3a60 4172 7261 7960 2074 6f20 616e  ss:`Array` to an
-0001e3b0: 0a20 2020 203a 636c 6173 733a 6041 7267  .    :class:`Arg
-0001e3c0: 756d 656e 7460 3a0a 0a20 2020 203e 3e3e  ument`:..    >>>
-0001e3d0: 2066 726f 6d20 6e75 7469 6c73 2069 6d70   from nutils imp
-0001e3e0: 6f72 7420 6576 616c 7561 626c 650a 2020  ort evaluable.  
-0001e3f0: 2020 3e3e 3e20 6120 3d20 6576 616c 7561    >>> a = evalua
-0001e400: 626c 652e 4172 6775 6d65 6e74 2827 7827  ble.Argument('x'
-0001e410: 2c20 2829 290a 2020 2020 3e3e 3e20 6220  , ()).    >>> b 
-0001e420: 3d20 6576 616c 7561 626c 652e 4172 6775  = evaluable.Argu
-0001e430: 6d65 6e74 2827 7927 2c20 2829 290a 2020  ment('y', ()).  
-0001e440: 2020 3e3e 3e20 6620 3d20 612a 2a33 202b    >>> f = a**3 +
-0001e450: 2062 2a2a 320a 2020 2020 3e3e 3e20 6576   b**2.    >>> ev
-0001e460: 616c 7561 626c 652e 6465 7269 7661 7469  aluable.derivati
-0001e470: 7665 2866 2c20 6229 2e73 696d 706c 6966  ve(f, b).simplif
-0001e480: 6965 6420 3d3d 2032 2e2a 620a 2020 2020  ied == 2.*b.    
-0001e490: 5472 7565 0a0a 2020 2020 4172 6773 0a20  True..    Args. 
-0001e4a0: 2020 202d 2d2d 2d0a 2020 2020 6e61 6d65     ----.    name
-0001e4b0: 203a 203a 636c 6173 733a 6073 7472 600a   : :class:`str`.
-0001e4c0: 2020 2020 2020 2020 5468 6520 4964 656e          The Iden
-0001e4d0: 7469 6669 6572 206f 6620 7468 6973 2061  tifier of this a
-0001e4e0: 7267 756d 656e 742e 0a20 2020 2073 6861  rgument..    sha
-0001e4f0: 7065 203a 203a 636c 6173 733a 6074 7570  pe : :class:`tup
-0001e500: 6c65 6020 6f66 203a 636c 6173 733a 6069  le` of :class:`i
-0001e510: 6e74 605c 5c73 0a20 2020 2020 2020 2054  nt`\\s.        T
-0001e520: 6865 2073 6861 7065 206f 6620 7468 6973  he shape of this
-0001e530: 2061 7267 756d 656e 742e 0a20 2020 2027   argument..    '
-0001e540: 2727 0a0a 2020 2020 6465 6620 5f5f 696e  ''..    def __in
-0001e550: 6974 5f5f 2873 656c 662c 206e 616d 653a  it__(self, name:
-0001e560: 2073 7472 2c20 7368 6170 653a 2074 7970   str, shape: typ
-0001e570: 696e 672e 5475 706c 655b 4172 7261 792c  ing.Tuple[Array,
-0001e580: 202e 2e2e 5d2c 2064 7479 7065 3a20 4474   ...], dtype: Dt
-0001e590: 7970 6520 3d20 666c 6f61 7429 3a0a 2020  ype = float):.  
-0001e5a0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-0001e5b0: 6e73 7461 6e63 6528 6e61 6d65 2c20 7374  nstance(name, st
-0001e5c0: 7229 2c20 6627 6e61 6d65 3d7b 6e61 6d65  r), f'name={name
-0001e5d0: 2172 7d27 0a20 2020 2020 2020 2061 7373  !r}'.        ass
-0001e5e0: 6572 7420 6973 696e 7374 616e 6365 2873  ert isinstance(s
-0001e5f0: 6861 7065 2c20 7475 706c 6529 2061 6e64  hape, tuple) and
-0001e600: 2061 6c6c 285f 6973 696e 6465 7828 6e29   all(_isindex(n)
-0001e610: 2066 6f72 206e 2069 6e20 7368 6170 6529   for n in shape)
-0001e620: 2c20 6627 7368 6170 653d 7b73 6861 7065  , f'shape={shape
-0001e630: 2172 7d27 0a20 2020 2020 2020 2073 656c  !r}'.        sel
-0001e640: 662e 5f6e 616d 6520 3d20 6e61 6d65 0a20  f._name = name. 
-0001e650: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
-0001e660: 5f69 6e69 745f 5f28 6172 6773 3d28 4556  _init__(args=(EV
-0001e670: 414c 4152 4753 2c20 2a73 6861 7065 292c  ALARGS, *shape),
-0001e680: 2073 6861 7065 3d73 6861 7065 2c20 6474   shape=shape, dt
-0001e690: 7970 653d 6474 7970 6529 0a0a 2020 2020  ype=dtype)..    
-0001e6a0: 6465 6620 6576 616c 6628 7365 6c66 2c20  def evalf(self, 
-0001e6b0: 6576 616c 6172 6773 2c20 2a73 6861 7065  evalargs, *shape
-0001e6c0: 293a 0a20 2020 2020 2020 2074 7279 3a0a  ):.        try:.
-0001e6d0: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
-0001e6e0: 6520 3d20 6576 616c 6172 6773 5b73 656c  e = evalargs[sel
-0001e6f0: 662e 5f6e 616d 655d 0a20 2020 2020 2020  f._name].       
-0001e700: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
-0001e710: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0001e720: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-0001e730: 2761 7267 756d 656e 7420 7b73 656c 662e  'argument {self.
-0001e740: 5f6e 616d 6521 727d 206d 6973 7369 6e67  _name!r} missing
-0001e750: 2729 0a20 2020 2020 2020 2076 616c 7565  ').        value
-0001e760: 203d 206e 756d 7079 2e61 7361 7272 6179   = numpy.asarray
-0001e770: 2876 616c 7565 290a 2020 2020 2020 2020  (value).        
-0001e780: 6966 2076 616c 7565 2e73 6861 7065 2021  if value.shape !
-0001e790: 3d20 7368 6170 653a 0a20 2020 2020 2020  = shape:.       
-0001e7a0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-0001e7b0: 4572 726f 7228 6627 6172 6775 6d65 6e74  Error(f'argument
-0001e7c0: 207b 7365 6c66 2e5f 6e61 6d65 2172 7d20   {self._name!r} 
-0001e7d0: 6861 7320 7468 6520 7772 6f6e 6720 7368  has the wrong sh
-0001e7e0: 6170 653a 2065 7870 6563 7465 6420 7b73  ape: expected {s
-0001e7f0: 6861 7065 7d2c 2067 6f74 207b 7661 6c75  hape}, got {valu
-0001e800: 652e 7368 6170 657d 2729 0a20 2020 2020  e.shape}').     
-0001e810: 2020 2072 6574 7572 6e20 7661 6c75 652e     return value.
-0001e820: 6173 7479 7065 2873 656c 662e 6474 7970  astype(self.dtyp
-0001e830: 652c 2063 6173 7469 6e67 3d27 7361 6665  e, casting='safe
-0001e840: 272c 2063 6f70 793d 4661 6c73 6529 0a0a  ', copy=False)..
-0001e850: 2020 2020 6465 6620 5f64 6572 6976 6174      def _derivat
-0001e860: 6976 6528 7365 6c66 2c20 7661 722c 2073  ive(self, var, s
-0001e870: 6565 6e29 3a0a 2020 2020 2020 2020 6966  een):.        if
-0001e880: 2069 7369 6e73 7461 6e63 6528 7661 722c   isinstance(var,
-0001e890: 2041 7267 756d 656e 7429 2061 6e64 2076   Argument) and v
-0001e8a0: 6172 2e5f 6e61 6d65 203d 3d20 7365 6c66  ar._name == self
-0001e8b0: 2e5f 6e61 6d65 2061 6e64 2073 656c 662e  ._name and self.
-0001e8c0: 6474 7970 6520 696e 2028 666c 6f61 742c  dtype in (float,
-0001e8d0: 2063 6f6d 706c 6578 293a 0a20 2020 2020   complex):.     
-0001e8e0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-0001e8f0: 6f6e 6573 2873 656c 662e 7368 6170 652c  ones(self.shape,
-0001e900: 2073 656c 662e 6474 7970 6529 0a20 2020   self.dtype).   
-0001e910: 2020 2020 2020 2020 2066 6f72 2069 2c20           for i, 
-0001e920: 7368 2069 6e20 656e 756d 6572 6174 6528  sh in enumerate(
-0001e930: 7365 6c66 2e73 6861 7065 293a 0a20 2020  self.shape):.   
-0001e940: 2020 2020 2020 2020 2020 2020 2072 6573               res
-0001e950: 756c 7420 3d20 6469 6167 6f6e 616c 697a  ult = diagonaliz
-0001e960: 6528 7265 7375 6c74 2c20 692c 2069 2b73  e(result, i, i+s
-0001e970: 656c 662e 6e64 696d 290a 2020 2020 2020  elf.ndim).      
-0001e980: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-0001e990: 756c 740a 2020 2020 2020 2020 656c 7365  ult.        else
-0001e9a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001e9b0: 7475 726e 207a 6572 6f73 2873 656c 662e  turn zeros(self.
-0001e9c0: 7368 6170 652b 7661 722e 7368 6170 6529  shape+var.shape)
-0001e9d0: 0a0a 2020 2020 6465 6620 5f5f 7374 725f  ..    def __str_
-0001e9e0: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
-0001e9f0: 2072 6574 7572 6e20 277b 7d20 7b21 727d   return '{} {!r}
-0001ea00: 203c 7b7d 3e27 2e66 6f72 6d61 7428 7365   <{}>'.format(se
-0001ea10: 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  lf.__class__.__n
-0001ea20: 616d 655f 5f2c 2073 656c 662e 5f6e 616d  ame__, self._nam
-0001ea30: 652c 2073 656c 662e 5f73 6861 7065 5f73  e, self._shape_s
-0001ea40: 7472 2866 6f72 6d3d 7374 7229 290a 0a20  tr(form=str)).. 
-0001ea50: 2020 2064 6566 205f 6e6f 6465 2873 656c     def _node(sel
-0001ea60: 662c 2063 6163 6865 2c20 7375 6267 7261  f, cache, subgra
-0001ea70: 7068 2c20 7469 6d65 7329 3a0a 2020 2020  ph, times):.    
-0001ea80: 2020 2020 6966 2073 656c 6620 696e 2063      if self in c
-0001ea90: 6163 6865 3a0a 2020 2020 2020 2020 2020  ache:.          
-0001eaa0: 2020 7265 7475 726e 2063 6163 6865 5b73    return cache[s
-0001eab0: 656c 665d 0a20 2020 2020 2020 2065 6c73  elf].        els
-0001eac0: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-0001ead0: 6162 656c 203d 2027 5c6e 272e 6a6f 696e  abel = '\n'.join
-0001eae0: 2866 696c 7465 7228 4e6f 6e65 2c20 2874  (filter(None, (t
-0001eaf0: 7970 6528 7365 6c66 292e 5f5f 6e61 6d65  ype(self).__name
-0001eb00: 5f5f 2c20 7365 6c66 2e5f 6e61 6d65 2c20  __, self._name, 
-0001eb10: 7365 6c66 2e5f 7368 6170 655f 7374 7228  self._shape_str(
-0001eb20: 666f 726d 3d72 6570 7229 2929 290a 2020  form=repr)))).  
-0001eb30: 2020 2020 2020 2020 2020 6361 6368 655b            cache[
-0001eb40: 7365 6c66 5d20 3d20 6e6f 6465 203d 2044  self] = node = D
-0001eb50: 7570 6c69 6361 7465 644c 6561 664e 6f64  uplicatedLeafNod
-0001eb60: 6528 6c61 6265 6c2c 2028 7479 7065 2873  e(label, (type(s
-0001eb70: 656c 6629 2e5f 5f6e 616d 655f 5f2c 2074  elf).__name__, t
-0001eb80: 696d 6573 5b73 656c 665d 2929 0a20 2020  imes[self])).   
-0001eb90: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001eba0: 6e6f 6465 0a0a 2020 2020 4070 726f 7065  node..    @prope
-0001ebb0: 7274 790a 2020 2020 6465 6620 6172 6775  rty.    def argu
-0001ebc0: 6d65 6e74 7328 7365 6c66 293a 0a20 2020  ments(self):.   
-0001ebd0: 2020 2020 2072 6574 7572 6e20 6672 6f7a       return froz
-0001ebe0: 656e 7365 7428 7b73 656c 667d 290a 0a0a  enset({self})...
-0001ebf0: 636c 6173 7320 4964 656e 7469 6669 6572  class Identifier
-0001ec00: 4465 7269 7661 7469 7665 5461 7267 6574  DerivativeTarget
-0001ec10: 2844 6572 6976 6174 6976 6554 6172 6765  (DerivativeTarge
-0001ec20: 7442 6173 6529 3a0a 2020 2020 2727 2756  tBase):.    '''V
-0001ec30: 6972 7475 616c 2064 6572 6976 6174 6976  irtual derivativ
-0001ec40: 6520 7461 7267 6574 2064 6973 7469 6e67  e target disting
-0001ec50: 7569 7368 6564 2062 7920 616e 2069 6465  uished by an ide
-0001ec60: 6e74 6966 6965 722e 0a0a 2020 2020 5061  ntifier...    Pa
-0001ec70: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-0001ec80: 2d2d 2d2d 2d2d 2d0a 2020 2020 6964 656e  -------.    iden
-0001ec90: 7469 6669 6572 203a 2068 6173 6861 626c  tifier : hashabl
-0001eca0: 6520 3a63 6c61 7373 3a60 6f62 6a65 6374  e :class:`object
-0001ecb0: 600a 2020 2020 2020 2020 5468 6520 6964  `.        The id
-0001ecc0: 656e 7469 6669 6572 2066 6f72 2074 6869  entifier for thi
-0001ecd0: 7320 6465 7269 7661 7469 7665 2074 6172  s derivative tar
-0001ece0: 6765 742e 0a20 2020 2073 6861 7065 203a  get..    shape :
-0001ecf0: 203a 636c 6173 733a 6074 7570 6c65 6020   :class:`tuple` 
-0001ed00: 6f66 203a 636c 6173 733a 6041 7272 6179  of :class:`Array
-0001ed10: 6020 6f72 203a 636c 6173 733a 6069 6e74  ` or :class:`int
-0001ed20: 600a 2020 2020 2020 2020 5468 6520 7368  `.        The sh
-0001ed30: 6170 6520 6f66 2074 6869 7320 6465 7269  ape of this deri
-0001ed40: 7661 7469 7665 2074 6172 6765 742e 0a0a  vative target...
-0001ed50: 2020 2020 5365 6520 416c 736f 0a20 2020      See Also.   
-0001ed60: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 3a63   --------.    :c
-0001ed70: 6c61 7373 3a60 5769 7468 4465 7269 7661  lass:`WithDeriva
-0001ed80: 7469 7665 6020 3a20 3a63 6c61 7373 3a60  tive` : :class:`
-0001ed90: 4172 7261 7960 2077 7261 7070 6572 2077  Array` wrapper w
-0001eda0: 6974 6820 6164 6469 7469 6f6e 616c 2064  ith additional d
-0001edb0: 6572 6976 6174 6976 650a 2020 2020 2727  erivative.    ''
-0001edc0: 270a 0a20 2020 2064 6566 205f 5f69 6e69  '..    def __ini
-0001edd0: 745f 5f28 7365 6c66 2c20 6964 656e 7469  t__(self, identi
-0001ede0: 6669 6572 2c20 7368 6170 6529 3a0a 2020  fier, shape):.  
-0001edf0: 2020 2020 2020 7365 6c66 2e69 6465 6e74        self.ident
-0001ee00: 6966 6965 7220 3d20 6964 656e 7469 6669  ifier = identifi
-0001ee10: 6572 0a20 2020 2020 2020 2073 7570 6572  er.        super
-0001ee20: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
-0001ee30: 3d28 292c 2073 6861 7065 3d73 6861 7065  =(), shape=shape
-0001ee40: 2c20 6474 7970 653d 666c 6f61 7429 0a0a  , dtype=float)..
-0001ee50: 2020 2020 6465 6620 6576 616c 6628 7365      def evalf(se
-0001ee60: 6c66 293a 0a20 2020 2020 2020 2072 6169  lf):.        rai
-0001ee70: 7365 2045 7863 6570 7469 6f6e 2827 7b7d  se Exception('{}
-0001ee80: 2063 616e 6e6f 7420 6265 2065 7661 6c75   cannot be evalu
-0001ee90: 6162 6c65 6427 2e66 6f72 6d61 7428 7479  abled'.format(ty
-0001eea0: 7065 2873 656c 6629 2e5f 5f6e 616d 655f  pe(self).__name_
-0001eeb0: 5f29 290a 0a0a 636c 6173 7320 5261 7665  _))...class Rave
-0001eec0: 6c28 4172 7261 7929 3a0a 0a20 2020 2064  l(Array):..    d
-0001eed0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-0001eee0: 2c20 6675 6e63 3a20 4172 7261 7929 3a0a  , func: Array):.
-0001eef0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-0001ef00: 7369 6e73 7461 6e63 6528 6675 6e63 2c20  sinstance(func, 
-0001ef10: 4172 7261 7929 2061 6e64 2066 756e 632e  Array) and func.
-0001ef20: 6e64 696d 203e 3d20 322c 2066 2766 756e  ndim >= 2, f'fun
-0001ef30: 633d 7b66 756e 6321 727d 270a 2020 2020  c={func!r}'.    
-0001ef40: 2020 2020 7365 6c66 2e66 756e 6320 3d20      self.func = 
-0001ef50: 6675 6e63 0a20 2020 2020 2020 2073 7570  func.        sup
-0001ef60: 6572 2829 2e5f 5f69 6e69 745f 5f28 6172  er().__init__(ar
-0001ef70: 6773 3d28 6675 6e63 2c29 2c20 7368 6170  gs=(func,), shap
-0001ef80: 653d 282a 6675 6e63 2e73 6861 7065 5b3a  e=(*func.shape[:
-0001ef90: 2d32 5d2c 2066 756e 632e 7368 6170 655b  -2], func.shape[
-0001efa0: 2d32 5d20 2a20 6675 6e63 2e73 6861 7065  -2] * func.shape
-0001efb0: 5b2d 315d 292c 2064 7479 7065 3d66 756e  [-1]), dtype=fun
-0001efc0: 632e 6474 7970 6529 0a0a 2020 2020 4063  c.dtype)..    @c
-0001efd0: 6163 6865 645f 7072 6f70 6572 7479 0a20  ached_property. 
-0001efe0: 2020 2064 6566 205f 696e 666c 6174 696f     def _inflatio
-0001eff0: 6e73 2873 656c 6629 3a0a 2020 2020 2020  ns(self):.      
-0001f000: 2020 696e 666c 6174 696f 6e73 203d 205b    inflations = [
-0001f010: 5d0a 2020 2020 2020 2020 7374 7269 6465  ].        stride
-0001f020: 203d 2073 656c 662e 6675 6e63 2e73 6861   = self.func.sha
-0001f030: 7065 5b2d 315d 0a20 2020 2020 2020 206e  pe[-1].        n
-0001f040: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0001f050: 666f 7220 6178 6973 2c20 6f6c 645f 7061  for axis, old_pa
-0001f060: 7274 7320 696e 2073 656c 662e 6675 6e63  rts in self.func
-0001f070: 2e5f 696e 666c 6174 696f 6e73 3a0a 2020  ._inflations:.  
-0001f080: 2020 2020 2020 2020 2020 6966 2061 7869            if axi
-0001f090: 7320 3d3d 2073 656c 662e 6e64 696d 202d  s == self.ndim -
-0001f0a0: 2031 2061 6e64 206e 2069 7320 4e6f 6e65   1 and n is None
-0001f0b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001f0c0: 2020 6e20 3d20 7365 6c66 2e66 756e 632e    n = self.func.
-0001f0d0: 7368 6170 655b 2d31 5d0a 2020 2020 2020  shape[-1].      
-0001f0e0: 2020 2020 2020 2020 2020 696e 666c 6174            inflat
-0001f0f0: 696f 6e73 2e61 7070 656e 6428 2873 656c  ions.append((sel
-0001f100: 662e 6e64 696d 202d 2031 2c20 7479 7065  f.ndim - 1, type
-0001f110: 732e 6672 6f7a 656e 6469 6374 2828 5261  s.frozendict((Ra
-0001f120: 7665 6c49 6e64 6578 2864 6f66 6d61 702c  velIndex(dofmap,
-0001f130: 2052 616e 6765 286e 292c 202a 7365 6c66   Range(n), *self
-0001f140: 2e66 756e 632e 7368 6170 655b 2d32 3a5d  .func.shape[-2:]
-0001f150: 292c 2066 756e 6329 2066 6f72 2064 6f66  ), func) for dof
-0001f160: 6d61 702c 2066 756e 6320 696e 206f 6c64  map, func in old
-0001f170: 5f70 6172 7473 2e69 7465 6d73 2829 2929  _parts.items()))
-0001f180: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-0001f190: 6966 2061 7869 7320 3d3d 2073 656c 662e  if axis == self.
-0001f1a0: 6e64 696d 2061 6e64 206e 2069 7320 4e6f  ndim and n is No
-0001f1b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001f1c0: 2020 2020 6e20 3d20 7365 6c66 2e66 756e      n = self.fun
-0001f1d0: 632e 7368 6170 655b 2d32 5d0a 2020 2020  c.shape[-2].    
-0001f1e0: 2020 2020 2020 2020 2020 2020 696e 666c              infl
-0001f1f0: 6174 696f 6e73 2e61 7070 656e 6428 2873  ations.append((s
-0001f200: 656c 662e 6e64 696d 202d 2031 2c20 7479  elf.ndim - 1, ty
-0001f210: 7065 732e 6672 6f7a 656e 6469 6374 2828  pes.frozendict((
-0001f220: 5261 7665 6c49 6e64 6578 2852 616e 6765  RavelIndex(Range
-0001f230: 286e 292c 2064 6f66 6d61 702c 202a 7365  (n), dofmap, *se
-0001f240: 6c66 2e66 756e 632e 7368 6170 655b 2d32  lf.func.shape[-2
-0001f250: 3a5d 292c 2066 756e 6329 2066 6f72 2064  :]), func) for d
-0001f260: 6f66 6d61 702c 2066 756e 6320 696e 206f  ofmap, func in o
-0001f270: 6c64 5f70 6172 7473 2e69 7465 6d73 2829  ld_parts.items()
-0001f280: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
-0001f290: 656c 6966 2061 7869 7320 3c20 7365 6c66  elif axis < self
-0001f2a0: 2e6e 6469 6d20 2d20 313a 0a20 2020 2020  .ndim - 1:.     
-0001f2b0: 2020 2020 2020 2020 2020 2069 6e66 6c61             infla
-0001f2c0: 7469 6f6e 732e 6170 7065 6e64 2828 6178  tions.append((ax
-0001f2d0: 6973 2c20 7479 7065 732e 6672 6f7a 656e  is, types.frozen
-0001f2e0: 6469 6374 2828 646f 666d 6170 2c20 5261  dict((dofmap, Ra
-0001f2f0: 7665 6c28 6675 6e63 2929 2066 6f72 2064  vel(func)) for d
-0001f300: 6f66 6d61 702c 2066 756e 6320 696e 206f  ofmap, func in o
-0001f310: 6c64 5f70 6172 7473 2e69 7465 6d73 2829  ld_parts.items()
-0001f320: 2929 290a 2020 2020 2020 2020 7265 7475  ))).        retu
-0001f330: 726e 2074 7570 6c65 2869 6e66 6c61 7469  rn tuple(inflati
-0001f340: 6f6e 7329 0a0a 2020 2020 6465 6620 5f73  ons)..    def _s
-0001f350: 696d 706c 6966 6965 6428 7365 6c66 293a  implified(self):
-0001f360: 0a20 2020 2020 2020 2069 6620 5f65 7175  .        if _equ
-0001f370: 616c 735f 7363 616c 6172 5f63 6f6e 7374  als_scalar_const
-0001f380: 616e 7428 7365 6c66 2e66 756e 632e 7368  ant(self.func.sh
-0001f390: 6170 655b 2d32 5d2c 2031 293a 0a20 2020  ape[-2], 1):.   
-0001f3a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001f3b0: 6765 7428 7365 6c66 2e66 756e 632c 202d  get(self.func, -
-0001f3c0: 322c 2063 6f6e 7374 616e 7428 3029 290a  2, constant(0)).
-0001f3d0: 2020 2020 2020 2020 6966 205f 6571 7561          if _equa
-0001f3e0: 6c73 5f73 6361 6c61 725f 636f 6e73 7461  ls_scalar_consta
-0001f3f0: 6e74 2873 656c 662e 6675 6e63 2e73 6861  nt(self.func.sha
-0001f400: 7065 5b2d 315d 2c20 3129 3a0a 2020 2020  pe[-1], 1):.    
-0001f410: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-0001f420: 6574 2873 656c 662e 6675 6e63 2c20 2d31  et(self.func, -1
-0001f430: 2c20 636f 6e73 7461 6e74 2830 2929 0a20  , constant(0)). 
-0001f440: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0001f450: 6c66 2e66 756e 632e 5f72 6176 656c 2873  lf.func._ravel(s
-0001f460: 656c 662e 6e64 696d 2d31 290a 0a20 2020  elf.ndim-1)..   
-0001f470: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-0001f480: 2020 2064 6566 2065 7661 6c66 2866 293a     def evalf(f):
-0001f490: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001f4a0: 662e 7265 7368 6170 6528 662e 7368 6170  f.reshape(f.shap
-0001f4b0: 655b 3a2d 325d 202b 2028 662e 7368 6170  e[:-2] + (f.shap
-0001f4c0: 655b 2d32 5d2a 662e 7368 6170 655b 2d31  e[-2]*f.shape[-1
-0001f4d0: 5d2c 2929 0a0a 2020 2020 6465 6620 5f6d  ],))..    def _m
-0001f4e0: 756c 7469 706c 7928 7365 6c66 2c20 6f74  ultiply(self, ot
-0001f4f0: 6865 7229 3a0a 2020 2020 2020 2020 6966  her):.        if
-0001f500: 2069 7369 6e73 7461 6e63 6528 6f74 6865   isinstance(othe
-0001f510: 722c 2052 6176 656c 2920 616e 6420 6571  r, Ravel) and eq
-0001f520: 7561 6c73 6861 7065 286f 7468 6572 2e66  ualshape(other.f
-0001f530: 756e 632e 7368 6170 655b 2d32 3a5d 2c20  unc.shape[-2:], 
-0001f540: 7365 6c66 2e66 756e 632e 7368 6170 655b  self.func.shape[
-0001f550: 2d32 3a5d 293a 0a20 2020 2020 2020 2020  -2:]):.         
-0001f560: 2020 2072 6574 7572 6e20 5261 7665 6c28     return Ravel(
-0001f570: 6d75 6c74 6970 6c79 2873 656c 662e 6675  multiply(self.fu
-0001f580: 6e63 2c20 6f74 6865 722e 6675 6e63 2929  nc, other.func))
-0001f590: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001f5a0: 5261 7665 6c28 6d75 6c74 6970 6c79 2873  Ravel(multiply(s
-0001f5b0: 656c 662e 6675 6e63 2c20 556e 7261 7665  elf.func, Unrave
-0001f5c0: 6c28 6f74 6865 722c 202a 7365 6c66 2e66  l(other, *self.f
-0001f5d0: 756e 632e 7368 6170 655b 2d32 3a5d 2929  unc.shape[-2:]))
-0001f5e0: 290a 0a20 2020 2064 6566 205f 6164 6428  )..    def _add(
-0001f5f0: 7365 6c66 2c20 6f74 6865 7229 3a0a 2020  self, other):.  
-0001f600: 2020 2020 2020 7265 7475 726e 2052 6176        return Rav
-0001f610: 656c 2873 656c 662e 6675 6e63 202b 2055  el(self.func + U
-0001f620: 6e72 6176 656c 286f 7468 6572 2c20 2a73  nravel(other, *s
-0001f630: 656c 662e 6675 6e63 2e73 6861 7065 5b2d  elf.func.shape[-
-0001f640: 323a 5d29 290a 0a20 2020 2064 6566 205f  2:]))..    def _
-0001f650: 7375 6d28 7365 6c66 2c20 6178 6973 293a  sum(self, axis):
-0001f660: 0a20 2020 2020 2020 2069 6620 6178 6973  .        if axis
-0001f670: 203d 3d20 7365 6c66 2e6e 6469 6d2d 313a   == self.ndim-1:
-0001f680: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001f690: 7572 6e20 5375 6d28 5375 6d28 7365 6c66  urn Sum(Sum(self
-0001f6a0: 2e66 756e 6329 290a 2020 2020 2020 2020  .func)).        
-0001f6b0: 7265 7475 726e 2052 6176 656c 2873 756d  return Ravel(sum
-0001f6c0: 2873 656c 662e 6675 6e63 2c20 6178 6973  (self.func, axis
-0001f6d0: 2929 0a0a 2020 2020 6465 6620 5f64 6572  ))..    def _der
-0001f6e0: 6976 6174 6976 6528 7365 6c66 2c20 7661  ivative(self, va
-0001f6f0: 722c 2073 6565 6e29 3a0a 2020 2020 2020  r, seen):.      
-0001f700: 2020 7265 7475 726e 2072 6176 656c 2864    return ravel(d
-0001f710: 6572 6976 6174 6976 6528 7365 6c66 2e66  erivative(self.f
-0001f720: 756e 632c 2076 6172 2c20 7365 656e 292c  unc, var, seen),
-0001f730: 2061 7869 733d 7365 6c66 2e6e 6469 6d2d   axis=self.ndim-
-0001f740: 3129 0a0a 2020 2020 6465 6620 5f74 616b  1)..    def _tak
-0001f750: 6564 6961 6728 7365 6c66 2c20 6178 6973  ediag(self, axis
-0001f760: 312c 2061 7869 7332 293a 0a20 2020 2020  1, axis2):.     
-0001f770: 2020 2061 7373 6572 7420 6178 6973 3120     assert axis1 
-0001f780: 3c20 6178 6973 320a 2020 2020 2020 2020  < axis2.        
-0001f790: 6966 2061 7869 7332 203c 3d20 7365 6c66  if axis2 <= self
-0001f7a0: 2e6e 6469 6d2d 323a 0a20 2020 2020 2020  .ndim-2:.       
-0001f7b0: 2020 2020 2072 6574 7572 6e20 7261 7665       return rave
-0001f7c0: 6c28 5f74 616b 6564 6961 6728 7365 6c66  l(_takediag(self
-0001f7d0: 2e66 756e 632c 2061 7869 7331 2c20 6178  .func, axis1, ax
-0001f7e0: 6973 3229 2c20 7365 6c66 2e6e 6469 6d2d  is2), self.ndim-
-0001f7f0: 3329 0a20 2020 2020 2020 2065 6c73 653a  3).        else:
-0001f800: 0a20 2020 2020 2020 2020 2020 2075 6e72  .            unr
-0001f810: 6176 656c 6564 203d 2075 6e72 6176 656c  aveled = unravel
-0001f820: 2873 656c 662e 6675 6e63 2c20 6178 6973  (self.func, axis
-0001f830: 312c 2073 656c 662e 6675 6e63 2e73 6861  1, self.func.sha
-0001f840: 7065 5b2d 323a 5d29 0a20 2020 2020 2020  pe[-2:]).       
-0001f850: 2020 2020 2072 6574 7572 6e20 5261 7665       return Rave
-0001f860: 6c28 5f74 616b 6564 6961 6728 5f74 616b  l(_takediag(_tak
-0001f870: 6564 6961 6728 756e 7261 7665 6c65 642c  ediag(unraveled,
-0001f880: 2061 7869 7331 2c20 2d32 292c 2061 7869   axis1, -2), axi
-0001f890: 7331 2c20 2d32 2929 0a0a 2020 2020 6465  s1, -2))..    de
-0001f8a0: 6620 5f74 616b 6528 7365 6c66 2c20 696e  f _take(self, in
-0001f8b0: 6465 782c 2061 7869 7329 3a0a 2020 2020  dex, axis):.    
-0001f8c0: 2020 2020 6966 2061 7869 7320 213d 2073      if axis != s
-0001f8d0: 656c 662e 6e64 696d 2d31 3a0a 2020 2020  elf.ndim-1:.    
-0001f8e0: 2020 2020 2020 2020 7265 7475 726e 2052          return R
-0001f8f0: 6176 656c 285f 7461 6b65 2873 656c 662e  avel(_take(self.
-0001f900: 6675 6e63 2c20 696e 6465 782c 2061 7869  func, index, axi
-0001f910: 7329 290a 0a20 2020 2064 6566 205f 7274  s))..    def _rt
-0001f920: 616b 6528 7365 6c66 2c20 6675 6e63 2c20  ake(self, func, 
-0001f930: 6178 6973 293a 0a20 2020 2020 2020 2069  axis):.        i
-0001f940: 6620 7365 6c66 2e6e 6469 6d20 3d3d 2031  f self.ndim == 1
-0001f950: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001f960: 7475 726e 2052 6176 656c 2854 616b 6528  turn Ravel(Take(
-0001f970: 6675 6e63 2c20 7365 6c66 2e66 756e 6329  func, self.func)
-0001f980: 290a 0a20 2020 2064 6566 205f 756e 7261  )..    def _unra
-0001f990: 7665 6c28 7365 6c66 2c20 6178 6973 2c20  vel(self, axis, 
-0001f9a0: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
-0001f9b0: 6966 2061 7869 7320 213d 2073 656c 662e  if axis != self.
-0001f9c0: 6e64 696d 2d31 3a0a 2020 2020 2020 2020  ndim-1:.        
-0001f9d0: 2020 2020 7265 7475 726e 2052 6176 656c      return Ravel
-0001f9e0: 2875 6e72 6176 656c 2873 656c 662e 6675  (unravel(self.fu
-0001f9f0: 6e63 2c20 6178 6973 2c20 7368 6170 6529  nc, axis, shape)
-0001fa00: 290a 2020 2020 2020 2020 656c 6966 2065  ).        elif e
-0001fa10: 7175 616c 7368 6170 6528 7368 6170 652c  qualshape(shape,
-0001fa20: 2073 656c 662e 6675 6e63 2e73 6861 7065   self.func.shape
-0001fa30: 5b2d 323a 5d29 3a0a 2020 2020 2020 2020  [-2:]):.        
-0001fa40: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0001fa50: 6675 6e63 0a0a 2020 2020 6465 6620 5f69  func..    def _i
-0001fa60: 6e66 6c61 7465 2873 656c 662c 2064 6f66  nflate(self, dof
-0001fa70: 6d61 702c 206c 656e 6774 682c 2061 7869  map, length, axi
-0001fa80: 7329 3a0a 2020 2020 2020 2020 6966 2061  s):.        if a
-0001fa90: 7869 7320 3c20 7365 6c66 2e6e 6469 6d2d  xis < self.ndim-
-0001faa0: 646f 666d 6170 2e6e 6469 6d3a 0a20 2020  dofmap.ndim:.   
-0001fab0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001fac0: 5261 7665 6c28 5f69 6e66 6c61 7465 2873  Ravel(_inflate(s
-0001fad0: 656c 662e 6675 6e63 2c20 646f 666d 6170  elf.func, dofmap
-0001fae0: 2c20 6c65 6e67 7468 2c20 6178 6973 2929  , length, axis))
-0001faf0: 0a20 2020 2020 2020 2065 6c69 6620 646f  .        elif do
-0001fb00: 666d 6170 2e6e 6469 6d20 3d3d 2030 3a0a  fmap.ndim == 0:.
-0001fb10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001fb20: 726e 2072 6176 656c 2849 6e66 6c61 7465  rn ravel(Inflate
-0001fb30: 2873 656c 662e 6675 6e63 2c20 646f 666d  (self.func, dofm
-0001fb40: 6170 2c20 6c65 6e67 7468 292c 2073 656c  ap, length), sel
-0001fb50: 662e 6e64 696d 2d31 290a 2020 2020 2020  f.ndim-1).      
-0001fb60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001fb70: 2020 2020 7265 7475 726e 205f 696e 666c      return _infl
-0001fb80: 6174 6528 7365 6c66 2e66 756e 632c 2055  ate(self.func, U
-0001fb90: 6e72 6176 656c 2864 6f66 6d61 702c 202a  nravel(dofmap, *
-0001fba0: 7365 6c66 2e66 756e 632e 7368 6170 655b  self.func.shape[
-0001fbb0: 2d32 3a5d 292c 206c 656e 6774 682c 2061  -2:]), length, a
-0001fbc0: 7869 7329 0a0a 2020 2020 6465 6620 5f64  xis)..    def _d
-0001fbd0: 6961 676f 6e61 6c69 7a65 2873 656c 662c  iagonalize(self,
-0001fbe0: 2061 7869 7329 3a0a 2020 2020 2020 2020   axis):.        
-0001fbf0: 6966 2061 7869 7320 213d 2073 656c 662e  if axis != self.
-0001fc00: 6e64 696d 2d31 3a0a 2020 2020 2020 2020  ndim-1:.        
-0001fc10: 2020 2020 7265 7475 726e 2072 6176 656c      return ravel
-0001fc20: 2864 6961 676f 6e61 6c69 7a65 2873 656c  (diagonalize(sel
-0001fc30: 662e 6675 6e63 2c20 6178 6973 292c 2073  f.func, axis), s
-0001fc40: 656c 662e 6e64 696d 2d31 290a 0a20 2020  elf.ndim-1)..   
-0001fc50: 2064 6566 205f 696e 7365 7274 6178 6973   def _insertaxis
-0001fc60: 2873 656c 662c 2061 7869 732c 206c 656e  (self, axis, len
-0001fc70: 6774 6829 3a0a 2020 2020 2020 2020 7265  gth):.        re
-0001fc80: 7475 726e 2072 6176 656c 2869 6e73 6572  turn ravel(inser
-0001fc90: 7461 7869 7328 7365 6c66 2e66 756e 632c  taxis(self.func,
-0001fca0: 2061 7869 732b 2861 7869 7320 3d3d 2073   axis+(axis == s
-0001fcb0: 656c 662e 6e64 696d 292c 206c 656e 6774  elf.ndim), lengt
-0001fcc0: 6829 2c20 7365 6c66 2e6e 6469 6d2d 2861  h), self.ndim-(a
-0001fcd0: 7869 7320 3d3d 2073 656c 662e 6e64 696d  xis == self.ndim
-0001fce0: 2929 0a0a 2020 2020 6465 6620 5f70 6f77  ))..    def _pow
-0001fcf0: 6572 2873 656c 662c 206e 293a 0a20 2020  er(self, n):.   
-0001fd00: 2020 2020 2072 6574 7572 6e20 5261 7665       return Rave
-0001fd10: 6c28 506f 7765 7228 7365 6c66 2e66 756e  l(Power(self.fun
-0001fd20: 632c 2055 6e72 6176 656c 286e 2c20 2a73  c, Unravel(n, *s
-0001fd30: 656c 662e 6675 6e63 2e73 6861 7065 5b2d  elf.func.shape[-
-0001fd40: 323a 5d29 2929 0a0a 2020 2020 6465 6620  2:])))..    def 
-0001fd50: 5f73 6967 6e28 7365 6c66 293a 0a20 2020  _sign(self):.   
-0001fd60: 2020 2020 2072 6574 7572 6e20 5261 7665       return Rave
-0001fd70: 6c28 5369 676e 2873 656c 662e 6675 6e63  l(Sign(self.func
-0001fd80: 2929 0a0a 2020 2020 6465 6620 5f70 726f  ))..    def _pro
-0001fd90: 6475 6374 2873 656c 6629 3a0a 2020 2020  duct(self):.    
-0001fda0: 2020 2020 7265 7475 726e 2050 726f 6475      return Produ
-0001fdb0: 6374 2850 726f 6475 6374 2873 656c 662e  ct(Product(self.
-0001fdc0: 6675 6e63 2929 0a0a 2020 2020 6465 6620  func))..    def 
-0001fdd0: 5f6c 6f6f 7073 756d 2873 656c 662c 2069  _loopsum(self, i
-0001fde0: 6e64 6578 293a 0a20 2020 2020 2020 2072  ndex):.        r
-0001fdf0: 6574 7572 6e20 5261 7665 6c28 6c6f 6f70  eturn Ravel(loop
-0001fe00: 5f73 756d 2873 656c 662e 6675 6e63 2c20  _sum(self.func, 
-0001fe10: 696e 6465 7829 290a 0a20 2020 2040 7072  index))..    @pr
-0001fe20: 6f70 6572 7479 0a20 2020 2064 6566 205f  operty.    def _
-0001fe30: 756e 616c 6967 6e65 6428 7365 6c66 293a  unaligned(self):
-0001fe40: 0a20 2020 2020 2020 2075 6e61 6c69 676e  .        unalign
-0001fe50: 6564 2c20 7768 6572 6520 3d20 756e 616c  ed, where = unal
-0001fe60: 6967 6e28 7365 6c66 2e66 756e 632c 206e  ign(self.func, n
-0001fe70: 6178 6573 3d73 656c 662e 6e64 696d 202d  axes=self.ndim -
-0001fe80: 2031 290a 2020 2020 2020 2020 7265 7475   1).        retu
-0001fe90: 726e 2052 6176 656c 2875 6e61 6c69 676e  rn Ravel(unalign
-0001fea0: 6564 292c 2028 2a77 6865 7265 2c20 7365  ed), (*where, se
-0001feb0: 6c66 2e6e 6469 6d20 2d20 3129 0a0a 2020  lf.ndim - 1)..  
-0001fec0: 2020 4063 6163 6865 645f 7072 6f70 6572    @cached_proper
-0001fed0: 7479 0a20 2020 2064 6566 205f 6173 7370  ty.    def _assp
-0001fee0: 6172 7365 2873 656c 6629 3a0a 2020 2020  arse(self):.    
-0001fef0: 2020 2020 7265 7475 726e 2074 7570 6c65      return tuple
-0001ff00: 2828 2a69 6e64 6963 6573 5b3a 2d32 5d2c  ((*indices[:-2],
-0001ff10: 2069 6e64 6963 6573 5b2d 325d 2a73 656c   indices[-2]*sel
-0001ff20: 662e 6675 6e63 2e73 6861 7065 5b2d 315d  f.func.shape[-1]
-0001ff30: 2b69 6e64 6963 6573 5b2d 315d 2c20 7661  +indices[-1], va
-0001ff40: 6c75 6573 2920 666f 7220 2a69 6e64 6963  lues) for *indic
-0001ff50: 6573 2c20 7661 6c75 6573 2069 6e20 7365  es, values in se
-0001ff60: 6c66 2e66 756e 632e 5f61 7373 7061 7273  lf.func._asspars
-0001ff70: 6529 0a0a 2020 2020 6465 6620 5f69 6e74  e)..    def _int
-0001ff80: 626f 756e 6473 5f69 6d70 6c28 7365 6c66  bounds_impl(self
-0001ff90: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0001ffa0: 6e20 7365 6c66 2e66 756e 632e 5f69 6e74  n self.func._int
-0001ffb0: 626f 756e 6473 5f69 6d70 6c28 290a 0a0a  bounds_impl()...
-0001ffc0: 636c 6173 7320 556e 7261 7665 6c28 4172  class Unravel(Ar
-0001ffd0: 7261 7929 3a0a 0a20 2020 2064 6566 205f  ray):..    def _
-0001ffe0: 5f69 6e69 745f 5f28 7365 6c66 2c20 6675  _init__(self, fu
-0001fff0: 6e63 3a20 4172 7261 792c 2073 6831 3a20  nc: Array, sh1: 
-00020000: 4172 7261 792c 2073 6832 3a20 4172 7261  Array, sh2: Arra
-00020010: 7929 3a0a 2020 2020 2020 2020 6173 7365  y):.        asse
-00020020: 7274 2069 7369 6e73 7461 6e63 6528 6675  rt isinstance(fu
-00020030: 6e63 2c20 4172 7261 7929 2061 6e64 2066  nc, Array) and f
-00020040: 756e 632e 6e64 696d 203e 2030 2c20 6627  unc.ndim > 0, f'
-00020050: 6675 6e63 3d7b 6675 6e63 2172 7d27 0a20  func={func!r}'. 
-00020060: 2020 2020 2020 2061 7373 6572 7420 5f69         assert _i
-00020070: 7369 6e64 6578 2873 6831 292c 2066 2773  sindex(sh1), f's
-00020080: 6831 3d7b 7368 3121 727d 270a 2020 2020  h1={sh1!r}'.    
-00020090: 2020 2020 6173 7365 7274 205f 6973 696e      assert _isin
-000200a0: 6465 7828 7368 3229 2c20 6627 7368 323d  dex(sh2), f'sh2=
-000200b0: 7b73 6832 2172 7d27 0a20 2020 2020 2020  {sh2!r}'.       
-000200c0: 2061 7373 6572 7420 5f65 7175 616c 735f   assert _equals_
-000200d0: 7369 6d70 6c69 6669 6564 2866 756e 632e  simplified(func.
-000200e0: 7368 6170 655b 2d31 5d2c 2073 6831 202a  shape[-1], sh1 *
-000200f0: 2073 6832 290a 2020 2020 2020 2020 7365   sh2).        se
-00020100: 6c66 2e66 756e 6320 3d20 6675 6e63 0a20  lf.func = func. 
-00020110: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
-00020120: 5f69 6e69 745f 5f28 6172 6773 3d28 6675  _init__(args=(fu
-00020130: 6e63 2c20 7368 312c 2073 6832 292c 2073  nc, sh1, sh2), s
-00020140: 6861 7065 3d28 2a66 756e 632e 7368 6170  hape=(*func.shap
-00020150: 655b 3a2d 315d 2c20 7368 312c 2073 6832  e[:-1], sh1, sh2
-00020160: 292c 2064 7479 7065 3d66 756e 632e 6474  ), dtype=func.dt
-00020170: 7970 6529 0a0a 2020 2020 6465 6620 5f73  ype)..    def _s
-00020180: 696d 706c 6966 6965 6428 7365 6c66 293a  implified(self):
-00020190: 0a20 2020 2020 2020 2069 6620 5f65 7175  .        if _equ
-000201a0: 616c 735f 7363 616c 6172 5f63 6f6e 7374  als_scalar_const
-000201b0: 616e 7428 7365 6c66 2e73 6861 7065 5b2d  ant(self.shape[-
-000201c0: 325d 2c20 3129 3a0a 2020 2020 2020 2020  2], 1):.        
-000201d0: 2020 2020 7265 7475 726e 2069 6e73 6572      return inser
-000201e0: 7461 7869 7328 7365 6c66 2e66 756e 632c  taxis(self.func,
-000201f0: 2073 656c 662e 6e64 696d 2d32 2c20 636f   self.ndim-2, co
-00020200: 6e73 7461 6e74 2831 2929 0a20 2020 2020  nstant(1)).     
-00020210: 2020 2069 6620 5f65 7175 616c 735f 7363     if _equals_sc
-00020220: 616c 6172 5f63 6f6e 7374 616e 7428 7365  alar_constant(se
-00020230: 6c66 2e73 6861 7065 5b2d 315d 2c20 3129  lf.shape[-1], 1)
-00020240: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00020250: 7475 726e 2069 6e73 6572 7461 7869 7328  turn insertaxis(
-00020260: 7365 6c66 2e66 756e 632c 2073 656c 662e  self.func, self.
-00020270: 6e64 696d 2d31 2c20 636f 6e73 7461 6e74  ndim-1, constant
-00020280: 2831 2929 0a20 2020 2020 2020 2072 6574  (1)).        ret
-00020290: 7572 6e20 7365 6c66 2e66 756e 632e 5f75  urn self.func._u
-000202a0: 6e72 6176 656c 2873 656c 662e 6e64 696d  nravel(self.ndim
-000202b0: 2d32 2c20 7365 6c66 2e73 6861 7065 5b2d  -2, self.shape[-
-000202c0: 323a 5d29 0a0a 2020 2020 6465 6620 5f64  2:])..    def _d
-000202d0: 6572 6976 6174 6976 6528 7365 6c66 2c20  erivative(self, 
-000202e0: 7661 722c 2073 6565 6e29 3a0a 2020 2020  var, seen):.    
-000202f0: 2020 2020 7265 7475 726e 2075 6e72 6176      return unrav
-00020300: 656c 2864 6572 6976 6174 6976 6528 7365  el(derivative(se
-00020310: 6c66 2e66 756e 632c 2076 6172 2c20 7365  lf.func, var, se
-00020320: 656e 292c 2061 7869 733d 7365 6c66 2e6e  en), axis=self.n
-00020330: 6469 6d2d 322c 2073 6861 7065 3d73 656c  dim-2, shape=sel
-00020340: 662e 7368 6170 655b 2d32 3a5d 290a 0a20  f.shape[-2:]).. 
-00020350: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
-00020360: 0a20 2020 2064 6566 2065 7661 6c66 2866  .    def evalf(f
-00020370: 2c20 7368 312c 2073 6832 293a 0a20 2020  , sh1, sh2):.   
-00020380: 2020 2020 2072 6574 7572 6e20 662e 7265       return f.re
-00020390: 7368 6170 6528 662e 7368 6170 655b 3a2d  shape(f.shape[:-
-000203a0: 315d 202b 2028 7368 312c 2073 6832 2929  1] + (sh1, sh2))
-000203b0: 0a0a 2020 2020 6465 6620 5f74 616b 6564  ..    def _taked
-000203c0: 6961 6728 7365 6c66 2c20 6178 6973 312c  iag(self, axis1,
-000203d0: 2061 7869 7332 293a 0a20 2020 2020 2020   axis2):.       
-000203e0: 2069 6620 6178 6973 3220 3c20 7365 6c66   if axis2 < self
-000203f0: 2e6e 6469 6d2d 323a 0a20 2020 2020 2020  .ndim-2:.       
-00020400: 2020 2020 2072 6574 7572 6e20 756e 7261       return unra
-00020410: 7665 6c28 5f74 616b 6564 6961 6728 7365  vel(_takediag(se
-00020420: 6c66 2e66 756e 632c 2061 7869 7331 2c20  lf.func, axis1, 
-00020430: 6178 6973 3229 2c20 7365 6c66 2e6e 6469  axis2), self.ndi
-00020440: 6d2d 342c 2073 656c 662e 7368 6170 655b  m-4, self.shape[
-00020450: 2d32 3a5d 290a 0a20 2020 2064 6566 205f  -2:])..    def _
-00020460: 7461 6b65 2873 656c 662c 2069 6e64 6578  take(self, index
-00020470: 2c20 6178 6973 293a 0a20 2020 2020 2020  , axis):.       
-00020480: 2069 6620 6178 6973 203c 2073 656c 662e   if axis < self.
-00020490: 6e64 696d 202d 2032 3a0a 2020 2020 2020  ndim - 2:.      
-000204a0: 2020 2020 2020 7265 7475 726e 2055 6e72        return Unr
-000204b0: 6176 656c 285f 7461 6b65 2873 656c 662e  avel(_take(self.
-000204c0: 6675 6e63 2c20 696e 6465 782c 2061 7869  func, index, axi
-000204d0: 7329 2c20 2a73 656c 662e 7368 6170 655b  s), *self.shape[
-000204e0: 2d32 3a5d 290a 0a20 2020 2064 6566 205f  -2:])..    def _
-000204f0: 7375 6d28 7365 6c66 2c20 6178 6973 293a  sum(self, axis):
-00020500: 0a20 2020 2020 2020 2069 6620 6178 6973  .        if axis
-00020510: 203c 2073 656c 662e 6e64 696d 202d 2032   < self.ndim - 2
-00020520: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00020530: 7475 726e 2055 6e72 6176 656c 2873 756d  turn Unravel(sum
-00020540: 2873 656c 662e 6675 6e63 2c20 6178 6973  (self.func, axis
-00020550: 292c 202a 7365 6c66 2e73 6861 7065 5b2d  ), *self.shape[-
-00020560: 323a 5d29 0a0a 2020 2020 4063 6163 6865  2:])..    @cache
-00020570: 645f 7072 6f70 6572 7479 0a20 2020 2064  d_property.    d
-00020580: 6566 205f 6173 7370 6172 7365 2873 656c  ef _assparse(sel
-00020590: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
-000205a0: 726e 2074 7570 6c65 2828 2a69 6e64 6963  rn tuple((*indic
-000205b0: 6573 5b3a 2d31 5d2c 202a 6469 766d 6f64  es[:-1], *divmod
-000205c0: 2869 6e64 6963 6573 5b2d 315d 2c20 6170  (indices[-1], ap
-000205d0: 7065 6e64 6178 6573 2873 656c 662e 7368  pendaxes(self.sh
-000205e0: 6170 655b 2d31 5d2c 2076 616c 7565 732e  ape[-1], values.
-000205f0: 7368 6170 6529 292c 2076 616c 7565 7329  shape)), values)
-00020600: 2066 6f72 202a 696e 6469 6365 732c 2076   for *indices, v
-00020610: 616c 7565 7320 696e 2073 656c 662e 6675  alues in self.fu
-00020620: 6e63 2e5f 6173 7370 6172 7365 290a 0a0a  nc._assparse)...
-00020630: 636c 6173 7320 5261 7665 6c49 6e64 6578  class RavelIndex
-00020640: 2841 7272 6179 293a 0a0a 2020 2020 6465  (Array):..    de
-00020650: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-00020660: 2069 613a 2041 7272 6179 2c20 6962 3a20   ia: Array, ib: 
-00020670: 4172 7261 792c 206e 613a 2041 7272 6179  Array, na: Array
-00020680: 2c20 6e62 3a20 4172 7261 7929 3a0a 2020  , nb: Array):.  
-00020690: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-000206a0: 6e73 7461 6e63 6528 6961 2c20 4172 7261  nstance(ia, Arra
-000206b0: 7929 2c20 6627 6961 3d7b 6961 2172 7d27  y), f'ia={ia!r}'
-000206c0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-000206d0: 6973 696e 7374 616e 6365 2869 622c 2041  isinstance(ib, A
-000206e0: 7272 6179 292c 2066 2769 623d 7b69 6221  rray), f'ib={ib!
-000206f0: 727d 270a 2020 2020 2020 2020 6173 7365  r}'.        asse
-00020700: 7274 205f 6973 696e 6465 7828 6e61 292c  rt _isindex(na),
-00020710: 2066 276e 613d 7b6e 6121 727d 270a 2020   f'na={na!r}'.  
-00020720: 2020 2020 2020 6173 7365 7274 205f 6973        assert _is
-00020730: 696e 6465 7828 6e62 292c 2066 276e 623d  index(nb), f'nb=
-00020740: 7b6e 6221 727d 270a 2020 2020 2020 2020  {nb!r}'.        
-00020750: 7365 6c66 2e5f 6961 203d 2069 610a 2020  self._ia = ia.  
-00020760: 2020 2020 2020 7365 6c66 2e5f 6962 203d        self._ib =
-00020770: 2069 620a 2020 2020 2020 2020 7365 6c66   ib.        self
-00020780: 2e5f 6e61 203d 206e 610a 2020 2020 2020  ._na = na.      
-00020790: 2020 7365 6c66 2e5f 6e62 203d 206e 620a    self._nb = nb.
-000207a0: 2020 2020 2020 2020 7365 6c66 2e5f 6c65          self._le
-000207b0: 6e67 7468 203d 206e 6120 2a20 6e62 0a20  ngth = na * nb. 
-000207c0: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
-000207d0: 5f69 6e69 745f 5f28 6172 6773 3d28 6961  _init__(args=(ia
-000207e0: 2c20 6962 2c20 6e62 292c 2073 6861 7065  , ib, nb), shape
-000207f0: 3d69 612e 7368 6170 6520 2b20 6962 2e73  =ia.shape + ib.s
-00020800: 6861 7065 2c20 6474 7970 653d 696e 7429  hape, dtype=int)
-00020810: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
-00020820: 686f 640a 2020 2020 6465 6620 6576 616c  hod.    def eval
-00020830: 6628 6961 2c20 6962 2c20 6e62 293a 0a20  f(ia, ib, nb):. 
-00020840: 2020 2020 2020 2072 6574 7572 6e20 6961         return ia
-00020850: 5b28 2e2e 2e2c 292b 286e 756d 7079 2e6e  [(...,)+(numpy.n
-00020860: 6577 6178 6973 2c29 2a69 622e 6e64 696d  ewaxis,)*ib.ndim
-00020870: 5d20 2a20 6e62 202b 2069 620a 0a20 2020  ] * nb + ib..   
-00020880: 2064 6566 205f 7461 6b65 2873 656c 662c   def _take(self,
-00020890: 2069 6e64 6578 2c20 6178 6973 293a 0a20   index, axis):. 
-000208a0: 2020 2020 2020 2069 6620 6178 6973 203c         if axis <
-000208b0: 2073 656c 662e 5f69 612e 6e64 696d 3a0a   self._ia.ndim:.
-000208c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000208d0: 726e 2052 6176 656c 496e 6465 7828 5f74  rn RavelIndex(_t
-000208e0: 616b 6528 7365 6c66 2e5f 6961 2c20 696e  ake(self._ia, in
-000208f0: 6465 782c 2061 7869 7329 2c20 7365 6c66  dex, axis), self
-00020900: 2e5f 6962 2c20 7365 6c66 2e5f 6e61 2c20  ._ib, self._na, 
-00020910: 7365 6c66 2e5f 6e62 290a 2020 2020 2020  self._nb).      
-00020920: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00020930: 2020 2020 7265 7475 726e 2052 6176 656c      return Ravel
-00020940: 496e 6465 7828 7365 6c66 2e5f 6961 2c20  Index(self._ia, 
-00020950: 5f74 616b 6528 7365 6c66 2e5f 6962 2c20  _take(self._ib, 
-00020960: 696e 6465 782c 2061 7869 7320 2d20 7365  index, axis - se
-00020970: 6c66 2e5f 6961 2e6e 6469 6d29 2c20 7365  lf._ia.ndim), se
-00020980: 6c66 2e5f 6e61 2c20 7365 6c66 2e5f 6e62  lf._na, self._nb
-00020990: 290a 0a20 2020 2064 6566 205f 7274 616b  )..    def _rtak
-000209a0: 6528 7365 6c66 2c20 6675 6e63 2c20 6178  e(self, func, ax
-000209b0: 6973 293a 0a20 2020 2020 2020 2069 6620  is):.        if 
-000209c0: 5f65 7175 616c 735f 7369 6d70 6c69 6669  _equals_simplifi
-000209d0: 6564 2866 756e 632e 7368 6170 655b 6178  ed(func.shape[ax
-000209e0: 6973 5d2c 2073 656c 662e 5f6c 656e 6774  is], self._lengt
-000209f0: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
-00020a00: 7265 7475 726e 205f 7461 6b65 285f 7461  return _take(_ta
-00020a10: 6b65 2875 6e72 6176 656c 2866 756e 632c  ke(unravel(func,
-00020a20: 2061 7869 732c 2028 7365 6c66 2e5f 6e61   axis, (self._na
-00020a30: 2c20 7365 6c66 2e5f 6e62 2929 2c20 7365  , self._nb)), se
-00020a40: 6c66 2e5f 6962 2c20 6178 6973 2b31 292c  lf._ib, axis+1),
-00020a50: 2073 656c 662e 5f69 612c 2061 7869 7329   self._ia, axis)
-00020a60: 0a0a 2020 2020 6465 6620 5f72 696e 666c  ..    def _rinfl
-00020a70: 6174 6528 7365 6c66 2c20 6675 6e63 2c20  ate(self, func, 
-00020a80: 6c65 6e67 7468 2c20 6178 6973 293a 0a20  length, axis):. 
-00020a90: 2020 2020 2020 2069 6620 5f65 7175 616c         if _equal
-00020aa0: 735f 7369 6d70 6c69 6669 6564 286c 656e  s_simplified(len
-00020ab0: 6774 682c 2073 656c 662e 5f6c 656e 6774  gth, self._lengt
-00020ac0: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
-00020ad0: 7265 7475 726e 2052 6176 656c 2849 6e66  return Ravel(Inf
-00020ae0: 6c61 7465 285f 696e 666c 6174 6528 6675  late(_inflate(fu
-00020af0: 6e63 2c20 7365 6c66 2e5f 6961 2c20 7365  nc, self._ia, se
-00020b00: 6c66 2e5f 6e61 2c20 6675 6e63 2e6e 6469  lf._na, func.ndi
-00020b10: 6d20 2d20 7365 6c66 2e6e 6469 6d29 2c20  m - self.ndim), 
-00020b20: 7365 6c66 2e5f 6962 2c20 7365 6c66 2e5f  self._ib, self._
-00020b30: 6e62 2929 0a0a 2020 2020 6465 6620 5f75  nb))..    def _u
-00020b40: 6e72 6176 656c 2873 656c 662c 2061 7869  nravel(self, axi
-00020b50: 732c 2073 6861 7065 293a 0a20 2020 2020  s, shape):.     
-00020b60: 2020 2069 6620 6178 6973 203c 2073 656c     if axis < sel
-00020b70: 662e 5f69 612e 6e64 696d 3a0a 2020 2020  f._ia.ndim:.    
-00020b80: 2020 2020 2020 2020 7265 7475 726e 2052          return R
-00020b90: 6176 656c 496e 6465 7828 756e 7261 7665  avelIndex(unrave
-00020ba0: 6c28 7365 6c66 2e5f 6961 2c20 6178 6973  l(self._ia, axis
-00020bb0: 2c20 7368 6170 6529 2c20 7365 6c66 2e5f  , shape), self._
-00020bc0: 6962 2c20 7365 6c66 2e5f 6e61 2c20 7365  ib, self._na, se
-00020bd0: 6c66 2e5f 6e62 290a 2020 2020 2020 2020  lf._nb).        
-00020be0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00020bf0: 2020 7265 7475 726e 2052 6176 656c 496e    return RavelIn
-00020c00: 6465 7828 7365 6c66 2e5f 6961 2c20 756e  dex(self._ia, un
-00020c10: 7261 7665 6c28 7365 6c66 2e5f 6962 2c20  ravel(self._ib, 
-00020c20: 6178 6973 2d73 656c 662e 5f69 612e 6e64  axis-self._ia.nd
-00020c30: 696d 2c20 7368 6170 6529 2c20 7365 6c66  im, shape), self
-00020c40: 2e5f 6e61 2c20 7365 6c66 2e5f 6e62 290a  ._na, self._nb).
-00020c50: 0a20 2020 2064 6566 205f 696e 7462 6f75  .    def _intbou
-00020c60: 6e64 735f 696d 706c 2873 656c 6629 3a0a  nds_impl(self):.
-00020c70: 2020 2020 2020 2020 6e62 6d69 6e2c 206e          nbmin, n
-00020c80: 626d 6178 203d 2073 656c 662e 5f6e 622e  bmax = self._nb.
-00020c90: 5f69 6e74 626f 756e 6473 0a20 2020 2020  _intbounds.     
-00020ca0: 2020 2069 616d 696e 2c20 6961 6d61 7820     iamin, iamax 
-00020cb0: 3d20 7365 6c66 2e5f 6961 2e5f 696e 7462  = self._ia._intb
-00020cc0: 6f75 6e64 730a 2020 2020 2020 2020 6962  ounds.        ib
-00020cd0: 6d69 6e2c 2069 626d 6178 203d 2073 656c  min, ibmax = sel
-00020ce0: 662e 5f69 622e 5f69 6e74 626f 756e 6473  f._ib._intbounds
-00020cf0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00020d00: 6961 6d69 6e20 2a20 6e62 6d69 6e20 2b20  iamin * nbmin + 
-00020d10: 6962 6d69 6e2c 2028 6961 6d61 7820 616e  ibmin, (iamax an
-00020d20: 6420 6e62 6d61 7820 616e 6420 6961 6d61  d nbmax and iama
-00020d30: 7820 2a20 6e62 6d61 7829 202b 2069 626d  x * nbmax) + ibm
-00020d40: 6178 0a0a 0a63 6c61 7373 2052 616e 6765  ax...class Range
-00020d50: 2841 7272 6179 293a 0a0a 2020 2020 6465  (Array):..    de
-00020d60: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-00020d70: 206c 656e 6774 683a 2041 7272 6179 293a   length: Array):
-00020d80: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00020d90: 5f69 7369 6e64 6578 286c 656e 6774 6829  _isindex(length)
-00020da0: 2c20 6627 6c65 6e67 7468 3d7b 6c65 6e67  , f'length={leng
-00020db0: 7468 2172 7d27 0a20 2020 2020 2020 2073  th!r}'.        s
-00020dc0: 656c 662e 6c65 6e67 7468 203d 206c 656e  elf.length = len
-00020dd0: 6774 680a 2020 2020 2020 2020 7375 7065  gth.        supe
-00020de0: 7228 292e 5f5f 696e 6974 5f5f 2861 7267  r().__init__(arg
-00020df0: 733d 286c 656e 6774 682c 292c 2073 6861  s=(length,), sha
-00020e00: 7065 3d28 6c65 6e67 7468 2c29 2c20 6474  pe=(length,), dt
-00020e10: 7970 653d 696e 7429 0a0a 2020 2020 6465  ype=int)..    de
-00020e20: 6620 5f74 616b 6528 7365 6c66 2c20 696e  f _take(self, in
-00020e30: 6465 782c 2061 7869 7329 3a0a 2020 2020  dex, axis):.    
-00020e40: 2020 2020 7265 7475 726e 2049 6e52 616e      return InRan
-00020e50: 6765 2869 6e64 6578 2c20 7365 6c66 2e6c  ge(index, self.l
-00020e60: 656e 6774 6829 0a0a 2020 2020 6465 6620  ength)..    def 
-00020e70: 5f75 6e72 6176 656c 2873 656c 662c 2061  _unravel(self, a
-00020e80: 7869 732c 2073 6861 7065 293a 0a20 2020  xis, shape):.   
-00020e90: 2020 2020 2069 6620 6c65 6e28 7368 6170       if len(shap
-00020ea0: 6529 203d 3d20 323a 0a20 2020 2020 2020  e) == 2:.       
-00020eb0: 2020 2020 2072 6574 7572 6e20 5261 7665       return Rave
-00020ec0: 6c49 6e64 6578 2852 616e 6765 2873 6861  lIndex(Range(sha
-00020ed0: 7065 5b30 5d29 2c20 5261 6e67 6528 7368  pe[0]), Range(sh
-00020ee0: 6170 655b 315d 292c 2073 6861 7065 5b30  ape[1]), shape[0
-00020ef0: 5d2c 2073 6861 7065 5b31 5d29 0a0a 2020  ], shape[1])..  
-00020f00: 2020 6465 6620 5f72 7461 6b65 2873 656c    def _rtake(sel
-00020f10: 662c 2066 756e 632c 2061 7869 7329 3a0a  f, func, axis):.
-00020f20: 2020 2020 2020 2020 6966 205f 6571 7561          if _equa
-00020f30: 6c73 5f73 696d 706c 6966 6965 6428 7365  ls_simplified(se
-00020f40: 6c66 2e6c 656e 6774 682c 2066 756e 632e  lf.length, func.
-00020f50: 7368 6170 655b 6178 6973 5d29 3a0a 2020  shape[axis]):.  
-00020f60: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00020f70: 2066 756e 630a 0a20 2020 2064 6566 205f   func..    def _
-00020f80: 7269 6e66 6c61 7465 2873 656c 662c 2066  rinflate(self, f
-00020f90: 756e 632c 206c 656e 6774 682c 2061 7869  unc, length, axi
-00020fa0: 7329 3a0a 2020 2020 2020 2020 6966 206c  s):.        if l
-00020fb0: 656e 6774 6820 3d3d 2073 656c 662e 6c65  ength == self.le
-00020fc0: 6e67 7468 3a0a 2020 2020 2020 2020 2020  ngth:.          
-00020fd0: 2020 7265 7475 726e 2066 756e 630a 0a20    return func.. 
-00020fe0: 2020 2065 7661 6c66 203d 2073 7461 7469     evalf = stati
-00020ff0: 636d 6574 686f 6428 6e75 6d70 792e 6172  cmethod(numpy.ar
-00021000: 616e 6765 290a 0a20 2020 2064 6566 205f  ange)..    def _
-00021010: 696e 7462 6f75 6e64 735f 696d 706c 2873  intbounds_impl(s
-00021020: 656c 6629 3a0a 2020 2020 2020 2020 6c6f  elf):.        lo
-00021030: 7765 722c 2075 7070 6572 203d 2073 656c  wer, upper = sel
-00021040: 662e 6c65 6e67 7468 2e5f 696e 7462 6f75  f.length._intbou
-00021050: 6e64 730a 2020 2020 2020 2020 6173 7365  nds.        asse
-00021060: 7274 206c 6f77 6572 203e 3d20 300a 2020  rt lower >= 0.  
-00021070: 2020 2020 2020 7265 7475 726e 2030 2c20        return 0, 
-00021080: 6d61 7828 302c 2075 7070 6572 202d 2031  max(0, upper - 1
-00021090: 290a 0a0a 636c 6173 7320 496e 5261 6e67  )...class InRang
-000210a0: 6528 4172 7261 7929 3a0a 0a20 2020 2064  e(Array):..    d
-000210b0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-000210c0: 2c20 696e 6465 783a 2041 7272 6179 2c20  , index: Array, 
-000210d0: 6c65 6e67 7468 3a20 4172 7261 7929 3a0a  length: Array):.
-000210e0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-000210f0: 7369 6e73 7461 6e63 6528 696e 6465 782c  sinstance(index,
-00021100: 2041 7272 6179 2920 616e 6420 696e 6465   Array) and inde
-00021110: 782e 6474 7970 6520 3d3d 2069 6e74 2c20  x.dtype == int, 
-00021120: 6627 696e 6465 783d 7b69 6e64 6578 2172  f'index={index!r
-00021130: 7d27 0a20 2020 2020 2020 2061 7373 6572  }'.        asser
-00021140: 7420 6973 696e 7374 616e 6365 286c 656e  t isinstance(len
-00021150: 6774 682c 2041 7272 6179 2920 616e 6420  gth, Array) and 
-00021160: 6c65 6e67 7468 2e64 7479 7065 203d 3d20  length.dtype == 
-00021170: 696e 7420 616e 6420 6c65 6e67 7468 2e6e  int and length.n
-00021180: 6469 6d20 3d3d 2030 2c20 6627 6c65 6e67  dim == 0, f'leng
-00021190: 7468 3d7b 6c65 6e67 7468 2172 7d27 0a20  th={length!r}'. 
-000211a0: 2020 2020 2020 2073 656c 662e 696e 6465         self.inde
-000211b0: 7820 3d20 696e 6465 780a 2020 2020 2020  x = index.      
-000211c0: 2020 7365 6c66 2e6c 656e 6774 6820 3d20    self.length = 
-000211d0: 6c65 6e67 7468 0a20 2020 2020 2020 2073  length.        s
-000211e0: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
-000211f0: 6172 6773 3d28 696e 6465 782c 206c 656e  args=(index, len
-00021200: 6774 6829 2c20 7368 6170 653d 696e 6465  gth), shape=inde
-00021210: 782e 7368 6170 652c 2064 7479 7065 3d69  x.shape, dtype=i
-00021220: 6e74 290a 0a20 2020 2040 7374 6174 6963  nt)..    @static
-00021230: 6d65 7468 6f64 0a20 2020 2064 6566 2065  method.    def e
-00021240: 7661 6c66 2869 6e64 6578 2c20 6c65 6e67  valf(index, leng
-00021250: 7468 293a 0a20 2020 2020 2020 2061 7373  th):.        ass
-00021260: 6572 7420 696e 6465 782e 7369 7a65 203d  ert index.size =
-00021270: 3d20 3020 6f72 2030 203c 3d20 696e 6465  = 0 or 0 <= inde
-00021280: 782e 6d69 6e28 2920 616e 6420 696e 6465  x.min() and inde
-00021290: 782e 6d61 7828 2920 3c20 6c65 6e67 7468  x.max() < length
-000212a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000212b0: 696e 6465 780a 0a20 2020 2064 6566 205f  index..    def _
-000212c0: 7369 6d70 6c69 6669 6564 2873 656c 6629  simplified(self)
-000212d0: 3a0a 2020 2020 2020 2020 6c6f 7765 725f  :.        lower_
-000212e0: 6c65 6e67 7468 2c20 7570 7065 725f 6c65  length, upper_le
-000212f0: 6e67 7468 203d 2073 656c 662e 6c65 6e67  ngth = self.leng
-00021300: 7468 2e5f 696e 7462 6f75 6e64 730a 2020  th._intbounds.  
-00021310: 2020 2020 2020 6c6f 7765 725f 696e 6465        lower_inde
-00021320: 782c 2075 7070 6572 5f69 6e64 6578 203d  x, upper_index =
-00021330: 2073 656c 662e 696e 6465 782e 5f69 6e74   self.index._int
-00021340: 626f 756e 6473 0a20 2020 2020 2020 2069  bounds.        i
-00021350: 6620 3020 3c3d 206c 6f77 6572 5f69 6e64  f 0 <= lower_ind
-00021360: 6578 203c 3d20 7570 7065 725f 696e 6465  ex <= upper_inde
-00021370: 7820 3c20 6c6f 7765 725f 6c65 6e67 7468  x < lower_length
-00021380: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00021390: 7475 726e 2073 656c 662e 696e 6465 780a  turn self.index.
-000213a0: 0a20 2020 2064 6566 205f 696e 7462 6f75  .    def _intbou
-000213b0: 6e64 735f 696d 706c 2873 656c 6629 3a0a  nds_impl(self):.
-000213c0: 2020 2020 2020 2020 6c6f 7765 725f 696e          lower_in
-000213d0: 6465 782c 2075 7070 6572 5f69 6e64 6578  dex, upper_index
-000213e0: 203d 2073 656c 662e 696e 6465 782e 5f69   = self.index._i
-000213f0: 6e74 626f 756e 6473 0a20 2020 2020 2020  ntbounds.       
-00021400: 206c 6f77 6572 5f6c 656e 6774 682c 2075   lower_length, u
-00021410: 7070 6572 5f6c 656e 6774 6820 3d20 7365  pper_length = se
-00021420: 6c66 2e6c 656e 6774 682e 5f69 6e74 626f  lf.length._intbo
-00021430: 756e 6473 0a20 2020 2020 2020 2075 7070  unds.        upp
-00021440: 6572 203d 206d 696e 2875 7070 6572 5f69  er = min(upper_i
-00021450: 6e64 6578 2c20 6d61 7828 302c 2075 7070  ndex, max(0, upp
-00021460: 6572 5f6c 656e 6774 6820 2d20 3129 290a  er_length - 1)).
-00021470: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-00021480: 6178 2830 2c20 6d69 6e28 6c6f 7765 725f  ax(0, min(lower_
-00021490: 696e 6465 782c 2075 7070 6572 2929 2c20  index, upper)), 
-000214a0: 7570 7065 720a 0a0a 636c 6173 7320 506f  upper...class Po
-000214b0: 6c79 7661 6c28 4172 7261 7929 3a0a 2020  lyval(Array):.  
-000214c0: 2020 2727 2745 7661 6c75 6174 6520 6120    '''Evaluate a 
-000214d0: 706f 6c79 6e6f 6d69 616c 0a0a 2020 2020  polynomial..    
-000214e0: 5468 6520 706f 6c79 6e6f 6d69 616c 7320  The polynomials 
-000214f0: 6172 6520 6f66 2074 6865 2066 6f72 6d0a  are of the form.
-00021500: 0a20 2020 202e 2e20 6d61 7468 3a3a 20ce  .    .. math:: .
-00021510: a35f 7b6b 20e2 8888 20e2 84a4 5e6e 207c  ._{k ... ...^n |
-00021520: 20ce a35f 6920 6b5f 6920 e289 a420 707d   .._i k_i ... p}
-00021530: 2063 5f6b 20e2 888f 5f69 2078 5f69 5e28   c_k ..._i x_i^(
-00021540: 6b5f 6929 0a0a 2020 2020 7768 6572 6520  k_i)..    where 
-00021550: 3a6d 6174 683a 6063 6020 6973 2061 2076  :math:`c` is a v
-00021560: 6563 746f 7220 6f66 2063 6f65 6666 6963  ector of coeffic
-00021570: 6965 6e74 732c 203a 6d61 7468 3a60 7860  ients, :math:`x`
-00021580: 2061 2076 6563 746f 7220 6f66 0a20 2020   a vector of.   
-00021590: 203a 6d61 7468 3a60 6e60 2076 6172 6961   :math:`n` varia
-000215a0: 626c 6573 2061 6e64 203a 6d61 7468 3a60  bles and :math:`
-000215b0: 7060 2061 206e 6f6e 6e65 6761 7469 7665  p` a nonnegative
-000215c0: 2069 6e74 6567 6572 2064 6567 7265 652e   integer degree.
-000215d0: 2054 6865 0a20 2020 2063 6f65 6666 6963   The.    coeffic
-000215e0: 6965 6e74 7320 6172 6520 6173 7375 6d65  ients are assume
-000215f0: 6420 746f 2062 6520 696e 2072 6576 6572  d to be in rever
-00021600: 7365 205b 6c65 7869 636f 6772 6170 6869  se [lexicographi
-00021610: 6320 6f72 6465 725d 3a20 7468 650a 2020  c order]: the.  
-00021620: 2020 636f 6566 6669 6369 656e 7420 666f    coefficient fo
-00021630: 7220 706f 7765 7273 203a 6d61 7468 3a60  r powers :math:`
-00021640: 6a20 e288 8820 e284 a45e 6e60 2063 6f6d  j ... ...^n` com
-00021650: 6573 2062 6566 6f72 6520 7468 6520 636f  es before the co
-00021660: 6566 6669 6369 656e 7420 666f 720a 2020  efficient for.  
-00021670: 2020 706f 7765 7273 203a 6d61 7468 3a60    powers :math:`
-00021680: 6b20 e288 8820 e284 a45e 6e20 2f20 7b6a  k ... ...^n / {j
-00021690: 7d60 2069 6666 203a 6d61 7468 3a60 6a5f  }` iff :math:`j_
-000216a0: 6920 3e20 6b5f 6960 2c20 7768 6572 6520  i > k_i`, where 
-000216b0: 3a6d 6174 683a 6069 203d 0a20 2020 206d  :math:`i =.    m
-000216c0: 6178 5f6c 286a 5f6c 20e2 89a0 206b 5f6c  ax_l(j_l ... k_l
-000216d0: 2960 2c20 7468 6520 696e 6465 7820 6f66  )`, the index of
-000216e0: 2074 6865 202a 6c61 7374 2a20 6e6f 6e2d   the *last* non-
-000216f0: 6d61 7463 6869 6e67 2070 6f77 6572 2e0a  matching power..
-00021700: 0a20 2020 2041 7267 730a 2020 2020 2d2d  .    Args.    --
-00021710: 2d2d 0a20 2020 2063 6f65 6666 7320 3a20  --.    coeffs : 
-00021720: 3a63 6c61 7373 3a60 4172 7261 7960 0a20  :class:`Array`. 
-00021730: 2020 2020 2020 2041 7272 6179 206f 6620         Array of 
-00021740: 636f 6566 6669 6369 656e 7473 2077 6865  coefficients whe
-00021750: 7265 2074 6865 206c 6173 7420 6178 6973  re the last axis
-00021760: 2069 7320 7472 6561 7465 6420 6173 2074   is treated as t
-00021770: 6865 0a20 2020 2020 2020 2063 6f65 6666  he.        coeff
-00021780: 6963 6965 6e74 7320 6178 6573 2e20 416c  icients axes. Al
-00021790: 6c20 7265 6d61 696e 696e 6720 6178 6573  l remaining axes
-000217a0: 2061 7265 2074 7265 6174 6564 2070 6f69   are treated poi
-000217b0: 6e74 7769 7365 2e0a 2020 2020 706f 696e  ntwise..    poin
-000217c0: 7473 203a 203a 636c 6173 733a 6041 7272  ts : :class:`Arr
-000217d0: 6179 600a 2020 2020 2020 2020 4172 7261  ay`.        Arra
-000217e0: 7920 6f66 2076 616c 7565 7320 7768 6572  y of values wher
-000217f0: 6520 7468 6520 6c61 7374 2061 7869 7320  e the last axis 
-00021800: 6973 2074 7265 6174 6564 2061 7320 7468  is treated as th
-00021810: 6520 7661 7269 6162 6c65 7320 6178 6973  e variables axis
-00021820: 2e0a 2020 2020 2020 2020 416c 6c20 7265  ..        All re
-00021830: 6d61 696e 696e 6720 6178 6573 2061 7265  maining axes are
-00021840: 2074 7265 6174 6564 2070 6f69 6e74 7769   treated pointwi
-00021850: 7365 2e0a 2020 2020 2727 270a 0a20 2020  se..    '''..   
-00021860: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00021870: 6c66 2c20 636f 6566 6673 3a20 4172 7261  lf, coeffs: Arra
-00021880: 792c 2070 6f69 6e74 733a 2041 7272 6179  y, points: Array
-00021890: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
-000218a0: 7420 6973 696e 7374 616e 6365 2863 6f65  t isinstance(coe
-000218b0: 6666 732c 2041 7272 6179 2920 616e 6420  ffs, Array) and 
-000218c0: 636f 6566 6673 2e64 7479 7065 203d 3d20  coeffs.dtype == 
-000218d0: 666c 6f61 7420 616e 6420 636f 6566 6673  float and coeffs
-000218e0: 2e6e 6469 6d20 3e3d 2031 2c20 6627 636f  .ndim >= 1, f'co
-000218f0: 6566 6673 3d7b 636f 6566 6673 2172 7d27  effs={coeffs!r}'
-00021900: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00021910: 6973 696e 7374 616e 6365 2870 6f69 6e74  isinstance(point
-00021920: 732c 2041 7272 6179 2920 616e 6420 706f  s, Array) and po
-00021930: 696e 7473 2e64 7479 7065 203d 3d20 666c  ints.dtype == fl
-00021940: 6f61 7420 616e 6420 706f 696e 7473 2e6e  oat and points.n
-00021950: 6469 6d20 3e3d 2031 2061 6e64 2070 6f69  dim >= 1 and poi
-00021960: 6e74 732e 7368 6170 655b 2d31 5d2e 6973  nts.shape[-1].is
-00021970: 636f 6e73 7461 6e74 2c20 6627 706f 696e  constant, f'poin
-00021980: 7473 3d7b 706f 696e 7473 2172 7d27 0a20  ts={points!r}'. 
-00021990: 2020 2020 2020 2073 656c 662e 706f 696e         self.poin
-000219a0: 7473 5f6e 6469 6d20 3d20 696e 7428 706f  ts_ndim = int(po
-000219b0: 696e 7473 2e73 6861 7065 5b2d 315d 290a  ints.shape[-1]).
-000219c0: 2020 2020 2020 2020 7365 6c66 2e63 6f65          self.coe
-000219d0: 6666 7320 3d20 636f 6566 6673 0a20 2020  ffs = coeffs.   
-000219e0: 2020 2020 2073 656c 662e 706f 696e 7473       self.points
-000219f0: 203d 2070 6f69 6e74 730a 2020 2020 2020   = points.      
-00021a00: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
-00021a10: 5f5f 2861 7267 733d 2863 6f65 6666 732c  __(args=(coeffs,
-00021a20: 2070 6f69 6e74 7329 2c20 7368 6170 653d   points), shape=
-00021a30: 706f 696e 7473 2e73 6861 7065 5b3a 2d31  points.shape[:-1
-00021a40: 5d2b 636f 6566 6673 2e73 6861 7065 5b3a  ]+coeffs.shape[:
-00021a50: 2d31 5d2c 2064 7479 7065 3d66 6c6f 6174  -1], dtype=float
-00021a60: 290a 0a20 2020 2065 7661 6c66 203d 2073  )..    evalf = s
-00021a70: 7461 7469 636d 6574 686f 6428 706f 6c79  taticmethod(poly
-00021a80: 2e65 7661 6c5f 6f75 7465 7229 0a0a 2020  .eval_outer)..  
-00021a90: 2020 6465 6620 5f64 6572 6976 6174 6976    def _derivativ
-00021aa0: 6528 7365 6c66 2c20 7661 722c 2073 6565  e(self, var, see
-00021ab0: 6e29 3a0a 2020 2020 2020 2020 6966 2073  n):.        if s
-00021ac0: 656c 662e 6474 7970 6520 3d3d 2063 6f6d  elf.dtype == com
-00021ad0: 706c 6578 3a0a 2020 2020 2020 2020 2020  plex:.          
-00021ae0: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
-00021af0: 6d65 6e74 6564 4572 726f 7228 2754 6865  mentedError('The
-00021b00: 2063 6f6d 706c 6578 2064 6572 6976 6174   complex derivat
-00021b10: 6976 6520 6973 206e 6f74 2069 6d70 6c65  ive is not imple
-00021b20: 6d65 6e74 6564 2e27 290a 2020 2020 2020  mented.').      
-00021b30: 2020 6470 6f69 6e74 7320 3d20 6569 6e73    dpoints = eins
-00021b40: 756d 2827 4142 692c 4169 442d 3e41 4244  um('ABi,AiD->ABD
-00021b50: 272c 2050 6f6c 7976 616c 2850 6f6c 7947  ', Polyval(PolyG
-00021b60: 7261 6428 7365 6c66 2e63 6f65 6666 732c  rad(self.coeffs,
-00021b70: 2073 656c 662e 706f 696e 7473 5f6e 6469   self.points_ndi
-00021b80: 6d29 2c20 7365 6c66 2e70 6f69 6e74 7329  m), self.points)
-00021b90: 2c20 6465 7269 7661 7469 7665 2873 656c  , derivative(sel
-00021ba0: 662e 706f 696e 7473 2c20 7661 722c 2073  f.points, var, s
-00021bb0: 6565 6e29 2c20 413d 7365 6c66 2e70 6f69  een), A=self.poi
-00021bc0: 6e74 732e 6e64 696d 2d31 290a 2020 2020  nts.ndim-1).    
-00021bd0: 2020 2020 6463 6f65 6666 7320 3d20 5472      dcoeffs = Tr
-00021be0: 616e 7370 6f73 652e 6672 6f6d 5f65 6e64  anspose.from_end
-00021bf0: 2850 6f6c 7976 616c 2854 7261 6e73 706f  (Polyval(Transpo
-00021c00: 7365 2e74 6f5f 656e 6428 6465 7269 7661  se.to_end(deriva
-00021c10: 7469 7665 2873 656c 662e 636f 6566 6673  tive(self.coeffs
-00021c20: 2c20 7661 722c 2073 6565 6e29 2c20 2a72  , var, seen), *r
-00021c30: 616e 6765 2873 656c 662e 636f 6566 6673  ange(self.coeffs
-00021c40: 2e6e 6469 6d29 292c 2073 656c 662e 706f  .ndim)), self.po
-00021c50: 696e 7473 292c 202a 7261 6e67 6528 7365  ints), *range(se
-00021c60: 6c66 2e70 6f69 6e74 732e 6e64 696d 2d31  lf.points.ndim-1
-00021c70: 2c20 7365 6c66 2e6e 6469 6d29 290a 2020  , self.ndim)).  
-00021c80: 2020 2020 2020 7265 7475 726e 2064 706f        return dpo
-00021c90: 696e 7473 202b 2064 636f 6566 6673 0a0a  ints + dcoeffs..
-00021ca0: 2020 2020 6465 6620 5f74 616b 6528 7365      def _take(se
-00021cb0: 6c66 2c20 696e 6465 782c 2061 7869 7329  lf, index, axis)
-00021cc0: 3a0a 2020 2020 2020 2020 6966 2061 7869  :.        if axi
-00021cd0: 7320 3c20 7365 6c66 2e70 6f69 6e74 732e  s < self.points.
-00021ce0: 6e64 696d 202d 2031 3a0a 2020 2020 2020  ndim - 1:.      
-00021cf0: 2020 2020 2020 7265 7475 726e 2050 6f6c        return Pol
-00021d00: 7976 616c 2873 656c 662e 636f 6566 6673  yval(self.coeffs
-00021d10: 2c20 5f74 616b 6528 7365 6c66 2e70 6f69  , _take(self.poi
-00021d20: 6e74 732c 2069 6e64 6578 2c20 6178 6973  nts, index, axis
-00021d30: 2929 0a20 2020 2020 2020 2065 6c69 6620  )).        elif 
-00021d40: 6178 6973 203c 2073 656c 662e 6e64 696d  axis < self.ndim
-00021d50: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00021d60: 7475 726e 2050 6f6c 7976 616c 285f 7461  turn Polyval(_ta
-00021d70: 6b65 2873 656c 662e 636f 6566 6673 2c20  ke(self.coeffs, 
-00021d80: 696e 6465 782c 2061 7869 7320 2d20 7365  index, axis - se
-00021d90: 6c66 2e70 6f69 6e74 732e 6e64 696d 202b  lf.points.ndim +
-00021da0: 2031 292c 2073 656c 662e 706f 696e 7473   1), self.points
-00021db0: 290a 0a20 2020 2064 6566 205f 7369 6d70  )..    def _simp
-00021dc0: 6c69 6669 6564 2873 656c 6629 3a0a 2020  lified(self):.  
-00021dd0: 2020 2020 2020 6e63 6f65 6666 735f 6c6f        ncoeffs_lo
-00021de0: 7765 722c 206e 636f 6566 6673 5f75 7070  wer, ncoeffs_upp
-00021df0: 6572 203d 2073 656c 662e 636f 6566 6673  er = self.coeffs
-00021e00: 2e73 6861 7065 5b2d 315d 2e5f 696e 7462  .shape[-1]._intb
-00021e10: 6f75 6e64 730a 2020 2020 2020 2020 6966  ounds.        if
-00021e20: 2069 737a 6572 6f28 7365 6c66 2e63 6f65   iszero(self.coe
-00021e30: 6666 7329 3a0a 2020 2020 2020 2020 2020  ffs):.          
-00021e40: 2020 7265 7475 726e 207a 6572 6f73 5f6c    return zeros_l
-00021e50: 696b 6528 7365 6c66 290a 2020 2020 2020  ike(self).      
-00021e60: 2020 656c 6966 205f 6571 7561 6c73 5f73    elif _equals_s
-00021e70: 6361 6c61 725f 636f 6e73 7461 6e74 2873  calar_constant(s
-00021e80: 656c 662e 636f 6566 6673 2e73 6861 7065  elf.coeffs.shape
-00021e90: 5b2d 315d 2c20 3129 3a0a 2020 2020 2020  [-1], 1):.      
-00021ea0: 2020 2020 2020 7265 7475 726e 2070 7265        return pre
-00021eb0: 7065 6e64 6178 6573 2867 6574 2873 656c  pendaxes(get(sel
-00021ec0: 662e 636f 6566 6673 2c20 2d31 2c20 636f  f.coeffs, -1, co
-00021ed0: 6e73 7461 6e74 2830 2929 2c20 7365 6c66  nstant(0)), self
-00021ee0: 2e70 6f69 6e74 732e 7368 6170 655b 3a2d  .points.shape[:-
-00021ef0: 315d 290a 2020 2020 2020 2020 706f 696e  1]).        poin
-00021f00: 7473 2c20 7768 6572 655f 706f 696e 7473  ts, where_points
-00021f10: 203d 2075 6e61 6c69 676e 2873 656c 662e   = unalign(self.
-00021f20: 706f 696e 7473 2c20 6e61 7865 733d 7365  points, naxes=se
-00021f30: 6c66 2e70 6f69 6e74 732e 6e64 696d 202d  lf.points.ndim -
-00021f40: 2031 290a 2020 2020 2020 2020 636f 6566   1).        coef
-00021f50: 6673 2c20 7768 6572 655f 636f 6566 6673  fs, where_coeffs
-00021f60: 203d 2075 6e61 6c69 676e 2873 656c 662e   = unalign(self.
-00021f70: 636f 6566 6673 2c20 6e61 7865 733d 7365  coeffs, naxes=se
-00021f80: 6c66 2e63 6f65 6666 732e 6e64 696d 202d  lf.coeffs.ndim -
-00021f90: 2031 290a 2020 2020 2020 2020 6966 206c   1).        if l
-00021fa0: 656e 2877 6865 7265 5f70 6f69 6e74 7329  en(where_points)
-00021fb0: 202b 206c 656e 2877 6865 7265 5f63 6f65   + len(where_coe
-00021fc0: 6666 7329 203c 2073 656c 662e 6e64 696d  ffs) < self.ndim
-00021fd0: 3a0a 2020 2020 2020 2020 2020 2020 7768  :.            wh
-00021fe0: 6572 6520 3d20 2a77 6865 7265 5f70 6f69  ere = *where_poi
-00021ff0: 6e74 732c 202a 2861 7869 7320 2b20 7365  nts, *(axis + se
-00022000: 6c66 2e70 6f69 6e74 732e 6e64 696d 202d  lf.points.ndim -
-00022010: 2031 2066 6f72 2061 7869 7320 696e 2077   1 for axis in w
-00022020: 6865 7265 5f63 6f65 6666 7329 0a20 2020  here_coeffs).   
-00022030: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00022040: 616c 6967 6e28 506f 6c79 7661 6c28 636f  align(Polyval(co
-00022050: 6566 6673 2c20 706f 696e 7473 292c 2077  effs, points), w
-00022060: 6865 7265 2c20 7365 6c66 2e73 6861 7065  here, self.shape
-00022070: 290a 0a0a 636c 6173 7320 506f 6c79 4465  )...class PolyDe
-00022080: 6772 6565 2841 7272 6179 293a 0a20 2020  gree(Array):.   
-00022090: 2027 2727 5265 7475 726e 7320 7468 6520   '''Returns the 
-000220a0: 6465 6772 6565 206f 6620 6120 706f 6c79  degree of a poly
-000220b0: 6e6f 6d69 616c 2067 6976 656e 2074 6865  nomial given the
-000220c0: 206e 756d 6265 7220 6f66 2063 6f65 6666   number of coeff
-000220d0: 6963 6965 6e74 7320 616e 6420 6e75 6d62  icients and numb
-000220e0: 6572 206f 6620 7661 7269 6162 6c65 730a  er of variables.
-000220f0: 0a20 2020 2041 7267 730a 2020 2020 2d2d  .    Args.    --
-00022100: 2d2d 0a20 2020 206e 636f 6566 6673 203a  --.    ncoeffs :
-00022110: 203a 636c 6173 733a 6041 7272 6179 600a   :class:`Array`.
-00022120: 2020 2020 2020 2020 5468 6520 6e75 6d62          The numb
-00022130: 6572 206f 6620 636f 6566 6669 6369 656e  er of coefficien
-00022140: 7473 206f 6620 7468 6520 706f 6c79 6e6f  ts of the polyno
-00022150: 6d69 616c 2e0a 2020 2020 6e76 6172 7320  mial..    nvars 
-00022160: 3a20 3a63 6c61 7373 3a60 696e 7460 0a20  : :class:`int`. 
-00022170: 2020 2020 2020 2054 6865 206e 756d 6265         The numbe
-00022180: 7220 6f66 2076 6172 6961 626c 6573 206f  r of variables o
-00022190: 6620 7468 6520 706f 6c79 6e6f 6d69 616c  f the polynomial
-000221a0: 2e0a 0a20 2020 204e 6f74 6573 0a20 2020  ...    Notes.   
-000221b0: 202d 2d2d 2d2d 0a0a 2020 2020 5365 6520   -----..    See 
-000221c0: 3a63 6c61 7373 3a60 506f 6c79 7661 6c60  :class:`Polyval`
-000221d0: 2066 6f72 2061 2064 6566 696e 6974 696f   for a definitio
-000221e0: 6e20 6f66 2074 6865 2070 6f6c 796e 6f6d  n of the polynom
-000221f0: 6961 6c2e 0a20 2020 2027 2727 0a0a 2020  ial..    '''..  
-00022200: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00022210: 656c 662c 206e 636f 6566 6673 3a20 4172  elf, ncoeffs: Ar
-00022220: 7261 792c 206e 7661 7273 3a20 696e 7429  ray, nvars: int)
-00022230: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00022240: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-00022250: 6e63 6528 6e63 6f65 6666 732c 2041 7272  nce(ncoeffs, Arr
-00022260: 6179 2920 616e 6420 6e63 6f65 6666 732e  ay) and ncoeffs.
-00022270: 6e64 696d 203d 3d20 3020 616e 6420 6e63  ndim == 0 and nc
-00022280: 6f65 6666 732e 6474 7970 6520 3d3d 2069  oeffs.dtype == i
-00022290: 6e74 2c20 276e 636f 6566 6673 3d7b 6e63  nt, 'ncoeffs={nc
-000222a0: 6f65 6666 7321 727d 270a 2020 2020 2020  oeffs!r}'.      
-000222b0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-000222c0: 6e63 6528 6e76 6172 732c 2069 6e74 2920  nce(nvars, int) 
-000222d0: 616e 6420 6e76 6172 7320 3e3d 2030 2c20  and nvars >= 0, 
-000222e0: 276e 7661 7273 3d7b 6e76 6172 7321 727d  'nvars={nvars!r}
-000222f0: 270a 2020 2020 2020 2020 7365 6c66 2e6e  '.        self.n
-00022300: 636f 6566 6673 203d 206e 636f 6566 6673  coeffs = ncoeffs
-00022310: 0a20 2020 2020 2020 2073 656c 662e 6e76  .        self.nv
-00022320: 6172 7320 3d20 6e76 6172 730a 2020 2020  ars = nvars.    
-00022330: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-00022340: 6974 5f5f 2861 7267 733d 286e 636f 6566  it__(args=(ncoef
-00022350: 6673 2c29 2c20 7368 6170 653d 2829 2c20  fs,), shape=(), 
-00022360: 6474 7970 653d 696e 7429 0a0a 2020 2020  dtype=int)..    
-00022370: 6465 6620 6576 616c 6628 7365 6c66 2c20  def evalf(self, 
-00022380: 6e63 6f65 6666 7329 3a0a 2020 2020 2020  ncoeffs):.      
-00022390: 2020 7265 7475 726e 206e 756d 7079 2e61    return numpy.a
-000223a0: 7272 6179 2870 6f6c 792e 6465 6772 6565  rray(poly.degree
-000223b0: 2873 656c 662e 6e76 6172 732c 206e 636f  (self.nvars, nco
-000223c0: 6566 6673 2e5f 5f69 6e64 6578 5f5f 2829  effs.__index__()
-000223d0: 2929 0a0a 2020 2020 6465 6620 5f69 6e74  ))..    def _int
-000223e0: 626f 756e 6473 5f69 6d70 6c28 7365 6c66  bounds_impl(self
-000223f0: 293a 0a20 2020 2020 2020 206c 6f77 6572  ):.        lower
-00022400: 2c20 7570 7065 7220 3d20 7365 6c66 2e6e  , upper = self.n
-00022410: 636f 6566 6673 2e5f 696e 7462 6f75 6e64  coeffs._intbound
-00022420: 730a 2020 2020 2020 2020 7472 793a 0a20  s.        try:. 
-00022430: 2020 2020 2020 2020 2020 206c 6f77 6572             lower
-00022440: 203d 2070 6f6c 792e 6465 6772 6565 2873   = poly.degree(s
-00022450: 656c 662e 6e76 6172 732c 206c 6f77 6572  elf.nvars, lower
-00022460: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-00022470: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00022480: 7765 7220 3d20 300a 2020 2020 2020 2020  wer = 0.        
-00022490: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-000224a0: 2075 7070 6572 203d 2070 6f6c 792e 6465   upper = poly.de
-000224b0: 6772 6565 2873 656c 662e 6e76 6172 732c  gree(self.nvars,
-000224c0: 2075 7070 6572 290a 2020 2020 2020 2020   upper).        
-000224d0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-000224e0: 2020 2020 7570 7065 7220 3d20 666c 6f61      upper = floa
-000224f0: 7428 2769 6e66 2729 0a20 2020 2020 2020  t('inf').       
-00022500: 2072 6574 7572 6e20 6c6f 7765 722c 2075   return lower, u
-00022510: 7070 6572 0a0a 0a63 6c61 7373 2050 6f6c  pper...class Pol
-00022520: 794e 436f 6566 6673 2841 7272 6179 293a  yNCoeffs(Array):
-00022530: 0a20 2020 2027 2727 5265 7475 726e 7320  .    '''Returns 
-00022540: 7468 6520 6e75 6d62 6572 206f 6620 636f  the number of co
-00022550: 6566 6669 6369 656e 7473 2066 6f72 2061  efficients for a
-00022560: 2070 6f6c 796e 6f6d 6961 6c20 6f66 2067   polynomial of g
-00022570: 6976 656e 2064 6567 7265 6520 616e 6420  iven degree and 
-00022580: 6e75 6d62 6572 206f 6620 7661 7269 6162  number of variab
-00022590: 6c65 730a 0a20 2020 2041 7267 730a 2020  les..    Args.  
-000225a0: 2020 2d2d 2d2d 0a20 2020 206e 7661 7273    ----.    nvars
-000225b0: 203a 203a 636c 6173 733a 6069 6e74 600a   : :class:`int`.
-000225c0: 2020 2020 2020 2020 5468 6520 6e75 6d62          The numb
-000225d0: 6572 206f 6620 7661 7269 6162 6c65 7320  er of variables 
-000225e0: 6f66 2074 6865 2070 6f6c 796e 6f6d 6961  of the polynomia
-000225f0: 6c2e 0a20 2020 2064 6567 7265 6520 3a20  l..    degree : 
-00022600: 3a63 6c61 7373 3a60 4172 7261 7960 0a20  :class:`Array`. 
-00022610: 2020 2020 2020 2054 6865 2064 6567 7265         The degre
-00022620: 6520 6f66 2074 6865 2070 6f6c 796e 6f6d  e of the polynom
-00022630: 6961 6c2e 0a0a 2020 2020 4e6f 7465 730a  ial...    Notes.
-00022640: 2020 2020 2d2d 2d2d 2d0a 0a20 2020 2053      -----..    S
-00022650: 6565 203a 636c 6173 733a 6050 6f6c 7976  ee :class:`Polyv
-00022660: 616c 6020 666f 7220 6120 6465 6669 6e69  al` for a defini
-00022670: 7469 6f6e 206f 6620 7468 6520 706f 6c79  tion of the poly
-00022680: 6e6f 6d69 616c 2e0a 2020 2020 2727 270a  nomial..    '''.
-00022690: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-000226a0: 5f28 7365 6c66 2c20 6e76 6172 733a 2069  _(self, nvars: i
-000226b0: 6e74 2c20 6465 6772 6565 3a20 4172 7261  nt, degree: Arra
-000226c0: 7929 202d 3e20 4e6f 6e65 3a0a 2020 2020  y) -> None:.    
-000226d0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-000226e0: 7461 6e63 6528 6465 6772 6565 2c20 4172  tance(degree, Ar
-000226f0: 7261 7929 2061 6e64 2064 6567 7265 652e  ray) and degree.
-00022700: 6e64 696d 203d 3d20 3020 616e 6420 6465  ndim == 0 and de
-00022710: 6772 6565 2e64 7479 7065 203d 3d20 696e  gree.dtype == in
-00022720: 742c 2066 2764 6567 7265 653d 7b64 6567  t, f'degree={deg
-00022730: 7265 6521 727d 270a 2020 2020 2020 2020  ree!r}'.        
-00022740: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-00022750: 6528 6e76 6172 732c 2069 6e74 2920 616e  e(nvars, int) an
-00022760: 6420 6e76 6172 7320 3e3d 2030 2c20 276e  d nvars >= 0, 'n
-00022770: 7661 7273 3d7b 6e76 6172 7321 727d 270a  vars={nvars!r}'.
-00022780: 2020 2020 2020 2020 7365 6c66 2e6e 7661          self.nva
-00022790: 7273 203d 206e 7661 7273 0a20 2020 2020  rs = nvars.     
-000227a0: 2020 2073 656c 662e 6465 6772 6565 203d     self.degree =
-000227b0: 2064 6567 7265 650a 2020 2020 2020 2020   degree.        
-000227c0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
-000227d0: 2861 7267 733d 2864 6567 7265 652c 292c  (args=(degree,),
-000227e0: 2073 6861 7065 3d28 292c 2064 7479 7065   shape=(), dtype
-000227f0: 3d69 6e74 290a 0a20 2020 2064 6566 2065  =int)..    def e
-00022800: 7661 6c66 2873 656c 662c 2064 6567 7265  valf(self, degre
-00022810: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
-00022820: 726e 206e 756d 7079 2e61 7272 6179 2870  rn numpy.array(p
-00022830: 6f6c 792e 6e63 6f65 6666 7328 7365 6c66  oly.ncoeffs(self
-00022840: 2e6e 7661 7273 2c20 6465 6772 6565 2e5f  .nvars, degree._
-00022850: 5f69 6e64 6578 5f5f 2829 2929 0a0a 2020  _index__()))..  
-00022860: 2020 6465 6620 5f69 6e74 626f 756e 6473    def _intbounds
-00022870: 5f69 6d70 6c28 7365 6c66 293a 0a20 2020  _impl(self):.   
-00022880: 2020 2020 206c 6f77 6572 2c20 7570 7065       lower, uppe
-00022890: 7220 3d20 7365 6c66 2e64 6567 7265 652e  r = self.degree.
-000228a0: 5f69 6e74 626f 756e 6473 0a20 2020 2020  _intbounds.     
-000228b0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-000228c0: 286c 6f77 6572 2c20 696e 7429 2061 6e64  (lower, int) and
-000228d0: 206c 6f77 6572 203e 3d20 303a 0a20 2020   lower >= 0:.   
-000228e0: 2020 2020 2020 2020 206c 6f77 6572 203d           lower =
-000228f0: 2070 6f6c 792e 6e63 6f65 6666 7328 7365   poly.ncoeffs(se
-00022900: 6c66 2e6e 7661 7273 2c20 6c6f 7765 7229  lf.nvars, lower)
-00022910: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00022920: 2020 2020 2020 2020 2020 206c 6f77 6572             lower
-00022930: 203d 2030 0a20 2020 2020 2020 2069 6620   = 0.        if 
-00022940: 6973 696e 7374 616e 6365 2875 7070 6572  isinstance(upper
-00022950: 2c20 696e 7429 2061 6e64 2075 7070 6572  , int) and upper
-00022960: 203e 3d20 303a 0a20 2020 2020 2020 2020   >= 0:.         
-00022970: 2020 2075 7070 6572 203d 2070 6f6c 792e     upper = poly.
-00022980: 6e63 6f65 6666 7328 7365 6c66 2e6e 7661  ncoeffs(self.nva
-00022990: 7273 2c20 7570 7065 7229 0a20 2020 2020  rs, upper).     
-000229a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000229b0: 2020 2020 2075 7070 6572 203d 2066 6c6f       upper = flo
-000229c0: 6174 2827 696e 6627 290a 2020 2020 2020  at('inf').      
-000229d0: 2020 7265 7475 726e 206c 6f77 6572 2c20    return lower, 
-000229e0: 7570 7065 720a 0a0a 636c 6173 7320 506f  upper...class Po
-000229f0: 6c79 4d75 6c28 4172 7261 7929 3a0a 2020  lyMul(Array):.  
-00022a00: 2020 2727 2743 6f6d 7075 7465 2074 6865    '''Compute the
-00022a10: 2063 6f65 6666 6963 6965 6e74 7320 666f   coefficients fo
-00022a20: 7220 7468 6520 7072 6f64 7563 7420 6f66  r the product of
-00022a30: 2074 776f 2070 6f6c 796e 6f6d 6961 6c73   two polynomials
-00022a40: 0a0a 2020 2020 5265 7475 726e 2074 6865  ..    Return the
-00022a50: 2063 6f65 6666 6963 6965 6e74 7320 7375   coefficients su
-00022a60: 6368 2074 6861 7420 6361 6c6c 696e 6720  ch that calling 
-00022a70: 3a63 6c61 7373 3a60 506f 6c79 7661 6c60  :class:`Polyval`
-00022a80: 206f 6e20 7468 6973 2072 6573 756c 740a   on this result.
-00022a90: 2020 2020 6973 2065 7175 616c 2074 6f20      is equal to 
-00022aa0: 7468 6520 7072 6f64 7563 7420 6f66 203a  the product of :
-00022ab0: 636c 6173 733a 6050 6f6c 7976 616c 6020  class:`Polyval` 
-00022ac0: 6361 6c6c 6564 206f 6e20 7468 6520 696e  called on the in
-00022ad0: 6469 7669 6475 616c 2061 7272 6179 730a  dividual arrays.
-00022ae0: 2020 2020 6f66 2063 6f65 6666 6963 6965      of coefficie
-00022af0: 6e74 7320 2877 6974 6820 7468 6520 6170  nts (with the ap
-00022b00: 7072 6f70 7269 6174 6520 7365 6c65 6374  propriate select
-00022b10: 696f 6e20 6f66 2074 6865 2076 6172 6961  ion of the varia
-00022b20: 626c 6573 2061 730a 2020 2020 6465 7363  bles as.    desc
-00022b30: 7269 6265 6420 6279 2070 6172 616d 6574  ribed by paramet
-00022b40: 6572 2060 6076 6172 7360 6029 2e0a 0a20  er ``vars``)... 
-00022b50: 2020 2041 7267 730a 2020 2020 2d2d 2d2d     Args.    ----
-00022b60: 0a20 2020 2063 6f65 6666 735f 6c65 6674  .    coeffs_left
-00022b70: 203a 203a 636c 6173 733a 6041 7272 6179   : :class:`Array
-00022b80: 600a 2020 2020 2020 2020 5468 6520 636f  `.        The co
-00022b90: 6566 6669 6369 656e 7473 2066 6f72 2074  efficients for t
-00022ba0: 6865 206c 6566 7420 6f70 6572 616e 642e  he left operand.
-00022bb0: 2054 6865 206c 6173 7420 6178 6973 2069   The last axis i
-00022bc0: 7320 7472 6561 7465 6420 6173 2074 6865  s treated as the
-00022bd0: 0a20 2020 2020 2020 2063 6f65 6666 6963  .        coeffic
-00022be0: 6965 6e74 7320 6178 6973 2e0a 2020 2020  ients axis..    
-00022bf0: 636f 6566 6673 5f72 6967 6874 203a 203a  coeffs_right : :
-00022c00: 636c 6173 733a 6041 7272 6179 600a 2020  class:`Array`.  
-00022c10: 2020 2020 2020 5468 6520 636f 6566 6669        The coeffi
-00022c20: 6369 656e 7473 2066 6f72 2074 6865 2072  cients for the r
-00022c30: 6967 6874 206f 7065 7261 6e64 2e20 5468  ight operand. Th
-00022c40: 6520 6c61 7374 2061 7869 7320 6973 2074  e last axis is t
-00022c50: 7265 6174 6564 2061 7320 7468 650a 2020  reated as the.  
-00022c60: 2020 2020 2020 636f 6566 6669 6369 656e        coefficien
-00022c70: 7473 2061 7869 732e 0a20 2020 2076 6172  ts axis..    var
-00022c80: 7320 3a20 3a63 6c61 7373 3a60 7475 706c  s : :class:`tupl
-00022c90: 6560 206f 6620 6060 6e75 7469 6c73 5f70  e` of ``nutils_p
-00022ca0: 6f6c 792e 4d75 6c56 6172 6060 0a20 2020  oly.MulVar``.   
-00022cb0: 2020 2020 2046 6f72 2065 6163 6820 7661       For each va
-00022cc0: 7269 6162 6c65 206f 6620 7468 6973 2070  riable of this p
-00022cd0: 726f 6475 6374 2c20 6060 7661 7260 6020  roduct, ``var`` 
-00022ce0: 6465 6669 6e65 7320 6966 2074 6865 2076  defines if the v
-00022cf0: 6172 6961 626c 650a 2020 2020 2020 2020  ariable.        
-00022d00: 6578 6973 7473 2069 6e20 7468 6520 6c65  exists in the le
-00022d10: 6674 2070 6f6c 796e 6f6d 6961 6c2c 2074  ft polynomial, t
-00022d20: 6865 2072 6967 6874 206f 7220 626f 7468  he right or both
-00022d30: 2e0a 0a20 2020 204e 6f74 6573 0a20 2020  ...    Notes.   
-00022d40: 202d 2d2d 2d2d 0a0a 2020 2020 5365 6520   -----..    See 
-00022d50: 3a63 6c61 7373 3a60 506f 6c79 7661 6c60  :class:`Polyval`
-00022d60: 2066 6f72 2061 2064 6566 696e 6974 696f   for a definitio
-00022d70: 6e20 6f66 2074 6865 2070 6f6c 796e 6f6d  n of the polynom
-00022d80: 6961 6c2e 0a20 2020 2027 2727 0a0a 2020  ial..    '''..  
-00022d90: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00022da0: 656c 662c 2063 6f65 6666 735f 6c65 6674  elf, coeffs_left
-00022db0: 3a20 4172 7261 792c 2063 6f65 6666 735f  : Array, coeffs_
-00022dc0: 7269 6768 743a 2041 7272 6179 2c20 7661  right: Array, va
-00022dd0: 7273 3a20 7479 7069 6e67 2e54 7570 6c65  rs: typing.Tuple
-00022de0: 5b70 6f6c 792e 4d75 6c56 6172 2c20 2e2e  [poly.MulVar, ..
-00022df0: 2e5d 293a 0a20 2020 2020 2020 2061 7373  .]):.        ass
-00022e00: 6572 7420 6973 696e 7374 616e 6365 2863  ert isinstance(c
-00022e10: 6f65 6666 735f 6c65 6674 2c20 4172 7261  oeffs_left, Arra
-00022e20: 7929 2061 6e64 2063 6f65 6666 735f 6c65  y) and coeffs_le
-00022e30: 6674 2e6e 6469 6d20 3e3d 2031 2061 6e64  ft.ndim >= 1 and
-00022e40: 2063 6f65 6666 735f 6c65 6674 2e64 7479   coeffs_left.dty
-00022e50: 7065 203d 3d20 666c 6f61 742c 2066 2763  pe == float, f'c
-00022e60: 6f65 6666 735f 6c65 6674 3d7b 636f 6566  oeffs_left={coef
-00022e70: 6673 5f6c 6566 7421 727d 270a 2020 2020  fs_left!r}'.    
-00022e80: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-00022e90: 7461 6e63 6528 636f 6566 6673 5f72 6967  tance(coeffs_rig
-00022ea0: 6874 2c20 4172 7261 7929 2061 6e64 2063  ht, Array) and c
-00022eb0: 6f65 6666 735f 7269 6768 742e 6e64 696d  oeffs_right.ndim
-00022ec0: 203e 3d20 3120 616e 6420 636f 6566 6673   >= 1 and coeffs
-00022ed0: 5f72 6967 6874 2e64 7479 7065 203d 3d20  _right.dtype == 
-00022ee0: 666c 6f61 742c 2066 2763 6f65 6666 735f  float, f'coeffs_
-00022ef0: 7269 6768 743d 7b63 6f65 6666 735f 7269  right={coeffs_ri
-00022f00: 6768 7421 727d 270a 2020 2020 2020 2020  ght!r}'.        
-00022f10: 6173 7365 7274 2065 7175 616c 7368 6170  assert equalshap
-00022f20: 6528 636f 6566 6673 5f6c 6566 742e 7368  e(coeffs_left.sh
-00022f30: 6170 655b 3a2d 315d 2c20 636f 6566 6673  ape[:-1], coeffs
-00022f40: 5f72 6967 6874 2e73 6861 7065 5b3a 2d31  _right.shape[:-1
-00022f50: 5d29 2c20 2750 6f6c 794d 756c 287b 7d2c  ]), 'PolyMul({},
-00022f60: 207b 7d29 272e 666f 726d 6174 2863 6f65   {})'.format(coe
-00022f70: 6666 735f 6c65 6674 2c20 636f 6566 6673  ffs_left, coeffs
-00022f80: 5f72 6967 6874 290a 2020 2020 2020 2020  _right).        
-00022f90: 7365 6c66 2e63 6f65 6666 735f 6c65 6674  self.coeffs_left
-00022fa0: 203d 2063 6f65 6666 735f 6c65 6674 0a20   = coeffs_left. 
-00022fb0: 2020 2020 2020 2073 656c 662e 636f 6566         self.coef
-00022fc0: 6673 5f72 6967 6874 203d 2063 6f65 6666  fs_right = coeff
-00022fd0: 735f 7269 6768 740a 2020 2020 2020 2020  s_right.        
-00022fe0: 7365 6c66 2e76 6172 7320 3d20 7661 7273  self.vars = vars
-00022ff0: 0a20 2020 2020 2020 2073 656c 662e 6465  .        self.de
-00023000: 6772 6565 5f6c 6566 7420 3d20 506f 6c79  gree_left = Poly
-00023010: 4465 6772 6565 2863 6f65 6666 735f 6c65  Degree(coeffs_le
-00023020: 6674 2e73 6861 7065 5b2d 315d 2c20 6275  ft.shape[-1], bu
-00023030: 696c 7469 6e73 2e73 756d 2876 6172 2021  iltins.sum(var !
-00023040: 3d20 706f 6c79 2e4d 756c 5661 722e 5269  = poly.MulVar.Ri
-00023050: 6768 7420 666f 7220 7661 7220 696e 2076  ght for var in v
-00023060: 6172 7329 290a 2020 2020 2020 2020 7365  ars)).        se
-00023070: 6c66 2e64 6567 7265 655f 7269 6768 7420  lf.degree_right 
-00023080: 3d20 506f 6c79 4465 6772 6565 2863 6f65  = PolyDegree(coe
-00023090: 6666 735f 7269 6768 742e 7368 6170 655b  ffs_right.shape[
-000230a0: 2d31 5d2c 2062 7569 6c74 696e 732e 7375  -1], builtins.su
-000230b0: 6d28 7661 7220 213d 2070 6f6c 792e 4d75  m(var != poly.Mu
-000230c0: 6c56 6172 2e4c 6566 7420 666f 7220 7661  lVar.Left for va
-000230d0: 7220 696e 2076 6172 7329 290a 2020 2020  r in vars)).    
-000230e0: 2020 2020 6e63 6f65 6666 7320 3d20 506f      ncoeffs = Po
-000230f0: 6c79 4e43 6f65 6666 7328 6c65 6e28 7661  lyNCoeffs(len(va
-00023100: 7273 292c 2073 656c 662e 6465 6772 6565  rs), self.degree
-00023110: 5f6c 6566 7420 2b20 7365 6c66 2e64 6567  _left + self.deg
-00023120: 7265 655f 7269 6768 7429 0a20 2020 2020  ree_right).     
-00023130: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
-00023140: 745f 5f28 6172 6773 3d28 636f 6566 6673  t__(args=(coeffs
-00023150: 5f6c 6566 742c 2063 6f65 6666 735f 7269  _left, coeffs_ri
-00023160: 6768 7429 2c20 7368 6170 653d 282a 636f  ght), shape=(*co
-00023170: 6566 6673 5f6c 6566 742e 7368 6170 655b  effs_left.shape[
-00023180: 3a2d 315d 2c20 6e63 6f65 6666 7329 2c20  :-1], ncoeffs), 
-00023190: 6474 7970 653d 666c 6f61 7429 0a0a 2020  dtype=float)..  
-000231a0: 2020 4063 6163 6865 645f 7072 6f70 6572    @cached_proper
-000231b0: 7479 0a20 2020 2064 6566 2065 7661 6c66  ty.    def evalf
-000231c0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000231d0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-000231e0: 2064 6567 7265 655f 6c65 6674 203d 2073   degree_left = s
-000231f0: 656c 662e 6465 6772 6565 5f6c 6566 742e  elf.degree_left.
-00023200: 5f5f 696e 6465 785f 5f28 290a 2020 2020  __index__().    
-00023210: 2020 2020 2020 2020 6465 6772 6565 5f72          degree_r
-00023220: 6967 6874 203d 2073 656c 662e 6465 6772  ight = self.degr
-00023230: 6565 5f72 6967 6874 2e5f 5f69 6e64 6578  ee_right.__index
-00023240: 5f5f 2829 0a20 2020 2020 2020 2065 7863  __().        exc
-00023250: 6570 7420 5479 7065 4572 726f 7220 6173  ept TypeError as
-00023260: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00023270: 7265 7475 726e 2066 756e 6374 6f6f 6c73  return functools
-00023280: 2e70 6172 7469 616c 2870 6f6c 792e 6d75  .partial(poly.mu
-00023290: 6c2c 2076 6172 733d 7365 6c66 2e76 6172  l, vars=self.var
-000232a0: 7329 0a20 2020 2020 2020 2065 6c73 653a  s).        else:
-000232b0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000232c0: 7572 6e20 706f 6c79 2e4d 756c 506c 616e  urn poly.MulPlan
-000232d0: 2873 656c 662e 7661 7273 2c20 6465 6772  (self.vars, degr
-000232e0: 6565 5f6c 6566 742c 2064 6567 7265 655f  ee_left, degree_
-000232f0: 7269 6768 7429 0a0a 2020 2020 6465 6620  right)..    def 
-00023300: 5f73 696d 706c 6966 6965 6428 7365 6c66  _simplified(self
-00023310: 293a 0a20 2020 2020 2020 2069 6620 6973  ):.        if is
-00023320: 7a65 726f 2873 656c 662e 636f 6566 6673  zero(self.coeffs
-00023330: 5f6c 6566 7429 206f 7220 6973 7a65 726f  _left) or iszero
-00023340: 2873 656c 662e 636f 6566 6673 5f72 6967  (self.coeffs_rig
-00023350: 6874 293a 0a20 2020 2020 2020 2020 2020  ht):.           
-00023360: 2072 6574 7572 6e20 7a65 726f 735f 6c69   return zeros_li
-00023370: 6b65 2873 656c 6629 0a0a 2020 2020 6465  ke(self)..    de
-00023380: 6620 5f74 616b 6564 6961 6728 7365 6c66  f _takediag(self
-00023390: 2c20 6178 6973 312c 2061 7869 7332 293a  , axis1, axis2):
-000233a0: 0a20 2020 2020 2020 2069 6620 6178 6973  .        if axis
-000233b0: 3120 3c20 7365 6c66 2e6e 6469 6d20 2d20  1 < self.ndim - 
-000233c0: 3120 616e 6420 6178 6973 3220 3c20 7365  1 and axis2 < se
-000233d0: 6c66 2e6e 6469 6d20 2d20 313a 0a20 2020  lf.ndim - 1:.   
-000233e0: 2020 2020 2020 2020 2063 6f65 6666 735f           coeffs_
-000233f0: 6c65 6674 203d 2054 7261 6e73 706f 7365  left = Transpose
-00023400: 2e74 6f5f 656e 6428 5f74 616b 6564 6961  .to_end(_takedia
-00023410: 6728 7365 6c66 2e63 6f65 6666 735f 6c65  g(self.coeffs_le
-00023420: 6674 2c20 6178 6973 312c 2061 7869 7332  ft, axis1, axis2
-00023430: 292c 202d 3229 0a20 2020 2020 2020 2020  ), -2).         
-00023440: 2020 2063 6f65 6666 735f 7269 6768 7420     coeffs_right 
-00023450: 3d20 5472 616e 7370 6f73 652e 746f 5f65  = Transpose.to_e
-00023460: 6e64 285f 7461 6b65 6469 6167 2873 656c  nd(_takediag(sel
-00023470: 662e 636f 6566 6673 5f72 6967 6874 2c20  f.coeffs_right, 
-00023480: 6178 6973 312c 2061 7869 7332 292c 202d  axis1, axis2), -
-00023490: 3229 0a20 2020 2020 2020 2020 2020 2072  2).            r
-000234a0: 6574 7572 6e20 5472 616e 7370 6f73 652e  eturn Transpose.
-000234b0: 746f 5f65 6e64 2850 6f6c 794d 756c 2863  to_end(PolyMul(c
-000234c0: 6f65 6666 735f 6c65 6674 2c20 636f 6566  oeffs_left, coef
-000234d0: 6673 5f72 6967 6874 2c20 7365 6c66 2e76  fs_right, self.v
-000234e0: 6172 7329 2c20 2d32 290a 0a20 2020 2064  ars), -2)..    d
-000234f0: 6566 205f 7461 6b65 2873 656c 662c 2069  ef _take(self, i
-00023500: 6e64 6578 2c20 6178 6973 293a 0a20 2020  ndex, axis):.   
-00023510: 2020 2020 2069 6620 6178 6973 203c 2073       if axis < s
-00023520: 656c 662e 6e64 696d 202d 2031 3a0a 2020  elf.ndim - 1:.  
-00023530: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00023540: 2050 6f6c 794d 756c 285f 7461 6b65 2873   PolyMul(_take(s
-00023550: 656c 662e 636f 6566 6673 5f6c 6566 742c  elf.coeffs_left,
-00023560: 2069 6e64 6578 2c20 6178 6973 292c 205f   index, axis), _
-00023570: 7461 6b65 2873 656c 662e 636f 6566 6673  take(self.coeffs
-00023580: 5f72 6967 6874 2c20 696e 6465 782c 2061  _right, index, a
-00023590: 7869 7329 2c20 7365 6c66 2e76 6172 7329  xis), self.vars)
-000235a0: 0a0a 2020 2020 6465 6620 5f75 6e72 6176  ..    def _unrav
-000235b0: 656c 2873 656c 662c 2061 7869 732c 2073  el(self, axis, s
-000235c0: 6861 7065 293a 0a20 2020 2020 2020 2069  hape):.        i
-000235d0: 6620 6178 6973 203c 2073 656c 662e 6e64  f axis < self.nd
-000235e0: 696d 202d 2031 3a0a 2020 2020 2020 2020  im - 1:.        
-000235f0: 2020 2020 7265 7475 726e 2050 6f6c 794d      return PolyM
-00023600: 756c 2875 6e72 6176 656c 2873 656c 662e  ul(unravel(self.
-00023610: 636f 6566 6673 5f6c 6566 742c 2061 7869  coeffs_left, axi
-00023620: 732c 2073 6861 7065 292c 2075 6e72 6176  s, shape), unrav
-00023630: 656c 2873 656c 662e 636f 6566 6673 5f72  el(self.coeffs_r
-00023640: 6967 6874 2c20 6178 6973 2c20 7368 6170  ight, axis, shap
-00023650: 6529 2c20 7365 6c66 2e76 6172 7329 0a0a  e), self.vars)..
-00023660: 0a63 6c61 7373 2050 6f6c 7947 7261 6428  .class PolyGrad(
-00023670: 4172 7261 7929 3a0a 2020 2020 2727 2743  Array):.    '''C
-00023680: 6f6d 7075 7465 2074 6865 2063 6f65 6666  ompute the coeff
-00023690: 6963 6965 6e74 7320 666f 7220 7468 6520  icients for the 
-000236a0: 6772 6164 6965 6e74 206f 6620 6120 706f  gradient of a po
-000236b0: 6c79 6e6f 6d69 616c 0a0a 2020 2020 5468  lynomial..    Th
-000236c0: 6520 6c61 7374 2074 776f 2061 7865 7320  e last two axes 
-000236d0: 6f66 2074 6869 7320 6172 7261 7920 6172  of this array ar
-000236e0: 6520 7468 6520 6178 6973 206f 6620 7661  e the axis of va
-000236f0: 7269 6162 6c65 7320 616e 6420 7468 6520  riables and the 
-00023700: 6178 6973 206f 660a 2020 2020 636f 6566  axis of.    coef
-00023710: 6669 6369 656e 7473 2e0a 0a20 2020 2041  ficients...    A
-00023720: 7267 730a 2020 2020 2d2d 2d2d 0a20 2020  rgs.    ----.   
-00023730: 2063 6f65 6666 7320 3a20 3a63 6c61 7373   coeffs : :class
-00023740: 3a60 4172 7261 7960 0a20 2020 2020 2020  :`Array`.       
-00023750: 2054 6865 2063 6f65 6666 6963 6965 6e74   The coefficient
-00023760: 7320 6f66 2074 6865 2070 6f6c 796e 6f6d  s of the polynom
-00023770: 6961 6c20 746f 2063 6f6d 7075 7465 2074  ial to compute t
-00023780: 6865 2067 7261 6469 656e 7420 666f 722e  he gradient for.
-00023790: 2054 6865 0a20 2020 2020 2020 206c 6173   The.        las
-000237a0: 7420 6178 6973 2069 7320 7472 6561 7465  t axis is treate
-000237b0: 6420 6173 2074 6865 2063 6f65 6666 6963  d as the coeffic
-000237c0: 6965 6e74 7320 6178 6973 2e0a 2020 2020  ients axis..    
-000237d0: 6e76 6172 7320 3a20 3a63 6c61 7373 3a60  nvars : :class:`
-000237e0: 696e 7460 0a20 2020 2020 2020 2054 6865  int`.        The
-000237f0: 206e 756d 6265 7220 6f66 2076 6172 6961   number of varia
-00023800: 626c 6573 206f 6620 7468 6520 706f 6c79  bles of the poly
-00023810: 6e6f 6d69 616c 2e0a 0a20 2020 204e 6f74  nomial...    Not
-00023820: 6573 0a20 2020 202d 2d2d 2d2d 0a0a 2020  es.    -----..  
-00023830: 2020 5365 6520 3a63 6c61 7373 3a60 506f    See :class:`Po
-00023840: 6c79 7661 6c60 2066 6f72 2061 2064 6566  lyval` for a def
-00023850: 696e 6974 696f 6e20 6f66 2074 6865 2070  inition of the p
-00023860: 6f6c 796e 6f6d 6961 6c2e 0a20 2020 2027  olynomial..    '
-00023870: 2727 0a0a 2020 2020 6465 6620 5f5f 696e  ''..    def __in
-00023880: 6974 5f5f 2873 656c 662c 2063 6f65 6666  it__(self, coeff
-00023890: 733a 2041 7272 6179 2c20 6e76 6172 733a  s: Array, nvars:
-000238a0: 2069 6e74 293a 0a20 2020 2020 2020 2061   int):.        a
-000238b0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-000238c0: 2863 6f65 6666 732c 2041 7272 6179 2920  (coeffs, Array) 
-000238d0: 616e 6420 636f 6566 6673 2e64 7479 7065  and coeffs.dtype
-000238e0: 203d 3d20 666c 6f61 7420 616e 6420 636f   == float and co
-000238f0: 6566 6673 2e6e 6469 6d20 3e3d 2031 2c20  effs.ndim >= 1, 
-00023900: 6627 636f 6566 6673 3d7b 636f 6566 6673  f'coeffs={coeffs
-00023910: 2172 7d27 0a20 2020 2020 2020 2061 7373  !r}'.        ass
-00023920: 6572 7420 6973 696e 7374 616e 6365 286e  ert isinstance(n
-00023930: 7661 7273 2c20 696e 7429 2061 6e64 206e  vars, int) and n
-00023940: 7661 7273 203e 3d20 302c 2066 276e 7661  vars >= 0, f'nva
-00023950: 7273 3d7b 6e76 6172 7321 727d 270a 2020  rs={nvars!r}'.  
-00023960: 2020 2020 2020 7365 6c66 2e63 6f65 6666        self.coeff
-00023970: 7320 3d20 636f 6566 6673 0a20 2020 2020  s = coeffs.     
-00023980: 2020 2073 656c 662e 6e76 6172 7320 3d20     self.nvars = 
-00023990: 6e76 6172 730a 2020 2020 2020 2020 7365  nvars.        se
-000239a0: 6c66 2e64 6567 7265 6520 3d20 506f 6c79  lf.degree = Poly
-000239b0: 4465 6772 6565 2863 6f65 6666 732e 7368  Degree(coeffs.sh
-000239c0: 6170 655b 2d31 5d2c 206e 7661 7273 290a  ape[-1], nvars).
-000239d0: 2020 2020 2020 2020 6e63 6f65 6666 7320          ncoeffs 
-000239e0: 3d20 506f 6c79 4e43 6f65 6666 7328 6e76  = PolyNCoeffs(nv
-000239f0: 6172 732c 204d 6178 696d 756d 2863 6f6e  ars, Maximum(con
-00023a00: 7374 616e 7428 3029 2c20 7365 6c66 2e64  stant(0), self.d
-00023a10: 6567 7265 6520 2d20 636f 6e73 7461 6e74  egree - constant
-00023a20: 2831 2929 290a 2020 2020 2020 2020 7368  (1))).        sh
-00023a30: 6170 6520 3d20 2a63 6f65 6666 732e 7368  ape = *coeffs.sh
-00023a40: 6170 655b 3a2d 315d 2c20 636f 6e73 7461  ape[:-1], consta
-00023a50: 6e74 286e 7661 7273 292c 206e 636f 6566  nt(nvars), ncoef
-00023a60: 6673 0a20 2020 2020 2020 2073 7570 6572  fs.        super
-00023a70: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
-00023a80: 3d28 636f 6566 6673 2c29 2c20 7368 6170  =(coeffs,), shap
-00023a90: 653d 7368 6170 652c 2064 7479 7065 3d66  e=shape, dtype=f
-00023aa0: 6c6f 6174 290a 0a20 2020 2040 6361 6368  loat)..    @cach
-00023ab0: 6564 5f70 726f 7065 7274 790a 2020 2020  ed_property.    
-00023ac0: 6465 6620 6576 616c 6628 7365 6c66 293a  def evalf(self):
-00023ad0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00023ae0: 2020 2020 2020 2020 2020 6465 6772 6565            degree
-00023af0: 203d 2073 656c 662e 6465 6772 6565 2e5f   = self.degree._
-00023b00: 5f69 6e64 6578 5f5f 2829 0a20 2020 2020  _index__().     
-00023b10: 2020 2065 7863 6570 7420 5479 7065 4572     except TypeEr
-00023b20: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
-00023b30: 2020 2020 2020 7265 7475 726e 2066 756e        return fun
-00023b40: 6374 6f6f 6c73 2e70 6172 7469 616c 2870  ctools.partial(p
-00023b50: 6f6c 792e 6772 6164 2c20 6e76 6172 733d  oly.grad, nvars=
-00023b60: 7365 6c66 2e6e 7661 7273 290a 2020 2020  self.nvars).    
-00023b70: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00023b80: 2020 2020 2020 7265 7475 726e 2070 6f6c        return pol
-00023b90: 792e 4772 6164 506c 616e 2873 656c 662e  y.GradPlan(self.
-00023ba0: 6e76 6172 732c 2064 6567 7265 6529 0a0a  nvars, degree)..
-00023bb0: 2020 2020 6465 6620 5f73 696d 706c 6966      def _simplif
-00023bc0: 6965 6428 7365 6c66 293a 0a20 2020 2020  ied(self):.     
-00023bd0: 2020 2069 6620 6973 7a65 726f 2873 656c     if iszero(sel
-00023be0: 662e 636f 6566 6673 2920 6f72 205f 6571  f.coeffs) or _eq
-00023bf0: 7561 6c73 5f73 6361 6c61 725f 636f 6e73  uals_scalar_cons
-00023c00: 7461 6e74 2873 656c 662e 6465 6772 6565  tant(self.degree
-00023c10: 2c20 3029 3a0a 2020 2020 2020 2020 2020  , 0):.          
-00023c20: 2020 7265 7475 726e 207a 6572 6f73 5f6c    return zeros_l
-00023c30: 696b 6528 7365 6c66 290a 2020 2020 2020  ike(self).      
-00023c40: 2020 656c 6966 205f 6571 7561 6c73 5f73    elif _equals_s
-00023c50: 6361 6c61 725f 636f 6e73 7461 6e74 2873  calar_constant(s
-00023c60: 656c 662e 6465 6772 6565 2c20 3129 3a0a  elf.degree, 1):.
-00023c70: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00023c80: 726e 2049 6e73 6572 7441 7869 7328 5461  rn InsertAxis(Ta
-00023c90: 6b65 2873 656c 662e 636f 6566 6673 2c20  ke(self.coeffs, 
-00023ca0: 636f 6e73 7461 6e74 2873 656c 662e 6e76  constant(self.nv
-00023cb0: 6172 7320 2d20 3129 202d 2052 616e 6765  ars - 1) - Range
-00023cc0: 2863 6f6e 7374 616e 7428 7365 6c66 2e6e  (constant(self.n
-00023cd0: 7661 7273 2929 292c 2063 6f6e 7374 616e  vars))), constan
-00023ce0: 7428 3129 290a 0a20 2020 2064 6566 205f  t(1))..    def _
-00023cf0: 7461 6b65 6469 6167 2873 656c 662c 2061  takediag(self, a
-00023d00: 7869 7331 2c20 6178 6973 3229 3a0a 2020  xis1, axis2):.  
-00023d10: 2020 2020 2020 6966 2061 7869 7331 203c        if axis1 <
-00023d20: 2073 656c 662e 6e64 696d 202d 2032 2061   self.ndim - 2 a
-00023d30: 6e64 2061 7869 7332 203c 2073 656c 662e  nd axis2 < self.
-00023d40: 6e64 696d 202d 2032 3a0a 2020 2020 2020  ndim - 2:.      
-00023d50: 2020 2020 2020 636f 6566 6673 203d 2054        coeffs = T
-00023d60: 7261 6e73 706f 7365 2e74 6f5f 656e 6428  ranspose.to_end(
-00023d70: 5f74 616b 6564 6961 6728 7365 6c66 2e63  _takediag(self.c
-00023d80: 6f65 6666 732c 2061 7869 7331 2c20 6178  oeffs, axis1, ax
-00023d90: 6973 3229 2c20 2d32 290a 2020 2020 2020  is2), -2).      
-00023da0: 2020 2020 2020 7265 7475 726e 2054 7261        return Tra
-00023db0: 6e73 706f 7365 2e66 726f 6d5f 656e 6428  nspose.from_end(
-00023dc0: 506f 6c79 4772 6164 2863 6f65 6666 732c  PolyGrad(coeffs,
-00023dd0: 2073 656c 662e 6e76 6172 7329 2c20 2d33   self.nvars), -3
-00023de0: 2c20 2d32 290a 0a20 2020 2064 6566 205f  , -2)..    def _
-00023df0: 7461 6b65 2873 656c 662c 2069 6e64 6578  take(self, index
-00023e00: 2c20 6178 6973 293a 0a20 2020 2020 2020  , axis):.       
-00023e10: 2069 6620 6178 6973 203c 2073 656c 662e   if axis < self.
-00023e20: 6e64 696d 202d 2032 3a0a 2020 2020 2020  ndim - 2:.      
-00023e30: 2020 2020 2020 7265 7475 726e 2050 6f6c        return Pol
-00023e40: 7947 7261 6428 5f74 616b 6528 7365 6c66  yGrad(_take(self
-00023e50: 2e63 6f65 6666 732c 2069 6e64 6578 2c20  .coeffs, index, 
-00023e60: 6178 6973 292c 2073 656c 662e 6e76 6172  axis), self.nvar
-00023e70: 7329 0a0a 2020 2020 6465 6620 5f75 6e72  s)..    def _unr
-00023e80: 6176 656c 2873 656c 662c 2061 7869 732c  avel(self, axis,
-00023e90: 2073 6861 7065 293a 0a20 2020 2020 2020   shape):.       
-00023ea0: 2069 6620 6178 6973 203c 2073 656c 662e   if axis < self.
-00023eb0: 6e64 696d 202d 2032 3a0a 2020 2020 2020  ndim - 2:.      
-00023ec0: 2020 2020 2020 7265 7475 726e 2050 6f6c        return Pol
-00023ed0: 7947 7261 6428 756e 7261 7665 6c28 7365  yGrad(unravel(se
-00023ee0: 6c66 2e63 6f65 6666 732c 2061 7869 732c  lf.coeffs, axis,
-00023ef0: 2073 6861 7065 292c 2073 656c 662e 6e76   shape), self.nv
-00023f00: 6172 7329 0a0a 0a63 6c61 7373 204c 6567  ars)...class Leg
-00023f10: 656e 6472 6528 4172 7261 7929 3a0a 2020  endre(Array):.  
-00023f20: 2020 2727 2753 6572 6965 7320 6f66 204c    '''Series of L
-00023f30: 6567 656e 6472 6520 706f 6c79 6e6f 6d69  egendre polynomi
-00023f40: 616c 2075 7020 746f 2061 6e64 2069 6e63  al up to and inc
-00023f50: 6c75 6469 6e67 2074 6865 2067 6976 656e  luding the given
-00023f60: 2064 6567 7265 652e 0a0a 2020 2020 5061   degree...    Pa
-00023f70: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-00023f80: 2d2d 2d2d 2d2d 0a20 2020 2078 203a 203a  ------.    x : :
-00023f90: 636c 6173 733a 6041 7272 6179 600a 2020  class:`Array`.  
-00023fa0: 2020 2020 2020 5468 6520 636f 6f72 6469        The coordi
-00023fb0: 6e61 7465 7320 746f 2065 7661 6c75 6174  nates to evaluat
-00023fc0: 6520 7468 6520 7365 7269 6573 2061 742e  e the series at.
-00023fd0: 0a20 2020 2064 6567 7265 6520 3a20 3a63  .    degree : :c
-00023fe0: 6c61 7373 3a60 696e 7460 0a20 2020 2020  lass:`int`.     
-00023ff0: 2020 2054 6865 2064 6567 7265 6520 6f66     The degree of
-00024000: 2074 6865 206c 6173 7420 706f 6c79 6e6f   the last polyno
-00024010: 6d69 616c 206f 6620 7468 6520 7365 7269  mial of the seri
-00024020: 6573 2e0a 2020 2020 2727 270a 0a20 2020  es..    '''..   
-00024030: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00024040: 6c66 2c20 783a 2041 7272 6179 2c20 6465  lf, x: Array, de
-00024050: 6772 6565 3a20 696e 7429 202d 3e20 4e6f  gree: int) -> No
-00024060: 6e65 3a0a 2020 2020 2020 2020 6173 7365  ne:.        asse
-00024070: 7274 2069 7369 6e73 7461 6e63 6528 782c  rt isinstance(x,
-00024080: 2041 7272 6179 2920 616e 6420 782e 6474   Array) and x.dt
-00024090: 7970 6520 3d3d 2066 6c6f 6174 2c20 6627  ype == float, f'
-000240a0: 783d 7b78 2172 7d27 0a20 2020 2020 2020  x={x!r}'.       
-000240b0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-000240c0: 6365 2864 6567 7265 652c 2069 6e74 2920  ce(degree, int) 
-000240d0: 616e 6420 6465 6772 6565 203e 3d20 302c  and degree >= 0,
-000240e0: 2066 2764 6567 7265 653d 7b64 6567 7265   f'degree={degre
-000240f0: 6521 727d 270a 2020 2020 2020 2020 7365  e!r}'.        se
-00024100: 6c66 2e5f 7820 3d20 780a 2020 2020 2020  lf._x = x.      
-00024110: 2020 7365 6c66 2e5f 6465 6772 6565 203d    self._degree =
-00024120: 2064 6567 7265 650a 2020 2020 2020 2020   degree.        
-00024130: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
-00024140: 2861 7267 733d 2878 2c29 2c20 7368 6170  (args=(x,), shap
-00024150: 653d 282a 782e 7368 6170 652c 2063 6f6e  e=(*x.shape, con
-00024160: 7374 616e 7428 6465 6772 6565 2b31 2929  stant(degree+1))
-00024170: 2c20 6474 7970 653d 666c 6f61 7429 0a0a  , dtype=float)..
-00024180: 2020 2020 6465 6620 6576 616c 6628 7365      def evalf(se
-00024190: 6c66 2c20 783a 206e 756d 7079 2e6e 6461  lf, x: numpy.nda
-000241a0: 7272 6179 2920 2d3e 206e 756d 7079 2e6e  rray) -> numpy.n
-000241b0: 6461 7272 6179 3a0a 2020 2020 2020 2020  darray:.        
-000241c0: 5020 3d20 6e75 6d70 792e 656d 7074 7928  P = numpy.empty(
-000241d0: 282a 782e 7368 6170 652c 2073 656c 662e  (*x.shape, self.
-000241e0: 5f64 6567 7265 652b 3129 2c20 6474 7970  _degree+1), dtyp
-000241f0: 653d 666c 6f61 7429 0a20 2020 2020 2020  e=float).       
-00024200: 2050 5b2e 2e2e 2c20 305d 203d 2031 0a20   P[..., 0] = 1. 
-00024210: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-00024220: 6465 6772 6565 3a0a 2020 2020 2020 2020  degree:.        
-00024230: 2020 2020 505b 2e2e 2e2c 2031 5d20 3d20      P[..., 1] = 
-00024240: 780a 2020 2020 2020 2020 666f 7220 6920  x.        for i 
-00024250: 696e 2072 616e 6765 2832 2c20 7365 6c66  in range(2, self
-00024260: 2e5f 6465 6772 6565 2b31 293a 0a20 2020  ._degree+1):.   
-00024270: 2020 2020 2020 2020 2050 5b2e 2e2e 2c20           P[..., 
-00024280: 695d 203d 2028 322d 312f 6929 2a50 5b2e  i] = (2-1/i)*P[.
-00024290: 2e2e 2c20 315d 2a50 5b2e 2e2e 2c20 692d  .., 1]*P[..., i-
-000242a0: 315d 202d 2028 312d 312f 6929 2a50 5b2e  1] - (1-1/i)*P[.
-000242b0: 2e2e 2c20 692d 325d 0a20 2020 2020 2020  .., i-2].       
-000242c0: 2072 6574 7572 6e20 500a 0a20 2020 2064   return P..    d
-000242d0: 6566 205f 6465 7269 7661 7469 7665 2873  ef _derivative(s
-000242e0: 656c 662c 2076 6172 2c20 7365 656e 293a  elf, var, seen):
-000242f0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00024300: 2e64 7479 7065 203d 3d20 636f 6d70 6c65  .dtype == comple
-00024310: 783a 0a20 2020 2020 2020 2020 2020 2072  x:.            r
-00024320: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
-00024330: 7465 6445 7272 6f72 2827 5468 6520 636f  tedError('The co
-00024340: 6d70 6c65 7820 6465 7269 7661 7469 7665  mplex derivative
-00024350: 2069 7320 6e6f 7420 696d 706c 656d 656e   is not implemen
-00024360: 7465 642e 2729 0a20 2020 2020 2020 2064  ted.').        d
-00024370: 203d 206e 756d 7079 2e7a 6572 6f73 2828   = numpy.zeros((
-00024380: 7365 6c66 2e5f 6465 6772 6565 2b31 2c29  self._degree+1,)
-00024390: 2a32 2c20 6474 7970 653d 696e 7429 0a20  *2, dtype=int). 
-000243a0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-000243b0: 7261 6e67 6528 7365 6c66 2e5f 6465 6772  range(self._degr
-000243c0: 6565 2b31 293a 0a20 2020 2020 2020 2020  ee+1):.         
-000243d0: 2020 2064 5b69 2c20 692b 313a 3a32 5d20     d[i, i+1::2] 
-000243e0: 3d20 322a 692b 310a 2020 2020 2020 2020  = 2*i+1.        
-000243f0: 6473 656c 6620 3d20 6569 6e73 756d 2827  dself = einsum('
-00024400: 4169 2c69 6a2d 3e41 6a27 2c20 7365 6c66  Ai,ij->Aj', self
-00024410: 2c20 636f 6e73 7461 6e74 2864 2929 0a20  , constant(d)). 
-00024420: 2020 2020 2020 2072 6574 7572 6e20 6569         return ei
-00024430: 6e73 756d 2827 4169 2c41 422d 3e41 6942  nsum('Ai,AB->AiB
-00024440: 272c 2064 7365 6c66 2c20 6465 7269 7661  ', dself, deriva
-00024450: 7469 7665 2873 656c 662e 5f78 2c20 7661  tive(self._x, va
-00024460: 722c 2073 6565 6e29 290a 0a20 2020 2064  r, seen))..    d
-00024470: 6566 205f 7369 6d70 6c69 6669 6564 2873  ef _simplified(s
-00024480: 656c 6629 3a0a 2020 2020 2020 2020 756e  elf):.        un
-00024490: 616c 6967 6e65 642c 2077 6865 7265 203d  aligned, where =
-000244a0: 2075 6e61 6c69 676e 2873 656c 662e 5f78   unalign(self._x
-000244b0: 290a 2020 2020 2020 2020 6966 2077 6865  ).        if whe
-000244c0: 7265 2021 3d20 7475 706c 6528 7261 6e67  re != tuple(rang
-000244d0: 6528 7365 6c66 2e5f 782e 6e64 696d 2929  e(self._x.ndim))
-000244e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000244f0: 7475 726e 2061 6c69 676e 284c 6567 656e  turn align(Legen
-00024500: 6472 6528 756e 616c 6967 6e65 642c 2073  dre(unaligned, s
-00024510: 656c 662e 5f64 6567 7265 6529 2c20 282a  elf._degree), (*
-00024520: 7768 6572 652c 2073 656c 662e 6e64 696d  where, self.ndim
-00024530: 2d31 292c 2073 656c 662e 7368 6170 6529  -1), self.shape)
-00024540: 0a0a 2020 2020 6465 6620 5f74 616b 6564  ..    def _taked
-00024550: 6961 6728 7365 6c66 2c20 6178 6973 312c  iag(self, axis1,
-00024560: 2061 7869 7332 293a 0a20 2020 2020 2020   axis2):.       
-00024570: 2069 6620 6178 6973 3120 3c20 7365 6c66   if axis1 < self
-00024580: 2e6e 6469 6d20 2d20 3120 616e 6420 6178  .ndim - 1 and ax
-00024590: 6973 3220 3c20 7365 6c66 2e6e 6469 6d20  is2 < self.ndim 
-000245a0: 2d20 313a 0a20 2020 2020 2020 2020 2020  - 1:.           
-000245b0: 2072 6574 7572 6e20 5472 616e 7370 6f73   return Transpos
-000245c0: 652e 746f 5f65 6e64 284c 6567 656e 6472  e.to_end(Legendr
-000245d0: 6528 5f74 616b 6564 6961 6728 7365 6c66  e(_takediag(self
-000245e0: 2e5f 782c 2061 7869 7331 2c20 6178 6973  ._x, axis1, axis
-000245f0: 3229 2c20 7365 6c66 2e5f 6465 6772 6565  2), self._degree
-00024600: 292c 202d 3229 0a0a 2020 2020 6465 6620  ), -2)..    def 
-00024610: 5f74 616b 6528 7365 6c66 2c20 696e 6465  _take(self, inde
-00024620: 782c 2061 7869 7329 3a0a 2020 2020 2020  x, axis):.      
-00024630: 2020 6966 2061 7869 7320 3c20 7365 6c66    if axis < self
-00024640: 2e6e 6469 6d20 2d20 313a 0a20 2020 2020  .ndim - 1:.     
-00024650: 2020 2020 2020 2072 6574 7572 6e20 4c65         return Le
-00024660: 6765 6e64 7265 285f 7461 6b65 2873 656c  gendre(_take(sel
-00024670: 662e 5f78 2c20 696e 6465 782c 2061 7869  f._x, index, axi
-00024680: 7329 2c20 7365 6c66 2e5f 6465 6772 6565  s), self._degree
-00024690: 290a 0a20 2020 2064 6566 205f 756e 7261  )..    def _unra
-000246a0: 7665 6c28 7365 6c66 2c20 6178 6973 2c20  vel(self, axis, 
-000246b0: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
-000246c0: 6966 2061 7869 7320 3c20 7365 6c66 2e6e  if axis < self.n
-000246d0: 6469 6d20 2d20 313a 0a20 2020 2020 2020  dim - 1:.       
-000246e0: 2020 2020 2072 6574 7572 6e20 4c65 6765       return Lege
-000246f0: 6e64 7265 2875 6e72 6176 656c 2873 656c  ndre(unravel(sel
-00024700: 662e 5f78 2c20 6178 6973 2c20 7368 6170  f._x, axis, shap
-00024710: 6529 2c20 7365 6c66 2e5f 6465 6772 6565  e), self._degree
-00024720: 290a 0a0a 636c 6173 7320 4368 6f6f 7365  )...class Choose
-00024730: 2841 7272 6179 293a 0a20 2020 2027 2727  (Array):.    '''
-00024740: 4675 6e63 7469 6f6e 2065 7175 6976 616c  Function equival
-00024750: 656e 7420 6f66 203a 6675 6e63 3a60 6e75  ent of :func:`nu
-00024760: 6d70 792e 6368 6f6f 7365 602e 2727 270a  mpy.choose`.'''.
-00024770: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00024780: 5f28 7365 6c66 2c20 696e 6465 783a 2041  _(self, index: A
-00024790: 7272 6179 2c20 2a63 686f 6963 6573 3a20  rray, *choices: 
-000247a0: 4172 7261 7929 3a0a 2020 2020 2020 2020  Array):.        
-000247b0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-000247c0: 6528 696e 6465 782c 2041 7272 6179 2920  e(index, Array) 
-000247d0: 616e 6420 696e 6465 782e 6474 7970 6520  and index.dtype 
-000247e0: 3d3d 2069 6e74 2c20 6627 696e 6465 783d  == int, f'index=
-000247f0: 7b69 6e64 6578 2172 7d27 0a20 2020 2020  {index!r}'.     
-00024800: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-00024810: 616e 6365 2863 686f 6963 6573 2c20 7475  ance(choices, tu
-00024820: 706c 6529 2061 6e64 2061 6c6c 2869 7369  ple) and all(isi
-00024830: 6e73 7461 6e63 6528 6368 6f69 6365 2c20  nstance(choice, 
-00024840: 4172 7261 7929 2066 6f72 2063 686f 6963  Array) for choic
-00024850: 6520 696e 2063 686f 6963 6573 292c 2066  e in choices), f
-00024860: 2763 686f 6963 6573 3d7b 6368 6f69 6365  'choices={choice
-00024870: 7321 727d 270a 2020 2020 2020 2020 6474  s!r}'.        dt
-00024880: 7970 6520 3d20 6368 6f69 6365 735b 305d  ype = choices[0]
-00024890: 2e64 7479 7065 0a20 2020 2020 2020 2061  .dtype.        a
-000248a0: 7373 6572 7420 616c 6c28 6368 6f69 6365  ssert all(choice
-000248b0: 2e64 7479 7065 203d 3d20 6474 7970 6520  .dtype == dtype 
-000248c0: 666f 7220 6368 6f69 6365 2069 6e20 6368  for choice in ch
-000248d0: 6f69 6365 735b 313a 5d29 0a20 2020 2020  oices[1:]).     
-000248e0: 2020 2073 6861 7065 203d 2069 6e64 6578     shape = index
-000248f0: 2e73 6861 7065 0a20 2020 2020 2020 2061  .shape.        a
-00024900: 7373 6572 7420 616c 6c28 6571 7561 6c73  ssert all(equals
-00024910: 6861 7065 2863 686f 6963 652e 7368 6170  hape(choice.shap
-00024920: 652c 2073 6861 7065 2920 666f 7220 6368  e, shape) for ch
-00024930: 6f69 6365 2069 6e20 6368 6f69 6365 7329  oice in choices)
-00024940: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
-00024950: 6465 7820 3d20 696e 6465 780a 2020 2020  dex = index.    
-00024960: 2020 2020 7365 6c66 2e63 686f 6963 6573      self.choices
-00024970: 203d 2063 686f 6963 6573 0a20 2020 2020   = choices.     
-00024980: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
-00024990: 745f 5f28 6172 6773 3d28 696e 6465 782c  t__(args=(index,
-000249a0: 292b 6368 6f69 6365 732c 2073 6861 7065  )+choices, shape
-000249b0: 3d73 6861 7065 2c20 6474 7970 653d 6474  =shape, dtype=dt
-000249c0: 7970 6529 0a0a 2020 2020 4073 7461 7469  ype)..    @stati
-000249d0: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
-000249e0: 6576 616c 6628 696e 6465 782c 202a 6368  evalf(index, *ch
-000249f0: 6f69 6365 7329 3a0a 2020 2020 2020 2020  oices):.        
-00024a00: 7265 7475 726e 206e 756d 7079 2e63 686f  return numpy.cho
-00024a10: 6f73 6528 696e 6465 782c 2063 686f 6963  ose(index, choic
-00024a20: 6573 290a 0a20 2020 2064 6566 205f 6465  es)..    def _de
-00024a30: 7269 7661 7469 7665 2873 656c 662c 2076  rivative(self, v
-00024a40: 6172 2c20 7365 656e 293a 0a20 2020 2020  ar, seen):.     
-00024a50: 2020 2072 6574 7572 6e20 4368 6f6f 7365     return Choose
-00024a60: 2861 7070 656e 6461 7865 7328 7365 6c66  (appendaxes(self
-00024a70: 2e69 6e64 6578 2c20 7661 722e 7368 6170  .index, var.shap
-00024a80: 6529 2c20 2a28 6465 7269 7661 7469 7665  e), *(derivative
-00024a90: 2863 686f 6963 652c 2076 6172 2c20 7365  (choice, var, se
-00024aa0: 656e 2920 666f 7220 6368 6f69 6365 2069  en) for choice i
-00024ab0: 6e20 7365 6c66 2e63 686f 6963 6573 2929  n self.choices))
-00024ac0: 0a0a 2020 2020 6465 6620 5f73 696d 706c  ..    def _simpl
-00024ad0: 6966 6965 6428 7365 6c66 293a 0a20 2020  ified(self):.   
-00024ae0: 2020 2020 2069 6620 616c 6c28 6368 6f69       if all(choi
-00024af0: 6365 203d 3d20 7365 6c66 2e63 686f 6963  ce == self.choic
-00024b00: 6573 5b30 5d20 666f 7220 6368 6f69 6365  es[0] for choice
-00024b10: 2069 6e20 7365 6c66 2e63 686f 6963 6573   in self.choices
-00024b20: 5b31 3a5d 293a 0a20 2020 2020 2020 2020  [1:]):.         
-00024b30: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
-00024b40: 686f 6963 6573 5b30 5d0a 2020 2020 2020  hoices[0].      
-00024b50: 2020 696e 6465 782c 202a 6368 6f69 6365    index, *choice
-00024b60: 732c 2077 6865 7265 203d 2075 6e61 6c69  s, where = unali
-00024b70: 676e 2873 656c 662e 696e 6465 782c 202a  gn(self.index, *
-00024b80: 7365 6c66 2e63 686f 6963 6573 290a 2020  self.choices).  
-00024b90: 2020 2020 2020 6966 206c 656e 2877 6865        if len(whe
-00024ba0: 7265 2920 3c20 7365 6c66 2e6e 6469 6d3a  re) < self.ndim:
-00024bb0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00024bc0: 7572 6e20 616c 6967 6e28 4368 6f6f 7365  urn align(Choose
-00024bd0: 2869 6e64 6578 2c20 2a63 686f 6963 6573  (index, *choices
-00024be0: 292c 2077 6865 7265 2c20 7365 6c66 2e73  ), where, self.s
-00024bf0: 6861 7065 290a 0a20 2020 2064 6566 205f  hape)..    def _
-00024c00: 6d75 6c74 6970 6c79 2873 656c 662c 206f  multiply(self, o
-00024c10: 7468 6572 293a 0a20 2020 2020 2020 2069  ther):.        i
-00024c20: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
-00024c30: 6572 2c20 4368 6f6f 7365 2920 616e 6420  er, Choose) and 
-00024c40: 7365 6c66 2e69 6e64 6578 203d 3d20 6f74  self.index == ot
-00024c50: 6865 722e 696e 6465 783a 0a20 2020 2020  her.index:.     
-00024c60: 2020 2020 2020 2072 6574 7572 6e20 4368         return Ch
-00024c70: 6f6f 7365 2873 656c 662e 696e 6465 782c  oose(self.index,
-00024c80: 202a 6d61 7028 6d75 6c74 6970 6c79 2c20   *map(multiply, 
-00024c90: 7365 6c66 2e63 686f 6963 6573 2c20 6f74  self.choices, ot
-00024ca0: 6865 722e 6368 6f69 6365 7329 290a 0a20  her.choices)).. 
-00024cb0: 2020 2064 6566 205f 6765 7428 7365 6c66     def _get(self
-00024cc0: 2c20 692c 2069 7465 6d29 3a0a 2020 2020  , i, item):.    
-00024cd0: 2020 2020 7265 7475 726e 2043 686f 6f73      return Choos
-00024ce0: 6528 6765 7428 7365 6c66 2e69 6e64 6578  e(get(self.index
-00024cf0: 2c20 692c 2069 7465 6d29 2c20 2a28 6765  , i, item), *(ge
-00024d00: 7428 6368 6f69 6365 2c20 692c 2069 7465  t(choice, i, ite
-00024d10: 6d29 2066 6f72 2063 686f 6963 6520 696e  m) for choice in
-00024d20: 2073 656c 662e 6368 6f69 6365 7329 290a   self.choices)).
-00024d30: 0a20 2020 2064 6566 205f 7375 6d28 7365  .    def _sum(se
-00024d40: 6c66 2c20 6178 6973 293a 0a20 2020 2020  lf, axis):.     
-00024d50: 2020 2075 6e61 6c69 676e 6564 2c20 7768     unaligned, wh
-00024d60: 6572 6520 3d20 756e 616c 6967 6e28 7365  ere = unalign(se
-00024d70: 6c66 2e69 6e64 6578 290a 2020 2020 2020  lf.index).      
-00024d80: 2020 6966 2061 7869 7320 6e6f 7420 696e    if axis not in
-00024d90: 2077 6865 7265 3a0a 2020 2020 2020 2020   where:.        
-00024da0: 2020 2020 696e 6465 7820 3d20 616c 6967      index = alig
-00024db0: 6e28 756e 616c 6967 6e65 642c 205b 692d  n(unaligned, [i-
-00024dc0: 2869 203e 2061 7869 7329 2066 6f72 2069  (i > axis) for i
-00024dd0: 2069 6e20 7768 6572 655d 2c20 7365 6c66   in where], self
-00024de0: 2e73 6861 7065 5b3a 6178 6973 5d2b 7365  .shape[:axis]+se
-00024df0: 6c66 2e73 6861 7065 5b61 7869 732b 313a  lf.shape[axis+1:
-00024e00: 5d29 0a20 2020 2020 2020 2020 2020 2072  ]).            r
-00024e10: 6574 7572 6e20 4368 6f6f 7365 2869 6e64  eturn Choose(ind
-00024e20: 6578 2c20 2a28 7375 6d28 6368 6f69 6365  ex, *(sum(choice
-00024e30: 2c20 6178 6973 2920 666f 7220 6368 6f69  , axis) for choi
-00024e40: 6365 2069 6e20 7365 6c66 2e63 686f 6963  ce in self.choic
-00024e50: 6573 2929 0a0a 2020 2020 6465 6620 5f74  es))..    def _t
-00024e60: 616b 6528 7365 6c66 2c20 696e 6465 782c  ake(self, index,
-00024e70: 2061 7869 7329 3a0a 2020 2020 2020 2020   axis):.        
-00024e80: 7265 7475 726e 2043 686f 6f73 6528 5f74  return Choose(_t
-00024e90: 616b 6528 7365 6c66 2e69 6e64 6578 2c20  ake(self.index, 
-00024ea0: 696e 6465 782c 2061 7869 7329 2c20 2a28  index, axis), *(
-00024eb0: 5f74 616b 6528 6368 6f69 6365 2c20 696e  _take(choice, in
-00024ec0: 6465 782c 2061 7869 7329 2066 6f72 2063  dex, axis) for c
-00024ed0: 686f 6963 6520 696e 2073 656c 662e 6368  hoice in self.ch
-00024ee0: 6f69 6365 7329 290a 0a20 2020 2064 6566  oices))..    def
-00024ef0: 205f 7461 6b65 6469 6167 2873 656c 662c   _takediag(self,
-00024f00: 2061 7869 732c 2072 6d61 7869 7329 3a0a   axis, rmaxis):.
-00024f10: 2020 2020 2020 2020 7265 7475 726e 2043          return C
-00024f20: 686f 6f73 6528 7461 6b65 6469 6167 2873  hoose(takediag(s
-00024f30: 656c 662e 696e 6465 782c 2061 7869 732c  elf.index, axis,
-00024f40: 2072 6d61 7869 7329 2c20 2a28 7461 6b65   rmaxis), *(take
-00024f50: 6469 6167 2863 686f 6963 652c 2061 7869  diag(choice, axi
-00024f60: 732c 2072 6d61 7869 7329 2066 6f72 2063  s, rmaxis) for c
-00024f70: 686f 6963 6520 696e 2073 656c 662e 6368  hoice in self.ch
-00024f80: 6f69 6365 7329 290a 0a20 2020 2064 6566  oices))..    def
-00024f90: 205f 7072 6f64 7563 7428 7365 6c66 293a   _product(self):
-00024fa0: 0a20 2020 2020 2020 2075 6e61 6c69 676e  .        unalign
-00024fb0: 6564 2c20 7768 6572 6520 3d20 756e 616c  ed, where = unal
-00024fc0: 6967 6e28 7365 6c66 2e69 6e64 6578 290a  ign(self.index).
-00024fd0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00024fe0: 6e64 696d 2d31 206e 6f74 2069 6e20 7768  ndim-1 not in wh
-00024ff0: 6572 653a 0a20 2020 2020 2020 2020 2020  ere:.           
-00025000: 2069 6e64 6578 203d 2061 6c69 676e 2875   index = align(u
-00025010: 6e61 6c69 676e 6564 2c20 7768 6572 652c  naligned, where,
-00025020: 2073 656c 662e 7368 6170 655b 3a2d 315d   self.shape[:-1]
-00025030: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00025040: 7475 726e 2043 686f 6f73 6528 696e 6465  turn Choose(inde
-00025050: 782c 202a 6d61 7028 5072 6f64 7563 742c  x, *map(Product,
-00025060: 2073 656c 662e 6368 6f69 6365 7329 290a   self.choices)).
-00025070: 0a0a 636c 6173 7320 4e6f 726d 4469 6d28  ..class NormDim(
-00025080: 4172 7261 7929 3a0a 0a20 2020 2064 6566  Array):..    def
-00025090: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-000250a0: 6c65 6e67 7468 3a20 4172 7261 792c 2069  length: Array, i
-000250b0: 6e64 6578 3a20 4172 7261 7929 3a0a 2020  ndex: Array):.  
-000250c0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-000250d0: 6e73 7461 6e63 6528 6c65 6e67 7468 2c20  nstance(length, 
-000250e0: 4172 7261 7929 2061 6e64 206c 656e 6774  Array) and lengt
-000250f0: 682e 6474 7970 6520 3d3d 2069 6e74 2c20  h.dtype == int, 
-00025100: 6627 6c65 6e67 7468 3d7b 6c65 6e67 7468  f'length={length
-00025110: 2172 7d27 0a20 2020 2020 2020 2061 7373  !r}'.        ass
-00025120: 6572 7420 6973 696e 7374 616e 6365 2869  ert isinstance(i
-00025130: 6e64 6578 2c20 4172 7261 7929 2061 6e64  ndex, Array) and
-00025140: 2069 6e64 6578 2e64 7479 7065 203d 3d20   index.dtype == 
-00025150: 696e 742c 2066 2769 6e64 6578 3d7b 696e  int, f'index={in
-00025160: 6465 7821 727d 270a 2020 2020 2020 2020  dex!r}'.        
-00025170: 6173 7365 7274 2065 7175 616c 7368 6170  assert equalshap
-00025180: 6528 6c65 6e67 7468 2e73 6861 7065 2c20  e(length.shape, 
-00025190: 696e 6465 782e 7368 6170 6529 0a20 2020  index.shape).   
-000251a0: 2020 2020 2023 2054 6865 2066 6f6c 6c6f       # The follo
-000251b0: 7769 6e67 2063 6f72 6e65 7220 6361 7365  wing corner case
-000251c0: 7320 6d61 6b65 7320 7468 6520 6173 7365  s makes the asse
-000251d0: 7274 696f 6e20 6661 696c 2c20 6865 6e63  rtion fail, henc
-000251e0: 6520 7765 2063 616e 206f 6e6c 790a 2020  e we can only.  
-000251f0: 2020 2020 2020 2320 6173 7365 7274 2074        # assert t
-00025200: 6865 2062 6f75 6e64 7320 6966 2074 6865  he bounds if the
-00025210: 2061 7272 6179 7320 6172 6520 6775 6172   arrays are guar
-00025220: 616e 7465 6564 2074 6f20 6265 2075 6e65  anteed to be une
-00025230: 6d70 7479 3a0a 2020 2020 2020 2020 230a  mpty:.        #.
-00025240: 2020 2020 2020 2020 2320 2020 2020 5461          #     Ta
-00025250: 6b65 2866 756e 632c 204e 6f72 6d44 696d  ke(func, NormDim
-00025260: 2866 756e 632e 7368 6170 655b 2d31 5d2c  (func.shape[-1],
-00025270: 2052 616e 6765 2830 2920 2b20 6675 6e63   Range(0) + func
-00025280: 2e73 6861 7065 5b2d 315d 2929 0a20 2020  .shape[-1])).   
-00025290: 2020 2020 2069 6620 616c 6c28 6e2e 5f69       if all(n._i
-000252a0: 6e74 626f 756e 6473 5b30 5d20 3e20 3020  ntbounds[0] > 0 
-000252b0: 666f 7220 6e20 696e 2069 6e64 6578 2e73  for n in index.s
-000252c0: 6861 7065 293a 0a20 2020 2020 2020 2020  hape):.         
-000252d0: 2020 2061 7373 6572 7420 2d6c 656e 6774     assert -lengt
-000252e0: 682e 5f69 6e74 626f 756e 6473 5b31 5d20  h._intbounds[1] 
-000252f0: 3c3d 2069 6e64 6578 2e5f 696e 7462 6f75  <= index._intbou
-00025300: 6e64 735b 305d 2061 6e64 2069 6e64 6578  nds[0] and index
-00025310: 2e5f 696e 7462 6f75 6e64 735b 315d 203c  ._intbounds[1] <
-00025320: 3d20 6c65 6e67 7468 2e5f 696e 7462 6f75  = length._intbou
-00025330: 6e64 735b 315d 202d 2031 0a20 2020 2020  nds[1] - 1.     
-00025340: 2020 2073 656c 662e 6c65 6e67 7468 203d     self.length =
-00025350: 206c 656e 6774 680a 2020 2020 2020 2020   length.        
-00025360: 7365 6c66 2e69 6e64 6578 203d 2069 6e64  self.index = ind
-00025370: 6578 0a20 2020 2020 2020 2073 7570 6572  ex.        super
-00025380: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
-00025390: 3d28 6c65 6e67 7468 2c20 696e 6465 7829  =(length, index)
-000253a0: 2c20 7368 6170 653d 696e 6465 782e 7368  , shape=index.sh
-000253b0: 6170 652c 2064 7479 7065 3d69 6e64 6578  ape, dtype=index
-000253c0: 2e64 7479 7065 290a 0a20 2020 2040 7374  .dtype)..    @st
-000253d0: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-000253e0: 6566 2065 7661 6c66 286c 656e 6774 682c  ef evalf(length,
-000253f0: 2069 6e64 6578 293a 0a20 2020 2020 2020   index):.       
-00025400: 2061 7373 6572 7420 6c65 6e67 7468 2e73   assert length.s
-00025410: 6861 7065 203d 3d20 696e 6465 782e 7368  hape == index.sh
-00025420: 6170 650a 2020 2020 2020 2020 6173 7365  ape.        asse
-00025430: 7274 206c 656e 6774 682e 6474 7970 652e  rt length.dtype.
-00025440: 6b69 6e64 203d 3d20 2769 270a 2020 2020  kind == 'i'.    
-00025450: 2020 2020 6173 7365 7274 2069 6e64 6578      assert index
-00025460: 2e64 7479 7065 2e6b 696e 6420 3d3d 2027  .dtype.kind == '
-00025470: 6927 0a20 2020 2020 2020 2072 6573 756c  i'.        resul
-00025480: 7420 3d20 6e75 6d70 792e 656d 7074 7928  t = numpy.empty(
-00025490: 696e 6465 782e 7368 6170 652c 2064 7479  index.shape, dty
-000254a0: 7065 3d69 6e74 290a 2020 2020 2020 2020  pe=int).        
-000254b0: 666f 7220 6920 696e 206e 756d 7079 2e6e  for i in numpy.n
-000254c0: 6469 6e64 6578 2869 6e64 6578 2e73 6861  dindex(index.sha
-000254d0: 7065 293a 0a20 2020 2020 2020 2020 2020  pe):.           
-000254e0: 2072 6573 756c 745b 695d 203d 206e 756d   result[i] = num
-000254f0: 6572 6963 2e6e 6f72 6d64 696d 286c 656e  eric.normdim(len
-00025500: 6774 685b 695d 2c20 696e 6465 785b 695d  gth[i], index[i]
-00025510: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00025520: 2072 6573 756c 740a 0a20 2020 2064 6566   result..    def
-00025530: 205f 7369 6d70 6c69 6669 6564 2873 656c   _simplified(sel
-00025540: 6629 3a0a 2020 2020 2020 2020 6c6f 7765  f):.        lowe
-00025550: 725f 6c65 6e67 7468 2c20 7570 7065 725f  r_length, upper_
-00025560: 6c65 6e67 7468 203d 2073 656c 662e 6c65  length = self.le
-00025570: 6e67 7468 2e5f 696e 7462 6f75 6e64 730a  ngth._intbounds.
-00025580: 2020 2020 2020 2020 6c6f 7765 725f 696e          lower_in
-00025590: 6465 782c 2075 7070 6572 5f69 6e64 6578  dex, upper_index
-000255a0: 203d 2073 656c 662e 696e 6465 782e 5f69   = self.index._i
-000255b0: 6e74 626f 756e 6473 0a20 2020 2020 2020  ntbounds.       
-000255c0: 2069 6620 3020 3c3d 206c 6f77 6572 5f69   if 0 <= lower_i
-000255d0: 6e64 6578 2061 6e64 2075 7070 6572 5f69  ndex and upper_i
-000255e0: 6e64 6578 203c 206c 6f77 6572 5f6c 656e  ndex < lower_len
-000255f0: 6774 683a 0a20 2020 2020 2020 2020 2020  gth:.           
-00025600: 2072 6574 7572 6e20 7365 6c66 2e69 6e64   return self.ind
-00025610: 6578 0a20 2020 2020 2020 2069 6620 6973  ex.        if is
-00025620: 696e 7374 616e 6365 286c 6f77 6572 5f6c  instance(lower_l
-00025630: 656e 6774 682c 2069 6e74 2920 616e 6420  ength, int) and 
-00025640: 6c6f 7765 725f 6c65 6e67 7468 203d 3d20  lower_length == 
-00025650: 7570 7065 725f 6c65 6e67 7468 2061 6e64  upper_length and
-00025660: 202d 6c6f 7765 725f 6c65 6e67 7468 203c   -lower_length <
-00025670: 3d20 6c6f 7765 725f 696e 6465 7820 616e  = lower_index an
-00025680: 6420 7570 7065 725f 696e 6465 7820 3c20  d upper_index < 
-00025690: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
-000256a0: 6574 7572 6e20 7365 6c66 2e69 6e64 6578  eturn self.index
-000256b0: 202b 206c 6f77 6572 5f6c 656e 6774 680a   + lower_length.
-000256c0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000256d0: 6c65 6e67 7468 2e69 7363 6f6e 7374 616e  length.isconstan
-000256e0: 7420 616e 6420 7365 6c66 2e69 6e64 6578  t and self.index
-000256f0: 2e69 7363 6f6e 7374 616e 743a 0a20 2020  .isconstant:.   
-00025700: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00025710: 636f 6e73 7461 6e74 2873 656c 662e 6576  constant(self.ev
-00025720: 616c 2829 290a 0a20 2020 2064 6566 205f  al())..    def _
-00025730: 696e 7462 6f75 6e64 735f 696d 706c 2873  intbounds_impl(s
-00025740: 656c 6629 3a0a 2020 2020 2020 2020 6c6f  elf):.        lo
-00025750: 7765 725f 6c65 6e67 7468 2c20 7570 7065  wer_length, uppe
-00025760: 725f 6c65 6e67 7468 203d 2073 656c 662e  r_length = self.
-00025770: 6c65 6e67 7468 2e5f 696e 7462 6f75 6e64  length._intbound
-00025780: 730a 2020 2020 2020 2020 6c6f 7765 725f  s.        lower_
-00025790: 696e 6465 782c 2075 7070 6572 5f69 6e64  index, upper_ind
-000257a0: 6578 203d 2073 656c 662e 696e 6465 782e  ex = self.index.
-000257b0: 5f69 6e74 626f 756e 6473 0a20 2020 2020  _intbounds.     
-000257c0: 2020 2069 6620 6c6f 7765 725f 696e 6465     if lower_inde
-000257d0: 7820 3e3d 2030 3a0a 2020 2020 2020 2020  x >= 0:.        
-000257e0: 2020 2020 7265 7475 726e 206d 696e 286c      return min(l
-000257f0: 6f77 6572 5f69 6e64 6578 2c20 7570 7065  ower_index, uppe
-00025800: 725f 6c65 6e67 7468 202d 2031 292c 206d  r_length - 1), m
-00025810: 696e 2875 7070 6572 5f69 6e64 6578 2c20  in(upper_index, 
-00025820: 7570 7065 725f 6c65 6e67 7468 202d 2031  upper_length - 1
-00025830: 290a 2020 2020 2020 2020 656c 6966 2075  ).        elif u
-00025840: 7070 6572 5f69 6e64 6578 203c 2030 2061  pper_index < 0 a
-00025850: 6e64 2069 7369 6e73 7461 6e63 6528 6c6f  nd isinstance(lo
-00025860: 7765 725f 6c65 6e67 7468 2c20 696e 7429  wer_length, int)
-00025870: 2061 6e64 206c 6f77 6572 5f6c 656e 6774   and lower_lengt
-00025880: 6820 3d3d 2075 7070 6572 5f6c 656e 6774  h == upper_lengt
-00025890: 683a 0a20 2020 2020 2020 2020 2020 2072  h:.            r
-000258a0: 6574 7572 6e20 6d61 7828 6c6f 7765 725f  eturn max(lower_
-000258b0: 696e 6465 7820 2b20 6c6f 7765 725f 6c65  index + lower_le
-000258c0: 6e67 7468 2c20 3029 2c20 6d61 7828 7570  ngth, 0), max(up
-000258d0: 7065 725f 696e 6465 7820 2b20 6c6f 7765  per_index + lowe
-000258e0: 725f 6c65 6e67 7468 2c20 3029 0a20 2020  r_length, 0).   
-000258f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00025900: 2020 2020 2020 2072 6574 7572 6e20 302c         return 0,
-00025910: 2075 7070 6572 5f6c 656e 6774 6820 2d20   upper_length - 
-00025920: 310a 0a0a 636c 6173 7320 5472 616e 7366  1...class Transf
-00025930: 6f72 6d43 6f6f 7264 7328 4172 7261 7929  ormCoords(Array)
-00025940: 3a0a 2020 2020 2727 2754 7261 6e73 666f  :.    '''Transfo
-00025950: 726d 2063 6f6f 7264 696e 6174 6573 2066  rm coordinates f
-00025960: 726f 6d20 6f6e 6520 636f 6f72 6469 6e61  rom one coordina
-00025970: 7465 2073 7973 7465 6d20 746f 2061 6e6f  te system to ano
-00025980: 7468 6572 2028 7370 6174 6961 6c20 7061  ther (spatial pa
-00025990: 7274 290a 0a20 2020 2041 7267 730a 2020  rt)..    Args.  
-000259a0: 2020 2d2d 2d2d 0a20 2020 2074 6172 6765    ----.    targe
-000259b0: 7420 3a20 3a63 6c61 7373 3a60 6e75 7469  t : :class:`nuti
-000259c0: 6c73 2e74 7261 6e73 666f 726d 7365 712e  ls.transformseq.
-000259d0: 5472 616e 7366 6f72 6d73 602c 206f 7074  Transforms`, opt
-000259e0: 696f 6e61 6c0a 2020 2020 2020 2020 5468  ional.        Th
-000259f0: 6520 7461 7267 6574 2063 6f6f 7264 696e  e target coordin
-00025a00: 6174 6520 7379 7374 656d 2e20 4966 2060  ate system. If `
-00025a10: 4e6f 6e65 6020 7468 6520 7461 7267 6574  None` the target
-00025a20: 2069 7320 726f 6f74 2063 6f6f 7264 696e   is root coordin
-00025a30: 6174 650a 2020 2020 2020 2020 7379 7374  ate.        syst
-00025a40: 656d 2e0a 2020 2020 736f 7572 6365 203a  em..    source :
-00025a50: 203a 636c 6173 733a 606e 7574 696c 732e   :class:`nutils.
-00025a60: 7472 616e 7366 6f72 6d73 6571 2e54 7261  transformseq.Tra
-00025a70: 6e73 666f 726d 7360 0a20 2020 2020 2020  nsforms`.       
-00025a80: 2054 6865 2073 6f75 7263 6520 636f 6f72   The source coor
-00025a90: 6469 6e61 7465 2073 7973 7465 6d2e 0a20  dinate system.. 
-00025aa0: 2020 2069 6e64 6578 203a 2073 6361 6c61     index : scala
-00025ab0: 722c 2069 6e74 6567 6572 203a 636c 6173  r, integer :clas
-00025ac0: 733a 6041 7272 6179 600a 2020 2020 2020  s:`Array`.      
-00025ad0: 2020 5468 6520 696e 6465 7820 7061 7274    The index part
-00025ae0: 206f 6620 7468 6520 736f 7572 6365 2063   of the source c
-00025af0: 6f6f 7264 696e 6174 6573 2e0a 2020 2020  oordinates..    
-00025b00: 636f 6f72 6473 203a 203a 636c 6173 733a  coords : :class:
-00025b10: 6041 7272 6179 600a 2020 2020 2020 2020  `Array`.        
-00025b20: 5468 6520 7370 6174 6961 6c20 7061 7274  The spatial part
-00025b30: 206f 6620 7468 6520 736f 7572 6365 2063   of the source c
-00025b40: 6f6f 7264 696e 6174 6573 2e0a 2020 2020  oordinates..    
-00025b50: 2727 270a 0a20 2020 2064 6566 205f 5f69  '''..    def __i
-00025b60: 6e69 745f 5f28 7365 6c66 2c20 7461 7267  nit__(self, targ
-00025b70: 6574 2c20 736f 7572 6365 2c20 696e 6465  et, source, inde
-00025b80: 783a 2041 7272 6179 2c20 636f 6f72 6473  x: Array, coords
-00025b90: 3a20 4172 7261 7929 3a0a 2020 2020 2020  : Array):.      
-00025ba0: 2020 6966 2069 6e64 6578 2e64 7479 7065    if index.dtype
-00025bb0: 2021 3d20 696e 7420 6f72 2069 6e64 6578   != int or index
-00025bc0: 2e6e 6469 6d20 213d 2030 3a0a 2020 2020  .ndim != 0:.    
-00025bd0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00025be0: 6c75 6545 7272 6f72 2827 6172 6775 6d65  lueError('argume
-00025bf0: 6e74 2060 696e 6465 7860 206d 7573 7420  nt `index` must 
-00025c00: 6265 2061 2073 6361 6c61 722c 2069 6e74  be a scalar, int
-00025c10: 6567 6572 2060 6e75 7469 6c73 2e65 7661  eger `nutils.eva
-00025c20: 6c75 6162 6c65 2e41 7272 6179 6027 290a  luable.Array`').
-00025c30: 2020 2020 2020 2020 6966 2063 6f6f 7264          if coord
-00025c40: 732e 6474 7970 6520 213d 2066 6c6f 6174  s.dtype != float
-00025c50: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00025c60: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
-00025c70: 6172 6775 6d65 6e74 2060 636f 6f72 6473  argument `coords
-00025c80: 6020 6d75 7374 2062 6520 6120 7265 616c  ` must be a real
-00025c90: 2d76 616c 7565 6420 6172 7261 7920 7769  -valued array wi
-00025ca0: 7468 2061 7420 6c65 6173 7420 6f6e 6520  th at least one 
-00025cb0: 6178 6973 2729 0a20 2020 2020 2020 2073  axis').        s
-00025cc0: 656c 662e 5f74 6172 6765 7420 3d20 7461  elf._target = ta
-00025cd0: 7267 6574 0a20 2020 2020 2020 2073 656c  rget.        sel
-00025ce0: 662e 5f73 6f75 7263 6520 3d20 736f 7572  f._source = sour
-00025cf0: 6365 0a20 2020 2020 2020 2073 656c 662e  ce.        self.
-00025d00: 5f69 6e64 6578 203d 2069 6e64 6578 0a20  _index = index. 
-00025d10: 2020 2020 2020 2073 656c 662e 5f63 6f6f         self._coo
-00025d20: 7264 7320 3d20 636f 6f72 6473 0a20 2020  rds = coords.   
-00025d30: 2020 2020 2074 6172 6765 745f 6469 6d20       target_dim 
-00025d40: 3d20 736f 7572 6365 2e74 6f64 696d 7320  = source.todims 
-00025d50: 6966 2074 6172 6765 7420 6973 204e 6f6e  if target is Non
-00025d60: 6520 656c 7365 2074 6172 6765 742e 6672  e else target.fr
-00025d70: 6f6d 6469 6d73 0a20 2020 2020 2020 2073  omdims.        s
-00025d80: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
-00025d90: 6172 6773 3d28 696e 6465 782c 2063 6f6f  args=(index, coo
-00025da0: 7264 7329 2c20 7368 6170 653d 282a 636f  rds), shape=(*co
-00025db0: 6f72 6473 2e73 6861 7065 5b3a 2d31 5d2c  ords.shape[:-1],
-00025dc0: 2063 6f6e 7374 616e 7428 7461 7267 6574   constant(target
-00025dd0: 5f64 696d 2929 2c20 6474 7970 653d 666c  _dim)), dtype=fl
-00025de0: 6f61 7429 0a0a 2020 2020 6465 6620 6576  oat)..    def ev
-00025df0: 616c 6628 7365 6c66 2c20 696e 6465 782c  alf(self, index,
-00025e00: 2063 6f6f 7264 7329 3a0a 2020 2020 2020   coords):.      
-00025e10: 2020 6368 6169 6e20 3d20 7365 6c66 2e5f    chain = self._
-00025e20: 736f 7572 6365 5b69 6e64 6578 2e5f 5f69  source[index.__i
-00025e30: 6e64 6578 5f5f 2829 5d0a 2020 2020 2020  ndex__()].      
-00025e40: 2020 6966 2073 656c 662e 5f74 6172 6765    if self._targe
-00025e50: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
-00025e60: 2020 2020 2020 2020 2020 205f 2c20 6368             _, ch
-00025e70: 6169 6e20 3d20 7365 6c66 2e5f 7461 7267  ain = self._targ
-00025e80: 6574 2e69 6e64 6578 5f77 6974 685f 7461  et.index_with_ta
-00025e90: 696c 2863 6861 696e 290a 2020 2020 2020  il(chain).      
-00025ea0: 2020 7265 7475 726e 2066 756e 6374 6f6f    return functoo
-00025eb0: 6c73 2e72 6564 7563 6528 6c61 6d62 6461  ls.reduce(lambda
-00025ec0: 2063 2c20 743a 2074 2e61 7070 6c79 2863   c, t: t.apply(c
-00025ed0: 292c 2072 6576 6572 7365 6428 6368 6169  ), reversed(chai
-00025ee0: 6e29 2c20 636f 6f72 6473 290a 0a20 2020  n), coords)..   
-00025ef0: 2064 6566 205f 6465 7269 7661 7469 7665   def _derivative
-00025f00: 2873 656c 662c 2076 6172 2c20 7365 656e  (self, var, seen
-00025f10: 293a 0a20 2020 2020 2020 206c 696e 6561  ):.        linea
-00025f20: 7220 3d20 5472 616e 7366 6f72 6d4c 696e  r = TransformLin
-00025f30: 6561 7228 7365 6c66 2e5f 7461 7267 6574  ear(self._target
-00025f40: 2c20 7365 6c66 2e5f 736f 7572 6365 2c20  , self._source, 
-00025f50: 7365 6c66 2e5f 696e 6465 7829 0a20 2020  self._index).   
-00025f60: 2020 2020 2064 636f 6f72 6473 203d 2064       dcoords = d
-00025f70: 6572 6976 6174 6976 6528 7365 6c66 2e5f  erivative(self._
-00025f80: 636f 6f72 6473 2c20 7661 722c 2073 6565  coords, var, see
-00025f90: 6e29 0a20 2020 2020 2020 2072 6574 7572  n).        retur
-00025fa0: 6e20 6569 6e73 756d 2827 696a 2c41 6a42  n einsum('ij,AjB
-00025fb0: 2d3e 4169 4227 2c20 6c69 6e65 6172 2c20  ->AiB', linear, 
-00025fc0: 6463 6f6f 7264 732c 2041 3d73 656c 662e  dcoords, A=self.
-00025fd0: 5f63 6f6f 7264 732e 6e64 696d 202d 2031  _coords.ndim - 1
-00025fe0: 2c20 423d 7661 722e 6e64 696d 290a 0a20  , B=var.ndim).. 
-00025ff0: 2020 2064 6566 205f 7369 6d70 6c69 6669     def _simplifi
-00026000: 6564 2873 656c 6629 3a0a 2020 2020 2020  ed(self):.      
-00026010: 2020 6966 2073 656c 662e 5f74 6172 6765    if self._targe
-00026020: 7420 3d3d 2073 656c 662e 5f73 6f75 7263  t == self._sourc
-00026030: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00026040: 6574 7572 6e20 7365 6c66 2e5f 636f 6f72  eturn self._coor
-00026050: 6473 0a20 2020 2020 2020 2063 6178 203d  ds.        cax =
-00026060: 2073 656c 662e 6e64 696d 202d 2031 0a20   self.ndim - 1. 
-00026070: 2020 2020 2020 2063 6f6f 7264 732c 2077         coords, w
-00026080: 6865 7265 203d 2075 6e61 6c69 676e 2873  here = unalign(s
-00026090: 656c 662e 5f63 6f6f 7264 732c 206e 6178  elf._coords, nax
-000260a0: 6573 3d63 6178 290a 2020 2020 2020 2020  es=cax).        
-000260b0: 6966 206c 656e 2877 6865 7265 2920 3c20  if len(where) < 
-000260c0: 6361 783a 0a20 2020 2020 2020 2020 2020  cax:.           
-000260d0: 2072 6574 7572 6e20 616c 6967 6e28 5472   return align(Tr
-000260e0: 616e 7366 6f72 6d43 6f6f 7264 7328 7365  ansformCoords(se
-000260f0: 6c66 2e5f 7461 7267 6574 2c20 7365 6c66  lf._target, self
-00026100: 2e5f 736f 7572 6365 2c20 7365 6c66 2e5f  ._source, self._
-00026110: 696e 6465 782c 2063 6f6f 7264 7329 2c20  index, coords), 
-00026120: 282a 7768 6572 652c 2063 6178 292c 2073  (*where, cax), s
-00026130: 656c 662e 7368 6170 6529 0a0a 0a63 6c61  elf.shape)...cla
-00026140: 7373 2054 7261 6e73 666f 726d 496e 6465  ss TransformInde
-00026150: 7828 4172 7261 7929 3a0a 2020 2020 2727  x(Array):.    ''
-00026160: 2754 7261 6e73 666f 726d 2063 6f6f 7264  'Transform coord
-00026170: 696e 6174 6573 2066 726f 6d20 6f6e 6520  inates from one 
-00026180: 636f 6f72 6469 6e61 7465 2073 7973 7465  coordinate syste
-00026190: 6d20 746f 2061 6e6f 7468 6572 2028 696e  m to another (in
-000261a0: 6465 7820 7061 7274 290a 0a20 2020 2041  dex part)..    A
-000261b0: 7267 730a 2020 2020 2d2d 2d2d 0a20 2020  rgs.    ----.   
-000261c0: 2074 6172 6765 7420 3a20 3a63 6c61 7373   target : :class
-000261d0: 3a60 6e75 7469 6c73 2e74 7261 6e73 666f  :`nutils.transfo
-000261e0: 726d 7365 712e 5472 616e 7366 6f72 6d73  rmseq.Transforms
-000261f0: 602c 206f 7074 696f 6e61 6c0a 2020 2020  `, optional.    
-00026200: 2020 2020 5468 6520 7461 7267 6574 2063      The target c
-00026210: 6f6f 7264 696e 6174 6520 7379 7374 656d  oordinate system
-00026220: 2e20 4966 2060 4e6f 6e65 6020 7468 6520  . If `None` the 
-00026230: 7461 7267 6574 2069 7320 7468 6520 726f  target is the ro
-00026240: 6f74 0a20 2020 2020 2020 2063 6f6f 7264  ot.        coord
-00026250: 696e 6174 6520 7379 7374 656d 2e0a 2020  inate system..  
-00026260: 2020 736f 7572 6365 203a 203a 636c 6173    source : :clas
-00026270: 733a 606e 7574 696c 732e 7472 616e 7366  s:`nutils.transf
-00026280: 6f72 6d73 6571 2e54 7261 6e73 666f 726d  ormseq.Transform
-00026290: 7360 0a20 2020 2020 2020 2054 6865 2073  s`.        The s
-000262a0: 6f75 7263 6520 636f 6f72 6469 6e61 7465  ource coordinate
-000262b0: 2073 7973 7465 6d2e 0a20 2020 2069 6e64   system..    ind
-000262c0: 6578 203a 2073 6361 6c61 722c 2069 6e74  ex : scalar, int
-000262d0: 6567 6572 203a 636c 6173 733a 6041 7272  eger :class:`Arr
-000262e0: 6179 600a 2020 2020 2020 2020 5468 6520  ay`.        The 
-000262f0: 696e 6465 7820 7061 7274 206f 6620 7468  index part of th
-00026300: 6520 736f 7572 6365 2063 6f6f 7264 696e  e source coordin
-00026310: 6174 6573 2e0a 2020 2020 2727 270a 0a20  ates..    '''.. 
-00026320: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00026330: 7365 6c66 2c20 7461 7267 6574 2c20 736f  self, target, so
-00026340: 7572 6365 2c20 696e 6465 783a 2041 7272  urce, index: Arr
-00026350: 6179 293a 0a20 2020 2020 2020 2069 6620  ay):.        if 
-00026360: 696e 6465 782e 6474 7970 6520 213d 2069  index.dtype != i
-00026370: 6e74 206f 7220 696e 6465 782e 6e64 696d  nt or index.ndim
-00026380: 2021 3d20 303a 0a20 2020 2020 2020 2020   != 0:.         
-00026390: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-000263a0: 726f 7228 2761 7267 756d 656e 7420 6069  ror('argument `i
-000263b0: 6e64 6578 6020 6d75 7374 2062 6520 6120  ndex` must be a 
-000263c0: 7363 616c 6172 2c20 696e 7465 6765 7220  scalar, integer 
-000263d0: 606e 7574 696c 732e 6576 616c 7561 626c  `nutils.evaluabl
-000263e0: 652e 4172 7261 7960 2729 0a20 2020 2020  e.Array`').     
-000263f0: 2020 2073 656c 662e 5f74 6172 6765 7420     self._target 
-00026400: 3d20 7461 7267 6574 0a20 2020 2020 2020  = target.       
-00026410: 2073 656c 662e 5f73 6f75 7263 6520 3d20   self._source = 
-00026420: 736f 7572 6365 0a20 2020 2020 2020 2073  source.        s
-00026430: 656c 662e 5f69 6e64 6578 203d 2069 6e64  elf._index = ind
-00026440: 6578 0a20 2020 2020 2020 2073 7570 6572  ex.        super
-00026450: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
-00026460: 3d28 696e 6465 782c 292c 2073 6861 7065  =(index,), shape
-00026470: 3d28 292c 2064 7479 7065 3d69 6e74 290a  =(), dtype=int).
-00026480: 0a20 2020 2064 6566 2065 7661 6c66 2873  .    def evalf(s
-00026490: 656c 662c 2069 6e64 6578 293a 0a20 2020  elf, index):.   
-000264a0: 2020 2020 2069 6620 7365 6c66 2e5f 7461       if self._ta
-000264b0: 7267 6574 2069 7320 6e6f 7420 4e6f 6e65  rget is not None
-000264c0: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
-000264d0: 6465 782c 205f 203d 2073 656c 662e 5f74  dex, _ = self._t
-000264e0: 6172 6765 742e 696e 6465 785f 7769 7468  arget.index_with
-000264f0: 5f74 6169 6c28 7365 6c66 2e5f 736f 7572  _tail(self._sour
-00026500: 6365 5b69 6e64 6578 2e5f 5f69 6e64 6578  ce[index.__index
-00026510: 5f5f 2829 5d29 0a20 2020 2020 2020 2065  __()]).        e
-00026520: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00026530: 2069 6e64 6578 203d 2030 0a20 2020 2020   index = 0.     
-00026540: 2020 2072 6574 7572 6e20 6e75 6d70 792e     return numpy.
-00026550: 6172 7261 7928 696e 6465 7829 0a0a 2020  array(index)..  
-00026560: 2020 6465 6620 5f69 6e74 626f 756e 6473    def _intbounds
-00026570: 5f69 6d70 6c28 7365 6c66 293a 0a20 2020  _impl(self):.   
-00026580: 2020 2020 206c 656e 5f74 6172 6765 7420       len_target 
-00026590: 3d20 3120 6966 2073 656c 662e 5f74 6172  = 1 if self._tar
-000265a0: 6765 7420 6973 204e 6f6e 6520 656c 7365  get is None else
-000265b0: 206c 656e 2873 656c 662e 5f74 6172 6765   len(self._targe
-000265c0: 7429 0a20 2020 2020 2020 2072 6574 7572  t).        retur
-000265d0: 6e20 302c 206c 656e 5f74 6172 6765 7420  n 0, len_target 
-000265e0: 2d20 310a 0a20 2020 2064 6566 205f 7369  - 1..    def _si
-000265f0: 6d70 6c69 6669 6564 2873 656c 6629 3a0a  mplified(self):.
-00026600: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00026610: 5f74 6172 6765 7420 6973 204e 6f6e 653a  _target is None:
-00026620: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00026630: 7572 6e20 6f6e 6573 2828 312c 292c 2064  urn ones((1,), d
-00026640: 7479 7065 3d69 6e74 290a 2020 2020 2020  type=int).      
-00026650: 2020 656c 6966 2073 656c 662e 5f74 6172    elif self._tar
-00026660: 6765 7420 3d3d 2073 656c 662e 5f73 6f75  get == self._sou
-00026670: 7263 653a 0a20 2020 2020 2020 2020 2020  rce:.           
-00026680: 2072 6574 7572 6e20 7365 6c66 2e5f 696e   return self._in
-00026690: 6465 780a 0a0a 636c 6173 7320 5472 616e  dex...class Tran
-000266a0: 7366 6f72 6d4c 696e 6561 7228 4172 7261  sformLinear(Arra
-000266b0: 7929 3a0a 2020 2020 2727 274c 696e 6561  y):.    '''Linea
-000266c0: 7220 7061 7274 206f 6620 6120 636f 6f72  r part of a coor
-000266d0: 6469 6e61 7465 2074 7261 6e73 666f 726d  dinate transform
-000266e0: 6174 696f 6e0a 0a20 2020 2041 7267 730a  ation..    Args.
-000266f0: 2020 2020 2d2d 2d2d 0a20 2020 2074 6172      ----.    tar
-00026700: 6765 7420 3a20 3a63 6c61 7373 3a60 6e75  get : :class:`nu
-00026710: 7469 6c73 2e74 7261 6e73 666f 726d 7365  tils.transformse
-00026720: 712e 5472 616e 7366 6f72 6d73 602c 206f  q.Transforms`, o
-00026730: 7074 696f 6e61 6c0a 2020 2020 2020 2020  ptional.        
-00026740: 5468 6520 7461 7267 6574 2063 6f6f 7264  The target coord
-00026750: 696e 6174 6520 7379 7374 656d 2e20 4966  inate system. If
-00026760: 2060 4e6f 6e65 6020 7468 6520 7461 7267   `None` the targ
-00026770: 6574 2069 7320 7468 6520 726f 6f74 0a20  et is the root. 
-00026780: 2020 2020 2020 2063 6f6f 7264 696e 6174         coordinat
-00026790: 6520 7379 7374 656d 2e0a 2020 2020 736f  e system..    so
-000267a0: 7572 6365 203a 203a 636c 6173 733a 606e  urce : :class:`n
-000267b0: 7574 696c 732e 7472 616e 7366 6f72 6d73  utils.transforms
-000267c0: 6571 2e54 7261 6e73 666f 726d 7360 0a20  eq.Transforms`. 
-000267d0: 2020 2020 2020 2054 6865 2073 6f75 7263         The sourc
-000267e0: 6520 636f 6f72 6469 6e61 7465 2073 7973  e coordinate sys
-000267f0: 7465 6d2e 0a20 2020 2069 6e64 6578 203a  tem..    index :
-00026800: 2073 6361 6c61 722c 2069 6e74 6567 6572   scalar, integer
-00026810: 203a 636c 6173 733a 6041 7272 6179 600a   :class:`Array`.
-00026820: 2020 2020 2020 2020 5468 6520 696e 6465          The inde
-00026830: 7820 7061 7274 206f 6620 7468 6520 736f  x part of the so
-00026840: 7572 6365 2063 6f6f 7264 696e 6174 6573  urce coordinates
-00026850: 2e0a 2020 2020 2727 270a 0a20 2020 2064  ..    '''..    d
-00026860: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00026870: 2c20 7461 7267 6574 2c20 736f 7572 6365  , target, source
-00026880: 2c20 696e 6465 783a 2041 7272 6179 293a  , index: Array):
-00026890: 0a20 2020 2020 2020 2069 6620 696e 6465  .        if inde
-000268a0: 782e 6474 7970 6520 213d 2069 6e74 206f  x.dtype != int o
-000268b0: 7220 696e 6465 782e 6e64 696d 2021 3d20  r index.ndim != 
-000268c0: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
-000268d0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-000268e0: 2761 7267 756d 656e 7420 6069 6e64 6578  'argument `index
-000268f0: 6020 6d75 7374 2062 6520 6120 7363 616c  ` must be a scal
-00026900: 6172 2c20 696e 7465 6765 7220 606e 7574  ar, integer `nut
-00026910: 696c 732e 6576 616c 7561 626c 652e 4172  ils.evaluable.Ar
-00026920: 7261 7960 2729 0a20 2020 2020 2020 2073  ray`').        s
-00026930: 656c 662e 5f74 6172 6765 7420 3d20 7461  elf._target = ta
-00026940: 7267 6574 0a20 2020 2020 2020 2073 656c  rget.        sel
-00026950: 662e 5f73 6f75 7263 6520 3d20 736f 7572  f._source = sour
-00026960: 6365 0a20 2020 2020 2020 2074 6172 6765  ce.        targe
-00026970: 745f 6469 6d20 3d20 736f 7572 6365 2e74  t_dim = source.t
-00026980: 6f64 696d 7320 6966 2074 6172 6765 7420  odims if target 
-00026990: 6973 204e 6f6e 6520 656c 7365 2074 6172  is None else tar
-000269a0: 6765 742e 6672 6f6d 6469 6d73 0a20 2020  get.fromdims.   
-000269b0: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
-000269c0: 6e69 745f 5f28 6172 6773 3d28 696e 6465  nit__(args=(inde
-000269d0: 782c 292c 2073 6861 7065 3d28 636f 6e73  x,), shape=(cons
-000269e0: 7461 6e74 2874 6172 6765 745f 6469 6d29  tant(target_dim)
-000269f0: 2c20 636f 6e73 7461 6e74 2873 6f75 7263  , constant(sourc
-00026a00: 652e 6672 6f6d 6469 6d73 2929 2c20 6474  e.fromdims)), dt
-00026a10: 7970 653d 666c 6f61 7429 0a0a 2020 2020  ype=float)..    
-00026a20: 6465 6620 6576 616c 6628 7365 6c66 2c20  def evalf(self, 
-00026a30: 696e 6465 7829 3a0a 2020 2020 2020 2020  index):.        
-00026a40: 6368 6169 6e20 3d20 7365 6c66 2e5f 736f  chain = self._so
-00026a50: 7572 6365 5b69 6e64 6578 2e5f 5f69 6e64  urce[index.__ind
-00026a60: 6578 5f5f 2829 5d0a 2020 2020 2020 2020  ex__()].        
-00026a70: 6966 2073 656c 662e 5f74 6172 6765 7420  if self._target 
-00026a80: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00026a90: 2020 2020 2020 2020 205f 2c20 6368 6169           _, chai
-00026aa0: 6e20 3d20 7365 6c66 2e5f 7461 7267 6574  n = self._target
-00026ab0: 2e69 6e64 6578 5f77 6974 685f 7461 696c  .index_with_tail
-00026ac0: 2863 6861 696e 290a 2020 2020 2020 2020  (chain).        
-00026ad0: 6966 2063 6861 696e 3a0a 2020 2020 2020  if chain:.      
-00026ae0: 2020 2020 2020 7265 7475 726e 2066 756e        return fun
-00026af0: 6374 6f6f 6c73 2e72 6564 7563 6528 6c61  ctools.reduce(la
-00026b00: 6d62 6461 2072 2c20 693a 2069 2040 2072  mbda r, i: i @ r
-00026b10: 2c20 2869 7465 6d2e 6c69 6e65 6172 2066  , (item.linear f
-00026b20: 6f72 2069 7465 6d20 696e 2072 6576 6572  or item in rever
-00026b30: 7365 6428 6368 6169 6e29 2929 0a20 2020  sed(chain))).   
-00026b40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00026b50: 2020 2020 2020 2072 6574 7572 6e20 6e75         return nu
-00026b60: 6d70 792e 6579 6528 7365 6c66 2e5f 736f  mpy.eye(self._so
-00026b70: 7572 6365 2e66 726f 6d64 696d 7329 0a0a  urce.fromdims)..
-00026b80: 2020 2020 6465 6620 5f73 696d 706c 6966      def _simplif
-00026b90: 6965 6428 7365 6c66 293a 0a20 2020 2020  ied(self):.     
-00026ba0: 2020 2069 6620 7365 6c66 2e5f 7461 7267     if self._targ
-00026bb0: 6574 203d 3d20 7365 6c66 2e5f 736f 7572  et == self._sour
-00026bc0: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
-00026bd0: 7265 7475 726e 2064 6961 676f 6e61 6c69  return diagonali
-00026be0: 7a65 286f 6e65 7328 2863 6f6e 7374 616e  ze(ones((constan
-00026bf0: 7428 7365 6c66 2e5f 736f 7572 6365 2e66  t(self._source.f
-00026c00: 726f 6d64 696d 7329 2c29 2c20 6474 7970  romdims),), dtyp
-00026c10: 653d 666c 6f61 7429 290a 0a0a 636c 6173  e=float))...clas
-00026c20: 7320 5472 616e 7366 6f72 6d42 6173 6973  s TransformBasis
-00026c30: 2841 7272 6179 293a 0a20 2020 2027 2727  (Array):.    '''
-00026c40: 5665 6374 6f72 2062 6173 6973 2066 6f72  Vector basis for
-00026c50: 2074 6865 2072 6f6f 7420 616e 6420 6120   the root and a 
-00026c60: 736f 7572 6365 2063 6f6f 7264 696e 6174  source coordinat
-00026c70: 6520 7379 7374 656d 0a0a 2020 2020 5468  e system..    Th
-00026c80: 6520 636f 6c75 6d6e 7320 6f66 2074 6869  e columns of thi
-00026c90: 7320 6d61 7472 6978 2066 6f72 6d20 6120  s matrix form a 
-00026ca0: 7665 6374 6f72 2062 6173 6973 2066 6f72  vector basis for
-00026cb0: 2074 6865 2073 7061 6365 206f 6620 726f   the space of ro
-00026cc0: 6f74 0a20 2020 2063 6f6f 7264 696e 6174  ot.    coordinat
-00026cd0: 6573 2e20 5468 6520 6669 7273 7420 606e  es. The first `n
-00026ce0: 6020 7665 6374 6f72 7320 616c 736f 2073  ` vectors also s
-00026cf0: 7061 6e20 7468 6520 7370 6163 6520 6f66  pan the space of
-00026d00: 2073 6f75 7263 650a 2020 2020 636f 6f72   source.    coor
-00026d10: 6469 6e61 7465 7320 6d61 7070 6564 2074  dinates mapped t
-00026d20: 6f20 7468 6520 726f 6f74 2c20 7768 6572  o the root, wher
-00026d30: 6520 606e 6020 6973 2074 6865 2064 696d  e `n` is the dim
-00026d40: 656e 7369 6f6e 206f 6620 7468 6520 736f  ension of the so
-00026d50: 7572 6365 0a20 2020 2063 6f6f 7264 696e  urce.    coordin
-00026d60: 6174 6520 7379 7374 656d 2e20 5468 6520  ate system. The 
-00026d70: 7265 6d61 696e 6465 7220 6973 202a 6e6f  remainder is *no
-00026d80: 742a 2061 2073 7061 6e20 6f66 2074 6865  t* a span of the
-00026d90: 2063 6f6d 706c 656d 656e 7420 7370 6163   complement spac
-00026da0: 6520 696e 0a20 2020 2067 656e 6572 616c  e in.    general
-00026db0: 2e0a 0a20 2020 204e 6f20 6164 6469 7469  ...    No additi
-00026dc0: 6f6e 616c 2070 726f 7065 7274 6965 7320  onal properties 
-00026dd0: 6172 6520 6775 6172 616e 7465 6564 2062  are guaranteed b
-00026de0: 6579 6f6e 6420 7468 6520 6162 6f76 652e  eyond the above.
-00026df0: 2049 6e20 7061 7274 6963 756c 6172 2c20   In particular, 
-00026e00: 6966 0a20 2020 2074 6865 2073 6f75 7263  if.    the sourc
-00026e10: 6520 636f 6f72 6469 6e61 7465 2073 7973  e coordinate sys
-00026e20: 7465 6d20 6861 7320 7468 6520 7361 6d65  tem has the same
-00026e30: 2064 696d 656e 7369 6f6e 2061 7320 7468   dimension as th
-00026e40: 6520 726f 6f74 2c20 7468 650a 2020 2020  e root, the.    
-00026e50: 6261 7369 7320 6973 202a 6e6f 7420 6e65  basis is *not ne
-00026e60: 6365 7373 6172 696c 792a 2074 6865 2073  cessarily* the s
-00026e70: 616d 6520 6173 2060 6054 7261 6e73 666f  ame as ``Transfo
-00026e80: 726d 4c69 6e65 6172 284e 6f6e 652c 2073  rmLinear(None, s
-00026e90: 6f75 7263 652c 0a20 2020 2069 6e64 6578  ource,.    index
-00026ea0: 2960 602e 0a0a 2020 2020 4172 6773 0a20  )``...    Args. 
-00026eb0: 2020 202d 2d2d 2d0a 2020 2020 736f 7572     ----.    sour
-00026ec0: 6365 203a 203a 636c 6173 733a 606e 7574  ce : :class:`nut
-00026ed0: 696c 732e 7472 616e 7366 6f72 6d73 6571  ils.transformseq
-00026ee0: 2e54 7261 6e73 666f 726d 7360 0a20 2020  .Transforms`.   
-00026ef0: 2020 2020 2054 6865 2073 6f75 7263 6520       The source 
-00026f00: 636f 6f72 6469 6e61 7465 2073 7973 7465  coordinate syste
-00026f10: 6d2e 0a20 2020 2069 6e64 6578 203a 2073  m..    index : s
-00026f20: 6361 6c61 722c 2069 6e74 6567 6572 203a  calar, integer :
-00026f30: 636c 6173 733a 6041 7272 6179 600a 2020  class:`Array`.  
-00026f40: 2020 2020 2020 5468 6520 696e 6465 7820        The index 
-00026f50: 7061 7274 206f 6620 7468 6520 736f 7572  part of the sour
-00026f60: 6365 2063 6f6f 7264 696e 6174 6573 2e0a  ce coordinates..
-00026f70: 2020 2020 2727 270a 0a20 2020 2064 6566      '''..    def
-00026f80: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00026f90: 736f 7572 6365 2c20 696e 6465 783a 2041  source, index: A
-00026fa0: 7272 6179 293a 0a20 2020 2020 2020 2069  rray):.        i
-00026fb0: 6620 696e 6465 782e 6474 7970 6520 213d  f index.dtype !=
-00026fc0: 2069 6e74 206f 7220 696e 6465 782e 6e64   int or index.nd
-00026fd0: 696d 2021 3d20 303a 0a20 2020 2020 2020  im != 0:.       
-00026fe0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00026ff0: 4572 726f 7228 2761 7267 756d 656e 7420  Error('argument 
-00027000: 6069 6e64 6578 6020 6d75 7374 2062 6520  `index` must be 
-00027010: 6120 7363 616c 6172 2c20 696e 7465 6765  a scalar, intege
-00027020: 7220 606e 7574 696c 732e 6576 616c 7561  r `nutils.evalua
-00027030: 626c 652e 4172 7261 7960 2729 0a20 2020  ble.Array`').   
-00027040: 2020 2020 2073 656c 662e 5f73 6f75 7263       self._sourc
-00027050: 6520 3d20 736f 7572 6365 0a20 2020 2020  e = source.     
-00027060: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
-00027070: 745f 5f28 6172 6773 3d28 696e 6465 782c  t__(args=(index,
-00027080: 292c 2073 6861 7065 3d28 636f 6e73 7461  ), shape=(consta
-00027090: 6e74 2873 6f75 7263 652e 746f 6469 6d73  nt(source.todims
-000270a0: 292c 2063 6f6e 7374 616e 7428 736f 7572  ), constant(sour
-000270b0: 6365 2e74 6f64 696d 7329 292c 2064 7479  ce.todims)), dty
-000270c0: 7065 3d66 6c6f 6174 290a 0a20 2020 2064  pe=float)..    d
-000270d0: 6566 2065 7661 6c66 2873 656c 662c 2069  ef evalf(self, i
-000270e0: 6e64 6578 293a 0a20 2020 2020 2020 2063  ndex):.        c
-000270f0: 6861 696e 203d 2073 656c 662e 5f73 6f75  hain = self._sou
-00027100: 7263 655b 696e 6465 782e 5f5f 696e 6465  rce[index.__inde
-00027110: 785f 5f28 295d 0a20 2020 2020 2020 206c  x__()].        l
-00027120: 696e 6561 7220 3d20 6e75 6d70 792e 6579  inear = numpy.ey
-00027130: 6528 7365 6c66 2e5f 736f 7572 6365 2e66  e(self._source.f
-00027140: 726f 6d64 696d 7329 0a20 2020 2020 2020  romdims).       
-00027150: 2066 6f72 2069 7465 6d20 696e 2072 6576   for item in rev
-00027160: 6572 7365 6428 6368 6169 6e29 3a0a 2020  ersed(chain):.  
-00027170: 2020 2020 2020 2020 2020 6c69 6e65 6172            linear
-00027180: 203d 2069 7465 6d2e 6c69 6e65 6172 2040   = item.linear @
-00027190: 206c 696e 6561 720a 2020 2020 2020 2020   linear.        
-000271a0: 2020 2020 6173 7365 7274 2069 7465 6d2e      assert item.
-000271b0: 6672 6f6d 6469 6d73 203c 3d20 6974 656d  fromdims <= item
-000271c0: 2e74 6f64 696d 7320 3c3d 2069 7465 6d2e  .todims <= item.
-000271d0: 6672 6f6d 6469 6d73 202b 2031 0a20 2020  fromdims + 1.   
-000271e0: 2020 2020 2020 2020 2069 6620 6974 656d           if item
-000271f0: 2e74 6f64 696d 7320 3d3d 2069 7465 6d2e  .todims == item.
-00027200: 6672 6f6d 6469 6d73 202b 2031 3a0a 2020  fromdims + 1:.  
-00027210: 2020 2020 2020 2020 2020 2020 2020 6c69                li
-00027220: 6e65 6172 203d 206e 756d 7079 2e63 6f6e  near = numpy.con
-00027230: 6361 7465 6e61 7465 285b 6c69 6e65 6172  catenate([linear
-00027240: 2c20 6974 656d 2e65 7874 5b3a 2c20 6e75  , item.ext[:, nu
-00027250: 6d70 792e 6e65 7761 7869 735d 5d2c 2061  mpy.newaxis]], a
-00027260: 7869 733d 3129 0a20 2020 2020 2020 2061  xis=1).        a
-00027270: 7373 6572 7420 6c69 6e65 6172 2e73 6861  ssert linear.sha
-00027280: 7065 203d 3d20 2873 656c 662e 5f73 6f75  pe == (self._sou
-00027290: 7263 652e 746f 6469 6d73 2c20 7365 6c66  rce.todims, self
-000272a0: 2e5f 736f 7572 6365 2e74 6f64 696d 7329  ._source.todims)
-000272b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000272c0: 6c69 6e65 6172 0a0a 2020 2020 6465 6620  linear..    def 
-000272d0: 5f73 696d 706c 6966 6965 6428 7365 6c66  _simplified(self
-000272e0: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
-000272f0: 6c66 2e5f 736f 7572 6365 2e74 6f64 696d  lf._source.todim
-00027300: 7320 3d3d 2073 656c 662e 5f73 6f75 7263  s == self._sourc
-00027310: 652e 6672 6f6d 6469 6d73 3a0a 2020 2020  e.fromdims:.    
-00027320: 2020 2020 2020 2020 2320 5369 6e63 6520          # Since 
-00027330: 7765 206f 6e6c 7920 6775 6172 616e 7465  we only guarante
-00027340: 6520 7468 6174 2074 6865 2062 6173 6973  e that the basis
-00027350: 2073 7061 6e73 2074 6865 2073 7061 6365   spans the space
-00027360: 206f 6620 736f 7572 6365 0a20 2020 2020   of source.     
-00027370: 2020 2020 2020 2023 2063 6f6f 7264 696e         # coordin
-00027380: 6174 6573 206d 6170 7065 6420 746f 2074  ates mapped to t
-00027390: 6865 2072 6f6f 7420 616e 6420 7468 6520  he root and the 
-000273a0: 6d61 7020 6973 2061 2062 696a 6563 7469  map is a bijecti
-000273b0: 6f6e 2028 6576 6572 790a 2020 2020 2020  on (every.      
-000273c0: 2020 2020 2020 2320 6054 7261 6e73 666f        # `Transfo
-000273d0: 726d 6020 6973 2061 7373 756d 6564 2074  rm` is assumed t
-000273e0: 6f20 6265 2069 6e6a 6563 7469 7665 292c  o be injective),
-000273f0: 2077 6520 6361 6e20 7265 7475 726e 2074   we can return t
-00027400: 6865 2075 6e69 740a 2020 2020 2020 2020  he unit.        
-00027410: 2020 2020 2320 7665 6374 6f72 7320 6865      # vectors he
-00027420: 7265 2e0a 2020 2020 2020 2020 2020 2020  re..            
-00027430: 7265 7475 726e 2064 6961 676f 6e61 6c69  return diagonali
-00027440: 7a65 286f 6e65 7328 2873 656c 662e 5f73  ze(ones((self._s
-00027450: 6f75 7263 652e 6672 6f6d 6469 6d73 2c29  ource.fromdims,)
-00027460: 2c20 6474 7970 653d 666c 6f61 7429 290a  , dtype=float)).
-00027470: 0a0a 636c 6173 7320 5f4c 6f6f 7049 6e64  ..class _LoopInd
-00027480: 6578 2841 7267 756d 656e 7429 3a0a 0a20  ex(Argument):.. 
-00027490: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-000274a0: 7365 6c66 2c20 6e61 6d65 3a20 7374 722c  self, name: str,
-000274b0: 206c 656e 6774 683a 2041 7272 6179 293a   length: Array):
-000274c0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-000274d0: 6973 696e 7374 616e 6365 286e 616d 652c  isinstance(name,
-000274e0: 2073 7472 292c 2066 276e 616d 653d 7b6e   str), f'name={n
-000274f0: 616d 6521 727d 270a 2020 2020 2020 2020  ame!r}'.        
-00027500: 6173 7365 7274 205f 6973 696e 6465 7828  assert _isindex(
-00027510: 6c65 6e67 7468 292c 2066 276c 656e 6774  length), f'lengt
-00027520: 683d 7b6c 656e 6774 6821 727d 270a 2020  h={length!r}'.  
-00027530: 2020 2020 2020 7365 6c66 2e6c 656e 6774        self.lengt
-00027540: 6820 3d20 6c65 6e67 7468 0a20 2020 2020  h = length.     
-00027550: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
-00027560: 745f 5f28 6e61 6d65 2c20 2829 2c20 696e  t__(name, (), in
-00027570: 7429 0a0a 2020 2020 6465 6620 5f5f 7374  t)..    def __st
-00027580: 725f 5f28 7365 6c66 293a 0a20 2020 2020  r__(self):.     
-00027590: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-000275a0: 2020 2020 6c65 6e67 7468 203d 2073 656c      length = sel
-000275b0: 662e 6c65 6e67 7468 2e5f 5f69 6e64 6578  f.length.__index
-000275c0: 5f5f 2829 0a20 2020 2020 2020 2065 7863  __().        exc
-000275d0: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
-000275e0: 206c 656e 6774 6820 3d20 273f 270a 2020   length = '?'.  
-000275f0: 2020 2020 2020 7265 7475 726e 2027 4c6f        return 'Lo
-00027600: 6f70 496e 6465 7828 7b7d 2c20 6c65 6e67  opIndex({}, leng
-00027610: 7468 3d7b 7d29 272e 666f 726d 6174 2873  th={})'.format(s
-00027620: 656c 662e 5f6e 616d 652c 206c 656e 6774  elf._name, lengt
-00027630: 6829 0a0a 2020 2020 6465 6620 5f6e 6f64  h)..    def _nod
-00027640: 6528 7365 6c66 2c20 6361 6368 652c 2073  e(self, cache, s
-00027650: 7562 6772 6170 682c 2074 696d 6573 293a  ubgraph, times):
-00027660: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00027670: 2069 6e20 6361 6368 653a 0a20 2020 2020   in cache:.     
-00027680: 2020 2020 2020 2072 6574 7572 6e20 6361         return ca
-00027690: 6368 655b 7365 6c66 5d0a 2020 2020 2020  che[self].      
-000276a0: 2020 6361 6368 655b 7365 6c66 5d20 3d20    cache[self] = 
-000276b0: 6e6f 6465 203d 2052 6567 756c 6172 4e6f  node = RegularNo
-000276c0: 6465 2827 4c6f 6f70 496e 6465 7827 2c20  de('LoopIndex', 
-000276d0: 2829 2c20 6469 6374 286c 656e 6774 683d  (), dict(length=
-000276e0: 7365 6c66 2e6c 656e 6774 682e 5f6e 6f64  self.length._nod
-000276f0: 6528 6361 6368 652c 2073 7562 6772 6170  e(cache, subgrap
-00027700: 682c 2074 696d 6573 2929 2c20 2874 7970  h, times)), (typ
-00027710: 6528 7365 6c66 292e 5f5f 6e61 6d65 5f5f  e(self).__name__
-00027720: 2c20 5f53 7461 7473 2829 292c 2073 7562  , _Stats()), sub
-00027730: 6772 6170 6829 0a20 2020 2020 2020 2072  graph).        r
-00027740: 6574 7572 6e20 6e6f 6465 0a0a 2020 2020  eturn node..    
-00027750: 6465 6620 5f69 6e74 626f 756e 6473 5f69  def _intbounds_i
-00027760: 6d70 6c28 7365 6c66 293a 0a20 2020 2020  mpl(self):.     
-00027770: 2020 206c 6f77 6572 5f6c 656e 6774 682c     lower_length,
-00027780: 2075 7070 6572 5f6c 656e 6774 6820 3d20   upper_length = 
-00027790: 7365 6c66 2e6c 656e 6774 682e 5f69 6e74  self.length._int
-000277a0: 626f 756e 6473 0a20 2020 2020 2020 2072  bounds.        r
-000277b0: 6574 7572 6e20 302c 206d 6178 2830 2c20  eturn 0, max(0, 
-000277c0: 7570 7065 725f 6c65 6e67 7468 202d 2031  upper_length - 1
-000277d0: 290a 0a20 2020 2064 6566 205f 7369 6d70  )..    def _simp
-000277e0: 6c69 6669 6564 2873 656c 6629 3a0a 2020  lified(self):.  
-000277f0: 2020 2020 2020 6966 205f 6571 7561 6c73        if _equals
-00027800: 5f73 6361 6c61 725f 636f 6e73 7461 6e74  _scalar_constant
-00027810: 2873 656c 662e 6c65 6e67 7468 2c20 3129  (self.length, 1)
-00027820: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00027830: 7475 726e 205a 6572 6f73 2828 292c 2069  turn Zeros((), i
-00027840: 6e74 290a 0a0a 636c 6173 7320 4c6f 6f70  nt)...class Loop
-00027850: 5375 6d28 4172 7261 7929 3a0a 0a20 2020  Sum(Array):..   
-00027860: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00027870: 6c66 2c20 6675 6e63 3a20 4172 7261 792c  lf, func: Array,
-00027880: 2073 6861 7065 3a20 7479 7069 6e67 2e54   shape: typing.T
-00027890: 7570 6c65 5b41 7272 6179 2c20 2e2e 2e5d  uple[Array, ...]
-000278a0: 2c20 696e 6465 785f 6e61 6d65 3a20 7374  , index_name: st
-000278b0: 722c 206c 656e 6774 683a 2041 7272 6179  r, length: Array
-000278c0: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
-000278d0: 7420 6973 696e 7374 616e 6365 2866 756e  t isinstance(fun
-000278e0: 632c 2041 7272 6179 2920 616e 6420 6675  c, Array) and fu
-000278f0: 6e63 2e64 7479 7065 2021 3d20 626f 6f6c  nc.dtype != bool
-00027900: 2c20 6627 6675 6e63 3d7b 6675 6e63 2172  , f'func={func!r
-00027910: 7d27 0a20 2020 2020 2020 2061 7373 6572  }'.        asser
-00027920: 7420 6973 696e 7374 616e 6365 2873 6861  t isinstance(sha
-00027930: 7065 2c20 7475 706c 6529 2061 6e64 2061  pe, tuple) and a
-00027940: 6c6c 285f 6973 696e 6465 7828 6e29 2066  ll(_isindex(n) f
-00027950: 6f72 206e 2069 6e20 7368 6170 6529 2c20  or n in shape), 
-00027960: 6627 7368 6170 653d 7b73 6861 7065 2172  f'shape={shape!r
-00027970: 7d27 0a20 2020 2020 2020 2061 7373 6572  }'.        asser
-00027980: 7420 6973 696e 7374 616e 6365 2869 6e64  t isinstance(ind
-00027990: 6578 5f6e 616d 652c 2073 7472 292c 2066  ex_name, str), f
-000279a0: 2769 6e64 6578 5f6e 616d 653d 7b69 6e64  'index_name={ind
-000279b0: 6578 5f6e 616d 6521 727d 270a 2020 2020  ex_name!r}'.    
-000279c0: 2020 2020 6173 7365 7274 205f 6973 696e      assert _isin
-000279d0: 6465 7828 6c65 6e67 7468 292c 2066 276c  dex(length), f'l
-000279e0: 656e 6774 683d 7b6c 656e 6774 6821 727d  ength={length!r}
-000279f0: 270a 2020 2020 2020 2020 6173 7365 7274  '.        assert
-00027a00: 2066 756e 632e 6e64 696d 203d 3d20 6c65   func.ndim == le
-00027a10: 6e28 7368 6170 6529 0a20 2020 2020 2020  n(shape).       
-00027a20: 2073 656c 662e 696e 6465 7820 3d20 6c6f   self.index = lo
-00027a30: 6f70 5f69 6e64 6578 2869 6e64 6578 5f6e  op_index(index_n
-00027a40: 616d 652c 206c 656e 6774 6829 0a20 2020  ame, length).   
-00027a50: 2020 2020 2069 6620 616e 7928 7365 6c66       if any(self
-00027a60: 2e69 6e64 6578 2069 6e20 6e2e 6172 6775  .index in n.argu
-00027a70: 6d65 6e74 7320 666f 7220 6e20 696e 2073  ments for n in s
-00027a80: 6861 7065 293a 0a20 2020 2020 2020 2020  hape):.         
-00027a90: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00027aa0: 726f 7228 2774 6865 2073 6861 7065 206f  ror('the shape o
-00027ab0: 6620 7468 6520 6675 6e63 7469 6f6e 206d  f the function m
-00027ac0: 7573 7420 6e6f 7420 6465 7065 6e64 206f  ust not depend o
-00027ad0: 6e20 7468 6520 696e 6465 7827 290a 2020  n the index').  
-00027ae0: 2020 2020 2020 7365 6c66 2e66 756e 6320        self.func 
-00027af0: 3d20 6675 6e63 0a20 2020 2020 2020 2073  = func.        s
-00027b00: 656c 662e 5f69 6e76 6172 6961 6e74 732c  elf._invariants,
-00027b10: 2073 656c 662e 5f64 6570 656e 6465 6e63   self._dependenc
-00027b20: 6965 7320 3d20 5f64 6570 656e 6465 6e63  ies = _dependenc
-00027b30: 6965 735f 7361 6e73 5f69 6e76 6172 6961  ies_sans_invaria
-00027b40: 6e74 7328 6675 6e63 2c20 7365 6c66 2e69  nts(func, self.i
-00027b50: 6e64 6578 290a 2020 2020 2020 2020 7375  ndex).        su
-00027b60: 7065 7228 292e 5f5f 696e 6974 5f5f 2861  per().__init__(a
-00027b70: 7267 733d 2854 7570 6c65 2873 6861 7065  rgs=(Tuple(shape
-00027b80: 292c 206c 656e 6774 682c 202a 7365 6c66  ), length, *self
-00027b90: 2e5f 696e 7661 7269 616e 7473 292c 2073  ._invariants), s
-00027ba0: 6861 7065 3d73 6861 7065 2c20 6474 7970  hape=shape, dtyp
-00027bb0: 653d 6675 6e63 2e64 7479 7065 290a 0a20  e=func.dtype).. 
-00027bc0: 2020 2040 6361 6368 6564 5f70 726f 7065     @cached_prope
-00027bd0: 7274 790a 2020 2020 6465 6620 5f73 6572  rty.    def _ser
-00027be0: 6961 6c69 7a65 645f 6c6f 6f70 2873 656c  ialized_loop(sel
-00027bf0: 6629 3a0a 2020 2020 2020 2020 696e 6469  f):.        indi
-00027c00: 6365 7320 3d20 7b64 3a20 6920 666f 7220  ces = {d: i for 
-00027c10: 692c 2064 2069 6e20 656e 756d 6572 6174  i, d in enumerat
-00027c20: 6528 6974 6572 746f 6f6c 732e 6368 6169  e(itertools.chai
-00027c30: 6e28 5b73 656c 662e 696e 6465 785d 2c20  n([self.index], 
-00027c40: 7365 6c66 2e5f 696e 7661 7269 616e 7473  self._invariants
-00027c50: 2c20 7365 6c66 2e5f 6465 7065 6e64 656e  , self._dependen
-00027c60: 6369 6573 2929 7d0a 2020 2020 2020 2020  cies))}.        
-00027c70: 7265 7475 726e 2074 7570 6c65 2828 6465  return tuple((de
-00027c80: 702c 2074 7570 6c65 286d 6170 2869 6e64  p, tuple(map(ind
-00027c90: 6963 6573 2e5f 5f67 6574 6974 656d 5f5f  ices.__getitem__
-00027ca0: 2c20 6465 702e 5f45 7661 6c75 6162 6c65  , dep._Evaluable
-00027cb0: 5f5f 6172 6773 2929 2920 666f 7220 6465  __args))) for de
-00027cc0: 7020 696e 2073 656c 662e 5f64 6570 656e  p in self._depen
-00027cd0: 6465 6e63 6965 7329 0a0a 2020 2020 2320  dencies)..    # 
-00027ce0: 5468 6973 2070 726f 7065 7274 7920 6973  This property is
-00027cf0: 2061 2064 6572 6976 6174 696f 6e20 6f66   a derivation of
-00027d00: 2060 5f73 6572 6961 6c69 7a65 6460 2077   `_serialized` w
-00027d10: 6865 7265 2074 6865 2060 4576 616c 7561  here the `Evalua
-00027d20: 626c 6560 0a20 2020 2023 2069 6e73 7461  ble`.    # insta
-00027d30: 6e63 6573 2061 7265 206d 6170 7065 6420  nces are mapped 
-00027d40: 746f 2074 6865 2060 6576 616c 6660 206d  to the `evalf` m
-00027d50: 6574 686f 6473 206f 6620 7468 6520 696e  ethods of the in
-00027d60: 7374 616e 6365 732e 2041 7373 6572 7469  stances. Asserti
-00027d70: 6e67 0a20 2020 2023 2074 6861 7420 6675  ng.    # that fu
-00027d80: 6e63 7469 6f6e 7320 6172 6520 696d 6d75  nctions are immu
-00027d90: 7461 626c 6520 6973 2064 6966 6669 6375  table is difficu
-00027da0: 6c74 2061 6e64 2063 7572 7265 6e74 6c79  lt and currently
-00027db0: 0a20 2020 2023 2060 7479 7065 732e 5f69  .    # `types._i
-00027dc0: 7369 6d6d 7574 6162 6c65 6020 6d61 726b  simmutable` mark
-00027dd0: 7320 616c 6c20 6675 6e63 7469 6f6e 7320  s all functions 
-00027de0: 6173 206d 7574 6162 6c65 2e20 5369 6e63  as mutable. Sinc
-00027df0: 6520 7468 650a 2020 2020 2320 6074 7970  e the.    # `typ
-00027e00: 6573 2e43 6163 6865 4d65 7461 6020 6d61  es.CacheMeta` ma
-00027e10: 6368 696e 6572 7920 6173 7365 7274 7320  chinery asserts 
-00027e20: 696d 6d75 7461 6269 6c69 7479 206f 6620  immutability of 
-00027e30: 7468 6520 7072 6f70 6572 7479 2c20 7765  the property, we
-00027e40: 2068 6176 650a 2020 2020 2320 746f 2072   have.    # to r
-00027e50: 6573 6f72 7420 746f 2061 2072 6567 756c  esort to a regul
-00027e60: 6172 2060 6675 6e63 746f 6f6c 732e 6361  ar `functools.ca
-00027e70: 6368 6564 5f70 726f 7065 7274 7960 2e20  ched_property`. 
-00027e80: 4e65 7665 7274 6865 6c65 7373 2c20 7468  Nevertheless, th
-00027e90: 6973 0a20 2020 2023 2070 726f 7065 7274  is.    # propert
-00027ea0: 7920 7368 6f75 6c64 2062 6520 7472 6561  y should be trea
-00027eb0: 7465 6420 6173 2069 6620 6974 2069 7320  ted as if it is 
-00027ec0: 696d 6d75 7461 626c 652e 0a20 2020 2040  immutable..    @
-00027ed0: 6361 6368 6564 5f70 726f 7065 7274 790a  cached_property.
-00027ee0: 2020 2020 6465 6620 5f73 6572 6961 6c69      def _seriali
-00027ef0: 7a65 645f 6c6f 6f70 5f65 7661 6c66 2873  zed_loop_evalf(s
-00027f00: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-00027f10: 7475 726e 2074 7570 6c65 2828 6465 702e  turn tuple((dep.
-00027f20: 6576 616c 662c 2069 6e64 6963 6573 2920  evalf, indices) 
-00027f30: 666f 7220 6465 702c 2069 6e64 6963 6573  for dep, indices
-00027f40: 2069 6e20 7365 6c66 2e5f 7365 7269 616c   in self._serial
-00027f50: 697a 6564 5f6c 6f6f 7029 0a0a 2020 2020  ized_loop)..    
-00027f60: 6465 6620 6576 616c 6628 7365 6c66 2c20  def evalf(self, 
-00027f70: 7368 6170 652c 206c 656e 6774 682c 202a  shape, length, *
-00027f80: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
-00027f90: 6572 6961 6c69 7a65 645f 6576 616c 6620  erialized_evalf 
-00027fa0: 3d20 7365 6c66 2e5f 7365 7269 616c 697a  = self._serializ
-00027fb0: 6564 5f6c 6f6f 705f 6576 616c 660a 2020  ed_loop_evalf.  
-00027fc0: 2020 2020 2020 7265 7375 6c74 203d 206e        result = n
-00027fd0: 756d 7079 2e7a 6572 6f73 2873 6861 7065  umpy.zeros(shape
-00027fe0: 2c20 7365 6c66 2e64 7479 7065 290a 2020  , self.dtype).  
-00027ff0: 2020 2020 2020 666f 7220 696e 6465 7820        for index 
-00028000: 696e 2072 616e 6765 286c 656e 6774 6829  in range(length)
-00028010: 3a0a 2020 2020 2020 2020 2020 2020 7661  :.            va
-00028020: 6c75 6573 203d 205b 6e75 6d70 792e 6172  lues = [numpy.ar
-00028030: 7261 7928 696e 6465 7829 5d0a 2020 2020  ray(index)].    
-00028040: 2020 2020 2020 2020 7661 6c75 6573 2e65          values.e
-00028050: 7874 656e 6428 6172 6773 290a 2020 2020  xtend(args).    
-00028060: 2020 2020 2020 2020 7661 6c75 6573 2e65          values.e
-00028070: 7874 656e 6428 6f70 5f65 7661 6c66 282a  xtend(op_evalf(*
-00028080: 5b76 616c 7565 735b 695d 2066 6f72 2069  [values[i] for i
-00028090: 2069 6e20 696e 6469 6365 735d 2920 666f   in indices]) fo
-000280a0: 7220 6f70 5f65 7661 6c66 2c20 696e 6469  r op_evalf, indi
-000280b0: 6365 7320 696e 2073 6572 6961 6c69 7a65  ces in serialize
-000280c0: 645f 6576 616c 6629 0a20 2020 2020 2020  d_evalf).       
-000280d0: 2020 2020 2072 6573 756c 7420 2b3d 2076       result += v
-000280e0: 616c 7565 735b 2d31 5d0a 2020 2020 2020  alues[-1].      
-000280f0: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
-00028100: 0a20 2020 2064 6566 2065 7661 6c66 5f77  .    def evalf_w
-00028110: 6974 6874 696d 6573 2873 656c 662c 2074  ithtimes(self, t
-00028120: 696d 6573 2c20 7368 6170 652c 206c 656e  imes, shape, len
-00028130: 6774 682c 202a 6172 6773 293a 0a20 2020  gth, *args):.   
-00028140: 2020 2020 2073 6572 6961 6c69 7a65 6420       serialized 
-00028150: 3d20 7365 6c66 2e5f 7365 7269 616c 697a  = self._serializ
-00028160: 6564 5f6c 6f6f 700a 2020 2020 2020 2020  ed_loop.        
-00028170: 7375 6274 696d 6573 203d 2074 696d 6573  subtimes = times
-00028180: 2e73 6574 6465 6661 756c 7428 7365 6c66  .setdefault(self
-00028190: 2c20 636f 6c6c 6563 7469 6f6e 732e 6465  , collections.de
-000281a0: 6661 756c 7464 6963 7428 5f53 7461 7473  faultdict(_Stats
-000281b0: 2929 0a20 2020 2020 2020 2072 6573 756c  )).        resul
-000281c0: 7420 3d20 6e75 6d70 792e 7a65 726f 7328  t = numpy.zeros(
-000281d0: 7368 6170 652c 2073 656c 662e 6474 7970  shape, self.dtyp
-000281e0: 6529 0a20 2020 2020 2020 2066 6f72 2069  e).        for i
-000281f0: 6e64 6578 2069 6e20 7261 6e67 6528 6c65  ndex in range(le
-00028200: 6e67 7468 293a 0a20 2020 2020 2020 2020  ngth):.         
-00028210: 2020 2076 616c 7565 7320 3d20 5b6e 756d     values = [num
-00028220: 7079 2e61 7272 6179 2869 6e64 6578 295d  py.array(index)]
-00028230: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
-00028240: 7565 732e 6578 7465 6e64 2861 7267 7329  ues.extend(args)
-00028250: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
-00028260: 7565 732e 6578 7465 6e64 286f 702e 6576  ues.extend(op.ev
-00028270: 616c 665f 7769 7468 7469 6d65 7328 7375  alf_withtimes(su
-00028280: 6274 696d 6573 2c20 2a5b 7661 6c75 6573  btimes, *[values
-00028290: 5b69 5d20 666f 7220 6920 696e 2069 6e64  [i] for i in ind
-000282a0: 6963 6573 5d29 2066 6f72 206f 702c 2069  ices]) for op, i
-000282b0: 6e64 6963 6573 2069 6e20 7365 7269 616c  ndices in serial
-000282c0: 697a 6564 290a 2020 2020 2020 2020 2020  ized).          
-000282d0: 2020 7265 7375 6c74 202b 3d20 7661 6c75    result += valu
-000282e0: 6573 5b2d 315d 0a20 2020 2020 2020 2072  es[-1].        r
-000282f0: 6574 7572 6e20 7265 7375 6c74 0a0a 2020  eturn result..  
-00028300: 2020 6465 6620 5f64 6572 6976 6174 6976    def _derivativ
-00028310: 6528 7365 6c66 2c20 7661 722c 2073 6565  e(self, var, see
-00028320: 6e29 3a0a 2020 2020 2020 2020 7265 7475  n):.        retu
-00028330: 726e 206c 6f6f 705f 7375 6d28 6465 7269  rn loop_sum(deri
-00028340: 7661 7469 7665 2873 656c 662e 6675 6e63  vative(self.func
-00028350: 2c20 7661 722c 2073 6565 6e29 2c20 7365  , var, seen), se
-00028360: 6c66 2e69 6e64 6578 290a 0a20 2020 2064  lf.index)..    d
-00028370: 6566 205f 6e6f 6465 2873 656c 662c 2063  ef _node(self, c
-00028380: 6163 6865 2c20 7375 6267 7261 7068 2c20  ache, subgraph, 
-00028390: 7469 6d65 7329 3a0a 2020 2020 2020 2020  times):.        
-000283a0: 6966 2073 656c 6620 696e 2063 6163 6865  if self in cache
-000283b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000283c0: 7475 726e 2063 6163 6865 5b73 656c 665d  turn cache[self]
-000283d0: 0a20 2020 2020 2020 2073 7562 6361 6368  .        subcach
-000283e0: 6520 3d20 7b7d 0a20 2020 2020 2020 2066  e = {}.        f
-000283f0: 6f72 2061 7267 2069 6e20 7365 6c66 2e5f  or arg in self._
-00028400: 4576 616c 7561 626c 655f 5f61 7267 733a  Evaluable__args:
-00028410: 0a20 2020 2020 2020 2020 2020 2073 7562  .            sub
-00028420: 6361 6368 655b 6172 675d 203d 2061 7267  cache[arg] = arg
-00028430: 2e5f 6e6f 6465 2863 6163 6865 2c20 7375  ._node(cache, su
-00028440: 6267 7261 7068 2c20 7469 6d65 7329 0a20  bgraph, times). 
-00028450: 2020 2020 2020 206c 6f6f 7067 7261 7068         loopgraph
-00028460: 203d 2053 7562 6772 6170 6828 274c 6f6f   = Subgraph('Loo
-00028470: 7027 2c20 7375 6267 7261 7068 290a 2020  p', subgraph).  
-00028480: 2020 2020 2020 7375 6274 696d 6573 203d        subtimes =
-00028490: 2074 696d 6573 2e67 6574 2873 656c 662c   times.get(self,
-000284a0: 2063 6f6c 6c65 6374 696f 6e73 2e64 6566   collections.def
-000284b0: 6175 6c74 6469 6374 285f 5374 6174 7329  aultdict(_Stats)
-000284c0: 290a 2020 2020 2020 2020 7375 6d5f 6b77  ).        sum_kw
-000284d0: 6172 6773 203d 207b 2773 6861 7065 5b7b  args = {'shape[{
-000284e0: 7d5d 272e 666f 726d 6174 2869 293a 206e  }]'.format(i): n
-000284f0: 2e5f 6e6f 6465 2863 6163 6865 2c20 7375  ._node(cache, su
-00028500: 6267 7261 7068 2c20 7469 6d65 7329 2066  bgraph, times) f
-00028510: 6f72 2069 2c20 6e20 696e 2065 6e75 6d65  or i, n in enume
-00028520: 7261 7465 2873 656c 662e 7368 6170 6529  rate(self.shape)
-00028530: 7d0a 2020 2020 2020 2020 7375 6d5f 6b77  }.        sum_kw
-00028540: 6172 6773 5b27 6675 6e63 275d 203d 2073  args['func'] = s
-00028550: 656c 662e 6675 6e63 2e5f 6e6f 6465 2873  elf.func._node(s
-00028560: 7562 6361 6368 652c 206c 6f6f 7067 7261  ubcache, loopgra
-00028570: 7068 2c20 7375 6274 696d 6573 290a 2020  ph, subtimes).  
-00028580: 2020 2020 2020 6361 6368 655b 7365 6c66        cache[self
-00028590: 5d20 3d20 6e6f 6465 203d 2052 6567 756c  ] = node = Regul
-000285a0: 6172 4e6f 6465 2827 4c6f 6f70 5375 6d27  arNode('LoopSum'
-000285b0: 2c20 2829 2c20 7375 6d5f 6b77 6172 6773  , (), sum_kwargs
-000285c0: 2c20 2874 7970 6528 7365 6c66 292e 5f5f  , (type(self).__
-000285d0: 6e61 6d65 5f5f 2c20 7375 6274 696d 6573  name__, subtimes
-000285e0: 5b27 7375 6d27 5d29 2c20 6c6f 6f70 6772  ['sum']), loopgr
-000285f0: 6170 6829 0a20 2020 2020 2020 2072 6574  aph).        ret
-00028600: 7572 6e20 6e6f 6465 0a0a 2020 2020 6465  urn node..    de
-00028610: 6620 5f73 696d 706c 6966 6965 6428 7365  f _simplified(se
-00028620: 6c66 293a 0a20 2020 2020 2020 2069 6620  lf):.        if 
-00028630: 6973 7a65 726f 2873 656c 662e 6675 6e63  iszero(self.func
-00028640: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00028650: 6574 7572 6e20 7a65 726f 735f 6c69 6b65  eturn zeros_like
-00028660: 2873 656c 6629 0a20 2020 2020 2020 2065  (self).        e
-00028670: 6c69 6620 7365 6c66 2e69 6e64 6578 206e  lif self.index n
-00028680: 6f74 2069 6e20 7365 6c66 2e66 756e 632e  ot in self.func.
-00028690: 6172 6775 6d65 6e74 733a 0a20 2020 2020  arguments:.     
-000286a0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000286b0: 6c66 2e66 756e 6320 2a20 7365 6c66 2e69  lf.func * self.i
-000286c0: 6e64 6578 2e6c 656e 6774 680a 2020 2020  ndex.length.    
-000286d0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-000286e0: 6675 6e63 2e5f 6c6f 6f70 7375 6d28 7365  func._loopsum(se
-000286f0: 6c66 2e69 6e64 6578 290a 0a20 2020 2064  lf.index)..    d
-00028700: 6566 205f 7461 6b65 6469 6167 2873 656c  ef _takediag(sel
-00028710: 662c 2061 7869 7331 2c20 6178 6973 3229  f, axis1, axis2)
-00028720: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00028730: 206c 6f6f 705f 7375 6d28 5f74 616b 6564   loop_sum(_taked
-00028740: 6961 6728 7365 6c66 2e66 756e 632c 2061  iag(self.func, a
-00028750: 7869 7331 2c20 6178 6973 3229 2c20 7365  xis1, axis2), se
-00028760: 6c66 2e69 6e64 6578 290a 0a20 2020 2064  lf.index)..    d
-00028770: 6566 205f 7461 6b65 2873 656c 662c 2069  ef _take(self, i
-00028780: 6e64 6578 2c20 6178 6973 293a 0a20 2020  ndex, axis):.   
-00028790: 2020 2020 2072 6574 7572 6e20 6c6f 6f70       return loop
-000287a0: 5f73 756d 285f 7461 6b65 2873 656c 662e  _sum(_take(self.
-000287b0: 6675 6e63 2c20 696e 6465 782c 2061 7869  func, index, axi
-000287c0: 7329 2c20 7365 6c66 2e69 6e64 6578 290a  s), self.index).
-000287d0: 0a20 2020 2064 6566 205f 756e 7261 7665  .    def _unrave
-000287e0: 6c28 7365 6c66 2c20 6178 6973 2c20 7368  l(self, axis, sh
-000287f0: 6170 6529 3a0a 2020 2020 2020 2020 7265  ape):.        re
-00028800: 7475 726e 206c 6f6f 705f 7375 6d28 756e  turn loop_sum(un
-00028810: 7261 7665 6c28 7365 6c66 2e66 756e 632c  ravel(self.func,
-00028820: 2061 7869 732c 2073 6861 7065 292c 2073   axis, shape), s
-00028830: 656c 662e 696e 6465 7829 0a0a 2020 2020  elf.index)..    
-00028840: 6465 6620 5f73 756d 2873 656c 662c 2061  def _sum(self, a
-00028850: 7869 7329 3a0a 2020 2020 2020 2020 7265  xis):.        re
-00028860: 7475 726e 206c 6f6f 705f 7375 6d28 7375  turn loop_sum(su
-00028870: 6d28 7365 6c66 2e66 756e 632c 2061 7869  m(self.func, axi
-00028880: 7329 2c20 7365 6c66 2e69 6e64 6578 290a  s), self.index).
-00028890: 0a20 2020 2064 6566 205f 6164 6428 7365  .    def _add(se
-000288a0: 6c66 2c20 6f74 6865 7229 3a0a 2020 2020  lf, other):.    
-000288b0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-000288c0: 6528 6f74 6865 722c 204c 6f6f 7053 756d  e(other, LoopSum
-000288d0: 2920 616e 6420 6f74 6865 722e 696e 6465  ) and other.inde
-000288e0: 7820 3d3d 2073 656c 662e 696e 6465 783a  x == self.index:
-000288f0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00028900: 7572 6e20 6c6f 6f70 5f73 756d 2873 656c  urn loop_sum(sel
-00028910: 662e 6675 6e63 202b 206f 7468 6572 2e66  f.func + other.f
-00028920: 756e 632c 2073 656c 662e 696e 6465 7829  unc, self.index)
-00028930: 0a0a 2020 2020 6465 6620 5f6d 756c 7469  ..    def _multi
-00028940: 706c 7928 7365 6c66 2c20 6f74 6865 7229  ply(self, other)
-00028950: 3a0a 2020 2020 2020 2020 2320 4966 2060  :.        # If `
-00028960: 6f74 6865 7260 2064 6570 656e 6473 206f  other` depends o
-00028970: 6e20 6073 656c 662e 696e 6465 7860 2c20  n `self.index`, 
-00028980: 652e 672e 2062 6563 6175 7365 2060 7365  e.g. because `se
-00028990: 6c66 6020 6973 2074 6865 2069 6e6e 6572  lf` is the inner
-000289a0: 0a20 2020 2020 2020 2023 206c 6f6f 7020  .        # loop 
-000289b0: 6f66 2074 776f 206e 6573 7465 6420 604c  of two nested `L
-000289c0: 6f6f 7053 756d 6073 206f 7665 7220 7468  oopSum`s over th
-000289d0: 6520 7361 6d65 2069 6e64 6578 2c20 7468  e same index, th
-000289e0: 656e 2077 6520 7368 6f75 6c64 206e 6f74  en we should not
-000289f0: 0a20 2020 2020 2020 2023 206d 6f76 6520  .        # move 
-00028a00: 606f 7468 6572 6020 696e 7369 6465 2074  `other` inside t
-00028a10: 6869 7320 6c6f 6f70 2e0a 2020 2020 2020  his loop..      
-00028a20: 2020 6966 2073 656c 662e 696e 6465 7820    if self.index 
-00028a30: 6e6f 7420 696e 206f 7468 6572 2e61 7267  not in other.arg
-00028a40: 756d 656e 7473 3a0a 2020 2020 2020 2020  uments:.        
-00028a50: 2020 2020 7265 7475 726e 206c 6f6f 705f      return loop_
-00028a60: 7375 6d28 7365 6c66 2e66 756e 6320 2a20  sum(self.func * 
-00028a70: 6f74 6865 722c 2073 656c 662e 696e 6465  other, self.inde
-00028a80: 7829 0a0a 2020 2020 4063 6163 6865 645f  x)..    @cached_
-00028a90: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00028aa0: 205f 6173 7370 6172 7365 2873 656c 6629   _assparse(self)
-00028ab0: 3a0a 2020 2020 2020 2020 6368 756e 6b73  :.        chunks
-00028ac0: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
-00028ad0: 7220 2a65 6c65 6d5f 696e 6469 6365 732c  r *elem_indices,
-00028ae0: 2065 6c65 6d5f 7661 6c75 6573 2069 6e20   elem_values in 
-00028af0: 7365 6c66 2e66 756e 632e 5f61 7373 7061  self.func._asspa
-00028b00: 7273 653a 0a20 2020 2020 2020 2020 2020  rse:.           
-00028b10: 2069 6620 7365 6c66 2e6e 6469 6d20 3d3d   if self.ndim ==
-00028b20: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00028b30: 2020 2020 7661 6c75 6573 203d 206c 6f6f      values = loo
-00028b40: 705f 636f 6e63 6174 656e 6174 6528 496e  p_concatenate(In
-00028b50: 7365 7274 4178 6973 2865 6c65 6d5f 7661  sertAxis(elem_va
-00028b60: 6c75 6573 2c20 636f 6e73 7461 6e74 2831  lues, constant(1
-00028b70: 2929 2c20 7365 6c66 2e69 6e64 6578 290a  )), self.index).
-00028b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028b90: 7768 696c 6520 7661 6c75 6573 2e6e 6469  while values.ndi
-00028ba0: 6d3a 0a20 2020 2020 2020 2020 2020 2020  m:.             
-00028bb0: 2020 2020 2020 2076 616c 7565 7320 3d20         values = 
-00028bc0: 5375 6d28 7661 6c75 6573 290a 2020 2020  Sum(values).    
-00028bd0: 2020 2020 2020 2020 2020 2020 6368 756e              chun
-00028be0: 6b73 2e61 7070 656e 6428 2876 616c 7565  ks.append((value
-00028bf0: 732c 2929 0a20 2020 2020 2020 2020 2020  s,)).           
-00028c00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00028c10: 2020 2020 2020 2069 6620 656c 656d 5f76         if elem_v
-00028c20: 616c 7565 732e 6e64 696d 203d 3d20 303a  alues.ndim == 0:
-00028c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028c40: 2020 2020 202a 656c 656d 5f69 6e64 6963       *elem_indic
-00028c50: 6573 2c20 656c 656d 5f76 616c 7565 7320  es, elem_values 
-00028c60: 3d20 2849 6e73 6572 7441 7869 7328 6172  = (InsertAxis(ar
-00028c70: 722c 2063 6f6e 7374 616e 7428 3129 2920  r, constant(1)) 
-00028c80: 666f 7220 6172 7220 696e 2028 2a65 6c65  for arr in (*ele
-00028c90: 6d5f 696e 6469 6365 732c 2065 6c65 6d5f  m_indices, elem_
-00028ca0: 7661 6c75 6573 2929 0a20 2020 2020 2020  values)).       
-00028cb0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00028cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028cd0: 2020 2023 206d 696e 696d 697a 6520 7261     # minimize ra
-00028ce0: 7665 6c73 2062 7920 7472 616e 7370 6f73  vels by transpos
-00028cf0: 696e 6720 616c 6c20 7661 7269 6162 6c65  ing all variable
-00028d00: 206c 656e 6774 6820 6178 6573 2074 6f20   length axes to 
-00028d10: 7468 6520 656e 640a 2020 2020 2020 2020  the end.        
-00028d20: 2020 2020 2020 2020 2020 2020 7661 7269              vari
-00028d30: 6162 6c65 203d 2074 7570 6c65 2869 2066  able = tuple(i f
-00028d40: 6f72 2069 2c20 6e20 696e 2065 6e75 6d65  or i, n in enume
-00028d50: 7261 7465 2865 6c65 6d5f 7661 6c75 6573  rate(elem_values
-00028d60: 2e73 6861 7065 2920 6966 2073 656c 662e  .shape) if self.
-00028d70: 696e 6465 7820 696e 206e 2e61 7267 756d  index in n.argum
-00028d80: 656e 7473 290a 2020 2020 2020 2020 2020  ents).          
-00028d90: 2020 2020 2020 2020 2020 2a65 6c65 6d5f            *elem_
-00028da0: 696e 6469 6365 732c 2065 6c65 6d5f 7661  indices, elem_va
-00028db0: 6c75 6573 203d 2028 5472 616e 7370 6f73  lues = (Transpos
-00028dc0: 652e 746f 5f65 6e64 2861 7272 2c20 2a76  e.to_end(arr, *v
-00028dd0: 6172 6961 626c 6529 2066 6f72 2061 7272  ariable) for arr
-00028de0: 2069 6e20 282a 656c 656d 5f69 6e64 6963   in (*elem_indic
-00028df0: 6573 2c20 656c 656d 5f76 616c 7565 7329  es, elem_values)
-00028e00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00028e10: 2020 2020 2020 666f 7220 6920 696e 2076        for i in v
-00028e20: 6172 6961 626c 655b 3a2d 315d 3a0a 2020  ariable[:-1]:.  
-00028e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e40: 2020 2020 2020 2a65 6c65 6d5f 696e 6469        *elem_indi
-00028e50: 6365 732c 2065 6c65 6d5f 7661 6c75 6573  ces, elem_values
-00028e60: 203d 206d 6170 2852 6176 656c 2c20 282a   = map(Ravel, (*
-00028e70: 656c 656d 5f69 6e64 6963 6573 2c20 656c  elem_indices, el
-00028e80: 656d 5f76 616c 7565 7329 290a 2020 2020  em_values)).    
+00013410: 292c 206d 6178 2830 2c20 7570 7065 725f  ), max(0, upper_
+00013420: 6675 6e63 202a 2075 7070 6572 5f6c 656e  func * upper_len
+00013430: 6774 6829 0a20 2020 2020 2020 2065 6c73  gth).        els
+00013440: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00013450: 6574 7572 6e20 6d69 6e28 6c6f 7765 725f  eturn min(lower_
+00013460: 6675 6e63 202a 206c 6f77 6572 5f6c 656e  func * lower_len
+00013470: 6774 682c 206c 6f77 6572 5f66 756e 6320  gth, lower_func 
+00013480: 2a20 7570 7065 725f 6c65 6e67 7468 292c  * upper_length),
+00013490: 206d 6178 2875 7070 6572 5f66 756e 6320   max(upper_func 
+000134a0: 2a20 6c6f 7765 725f 6c65 6e67 7468 2c20  * lower_length, 
+000134b0: 7570 7065 725f 6675 6e63 202a 2075 7070  upper_func * upp
+000134c0: 6572 5f6c 656e 6774 6829 0a0a 0a63 6c61  er_length)...cla
+000134d0: 7373 2054 616b 6544 6961 6728 4172 7261  ss TakeDiag(Arra
+000134e0: 7929 3a0a 0a20 2020 2064 6566 205f 5f69  y):..    def __i
+000134f0: 6e69 745f 5f28 7365 6c66 2c20 6675 6e63  nit__(self, func
+00013500: 3a20 4172 7261 7929 3a0a 2020 2020 2020  : Array):.      
+00013510: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00013520: 6e63 6528 6675 6e63 2c20 4172 7261 7929  nce(func, Array)
+00013530: 2061 6e64 2066 756e 632e 6e64 696d 203e   and func.ndim >
+00013540: 3d20 3220 616e 6420 5f65 7175 616c 735f  = 2 and _equals_
+00013550: 7369 6d70 6c69 6669 6564 282a 6675 6e63  simplified(*func
+00013560: 2e73 6861 7065 5b2d 323a 5d29 2c20 6627  .shape[-2:]), f'
+00013570: 6675 6e63 3d7b 6675 6e63 2172 7d27 0a20  func={func!r}'. 
+00013580: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
+00013590: 203d 2066 756e 630a 2020 2020 2020 2020   = func.        
+000135a0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+000135b0: 2861 7267 733d 2866 756e 632c 292c 2073  (args=(func,), s
+000135c0: 6861 7065 3d66 756e 632e 7368 6170 655b  hape=func.shape[
+000135d0: 3a2d 315d 2c20 6474 7970 653d 6675 6e63  :-1], dtype=func
+000135e0: 2e64 7479 7065 290a 0a20 2020 2064 6566  .dtype)..    def
+000135f0: 205f 7369 6d70 6c69 6669 6564 2873 656c   _simplified(sel
+00013600: 6629 3a0a 2020 2020 2020 2020 6966 205f  f):.        if _
+00013610: 6571 7561 6c73 5f73 6361 6c61 725f 636f  equals_scalar_co
+00013620: 6e73 7461 6e74 2873 656c 662e 7368 6170  nstant(self.shap
+00013630: 655b 2d31 5d2c 2031 293a 0a20 2020 2020  e[-1], 1):.     
+00013640: 2020 2020 2020 2072 6574 7572 6e20 5461         return Ta
+00013650: 6b65 2873 656c 662e 6675 6e63 2c20 636f  ke(self.func, co
+00013660: 6e73 7461 6e74 2830 2929 0a20 2020 2020  nstant(0)).     
+00013670: 2020 2072 6574 7572 6e20 7365 6c66 2e66     return self.f
+00013680: 756e 632e 5f74 616b 6564 6961 6728 7365  unc._takediag(se
+00013690: 6c66 2e6e 6469 6d2d 312c 2073 656c 662e  lf.ndim-1, self.
+000136a0: 6e64 696d 290a 0a20 2020 2040 7374 6174  ndim)..    @stat
+000136b0: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+000136c0: 2065 7661 6c66 2861 7272 293a 0a20 2020   evalf(arr):.   
+000136d0: 2020 2020 2072 6574 7572 6e20 6e75 6d70       return nump
+000136e0: 792e 6569 6e73 756d 2827 2e2e 2e6b 6b2d  y.einsum('...kk-
+000136f0: 3e2e 2e2e 6b27 2c20 6172 722c 206f 7074  >...k', arr, opt
+00013700: 696d 697a 653d 4661 6c73 6529 0a0a 2020  imize=False)..  
+00013710: 2020 6465 6620 5f64 6572 6976 6174 6976    def _derivativ
+00013720: 6528 7365 6c66 2c20 7661 722c 2073 6565  e(self, var, see
+00013730: 6e29 3a0a 2020 2020 2020 2020 7265 7475  n):.        retu
+00013740: 726e 2074 616b 6564 6961 6728 6465 7269  rn takediag(deri
+00013750: 7661 7469 7665 2873 656c 662e 6675 6e63  vative(self.func
+00013760: 2c20 7661 722c 2073 6565 6e29 2c20 7365  , var, seen), se
+00013770: 6c66 2e6e 6469 6d2d 312c 2073 656c 662e  lf.ndim-1, self.
+00013780: 6e64 696d 290a 0a20 2020 2064 6566 205f  ndim)..    def _
+00013790: 7461 6b65 2873 656c 662c 2069 6e64 6578  take(self, index
+000137a0: 2c20 6178 6973 293a 0a20 2020 2020 2020  , axis):.       
+000137b0: 2069 6620 6178 6973 203c 2073 656c 662e   if axis < self.
+000137c0: 6e64 696d 202d 2031 3a0a 2020 2020 2020  ndim - 1:.      
+000137d0: 2020 2020 2020 7265 7475 726e 2054 616b        return Tak
+000137e0: 6544 6961 6728 5f74 616b 6528 7365 6c66  eDiag(_take(self
+000137f0: 2e66 756e 632c 2069 6e64 6578 2c20 6178  .func, index, ax
+00013800: 6973 2929 0a20 2020 2020 2020 2066 756e  is)).        fun
+00013810: 6320 3d20 5f74 616b 6528 5461 6b65 2873  c = _take(Take(s
+00013820: 656c 662e 6675 6e63 2c20 696e 6465 7829  elf.func, index)
+00013830: 2c20 696e 6465 782c 2073 656c 662e 6e64  , index, self.nd
+00013840: 696d 2d31 290a 2020 2020 2020 2020 666f  im-1).        fo
+00013850: 7220 6920 696e 2072 6576 6572 7365 6428  r i in reversed(
+00013860: 7261 6e67 6528 7365 6c66 2e6e 6469 6d2d  range(self.ndim-
+00013870: 312c 2073 656c 662e 6e64 696d 2d31 2b69  1, self.ndim-1+i
+00013880: 6e64 6578 2e6e 6469 6d29 293a 0a20 2020  ndex.ndim)):.   
+00013890: 2020 2020 2020 2020 2066 756e 6320 3d20           func = 
+000138a0: 7461 6b65 6469 6167 2866 756e 632c 2069  takediag(func, i
+000138b0: 2c20 692b 696e 6465 782e 6e64 696d 290a  , i+index.ndim).
+000138c0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+000138d0: 756e 630a 0a20 2020 2064 6566 205f 7375  unc..    def _su
+000138e0: 6d28 7365 6c66 2c20 6178 6973 293a 0a20  m(self, axis):. 
+000138f0: 2020 2020 2020 2069 6620 6178 6973 2021         if axis !
+00013900: 3d20 7365 6c66 2e6e 6469 6d20 2d20 313a  = self.ndim - 1:
+00013910: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00013920: 7572 6e20 5461 6b65 4469 6167 2873 756d  urn TakeDiag(sum
+00013930: 2873 656c 662e 6675 6e63 2c20 6178 6973  (self.func, axis
+00013940: 2929 0a0a 2020 2020 6465 6620 5f69 6e74  ))..    def _int
+00013950: 626f 756e 6473 5f69 6d70 6c28 7365 6c66  bounds_impl(self
+00013960: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00013970: 6e20 7365 6c66 2e66 756e 632e 5f69 6e74  n self.func._int
+00013980: 626f 756e 6473 0a0a 0a63 6c61 7373 2054  bounds...class T
+00013990: 616b 6528 4172 7261 7929 3a0a 0a20 2020  ake(Array):..   
+000139a0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+000139b0: 6c66 2c20 6675 6e63 3a20 4172 7261 792c  lf, func: Array,
+000139c0: 2069 6e64 6963 6573 3a20 4172 7261 7929   indices: Array)
+000139d0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+000139e0: 2069 7369 6e73 7461 6e63 6528 6675 6e63   isinstance(func
+000139f0: 2c20 4172 7261 7929 2061 6e64 2066 756e  , Array) and fun
+00013a00: 632e 6e64 696d 203e 2030 2c20 6627 6675  c.ndim > 0, f'fu
+00013a10: 6e63 3d7b 6675 6e63 2172 7d27 0a20 2020  nc={func!r}'.   
+00013a20: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+00013a30: 7374 616e 6365 2869 6e64 6963 6573 2c20  stance(indices, 
+00013a40: 4172 7261 7929 2061 6e64 2069 6e64 6963  Array) and indic
+00013a50: 6573 2e64 7479 7065 203d 3d20 696e 742c  es.dtype == int,
+00013a60: 2066 2769 6e64 6963 6573 3d7b 696e 6469   f'indices={indi
+00013a70: 6365 7321 727d 270a 2020 2020 2020 2020  ces!r}'.        
+00013a80: 7365 6c66 2e66 756e 6320 3d20 6675 6e63  self.func = func
+00013a90: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
+00013aa0: 6469 6365 7320 3d20 696e 6469 6365 730a  dices = indices.
+00013ab0: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+00013ac0: 5f5f 696e 6974 5f5f 2861 7267 733d 2866  __init__(args=(f
+00013ad0: 756e 632c 2069 6e64 6963 6573 292c 2073  unc, indices), s
+00013ae0: 6861 7065 3d66 756e 632e 7368 6170 655b  hape=func.shape[
+00013af0: 3a2d 315d 2b69 6e64 6963 6573 2e73 6861  :-1]+indices.sha
+00013b00: 7065 2c20 6474 7970 653d 6675 6e63 2e64  pe, dtype=func.d
+00013b10: 7479 7065 290a 0a20 2020 2064 6566 205f  type)..    def _
+00013b20: 7369 6d70 6c69 6669 6564 2873 656c 6629  simplified(self)
+00013b30: 3a0a 2020 2020 2020 2020 6966 2061 6e79  :.        if any
+00013b40: 2869 737a 6572 6f28 6e29 2066 6f72 206e  (iszero(n) for n
+00013b50: 2069 6e20 7365 6c66 2e69 6e64 6963 6573   in self.indices
+00013b60: 2e73 6861 7065 293a 0a20 2020 2020 2020  .shape):.       
+00013b70: 2020 2020 2072 6574 7572 6e20 7a65 726f       return zero
+00013b80: 735f 6c69 6b65 2873 656c 6629 0a20 2020  s_like(self).   
+00013b90: 2020 2020 2075 6e61 6c69 676e 6564 2c20       unaligned, 
+00013ba0: 7768 6572 6520 3d20 756e 616c 6967 6e28  where = unalign(
+00013bb0: 7365 6c66 2e69 6e64 6963 6573 290a 2020  self.indices).  
+00013bc0: 2020 2020 2020 6966 206c 656e 2877 6865        if len(whe
+00013bd0: 7265 2920 3c20 7365 6c66 2e69 6e64 6963  re) < self.indic
+00013be0: 6573 2e6e 6469 6d3a 0a20 2020 2020 2020  es.ndim:.       
+00013bf0: 2020 2020 206e 203d 2073 656c 662e 6675       n = self.fu
+00013c00: 6e63 2e6e 6469 6d2d 310a 2020 2020 2020  nc.ndim-1.      
+00013c10: 2020 2020 2020 7265 7475 726e 2061 6c69        return ali
+00013c20: 676e 2854 616b 6528 7365 6c66 2e66 756e  gn(Take(self.fun
+00013c30: 632c 2075 6e61 6c69 676e 6564 292c 2028  c, unaligned), (
+00013c40: 2a72 616e 6765 286e 292c 202a 286e 2b69  *range(n), *(n+i
+00013c50: 2066 6f72 2069 2069 6e20 7768 6572 6529   for i in where)
+00013c60: 292c 2073 656c 662e 7368 6170 6529 0a20  ), self.shape). 
+00013c70: 2020 2020 2020 2074 7279 7461 6b65 203d         trytake =
+00013c80: 2073 656c 662e 6675 6e63 2e5f 7461 6b65   self.func._take
+00013c90: 2873 656c 662e 696e 6469 6365 732c 2073  (self.indices, s
+00013ca0: 656c 662e 6675 6e63 2e6e 6469 6d2d 3129  elf.func.ndim-1)
+00013cb0: 206f 7220 5c0a 2020 2020 2020 2020 2020   or \.          
+00013cc0: 2020 7365 6c66 2e69 6e64 6963 6573 2e5f    self.indices._
+00013cd0: 7274 616b 6528 7365 6c66 2e66 756e 632c  rtake(self.func,
+00013ce0: 2073 656c 662e 6675 6e63 2e6e 6469 6d2d   self.func.ndim-
+00013cf0: 3129 0a20 2020 2020 2020 2069 6620 7472  1).        if tr
+00013d00: 7974 616b 653a 0a20 2020 2020 2020 2020  ytake:.         
+00013d10: 2020 2072 6574 7572 6e20 7472 7974 616b     return trytak
+00013d20: 650a 2020 2020 2020 2020 666f 7220 6178  e.        for ax
+00013d30: 6973 2c20 7061 7274 7320 696e 2073 656c  is, parts in sel
+00013d40: 662e 6675 6e63 2e5f 696e 666c 6174 696f  f.func._inflatio
+00013d50: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00013d60: 6966 2061 7869 7320 3d3d 2073 656c 662e  if axis == self.
+00013d70: 6675 6e63 2e6e 6469 6d20 2d20 313a 0a20  func.ndim - 1:. 
+00013d80: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00013d90: 6574 7572 6e20 7574 696c 2e73 756d 2849  eturn util.sum(I
+00013da0: 6e66 6c61 7465 2866 756e 632c 2064 6f66  nflate(func, dof
+00013db0: 6d61 702c 2073 656c 662e 6675 6e63 2e73  map, self.func.s
+00013dc0: 6861 7065 5b2d 315d 292e 5f74 616b 6528  hape[-1])._take(
+00013dd0: 7365 6c66 2e69 6e64 6963 6573 2c20 7365  self.indices, se
+00013de0: 6c66 2e66 756e 632e 6e64 696d 202d 2031  lf.func.ndim - 1
+00013df0: 2920 666f 7220 646f 666d 6170 2c20 6675  ) for dofmap, fu
+00013e00: 6e63 2069 6e20 7061 7274 732e 6974 656d  nc in parts.item
+00013e10: 7328 2929 0a0a 2020 2020 4073 7461 7469  s())..    @stati
+00013e20: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
+00013e30: 6576 616c 6628 6172 722c 2069 6e64 6963  evalf(arr, indic
+00013e40: 6573 293a 0a20 2020 2020 2020 2072 6574  es):.        ret
+00013e50: 7572 6e20 6172 725b 2e2e 2e2c 2069 6e64  urn arr[..., ind
+00013e60: 6963 6573 5d0a 0a20 2020 2064 6566 205f  ices]..    def _
+00013e70: 6465 7269 7661 7469 7665 2873 656c 662c  derivative(self,
+00013e80: 2076 6172 2c20 7365 656e 293a 0a20 2020   var, seen):.   
+00013e90: 2020 2020 2072 6574 7572 6e20 5f74 616b       return _tak
+00013ea0: 6528 6465 7269 7661 7469 7665 2873 656c  e(derivative(sel
+00013eb0: 662e 6675 6e63 2c20 7661 722c 2073 6565  f.func, var, see
+00013ec0: 6e29 2c20 7365 6c66 2e69 6e64 6963 6573  n), self.indices
+00013ed0: 2c20 7365 6c66 2e66 756e 632e 6e64 696d  , self.func.ndim
+00013ee0: 2d31 290a 0a20 2020 2064 6566 205f 7461  -1)..    def _ta
+00013ef0: 6b65 2873 656c 662c 2069 6e64 6578 2c20  ke(self, index, 
+00013f00: 6178 6973 293a 0a20 2020 2020 2020 2069  axis):.        i
+00013f10: 6620 6178 6973 203e 3d20 7365 6c66 2e66  f axis >= self.f
+00013f20: 756e 632e 6e64 696d 2d31 3a0a 2020 2020  unc.ndim-1:.    
+00013f30: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+00013f40: 616b 6528 7365 6c66 2e66 756e 632c 205f  ake(self.func, _
+00013f50: 7461 6b65 2873 656c 662e 696e 6469 6365  take(self.indice
+00013f60: 732c 2069 6e64 6578 2c20 6178 6973 2d73  s, index, axis-s
+00013f70: 656c 662e 6675 6e63 2e6e 6469 6d2b 3129  elf.func.ndim+1)
+00013f80: 290a 2020 2020 2020 2020 7472 7974 616b  ).        trytak
+00013f90: 6520 3d20 7365 6c66 2e66 756e 632e 5f74  e = self.func._t
+00013fa0: 616b 6528 696e 6465 782c 2061 7869 7329  ake(index, axis)
+00013fb0: 0a20 2020 2020 2020 2069 6620 7472 7974  .        if tryt
+00013fc0: 616b 6520 6973 206e 6f74 204e 6f6e 653a  ake is not None:
+00013fd0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00013fe0: 7572 6e20 5461 6b65 2874 7279 7461 6b65  urn Take(trytake
+00013ff0: 2c20 7365 6c66 2e69 6e64 6963 6573 290a  , self.indices).
+00014000: 0a20 2020 2064 6566 205f 7375 6d28 7365  .    def _sum(se
+00014010: 6c66 2c20 6178 6973 293a 0a20 2020 2020  lf, axis):.     
+00014020: 2020 2069 6620 6178 6973 203c 2073 656c     if axis < sel
+00014030: 662e 6675 6e63 2e6e 6469 6d20 2d20 313a  f.func.ndim - 1:
+00014040: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00014050: 7572 6e20 5461 6b65 2873 756d 2873 656c  urn Take(sum(sel
+00014060: 662e 6675 6e63 2c20 6178 6973 292c 2073  f.func, axis), s
+00014070: 656c 662e 696e 6469 6365 7329 0a0a 2020  elf.indices)..  
+00014080: 2020 6465 6620 5f69 6e74 626f 756e 6473    def _intbounds
+00014090: 5f69 6d70 6c28 7365 6c66 293a 0a20 2020  _impl(self):.   
+000140a0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+000140b0: 2e66 756e 632e 5f69 6e74 626f 756e 6473  .func._intbounds
+000140c0: 0a0a 0a63 6c61 7373 2050 6f77 6572 2841  ...class Power(A
+000140d0: 7272 6179 293a 0a0a 2020 2020 6465 6620  rray):..    def 
+000140e0: 5f5f 696e 6974 5f5f 2873 656c 662c 2066  __init__(self, f
+000140f0: 756e 633a 2041 7272 6179 2c20 706f 7765  unc: Array, powe
+00014100: 723a 2041 7272 6179 293a 0a20 2020 2020  r: Array):.     
+00014110: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+00014120: 616e 6365 2866 756e 632c 2041 7272 6179  ance(func, Array
+00014130: 292c 2066 2766 756e 633d 7b66 756e 6321  ), f'func={func!
+00014140: 727d 270a 2020 2020 2020 2020 6173 7365  r}'.        asse
+00014150: 7274 2069 7369 6e73 7461 6e63 6528 706f  rt isinstance(po
+00014160: 7765 722c 2041 7272 6179 2920 616e 6420  wer, Array) and 
+00014170: 2870 6f77 6572 2e64 7479 7065 2069 6e20  (power.dtype in 
+00014180: 2866 6c6f 6174 2c20 636f 6d70 6c65 7829  (float, complex)
+00014190: 206f 7220 706f 7765 722e 6474 7970 6520   or power.dtype 
+000141a0: 3d3d 2069 6e74 2061 6e64 2070 6f77 6572  == int and power
+000141b0: 2e5f 696e 7462 6f75 6e64 735b 305d 203e  ._intbounds[0] >
+000141c0: 3d20 3029 2c20 6627 706f 7765 723d 7b70  = 0), f'power={p
+000141d0: 6f77 6572 2172 7d27 0a20 2020 2020 2020  ower!r}'.       
+000141e0: 2061 7373 6572 7420 6571 7561 6c73 6861   assert equalsha
+000141f0: 7065 2866 756e 632e 7368 6170 652c 2070  pe(func.shape, p
+00014200: 6f77 6572 2e73 6861 7065 2920 616e 6420  ower.shape) and 
+00014210: 6675 6e63 2e64 7479 7065 203d 3d20 706f  func.dtype == po
+00014220: 7765 722e 6474 7970 652c 2027 506f 7765  wer.dtype, 'Powe
+00014230: 7228 7b7d 2c20 7b7d 2927 2e66 6f72 6d61  r({}, {})'.forma
+00014240: 7428 6675 6e63 2c20 706f 7765 7229 0a20  t(func, power). 
+00014250: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
+00014260: 203d 2066 756e 630a 2020 2020 2020 2020   = func.        
+00014270: 7365 6c66 2e70 6f77 6572 203d 2070 6f77  self.power = pow
+00014280: 6572 0a20 2020 2020 2020 2073 7570 6572  er.        super
+00014290: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
+000142a0: 3d28 6675 6e63 2c20 706f 7765 7229 2c20  =(func, power), 
+000142b0: 7368 6170 653d 6675 6e63 2e73 6861 7065  shape=func.shape
+000142c0: 2c20 6474 7970 653d 6675 6e63 2e64 7479  , dtype=func.dty
+000142d0: 7065 290a 0a20 2020 2064 6566 205f 7369  pe)..    def _si
+000142e0: 6d70 6c69 6669 6564 2873 656c 6629 3a0a  mplified(self):.
+000142f0: 2020 2020 2020 2020 6966 2069 737a 6572          if iszer
+00014300: 6f28 7365 6c66 2e70 6f77 6572 293a 0a20  o(self.power):. 
+00014310: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00014320: 6e20 6f6e 6573 5f6c 696b 6528 7365 6c66  n ones_like(self
+00014330: 290a 2020 2020 2020 2020 7020 3d20 7365  ).        p = se
+00014340: 6c66 2e70 6f77 6572 2e5f 636f 6e73 745f  lf.power._const_
+00014350: 756e 6966 6f72 6d0a 2020 2020 2020 2020  uniform.        
+00014360: 6966 2070 203d 3d20 313a 0a20 2020 2020  if p == 1:.     
+00014370: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00014380: 6c66 2e66 756e 630a 2020 2020 2020 2020  lf.func.        
+00014390: 656c 6966 2070 203d 3d20 323a 0a20 2020  elif p == 2:.   
+000143a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000143b0: 7365 6c66 2e66 756e 6320 2a20 7365 6c66  self.func * self
+000143c0: 2e66 756e 630a 2020 2020 2020 2020 656c  .func.        el
+000143d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000143e0: 7265 7475 726e 2073 656c 662e 6675 6e63  return self.func
+000143f0: 2e5f 706f 7765 7228 7365 6c66 2e70 6f77  ._power(self.pow
+00014400: 6572 290a 0a20 2020 2064 6566 205f 6f70  er)..    def _op
+00014410: 7469 6d69 7a65 645f 666f 725f 6e75 6d70  timized_for_nump
+00014420: 7928 7365 6c66 293a 0a20 2020 2020 2020  y(self):.       
+00014430: 2070 203d 2073 656c 662e 706f 7765 722e   p = self.power.
+00014440: 5f63 6f6e 7374 5f75 6e69 666f 726d 0a20  _const_uniform. 
+00014450: 2020 2020 2020 2069 6620 7020 3d3d 202d         if p == -
+00014460: 313a 0a20 2020 2020 2020 2020 2020 2072  1:.            r
+00014470: 6574 7572 6e20 5265 6369 7072 6f63 616c  eturn Reciprocal
+00014480: 2873 656c 662e 6675 6e63 290a 2020 2020  (self.func).    
+00014490: 2020 2020 656c 6966 2070 203d 3d20 2d32      elif p == -2
+000144a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000144b0: 7475 726e 2052 6563 6970 726f 6361 6c28  turn Reciprocal(
+000144c0: 7365 6c66 2e66 756e 6320 2a20 7365 6c66  self.func * self
+000144d0: 2e66 756e 6329 0a20 2020 2020 2020 2065  .func).        e
+000144e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000144f0: 2072 6574 7572 6e20 7365 6c66 2e5f 7369   return self._si
+00014500: 6d70 6c69 6669 6564 2829 0a0a 2020 2020  mplified()..    
+00014510: 6576 616c 6620 3d20 7374 6174 6963 6d65  evalf = staticme
+00014520: 7468 6f64 286e 756d 7079 2e70 6f77 6572  thod(numpy.power
+00014530: 290a 0a20 2020 2064 6566 205f 6465 7269  )..    def _deri
+00014540: 7661 7469 7665 2873 656c 662c 2076 6172  vative(self, var
+00014550: 2c20 7365 656e 293a 0a20 2020 2020 2020  , seen):.       
+00014560: 2069 6620 7365 6c66 2e70 6f77 6572 2e69   if self.power.i
+00014570: 7363 6f6e 7374 616e 743a 0a20 2020 2020  sconstant:.     
+00014580: 2020 2020 2020 2070 203d 2073 656c 662e         p = self.
+00014590: 706f 7765 722e 6576 616c 2829 0a20 2020  power.eval().   
+000145a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000145b0: 6569 6e73 756d 2827 412c 412c 4142 2d3e  einsum('A,A,AB->
+000145c0: 4142 272c 2063 6f6e 7374 616e 7428 7029  AB', constant(p)
+000145d0: 2c20 706f 7765 7228 7365 6c66 2e66 756e  , power(self.fun
+000145e0: 632c 2070 202d 2028 7020 213d 2030 2929  c, p - (p != 0))
+000145f0: 2c20 6465 7269 7661 7469 7665 2873 656c  , derivative(sel
+00014600: 662e 6675 6e63 2c20 7661 722c 2073 6565  f.func, var, see
+00014610: 6e29 290a 2020 2020 2020 2020 6966 2073  n)).        if s
+00014620: 656c 662e 6474 7970 6520 3d3d 2063 6f6d  elf.dtype == com
+00014630: 706c 6578 3a0a 2020 2020 2020 2020 2020  plex:.          
+00014640: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
+00014650: 6d65 6e74 6564 4572 726f 7228 2754 6865  mentedError('The
+00014660: 2063 6f6d 706c 6578 2064 6572 6976 6174   complex derivat
+00014670: 6976 6520 6973 206e 6f74 2069 6d70 6c65  ive is not imple
+00014680: 6d65 6e74 6564 2e27 290a 2020 2020 2020  mented.').      
+00014690: 2020 2320 7365 6c66 203d 2066 756e 632a    # self = func*
+000146a0: 2a70 6f77 6572 0a20 2020 2020 2020 2023  *power.        #
+000146b0: 206c 6e20 7365 6c66 203d 2070 6f77 6572   ln self = power
+000146c0: 202a 206c 6e20 6675 6e63 0a20 2020 2020   * ln func.     
+000146d0: 2020 2023 2073 656c 6660 202f 2073 656c     # self` / sel
+000146e0: 6620 3d20 706f 7765 7260 202a 206c 6e20  f = power` * ln 
+000146f0: 6675 6e63 202b 2070 6f77 6572 202a 2066  func + power * f
+00014700: 756e 6360 202f 2066 756e 630a 2020 2020  unc` / func.    
+00014710: 2020 2020 2320 7365 6c66 6020 3d20 706f      # self` = po
+00014720: 7765 7260 202a 206c 6e20 6675 6e63 202a  wer` * ln func *
+00014730: 2073 656c 6620 2b20 706f 7765 7220 2a20   self + power * 
+00014740: 6675 6e63 6020 2a20 6675 6e63 2a2a 2870  func` * func**(p
+00014750: 6f77 6572 2d31 290a 2020 2020 2020 2020  ower-1).        
+00014760: 7265 7475 726e 2065 696e 7375 6d28 2741  return einsum('A
+00014770: 2c41 2c41 422d 3e41 4227 2c20 7365 6c66  ,A,AB->AB', self
+00014780: 2e70 6f77 6572 2c20 706f 7765 7228 7365  .power, power(se
+00014790: 6c66 2e66 756e 632c 2073 656c 662e 706f  lf.func, self.po
+000147a0: 7765 7220 2d20 3129 2c20 6465 7269 7661  wer - 1), deriva
+000147b0: 7469 7665 2873 656c 662e 6675 6e63 2c20  tive(self.func, 
+000147c0: 7661 722c 2073 6565 6e29 2920 5c0a 2020  var, seen)) \.  
+000147d0: 2020 2020 2020 2020 2020 2b20 6569 6e73            + eins
+000147e0: 756d 2827 412c 412c 4142 2d3e 4142 272c  um('A,A,AB->AB',
+000147f0: 206c 6e28 7365 6c66 2e66 756e 6329 2c20   ln(self.func), 
+00014800: 7365 6c66 2c20 6465 7269 7661 7469 7665  self, derivative
+00014810: 2873 656c 662e 706f 7765 722c 2076 6172  (self.power, var
+00014820: 2c20 7365 656e 2929 0a0a 2020 2020 6465  , seen))..    de
+00014830: 6620 5f70 6f77 6572 2873 656c 662c 206e  f _power(self, n
+00014840: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
+00014850: 6c66 2e64 7479 7065 203d 3d20 636f 6d70  lf.dtype == comp
+00014860: 6c65 7820 6f72 206e 2e64 7479 7065 203d  lex or n.dtype =
+00014870: 3d20 636f 6d70 6c65 783a 0a20 2020 2020  = complex:.     
+00014880: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+00014890: 2020 2020 2020 6675 6e63 203d 2073 656c        func = sel
+000148a0: 662e 6675 6e63 0a20 2020 2020 2020 206e  f.func.        n
+000148b0: 6577 706f 7765 7220 3d20 6d75 6c74 6970  ewpower = multip
+000148c0: 6c79 2873 656c 662e 706f 7765 722c 206e  ly(self.power, n
+000148d0: 290a 2020 2020 2020 2020 6966 2069 737a  ).        if isz
+000148e0: 6572 6f28 7365 6c66 2e70 6f77 6572 2025  ero(self.power %
+000148f0: 2032 2920 616e 6420 6e6f 7420 6973 7a65   2) and not isze
+00014900: 726f 286e 6577 706f 7765 7220 2520 3229  ro(newpower % 2)
+00014910: 3a0a 2020 2020 2020 2020 2020 2020 6675  :.            fu
+00014920: 6e63 203d 2061 6273 2866 756e 6329 0a20  nc = abs(func). 
+00014930: 2020 2020 2020 2072 6574 7572 6e20 506f         return Po
+00014940: 7765 7228 6675 6e63 2c20 6e65 7770 6f77  wer(func, newpow
+00014950: 6572 290a 0a20 2020 2064 6566 205f 7461  er)..    def _ta
+00014960: 6b65 6469 6167 2873 656c 662c 2061 7869  kediag(self, axi
+00014970: 7331 2c20 6178 6973 3229 3a0a 2020 2020  s1, axis2):.    
+00014980: 2020 2020 7265 7475 726e 2050 6f77 6572      return Power
+00014990: 285f 7461 6b65 6469 6167 2873 656c 662e  (_takediag(self.
+000149a0: 6675 6e63 2c20 6178 6973 312c 2061 7869  func, axis1, axi
+000149b0: 7332 292c 205f 7461 6b65 6469 6167 2873  s2), _takediag(s
+000149c0: 656c 662e 706f 7765 722c 2061 7869 7331  elf.power, axis1
+000149d0: 2c20 6178 6973 3229 290a 0a20 2020 2064  , axis2))..    d
+000149e0: 6566 205f 7461 6b65 2873 656c 662c 2069  ef _take(self, i
+000149f0: 6e64 6578 2c20 6178 6973 293a 0a20 2020  ndex, axis):.   
+00014a00: 2020 2020 2072 6574 7572 6e20 506f 7765       return Powe
+00014a10: 7228 5f74 616b 6528 7365 6c66 2e66 756e  r(_take(self.fun
+00014a20: 632c 2069 6e64 6578 2c20 6178 6973 292c  c, index, axis),
+00014a30: 205f 7461 6b65 2873 656c 662e 706f 7765   _take(self.powe
+00014a40: 722c 2069 6e64 6578 2c20 6178 6973 2929  r, index, axis))
+00014a50: 0a0a 2020 2020 6465 6620 5f75 6e72 6176  ..    def _unrav
+00014a60: 656c 2873 656c 662c 2061 7869 732c 2073  el(self, axis, s
+00014a70: 6861 7065 293a 0a20 2020 2020 2020 2072  hape):.        r
+00014a80: 6574 7572 6e20 506f 7765 7228 756e 7261  eturn Power(unra
+00014a90: 7665 6c28 7365 6c66 2e66 756e 632c 2061  vel(self.func, a
+00014aa0: 7869 732c 2073 6861 7065 292c 2075 6e72  xis, shape), unr
+00014ab0: 6176 656c 2873 656c 662e 706f 7765 722c  avel(self.power,
+00014ac0: 2061 7869 732c 2073 6861 7065 2929 0a0a   axis, shape))..
+00014ad0: 0a63 6c61 7373 2050 6f69 6e74 7769 7365  .class Pointwise
+00014ae0: 2841 7272 6179 293a 0a20 2020 2027 2727  (Array):.    '''
+00014af0: 0a20 2020 2041 6273 7472 6163 7420 6261  .    Abstract ba
+00014b00: 7365 2063 6c61 7373 2066 6f72 2070 6f69  se class for poi
+00014b10: 6e74 7769 7365 2061 7272 6179 2066 756e  ntwise array fun
+00014b20: 6374 696f 6e73 2e0a 2020 2020 2727 270a  ctions..    '''.
+00014b30: 0a20 2020 2064 6572 6976 203d 204e 6f6e  .    deriv = Non
+00014b40: 650a 2020 2020 636f 6d70 6c65 785f 6465  e.    complex_de
+00014b50: 7269 7620 3d20 4e6f 6e65 0a20 2020 2072  riv = None.    r
+00014b60: 6574 7572 6e5f 7479 7065 203d 204e 6f6e  eturn_type = Non
+00014b70: 650a 0a20 2020 2064 6566 205f 5f69 6e69  e..    def __ini
+00014b80: 745f 5f28 7365 6c66 2c20 2a61 7267 733a  t__(self, *args:
+00014b90: 2041 7272 6179 2c20 2a2a 7061 7261 6d73   Array, **params
+00014ba0: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
+00014bb0: 7420 616c 6c28 6973 696e 7374 616e 6365  t all(isinstance
+00014bc0: 2861 7267 2c20 4172 7261 7929 2066 6f72  (arg, Array) for
+00014bd0: 2061 7267 2069 6e20 6172 6773 292c 2066   arg in args), f
+00014be0: 2761 7267 733d 7b61 7267 7321 727d 270a  'args={args!r}'.
+00014bf0: 2020 2020 2020 2020 6474 7970 6520 3d20          dtype = 
+00014c00: 7365 6c66 2e5f 5f63 6c61 7373 5f5f 2e72  self.__class__.r
+00014c10: 6574 7572 6e5f 7479 7065 282a 5b61 7267  eturn_type(*[arg
+00014c20: 2e64 7479 7065 2066 6f72 2061 7267 2069  .dtype for arg i
+00014c30: 6e20 6172 6773 5d2c 202a 2a70 6172 616d  n args], **param
+00014c40: 7329 0a20 2020 2020 2020 2073 6861 7065  s).        shape
+00014c50: 3020 3d20 6172 6773 5b30 5d2e 7368 6170  0 = args[0].shap
+00014c60: 650a 2020 2020 2020 2020 6173 7365 7274  e.        assert
+00014c70: 2061 6c6c 2865 7175 616c 7368 6170 6528   all(equalshape(
+00014c80: 6172 672e 7368 6170 652c 2073 6861 7065  arg.shape, shape
+00014c90: 3029 2066 6f72 2061 7267 2069 6e20 6172  0) for arg in ar
+00014ca0: 6773 5b31 3a5d 292c 2027 706f 696e 7477  gs[1:]), 'pointw
+00014cb0: 6973 6520 6172 6775 6d65 6e74 7320 6861  ise arguments ha
+00014cc0: 7665 2069 6e63 6f6e 7369 7374 656e 7420  ve inconsistent 
+00014cd0: 7368 6170 6573 270a 2020 2020 2020 2020  shapes'.        
+00014ce0: 7365 6c66 2e61 7267 7320 3d20 6172 6773  self.args = args
+00014cf0: 0a20 2020 2020 2020 2073 656c 662e 7061  .        self.pa
+00014d00: 7261 6d73 203d 2070 6172 616d 730a 2020  rams = params.  
+00014d10: 2020 2020 2020 6966 2070 6172 616d 733a        if params:
+00014d20: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00014d30: 662e 6576 616c 6620 3d20 6675 6e63 746f  f.evalf = functo
+00014d40: 6f6c 732e 7061 7274 6961 6c28 7365 6c66  ols.partial(self
+00014d50: 2e65 7661 6c66 2c20 2a2a 7061 7261 6d73  .evalf, **params
+00014d60: 290a 2020 2020 2020 2020 7375 7065 7228  ).        super(
+00014d70: 292e 5f5f 696e 6974 5f5f 2861 7267 733d  ).__init__(args=
+00014d80: 6172 6773 2c20 7368 6170 653d 7368 6170  args, shape=shap
+00014d90: 6530 2c20 6474 7970 653d 6474 7970 6529  e0, dtype=dtype)
+00014da0: 0a0a 2020 2020 6465 6620 5f6e 6577 6172  ..    def _newar
+00014db0: 6773 2873 656c 662c 202a 6172 6773 293a  gs(self, *args):
+00014dc0: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+00014dd0: 2020 2020 2052 6569 6e73 7461 6e74 6961       Reinstantia
+00014de0: 7465 2073 656c 6620 7769 7468 2064 6966  te self with dif
+00014df0: 6665 7265 6e74 2061 7267 756d 656e 7473  ferent arguments
+00014e00: 2e20 5061 7261 6d65 7465 7273 2061 7265  . Parameters are
+00014e10: 2070 7265 7365 7276 6564 2c0a 2020 2020   preserved,.    
+00014e20: 2020 2020 6173 2074 6865 7365 2061 7265      as these are
+00014e30: 2063 6f6e 7369 6465 7265 6420 7061 7274   considered part
+00014e40: 206f 6620 7468 6520 7479 7065 2e0a 2020   of the type..  
+00014e50: 2020 2020 2020 2727 270a 0a20 2020 2020        '''..     
+00014e60: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00014e70: 5f63 6c61 7373 5f5f 282a 6172 6773 2c20  _class__(*args, 
+00014e80: 2a2a 7365 6c66 2e70 6172 616d 7329 0a0a  **self.params)..
+00014e90: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
+00014ea0: 0a20 2020 2064 6566 206f 7574 6572 2863  .    def outer(c
+00014eb0: 6c73 2c20 2a61 7267 7329 3a0a 2020 2020  ls, *args):.    
+00014ec0: 2020 2020 2727 2741 6c74 6572 6e61 7469      '''Alternati
+00014ed0: 7665 2063 6f6e 7374 7275 6374 6f72 2074  ve constructor t
+00014ee0: 6861 7420 6f75 7465 722d 616c 6967 6e73  hat outer-aligns
+00014ef0: 2074 6865 2061 7267 756d 656e 7473 2e0a   the arguments..
+00014f00: 0a20 2020 2020 2020 2054 6865 206f 7574  .        The out
+00014f10: 7075 7420 7368 6170 6520 6f66 2074 6869  put shape of thi
+00014f20: 7320 706f 696e 7477 6973 6520 6675 6e63  s pointwise func
+00014f30: 7469 6f6e 2069 7320 7468 6520 7375 6d20  tion is the sum 
+00014f40: 6f66 2061 6c6c 2073 6861 7065 7320 6f66  of all shapes of
+00014f50: 2069 7473 0a20 2020 2020 2020 2061 7267   its.        arg
+00014f60: 756d 656e 7473 2e20 5768 656e 2063 616c  uments. When cal
+00014f70: 6c65 6420 7769 7468 206d 756c 7469 706c  led with multipl
+00014f80: 6520 6172 6775 6d65 6e74 732c 2074 6865  e arguments, the
+00014f90: 2066 6972 7374 2061 7267 756d 656e 7420   first argument 
+00014fa0: 7769 6c6c 2062 650a 2020 2020 2020 2020  will be.        
+00014fb0: 6170 7065 6e64 6564 2077 6974 6820 7369  appended with si
+00014fc0: 6e67 6c65 746f 6e20 6178 6573 2074 6f20  ngleton axes to 
+00014fd0: 6d61 7463 6820 7468 6520 6f75 7470 7574  match the output
+00014fe0: 2073 6861 7065 2c20 7468 6520 7365 636f   shape, the seco
+00014ff0: 6e64 2061 7267 756d 656e 740a 2020 2020  nd argument.    
+00015000: 2020 2020 7769 6c6c 2062 6520 7072 6570      will be prep
+00015010: 656e 6465 6420 7769 7468 2061 7320 6d61  ended with as ma
+00015020: 6e79 2073 696e 676c 6574 6f6e 2061 7865  ny singleton axe
+00015030: 7320 6173 2074 6865 2064 696d 656e 7369  s as the dimensi
+00015040: 6f6e 206f 6620 7468 650a 2020 2020 2020  on of the.      
+00015050: 2020 6f72 6967 696e 616c 2066 6972 7374    original first
+00015060: 2061 7267 756d 656e 7420 616e 6420 6170   argument and ap
+00015070: 7065 6e64 6564 2074 6f20 6d61 7463 6820  pended to match 
+00015080: 7468 6520 6f75 7470 7574 2073 6861 7065  the output shape
+00015090: 2c20 616e 6420 736f 0a20 2020 2020 2020  , and so.       
+000150a0: 2066 6f72 7468 2061 6e64 2073 6f20 6f6e   forth and so on
+000150b0: 2e0a 2020 2020 2020 2020 2727 270a 0a20  ..        '''.. 
+000150c0: 2020 2020 2020 2061 7267 7320 3d20 7475         args = tu
+000150d0: 706c 6528 6d61 7028 6173 6172 7261 792c  ple(map(asarray,
+000150e0: 2061 7267 7329 290a 2020 2020 2020 2020   args)).        
+000150f0: 7368 6170 6520 3d20 6275 696c 7469 6e73  shape = builtins
+00015100: 2e73 756d 2828 6172 672e 7368 6170 6520  .sum((arg.shape 
+00015110: 666f 7220 6172 6720 696e 2061 7267 7329  for arg in args)
+00015120: 2c20 2829 290a 2020 2020 2020 2020 6f66  , ()).        of
+00015130: 6673 6574 7320 3d20 6e75 6d70 792e 6375  fsets = numpy.cu
+00015140: 6d73 756d 285b 305d 2b5b 6172 672e 6e64  msum([0]+[arg.nd
+00015150: 696d 2066 6f72 2061 7267 2069 6e20 6172  im for arg in ar
+00015160: 6773 5d29 0a20 2020 2020 2020 2072 6574  gs]).        ret
+00015170: 7572 6e20 636c 7328 2a28 7072 6570 656e  urn cls(*(prepen
+00015180: 6461 7865 7328 6170 7065 6e64 6178 6573  daxes(appendaxes
+00015190: 2861 7267 2c20 7368 6170 655b 723a 5d29  (arg, shape[r:])
+000151a0: 2c20 7368 6170 655b 3a6c 5d29 2066 6f72  , shape[:l]) for
+000151b0: 2061 7267 2c20 6c2c 2072 2069 6e20 7a69   arg, l, r in zi
+000151c0: 7028 6172 6773 2c20 6f66 6673 6574 735b  p(args, offsets[
+000151d0: 3a2d 315d 2c20 6f66 6673 6574 735b 313a  :-1], offsets[1:
+000151e0: 5d29 2929 0a0a 2020 2020 6465 6620 5f73  ])))..    def _s
+000151f0: 696d 706c 6966 6965 6428 7365 6c66 293a  implified(self):
+00015200: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+00015210: 7365 6c66 2e61 7267 7329 203d 3d20 3120  self.args) == 1 
+00015220: 616e 6420 6973 696e 7374 616e 6365 2873  and isinstance(s
+00015230: 656c 662e 6172 6773 5b30 5d2c 2054 7261  elf.args[0], Tra
+00015240: 6e73 706f 7365 293a 0a20 2020 2020 2020  nspose):.       
+00015250: 2020 2020 2061 7267 2c20 3d20 7365 6c66       arg, = self
+00015260: 2e61 7267 730a 2020 2020 2020 2020 2020  .args.          
+00015270: 2020 7265 7475 726e 2054 7261 6e73 706f    return Transpo
+00015280: 7365 2873 656c 662e 5f6e 6577 6172 6773  se(self._newargs
+00015290: 2861 7267 2e66 756e 6329 2c20 6172 672e  (arg.func), arg.
+000152a0: 6178 6573 290a 2020 2020 2020 2020 2a75  axes).        *u
+000152b0: 6e69 6e73 6572 7465 642c 2077 6865 7265  ninserted, where
+000152c0: 203d 2075 6e61 6c69 676e 282a 7365 6c66   = unalign(*self
+000152d0: 2e61 7267 7329 0a20 2020 2020 2020 2069  .args).        i
+000152e0: 6620 6c65 6e28 7768 6572 6529 2021 3d20  f len(where) != 
+000152f0: 7365 6c66 2e6e 6469 6d3a 0a20 2020 2020  self.ndim:.     
+00015300: 2020 2020 2020 2072 6574 7572 6e20 616c         return al
+00015310: 6967 6e28 7365 6c66 2e5f 6e65 7761 7267  ign(self._newarg
+00015320: 7328 2a75 6e69 6e73 6572 7465 6429 2c20  s(*uninserted), 
+00015330: 7768 6572 652c 2073 656c 662e 7368 6170  where, self.shap
+00015340: 6529 0a0a 2020 2020 6465 6620 5f6f 7074  e)..    def _opt
+00015350: 696d 697a 6564 5f66 6f72 5f6e 756d 7079  imized_for_numpy
+00015360: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00015370: 6966 2073 656c 662e 6973 636f 6e73 7461  if self.isconsta
+00015380: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+00015390: 7265 7476 616c 203d 2073 656c 662e 6576  retval = self.ev
+000153a0: 616c 2829 0a20 2020 2020 2020 2020 2020  al().           
+000153b0: 2072 6574 7572 6e20 636f 6e73 7461 6e74   return constant
+000153c0: 2872 6574 7661 6c29 0a0a 2020 2020 6465  (retval)..    de
+000153d0: 6620 5f64 6572 6976 6174 6976 6528 7365  f _derivative(se
+000153e0: 6c66 2c20 7661 722c 2073 6565 6e29 3a0a  lf, var, seen):.
+000153f0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00015400: 636f 6d70 6c65 785f 6465 7269 7620 6973  complex_deriv is
+00015410: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00015420: 2020 2020 2020 2072 6574 7572 6e20 7574         return ut
+00015430: 696c 2e73 756d 2865 696e 7375 6d28 2741  il.sum(einsum('A
+00015440: 2c41 422d 3e41 4227 2c20 6465 7269 7628  ,AB->AB', deriv(
+00015450: 2a73 656c 662e 6172 6773 2c20 2a2a 7365  *self.args, **se
+00015460: 6c66 2e70 6172 616d 7329 2c20 6465 7269  lf.params), deri
+00015470: 7661 7469 7665 2861 7267 2c20 7661 722c  vative(arg, var,
+00015480: 2073 6565 6e29 2920 666f 7220 6172 672c   seen)) for arg,
+00015490: 2064 6572 6976 2069 6e20 7a69 7028 7365   deriv in zip(se
+000154a0: 6c66 2e61 7267 732c 2073 656c 662e 636f  lf.args, self.co
+000154b0: 6d70 6c65 785f 6465 7269 7629 290a 2020  mplex_deriv)).  
+000154c0: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
+000154d0: 6474 7970 6520 3d3d 2063 6f6d 706c 6578  dtype == complex
+000154e0: 206f 7220 7661 722e 6474 7970 6520 3d3d   or var.dtype ==
+000154f0: 2063 6f6d 706c 6578 3a0a 2020 2020 2020   complex:.      
+00015500: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
+00015510: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
+00015520: 2754 6865 2063 6f6d 706c 6578 2064 6572  'The complex der
+00015530: 6976 6174 6976 6520 6973 206e 6f74 2069  ivative is not i
+00015540: 6d70 6c65 6d65 6e74 6564 2e27 290a 2020  mplemented.').  
+00015550: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
+00015560: 6465 7269 7620 6973 206e 6f74 204e 6f6e  deriv is not Non
+00015570: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00015580: 6574 7572 6e20 7574 696c 2e73 756d 2865  eturn util.sum(e
+00015590: 696e 7375 6d28 2741 2c41 422d 3e41 4227  insum('A,AB->AB'
+000155a0: 2c20 6465 7269 7628 2a73 656c 662e 6172  , deriv(*self.ar
+000155b0: 6773 2c20 2a2a 7365 6c66 2e70 6172 616d  gs, **self.param
+000155c0: 7329 2c20 6465 7269 7661 7469 7665 2861  s), derivative(a
+000155d0: 7267 2c20 7661 722c 2073 6565 6e29 2920  rg, var, seen)) 
+000155e0: 666f 7220 6172 672c 2064 6572 6976 2069  for arg, deriv i
+000155f0: 6e20 7a69 7028 7365 6c66 2e61 7267 732c  n zip(self.args,
+00015600: 2073 656c 662e 6465 7269 7629 290a 2020   self.deriv)).  
+00015610: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00015620: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00015630: 7570 6572 2829 2e5f 6465 7269 7661 7469  uper()._derivati
+00015640: 7665 2876 6172 2c20 7365 656e 290a 0a20  ve(var, seen).. 
+00015650: 2020 2064 6566 205f 7461 6b65 6469 6167     def _takediag
+00015660: 2873 656c 662c 2061 7869 7331 2c20 6178  (self, axis1, ax
+00015670: 6973 3229 3a0a 2020 2020 2020 2020 7265  is2):.        re
+00015680: 7475 726e 2073 656c 662e 5f6e 6577 6172  turn self._newar
+00015690: 6773 282a 5b5f 7461 6b65 6469 6167 2861  gs(*[_takediag(a
+000156a0: 7267 2c20 6178 6973 312c 2061 7869 7332  rg, axis1, axis2
+000156b0: 2920 666f 7220 6172 6720 696e 2073 656c  ) for arg in sel
+000156c0: 662e 6172 6773 5d29 0a0a 2020 2020 6465  f.args])..    de
+000156d0: 6620 5f74 616b 6528 7365 6c66 2c20 696e  f _take(self, in
+000156e0: 6465 782c 2061 7869 7329 3a0a 2020 2020  dex, axis):.    
+000156f0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00015700: 5f6e 6577 6172 6773 282a 5b5f 7461 6b65  _newargs(*[_take
+00015710: 2861 7267 2c20 696e 6465 782c 2061 7869  (arg, index, axi
+00015720: 7329 2066 6f72 2061 7267 2069 6e20 7365  s) for arg in se
+00015730: 6c66 2e61 7267 735d 290a 0a20 2020 2064  lf.args])..    d
+00015740: 6566 205f 756e 7261 7665 6c28 7365 6c66  ef _unravel(self
+00015750: 2c20 6178 6973 2c20 7368 6170 6529 3a0a  , axis, shape):.
+00015760: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00015770: 656c 662e 5f6e 6577 6172 6773 282a 5b75  elf._newargs(*[u
+00015780: 6e72 6176 656c 2861 7267 2c20 6178 6973  nravel(arg, axis
+00015790: 2c20 7368 6170 6529 2066 6f72 2061 7267  , shape) for arg
+000157a0: 2069 6e20 7365 6c66 2e61 7267 735d 290a   in self.args]).
+000157b0: 0a0a 636c 6173 7320 5265 6369 7072 6f63  ..class Reciproc
+000157c0: 616c 2850 6f69 6e74 7769 7365 293a 0a20  al(Pointwise):. 
+000157d0: 2020 2065 7661 6c66 203d 2073 7461 7469     evalf = stati
+000157e0: 636d 6574 686f 6428 6e75 6d70 792e 7265  cmethod(numpy.re
+000157f0: 6369 7072 6f63 616c 290a 2020 2020 7265  ciprocal).    re
+00015800: 7475 726e 5f74 7970 6520 3d20 6c61 6d62  turn_type = lamb
+00015810: 6461 2054 3a20 636f 6d70 6c65 7820 6966  da T: complex if
+00015820: 2054 203d 3d20 636f 6d70 6c65 7820 656c   T == complex el
+00015830: 7365 2066 6c6f 6174 0a0a 0a63 6c61 7373  se float...class
+00015840: 204e 6567 6174 6976 6528 506f 696e 7477   Negative(Pointw
+00015850: 6973 6529 3a0a 2020 2020 6576 616c 6620  ise):.    evalf 
+00015860: 3d20 7374 6174 6963 6d65 7468 6f64 286e  = staticmethod(n
+00015870: 756d 7079 2e6e 6567 6174 6976 6529 0a20  umpy.negative). 
+00015880: 2020 2064 6566 2072 6574 7572 6e5f 7479     def return_ty
+00015890: 7065 2854 293a 0a20 2020 2020 2020 2069  pe(T):.        i
+000158a0: 6620 5420 3d3d 2062 6f6f 6c3a 0a20 2020  f T == bool:.   
+000158b0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+000158c0: 616c 7565 4572 726f 7228 2762 6f6f 6c65  alueError('boole
+000158d0: 616e 2076 616c 7565 7320 6361 6e6e 6f74  an values cannot
+000158e0: 2062 6520 6e65 6761 7465 6427 290a 2020   be negated').  
+000158f0: 2020 2020 2020 7265 7475 726e 2054 0a0a        return T..
+00015900: 2020 2020 6465 6620 5f69 6e74 626f 756e      def _intboun
+00015910: 6473 5f69 6d70 6c28 7365 6c66 293a 0a20  ds_impl(self):. 
+00015920: 2020 2020 2020 206c 6f77 6572 2c20 7570         lower, up
+00015930: 7065 7220 3d20 7365 6c66 2e61 7267 735b  per = self.args[
+00015940: 305d 2e5f 696e 7462 6f75 6e64 730a 2020  0]._intbounds.  
+00015950: 2020 2020 2020 7265 7475 726e 202d 7570        return -up
+00015960: 7065 722c 202d 6c6f 7765 720a 0a0a 636c  per, -lower...cl
+00015970: 6173 7320 466c 6f6f 7244 6976 6964 6528  ass FloorDivide(
+00015980: 506f 696e 7477 6973 6529 3a0a 2020 2020  Pointwise):.    
+00015990: 6576 616c 6620 3d20 7374 6174 6963 6d65  evalf = staticme
+000159a0: 7468 6f64 286e 756d 7079 2e66 6c6f 6f72  thod(numpy.floor
+000159b0: 5f64 6976 6964 6529 0a20 2020 2072 6574  _divide).    ret
+000159c0: 7572 6e5f 7479 7065 203d 206c 616d 6264  urn_type = lambd
+000159d0: 6120 5431 2c20 5432 3a20 636f 6d70 6c65  a T1, T2: comple
+000159e0: 7820 6966 2063 6f6d 706c 6578 2069 6e20  x if complex in 
+000159f0: 2854 312c 2054 3229 2065 6c73 6520 666c  (T1, T2) else fl
+00015a00: 6f61 7420 6966 2066 6c6f 6174 2069 6e20  oat if float in 
+00015a10: 2854 312c 2054 3229 2065 6c73 6520 696e  (T1, T2) else in
+00015a20: 740a 0a0a 636c 6173 7320 4162 736f 6c75  t...class Absolu
+00015a30: 7465 2850 6f69 6e74 7769 7365 293a 0a20  te(Pointwise):. 
+00015a40: 2020 2065 7661 6c66 203d 2073 7461 7469     evalf = stati
+00015a50: 636d 6574 686f 6428 6e75 6d70 792e 6162  cmethod(numpy.ab
+00015a60: 736f 6c75 7465 290a 2020 2020 7265 7475  solute).    retu
+00015a70: 726e 5f74 7970 6520 3d20 6c61 6d62 6461  rn_type = lambda
+00015a80: 2054 3a20 666c 6f61 7420 6966 2054 2069   T: float if T i
+00015a90: 6e20 2866 6c6f 6174 2c20 636f 6d70 6c65  n (float, comple
+00015aa0: 7829 2065 6c73 6520 696e 740a 0a20 2020  x) else int..   
+00015ab0: 2064 6566 205f 696e 7462 6f75 6e64 735f   def _intbounds_
+00015ac0: 696d 706c 2873 656c 6629 3a0a 2020 2020  impl(self):.    
+00015ad0: 2020 2020 6c6f 7765 722c 2075 7070 6572      lower, upper
+00015ae0: 203d 2073 656c 662e 6172 6773 5b30 5d2e   = self.args[0].
+00015af0: 5f69 6e74 626f 756e 6473 0a20 2020 2020  _intbounds.     
+00015b00: 2020 2065 7874 7265 6d61 203d 2062 7569     extrema = bui
+00015b10: 6c74 696e 732e 6162 7328 6c6f 7765 7229  ltins.abs(lower)
+00015b20: 2c20 6275 696c 7469 6e73 2e61 6273 2875  , builtins.abs(u
+00015b30: 7070 6572 290a 2020 2020 2020 2020 6966  pper).        if
+00015b40: 206c 6f77 6572 203c 3d20 3020 616e 6420   lower <= 0 and 
+00015b50: 7570 7065 7220 3e3d 2030 3a0a 2020 2020  upper >= 0:.    
+00015b60: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
+00015b70: 2c20 6d61 7828 6578 7472 656d 6129 0a20  , max(extrema). 
+00015b80: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00015b90: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00015ba0: 6d69 6e28 6578 7472 656d 6129 2c20 6d61  min(extrema), ma
+00015bb0: 7828 6578 7472 656d 6129 0a0a 0a63 6c61  x(extrema)...cla
+00015bc0: 7373 2043 6f73 2850 6f69 6e74 7769 7365  ss Cos(Pointwise
+00015bd0: 293a 0a20 2020 2027 436f 7369 6e65 2c20  ):.    'Cosine, 
+00015be0: 656c 656d 656e 742d 7769 7365 2e27 0a20  element-wise.'. 
+00015bf0: 2020 2065 7661 6c66 203d 2073 7461 7469     evalf = stati
+00015c00: 636d 6574 686f 6428 6e75 6d70 792e 636f  cmethod(numpy.co
+00015c10: 7329 0a20 2020 2063 6f6d 706c 6578 5f64  s).    complex_d
+00015c20: 6572 6976 203d 206c 616d 6264 6120 783a  eriv = lambda x:
+00015c30: 202d 5369 6e28 7829 2c0a 2020 2020 7265   -Sin(x),.    re
+00015c40: 7475 726e 5f74 7970 6520 3d20 6c61 6d62  turn_type = lamb
+00015c50: 6461 2054 3a20 636f 6d70 6c65 7820 6966  da T: complex if
+00015c60: 2054 203d 3d20 636f 6d70 6c65 7820 656c   T == complex el
+00015c70: 7365 2066 6c6f 6174 0a0a 2020 2020 6465  se float..    de
+00015c80: 6620 5f73 696d 706c 6966 6965 6428 7365  f _simplified(se
+00015c90: 6c66 293a 0a20 2020 2020 2020 2061 7267  lf):.        arg
+00015ca0: 2c20 3d20 7365 6c66 2e61 7267 730a 2020  , = self.args.  
+00015cb0: 2020 2020 2020 6966 2069 737a 6572 6f28        if iszero(
+00015cc0: 6172 6729 3a0a 2020 2020 2020 2020 2020  arg):.          
+00015cd0: 2020 7265 7475 726e 206f 6e65 7328 7365    return ones(se
+00015ce0: 6c66 2e73 6861 7065 2c20 6474 7970 653d  lf.shape, dtype=
+00015cf0: 7365 6c66 2e64 7479 7065 290a 2020 2020  self.dtype).    
+00015d00: 2020 2020 7265 7475 726e 2073 7570 6572      return super
+00015d10: 2829 2e5f 7369 6d70 6c69 6669 6564 2829  ()._simplified()
+00015d20: 0a0a 0a63 6c61 7373 2053 696e 2850 6f69  ...class Sin(Poi
+00015d30: 6e74 7769 7365 293a 0a20 2020 2027 5369  ntwise):.    'Si
+00015d40: 6e65 2c20 656c 656d 656e 742d 7769 7365  ne, element-wise
+00015d50: 2e27 0a20 2020 2065 7661 6c66 203d 2073  .'.    evalf = s
+00015d60: 7461 7469 636d 6574 686f 6428 6e75 6d70  taticmethod(nump
+00015d70: 792e 7369 6e29 0a20 2020 2063 6f6d 706c  y.sin).    compl
+00015d80: 6578 5f64 6572 6976 203d 2043 6f73 2c0a  ex_deriv = Cos,.
+00015d90: 2020 2020 7265 7475 726e 5f74 7970 6520      return_type 
+00015da0: 3d20 6c61 6d62 6461 2054 3a20 636f 6d70  = lambda T: comp
+00015db0: 6c65 7820 6966 2054 203d 3d20 636f 6d70  lex if T == comp
+00015dc0: 6c65 7820 656c 7365 2066 6c6f 6174 0a0a  lex else float..
+00015dd0: 2020 2020 6465 6620 5f73 696d 706c 6966      def _simplif
+00015de0: 6965 6428 7365 6c66 293a 0a20 2020 2020  ied(self):.     
+00015df0: 2020 2061 7267 2c20 3d20 7365 6c66 2e61     arg, = self.a
+00015e00: 7267 730a 2020 2020 2020 2020 6966 2069  rgs.        if i
+00015e10: 737a 6572 6f28 6172 6729 3a0a 2020 2020  szero(arg):.    
+00015e20: 2020 2020 2020 2020 7265 7475 726e 207a          return z
+00015e30: 6572 6f73 2873 656c 662e 7368 6170 652c  eros(self.shape,
+00015e40: 2064 7479 7065 3d73 656c 662e 6474 7970   dtype=self.dtyp
+00015e50: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
+00015e60: 6e20 7375 7065 7228 292e 5f73 696d 706c  n super()._simpl
+00015e70: 6966 6965 6428 290a 0a0a 636c 6173 7320  ified()...class 
+00015e80: 5461 6e28 506f 696e 7477 6973 6529 3a0a  Tan(Pointwise):.
+00015e90: 2020 2020 2754 616e 6765 6e74 2c20 656c      'Tangent, el
+00015ea0: 656d 656e 742d 7769 7365 2e27 0a20 2020  ement-wise.'.   
+00015eb0: 2065 7661 6c66 203d 2073 7461 7469 636d   evalf = staticm
+00015ec0: 6574 686f 6428 6e75 6d70 792e 7461 6e29  ethod(numpy.tan)
+00015ed0: 0a20 2020 2063 6f6d 706c 6578 5f64 6572  .    complex_der
+00015ee0: 6976 203d 206c 616d 6264 6120 783a 2043  iv = lambda x: C
+00015ef0: 6f73 2878 292a 2a2d 322c 0a20 2020 2072  os(x)**-2,.    r
+00015f00: 6574 7572 6e5f 7479 7065 203d 206c 616d  eturn_type = lam
+00015f10: 6264 6120 543a 2063 6f6d 706c 6578 2069  bda T: complex i
+00015f20: 6620 5420 3d3d 2063 6f6d 706c 6578 2065  f T == complex e
+00015f30: 6c73 6520 666c 6f61 740a 0a0a 636c 6173  lse float...clas
+00015f40: 7320 4172 6353 696e 2850 6f69 6e74 7769  s ArcSin(Pointwi
+00015f50: 7365 293a 0a20 2020 2027 496e 7665 7273  se):.    'Invers
+00015f60: 6520 7369 6e65 2c20 656c 656d 656e 742d  e sine, element-
+00015f70: 7769 7365 2e27 0a20 2020 2065 7661 6c66  wise.'.    evalf
+00015f80: 203d 2073 7461 7469 636d 6574 686f 6428   = staticmethod(
+00015f90: 6e75 6d70 792e 6172 6373 696e 290a 2020  numpy.arcsin).  
+00015fa0: 2020 636f 6d70 6c65 785f 6465 7269 7620    complex_deriv 
+00015fb0: 3d20 6c61 6d62 6461 2078 3a20 7265 6369  = lambda x: reci
+00015fc0: 7072 6f63 616c 2873 7172 7428 312d 782a  procal(sqrt(1-x*
+00015fd0: 2a32 2929 2c0a 2020 2020 7265 7475 726e  *2)),.    return
+00015fe0: 5f74 7970 6520 3d20 6c61 6d62 6461 2054  _type = lambda T
+00015ff0: 3a20 636f 6d70 6c65 7820 6966 2054 203d  : complex if T =
+00016000: 3d20 636f 6d70 6c65 7820 656c 7365 2066  = complex else f
+00016010: 6c6f 6174 0a0a 0a63 6c61 7373 2041 7263  loat...class Arc
+00016020: 436f 7328 506f 696e 7477 6973 6529 3a0a  Cos(Pointwise):.
+00016030: 2020 2020 2749 6e76 6572 7365 2063 6f73      'Inverse cos
+00016040: 696e 652c 2065 6c65 6d65 6e74 2d77 6973  ine, element-wis
+00016050: 652e 270a 2020 2020 6576 616c 6620 3d20  e.'.    evalf = 
+00016060: 7374 6174 6963 6d65 7468 6f64 286e 756d  staticmethod(num
+00016070: 7079 2e61 7263 636f 7329 0a20 2020 2063  py.arccos).    c
+00016080: 6f6d 706c 6578 5f64 6572 6976 203d 206c  omplex_deriv = l
+00016090: 616d 6264 6120 783a 202d 7265 6369 7072  ambda x: -recipr
+000160a0: 6f63 616c 2873 7172 7428 312d 782a 2a32  ocal(sqrt(1-x**2
+000160b0: 2929 2c0a 2020 2020 7265 7475 726e 5f74  )),.    return_t
+000160c0: 7970 6520 3d20 6c61 6d62 6461 2054 3a20  ype = lambda T: 
+000160d0: 636f 6d70 6c65 7820 6966 2054 203d 3d20  complex if T == 
+000160e0: 636f 6d70 6c65 7820 656c 7365 2066 6c6f  complex else flo
+000160f0: 6174 0a0a 0a63 6c61 7373 2041 7263 5461  at...class ArcTa
+00016100: 6e28 506f 696e 7477 6973 6529 3a0a 2020  n(Pointwise):.  
+00016110: 2020 2749 6e76 6572 7365 2074 616e 6765    'Inverse tange
+00016120: 6e74 2c20 656c 656d 656e 742d 7769 7365  nt, element-wise
+00016130: 2e27 0a20 2020 2065 7661 6c66 203d 2073  .'.    evalf = s
+00016140: 7461 7469 636d 6574 686f 6428 6e75 6d70  taticmethod(nump
+00016150: 792e 6172 6374 616e 290a 2020 2020 636f  y.arctan).    co
+00016160: 6d70 6c65 785f 6465 7269 7620 3d20 6c61  mplex_deriv = la
+00016170: 6d62 6461 2078 3a20 7265 6369 7072 6f63  mbda x: reciproc
+00016180: 616c 2831 2b78 2a2a 3229 2c0a 2020 2020  al(1+x**2),.    
+00016190: 7265 7475 726e 5f74 7970 6520 3d20 6c61  return_type = la
+000161a0: 6d62 6461 2054 3a20 636f 6d70 6c65 7820  mbda T: complex 
+000161b0: 6966 2054 203d 3d20 636f 6d70 6c65 7820  if T == complex 
+000161c0: 656c 7365 2066 6c6f 6174 0a0a 0a63 6c61  else float...cla
+000161d0: 7373 2053 696e 6328 506f 696e 7477 6973  ss Sinc(Pointwis
+000161e0: 6529 3a0a 2020 2020 6576 616c 6620 3d20  e):.    evalf = 
+000161f0: 7374 6174 6963 6d65 7468 6f64 286e 756d  staticmethod(num
+00016200: 6572 6963 2e73 696e 6329 0a20 2020 2063  eric.sinc).    c
+00016210: 6f6d 706c 6578 5f64 6572 6976 203d 206c  omplex_deriv = l
+00016220: 616d 6264 6120 782c 206e 3a20 5369 6e63  ambda x, n: Sinc
+00016230: 2878 2c20 6e3d 6e2b 3129 2c0a 2020 2020  (x, n=n+1),.    
+00016240: 7265 7475 726e 5f74 7970 6520 3d20 6c61  return_type = la
+00016250: 6d62 6461 2054 2c20 6e3a 2063 6f6d 706c  mbda T, n: compl
+00016260: 6578 2069 6620 5420 3d3d 2063 6f6d 706c  ex if T == compl
+00016270: 6578 2065 6c73 6520 666c 6f61 740a 0a0a  ex else float...
+00016280: 636c 6173 7320 436f 7348 2850 6f69 6e74  class CosH(Point
+00016290: 7769 7365 293a 0a20 2020 2027 4879 7065  wise):.    'Hype
+000162a0: 7262 6f6c 6963 2063 6f73 696e 652c 2065  rbolic cosine, e
+000162b0: 6c65 6d65 6e74 2d77 6973 652e 270a 2020  lement-wise.'.  
+000162c0: 2020 6576 616c 6620 3d20 7374 6174 6963    evalf = static
+000162d0: 6d65 7468 6f64 286e 756d 7079 2e63 6f73  method(numpy.cos
+000162e0: 6829 0a20 2020 2063 6f6d 706c 6578 5f64  h).    complex_d
+000162f0: 6572 6976 203d 206c 616d 6264 6120 783a  eriv = lambda x:
+00016300: 2053 696e 4828 7829 2c0a 2020 2020 7265   SinH(x),.    re
+00016310: 7475 726e 5f74 7970 6520 3d20 6c61 6d62  turn_type = lamb
+00016320: 6461 2054 3a20 636f 6d70 6c65 7820 6966  da T: complex if
+00016330: 2054 203d 3d20 636f 6d70 6c65 7820 656c   T == complex el
+00016340: 7365 2066 6c6f 6174 0a0a 0a63 6c61 7373  se float...class
+00016350: 2053 696e 4828 506f 696e 7477 6973 6529   SinH(Pointwise)
+00016360: 3a0a 2020 2020 2748 7970 6572 626f 6c69  :.    'Hyperboli
+00016370: 6320 7369 6e65 2c20 656c 656d 656e 742d  c sine, element-
+00016380: 7769 7365 2e27 0a20 2020 2065 7661 6c66  wise.'.    evalf
+00016390: 203d 2073 7461 7469 636d 6574 686f 6428   = staticmethod(
+000163a0: 6e75 6d70 792e 7369 6e68 290a 2020 2020  numpy.sinh).    
+000163b0: 636f 6d70 6c65 785f 6465 7269 7620 3d20  complex_deriv = 
+000163c0: 436f 7348 2c0a 2020 2020 7265 7475 726e  CosH,.    return
+000163d0: 5f74 7970 6520 3d20 6c61 6d62 6461 2054  _type = lambda T
+000163e0: 3a20 636f 6d70 6c65 7820 6966 2054 203d  : complex if T =
+000163f0: 3d20 636f 6d70 6c65 7820 656c 7365 2066  = complex else f
+00016400: 6c6f 6174 0a0a 0a63 6c61 7373 2054 616e  loat...class Tan
+00016410: 4828 506f 696e 7477 6973 6529 3a0a 2020  H(Pointwise):.  
+00016420: 2020 2748 7970 6572 626f 6c69 6320 7461    'Hyperbolic ta
+00016430: 6e67 656e 742c 2065 6c65 6d65 6e74 2d77  ngent, element-w
+00016440: 6973 652e 270a 2020 2020 6576 616c 6620  ise.'.    evalf 
+00016450: 3d20 7374 6174 6963 6d65 7468 6f64 286e  = staticmethod(n
+00016460: 756d 7079 2e74 616e 6829 0a20 2020 2063  umpy.tanh).    c
+00016470: 6f6d 706c 6578 5f64 6572 6976 203d 206c  omplex_deriv = l
+00016480: 616d 6264 6120 783a 2031 202d 2054 616e  ambda x: 1 - Tan
+00016490: 4828 7829 2a2a 322c 0a20 2020 2072 6574  H(x)**2,.    ret
+000164a0: 7572 6e5f 7479 7065 203d 206c 616d 6264  urn_type = lambd
+000164b0: 6120 543a 2063 6f6d 706c 6578 2069 6620  a T: complex if 
+000164c0: 5420 3d3d 2063 6f6d 706c 6578 2065 6c73  T == complex els
+000164d0: 6520 666c 6f61 740a 0a0a 636c 6173 7320  e float...class 
+000164e0: 4172 6354 616e 4828 506f 696e 7477 6973  ArcTanH(Pointwis
+000164f0: 6529 3a0a 2020 2020 2749 6e76 6572 7365  e):.    'Inverse
+00016500: 2068 7970 6572 626f 6c69 6320 7461 6e67   hyperbolic tang
+00016510: 656e 742c 2065 6c65 6d65 6e74 2d77 6973  ent, element-wis
+00016520: 652e 270a 2020 2020 6576 616c 6620 3d20  e.'.    evalf = 
+00016530: 7374 6174 6963 6d65 7468 6f64 286e 756d  staticmethod(num
+00016540: 7079 2e61 7263 7461 6e68 290a 2020 2020  py.arctanh).    
+00016550: 636f 6d70 6c65 785f 6465 7269 7620 3d20  complex_deriv = 
+00016560: 6c61 6d62 6461 2078 3a20 7265 6369 7072  lambda x: recipr
+00016570: 6f63 616c 2831 2d78 2a2a 3229 2c0a 2020  ocal(1-x**2),.  
+00016580: 2020 7265 7475 726e 5f74 7970 6520 3d20    return_type = 
+00016590: 6c61 6d62 6461 2054 3a20 636f 6d70 6c65  lambda T: comple
+000165a0: 7820 6966 2054 203d 3d20 636f 6d70 6c65  x if T == comple
+000165b0: 7820 656c 7365 2066 6c6f 6174 0a0a 0a63  x else float...c
+000165c0: 6c61 7373 2045 7870 2850 6f69 6e74 7769  lass Exp(Pointwi
+000165d0: 7365 293a 0a20 2020 2065 7661 6c66 203d  se):.    evalf =
+000165e0: 2073 7461 7469 636d 6574 686f 6428 6e75   staticmethod(nu
+000165f0: 6d70 792e 6578 7029 0a20 2020 2063 6f6d  mpy.exp).    com
+00016600: 706c 6578 5f64 6572 6976 203d 206c 616d  plex_deriv = lam
+00016610: 6264 6120 783a 2045 7870 2878 292c 0a20  bda x: Exp(x),. 
+00016620: 2020 2072 6574 7572 6e5f 7479 7065 203d     return_type =
+00016630: 206c 616d 6264 6120 543a 2063 6f6d 706c   lambda T: compl
+00016640: 6578 2069 6620 5420 3d3d 2063 6f6d 706c  ex if T == compl
+00016650: 6578 2065 6c73 6520 666c 6f61 740a 0a0a  ex else float...
+00016660: 636c 6173 7320 4c6f 6728 506f 696e 7477  class Log(Pointw
+00016670: 6973 6529 3a0a 2020 2020 6576 616c 6620  ise):.    evalf 
+00016680: 3d20 7374 6174 6963 6d65 7468 6f64 286e  = staticmethod(n
+00016690: 756d 7079 2e6c 6f67 290a 2020 2020 636f  umpy.log).    co
+000166a0: 6d70 6c65 785f 6465 7269 7620 3d20 6c61  mplex_deriv = la
+000166b0: 6d62 6461 2078 3a20 7265 6369 7072 6f63  mbda x: reciproc
+000166c0: 616c 2878 292c 0a20 2020 2072 6574 7572  al(x),.    retur
+000166d0: 6e5f 7479 7065 203d 206c 616d 6264 6120  n_type = lambda 
+000166e0: 543a 2063 6f6d 706c 6578 2069 6620 5420  T: complex if T 
+000166f0: 3d3d 2063 6f6d 706c 6578 2065 6c73 6520  == complex else 
+00016700: 666c 6f61 740a 0a0a 636c 6173 7320 4d6f  float...class Mo
+00016710: 6428 506f 696e 7477 6973 6529 3a0a 2020  d(Pointwise):.  
+00016720: 2020 6576 616c 6620 3d20 7374 6174 6963    evalf = static
+00016730: 6d65 7468 6f64 286e 756d 7079 2e6d 6f64  method(numpy.mod
+00016740: 290a 2020 2020 6465 6620 7265 7475 726e  ).    def return
+00016750: 5f74 7970 6528 5431 2c20 5432 293a 0a20  _type(T1, T2):. 
+00016760: 2020 2020 2020 2069 6620 5431 203d 3d20         if T1 == 
+00016770: 636f 6d70 6c65 7820 6f72 2054 3220 3d3d  complex or T2 ==
+00016780: 2063 6f6d 706c 6578 3a0a 2020 2020 2020   complex:.      
+00016790: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+000167a0: 6545 7272 6f72 2827 6d6f 6420 6973 206e  eError('mod is n
+000167b0: 6f74 2064 6566 696e 6564 2066 6f72 2063  ot defined for c
+000167c0: 6f6d 706c 6578 206e 756d 6265 7273 2729  omplex numbers')
+000167d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000167e0: 666c 6f61 7420 6966 2066 6c6f 6174 2069  float if float i
+000167f0: 6e20 2854 312c 2054 3229 2065 6c73 6520  n (T1, T2) else 
+00016800: 696e 740a 0a20 2020 2064 6566 205f 696e  int..    def _in
+00016810: 7462 6f75 6e64 735f 696d 706c 2873 656c  tbounds_impl(sel
+00016820: 6629 3a0a 2020 2020 2020 2020 6469 7669  f):.        divi
+00016830: 6465 6e64 2c20 6469 7669 736f 7220 3d20  dend, divisor = 
+00016840: 7365 6c66 2e61 7267 730a 2020 2020 2020  self.args.      
+00016850: 2020 6c6f 7765 725f 6469 7669 736f 722c    lower_divisor,
+00016860: 2075 7070 6572 5f64 6976 6973 6f72 203d   upper_divisor =
+00016870: 2064 6976 6973 6f72 2e5f 696e 7462 6f75   divisor._intbou
+00016880: 6e64 730a 2020 2020 2020 2020 6966 206c  nds.        if l
+00016890: 6f77 6572 5f64 6976 6973 6f72 203e 2030  ower_divisor > 0
+000168a0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+000168b0: 7765 725f 6469 7669 6465 6e64 2c20 7570  wer_dividend, up
+000168c0: 7065 725f 6469 7669 6465 6e64 203d 2064  per_dividend = d
+000168d0: 6976 6964 656e 642e 5f69 6e74 626f 756e  ividend._intboun
+000168e0: 6473 0a20 2020 2020 2020 2020 2020 2069  ds.            i
+000168f0: 6620 3020 3c3d 206c 6f77 6572 5f64 6976  f 0 <= lower_div
+00016900: 6964 656e 6420 616e 6420 7570 7065 725f  idend and upper_
+00016910: 6469 7669 6465 6e64 203c 206c 6f77 6572  dividend < lower
+00016920: 5f64 6976 6973 6f72 3a0a 2020 2020 2020  _divisor:.      
+00016930: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00016940: 206c 6f77 6572 5f64 6976 6964 656e 642c   lower_dividend,
+00016950: 2075 7070 6572 5f64 6976 6964 656e 640a   upper_dividend.
+00016960: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00016970: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016980: 2020 7265 7475 726e 2030 2c20 7570 7065    return 0, uppe
+00016990: 725f 6469 7669 736f 7220 2d20 310a 2020  r_divisor - 1.  
+000169a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000169b0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+000169c0: 7570 6572 2829 2e5f 696e 7462 6f75 6e64  uper()._intbound
+000169d0: 735f 696d 706c 2829 0a0a 2020 2020 6465  s_impl()..    de
+000169e0: 6620 5f73 696d 706c 6966 6965 6428 7365  f _simplified(se
+000169f0: 6c66 293a 0a20 2020 2020 2020 2064 6976  lf):.        div
+00016a00: 6964 656e 642c 2064 6976 6973 6f72 203d  idend, divisor =
+00016a10: 2073 656c 662e 6172 6773 0a20 2020 2020   self.args.     
+00016a20: 2020 206c 6f77 6572 5f64 6976 6973 6f72     lower_divisor
+00016a30: 2c20 7570 7065 725f 6469 7669 736f 7220  , upper_divisor 
+00016a40: 3d20 6469 7669 736f 722e 5f69 6e74 626f  = divisor._intbo
+00016a50: 756e 6473 0a20 2020 2020 2020 2069 6620  unds.        if 
+00016a60: 6c6f 7765 725f 6469 7669 736f 7220 3e20  lower_divisor > 
+00016a70: 303a 0a20 2020 2020 2020 2020 2020 206c  0:.            l
+00016a80: 6f77 6572 5f64 6976 6964 656e 642c 2075  ower_dividend, u
+00016a90: 7070 6572 5f64 6976 6964 656e 6420 3d20  pper_dividend = 
+00016aa0: 6469 7669 6465 6e64 2e5f 696e 7462 6f75  dividend._intbou
+00016ab0: 6e64 730a 2020 2020 2020 2020 2020 2020  nds.            
+00016ac0: 6966 2030 203c 3d20 6c6f 7765 725f 6469  if 0 <= lower_di
+00016ad0: 7669 6465 6e64 2061 6e64 2075 7070 6572  vidend and upper
+00016ae0: 5f64 6976 6964 656e 6420 3c20 6c6f 7765  _dividend < lowe
+00016af0: 725f 6469 7669 736f 723a 0a20 2020 2020  r_divisor:.     
+00016b00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00016b10: 6e20 6469 7669 6465 6e64 0a20 2020 2020  n dividend.     
+00016b20: 2020 2072 6574 7572 6e20 7375 7065 7228     return super(
+00016b30: 292e 5f73 696d 706c 6966 6965 6428 290a  )._simplified().
+00016b40: 0a0a 636c 6173 7320 4172 6354 616e 3228  ..class ArcTan2(
+00016b50: 506f 696e 7477 6973 6529 3a0a 2020 2020  Pointwise):.    
+00016b60: 6576 616c 6620 3d20 7374 6174 6963 6d65  evalf = staticme
+00016b70: 7468 6f64 286e 756d 7079 2e61 7263 7461  thod(numpy.arcta
+00016b80: 6e32 290a 2020 2020 6465 7269 7620 3d20  n2).    deriv = 
+00016b90: 6c61 6d62 6461 2078 2c20 793a 2079 202f  lambda x, y: y /
+00016ba0: 2028 782a 2a32 202b 2079 2a2a 3229 2c20   (x**2 + y**2), 
+00016bb0: 6c61 6d62 6461 2078 2c20 793a 202d 7820  lambda x, y: -x 
+00016bc0: 2f20 2878 2a2a 3220 2b20 792a 2a32 290a  / (x**2 + y**2).
+00016bd0: 2020 2020 6465 6620 7265 7475 726e 5f74      def return_t
+00016be0: 7970 6528 5431 2c20 5432 293a 0a20 2020  ype(T1, T2):.   
+00016bf0: 2020 2020 2069 6620 5431 203d 3d20 636f       if T1 == co
+00016c00: 6d70 6c65 7820 6f72 2054 3220 3d3d 2063  mplex or T2 == c
+00016c10: 6f6d 706c 6578 3a0a 2020 2020 2020 2020  omplex:.        
+00016c20: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00016c30: 7272 6f72 2827 6172 6374 616e 3220 6973  rror('arctan2 is
+00016c40: 206e 6f74 2064 6566 696e 6564 2066 6f72   not defined for
+00016c50: 2063 6f6d 706c 6578 206e 756d 6265 7273   complex numbers
+00016c60: 2729 0a20 2020 2020 2020 2072 6574 7572  ').        retur
+00016c70: 6e20 666c 6f61 740a 0a0a 636c 6173 7320  n float...class 
+00016c80: 4772 6561 7465 7228 506f 696e 7477 6973  Greater(Pointwis
+00016c90: 6529 3a0a 2020 2020 6576 616c 6620 3d20  e):.    evalf = 
+00016ca0: 7374 6174 6963 6d65 7468 6f64 286e 756d  staticmethod(num
+00016cb0: 7079 2e67 7265 6174 6572 290a 2020 2020  py.greater).    
+00016cc0: 6465 6620 7265 7475 726e 5f74 7970 6528  def return_type(
+00016cd0: 5431 2c20 5432 293a 0a20 2020 2020 2020  T1, T2):.       
+00016ce0: 2069 6620 5431 203d 3d20 636f 6d70 6c65   if T1 == comple
+00016cf0: 7820 6f72 2054 3220 3d3d 2063 6f6d 706c  x or T2 == compl
+00016d00: 6578 3a0a 2020 2020 2020 2020 2020 2020  ex:.            
+00016d10: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00016d20: 2827 436f 6d70 6c65 7820 6e75 6d62 6572  ('Complex number
+00016d30: 7320 6861 7665 206e 6f20 746f 7461 6c20  s have no total 
+00016d40: 6f72 6465 722e 2729 0a20 2020 2020 2020  order.').       
+00016d50: 2072 6574 7572 6e20 626f 6f6c 0a0a 0a63   return bool...c
+00016d60: 6c61 7373 2045 7175 616c 2850 6f69 6e74  lass Equal(Point
+00016d70: 7769 7365 293a 0a20 2020 2065 7661 6c66  wise):.    evalf
+00016d80: 203d 2073 7461 7469 636d 6574 686f 6428   = staticmethod(
+00016d90: 6e75 6d70 792e 6571 7561 6c29 0a20 2020  numpy.equal).   
+00016da0: 2072 6574 7572 6e5f 7479 7065 203d 206c   return_type = l
+00016db0: 616d 6264 6120 5431 2c20 5432 3a20 626f  ambda T1, T2: bo
+00016dc0: 6f6c 0a0a 2020 2020 6465 6620 5f73 696d  ol..    def _sim
+00016dd0: 706c 6966 6965 6428 7365 6c66 293a 0a20  plified(self):. 
+00016de0: 2020 2020 2020 2061 312c 2061 3220 3d20         a1, a2 = 
+00016df0: 7365 6c66 2e61 7267 730a 2020 2020 2020  self.args.      
+00016e00: 2020 6966 2061 3120 3d3d 2061 323a 0a20    if a1 == a2:. 
+00016e10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00016e20: 6e20 6f6e 6573 2873 656c 662e 7368 6170  n ones(self.shap
+00016e30: 652c 2062 6f6f 6c29 0a20 2020 2020 2020  e, bool).       
+00016e40: 2069 6620 7365 6c66 2e6e 6469 6d20 3d3d   if self.ndim ==
+00016e50: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
+00016e60: 7531 2c20 7731 203d 2075 6e61 6c69 676e  u1, w1 = unalign
+00016e70: 2861 3129 0a20 2020 2020 2020 2020 2020  (a1).           
+00016e80: 2075 322c 2077 3220 3d20 756e 616c 6967   u2, w2 = unalig
+00016e90: 6e28 6132 290a 2020 2020 2020 2020 2020  n(a2).          
+00016ea0: 2020 6966 2075 312e 6e64 696d 203d 3d20    if u1.ndim == 
+00016eb0: 7532 2e6e 6469 6d20 3d3d 2031 2061 6e64  u2.ndim == 1 and
+00016ec0: 2075 3120 3d3d 2075 3220 616e 6420 7731   u1 == u2 and w1
+00016ed0: 2021 3d20 7732 2061 6e64 2069 7369 6e73   != w2 and isins
+00016ee0: 7461 6e63 6528 7531 2c20 5261 6e67 6529  tance(u1, Range)
+00016ef0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016f00: 2020 2320 4e4f 5445 3a20 4f6e 6365 2077    # NOTE: Once w
+00016f10: 6520 696e 7472 6f64 7563 6520 6973 756e  e introduce isun
+00016f20: 6971 7565 2077 6520 6361 6e20 7265 6c61  ique we can rela
+00016f30: 7820 7468 6520 5261 6e67 6520 626f 756e  x the Range boun
+00016f40: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00016f50: 2020 7265 7475 726e 2044 6961 676f 6e61    return Diagona
+00016f60: 6c69 7a65 286f 6e65 7328 7531 2e73 6861  lize(ones(u1.sha
+00016f70: 7065 2c20 626f 6f6c 2929 0a20 2020 2020  pe, bool)).     
+00016f80: 2020 2072 6574 7572 6e20 7375 7065 7228     return super(
+00016f90: 292e 5f73 696d 706c 6966 6965 6428 290a  )._simplified().
+00016fa0: 0a0a 636c 6173 7320 4c65 7373 2850 6f69  ..class Less(Poi
+00016fb0: 6e74 7769 7365 293a 0a20 2020 2065 7661  ntwise):.    eva
+00016fc0: 6c66 203d 2073 7461 7469 636d 6574 686f  lf = staticmetho
+00016fd0: 6428 6e75 6d70 792e 6c65 7373 290a 2020  d(numpy.less).  
+00016fe0: 2020 6465 6620 7265 7475 726e 5f74 7970    def return_typ
+00016ff0: 6528 5431 2c20 5432 293a 0a20 2020 2020  e(T1, T2):.     
+00017000: 2020 2069 6620 5431 203d 3d20 636f 6d70     if T1 == comp
+00017010: 6c65 7820 6f72 2054 3220 3d3d 2063 6f6d  lex or T2 == com
+00017020: 706c 6578 3a0a 2020 2020 2020 2020 2020  plex:.          
+00017030: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00017040: 6f72 2827 436f 6d70 6c65 7820 6e75 6d62  or('Complex numb
+00017050: 6572 7320 6861 7665 206e 6f20 746f 7461  ers have no tota
+00017060: 6c20 6f72 6465 722e 2729 0a20 2020 2020  l order.').     
+00017070: 2020 2072 6574 7572 6e20 626f 6f6c 0a0a     return bool..
+00017080: 0a63 6c61 7373 204d 696e 696d 756d 2850  .class Minimum(P
+00017090: 6f69 6e74 7769 7365 293a 0a20 2020 2065  ointwise):.    e
+000170a0: 7661 6c66 203d 2073 7461 7469 636d 6574  valf = staticmet
+000170b0: 686f 6428 6e75 6d70 792e 6d69 6e69 6d75  hod(numpy.minimu
+000170c0: 6d29 0a20 2020 2064 6572 6976 203d 206c  m).    deriv = l
+000170d0: 616d 6264 6120 782c 2079 3a20 2e35 202d  ambda x, y: .5 -
+000170e0: 202e 3520 2a20 5369 676e 2878 202d 2079   .5 * Sign(x - y
+000170f0: 292c 206c 616d 6264 6120 782c 2079 3a20  ), lambda x, y: 
+00017100: 2e35 202b 202e 3520 2a20 5369 676e 2878  .5 + .5 * Sign(x
+00017110: 202d 2079 290a 2020 2020 6465 6620 7265   - y).    def re
+00017120: 7475 726e 5f74 7970 6528 5431 2c20 5432  turn_type(T1, T2
+00017130: 293a 0a20 2020 2020 2020 2069 6620 5431  ):.        if T1
+00017140: 203d 3d20 636f 6d70 6c65 7820 6f72 2054   == complex or T
+00017150: 3220 3d3d 2063 6f6d 706c 6578 3a0a 2020  2 == complex:.  
+00017160: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00017170: 5661 6c75 6545 7272 6f72 2827 436f 6d70  ValueError('Comp
+00017180: 6c65 7820 6e75 6d62 6572 7320 6861 7665  lex numbers have
+00017190: 206e 6f20 746f 7461 6c20 6f72 6465 722e   no total order.
+000171a0: 2729 0a20 2020 2020 2020 2072 6574 7572  ').        retur
+000171b0: 6e20 666c 6f61 7420 6966 2066 6c6f 6174  n float if float
+000171c0: 2069 6e20 2854 312c 2054 3229 2065 6c73   in (T1, T2) els
+000171d0: 6520 696e 7420 6966 2069 6e74 2069 6e20  e int if int in 
+000171e0: 2854 312c 2054 3229 2065 6c73 6520 626f  (T1, T2) else bo
+000171f0: 6f6c 0a0a 2020 2020 6465 6620 5f73 696d  ol..    def _sim
+00017200: 706c 6966 6965 6428 7365 6c66 293a 0a20  plified(self):. 
+00017210: 2020 2020 2020 2069 6620 7365 6c66 2e64         if self.d
+00017220: 7479 7065 203d 3d20 696e 743a 0a20 2020  type == int:.   
+00017230: 2020 2020 2020 2020 206c 6f77 6572 312c           lower1,
+00017240: 2075 7070 6572 3120 3d20 7365 6c66 2e61   upper1 = self.a
+00017250: 7267 735b 305d 2e5f 696e 7462 6f75 6e64  rgs[0]._intbound
+00017260: 730a 2020 2020 2020 2020 2020 2020 6c6f  s.            lo
+00017270: 7765 7232 2c20 7570 7065 7232 203d 2073  wer2, upper2 = s
+00017280: 656c 662e 6172 6773 5b31 5d2e 5f69 6e74  elf.args[1]._int
+00017290: 626f 756e 6473 0a20 2020 2020 2020 2020  bounds.         
+000172a0: 2020 2069 6620 7570 7065 7231 203c 3d20     if upper1 <= 
+000172b0: 6c6f 7765 7232 3a0a 2020 2020 2020 2020  lower2:.        
+000172c0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+000172d0: 656c 662e 6172 6773 5b30 5d0a 2020 2020  elf.args[0].    
+000172e0: 2020 2020 2020 2020 656c 6966 2075 7070          elif upp
+000172f0: 6572 3220 3c3d 206c 6f77 6572 313a 0a20  er2 <= lower1:. 
+00017300: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00017310: 6574 7572 6e20 7365 6c66 2e61 7267 735b  eturn self.args[
+00017320: 315d 0a20 2020 2020 2020 2072 6574 7572  1].        retur
+00017330: 6e20 7375 7065 7228 292e 5f73 696d 706c  n super()._simpl
+00017340: 6966 6965 6428 290a 0a20 2020 2064 6566  ified()..    def
+00017350: 205f 696e 7462 6f75 6e64 735f 696d 706c   _intbounds_impl
+00017360: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00017370: 6c6f 7765 7231 2c20 7570 7065 7231 203d  lower1, upper1 =
+00017380: 2073 656c 662e 6172 6773 5b30 5d2e 5f69   self.args[0]._i
+00017390: 6e74 626f 756e 6473 0a20 2020 2020 2020  ntbounds.       
+000173a0: 206c 6f77 6572 322c 2075 7070 6572 3220   lower2, upper2 
+000173b0: 3d20 7365 6c66 2e61 7267 735b 315d 2e5f  = self.args[1]._
+000173c0: 696e 7462 6f75 6e64 730a 2020 2020 2020  intbounds.      
+000173d0: 2020 7265 7475 726e 206d 696e 286c 6f77    return min(low
+000173e0: 6572 312c 206c 6f77 6572 3229 2c20 6d69  er1, lower2), mi
+000173f0: 6e28 7570 7065 7231 2c20 7570 7065 7232  n(upper1, upper2
+00017400: 290a 0a0a 636c 6173 7320 4d61 7869 6d75  )...class Maximu
+00017410: 6d28 506f 696e 7477 6973 6529 3a0a 2020  m(Pointwise):.  
+00017420: 2020 6576 616c 6620 3d20 7374 6174 6963    evalf = static
+00017430: 6d65 7468 6f64 286e 756d 7079 2e6d 6178  method(numpy.max
+00017440: 696d 756d 290a 2020 2020 6465 7269 7620  imum).    deriv 
+00017450: 3d20 6c61 6d62 6461 2078 2c20 793a 202e  = lambda x, y: .
+00017460: 3520 2b20 2e35 202a 2053 6967 6e28 7820  5 + .5 * Sign(x 
+00017470: 2d20 7929 2c20 6c61 6d62 6461 2078 2c20  - y), lambda x, 
+00017480: 793a 202e 3520 2d20 2e35 202a 2053 6967  y: .5 - .5 * Sig
+00017490: 6e28 7820 2d20 7929 0a20 2020 2064 6566  n(x - y).    def
+000174a0: 2072 6574 7572 6e5f 7479 7065 2854 312c   return_type(T1,
+000174b0: 2054 3229 3a0a 2020 2020 2020 2020 6966   T2):.        if
+000174c0: 2054 3120 3d3d 2063 6f6d 706c 6578 206f   T1 == complex o
+000174d0: 7220 5432 203d 3d20 636f 6d70 6c65 783a  r T2 == complex:
+000174e0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000174f0: 7365 2056 616c 7565 4572 726f 7228 2743  se ValueError('C
+00017500: 6f6d 706c 6578 206e 756d 6265 7273 2068  omplex numbers h
+00017510: 6176 6520 6e6f 2074 6f74 616c 206f 7264  ave no total ord
+00017520: 6572 2e27 290a 2020 2020 2020 2020 7265  er.').        re
+00017530: 7475 726e 2066 6c6f 6174 2069 6620 666c  turn float if fl
+00017540: 6f61 7420 696e 2028 5431 2c20 5432 2920  oat in (T1, T2) 
+00017550: 656c 7365 2069 6e74 2069 6620 696e 7420  else int if int 
+00017560: 696e 2028 5431 2c20 5432 2920 656c 7365  in (T1, T2) else
+00017570: 2062 6f6f 6c0a 0a20 2020 2064 6566 205f   bool..    def _
+00017580: 7369 6d70 6c69 6669 6564 2873 656c 6629  simplified(self)
+00017590: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
+000175a0: 662e 6474 7970 6520 3d3d 2069 6e74 3a0a  f.dtype == int:.
+000175b0: 2020 2020 2020 2020 2020 2020 6c6f 7765              lowe
+000175c0: 7231 2c20 7570 7065 7231 203d 2073 656c  r1, upper1 = sel
+000175d0: 662e 6172 6773 5b30 5d2e 5f69 6e74 626f  f.args[0]._intbo
+000175e0: 756e 6473 0a20 2020 2020 2020 2020 2020  unds.           
+000175f0: 206c 6f77 6572 322c 2075 7070 6572 3220   lower2, upper2 
+00017600: 3d20 7365 6c66 2e61 7267 735b 315d 2e5f  = self.args[1]._
+00017610: 696e 7462 6f75 6e64 730a 2020 2020 2020  intbounds.      
+00017620: 2020 2020 2020 6966 2075 7070 6572 3220        if upper2 
+00017630: 3c3d 206c 6f77 6572 313a 0a20 2020 2020  <= lower1:.     
+00017640: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00017650: 6e20 7365 6c66 2e61 7267 735b 305d 0a20  n self.args[0]. 
+00017660: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00017670: 7570 7065 7231 203c 3d20 6c6f 7765 7232  upper1 <= lower2
+00017680: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017690: 2020 7265 7475 726e 2073 656c 662e 6172    return self.ar
+000176a0: 6773 5b31 5d0a 2020 2020 2020 2020 7265  gs[1].        re
+000176b0: 7475 726e 2073 7570 6572 2829 2e5f 7369  turn super()._si
+000176c0: 6d70 6c69 6669 6564 2829 0a0a 2020 2020  mplified()..    
+000176d0: 6465 6620 5f69 6e74 626f 756e 6473 5f69  def _intbounds_i
+000176e0: 6d70 6c28 7365 6c66 293a 0a20 2020 2020  mpl(self):.     
+000176f0: 2020 206c 6f77 6572 312c 2075 7070 6572     lower1, upper
+00017700: 3120 3d20 7365 6c66 2e61 7267 735b 305d  1 = self.args[0]
+00017710: 2e5f 696e 7462 6f75 6e64 730a 2020 2020  ._intbounds.    
+00017720: 2020 2020 6c6f 7765 7232 2c20 7570 7065      lower2, uppe
+00017730: 7232 203d 2073 656c 662e 6172 6773 5b31  r2 = self.args[1
+00017740: 5d2e 5f69 6e74 626f 756e 6473 0a20 2020  ]._intbounds.   
+00017750: 2020 2020 2072 6574 7572 6e20 6d61 7828       return max(
+00017760: 6c6f 7765 7231 2c20 6c6f 7765 7232 292c  lower1, lower2),
+00017770: 206d 6178 2875 7070 6572 312c 2075 7070   max(upper1, upp
+00017780: 6572 3229 0a0a 0a63 6c61 7373 2043 6f6e  er2)...class Con
+00017790: 6a75 6761 7465 2850 6f69 6e74 7769 7365  jugate(Pointwise
+000177a0: 293a 0a20 2020 2065 7661 6c66 203d 2073  ):.    evalf = s
+000177b0: 7461 7469 636d 6574 686f 6428 6e75 6d70  taticmethod(nump
+000177c0: 792e 636f 6e6a 7567 6174 6529 0a20 2020  y.conjugate).   
+000177d0: 2072 6574 7572 6e5f 7479 7065 203d 206c   return_type = l
+000177e0: 616d 6264 6120 543a 2069 6e74 2069 6620  ambda T: int if 
+000177f0: 5420 3d3d 2062 6f6f 6c20 656c 7365 2054  T == bool else T
+00017800: 0a0a 2020 2020 6465 6620 5f73 696d 706c  ..    def _simpl
+00017810: 6966 6965 6428 7365 6c66 293a 0a20 2020  ified(self):.   
+00017820: 2020 2020 2072 6574 7661 6c20 3d20 7365       retval = se
+00017830: 6c66 2e61 7267 735b 305d 2e5f 636f 6e6a  lf.args[0]._conj
+00017840: 7567 6174 6528 290a 2020 2020 2020 2020  ugate().        
+00017850: 6966 2072 6574 7661 6c20 6973 206e 6f74  if retval is not
+00017860: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00017870: 2020 2072 6574 7572 6e20 7265 7476 616c     return retval
+00017880: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00017890: 7375 7065 7228 292e 5f73 696d 706c 6966  super()._simplif
+000178a0: 6965 6428 290a 0a0a 636c 6173 7320 5265  ied()...class Re
+000178b0: 616c 2850 6f69 6e74 7769 7365 293a 0a20  al(Pointwise):. 
+000178c0: 2020 2065 7661 6c66 203d 2073 7461 7469     evalf = stati
+000178d0: 636d 6574 686f 6428 6e75 6d70 792e 7265  cmethod(numpy.re
+000178e0: 616c 290a 2020 2020 7265 7475 726e 5f74  al).    return_t
+000178f0: 7970 6520 3d20 6c61 6d62 6461 2054 3a20  ype = lambda T: 
+00017900: 666c 6f61 7420 6966 2054 203d 3d20 636f  float if T == co
+00017910: 6d70 6c65 7820 656c 7365 2054 0a0a 2020  mplex else T..  
+00017920: 2020 6465 6620 5f73 696d 706c 6966 6965    def _simplifie
+00017930: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
+00017940: 2072 6574 7661 6c20 3d20 7365 6c66 2e61   retval = self.a
+00017950: 7267 735b 305d 2e5f 7265 616c 2829 0a20  rgs[0]._real(). 
+00017960: 2020 2020 2020 2069 6620 7265 7476 616c         if retval
+00017970: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00017980: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00017990: 2072 6574 7661 6c0a 2020 2020 2020 2020   retval.        
+000179a0: 7265 7475 726e 2073 7570 6572 2829 2e5f  return super()._
+000179b0: 7369 6d70 6c69 6669 6564 2829 0a0a 0a63  simplified()...c
+000179c0: 6c61 7373 2049 6d61 6728 506f 696e 7477  lass Imag(Pointw
+000179d0: 6973 6529 3a0a 2020 2020 6576 616c 6620  ise):.    evalf 
+000179e0: 3d20 7374 6174 6963 6d65 7468 6f64 286e  = staticmethod(n
+000179f0: 756d 7079 2e69 6d61 6729 0a20 2020 2072  umpy.imag).    r
+00017a00: 6574 7572 6e5f 7479 7065 203d 206c 616d  eturn_type = lam
+00017a10: 6264 6120 543a 2066 6c6f 6174 2069 6620  bda T: float if 
+00017a20: 5420 3d3d 2063 6f6d 706c 6578 2065 6c73  T == complex els
+00017a30: 6520 540a 0a20 2020 2064 6566 205f 7369  e T..    def _si
+00017a40: 6d70 6c69 6669 6564 2873 656c 6629 3a0a  mplified(self):.
+00017a50: 2020 2020 2020 2020 7265 7476 616c 203d          retval =
+00017a60: 2073 656c 662e 6172 6773 5b30 5d2e 5f69   self.args[0]._i
+00017a70: 6d61 6728 290a 2020 2020 2020 2020 6966  mag().        if
+00017a80: 2072 6574 7661 6c20 6973 206e 6f74 204e   retval is not N
+00017a90: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00017aa0: 2072 6574 7572 6e20 7265 7476 616c 0a20   return retval. 
+00017ab0: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
+00017ac0: 7065 7228 292e 5f73 696d 706c 6966 6965  per()._simplifie
+00017ad0: 6428 290a 0a0a 636c 6173 7320 4361 7374  d()...class Cast
+00017ae0: 2850 6f69 6e74 7769 7365 293a 0a0a 2020  (Pointwise):..  
+00017af0: 2020 6465 6620 6576 616c 6628 7365 6c66    def evalf(self
+00017b00: 2c20 6172 6729 3a0a 2020 2020 2020 2020  , arg):.        
+00017b10: 7265 7475 726e 206e 756d 7079 2e61 7272  return numpy.arr
+00017b20: 6179 2861 7267 2c20 6474 7970 653d 7365  ay(arg, dtype=se
+00017b30: 6c66 2e64 7479 7065 290a 0a20 2020 2064  lf.dtype)..    d
+00017b40: 6566 205f 7369 6d70 6c69 6669 6564 2873  ef _simplified(s
+00017b50: 656c 6629 3a0a 2020 2020 2020 2020 6172  elf):.        ar
+00017b60: 672c 203d 2073 656c 662e 6172 6773 0a20  g, = self.args. 
+00017b70: 2020 2020 2020 2069 6620 6973 7a65 726f         if iszero
+00017b80: 2861 7267 293a 0a20 2020 2020 2020 2020  (arg):.         
+00017b90: 2020 2072 6574 7572 6e20 7a65 726f 735f     return zeros_
+00017ba0: 6c69 6b65 2873 656c 6629 0a20 2020 2020  like(self).     
+00017bb0: 2020 2066 6f72 2061 7869 732c 2070 6172     for axis, par
+00017bc0: 7473 2069 6e20 6172 672e 5f69 6e66 6c61  ts in arg._infla
+00017bd0: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+00017be0: 2020 2072 6574 7572 6e20 7574 696c 2e73     return util.s
+00017bf0: 756d 285f 696e 666c 6174 6528 7365 6c66  um(_inflate(self
+00017c00: 2e5f 6e65 7761 7267 7328 6675 6e63 292c  ._newargs(func),
+00017c10: 2064 6f66 6d61 702c 2073 656c 662e 7368   dofmap, self.sh
+00017c20: 6170 655b 6178 6973 5d2c 2061 7869 7329  ape[axis], axis)
+00017c30: 2066 6f72 2064 6f66 6d61 702c 2066 756e   for dofmap, fun
+00017c40: 6320 696e 2070 6172 7473 2e69 7465 6d73  c in parts.items
+00017c50: 2829 290a 2020 2020 2020 2020 7265 7475  ()).        retu
+00017c60: 726e 2073 7570 6572 2829 2e5f 7369 6d70  rn super()._simp
+00017c70: 6c69 6669 6564 2829 0a0a 2020 2020 6465  lified()..    de
+00017c80: 6620 5f69 6e74 626f 756e 6473 5f69 6d70  f _intbounds_imp
+00017c90: 6c28 7365 6c66 293a 0a20 2020 2020 2020  l(self):.       
+00017ca0: 2069 6620 7365 6c66 2e61 7267 735b 305d   if self.args[0]
+00017cb0: 2e64 7479 7065 203d 3d20 626f 6f6c 3a0a  .dtype == bool:.
+00017cc0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00017cd0: 726e 2030 2c20 310a 2020 2020 2020 2020  rn 0, 1.        
+00017ce0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00017cf0: 2020 7265 7475 726e 2073 656c 662e 6172    return self.ar
+00017d00: 6773 5b30 5d2e 5f69 6e74 626f 756e 6473  gs[0]._intbounds
+00017d10: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00017d20: 2020 2020 6465 6620 5f63 6f6e 7374 5f75      def _const_u
+00017d30: 6e69 666f 726d 2873 656c 6629 3a0a 2020  niform(self):.  
+00017d40: 2020 2020 2020 7661 6c75 6520 3d20 7365        value = se
+00017d50: 6c66 2e61 7267 735b 305d 2e5f 636f 6e73  lf.args[0]._cons
+00017d60: 745f 756e 6966 6f72 6d0a 2020 2020 2020  t_uniform.      
+00017d70: 2020 6966 2076 616c 7565 2069 7320 6e6f    if value is no
+00017d80: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00017d90: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00017da0: 6474 7970 6528 7661 6c75 6529 0a0a 0a63  dtype(value)...c
+00017db0: 6c61 7373 2042 6f6f 6c54 6f49 6e74 2843  lass BoolToInt(C
+00017dc0: 6173 7429 3a0a 2020 2020 6465 6620 7265  ast):.    def re
+00017dd0: 7475 726e 5f74 7970 6528 5429 3a0a 2020  turn_type(T):.  
+00017de0: 2020 2020 2020 6966 2054 2021 3d20 626f        if T != bo
+00017df0: 6f6c 3a0a 2020 2020 2020 2020 2020 2020  ol:.            
+00017e00: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
+00017e10: 6627 4578 7065 6374 6564 2061 6e20 6172  f'Expected an ar
+00017e20: 7261 7920 7769 7468 2064 7479 7065 2062  ray with dtype b
+00017e30: 6f6f 6c20 6275 7420 676f 7420 7b54 2e5f  ool but got {T._
+00017e40: 5f6e 616d 655f 5f7d 2e27 290a 2020 2020  _name__}.').    
+00017e50: 2020 2020 7265 7475 726e 2069 6e74 0a0a      return int..
+00017e60: 0a63 6c61 7373 2049 6e74 546f 466c 6f61  .class IntToFloa
+00017e70: 7428 4361 7374 293a 0a20 2020 2064 6566  t(Cast):.    def
+00017e80: 2072 6574 7572 6e5f 7479 7065 2854 293a   return_type(T):
+00017e90: 0a20 2020 2020 2020 2069 6620 5420 213d  .        if T !=
+00017ea0: 2069 6e74 3a0a 2020 2020 2020 2020 2020   int:.          
+00017eb0: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
+00017ec0: 7228 6627 4578 7065 6374 6564 2061 6e20  r(f'Expected an 
+00017ed0: 6172 7261 7920 7769 7468 2064 7479 7065  array with dtype
+00017ee0: 2069 6e74 2062 7574 2067 6f74 207b 542e   int but got {T.
+00017ef0: 5f5f 6e61 6d65 5f5f 7d2e 2729 0a20 2020  __name__}.').   
+00017f00: 2020 2020 2072 6574 7572 6e20 666c 6f61       return floa
+00017f10: 740a 0a20 2020 2064 6566 205f 6164 6428  t..    def _add(
+00017f20: 7365 6c66 2c20 6f74 6865 7229 3a0a 2020  self, other):.  
+00017f30: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00017f40: 6e63 6528 6f74 6865 722c 205f 5f63 6c61  nce(other, __cla
+00017f50: 7373 5f5f 293a 0a20 2020 2020 2020 2020  ss__):.         
+00017f60: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00017f70: 6e65 7761 7267 7328 7365 6c66 2e61 7267  newargs(self.arg
+00017f80: 735b 305d 202b 206f 7468 6572 2e61 7267  s[0] + other.arg
+00017f90: 735b 305d 290a 0a20 2020 2064 6566 205f  s[0])..    def _
+00017fa0: 6d75 6c74 6970 6c79 2873 656c 662c 206f  multiply(self, o
+00017fb0: 7468 6572 293a 0a20 2020 2020 2020 2069  ther):.        i
+00017fc0: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
+00017fd0: 6572 2c20 5f5f 636c 6173 735f 5f29 3a0a  er, __class__):.
+00017fe0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00017ff0: 726e 2073 656c 662e 5f6e 6577 6172 6773  rn self._newargs
+00018000: 2873 656c 662e 6172 6773 5b30 5d20 2a20  (self.args[0] * 
+00018010: 6f74 6865 722e 6172 6773 5b30 5d29 0a0a  other.args[0])..
+00018020: 2020 2020 6465 6620 5f73 756d 2873 656c      def _sum(sel
+00018030: 662c 2061 7869 7329 3a0a 2020 2020 2020  f, axis):.      
+00018040: 2020 7265 7475 726e 2073 656c 662e 5f6e    return self._n
+00018050: 6577 6172 6773 2873 756d 2873 656c 662e  ewargs(sum(self.
+00018060: 6172 6773 5b30 5d2c 2061 7869 7329 290a  args[0], axis)).
+00018070: 0a20 2020 2064 6566 205f 7072 6f64 7563  .    def _produc
+00018080: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
+00018090: 2072 6574 7572 6e20 7365 6c66 2e5f 6e65   return self._ne
+000180a0: 7761 7267 7328 7072 6f64 7563 7428 7365  wargs(product(se
+000180b0: 6c66 2e61 7267 735b 305d 2c20 2d31 2929  lf.args[0], -1))
+000180c0: 0a0a 2020 2020 6465 6620 5f73 6967 6e28  ..    def _sign(
+000180d0: 7365 6c66 293a 0a20 2020 2020 2020 2061  self):.        a
+000180e0: 7373 6572 7420 7365 6c66 2e64 7479 7065  ssert self.dtype
+000180f0: 2021 3d20 636f 6d70 6c65 780a 2020 2020   != complex.    
+00018100: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00018110: 5f6e 6577 6172 6773 2873 6967 6e28 7365  _newargs(sign(se
+00018120: 6c66 2e61 7267 735b 305d 2929 0a0a 2020  lf.args[0]))..  
+00018130: 2020 6465 6620 5f64 6572 6976 6174 6976    def _derivativ
+00018140: 6528 7365 6c66 2c20 7661 722c 2073 6565  e(self, var, see
+00018150: 6e29 3a0a 2020 2020 2020 2020 7265 7475  n):.        retu
+00018160: 726e 205a 6572 6f73 2873 656c 662e 7368  rn Zeros(self.sh
+00018170: 6170 6520 2b20 7661 722e 7368 6170 652c  ape + var.shape,
+00018180: 2064 7479 7065 3d73 656c 662e 6474 7970   dtype=self.dtyp
+00018190: 6529 0a0a 0a63 6c61 7373 2046 6c6f 6174  e)...class Float
+000181a0: 546f 436f 6d70 6c65 7828 4361 7374 293a  ToComplex(Cast):
+000181b0: 0a20 2020 2064 6566 2072 6574 7572 6e5f  .    def return_
+000181c0: 7479 7065 2854 293a 0a20 2020 2020 2020  type(T):.       
+000181d0: 2069 6620 5420 213d 2066 6c6f 6174 3a0a   if T != float:.
+000181e0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000181f0: 6520 5479 7065 4572 726f 7228 6627 4578  e TypeError(f'Ex
+00018200: 7065 6374 6564 2061 6e20 6172 7261 7920  pected an array 
+00018210: 7769 7468 2064 7479 7065 2066 6c6f 6174  with dtype float
+00018220: 2062 7574 2067 6f74 207b 542e 5f5f 6e61   but got {T.__na
+00018230: 6d65 5f5f 7d2e 2729 0a20 2020 2020 2020  me__}.').       
+00018240: 2072 6574 7572 6e20 636f 6d70 6c65 780a   return complex.
+00018250: 0a20 2020 2064 6566 205f 6164 6428 7365  .    def _add(se
+00018260: 6c66 2c20 6f74 6865 7229 3a0a 2020 2020  lf, other):.    
+00018270: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00018280: 6528 6f74 6865 722c 205f 5f63 6c61 7373  e(other, __class
+00018290: 5f5f 293a 0a20 2020 2020 2020 2020 2020  __):.           
+000182a0: 2072 6574 7572 6e20 7365 6c66 2e5f 6e65   return self._ne
+000182b0: 7761 7267 7328 7365 6c66 2e61 7267 735b  wargs(self.args[
+000182c0: 305d 202b 206f 7468 6572 2e61 7267 735b  0] + other.args[
+000182d0: 305d 290a 0a20 2020 2064 6566 205f 6d75  0])..    def _mu
+000182e0: 6c74 6970 6c79 2873 656c 662c 206f 7468  ltiply(self, oth
+000182f0: 6572 293a 0a20 2020 2020 2020 2069 6620  er):.        if 
+00018300: 6973 696e 7374 616e 6365 286f 7468 6572  isinstance(other
+00018310: 2c20 5f5f 636c 6173 735f 5f29 3a0a 2020  , __class__):.  
+00018320: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00018330: 2073 656c 662e 5f6e 6577 6172 6773 2873   self._newargs(s
+00018340: 656c 662e 6172 6773 5b30 5d20 2a20 6f74  elf.args[0] * ot
+00018350: 6865 722e 6172 6773 5b30 5d29 0a0a 2020  her.args[0])..  
+00018360: 2020 6465 6620 5f73 756d 2873 656c 662c    def _sum(self,
+00018370: 2061 7869 7329 3a0a 2020 2020 2020 2020   axis):.        
+00018380: 7265 7475 726e 2073 656c 662e 5f6e 6577  return self._new
+00018390: 6172 6773 2873 756d 2873 656c 662e 6172  args(sum(self.ar
+000183a0: 6773 5b30 5d2c 2061 7869 7329 290a 0a20  gs[0], axis)).. 
+000183b0: 2020 2064 6566 205f 7072 6f64 7563 7428     def _product(
+000183c0: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
+000183d0: 6574 7572 6e20 7365 6c66 2e5f 6e65 7761  eturn self._newa
+000183e0: 7267 7328 7072 6f64 7563 7428 7365 6c66  rgs(product(self
+000183f0: 2e61 7267 735b 305d 2c20 2d31 2929 0a0a  .args[0], -1))..
+00018400: 2020 2020 6465 6620 5f72 6561 6c28 7365      def _real(se
+00018410: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
+00018420: 7572 6e20 7365 6c66 2e61 7267 735b 305d  urn self.args[0]
+00018430: 0a0a 2020 2020 6465 6620 5f69 6d61 6728  ..    def _imag(
+00018440: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
+00018450: 6574 7572 6e20 7a65 726f 735f 6c69 6b65  eturn zeros_like
+00018460: 2873 656c 662e 6172 6773 5b30 5d29 0a0a  (self.args[0])..
+00018470: 2020 2020 6465 6620 5f63 6f6e 6a75 6761      def _conjuga
+00018480: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
+00018490: 2020 7265 7475 726e 2073 656c 660a 0a20    return self.. 
+000184a0: 2020 2064 6566 205f 6465 7269 7661 7469     def _derivati
+000184b0: 7665 2873 656c 662c 2076 6172 2c20 7365  ve(self, var, se
+000184c0: 656e 293a 0a20 2020 2020 2020 2069 6620  en):.        if 
+000184d0: 7661 722e 6474 7970 6520 3d3d 2063 6f6d  var.dtype == com
+000184e0: 706c 6578 3a0a 2020 2020 2020 2020 2020  plex:.          
+000184f0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00018500: 6f72 2827 5468 6520 636f 6d70 6c65 7820  or('The complex 
+00018510: 6465 7269 7661 7469 7665 2064 6f65 7320  derivative does 
+00018520: 6e6f 7420 6578 6973 742e 2729 0a20 2020  not exist.').   
+00018530: 2020 2020 2061 7267 2c20 3d20 7365 6c66       arg, = self
+00018540: 2e61 7267 730a 2020 2020 2020 2020 7265  .args.        re
+00018550: 7475 726e 2046 6c6f 6174 546f 436f 6d70  turn FloatToComp
+00018560: 6c65 7828 6465 7269 7661 7469 7665 2861  lex(derivative(a
+00018570: 7267 2c20 7661 722c 2073 6565 6e29 290a  rg, var, seen)).
+00018580: 0a0a 6465 6620 6173 7479 7065 2861 7267  ..def astype(arg
+00018590: 2c20 6474 7970 6529 3a0a 2020 2020 6172  , dtype):.    ar
+000185a0: 6720 3d20 6173 6172 7261 7928 6172 6729  g = asarray(arg)
+000185b0: 0a20 2020 2069 203d 205f 7479 7065 5f6f  .    i = _type_o
+000185c0: 7264 6572 2e69 6e64 6578 2861 7267 2e64  rder.index(arg.d
+000185d0: 7479 7065 290a 2020 2020 6a20 3d20 5f74  type).    j = _t
+000185e0: 7970 655f 6f72 6465 722e 696e 6465 7828  ype_order.index(
+000185f0: 6474 7970 6529 0a20 2020 2069 6620 6920  dtype).    if i 
+00018600: 3e20 6a3a 0a20 2020 2020 2020 2072 6169  > j:.        rai
+00018610: 7365 2054 7970 6545 7272 6f72 2827 446f  se TypeError('Do
+00018620: 776e 6361 7374 696e 6720 6973 2066 6f72  wncasting is for
+00018630: 6269 6464 656e 2e27 290a 2020 2020 666f  bidden.').    fo
+00018640: 7220 6361 7374 2069 6e20 2842 6f6f 6c54  r cast in (BoolT
+00018650: 6f49 6e74 2c20 496e 7454 6f46 6c6f 6174  oInt, IntToFloat
+00018660: 2c20 466c 6f61 7454 6f43 6f6d 706c 6578  , FloatToComplex
+00018670: 295b 693a 6a5d 3a0a 2020 2020 2020 2020  )[i:j]:.        
+00018680: 6172 6720 3d20 6361 7374 2861 7267 290a  arg = cast(arg).
+00018690: 2020 2020 7265 7475 726e 2061 7267 0a0a      return arg..
+000186a0: 0a63 6c61 7373 2053 6967 6e28 4172 7261  .class Sign(Arra
+000186b0: 7929 3a0a 0a20 2020 2064 6566 205f 5f69  y):..    def __i
+000186c0: 6e69 745f 5f28 7365 6c66 2c20 6675 6e63  nit__(self, func
+000186d0: 3a20 4172 7261 7929 3a0a 2020 2020 2020  : Array):.      
+000186e0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+000186f0: 6e63 6528 6675 6e63 2c20 4172 7261 7929  nce(func, Array)
+00018700: 2061 6e64 2066 756e 632e 6474 7970 6520   and func.dtype 
+00018710: 213d 2063 6f6d 706c 6578 2c20 6627 6675  != complex, f'fu
+00018720: 6e63 3d7b 6675 6e63 2172 7d27 0a20 2020  nc={func!r}'.   
+00018730: 2020 2020 2073 656c 662e 6675 6e63 203d       self.func =
+00018740: 2066 756e 630a 2020 2020 2020 2020 7375   func.        su
+00018750: 7065 7228 292e 5f5f 696e 6974 5f5f 2861  per().__init__(a
+00018760: 7267 733d 2866 756e 632c 292c 2073 6861  rgs=(func,), sha
+00018770: 7065 3d66 756e 632e 7368 6170 652c 2064  pe=func.shape, d
+00018780: 7479 7065 3d66 756e 632e 6474 7970 6529  type=func.dtype)
+00018790: 0a0a 2020 2020 6465 6620 5f73 696d 706c  ..    def _simpl
+000187a0: 6966 6965 6428 7365 6c66 293a 0a20 2020  ified(self):.   
+000187b0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+000187c0: 2e66 756e 632e 5f73 6967 6e28 290a 0a20  .func._sign().. 
+000187d0: 2020 2065 7661 6c66 203d 2073 7461 7469     evalf = stati
+000187e0: 636d 6574 686f 6428 6e75 6d70 792e 7369  cmethod(numpy.si
+000187f0: 676e 290a 0a20 2020 2064 6566 205f 7461  gn)..    def _ta
+00018800: 6b65 6469 6167 2873 656c 662c 2061 7869  kediag(self, axi
+00018810: 7331 2c20 6178 6973 3229 3a0a 2020 2020  s1, axis2):.    
+00018820: 2020 2020 7265 7475 726e 2053 6967 6e28      return Sign(
+00018830: 5f74 616b 6564 6961 6728 7365 6c66 2e66  _takediag(self.f
+00018840: 756e 632c 2061 7869 7331 2c20 6178 6973  unc, axis1, axis
+00018850: 3229 290a 0a20 2020 2064 6566 205f 7461  2))..    def _ta
+00018860: 6b65 2873 656c 662c 2069 6e64 6578 2c20  ke(self, index, 
+00018870: 6178 6973 293a 0a20 2020 2020 2020 2072  axis):.        r
+00018880: 6574 7572 6e20 5369 676e 285f 7461 6b65  eturn Sign(_take
+00018890: 2873 656c 662e 6675 6e63 2c20 696e 6465  (self.func, inde
+000188a0: 782c 2061 7869 7329 290a 0a20 2020 2064  x, axis))..    d
+000188b0: 6566 205f 7369 676e 2873 656c 6629 3a0a  ef _sign(self):.
+000188c0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+000188d0: 656c 660a 0a20 2020 2064 6566 205f 756e  elf..    def _un
+000188e0: 7261 7665 6c28 7365 6c66 2c20 6178 6973  ravel(self, axis
+000188f0: 2c20 7368 6170 6529 3a0a 2020 2020 2020  , shape):.      
+00018900: 2020 7265 7475 726e 2053 6967 6e28 756e    return Sign(un
+00018910: 7261 7665 6c28 7365 6c66 2e66 756e 632c  ravel(self.func,
+00018920: 2061 7869 732c 2073 6861 7065 2929 0a0a   axis, shape))..
+00018930: 2020 2020 6465 6620 5f64 6572 6976 6174      def _derivat
+00018940: 6976 6528 7365 6c66 2c20 7661 722c 2073  ive(self, var, s
+00018950: 6565 6e29 3a0a 2020 2020 2020 2020 7265  een):.        re
+00018960: 7475 726e 205a 6572 6f73 2873 656c 662e  turn Zeros(self.
+00018970: 7368 6170 6520 2b20 7661 722e 7368 6170  shape + var.shap
+00018980: 652c 2064 7479 7065 3d73 656c 662e 6474  e, dtype=self.dt
+00018990: 7970 6529 0a0a 2020 2020 6465 6620 5f69  ype)..    def _i
+000189a0: 6e74 626f 756e 6473 5f69 6d70 6c28 7365  ntbounds_impl(se
+000189b0: 6c66 293a 0a20 2020 2020 2020 206c 6f77  lf):.        low
+000189c0: 6572 2c20 7570 7065 7220 3d20 7365 6c66  er, upper = self
+000189d0: 2e66 756e 632e 5f69 6e74 626f 756e 6473  .func._intbounds
+000189e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000189f0: 696e 7428 6e75 6d70 792e 7369 676e 286c  int(numpy.sign(l
+00018a00: 6f77 6572 2929 2c20 696e 7428 6e75 6d70  ower)), int(nump
+00018a10: 792e 7369 676e 2875 7070 6572 2929 0a0a  y.sign(upper))..
+00018a20: 0a63 6c61 7373 2053 616d 706c 6564 2841  .class Sampled(A
+00018a30: 7272 6179 293a 0a20 2020 2027 2727 4261  rray):.    '''Ba
+00018a40: 7369 732d 6c69 6b65 2069 6465 6e74 6974  sis-like identit
+00018a50: 7920 6f70 6572 6174 6f72 2e0a 0a20 2020  y operator...   
+00018a60: 2042 6173 6973 2d6c 696b 6520 6675 6e63   Basis-like func
+00018a70: 7469 6f6e 2074 6861 7420 666f 7220 6576  tion that for ev
+00018a80: 6572 7920 706f 696e 7420 6576 616c 7561  ery point evalua
+00018a90: 7465 7320 746f 2061 2070 6172 7469 7469  tes to a partiti
+00018aa0: 6f6e 206f 6620 756e 6974 790a 2020 2020  on of unity.    
+00018ab0: 6f66 2061 2070 7265 6465 6669 6e65 6420  of a predefined 
+00018ac0: 7365 7420 6261 7365 6420 6f6e 2074 6865  set based on the
+00018ad0: 2073 656c 6563 7465 6420 696e 7465 7270   selected interp
+00018ae0: 6f6c 6174 696f 6e20 7363 6865 6d65 2e0a  olation scheme..
+00018af0: 0a20 2020 2041 7267 730a 2020 2020 2d2d  .    Args.    --
+00018b00: 2d2d 0a20 2020 2070 6f69 6e74 7320 3a20  --.    points : 
+00018b10: 3264 203a 636c 6173 733a 6041 7272 6179  2d :class:`Array
+00018b20: 600a 2020 2020 2020 2020 5072 6573 656e  `.        Presen
+00018b30: 7420 706f 696e 7420 636f 6f72 6469 6e61  t point coordina
+00018b40: 7465 732e 0a20 2020 2074 6172 6765 7420  tes..    target 
+00018b50: 3a20 3264 203a 636c 6173 733a 6041 7272  : 2d :class:`Arr
+00018b60: 6179 600a 2020 2020 2020 2020 456c 656d  ay`.        Elem
+00018b70: 656e 7477 6973 6520 636f 6e73 7461 6e74  entwise constant
+00018b80: 2074 6861 7420 6576 616c 7561 7465 7320   that evaluates 
+00018b90: 746f 2074 6865 2074 6172 6765 7420 706f  to the target po
+00018ba0: 696e 7420 636f 6f72 6469 6e61 7465 732e  int coordinates.
+00018bb0: 0a20 2020 2069 6e74 6572 706f 6c61 7469  .    interpolati
+00018bc0: 6f6e 203a 203a 636c 6173 733a 6073 7472  on : :class:`str
+00018bd0: 600a 2020 2020 2020 2020 496e 7465 7270  `.        Interp
+00018be0: 6f6c 6174 696f 6e20 7363 6865 6d65 2074  olation scheme t
+00018bf0: 6f20 6d61 7020 706f 696e 7473 2074 6f20  o map points to 
+00018c00: 7461 7267 6574 3a20 226e 6f6e 6522 206f  target: "none" o
+00018c10: 7220 226e 6561 7265 7374 222e 0a20 2020  r "nearest"..   
+00018c20: 2027 2727 0a0a 2020 2020 6465 6620 5f5f   '''..    def __
+00018c30: 696e 6974 5f5f 2873 656c 662c 2070 6f69  init__(self, poi
+00018c40: 6e74 733a 2041 7272 6179 2c20 7461 7267  nts: Array, targ
+00018c50: 6574 3a20 4172 7261 792c 2069 6e74 6572  et: Array, inter
+00018c60: 706f 6c61 7469 6f6e 3a20 7374 7229 3a0a  polation: str):.
+00018c70: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
+00018c80: 7369 6e73 7461 6e63 6528 706f 696e 7473  sinstance(points
+00018c90: 2c20 4172 7261 7929 2061 6e64 2070 6f69  , Array) and poi
+00018ca0: 6e74 732e 6e64 696d 203d 3d20 322c 2066  nts.ndim == 2, f
+00018cb0: 2770 6f69 6e74 733d 7b70 6f69 6e74 7321  'points={points!
+00018cc0: 727d 270a 2020 2020 2020 2020 6173 7365  r}'.        asse
+00018cd0: 7274 2069 7369 6e73 7461 6e63 6528 7461  rt isinstance(ta
+00018ce0: 7267 6574 2c20 4172 7261 7929 2061 6e64  rget, Array) and
+00018cf0: 2074 6172 6765 742e 6e64 696d 203d 3d20   target.ndim == 
+00018d00: 322c 2066 2774 6172 6765 743d 7b74 6172  2, f'target={tar
+00018d10: 6765 7421 727d 270a 2020 2020 2020 2020  get!r}'.        
+00018d20: 6173 7365 7274 2070 6f69 6e74 732e 7368  assert points.sh
+00018d30: 6170 655b 315d 203d 3d20 7461 7267 6574  ape[1] == target
+00018d40: 2e73 6861 7065 5b31 5d0a 2020 2020 2020  .shape[1].      
+00018d50: 2020 6966 2069 6e74 6572 706f 6c61 7469    if interpolati
+00018d60: 6f6e 203d 3d20 276e 6f6e 6527 3a0a 2020  on == 'none':.  
+00018d70: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+00018d80: 7661 6c66 203d 2073 656c 662e 6576 616c  valf = self.eval
+00018d90: 665f 6e6f 6e65 0a20 2020 2020 2020 2065  f_none.        e
+00018da0: 6c69 6620 696e 7465 7270 6f6c 6174 696f  lif interpolatio
+00018db0: 6e20 3d3d 2027 6e65 6172 6573 7427 3a0a  n == 'nearest':.
+00018dc0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00018dd0: 2e65 7661 6c66 203d 2073 656c 662e 6576  .evalf = self.ev
+00018de0: 616c 665f 6e65 6172 6573 740a 2020 2020  alf_nearest.    
+00018df0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00018e00: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00018e10: 6545 7272 6f72 2866 2769 6e76 616c 6964  eError(f'invalid
+00018e20: 2069 6e74 6572 706f 6c61 7469 6f6e 207b   interpolation {
+00018e30: 696e 7465 7270 6f6c 6174 696f 6e21 727d  interpolation!r}
+00018e40: 3b20 7661 6c69 6420 7661 6c75 6573 2061  ; valid values a
+00018e50: 7265 2022 6e6f 6e65 2220 616e 6420 226e  re "none" and "n
+00018e60: 6561 7265 7374 2227 290a 2020 2020 2020  earest"').      
+00018e70: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00018e80: 5f5f 2861 7267 733d 2870 6f69 6e74 732c  __(args=(points,
+00018e90: 2074 6172 6765 7429 2c20 7368 6170 653d   target), shape=
+00018ea0: 2870 6f69 6e74 732e 7368 6170 655b 305d  (points.shape[0]
+00018eb0: 2c20 7461 7267 6574 2e73 6861 7065 5b30  , target.shape[0
+00018ec0: 5d29 2c20 6474 7970 653d 666c 6f61 7429  ]), dtype=float)
+00018ed0: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
+00018ee0: 686f 640a 2020 2020 6465 6620 6576 616c  hod.    def eval
+00018ef0: 665f 6e6f 6e65 2870 6f69 6e74 732c 2074  f_none(points, t
+00018f00: 6172 6765 7429 3a0a 2020 2020 2020 2020  arget):.        
+00018f10: 6966 2070 6f69 6e74 732e 7368 6170 6520  if points.shape 
+00018f20: 213d 2074 6172 6765 742e 7368 6170 6520  != target.shape 
+00018f30: 6f72 206e 6f74 206e 756d 7079 2e65 7175  or not numpy.equ
+00018f40: 616c 2870 6f69 6e74 732c 2074 6172 6765  al(points, targe
+00018f50: 7429 2e61 6c6c 2829 3a0a 2020 2020 2020  t).all():.      
+00018f60: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00018f70: 6545 7272 6f72 2827 706f 696e 7473 2064  eError('points d
+00018f80: 6f20 6e6f 7420 636f 7272 6573 706f 6e64  o not correspond
+00018f90: 2074 6f20 7468 6520 7461 7267 6574 2073   to the target s
+00018fa0: 616d 706c 653b 2063 6f6e 7369 6465 7220  ample; consider 
+00018fb0: 7573 696e 6720 226e 6561 7265 7374 2220  using "nearest" 
+00018fc0: 696e 7465 7270 6f6c 6174 696f 6e20 6966  interpolation if
+00018fd0: 2074 6869 7320 6973 2064 6573 6972 6564   this is desired
+00018fe0: 2729 0a20 2020 2020 2020 2072 6574 7572  ').        retur
+00018ff0: 6e20 6e75 6d70 792e 6579 6528 6c65 6e28  n numpy.eye(len(
+00019000: 706f 696e 7473 2929 0a0a 2020 2020 4073  points))..    @s
+00019010: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
+00019020: 6465 6620 6576 616c 665f 6e65 6172 6573  def evalf_neares
+00019030: 7428 706f 696e 7473 2c20 7461 7267 6574  t(points, target
+00019040: 293a 0a20 2020 2020 2020 206e 6561 7265  ):.        neare
+00019050: 7374 203d 206e 756d 7079 2e6c 696e 616c  st = numpy.linal
+00019060: 672e 6e6f 726d 2870 6f69 6e74 735b 3a2c  g.norm(points[:,
+00019070: 6e75 6d70 792e 6e65 7761 7869 732c 3a5d  numpy.newaxis,:]
+00019080: 202d 2074 6172 6765 745b 6e75 6d70 792e   - target[numpy.
+00019090: 6e65 7761 7869 732c 3a2c 3a5d 2c20 6178  newaxis,:,:], ax
+000190a0: 6973 3d32 292e 6172 676d 696e 2861 7869  is=2).argmin(axi
+000190b0: 733d 3129 0a20 2020 2020 2020 2072 6574  s=1).        ret
+000190c0: 7572 6e20 6e75 6d70 792e 6579 6528 6c65  urn numpy.eye(le
+000190d0: 6e28 7461 7267 6574 2929 5b6e 6561 7265  n(target))[neare
+000190e0: 7374 5d0a 0a0a 6465 6620 456c 656d 7769  st]...def Elemwi
+000190f0: 7365 2864 6174 613a 2074 7970 696e 672e  se(data: typing.
+00019100: 5475 706c 655b 7479 7065 732e 6172 7261  Tuple[types.arra
+00019110: 7964 6174 612c 202e 2e2e 5d2c 2069 6e64  ydata, ...], ind
+00019120: 6578 3a20 4172 7261 792c 2064 7479 7065  ex: Array, dtype
+00019130: 3a20 4474 7970 6529 3a0a 2020 2020 6173  : Dtype):.    as
+00019140: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00019150: 6461 7461 2c20 7475 706c 6529 2061 6e64  data, tuple) and
+00019160: 2061 6c6c 2869 7369 6e73 7461 6e63 6528   all(isinstance(
+00019170: 642c 2074 7970 6573 2e61 7272 6179 6461  d, types.arrayda
+00019180: 7461 2920 616e 6420 642e 6474 7970 6520  ta) and d.dtype 
+00019190: 3d3d 2064 7479 7065 2066 6f72 2064 2069  == dtype for d i
+000191a0: 6e20 6461 7461 292c 2066 2764 6174 613d  n data), f'data=
+000191b0: 7b64 6174 6121 727d 270a 2020 2020 6173  {data!r}'.    as
+000191c0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+000191d0: 696e 6465 782c 2041 7272 6179 2920 616e  index, Array) an
+000191e0: 6420 696e 6465 782e 6e64 696d 203d 3d20  d index.ndim == 
+000191f0: 3020 616e 6420 696e 6465 782e 6474 7970  0 and index.dtyp
+00019200: 6520 3d3d 2069 6e74 2c20 6627 696e 6465  e == int, f'inde
+00019210: 783d 7b69 6e64 6578 2172 7d27 0a20 2020  x={index!r}'.   
+00019220: 2075 6e69 7175 652c 2069 6e64 6963 6573   unique, indices
+00019230: 203d 2075 7469 6c2e 756e 6971 7565 2864   = util.unique(d
+00019240: 6174 6129 0a20 2020 2069 6620 6c65 6e28  ata).    if len(
+00019250: 756e 6971 7565 2920 3d3d 2031 3a0a 2020  unique) == 1:.  
+00019260: 2020 2020 2020 7265 7475 726e 2043 6f6e        return Con
+00019270: 7374 616e 7428 756e 6971 7565 5b30 5d29  stant(unique[0])
+00019280: 0a20 2020 2023 2043 7265 6174 6520 7368  .    # Create sh
+00019290: 6170 6520 6672 6f6d 2064 6174 6120 616e  ape from data an
+000192a0: 6420 696e 6465 782c 2072 6174 6865 7220  d index, rather 
+000192b0: 7468 616e 2075 6e69 7175 6520 616e 6420  than unique and 
+000192c0: 7468 6520 6d6f 6469 6669 6564 0a20 2020  the modified.   
+000192d0: 2023 2069 6e64 6578 2c20 696e 206f 7264   # index, in ord
+000192e0: 6572 2074 6f20 6176 6f69 6420 706f 7465  er to avoid pote
+000192f0: 6e74 6961 6c20 7368 6170 6520 696e 636f  ntial shape inco
+00019300: 6e73 6973 7465 6e63 6965 7320 6c61 7465  nsistencies late
+00019310: 7220 6f6e 2e0a 2020 2020 7368 6170 6573  r on..    shapes
+00019320: 203d 206e 756d 7079 2e61 7272 6179 285b   = numpy.array([
+00019330: 642e 7368 6170 6520 666f 7220 6420 696e  d.shape for d in
+00019340: 2064 6174 615d 290a 2020 2020 7368 6170   data]).    shap
+00019350: 6520 3d20 5b54 616b 6528 636f 6e73 7461  e = [Take(consta
+00019360: 6e74 2873 292c 2069 6e64 6578 2920 666f  nt(s), index) fo
+00019370: 7220 7320 696e 2073 6861 7065 732e 545d  r s in shapes.T]
+00019380: 0a20 2020 2069 6620 6c65 6e28 756e 6971  .    if len(uniq
+00019390: 7565 2920 3c20 6c65 6e28 6461 7461 293a  ue) < len(data):
+000193a0: 0a20 2020 2020 2020 2069 6e64 6578 203d  .        index =
+000193b0: 2054 616b 6528 636f 6e73 7461 6e74 2869   Take(constant(i
+000193c0: 6e64 6963 6573 292c 2069 6e64 6578 290a  ndices), index).
+000193d0: 2020 2020 2320 4d6f 7665 2061 6c6c 2061      # Move all a
+000193e0: 7865 7320 7769 7468 2063 6f6e 7374 616e  xes with constan
+000193f0: 7420 7368 6170 6520 746f 2074 6865 206c  t shape to the l
+00019400: 6566 7420 616e 6420 7261 7665 6c20 7468  eft and ravel th
+00019410: 6520 7265 6d61 696e 6465 722e 0a20 2020  e remainder..   
+00019420: 2069 735f 636f 6e73 7461 6e74 203d 206e   is_constant = n
+00019430: 756d 7079 2e61 6c6c 2873 6861 7065 735b  umpy.all(shapes[
+00019440: 313a 5d20 3d3d 2073 6861 7065 735b 305d  1:] == shapes[0]
+00019450: 2c20 6178 6973 3d30 290a 2020 2020 6e63  , axis=0).    nc
+00019460: 6f6e 7374 616e 7420 3d20 6973 5f63 6f6e  onstant = is_con
+00019470: 7374 616e 742e 7375 6d28 290a 2020 2020  stant.sum().    
+00019480: 7265 6f72 6465 7220 3d20 6e75 6d70 792e  reorder = numpy.
+00019490: 6172 6773 6f72 7428 7e69 735f 636f 6e73  argsort(~is_cons
+000194a0: 7461 6e74 290a 2020 2020 7261 7665 6c65  tant).    ravele
+000194b0: 6420 3d20 5b6e 756d 7079 2e74 7261 6e73  d = [numpy.trans
+000194c0: 706f 7365 2864 2c20 7265 6f72 6465 7229  pose(d, reorder)
+000194d0: 2e72 6573 6861 7065 282a 7368 6170 6573  .reshape(*shapes
+000194e0: 5b30 2c20 7265 6f72 6465 725b 3a6e 636f  [0, reorder[:nco
+000194f0: 6e73 7461 6e74 5d5d 2c20 2d31 2920 666f  nstant]], -1) fo
+00019500: 7220 6420 696e 2075 6e69 7175 655d 0a20  r d in unique]. 
+00019510: 2020 2023 2043 6f6e 6361 7465 6e61 7465     # Concatenate
+00019520: 2074 6865 2072 6176 656c 6564 2061 7869   the raveled axi
+00019530: 732c 2074 616b 6520 736c 6963 6573 2c20  s, take slices, 
+00019540: 756e 7261 7665 6c20 616e 6420 7265 6f72  unravel and reor
+00019550: 6465 7220 7468 6520 6178 6573 2074 6f0a  der the axes to.
+00019560: 2020 2020 2320 7468 6520 6f72 6967 696e      # the origin
+00019570: 616c 2070 6f73 6974 696f 6e2e 0a20 2020  al position..   
+00019580: 2063 6f6e 6361 7420 3d20 636f 6e73 7461   concat = consta
+00019590: 6e74 286e 756d 7079 2e63 6f6e 6361 7465  nt(numpy.concate
+000195a0: 6e61 7465 2872 6176 656c 6564 2c20 6178  nate(raveled, ax
+000195b0: 6973 3d2d 3129 290a 2020 2020 6966 2069  is=-1)).    if i
+000195c0: 735f 636f 6e73 7461 6e74 2e61 6c6c 2829  s_constant.all()
+000195d0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000195e0: 2054 616b 6528 636f 6e63 6174 2c20 696e   Take(concat, in
+000195f0: 6465 7829 0a20 2020 2076 6172 5f73 6861  dex).    var_sha
+00019600: 7065 203d 2074 7570 6c65 2873 6861 7065  pe = tuple(shape
+00019610: 5b69 5d20 666f 7220 6920 696e 2072 656f  [i] for i in reo
+00019620: 7264 6572 5b6e 636f 6e73 7461 6e74 3a5d  rder[nconstant:]
+00019630: 290a 2020 2020 6375 6d70 726f 6420 3d20  ).    cumprod = 
+00019640: 6c69 7374 2876 6172 5f73 6861 7065 290a  list(var_shape).
+00019650: 2020 2020 666f 7220 6920 696e 2072 6576      for i in rev
+00019660: 6572 7365 6428 7261 6e67 6528 6c65 6e28  ersed(range(len(
+00019670: 7661 725f 7368 6170 6529 2d31 2929 3a0a  var_shape)-1)):.
+00019680: 2020 2020 2020 2020 6375 6d70 726f 645b          cumprod[
+00019690: 695d 202a 3d20 6375 6d70 726f 645b 692b  i] *= cumprod[i+
+000196a0: 315d 2020 2320 776f 726b 2062 6163 6b77  1]  # work backw
+000196b0: 6172 6473 2073 6f20 7468 6174 2074 6865  ards so that the
+000196c0: 2073 6861 7065 2063 6865 636b 206d 6174   shape check mat
+000196d0: 6368 6573 2069 6e20 556e 7261 7665 6c0a  ches in Unravel.
+000196e0: 2020 2020 6f66 6673 6574 7320 3d20 5f53      offsets = _S
+000196f0: 697a 6573 546f 4f66 6673 6574 7328 6173  izesToOffsets(as
+00019700: 6172 7261 7928 5b64 2e73 6861 7065 5b2d  array([d.shape[-
+00019710: 315d 2066 6f72 2064 2069 6e20 7261 7665  1] for d in rave
+00019720: 6c65 645d 2929 0a20 2020 2065 6c65 6d77  led])).    elemw
+00019730: 6973 6520 3d20 5461 6b65 2863 6f6e 6361  ise = Take(conca
+00019740: 742c 2052 616e 6765 2863 756d 7072 6f64  t, Range(cumprod
+00019750: 5b30 5d29 202b 2054 616b 6528 6f66 6673  [0]) + Take(offs
+00019760: 6574 732c 2069 6e64 6578 2929 0a20 2020  ets, index)).   
+00019770: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00019780: 6c65 6e28 7661 725f 7368 6170 6529 2d31  len(var_shape)-1
+00019790: 293a 0a20 2020 2020 2020 2065 6c65 6d77  ):.        elemw
+000197a0: 6973 6520 3d20 556e 7261 7665 6c28 656c  ise = Unravel(el
+000197b0: 656d 7769 7365 2c20 7661 725f 7368 6170  emwise, var_shap
+000197c0: 655b 695d 2c20 6375 6d70 726f 645b 692b  e[i], cumprod[i+
+000197d0: 315d 290a 2020 2020 7265 7475 726e 2054  1]).    return T
+000197e0: 7261 6e73 706f 7365 2e69 6e76 2865 6c65  ranspose.inv(ele
+000197f0: 6d77 6973 652c 2072 656f 7264 6572 290a  mwise, reorder).
+00019800: 0a0a 636c 6173 7320 4569 6728 4576 616c  ..class Eig(Eval
+00019810: 7561 626c 6529 3a0a 0a20 2020 2064 6566  uable):..    def
+00019820: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00019830: 6675 6e63 3a20 4172 7261 792c 2073 796d  func: Array, sym
+00019840: 6d65 7472 6963 3a20 626f 6f6c 203d 2046  metric: bool = F
+00019850: 616c 7365 293a 0a20 2020 2020 2020 2061  alse):.        a
+00019860: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00019870: 2866 756e 632c 2041 7272 6179 2920 616e  (func, Array) an
+00019880: 6420 6675 6e63 2e6e 6469 6d20 3e3d 2032  d func.ndim >= 2
+00019890: 2061 6e64 205f 6571 7561 6c73 5f73 696d   and _equals_sim
+000198a0: 706c 6966 6965 6428 6675 6e63 2e73 6861  plified(func.sha
+000198b0: 7065 5b2d 315d 2c20 6675 6e63 2e73 6861  pe[-1], func.sha
+000198c0: 7065 5b2d 325d 292c 2066 2766 756e 633d  pe[-2]), f'func=
+000198d0: 7b66 756e 6321 727d 270a 2020 2020 2020  {func!r}'.      
+000198e0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+000198f0: 6e63 6528 7379 6d6d 6574 7269 632c 2062  nce(symmetric, b
+00019900: 6f6f 6c29 2c20 6627 7379 6d6d 6574 7269  ool), f'symmetri
+00019910: 633d 7b73 796d 6d65 7472 6963 2172 7d27  c={symmetric!r}'
+00019920: 0a20 2020 2020 2020 2073 656c 662e 7379  .        self.sy
+00019930: 6d6d 6574 7269 6320 3d20 7379 6d6d 6574  mmetric = symmet
+00019940: 7269 630a 2020 2020 2020 2020 7365 6c66  ric.        self
+00019950: 2e66 756e 6320 3d20 6675 6e63 0a20 2020  .func = func.   
+00019960: 2020 2020 2073 656c 662e 5f77 5f64 7479       self._w_dty
+00019970: 7065 203d 2066 6c6f 6174 2069 6620 7379  pe = float if sy
+00019980: 6d6d 6574 7269 6320 656c 7365 2063 6f6d  mmetric else com
+00019990: 706c 6578 0a20 2020 2020 2020 2073 656c  plex.        sel
+000199a0: 662e 5f76 745f 6474 7970 6520 3d20 666c  f._vt_dtype = fl
+000199b0: 6f61 7420 6966 2073 796d 6d65 7472 6963  oat if symmetric
+000199c0: 2061 6e64 2066 756e 632e 6474 7970 6520   and func.dtype 
+000199d0: 213d 2063 6f6d 706c 6578 2065 6c73 6520  != complex else 
+000199e0: 636f 6d70 6c65 780a 2020 2020 2020 2020  complex.        
+000199f0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+00019a00: 2861 7267 733d 2866 756e 632c 2929 0a0a  (args=(func,))..
+00019a10: 2020 2020 6465 6620 5f5f 6c65 6e5f 5f28      def __len__(
+00019a20: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
+00019a30: 6574 7572 6e20 320a 0a20 2020 2064 6566  eturn 2..    def
+00019a40: 205f 5f67 6574 6974 656d 5f5f 2873 656c   __getitem__(sel
+00019a50: 662c 2069 6e64 6578 293a 0a20 2020 2020  f, index):.     
+00019a60: 2020 2069 6620 696e 6465 7820 3d3d 2030     if index == 0
+00019a70: 3a0a 2020 2020 2020 2020 2020 2020 7368  :.            sh
+00019a80: 6170 6520 3d20 7365 6c66 2e66 756e 632e  ape = self.func.
+00019a90: 7368 6170 655b 3a2d 315d 0a20 2020 2020  shape[:-1].     
+00019aa0: 2020 2020 2020 2064 7479 7065 203d 2073         dtype = s
+00019ab0: 656c 662e 5f77 5f64 7479 7065 0a20 2020  elf._w_dtype.   
+00019ac0: 2020 2020 2065 6c69 6620 696e 6465 7820       elif index 
+00019ad0: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+00019ae0: 2020 7368 6170 653d 7365 6c66 2e66 756e    shape=self.fun
+00019af0: 632e 7368 6170 650a 2020 2020 2020 2020  c.shape.        
+00019b00: 2020 2020 6474 7970 653d 7365 6c66 2e5f      dtype=self._
+00019b10: 7674 5f64 7479 7065 0a20 2020 2020 2020  vt_dtype.       
+00019b20: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00019b30: 2020 2072 6169 7365 2049 6e64 6578 4572     raise IndexEr
+00019b40: 726f 720a 2020 2020 2020 2020 7265 7475  ror.        retu
+00019b50: 726e 2041 7272 6179 4672 6f6d 5475 706c  rn ArrayFromTupl
+00019b60: 6528 7365 6c66 2c20 696e 6465 783d 696e  e(self, index=in
+00019b70: 6465 782c 2073 6861 7065 3d73 6861 7065  dex, shape=shape
+00019b80: 2c20 6474 7970 653d 6474 7970 6529 0a0a  , dtype=dtype)..
+00019b90: 2020 2020 6465 6620 5f73 696d 706c 6966      def _simplif
+00019ba0: 6965 6428 7365 6c66 293a 0a20 2020 2020  ied(self):.     
+00019bb0: 2020 2072 6574 7572 6e20 7365 6c66 2e66     return self.f
+00019bc0: 756e 632e 5f65 6967 2873 656c 662e 7379  unc._eig(self.sy
+00019bd0: 6d6d 6574 7269 6329 0a0a 2020 2020 6465  mmetric)..    de
+00019be0: 6620 6576 616c 6628 7365 6c66 2c20 6172  f evalf(self, ar
+00019bf0: 7229 3a0a 2020 2020 2020 2020 772c 2076  r):.        w, v
+00019c00: 7420 3d20 286e 756d 7079 2e6c 696e 616c  t = (numpy.linal
+00019c10: 672e 6569 6768 2069 6620 7365 6c66 2e73  g.eigh if self.s
+00019c20: 796d 6d65 7472 6963 2065 6c73 6520 6e75  ymmetric else nu
+00019c30: 6d70 792e 6c69 6e61 6c67 2e65 6967 2928  mpy.linalg.eig)(
+00019c40: 6172 7229 0a20 2020 2020 2020 2077 203d  arr).        w =
+00019c50: 2077 2e61 7374 7970 6528 7365 6c66 2e5f   w.astype(self._
+00019c60: 775f 6474 7970 652c 2063 6f70 793d 4661  w_dtype, copy=Fa
+00019c70: 6c73 6529 0a20 2020 2020 2020 2076 7420  lse).        vt 
+00019c80: 3d20 7674 2e61 7374 7970 6528 7365 6c66  = vt.astype(self
+00019c90: 2e5f 7674 5f64 7479 7065 2c20 636f 7079  ._vt_dtype, copy
+00019ca0: 3d46 616c 7365 290a 2020 2020 2020 2020  =False).        
+00019cb0: 7265 7475 726e 2028 772c 2076 7429 0a0a  return (w, vt)..
+00019cc0: 0a63 6c61 7373 2041 7272 6179 4672 6f6d  .class ArrayFrom
+00019cd0: 5475 706c 6528 4172 7261 7929 3a0a 0a20  Tuple(Array):.. 
+00019ce0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00019cf0: 7365 6c66 2c20 6172 7261 7973 3a20 4576  self, arrays: Ev
+00019d00: 616c 7561 626c 652c 2069 6e64 6578 3a20  aluable, index: 
+00019d10: 696e 742c 2073 6861 7065 3a20 7479 7069  int, shape: typi
+00019d20: 6e67 2e54 7570 6c65 5b41 7272 6179 2c20  ng.Tuple[Array, 
+00019d30: 2e2e 2e5d 2c20 6474 7970 653a 2044 7479  ...], dtype: Dty
+00019d40: 7065 2c20 2a2c 205f 6c6f 7765 723d 666c  pe, *, _lower=fl
+00019d50: 6f61 7428 272d 696e 6627 292c 205f 7570  oat('-inf'), _up
+00019d60: 7065 723d 666c 6f61 7428 2769 6e66 2729  per=float('inf')
+00019d70: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
+00019d80: 7420 6973 696e 7374 616e 6365 2861 7272  t isinstance(arr
+00019d90: 6179 732c 2045 7661 6c75 6162 6c65 292c  ays, Evaluable),
+00019da0: 2066 2761 7272 6179 733d 7b61 7272 6179   f'arrays={array
+00019db0: 7321 727d 270a 2020 2020 2020 2020 6173  s!r}'.        as
+00019dc0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00019dd0: 696e 6465 782c 2069 6e74 292c 2066 2769  index, int), f'i
+00019de0: 6e64 6578 3d66 7b69 6e64 6578 7d27 0a20  ndex=f{index}'. 
+00019df0: 2020 2020 2020 2073 656c 662e 6172 7261         self.arra
+00019e00: 7973 203d 2061 7272 6179 730a 2020 2020  ys = arrays.    
+00019e10: 2020 2020 7365 6c66 2e69 6e64 6578 203d      self.index =
+00019e20: 2069 6e64 6578 0a20 2020 2020 2020 2073   index.        s
+00019e30: 656c 662e 5f6c 6f77 6572 203d 205f 6c6f  elf._lower = _lo
+00019e40: 7765 720a 2020 2020 2020 2020 7365 6c66  wer.        self
+00019e50: 2e5f 7570 7065 7220 3d20 5f75 7070 6572  ._upper = _upper
+00019e60: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+00019e70: 2e5f 5f69 6e69 745f 5f28 6172 6773 3d28  .__init__(args=(
+00019e80: 6172 7261 7973 2c29 2c20 7368 6170 653d  arrays,), shape=
+00019e90: 7368 6170 652c 2064 7479 7065 3d64 7479  shape, dtype=dty
+00019ea0: 7065 290a 0a20 2020 2064 6566 205f 7369  pe)..    def _si
+00019eb0: 6d70 6c69 6669 6564 2873 656c 6629 3a0a  mplified(self):.
+00019ec0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00019ed0: 7461 6e63 6528 7365 6c66 2e61 7272 6179  tance(self.array
+00019ee0: 732c 2054 7570 6c65 293a 0a20 2020 2020  s, Tuple):.     
+00019ef0: 2020 2020 2020 2023 2054 6869 7320 616c         # This al
+00019f00: 6c6f 7773 2074 6865 2073 656c 662e 6172  lows the self.ar
+00019f10: 7261 7973 2065 7661 6c75 6162 6c65 2074  rays evaluable t
+00019f20: 6f20 7369 6d70 6c69 6679 2069 7473 656c  o simplify itsel
+00019f30: 6620 696e 746f 2061 0a20 2020 2020 2020  f into a.       
+00019f40: 2020 2020 2023 2054 7570 6c65 2061 6e64       # Tuple and
+00019f50: 2069 7473 2063 6f6d 706f 6e65 6e74 7320   its components 
+00019f60: 6265 2065 7870 6f73 6564 2074 6f20 7468  be exposed to th
+00019f70: 6520 6675 6e63 7469 6f6e 2074 7265 652e  e function tree.
+00019f80: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00019f90: 7572 6e20 7365 6c66 2e61 7272 6179 735b  urn self.arrays[
+00019fa0: 7365 6c66 2e69 6e64 6578 5d0a 0a20 2020  self.index]..   
+00019fb0: 2064 6566 2065 7661 6c66 2873 656c 662c   def evalf(self,
+00019fc0: 2061 7272 6179 7329 3a0a 2020 2020 2020   arrays):.      
+00019fd0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00019fe0: 6e63 6528 6172 7261 7973 2c20 7475 706c  nce(arrays, tupl
+00019ff0: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
+0001a000: 6e20 6172 7261 7973 5b73 656c 662e 696e  n arrays[self.in
+0001a010: 6465 785d 0a0a 2020 2020 6465 6620 5f6e  dex]..    def _n
+0001a020: 6f64 6528 7365 6c66 2c20 6361 6368 652c  ode(self, cache,
+0001a030: 2073 7562 6772 6170 682c 2074 696d 6573   subgraph, times
+0001a040: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
+0001a050: 6c66 2069 6e20 6361 6368 653a 0a20 2020  lf in cache:.   
+0001a060: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001a070: 6361 6368 655b 7365 6c66 5d0a 2020 2020  cache[self].    
+0001a080: 2020 2020 656c 6966 2068 6173 6174 7472      elif hasattr
+0001a090: 2873 656c 662e 6172 7261 7973 2c20 275f  (self.arrays, '_
+0001a0a0: 6e6f 6465 5f74 7570 6c65 2729 3a0a 2020  node_tuple'):.  
+0001a0b0: 2020 2020 2020 2020 2020 6361 6368 655b            cache[
+0001a0c0: 7365 6c66 5d20 3d20 6e6f 6465 203d 2073  self] = node = s
+0001a0d0: 656c 662e 6172 7261 7973 2e5f 6e6f 6465  elf.arrays._node
+0001a0e0: 5f74 7570 6c65 2863 6163 6865 2c20 7375  _tuple(cache, su
+0001a0f0: 6267 7261 7068 2c20 7469 6d65 7329 5b73  bgraph, times)[s
+0001a100: 656c 662e 696e 6465 785d 0a20 2020 2020  elf.index].     
+0001a110: 2020 2020 2020 2072 6574 7572 6e20 6e6f         return no
+0001a120: 6465 0a20 2020 2020 2020 2065 6c73 653a  de.        else:
+0001a130: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001a140: 7572 6e20 7375 7065 7228 292e 5f6e 6f64  urn super()._nod
+0001a150: 6528 6361 6368 652c 2073 7562 6772 6170  e(cache, subgrap
+0001a160: 682c 2074 696d 6573 290a 0a20 2020 2064  h, times)..    d
+0001a170: 6566 205f 696e 7462 6f75 6e64 735f 696d  ef _intbounds_im
+0001a180: 706c 2873 656c 6629 3a0a 2020 2020 2020  pl(self):.      
+0001a190: 2020 7265 7475 726e 2073 656c 662e 5f6c    return self._l
+0001a1a0: 6f77 6572 2c20 7365 6c66 2e5f 7570 7065  ower, self._uppe
+0001a1b0: 720a 0a0a 636c 6173 7320 5a65 726f 7328  r...class Zeros(
+0001a1c0: 4172 7261 7929 3a0a 2020 2020 277a 6572  Array):.    'zer
+0001a1d0: 6f27 0a0a 2020 2020 6465 6620 5f5f 696e  o'..    def __in
+0001a1e0: 6974 5f5f 2873 656c 662c 2073 6861 7065  it__(self, shape
+0001a1f0: 2c20 6474 7970 6529 3a0a 2020 2020 2020  , dtype):.      
+0001a200: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+0001a210: 5f5f 2861 7267 733d 7368 6170 652c 2073  __(args=shape, s
+0001a220: 6861 7065 3d73 6861 7065 2c20 6474 7970  hape=shape, dtyp
+0001a230: 653d 6474 7970 6529 0a0a 2020 2020 4063  e=dtype)..    @c
+0001a240: 6163 6865 645f 7072 6f70 6572 7479 0a20  ached_property. 
+0001a250: 2020 2064 6566 205f 756e 616c 6967 6e65     def _unaligne
+0001a260: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
+0001a270: 2072 6574 7572 6e20 5a65 726f 7328 2829   return Zeros(()
+0001a280: 2c20 7365 6c66 2e64 7479 7065 292c 2028  , self.dtype), (
+0001a290: 290a 0a20 2020 2064 6566 2065 7661 6c66  )..    def evalf
+0001a2a0: 2873 656c 662c 202a 7368 6170 6529 3a0a  (self, *shape):.
+0001a2b0: 2020 2020 2020 2020 7265 7475 726e 206e          return n
+0001a2c0: 756d 7079 2e7a 6572 6f73 2873 6861 7065  umpy.zeros(shape
+0001a2d0: 2c20 6474 7970 653d 7365 6c66 2e64 7479  , dtype=self.dty
+0001a2e0: 7065 290a 0a20 2020 2064 6566 205f 6e6f  pe)..    def _no
+0001a2f0: 6465 2873 656c 662c 2063 6163 6865 2c20  de(self, cache, 
+0001a300: 7375 6267 7261 7068 2c20 7469 6d65 7329  subgraph, times)
+0001a310: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
+0001a320: 662e 6e64 696d 3a0a 2020 2020 2020 2020  f.ndim:.        
+0001a330: 2020 2020 7265 7475 726e 2073 7570 6572      return super
+0001a340: 2829 2e5f 6e6f 6465 2863 6163 6865 2c20  ()._node(cache, 
+0001a350: 7375 6267 7261 7068 2c20 7469 6d65 7329  subgraph, times)
+0001a360: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
+0001a370: 6c66 2069 6e20 6361 6368 653a 0a20 2020  lf in cache:.   
+0001a380: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001a390: 6361 6368 655b 7365 6c66 5d0a 2020 2020  cache[self].    
+0001a3a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001a3b0: 2020 2020 2020 6361 6368 655b 7365 6c66        cache[self
+0001a3c0: 5d20 3d20 6e6f 6465 203d 2044 7570 6c69  ] = node = Dupli
+0001a3d0: 6361 7465 644c 6561 664e 6f64 6528 2730  catedLeafNode('0
+0001a3e0: 272c 2028 7479 7065 2873 656c 6629 2e5f  ', (type(self)._
+0001a3f0: 5f6e 616d 655f 5f2c 2074 696d 6573 5b73  _name__, times[s
+0001a400: 656c 665d 2929 0a20 2020 2020 2020 2020  elf])).         
+0001a410: 2020 2072 6574 7572 6e20 6e6f 6465 0a0a     return node..
+0001a420: 2020 2020 6465 6620 5f61 6464 2873 656c      def _add(sel
+0001a430: 662c 206f 7468 6572 293a 0a20 2020 2020  f, other):.     
+0001a440: 2020 2072 6574 7572 6e20 6f74 6865 720a     return other.
+0001a450: 0a20 2020 2064 6566 205f 6d75 6c74 6970  .    def _multip
+0001a460: 6c79 2873 656c 662c 206f 7468 6572 293a  ly(self, other):
+0001a470: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001a480: 7365 6c66 0a0a 2020 2020 6465 6620 5f64  self..    def _d
+0001a490: 6961 676f 6e61 6c69 7a65 2873 656c 662c  iagonalize(self,
+0001a4a0: 2061 7869 7329 3a0a 2020 2020 2020 2020   axis):.        
+0001a4b0: 7265 7475 726e 205a 6572 6f73 2873 656c  return Zeros(sel
+0001a4c0: 662e 7368 6170 652b 2873 656c 662e 7368  f.shape+(self.sh
+0001a4d0: 6170 655b 6178 6973 5d2c 292c 2064 7479  ape[axis],), dty
+0001a4e0: 7065 3d73 656c 662e 6474 7970 6529 0a0a  pe=self.dtype)..
+0001a4f0: 2020 2020 6465 6620 5f73 756d 2873 656c      def _sum(sel
+0001a500: 662c 2061 7869 7329 3a0a 2020 2020 2020  f, axis):.      
+0001a510: 2020 7265 7475 726e 205a 6572 6f73 2873    return Zeros(s
+0001a520: 656c 662e 7368 6170 655b 3a61 7869 735d  elf.shape[:axis]
+0001a530: 202b 2073 656c 662e 7368 6170 655b 6178   + self.shape[ax
+0001a540: 6973 2b31 3a5d 2c20 6474 7970 653d 696e  is+1:], dtype=in
+0001a550: 7420 6966 2073 656c 662e 6474 7970 6520  t if self.dtype 
+0001a560: 3d3d 2062 6f6f 6c20 656c 7365 2073 656c  == bool else sel
+0001a570: 662e 6474 7970 6529 0a0a 2020 2020 6465  f.dtype)..    de
+0001a580: 6620 5f74 7261 6e73 706f 7365 2873 656c  f _transpose(sel
+0001a590: 662c 2061 7865 7329 3a0a 2020 2020 2020  f, axes):.      
+0001a5a0: 2020 7368 6170 6520 3d20 7475 706c 6528    shape = tuple(
+0001a5b0: 7365 6c66 2e73 6861 7065 5b6e 5d20 666f  self.shape[n] fo
+0001a5c0: 7220 6e20 696e 2061 7865 7329 0a20 2020  r n in axes).   
+0001a5d0: 2020 2020 2072 6574 7572 6e20 5a65 726f       return Zero
+0001a5e0: 7328 7368 6170 652c 2064 7479 7065 3d73  s(shape, dtype=s
+0001a5f0: 656c 662e 6474 7970 6529 0a0a 2020 2020  elf.dtype)..    
+0001a600: 6465 6620 5f69 6e73 6572 7461 7869 7328  def _insertaxis(
+0001a610: 7365 6c66 2c20 6178 6973 2c20 6c65 6e67  self, axis, leng
+0001a620: 7468 293a 0a20 2020 2020 2020 2072 6574  th):.        ret
+0001a630: 7572 6e20 5a65 726f 7328 7365 6c66 2e73  urn Zeros(self.s
+0001a640: 6861 7065 5b3a 6178 6973 5d2b 286c 656e  hape[:axis]+(len
+0001a650: 6774 682c 292b 7365 6c66 2e73 6861 7065  gth,)+self.shape
+0001a660: 5b61 7869 733a 5d2c 2073 656c 662e 6474  [axis:], self.dt
+0001a670: 7970 6529 0a0a 2020 2020 6465 6620 5f74  ype)..    def _t
+0001a680: 616b 6564 6961 6728 7365 6c66 2c20 6178  akediag(self, ax
+0001a690: 6973 312c 2061 7869 7332 293a 0a20 2020  is1, axis2):.   
+0001a6a0: 2020 2020 2072 6574 7572 6e20 5a65 726f       return Zero
+0001a6b0: 7328 7365 6c66 2e73 6861 7065 5b3a 6178  s(self.shape[:ax
+0001a6c0: 6973 315d 2b73 656c 662e 7368 6170 655b  is1]+self.shape[
+0001a6d0: 6178 6973 312b 313a 6178 6973 325d 2b73  axis1+1:axis2]+s
+0001a6e0: 656c 662e 7368 6170 655b 6178 6973 322b  elf.shape[axis2+
+0001a6f0: 313a 7365 6c66 2e6e 6469 6d5d 2b28 7365  1:self.ndim]+(se
+0001a700: 6c66 2e73 6861 7065 5b61 7869 7331 5d2c  lf.shape[axis1],
+0001a710: 292c 2064 7479 7065 3d73 656c 662e 6474  ), dtype=self.dt
+0001a720: 7970 6529 0a0a 2020 2020 6465 6620 5f74  ype)..    def _t
+0001a730: 616b 6528 7365 6c66 2c20 696e 6465 782c  ake(self, index,
+0001a740: 2061 7869 7329 3a0a 2020 2020 2020 2020   axis):.        
+0001a750: 7265 7475 726e 205a 6572 6f73 2873 656c  return Zeros(sel
+0001a760: 662e 7368 6170 655b 3a61 7869 735d 202b  f.shape[:axis] +
+0001a770: 2069 6e64 6578 2e73 6861 7065 202b 2073   index.shape + s
+0001a780: 656c 662e 7368 6170 655b 6178 6973 2b31  elf.shape[axis+1
+0001a790: 3a5d 2c20 6474 7970 653d 7365 6c66 2e64  :], dtype=self.d
+0001a7a0: 7479 7065 290a 0a20 2020 2064 6566 205f  type)..    def _
+0001a7b0: 696e 666c 6174 6528 7365 6c66 2c20 646f  inflate(self, do
+0001a7c0: 666d 6170 2c20 6c65 6e67 7468 2c20 6178  fmap, length, ax
+0001a7d0: 6973 293a 0a20 2020 2020 2020 2072 6574  is):.        ret
+0001a7e0: 7572 6e20 5a65 726f 7328 7365 6c66 2e73  urn Zeros(self.s
+0001a7f0: 6861 7065 5b3a 6178 6973 5d20 2b20 286c  hape[:axis] + (l
+0001a800: 656e 6774 682c 2920 2b20 7365 6c66 2e73  ength,) + self.s
+0001a810: 6861 7065 5b61 7869 732b 646f 666d 6170  hape[axis+dofmap
+0001a820: 2e6e 6469 6d3a 5d2c 2064 7479 7065 3d73  .ndim:], dtype=s
+0001a830: 656c 662e 6474 7970 6529 0a0a 2020 2020  elf.dtype)..    
+0001a840: 6465 6620 5f75 6e72 6176 656c 2873 656c  def _unravel(sel
+0001a850: 662c 2061 7869 732c 2073 6861 7065 293a  f, axis, shape):
+0001a860: 0a20 2020 2020 2020 2073 6861 7065 203d  .        shape =
+0001a870: 2073 656c 662e 7368 6170 655b 3a61 7869   self.shape[:axi
+0001a880: 735d 202b 2073 6861 7065 202b 2073 656c  s] + shape + sel
+0001a890: 662e 7368 6170 655b 6178 6973 2b31 3a5d  f.shape[axis+1:]
+0001a8a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001a8b0: 5a65 726f 7328 7368 6170 652c 2064 7479  Zeros(shape, dty
+0001a8c0: 7065 3d73 656c 662e 6474 7970 6529 0a0a  pe=self.dtype)..
+0001a8d0: 2020 2020 6465 6620 5f72 6176 656c 2873      def _ravel(s
+0001a8e0: 656c 662c 2061 7869 7329 3a0a 2020 2020  elf, axis):.    
+0001a8f0: 2020 2020 7265 7475 726e 205a 6572 6f73      return Zeros
+0001a900: 2873 656c 662e 7368 6170 655b 3a61 7869  (self.shape[:axi
+0001a910: 735d 202b 2028 7365 6c66 2e73 6861 7065  s] + (self.shape
+0001a920: 5b61 7869 735d 2a73 656c 662e 7368 6170  [axis]*self.shap
+0001a930: 655b 6178 6973 2b31 5d2c 2920 2b20 7365  e[axis+1],) + se
+0001a940: 6c66 2e73 6861 7065 5b61 7869 732b 323a  lf.shape[axis+2:
+0001a950: 5d2c 2073 656c 662e 6474 7970 6529 0a0a  ], self.dtype)..
+0001a960: 2020 2020 6465 6620 5f64 6574 6572 6d69      def _determi
+0001a970: 6e61 6e74 2873 656c 662c 2061 7869 7331  nant(self, axis1
+0001a980: 2c20 6178 6973 3229 3a0a 2020 2020 2020  , axis2):.      
+0001a990: 2020 6173 7365 7274 2061 7869 7331 2021    assert axis1 !
+0001a9a0: 3d20 6178 6973 320a 2020 2020 2020 2020  = axis2.        
+0001a9b0: 6c65 6e67 7468 203d 2073 656c 662e 7368  length = self.sh
+0001a9c0: 6170 655b 6178 6973 315d 0a20 2020 2020  ape[axis1].     
+0001a9d0: 2020 2061 7373 6572 7420 6c65 6e67 7468     assert length
+0001a9e0: 203d 3d20 7365 6c66 2e73 6861 7065 5b61   == self.shape[a
+0001a9f0: 7869 7332 5d0a 2020 2020 2020 2020 692c  xis2].        i,
+0001aa00: 206a 203d 2073 6f72 7465 6428 5b61 7869   j = sorted([axi
+0001aa10: 7331 2c20 6178 6973 325d 290a 2020 2020  s1, axis2]).    
+0001aa20: 2020 2020 7368 6170 6520 3d20 282a 7365      shape = (*se
+0001aa30: 6c66 2e73 6861 7065 5b3a 695d 2c20 2a73  lf.shape[:i], *s
+0001aa40: 656c 662e 7368 6170 655b 692b 313a 6a5d  elf.shape[i+1:j]
+0001aa50: 2c20 2a73 656c 662e 7368 6170 655b 6a2b  , *self.shape[j+
+0001aa60: 313a 5d29 0a20 2020 2020 2020 2064 7479  1:]).        dty
+0001aa70: 7065 203d 2063 6f6d 706c 6578 2069 6620  pe = complex if 
+0001aa80: 7365 6c66 2e64 7479 7065 203d 3d20 636f  self.dtype == co
+0001aa90: 6d70 6c65 7820 656c 7365 2066 6c6f 6174  mplex else float
+0001aaa0: 0a20 2020 2020 2020 2069 6620 6973 7a65  .        if isze
+0001aab0: 726f 286c 656e 6774 6829 3a0a 2020 2020  ro(length):.    
+0001aac0: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+0001aad0: 6e65 7328 7368 6170 652c 2064 7479 7065  nes(shape, dtype
+0001aae0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0001aaf0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001ab00: 726e 205a 6572 6f73 2873 6861 7065 2c20  rn Zeros(shape, 
+0001ab10: 6474 7970 6529 0a0a 2020 2020 4063 6163  dtype)..    @cac
+0001ab20: 6865 645f 7072 6f70 6572 7479 0a20 2020  hed_property.   
+0001ab30: 2064 6566 205f 6173 7370 6172 7365 2873   def _assparse(s
+0001ab40: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+0001ab50: 7475 726e 2028 290a 0a20 2020 2064 6566  turn ()..    def
+0001ab60: 205f 696e 7462 6f75 6e64 735f 696d 706c   _intbounds_impl
+0001ab70: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001ab80: 7265 7475 726e 2030 2c20 300a 0a0a 636c  return 0, 0...cl
+0001ab90: 6173 7320 496e 666c 6174 6528 4172 7261  ass Inflate(Arra
+0001aba0: 7929 3a0a 0a20 2020 2064 6566 205f 5f69  y):..    def __i
+0001abb0: 6e69 745f 5f28 7365 6c66 2c20 6675 6e63  nit__(self, func
+0001abc0: 3a20 4172 7261 792c 2064 6f66 6d61 703a  : Array, dofmap:
+0001abd0: 2041 7272 6179 2c20 6c65 6e67 7468 3a20   Array, length: 
+0001abe0: 4172 7261 7929 3a0a 2020 2020 2020 2020  Array):.        
+0001abf0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0001ac00: 6528 6675 6e63 2c20 4172 7261 7929 2c20  e(func, Array), 
+0001ac10: 6627 6675 6e63 3d7b 6675 6e63 2172 7d27  f'func={func!r}'
+0001ac20: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0001ac30: 6973 696e 7374 616e 6365 2864 6f66 6d61  isinstance(dofma
+0001ac40: 702c 2041 7272 6179 292c 2066 2764 6f66  p, Array), f'dof
+0001ac50: 6d61 703d 7b64 6f66 6d61 7021 727d 270a  map={dofmap!r}'.
+0001ac60: 2020 2020 2020 2020 6173 7365 7274 205f          assert _
+0001ac70: 6973 696e 6465 7828 6c65 6e67 7468 292c  isindex(length),
+0001ac80: 2066 276c 656e 6774 683d 7b6c 656e 6774   f'length={lengt
+0001ac90: 6821 727d 270a 2020 2020 2020 2020 6173  h!r}'.        as
+0001aca0: 7365 7274 2065 7175 616c 7368 6170 6528  sert equalshape(
+0001acb0: 6675 6e63 2e73 6861 7065 5b66 756e 632e  func.shape[func.
+0001acc0: 6e64 696d 2d64 6f66 6d61 702e 6e64 696d  ndim-dofmap.ndim
+0001acd0: 3a5d 2c20 646f 666d 6170 2e73 6861 7065  :], dofmap.shape
+0001ace0: 292c 2066 2766 756e 632e 7368 6170 653d  ), f'func.shape=
+0001acf0: 7b66 756e 632e 7368 6170 6521 727d 2c20  {func.shape!r}, 
+0001ad00: 646f 666d 6170 2e73 6861 7065 3d7b 646f  dofmap.shape={do
+0001ad10: 666d 6170 2e73 6861 7065 2172 7d27 0a20  fmap.shape!r}'. 
+0001ad20: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
+0001ad30: 203d 2066 756e 630a 2020 2020 2020 2020   = func.        
+0001ad40: 7365 6c66 2e64 6f66 6d61 7020 3d20 646f  self.dofmap = do
+0001ad50: 666d 6170 0a20 2020 2020 2020 2073 656c  fmap.        sel
+0001ad60: 662e 6c65 6e67 7468 203d 206c 656e 6774  f.length = lengt
+0001ad70: 680a 2020 2020 2020 2020 7365 6c66 2e77  h.        self.w
+0001ad80: 6172 6e20 3d20 6e6f 7420 646f 666d 6170  arn = not dofmap
+0001ad90: 2e69 7363 6f6e 7374 616e 740a 2020 2020  .isconstant.    
+0001ada0: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+0001adb0: 6974 5f5f 2861 7267 733d 2866 756e 632c  it__(args=(func,
+0001adc0: 2064 6f66 6d61 702c 206c 656e 6774 6829   dofmap, length)
+0001add0: 2c20 7368 6170 653d 282a 6675 6e63 2e73  , shape=(*func.s
+0001ade0: 6861 7065 5b3a 6675 6e63 2e6e 6469 6d2d  hape[:func.ndim-
+0001adf0: 646f 666d 6170 2e6e 6469 6d5d 2c20 6c65  dofmap.ndim], le
+0001ae00: 6e67 7468 292c 2064 7479 7065 3d66 756e  ngth), dtype=fun
+0001ae10: 632e 6474 7970 6529 0a0a 2020 2020 4063  c.dtype)..    @c
+0001ae20: 6163 6865 645f 7072 6f70 6572 7479 0a20  ached_property. 
+0001ae30: 2020 2064 6566 205f 6469 6167 6f6e 616c     def _diagonal
+0001ae40: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+0001ae50: 2072 6574 7572 6e20 7475 706c 6528 6178   return tuple(ax
+0001ae60: 6573 2066 6f72 2061 7865 7320 696e 2073  es for axes in s
+0001ae70: 656c 662e 6675 6e63 2e5f 6469 6167 6f6e  elf.func._diagon
+0001ae80: 616c 7320 6966 2061 6c6c 2861 7869 7320  als if all(axis 
+0001ae90: 3c20 7365 6c66 2e6e 6469 6d2d 3120 666f  < self.ndim-1 fo
+0001aea0: 7220 6178 6973 2069 6e20 6178 6573 2929  r axis in axes))
+0001aeb0: 0a0a 2020 2020 4063 6163 6865 645f 7072  ..    @cached_pr
+0001aec0: 6f70 6572 7479 0a20 2020 2064 6566 205f  operty.    def _
+0001aed0: 696e 666c 6174 696f 6e73 2873 656c 6629  inflations(self)
+0001aee0: 3a0a 2020 2020 2020 2020 696e 666c 6174  :.        inflat
+0001aef0: 696f 6e73 203d 205b 2873 656c 662e 6e64  ions = [(self.nd
+0001af00: 696d 2d31 2c20 7479 7065 732e 6672 6f7a  im-1, types.froz
+0001af10: 656e 6469 6374 287b 7365 6c66 2e64 6f66  endict({self.dof
+0001af20: 6d61 703a 2073 656c 662e 6675 6e63 7d29  map: self.func})
+0001af30: 295d 0a20 2020 2020 2020 2066 6f72 2061  )].        for a
+0001af40: 7869 732c 2070 6172 7473 2069 6e20 7365  xis, parts in se
+0001af50: 6c66 2e66 756e 632e 5f69 6e66 6c61 7469  lf.func._inflati
+0001af60: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+0001af70: 2069 6e66 6c61 7469 6f6e 732e 6170 7065   inflations.appe
+0001af80: 6e64 2828 6178 6973 2c20 7479 7065 732e  nd((axis, types.
+0001af90: 6672 6f7a 656e 6469 6374 2828 646f 666d  frozendict((dofm
+0001afa0: 6170 2c20 496e 666c 6174 6528 6675 6e63  ap, Inflate(func
+0001afb0: 2c20 7365 6c66 2e64 6f66 6d61 702c 2073  , self.dofmap, s
+0001afc0: 656c 662e 6c65 6e67 7468 2929 2066 6f72  elf.length)) for
+0001afd0: 2064 6f66 6d61 702c 2066 756e 6320 696e   dofmap, func in
+0001afe0: 2070 6172 7473 2e69 7465 6d73 2829 2929   parts.items()))
+0001aff0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0001b000: 2074 7570 6c65 2869 6e66 6c61 7469 6f6e   tuple(inflation
+0001b010: 7329 0a0a 2020 2020 6465 6620 5f73 696d  s)..    def _sim
+0001b020: 706c 6966 6965 6428 7365 6c66 293a 0a20  plified(self):. 
+0001b030: 2020 2020 2020 2066 6f72 2061 7869 7320         for axis 
+0001b040: 696e 2072 616e 6765 2873 656c 662e 646f  in range(self.do
+0001b050: 666d 6170 2e6e 6469 6d29 3a0a 2020 2020  fmap.ndim):.    
+0001b060: 2020 2020 2020 2020 6966 205f 6571 7561          if _equa
+0001b070: 6c73 5f73 6361 6c61 725f 636f 6e73 7461  ls_scalar_consta
+0001b080: 6e74 2873 656c 662e 646f 666d 6170 2e73  nt(self.dofmap.s
+0001b090: 6861 7065 5b61 7869 735d 2c20 3129 3a0a  hape[axis], 1):.
+0001b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b0b0: 7265 7475 726e 2049 6e66 6c61 7465 285f  return Inflate(_
+0001b0c0: 7461 6b65 2873 656c 662e 6675 6e63 2c20  take(self.func, 
+0001b0d0: 636f 6e73 7461 6e74 2830 292c 2073 656c  constant(0), sel
+0001b0e0: 662e 6675 6e63 2e6e 6469 6d2d 7365 6c66  f.func.ndim-self
+0001b0f0: 2e64 6f66 6d61 702e 6e64 696d 2b61 7869  .dofmap.ndim+axi
+0001b100: 7329 2c20 5f74 616b 6528 7365 6c66 2e64  s), _take(self.d
+0001b110: 6f66 6d61 702c 2063 6f6e 7374 616e 7428  ofmap, constant(
+0001b120: 3029 2c20 6178 6973 292c 2073 656c 662e  0), axis), self.
+0001b130: 6c65 6e67 7468 290a 2020 2020 2020 2020  length).        
+0001b140: 666f 7220 6178 6973 2c20 7061 7274 7320  for axis, parts 
+0001b150: 696e 2073 656c 662e 6675 6e63 2e5f 696e  in self.func._in
+0001b160: 666c 6174 696f 6e73 3a0a 2020 2020 2020  flations:.      
+0001b170: 2020 2020 2020 6920 3d20 6178 6973 202d        i = axis -
+0001b180: 2028 7365 6c66 2e6e 6469 6d2d 3129 0a20   (self.ndim-1). 
+0001b190: 2020 2020 2020 2020 2020 2069 6620 6920             if i 
+0001b1a0: 3e3d 2030 3a0a 2020 2020 2020 2020 2020  >= 0:.          
+0001b1b0: 2020 2020 2020 7265 7475 726e 2075 7469        return uti
+0001b1c0: 6c2e 7375 6d28 496e 666c 6174 6528 662c  l.sum(Inflate(f,
+0001b1d0: 205f 7461 6b65 2873 656c 662e 646f 666d   _take(self.dofm
+0001b1e0: 6170 2c20 696e 642c 2069 292c 2073 656c  ap, ind, i), sel
+0001b1f0: 662e 6c65 6e67 7468 2920 666f 7220 696e  f.length) for in
+0001b200: 642c 2066 2069 6e20 7061 7274 732e 6974  d, f in parts.it
+0001b210: 656d 7328 2929 0a20 2020 2020 2020 2069  ems()).        i
+0001b220: 6620 7365 6c66 2e64 6f66 6d61 702e 6e64  f self.dofmap.nd
+0001b230: 696d 203d 3d20 3020 616e 6420 5f65 7175  im == 0 and _equ
+0001b240: 616c 735f 7363 616c 6172 5f63 6f6e 7374  als_scalar_const
+0001b250: 616e 7428 7365 6c66 2e64 6f66 6d61 702c  ant(self.dofmap,
+0001b260: 2030 2920 616e 6420 5f65 7175 616c 735f   0) and _equals_
+0001b270: 7363 616c 6172 5f63 6f6e 7374 616e 7428  scalar_constant(
+0001b280: 7365 6c66 2e6c 656e 6774 682c 2031 293a  self.length, 1):
+0001b290: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001b2a0: 7572 6e20 496e 7365 7274 4178 6973 2873  urn InsertAxis(s
+0001b2b0: 656c 662e 6675 6e63 2c20 636f 6e73 7461  elf.func, consta
+0001b2c0: 6e74 2831 2929 0a20 2020 2020 2020 2072  nt(1)).        r
+0001b2d0: 6574 7572 6e20 7365 6c66 2e66 756e 632e  eturn self.func.
+0001b2e0: 5f69 6e66 6c61 7465 2873 656c 662e 646f  _inflate(self.do
+0001b2f0: 666d 6170 2c20 7365 6c66 2e6c 656e 6774  fmap, self.lengt
+0001b300: 682c 2073 656c 662e 6e64 696d 2d31 2920  h, self.ndim-1) 
+0001b310: 5c0a 2020 2020 2020 2020 2020 2020 6f72  \.            or
+0001b320: 2073 656c 662e 646f 666d 6170 2e5f 7269   self.dofmap._ri
+0001b330: 6e66 6c61 7465 2873 656c 662e 6675 6e63  nflate(self.func
+0001b340: 2c20 7365 6c66 2e6c 656e 6774 682c 2073  , self.length, s
+0001b350: 656c 662e 6e64 696d 2d31 290a 0a20 2020  elf.ndim-1)..   
+0001b360: 2064 6566 2065 7661 6c66 2873 656c 662c   def evalf(self,
+0001b370: 2061 7272 6179 2c20 696e 6469 6365 732c   array, indices,
+0001b380: 206c 656e 6774 6829 3a0a 2020 2020 2020   length):.      
+0001b390: 2020 6173 7365 7274 2069 6e64 6963 6573    assert indices
+0001b3a0: 2e6e 6469 6d20 3d3d 2073 656c 662e 646f  .ndim == self.do
+0001b3b0: 666d 6170 2e6e 6469 6d0a 2020 2020 2020  fmap.ndim.      
+0001b3c0: 2020 6173 7365 7274 206c 656e 6774 682e    assert length.
+0001b3d0: 6e64 696d 203d 3d20 300a 2020 2020 2020  ndim == 0.      
+0001b3e0: 2020 6966 2073 656c 662e 7761 726e 2061    if self.warn a
+0001b3f0: 6e64 2069 6e74 286c 656e 6774 6829 203e  nd int(length) >
+0001b400: 2069 6e64 6963 6573 2e73 697a 653a 0a20   indices.size:. 
+0001b410: 2020 2020 2020 2020 2020 2077 6172 6e69             warni
+0001b420: 6e67 732e 7761 726e 2827 7573 696e 6720  ngs.warn('using 
+0001b430: 6578 706c 6963 6974 2069 6e66 6c61 7469  explicit inflati
+0001b440: 6f6e 3b20 7468 6973 2069 7320 7573 7561  on; this is usua
+0001b450: 6c6c 7920 6120 6275 672e 272c 2045 7870  lly a bug.', Exp
+0001b460: 656e 7369 7665 4576 616c 7561 7469 6f6e  ensiveEvaluation
+0001b470: 5761 726e 696e 6729 0a20 2020 2020 2020  Warning).       
+0001b480: 2069 6e66 6c61 7465 6420 3d20 6e75 6d70   inflated = nump
+0001b490: 792e 7a65 726f 7328 6172 7261 792e 7368  y.zeros(array.sh
+0001b4a0: 6170 655b 3a61 7272 6179 2e6e 6469 6d2d  ape[:array.ndim-
+0001b4b0: 696e 6469 6365 732e 6e64 696d 5d20 2b20  indices.ndim] + 
+0001b4c0: 286c 656e 6774 682c 292c 2064 7479 7065  (length,), dtype
+0001b4d0: 3d73 656c 662e 6474 7970 6529 0a20 2020  =self.dtype).   
+0001b4e0: 2020 2020 206e 756d 7079 2e61 6464 2e61       numpy.add.a
+0001b4f0: 7428 696e 666c 6174 6564 2c20 2873 6c69  t(inflated, (sli
+0001b500: 6365 284e 6f6e 6529 2c29 2a28 7365 6c66  ce(None),)*(self
+0001b510: 2e6e 6469 6d2d 3129 2b28 696e 6469 6365  .ndim-1)+(indice
+0001b520: 732c 292c 2061 7272 6179 290a 2020 2020  s,), array).    
+0001b530: 2020 2020 7265 7475 726e 2069 6e66 6c61      return infla
+0001b540: 7465 640a 0a20 2020 2064 6566 205f 696e  ted..    def _in
+0001b550: 666c 6174 6528 7365 6c66 2c20 646f 666d  flate(self, dofm
+0001b560: 6170 2c20 6c65 6e67 7468 2c20 6178 6973  ap, length, axis
+0001b570: 293a 0a20 2020 2020 2020 2069 6620 646f  ):.        if do
+0001b580: 666d 6170 2e6e 6469 6d20 3d3d 2030 2061  fmap.ndim == 0 a
+0001b590: 6e64 2064 6f66 6d61 7020 3d3d 2073 656c  nd dofmap == sel
+0001b5a0: 662e 646f 666d 6170 2061 6e64 206c 656e  f.dofmap and len
+0001b5b0: 6774 6820 3d3d 2073 656c 662e 6c65 6e67  gth == self.leng
+0001b5c0: 7468 3a0a 2020 2020 2020 2020 2020 2020  th:.            
+0001b5d0: 7265 7475 726e 2064 6961 676f 6e61 6c69  return diagonali
+0001b5e0: 7a65 2873 656c 662c 202d 312c 2061 7869  ze(self, -1, axi
+0001b5f0: 7329 0a0a 2020 2020 6465 6620 5f64 6572  s)..    def _der
+0001b600: 6976 6174 6976 6528 7365 6c66 2c20 7661  ivative(self, va
+0001b610: 722c 2073 6565 6e29 3a0a 2020 2020 2020  r, seen):.      
+0001b620: 2020 7265 7475 726e 205f 696e 666c 6174    return _inflat
+0001b630: 6528 6465 7269 7661 7469 7665 2873 656c  e(derivative(sel
+0001b640: 662e 6675 6e63 2c20 7661 722c 2073 6565  f.func, var, see
+0001b650: 6e29 2c20 7365 6c66 2e64 6f66 6d61 702c  n), self.dofmap,
+0001b660: 2073 656c 662e 6c65 6e67 7468 2c20 7365   self.length, se
+0001b670: 6c66 2e6e 6469 6d2d 3129 0a0a 2020 2020  lf.ndim-1)..    
+0001b680: 6465 6620 5f6d 756c 7469 706c 7928 7365  def _multiply(se
+0001b690: 6c66 2c20 6f74 6865 7229 3a0a 2020 2020  lf, other):.    
+0001b6a0: 2020 2020 7265 7475 726e 2049 6e66 6c61      return Infla
+0001b6b0: 7465 286d 756c 7469 706c 7928 7365 6c66  te(multiply(self
+0001b6c0: 2e66 756e 632c 2054 616b 6528 6f74 6865  .func, Take(othe
+0001b6d0: 722c 2073 656c 662e 646f 666d 6170 2929  r, self.dofmap))
+0001b6e0: 2c20 7365 6c66 2e64 6f66 6d61 702c 2073  , self.dofmap, s
+0001b6f0: 656c 662e 6c65 6e67 7468 290a 0a20 2020  elf.length)..   
+0001b700: 2064 6566 205f 6164 6428 7365 6c66 2c20   def _add(self, 
+0001b710: 6f74 6865 7229 3a0a 2020 2020 2020 2020  other):.        
+0001b720: 6966 2069 7369 6e73 7461 6e63 6528 6f74  if isinstance(ot
+0001b730: 6865 722c 2049 6e66 6c61 7465 2920 616e  her, Inflate) an
+0001b740: 6420 7365 6c66 2e64 6f66 6d61 7020 3d3d  d self.dofmap ==
+0001b750: 206f 7468 6572 2e64 6f66 6d61 703a 0a20   other.dofmap:. 
+0001b760: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001b770: 6e20 496e 666c 6174 6528 6164 6428 7365  n Inflate(add(se
+0001b780: 6c66 2e66 756e 632c 206f 7468 6572 2e66  lf.func, other.f
+0001b790: 756e 6329 2c20 7365 6c66 2e64 6f66 6d61  unc), self.dofma
+0001b7a0: 702c 2073 656c 662e 6c65 6e67 7468 290a  p, self.length).
+0001b7b0: 0a20 2020 2064 6566 205f 7461 6b65 6469  .    def _takedi
+0001b7c0: 6167 2873 656c 662c 2061 7869 7331 2c20  ag(self, axis1, 
+0001b7d0: 6178 6973 3229 3a0a 2020 2020 2020 2020  axis2):.        
+0001b7e0: 6173 7365 7274 2061 7869 7331 203c 2061  assert axis1 < a
+0001b7f0: 7869 7332 0a20 2020 2020 2020 2069 6620  xis2.        if 
+0001b800: 6178 6973 3220 3d3d 2073 656c 662e 6e64  axis2 == self.nd
+0001b810: 696d 2d31 3a0a 2020 2020 2020 2020 2020  im-1:.          
+0001b820: 2020 6675 6e63 203d 205f 7461 6b65 2873    func = _take(s
+0001b830: 656c 662e 6675 6e63 2c20 7365 6c66 2e64  elf.func, self.d
+0001b840: 6f66 6d61 702c 2061 7869 7331 290a 2020  ofmap, axis1).  
+0001b850: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+0001b860: 696e 2072 616e 6765 2873 656c 662e 646f  in range(self.do
+0001b870: 666d 6170 2e6e 6469 6d29 3a0a 2020 2020  fmap.ndim):.    
+0001b880: 2020 2020 2020 2020 2020 2020 6675 6e63              func
+0001b890: 203d 205f 7461 6b65 6469 6167 2866 756e   = _takediag(fun
+0001b8a0: 632c 2061 7869 7331 2c20 6178 6973 322b  c, axis1, axis2+
+0001b8b0: 7365 6c66 2e64 6f66 6d61 702e 6e64 696d  self.dofmap.ndim
+0001b8c0: 2d31 2d69 290a 2020 2020 2020 2020 2020  -1-i).          
+0001b8d0: 2020 7265 7475 726e 2049 6e66 6c61 7465    return Inflate
+0001b8e0: 2866 756e 632c 2073 656c 662e 646f 666d  (func, self.dofm
+0001b8f0: 6170 2c20 7365 6c66 2e6c 656e 6774 6829  ap, self.length)
+0001b900: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001b910: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001b920: 6e20 5f69 6e66 6c61 7465 285f 7461 6b65  n _inflate(_take
+0001b930: 6469 6167 2873 656c 662e 6675 6e63 2c20  diag(self.func, 
+0001b940: 6178 6973 312c 2061 7869 7332 292c 2073  axis1, axis2), s
+0001b950: 656c 662e 646f 666d 6170 2c20 7365 6c66  elf.dofmap, self
+0001b960: 2e6c 656e 6774 682c 2073 656c 662e 6e64  .length, self.nd
+0001b970: 696d 2d33 290a 0a20 2020 2064 6566 205f  im-3)..    def _
+0001b980: 7461 6b65 2873 656c 662c 2069 6e64 6578  take(self, index
+0001b990: 2c20 6178 6973 293a 0a20 2020 2020 2020  , axis):.       
+0001b9a0: 2069 6620 6178 6973 2021 3d20 7365 6c66   if axis != self
+0001b9b0: 2e6e 6469 6d2d 313a 0a20 2020 2020 2020  .ndim-1:.       
+0001b9c0: 2020 2020 2072 6574 7572 6e20 496e 666c       return Infl
+0001b9d0: 6174 6528 5f74 616b 6528 7365 6c66 2e66  ate(_take(self.f
+0001b9e0: 756e 632c 2069 6e64 6578 2c20 6178 6973  unc, index, axis
+0001b9f0: 292c 2073 656c 662e 646f 666d 6170 2c20  ), self.dofmap, 
+0001ba00: 7365 6c66 2e6c 656e 6774 6829 0a20 2020  self.length).   
+0001ba10: 2020 2020 206e 6577 696e 6465 782c 206e       newindex, n
+0001ba20: 6577 646f 666d 6170 203d 2053 7761 7049  ewdofmap = SwapI
+0001ba30: 6e66 6c61 7465 5461 6b65 2873 656c 662e  nflateTake(self.
+0001ba40: 646f 666d 6170 2c20 696e 6465 7829 0a20  dofmap, index). 
+0001ba50: 2020 2020 2020 2069 6620 7365 6c66 2e64         if self.d
+0001ba60: 6f66 6d61 702e 6e64 696d 3a0a 2020 2020  ofmap.ndim:.    
+0001ba70: 2020 2020 2020 2020 6675 6e63 203d 2073          func = s
+0001ba80: 656c 662e 6675 6e63 0a20 2020 2020 2020  elf.func.       
+0001ba90: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+0001baa0: 6e67 6528 7365 6c66 2e64 6f66 6d61 702e  nge(self.dofmap.
+0001bab0: 6e64 696d 2d31 293a 0a20 2020 2020 2020  ndim-1):.       
+0001bac0: 2020 2020 2020 2020 2066 756e 6320 3d20           func = 
+0001bad0: 5261 7665 6c28 6675 6e63 290a 2020 2020  Ravel(func).    
+0001bae0: 2020 2020 2020 2020 696e 7465 7273 6563          intersec
+0001baf0: 7469 6f6e 203d 2054 616b 6528 6675 6e63  tion = Take(func
+0001bb00: 2c20 6e65 7769 6e64 6578 290a 2020 2020  , newindex).    
+0001bb10: 2020 2020 656c 7365 3a20 2023 206b 726f      else:  # kro
+0001bb20: 6e65 636b 6572 3b20 6e65 7769 6e64 6578  necker; newindex
+0001bb30: 2069 7320 616c 6c20 7a65 726f 7320 2862   is all zeros (b
+0001bb40: 7574 206f 6620 7661 7279 696e 6720 6c65  ut of varying le
+0001bb50: 6e67 7468 290a 2020 2020 2020 2020 2020  ngth).          
+0001bb60: 2020 696e 7465 7273 6563 7469 6f6e 203d    intersection =
+0001bb70: 2049 6e73 6572 7441 7869 7328 7365 6c66   InsertAxis(self
+0001bb80: 2e66 756e 632c 206e 6577 696e 6465 782e  .func, newindex.
+0001bb90: 7368 6170 655b 305d 290a 2020 2020 2020  shape[0]).      
+0001bba0: 2020 6966 2069 6e64 6578 2e6e 6469 6d3a    if index.ndim:
+0001bbb0: 0a20 2020 2020 2020 2020 2020 2073 7761  .            swa
+0001bbc0: 7070 6564 203d 2049 6e66 6c61 7465 2869  pped = Inflate(i
+0001bbd0: 6e74 6572 7365 6374 696f 6e2c 206e 6577  ntersection, new
+0001bbe0: 646f 666d 6170 2c20 7574 696c 2e70 726f  dofmap, util.pro
+0001bbf0: 6475 6374 2869 6e64 6578 2e73 6861 7065  duct(index.shape
+0001bc00: 2929 0a20 2020 2020 2020 2020 2020 2066  )).            f
+0001bc10: 6f72 2069 2069 6e20 7261 6e67 6528 696e  or i in range(in
+0001bc20: 6465 782e 6e64 696d 2d31 293a 0a20 2020  dex.ndim-1):.   
+0001bc30: 2020 2020 2020 2020 2020 2020 2073 7761               swa
+0001bc40: 7070 6564 203d 2055 6e72 6176 656c 2873  pped = Unravel(s
+0001bc50: 7761 7070 6564 2c20 696e 6465 782e 7368  wapped, index.sh
+0001bc60: 6170 655b 695d 2c20 7574 696c 2e70 726f  ape[i], util.pro
+0001bc70: 6475 6374 2869 6e64 6578 2e73 6861 7065  duct(index.shape
+0001bc80: 5b69 2b31 3a5d 2929 0a20 2020 2020 2020  [i+1:])).       
+0001bc90: 2065 6c73 653a 2020 2320 6765 743b 206e   else:  # get; n
+0001bca0: 6577 646f 666d 6170 2069 7320 616c 6c20  ewdofmap is all 
+0001bcb0: 7a65 726f 7320 2862 7574 206f 6620 7661  zeros (but of va
+0001bcc0: 7279 696e 6720 6c65 6e67 7468 290a 2020  rying length).  
+0001bcd0: 2020 2020 2020 2020 2020 7377 6170 7065            swappe
+0001bce0: 6420 3d20 5375 6d28 696e 7465 7273 6563  d = Sum(intersec
+0001bcf0: 7469 6f6e 290a 2020 2020 2020 2020 7265  tion).        re
+0001bd00: 7475 726e 2073 7761 7070 6564 0a0a 2020  turn swapped..  
+0001bd10: 2020 6465 6620 5f64 6961 676f 6e61 6c69    def _diagonali
+0001bd20: 7a65 2873 656c 662c 2061 7869 7329 3a0a  ze(self, axis):.
+0001bd30: 2020 2020 2020 2020 6966 2061 7869 7320          if axis 
+0001bd40: 213d 2073 656c 662e 6e64 696d 2d31 3a0a  != self.ndim-1:.
+0001bd50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001bd60: 726e 205f 696e 666c 6174 6528 6469 6167  rn _inflate(diag
+0001bd70: 6f6e 616c 697a 6528 7365 6c66 2e66 756e  onalize(self.fun
+0001bd80: 632c 2061 7869 7329 2c20 7365 6c66 2e64  c, axis), self.d
+0001bd90: 6f66 6d61 702c 2073 656c 662e 6c65 6e67  ofmap, self.leng
+0001bda0: 7468 2c20 7365 6c66 2e6e 6469 6d2d 3129  th, self.ndim-1)
+0001bdb0: 0a0a 2020 2020 6465 6620 5f73 756d 2873  ..    def _sum(s
+0001bdc0: 656c 662c 2061 7869 7329 3a0a 2020 2020  elf, axis):.    
+0001bdd0: 2020 2020 6966 2061 7869 7320 3d3d 2073      if axis == s
+0001bde0: 656c 662e 6e64 696d 2d31 3a0a 2020 2020  elf.ndim-1:.    
+0001bdf0: 2020 2020 2020 2020 6675 6e63 203d 2073          func = s
+0001be00: 656c 662e 6675 6e63 0a20 2020 2020 2020  elf.func.       
+0001be10: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+0001be20: 6e67 6528 7365 6c66 2e64 6f66 6d61 702e  nge(self.dofmap.
+0001be30: 6e64 696d 293a 0a20 2020 2020 2020 2020  ndim):.         
+0001be40: 2020 2020 2020 2066 756e 6320 3d20 5375         func = Su
+0001be50: 6d28 6675 6e63 290a 2020 2020 2020 2020  m(func).        
+0001be60: 2020 2020 7265 7475 726e 2066 756e 630a      return func.
+0001be70: 2020 2020 2020 2020 7265 7475 726e 2049          return I
+0001be80: 6e66 6c61 7465 2873 756d 2873 656c 662e  nflate(sum(self.
+0001be90: 6675 6e63 2c20 6178 6973 292c 2073 656c  func, axis), sel
+0001bea0: 662e 646f 666d 6170 2c20 7365 6c66 2e6c  f.dofmap, self.l
+0001beb0: 656e 6774 6829 0a0a 2020 2020 6465 6620  ength)..    def 
+0001bec0: 5f75 6e72 6176 656c 2873 656c 662c 2061  _unravel(self, a
+0001bed0: 7869 732c 2073 6861 7065 293a 0a20 2020  xis, shape):.   
+0001bee0: 2020 2020 2069 6620 6178 6973 2021 3d20       if axis != 
+0001bef0: 7365 6c66 2e6e 6469 6d2d 313a 0a20 2020  self.ndim-1:.   
+0001bf00: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001bf10: 496e 666c 6174 6528 756e 7261 7665 6c28  Inflate(unravel(
+0001bf20: 7365 6c66 2e66 756e 632c 2061 7869 732c  self.func, axis,
+0001bf30: 2073 6861 7065 292c 2073 656c 662e 646f   shape), self.do
+0001bf40: 666d 6170 2c20 7365 6c66 2e6c 656e 6774  fmap, self.lengt
+0001bf50: 6829 0a0a 2020 2020 6465 6620 5f73 6967  h)..    def _sig
+0001bf60: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
+0001bf70: 2069 6620 7365 6c66 2e64 6f66 6d61 702e   if self.dofmap.
+0001bf80: 6973 636f 6e73 7461 6e74 2061 6e64 205f  isconstant and _
+0001bf90: 6973 756e 6971 7565 2873 656c 662e 646f  isunique(self.do
+0001bfa0: 666d 6170 2e65 7661 6c28 2929 3a0a 2020  fmap.eval()):.  
+0001bfb0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001bfc0: 2049 6e66 6c61 7465 2853 6967 6e28 7365   Inflate(Sign(se
+0001bfd0: 6c66 2e66 756e 6329 2c20 7365 6c66 2e64  lf.func), self.d
+0001bfe0: 6f66 6d61 702c 2073 656c 662e 6c65 6e67  ofmap, self.leng
+0001bff0: 7468 290a 0a20 2020 2040 6361 6368 6564  th)..    @cached
+0001c000: 5f70 726f 7065 7274 790a 2020 2020 6465  _property.    de
+0001c010: 6620 5f61 7373 7061 7273 6528 7365 6c66  f _assparse(self
+0001c020: 293a 0a20 2020 2020 2020 2063 6875 6e6b  ):.        chunk
+0001c030: 7320 3d20 5b5d 0a20 2020 2020 2020 2066  s = [].        f
+0001c040: 6c61 745f 646f 666d 6170 203d 205f 666c  lat_dofmap = _fl
+0001c050: 6174 2873 656c 662e 646f 666d 6170 290a  at(self.dofmap).
+0001c060: 2020 2020 2020 2020 6b65 6570 5f64 696d          keep_dim
+0001c070: 203d 2073 656c 662e 6675 6e63 2e6e 6469   = self.func.ndi
+0001c080: 6d20 2d20 7365 6c66 2e64 6f66 6d61 702e  m - self.dofmap.
+0001c090: 6e64 696d 0a20 2020 2020 2020 2073 7472  ndim.        str
+0001c0a0: 6964 6573 203d 2028 312c 202a 6974 6572  ides = (1, *iter
+0001c0b0: 746f 6f6c 732e 6163 6375 6d75 6c61 7465  tools.accumulate
+0001c0c0: 2873 656c 662e 646f 666d 6170 2e73 6861  (self.dofmap.sha
+0001c0d0: 7065 5b3a 303a 2d31 5d2c 206f 7065 7261  pe[:0:-1], opera
+0001c0e0: 746f 722e 6d75 6c29 295b 3a3a 2d31 5d0a  tor.mul))[::-1].
+0001c0f0: 2020 2020 2020 2020 666f 7220 2a69 6e64          for *ind
+0001c100: 6963 6573 2c20 7661 6c75 6573 2069 6e20  ices, values in 
+0001c110: 7365 6c66 2e66 756e 632e 5f61 7373 7061  self.func._asspa
+0001c120: 7273 653a 0a20 2020 2020 2020 2020 2020  rse:.           
+0001c130: 2069 6620 7365 6c66 2e64 6f66 6d61 702e   if self.dofmap.
+0001c140: 6e64 696d 3a0a 2020 2020 2020 2020 2020  ndim:.          
+0001c150: 2020 2020 2020 696e 666c 6174 655f 696e        inflate_in
+0001c160: 6469 6365 7320 3d20 5461 6b65 2866 6c61  dices = Take(fla
+0001c170: 745f 646f 666d 6170 2c20 6675 6e63 746f  t_dofmap, functo
+0001c180: 6f6c 732e 7265 6475 6365 286f 7065 7261  ols.reduce(opera
+0001c190: 746f 722e 6164 642c 206d 6170 286f 7065  tor.add, map(ope
+0001c1a0: 7261 746f 722e 6d75 6c2c 2069 6e64 6963  rator.mul, indic
+0001c1b0: 6573 5b6b 6565 705f 6469 6d3a 5d2c 2073  es[keep_dim:], s
+0001c1c0: 7472 6964 6573 2929 290a 2020 2020 2020  trides))).      
+0001c1d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001c1e0: 2020 2020 2020 2020 2020 2020 696e 666c              infl
+0001c1f0: 6174 655f 696e 6469 6365 7320 3d20 6170  ate_indices = ap
+0001c200: 7065 6e64 6178 6573 2873 656c 662e 646f  pendaxes(self.do
+0001c210: 666d 6170 2c20 7661 6c75 6573 2e73 6861  fmap, values.sha
+0001c220: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
+0001c230: 6368 756e 6b73 2e61 7070 656e 6428 282a  chunks.append((*
+0001c240: 696e 6469 6365 735b 3a6b 6565 705f 6469  indices[:keep_di
+0001c250: 6d5d 2c20 696e 666c 6174 655f 696e 6469  m], inflate_indi
+0001c260: 6365 732c 2076 616c 7565 7329 290a 2020  ces, values)).  
+0001c270: 2020 2020 2020 7265 7475 726e 2074 7570        return tup
+0001c280: 6c65 2863 6875 6e6b 7329 0a0a 2020 2020  le(chunks)..    
+0001c290: 6465 6620 5f69 6e74 626f 756e 6473 5f69  def _intbounds_i
+0001c2a0: 6d70 6c28 7365 6c66 293a 0a20 2020 2020  mpl(self):.     
+0001c2b0: 2020 206c 6f77 6572 2c20 7570 7065 7220     lower, upper 
+0001c2c0: 3d20 7365 6c66 2e66 756e 632e 5f69 6e74  = self.func._int
+0001c2d0: 626f 756e 6473 0a20 2020 2020 2020 2072  bounds.        r
+0001c2e0: 6574 7572 6e20 6d69 6e28 6c6f 7765 722c  eturn min(lower,
+0001c2f0: 2030 292c 206d 6178 2875 7070 6572 2c20   0), max(upper, 
+0001c300: 3029 0a0a 0a63 6c61 7373 2053 7761 7049  0)...class SwapI
+0001c310: 6e66 6c61 7465 5461 6b65 2845 7661 6c75  nflateTake(Evalu
+0001c320: 6162 6c65 293a 0a0a 2020 2020 6465 6620  able):..    def 
+0001c330: 5f5f 696e 6974 5f5f 2873 656c 662c 2069  __init__(self, i
+0001c340: 6e66 6c61 7465 6964 782c 2074 616b 6569  nflateidx, takei
+0001c350: 6478 293a 0a20 2020 2020 2020 2073 656c  dx):.        sel
+0001c360: 662e 696e 666c 6174 6569 6478 203d 2069  f.inflateidx = i
+0001c370: 6e66 6c61 7465 6964 780a 2020 2020 2020  nflateidx.      
+0001c380: 2020 7365 6c66 2e74 616b 6569 6478 203d    self.takeidx =
+0001c390: 2074 616b 6569 6478 0a20 2020 2020 2020   takeidx.       
+0001c3a0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+0001c3b0: 5f28 6172 6773 3d28 696e 666c 6174 6569  _(args=(inflatei
+0001c3c0: 6478 2c20 7461 6b65 6964 7829 290a 0a20  dx, takeidx)).. 
+0001c3d0: 2020 2064 6566 205f 7369 6d70 6c69 6669     def _simplifi
+0001c3e0: 6564 2873 656c 6629 3a0a 2020 2020 2020  ed(self):.      
+0001c3f0: 2020 6966 2073 656c 662e 6973 636f 6e73    if self.iscons
+0001c400: 7461 6e74 3a0a 2020 2020 2020 2020 2020  tant:.          
+0001c410: 2020 7265 7475 726e 2054 7570 6c65 2874    return Tuple(t
+0001c420: 7570 6c65 286d 6170 2863 6f6e 7374 616e  uple(map(constan
+0001c430: 742c 2073 656c 662e 6576 616c 2829 2929  t, self.eval()))
+0001c440: 290a 0a20 2020 2064 6566 205f 5f69 7465  )..    def __ite
+0001c450: 725f 5f28 7365 6c66 293a 0a20 2020 2020  r__(self):.     
+0001c460: 2020 2073 6861 7065 203d 2041 7272 6179     shape = Array
+0001c470: 4672 6f6d 5475 706c 6528 7365 6c66 2c20  FromTuple(self, 
+0001c480: 696e 6465 783d 322c 2073 6861 7065 3d28  index=2, shape=(
+0001c490: 292c 2064 7479 7065 3d69 6e74 2c20 5f6c  ), dtype=int, _l
+0001c4a0: 6f77 6572 3d30 292c 0a20 2020 2020 2020  ower=0),.       
+0001c4b0: 2072 6574 7572 6e20 2841 7272 6179 4672   return (ArrayFr
+0001c4c0: 6f6d 5475 706c 6528 7365 6c66 2c20 696e  omTuple(self, in
+0001c4d0: 6465 783d 696e 6465 782c 2073 6861 7065  dex=index, shape
+0001c4e0: 3d73 6861 7065 2c20 6474 7970 653d 696e  =shape, dtype=in
+0001c4f0: 742c 205f 6c6f 7765 723d 3029 2066 6f72  t, _lower=0) for
+0001c500: 2069 6e64 6578 2069 6e20 7261 6e67 6528   index in range(
+0001c510: 3229 290a 0a20 2020 2040 7374 6174 6963  2))..    @static
+0001c520: 6d65 7468 6f64 0a20 2020 2064 6566 2065  method.    def e
+0001c530: 7661 6c66 2869 6e66 6c61 7465 6964 782c  valf(inflateidx,
+0001c540: 2074 616b 6569 6478 293a 0a20 2020 2020   takeidx):.     
+0001c550: 2020 2075 6e69 7175 6569 6e66 6c61 7465     uniqueinflate
+0001c560: 203d 205f 6973 756e 6971 7565 2869 6e66   = _isunique(inf
+0001c570: 6c61 7465 6964 7829 0a20 2020 2020 2020  lateidx).       
+0001c580: 2075 6e69 7175 6574 616b 6520 3d20 5f69   uniquetake = _i
+0001c590: 7375 6e69 7175 6528 7461 6b65 6964 7829  sunique(takeidx)
+0001c5a0: 0a20 2020 2020 2020 2075 6e69 7175 6520  .        unique 
+0001c5b0: 3d20 756e 6971 7565 696e 666c 6174 6520  = uniqueinflate 
+0001c5c0: 616e 6420 756e 6971 7565 7461 6b65 0a20  and uniquetake. 
+0001c5d0: 2020 2020 2020 2023 2049 6620 626f 7468         # If both
+0001c5e0: 2069 6e64 6963 6573 2061 7265 2075 6e69   indices are uni
+0001c5f0: 7175 6520 2869 2e65 2e20 7468 6579 2064  que (i.e. they d
+0001c600: 6f20 6e6f 7420 636f 6e74 6169 6e20 6475  o not contain du
+0001c610: 706c 6963 6174 6573 2920 7468 656e 2074  plicates) then t
+0001c620: 6865 0a20 2020 2020 2020 2023 2074 616b  he.        # tak
+0001c630: 6520 616e 6420 696e 666c 6174 6520 6f70  e and inflate op
+0001c640: 6572 6174 696f 6e73 2063 616e 2073 696d  erations can sim
+0001c650: 706c 7920 6265 2072 6573 7472 6963 7465  ply be restricte
+0001c660: 6420 746f 2074 6865 2069 6e74 6572 7365  d to the interse
+0001c670: 6374 696f 6e2c 0a20 2020 2020 2020 2023  ction,.        #
+0001c680: 2077 6974 6820 7468 6520 7468 6520 6c6f   with the the lo
+0001c690: 6361 7469 6f6e 206f 6620 7468 6520 696e  cation of the in
+0001c6a0: 7465 7273 6563 7469 6f6e 2069 6e20 7468  tersection in th
+0001c6b0: 6520 6f72 6967 696e 616c 2069 6e64 6578  e original index
+0001c6c0: 2076 6563 746f 7273 0a20 2020 2020 2020   vectors.       
+0001c6d0: 2023 2062 6569 6e67 2074 6865 206e 6577   # being the new
+0001c6e0: 2069 6e64 6963 6573 2066 6f72 2074 6865   indices for the
+0001c6f0: 2073 7761 7070 6564 206f 7065 7261 7469   swapped operati
+0001c700: 6f6e 732e 0a20 2020 2020 2020 2069 6e74  ons..        int
+0001c710: 6572 7365 6374 696f 6e2c 2073 7562 696e  ersection, subin
+0001c720: 666c 6174 652c 2073 7562 7461 6b65 203d  flate, subtake =
+0001c730: 206e 756d 7079 2e69 6e74 6572 7365 6374   numpy.intersect
+0001c740: 3164 2869 6e66 6c61 7465 6964 782c 2074  1d(inflateidx, t
+0001c750: 616b 6569 6478 2c20 7265 7475 726e 5f69  akeidx, return_i
+0001c760: 6e64 6963 6573 3d54 7275 652c 2061 7373  ndices=True, ass
+0001c770: 756d 655f 756e 6971 7565 3d75 6e69 7175  ume_unique=uniqu
+0001c780: 6529 0a20 2020 2020 2020 2069 6620 756e  e).        if un
+0001c790: 6971 7565 3a0a 2020 2020 2020 2020 2020  ique:.          
+0001c7a0: 2020 7265 7475 726e 2073 7562 696e 666c    return subinfl
+0001c7b0: 6174 652c 2073 7562 7461 6b65 2c20 6e75  ate, subtake, nu
+0001c7c0: 6d70 792e 6172 7261 7928 6c65 6e28 696e  mpy.array(len(in
+0001c7d0: 7465 7273 6563 7469 6f6e 2929 0a20 2020  tersection)).   
+0001c7e0: 2020 2020 2023 204f 7468 6572 7769 7365       # Otherwise
+0001c7f0: 2c20 7768 696c 6520 7374 696c 6c20 6c69  , while still li
+0001c800: 6d69 7469 6e67 2074 6865 206f 7065 7261  miting the opera
+0001c810: 7469 6f6e 7320 746f 2074 6865 2069 6e74  tions to the int
+0001c820: 6572 7365 6374 696f 6e2c 2077 650a 2020  ersection, we.  
+0001c830: 2020 2020 2020 2320 6e65 6564 2074 6f20        # need to 
+0001c840: 6164 6420 7468 6520 6170 7072 6f70 7269  add the appropri
+0001c850: 6174 6520 6475 706c 6963 6174 696f 6e73  ate duplications
+0001c860: 206f 6e20 6569 7468 6572 2073 6964 652e   on either side.
+0001c870: 2054 6865 2065 6173 6965 7374 2077 6179   The easiest way
+0001c880: 0a20 2020 2020 2020 2023 2074 6f20 646f  .        # to do
+0001c890: 2074 6869 7320 6973 2074 6f20 666f 726d   this is to form
+0001c8a0: 2074 6865 2070 6572 6d75 7461 7469 6f6e   the permutation
+0001c8b0: 206d 6174 7269 7820 4120 666f 7220 7461   matrix A for ta
+0001c8c0: 6b65 2028 6d61 7920 636f 6e74 6169 6e0a  ke (may contain.
+0001c8d0: 2020 2020 2020 2020 2320 6d75 6c74 6970          # multip
+0001c8e0: 6c65 2069 7465 6d73 2070 6572 2063 6f6c  le items per col
+0001c8f0: 756d 6e29 2061 6e64 2042 2066 6f72 2069  umn) and B for i
+0001c900: 6e66 6c61 7465 2028 6d61 7920 636f 6e74  nflate (may cont
+0001c910: 6169 6e20 7365 7665 7261 6c20 6974 656d  ain several item
+0001c920: 730a 2020 2020 2020 2020 2320 7065 7220  s.        # per 
+0001c930: 726f 7729 2061 6e64 2074 616b 6520 7468  row) and take th
+0001c940: 6520 7072 6f64 7563 7420 4142 2066 6f72  e product AB for
+0001c950: 2074 6865 2063 6f6d 6269 6e65 6420 6f70   the combined op
+0001c960: 6572 6174 696f 6e2e 2054 6f20 7468 656e  eration. To then
+0001c970: 0a20 2020 2020 2020 2023 2064 6563 6f6d  .        # decom
+0001c980: 706f 7365 2041 4220 696e 746f 2074 6865  pose AB into the
+0001c990: 2065 7175 6976 616c 656e 7420 7461 6b65   equivalent take
+0001c9a0: 2066 6f6c 6c6f 7765 6420 6279 2069 6e66   followed by inf
+0001c9b0: 6c61 7465 2077 6520 6361 6e20 7369 6d70  late we can simp
+0001c9c0: 6c79 0a20 2020 2020 2020 2023 2074 616b  ly.        # tak
+0001c9d0: 6520 7468 6520 7477 6f20 696e 6465 7820  e the two index 
+0001c9e0: 7665 6374 6f72 7320 6672 6f6d 2041 422e  vectors from AB.
+0001c9f0: 6e6f 6e7a 6572 6f28 2920 616e 6420 666f  nonzero() and fo
+0001ca00: 726d 2043 4420 3d20 4142 2e20 5468 650a  rm CD = AB. The.
+0001ca10: 2020 2020 2020 2020 2320 616c 676f 7269          # algori
+0001ca20: 7468 6d20 6265 6c6f 7720 646f 6573 2070  thm below does p
+0001ca30: 7265 6369 7365 6c79 2074 6869 7320 7769  recisely this wi
+0001ca40: 7468 6f75 7420 666f 726d 696e 6720 4142  thout forming AB
+0001ca50: 2065 7870 6c69 6369 746c 792e 0a20 2020   explicitly..   
+0001ca60: 2020 2020 206e 6577 696e 666c 6174 6520       newinflate 
+0001ca70: 3d20 5b5d 0a20 2020 2020 2020 206e 6577  = [].        new
+0001ca80: 7461 6b65 203d 205b 5d0a 2020 2020 2020  take = [].      
+0001ca90: 2020 666f 7220 6b2c 206e 2069 6e20 656e    for k, n in en
+0001caa0: 756d 6572 6174 6528 696e 7465 7273 6563  umerate(intersec
+0001cab0: 7469 6f6e 293a 0a20 2020 2020 2020 2020  tion):.         
+0001cac0: 2020 2066 6f72 2069 2069 6e20 5b73 7562     for i in [sub
+0001cad0: 7461 6b65 5b6b 5d5d 2069 6620 756e 6971  take[k]] if uniq
+0001cae0: 7565 7461 6b65 2065 6c73 6520 6e75 6d70  uetake else nump
+0001caf0: 792e 6571 7561 6c28 7461 6b65 6964 782e  y.equal(takeidx.
+0001cb00: 7261 7665 6c28 292c 206e 292e 6e6f 6e7a  ravel(), n).nonz
+0001cb10: 6572 6f28 295b 305d 3a0a 2020 2020 2020  ero()[0]:.      
+0001cb20: 2020 2020 2020 2020 2020 666f 7220 6a20            for j 
+0001cb30: 696e 205b 7375 6269 6e66 6c61 7465 5b6b  in [subinflate[k
+0001cb40: 5d5d 2069 6620 756e 6971 7565 696e 666c  ]] if uniqueinfl
+0001cb50: 6174 6520 656c 7365 206e 756d 7079 2e65  ate else numpy.e
+0001cb60: 7175 616c 2869 6e66 6c61 7465 6964 782e  qual(inflateidx.
+0001cb70: 7261 7665 6c28 292c 206e 292e 6e6f 6e7a  ravel(), n).nonz
+0001cb80: 6572 6f28 295b 305d 3a0a 2020 2020 2020  ero()[0]:.      
+0001cb90: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+0001cba0: 7769 6e66 6c61 7465 2e61 7070 656e 6428  winflate.append(
+0001cbb0: 6929 0a20 2020 2020 2020 2020 2020 2020  i).             
+0001cbc0: 2020 2020 2020 206e 6577 7461 6b65 2e61         newtake.a
+0001cbd0: 7070 656e 6428 6a29 0a20 2020 2020 2020  ppend(j).       
+0001cbe0: 2072 6574 7572 6e20 6e75 6d70 792e 6172   return numpy.ar
+0001cbf0: 7261 7928 6e65 7774 616b 652c 2064 7479  ray(newtake, dty
+0001cc00: 7065 3d69 6e74 292c 206e 756d 7079 2e61  pe=int), numpy.a
+0001cc10: 7272 6179 286e 6577 696e 666c 6174 652c  rray(newinflate,
+0001cc20: 2064 7479 7065 3d69 6e74 292c 206e 756d   dtype=int), num
+0001cc30: 7079 2e61 7272 6179 286c 656e 286e 6577  py.array(len(new
+0001cc40: 7461 6b65 292c 2064 7479 7065 3d69 6e74  take), dtype=int
+0001cc50: 290a 0a0a 636c 6173 7320 4469 6167 6f6e  )...class Diagon
+0001cc60: 616c 697a 6528 4172 7261 7929 3a0a 0a20  alize(Array):.. 
+0001cc70: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+0001cc80: 7365 6c66 2c20 6675 6e63 3a20 4172 7261  self, func: Arra
+0001cc90: 7929 3a0a 2020 2020 2020 2020 6173 7365  y):.        asse
+0001cca0: 7274 2069 7369 6e73 7461 6e63 6528 6675  rt isinstance(fu
+0001ccb0: 6e63 2c20 4172 7261 7929 2061 6e64 2066  nc, Array) and f
+0001ccc0: 756e 632e 6e64 696d 203e 2030 2c20 6627  unc.ndim > 0, f'
+0001ccd0: 6675 6e63 3d7b 6675 6e63 2172 7d27 0a20  func={func!r}'. 
+0001cce0: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
+0001ccf0: 203d 2066 756e 630a 2020 2020 2020 2020   = func.        
+0001cd00: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+0001cd10: 2861 7267 733d 2866 756e 632c 292c 2073  (args=(func,), s
+0001cd20: 6861 7065 3d28 2a66 756e 632e 7368 6170  hape=(*func.shap
+0001cd30: 652c 2066 756e 632e 7368 6170 655b 2d31  e, func.shape[-1
+0001cd40: 5d29 2c20 6474 7970 653d 6675 6e63 2e64  ]), dtype=func.d
+0001cd50: 7479 7065 290a 0a20 2020 2040 6361 6368  type)..    @cach
+0001cd60: 6564 5f70 726f 7065 7274 790a 2020 2020  ed_property.    
+0001cd70: 6465 6620 5f64 6961 676f 6e61 6c73 2873  def _diagonals(s
+0001cd80: 656c 6629 3a0a 2020 2020 2020 2020 6469  elf):.        di
+0001cd90: 6167 6f6e 616c 7320 3d20 5b66 726f 7a65  agonals = [froze
+0001cda0: 6e73 6574 285b 7365 6c66 2e6e 6469 6d2d  nset([self.ndim-
+0001cdb0: 322c 2073 656c 662e 6e64 696d 2d31 5d29  2, self.ndim-1])
+0001cdc0: 5d0a 2020 2020 2020 2020 666f 7220 6178  ].        for ax
+0001cdd0: 6573 2069 6e20 7365 6c66 2e66 756e 632e  es in self.func.
+0001cde0: 5f64 6961 676f 6e61 6c73 3a0a 2020 2020  _diagonals:.    
+0001cdf0: 2020 2020 2020 2020 6966 2061 7865 7320          if axes 
+0001ce00: 2620 6469 6167 6f6e 616c 735b 305d 3a0a  & diagonals[0]:.
+0001ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce20: 6469 6167 6f6e 616c 735b 305d 207c 3d20  diagonals[0] |= 
+0001ce30: 6178 6573 0a20 2020 2020 2020 2020 2020  axes.           
+0001ce40: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001ce50: 2020 2020 2020 2064 6961 676f 6e61 6c73         diagonals
+0001ce60: 2e61 7070 656e 6428 6178 6573 290a 2020  .append(axes).  
+0001ce70: 2020 2020 2020 7265 7475 726e 2074 7570        return tup
+0001ce80: 6c65 2864 6961 676f 6e61 6c73 290a 0a20  le(diagonals).. 
+0001ce90: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+0001cea0: 2064 6566 205f 696e 666c 6174 696f 6e73   def _inflations
+0001ceb0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001cec0: 7265 7475 726e 2074 7570 6c65 2828 6178  return tuple((ax
+0001ced0: 6973 2c20 7479 7065 732e 6672 6f7a 656e  is, types.frozen
+0001cee0: 6469 6374 2828 646f 666d 6170 2c20 4469  dict((dofmap, Di
+0001cef0: 6167 6f6e 616c 697a 6528 6675 6e63 2929  agonalize(func))
+0001cf00: 2066 6f72 2064 6f66 6d61 702c 2066 756e   for dofmap, fun
+0001cf10: 6320 696e 2070 6172 7473 2e69 7465 6d73  c in parts.items
+0001cf20: 2829 2929 0a20 2020 2020 2020 2020 2020  ())).           
+0001cf30: 2020 2020 2020 2020 2020 666f 7220 6178            for ax
+0001cf40: 6973 2c20 7061 7274 7320 696e 2073 656c  is, parts in sel
+0001cf50: 662e 6675 6e63 2e5f 696e 666c 6174 696f  f.func._inflatio
+0001cf60: 6e73 0a20 2020 2020 2020 2020 2020 2020  ns.             
+0001cf70: 2020 2020 2020 2020 6966 2061 7869 7320          if axis 
+0001cf80: 3c20 7365 6c66 2e6e 6469 6d2d 3229 0a0a  < self.ndim-2)..
+0001cf90: 2020 2020 6465 6620 5f73 696d 706c 6966      def _simplif
+0001cfa0: 6965 6428 7365 6c66 293a 0a20 2020 2020  ied(self):.     
+0001cfb0: 2020 2069 6620 7365 6c66 2e73 6861 7065     if self.shape
+0001cfc0: 5b2d 315d 203d 3d20 313a 0a20 2020 2020  [-1] == 1:.     
+0001cfd0: 2020 2020 2020 2072 6574 7572 6e20 496e         return In
+0001cfe0: 7365 7274 4178 6973 2873 656c 662e 6675  sertAxis(self.fu
+0001cff0: 6e63 2c20 3129 0a20 2020 2020 2020 2072  nc, 1).        r
+0001d000: 6574 7572 6e20 7365 6c66 2e66 756e 632e  eturn self.func.
+0001d010: 5f64 6961 676f 6e61 6c69 7a65 2873 656c  _diagonalize(sel
+0001d020: 662e 6e64 696d 2d32 290a 0a20 2020 2040  f.ndim-2)..    @
+0001d030: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
+0001d040: 2064 6566 2065 7661 6c66 2861 7272 293a   def evalf(arr):
+0001d050: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
+0001d060: 3d20 6e75 6d70 792e 7a65 726f 7328 6172  = numpy.zeros(ar
+0001d070: 722e 7368 6170 652b 2861 7272 2e73 6861  r.shape+(arr.sha
+0001d080: 7065 5b2d 315d 2c29 2c20 6474 7970 653d  pe[-1],), dtype=
+0001d090: 6172 722e 6474 7970 652c 206f 7264 6572  arr.dtype, order
+0001d0a0: 3d27 4627 290a 2020 2020 2020 2020 6469  ='F').        di
+0001d0b0: 6167 203d 206e 756d 7079 2e63 6f72 652e  ag = numpy.core.
+0001d0c0: 6d75 6c74 6961 7272 6179 2e63 5f65 696e  multiarray.c_ein
+0001d0d0: 7375 6d28 272e 2e2e 6969 2d3e 2e2e 2e69  sum('...ii->...i
+0001d0e0: 272c 2072 6573 756c 7429 0a20 2020 2020  ', result).     
+0001d0f0: 2020 2064 6961 675b 3a5d 203d 2061 7272     diag[:] = arr
+0001d100: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001d110: 7265 7375 6c74 0a0a 2020 2020 6465 6620  result..    def 
+0001d120: 5f64 6572 6976 6174 6976 6528 7365 6c66  _derivative(self
+0001d130: 2c20 7661 722c 2073 6565 6e29 3a0a 2020  , var, seen):.  
+0001d140: 2020 2020 2020 7265 7475 726e 2064 6961        return dia
+0001d150: 676f 6e61 6c69 7a65 2864 6572 6976 6174  gonalize(derivat
+0001d160: 6976 6528 7365 6c66 2e66 756e 632c 2076  ive(self.func, v
+0001d170: 6172 2c20 7365 656e 292c 2073 656c 662e  ar, seen), self.
+0001d180: 6e64 696d 2d32 2c20 7365 6c66 2e6e 6469  ndim-2, self.ndi
+0001d190: 6d2d 3129 0a0a 2020 2020 6465 6620 5f69  m-1)..    def _i
+0001d1a0: 6e76 6572 7365 2873 656c 662c 2061 7869  nverse(self, axi
+0001d1b0: 7331 2c20 6178 6973 3229 3a0a 2020 2020  s1, axis2):.    
+0001d1c0: 2020 2020 6966 2073 6f72 7465 6428 5b61      if sorted([a
+0001d1d0: 7869 7331 2c20 6178 6973 325d 2920 3d3d  xis1, axis2]) ==
+0001d1e0: 205b 7365 6c66 2e6e 6469 6d2d 322c 2073   [self.ndim-2, s
+0001d1f0: 656c 662e 6e64 696d 2d31 5d3a 0a20 2020  elf.ndim-1]:.   
+0001d200: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001d210: 4469 6167 6f6e 616c 697a 6528 7265 6369  Diagonalize(reci
+0001d220: 7072 6f63 616c 2873 656c 662e 6675 6e63  procal(self.func
+0001d230: 2929 0a0a 2020 2020 6465 6620 5f64 6574  ))..    def _det
+0001d240: 6572 6d69 6e61 6e74 2873 656c 662c 2061  erminant(self, a
+0001d250: 7869 7331 2c20 6178 6973 3229 3a0a 2020  xis1, axis2):.  
+0001d260: 2020 2020 2020 6966 2073 6f72 7465 6428        if sorted(
+0001d270: 5b61 7869 7331 2c20 6178 6973 325d 2920  [axis1, axis2]) 
+0001d280: 3d3d 205b 7365 6c66 2e6e 6469 6d2d 322c  == [self.ndim-2,
+0001d290: 2073 656c 662e 6e64 696d 2d31 5d3a 0a20   self.ndim-1]:. 
+0001d2a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001d2b0: 6e20 5072 6f64 7563 7428 7365 6c66 2e66  n Product(self.f
+0001d2c0: 756e 6329 0a20 2020 2020 2020 2065 6c69  unc).        eli
+0001d2d0: 6620 6178 6973 3120 3c20 7365 6c66 2e6e  f axis1 < self.n
+0001d2e0: 6469 6d2d 3220 616e 6420 6178 6973 3220  dim-2 and axis2 
+0001d2f0: 3c20 7365 6c66 2e6e 6469 6d2d 323a 0a20  < self.ndim-2:. 
+0001d300: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001d310: 6e20 4469 6167 6f6e 616c 697a 6528 6465  n Diagonalize(de
+0001d320: 7465 726d 696e 616e 7428 7365 6c66 2e66  terminant(self.f
+0001d330: 756e 632c 2028 6178 6973 312c 2061 7869  unc, (axis1, axi
+0001d340: 7332 2929 290a 0a20 2020 2064 6566 205f  s2)))..    def _
+0001d350: 7375 6d28 7365 6c66 2c20 6178 6973 293a  sum(self, axis):
+0001d360: 0a20 2020 2020 2020 2069 6620 6178 6973  .        if axis
+0001d370: 203e 3d20 7365 6c66 2e6e 6469 6d20 2d20   >= self.ndim - 
+0001d380: 323a 0a20 2020 2020 2020 2020 2020 2072  2:.            r
+0001d390: 6574 7572 6e20 7365 6c66 2e66 756e 630a  eturn self.func.
+0001d3a0: 2020 2020 2020 2020 7265 7475 726e 2044          return D
+0001d3b0: 6961 676f 6e61 6c69 7a65 2873 756d 2873  iagonalize(sum(s
+0001d3c0: 656c 662e 6675 6e63 2c20 6178 6973 2929  elf.func, axis))
+0001d3d0: 0a0a 2020 2020 6465 6620 5f74 616b 6564  ..    def _taked
+0001d3e0: 6961 6728 7365 6c66 2c20 6178 6973 312c  iag(self, axis1,
+0001d3f0: 2061 7869 7332 293a 0a20 2020 2020 2020   axis2):.       
+0001d400: 2069 6620 6178 6973 3120 3d3d 2073 656c   if axis1 == sel
+0001d410: 662e 6e64 696d 2d32 3a20 2023 2061 7869  f.ndim-2:  # axi
+0001d420: 7332 203d 3d20 7365 6c66 2e6e 6469 6d2d  s2 == self.ndim-
+0001d430: 310a 2020 2020 2020 2020 2020 2020 7265  1.            re
+0001d440: 7475 726e 2073 656c 662e 6675 6e63 0a20  turn self.func. 
+0001d450: 2020 2020 2020 2065 6c69 6620 6178 6973         elif axis
+0001d460: 3220 3e3d 2073 656c 662e 6e64 696d 2d32  2 >= self.ndim-2
+0001d470: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0001d480: 7475 726e 2064 6961 676f 6e61 6c69 7a65  turn diagonalize
+0001d490: 285f 7461 6b65 6469 6167 2873 656c 662e  (_takediag(self.
+0001d4a0: 6675 6e63 2c20 6178 6973 312c 2073 656c  func, axis1, sel
+0001d4b0: 662e 6e64 696d 2d32 292c 2073 656c 662e  f.ndim-2), self.
+0001d4c0: 6e64 696d 2d33 2c20 7365 6c66 2e6e 6469  ndim-3, self.ndi
+0001d4d0: 6d2d 3229 0a20 2020 2020 2020 2065 6c73  m-2).        els
+0001d4e0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0001d4f0: 6574 7572 6e20 6469 6167 6f6e 616c 697a  eturn diagonaliz
+0001d500: 6528 5f74 616b 6564 6961 6728 7365 6c66  e(_takediag(self
+0001d510: 2e66 756e 632c 2061 7869 7331 2c20 6178  .func, axis1, ax
+0001d520: 6973 3229 2c20 7365 6c66 2e6e 6469 6d2d  is2), self.ndim-
+0001d530: 342c 2073 656c 662e 6e64 696d 2d33 290a  4, self.ndim-3).
+0001d540: 0a20 2020 2064 6566 205f 7461 6b65 2873  .    def _take(s
+0001d550: 656c 662c 2069 6e64 6578 2c20 6178 6973  elf, index, axis
+0001d560: 293a 0a20 2020 2020 2020 2069 6620 6178  ):.        if ax
+0001d570: 6973 203c 2073 656c 662e 6e64 696d 202d  is < self.ndim -
+0001d580: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
+0001d590: 7265 7475 726e 2044 6961 676f 6e61 6c69  return Diagonali
+0001d5a0: 7a65 285f 7461 6b65 2873 656c 662e 6675  ze(_take(self.fu
+0001d5b0: 6e63 2c20 696e 6465 782c 2061 7869 7329  nc, index, axis)
+0001d5c0: 290a 2020 2020 2020 2020 6675 6e63 203d  ).        func =
+0001d5d0: 205f 7461 6b65 2873 656c 662e 6675 6e63   _take(self.func
+0001d5e0: 2c20 696e 6465 782c 2073 656c 662e 6e64  , index, self.nd
+0001d5f0: 696d 2d32 290a 2020 2020 2020 2020 666f  im-2).        fo
+0001d600: 7220 6920 696e 2072 616e 6765 2869 6e64  r i in range(ind
+0001d610: 6578 2e6e 6469 6d29 3a0a 2020 2020 2020  ex.ndim):.      
+0001d620: 2020 2020 2020 6675 6e63 203d 2064 6961        func = dia
+0001d630: 676f 6e61 6c69 7a65 2866 756e 632c 2073  gonalize(func, s
+0001d640: 656c 662e 6e64 696d 2d32 2b69 290a 2020  elf.ndim-2+i).  
+0001d650: 2020 2020 2020 7265 7475 726e 205f 696e        return _in
+0001d660: 666c 6174 6528 6675 6e63 2c20 696e 6465  flate(func, inde
+0001d670: 782c 2073 656c 662e 6675 6e63 2e73 6861  x, self.func.sha
+0001d680: 7065 5b2d 315d 2c20 7365 6c66 2e6e 6469  pe[-1], self.ndi
+0001d690: 6d2d 3220 6966 2061 7869 7320 3d3d 2073  m-2 if axis == s
+0001d6a0: 656c 662e 6e64 696d 2d31 2065 6c73 6520  elf.ndim-1 else 
+0001d6b0: 7365 6c66 2e6e 6469 6d2d 322b 696e 6465  self.ndim-2+inde
+0001d6c0: 782e 6e64 696d 290a 0a20 2020 2064 6566  x.ndim)..    def
+0001d6d0: 205f 756e 7261 7665 6c28 7365 6c66 2c20   _unravel(self, 
+0001d6e0: 6178 6973 2c20 7368 6170 6529 3a0a 2020  axis, shape):.  
+0001d6f0: 2020 2020 2020 6966 2061 7869 7320 3e3d        if axis >=
+0001d700: 2073 656c 662e 6e64 696d 202d 2032 3a0a   self.ndim - 2:.
+0001d710: 2020 2020 2020 2020 2020 2020 6469 6167              diag
+0001d720: 203d 2064 6961 676f 6e61 6c69 7a65 2864   = diagonalize(d
+0001d730: 6961 676f 6e61 6c69 7a65 2855 6e72 6176  iagonalize(Unrav
+0001d740: 656c 2873 656c 662e 6675 6e63 2c20 2a73  el(self.func, *s
+0001d750: 6861 7065 292c 2073 656c 662e 6e64 696d  hape), self.ndim
+0001d760: 2d32 2c20 7365 6c66 2e6e 6469 6d29 2c20  -2, self.ndim), 
+0001d770: 7365 6c66 2e6e 6469 6d2d 312c 2073 656c  self.ndim-1, sel
+0001d780: 662e 6e64 696d 2b31 290a 2020 2020 2020  f.ndim+1).      
+0001d790: 2020 2020 2020 7265 7475 726e 2072 6176        return rav
+0001d7a0: 656c 2864 6961 672c 2073 656c 662e 6e64  el(diag, self.nd
+0001d7b0: 696d 2069 6620 6178 6973 203d 3d20 7365  im if axis == se
+0001d7c0: 6c66 2e6e 6469 6d2d 3220 656c 7365 2073  lf.ndim-2 else s
+0001d7d0: 656c 662e 6e64 696d 2d32 290a 2020 2020  elf.ndim-2).    
+0001d7e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001d7f0: 2020 2020 2020 7265 7475 726e 2044 6961        return Dia
+0001d800: 676f 6e61 6c69 7a65 2875 6e72 6176 656c  gonalize(unravel
+0001d810: 2873 656c 662e 6675 6e63 2c20 6178 6973  (self.func, axis
+0001d820: 2c20 7368 6170 6529 290a 0a20 2020 2064  , shape))..    d
+0001d830: 6566 205f 7369 676e 2873 656c 6629 3a0a  ef _sign(self):.
+0001d840: 2020 2020 2020 2020 7265 7475 726e 2044          return D
+0001d850: 6961 676f 6e61 6c69 7a65 2853 6967 6e28  iagonalize(Sign(
+0001d860: 7365 6c66 2e66 756e 6329 290a 0a20 2020  self.func))..   
+0001d870: 2064 6566 205f 7072 6f64 7563 7428 7365   def _product(se
+0001d880: 6c66 293a 0a20 2020 2020 2020 2069 6620  lf):.        if 
+0001d890: 6e75 6d65 7269 632e 6973 696e 7428 7365  numeric.isint(se
+0001d8a0: 6c66 2e73 6861 7065 5b2d 315d 2920 616e  lf.shape[-1]) an
+0001d8b0: 6420 7365 6c66 2e73 6861 7065 5b2d 315d  d self.shape[-1]
+0001d8c0: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
+0001d8d0: 2020 7265 7475 726e 205a 6572 6f73 2873    return Zeros(s
+0001d8e0: 656c 662e 7368 6170 655b 3a2d 315d 2c20  elf.shape[:-1], 
+0001d8f0: 6474 7970 653d 7365 6c66 2e64 7479 7065  dtype=self.dtype
+0001d900: 290a 0a20 2020 2064 6566 205f 6c6f 6f70  )..    def _loop
+0001d910: 7375 6d28 7365 6c66 2c20 696e 6465 7829  sum(self, index)
+0001d920: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0001d930: 2044 6961 676f 6e61 6c69 7a65 286c 6f6f   Diagonalize(loo
+0001d940: 705f 7375 6d28 7365 6c66 2e66 756e 632c  p_sum(self.func,
+0001d950: 2069 6e64 6578 2929 0a0a 2020 2020 4063   index))..    @c
+0001d960: 6163 6865 645f 7072 6f70 6572 7479 0a20  ached_property. 
+0001d970: 2020 2064 6566 205f 6173 7370 6172 7365     def _assparse
+0001d980: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001d990: 7265 7475 726e 2074 7570 6c65 2828 2a69  return tuple((*i
+0001d9a0: 6e64 6963 6573 2c20 696e 6469 6365 735b  ndices, indices[
+0001d9b0: 2d31 5d2c 2076 616c 7565 7329 2066 6f72  -1], values) for
+0001d9c0: 202a 696e 6469 6365 732c 2076 616c 7565   *indices, value
+0001d9d0: 7320 696e 2073 656c 662e 6675 6e63 2e5f  s in self.func._
+0001d9e0: 6173 7370 6172 7365 290a 0a0a 636c 6173  assparse)...clas
+0001d9f0: 7320 4775 6172 6428 4172 7261 7929 3a0a  s Guard(Array):.
+0001da00: 2020 2020 2762 6172 2061 6c6c 2073 696d      'bar all sim
+0001da10: 706c 6966 6963 6174 696f 6e73 270a 0a20  plifications'.. 
+0001da20: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+0001da30: 7365 6c66 2c20 6675 6e3a 2041 7272 6179  self, fun: Array
+0001da40: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
+0001da50: 7420 6973 696e 7374 616e 6365 2866 756e  t isinstance(fun
+0001da60: 2c20 4172 7261 7929 2c20 6627 6675 6e3d  , Array), f'fun=
+0001da70: 7b66 756e 2172 7d27 0a20 2020 2020 2020  {fun!r}'.       
+0001da80: 2073 656c 662e 6675 6e20 3d20 6675 6e0a   self.fun = fun.
+0001da90: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+0001daa0: 5f5f 696e 6974 5f5f 2861 7267 733d 2866  __init__(args=(f
+0001dab0: 756e 2c29 2c20 7368 6170 653d 6675 6e2e  un,), shape=fun.
+0001dac0: 7368 6170 652c 2064 7479 7065 3d66 756e  shape, dtype=fun
+0001dad0: 2e64 7479 7065 290a 0a20 2020 2040 7072  .dtype)..    @pr
+0001dae0: 6f70 6572 7479 0a20 2020 2064 6566 2069  operty.    def i
+0001daf0: 7363 6f6e 7374 616e 7428 7365 6c66 293a  sconstant(self):
+0001db00: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001db10: 4661 6c73 6520 2023 2061 766f 6964 2073  False  # avoid s
+0001db20: 696d 706c 6966 6963 6174 696f 6e73 2062  implifications b
+0001db30: 6173 6564 206f 6e20 6675 6e20 6265 696e  ased on fun bein
+0001db40: 6720 636f 6e73 7461 6e74 0a0a 2020 2020  g constant..    
+0001db50: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+0001db60: 2020 6465 6620 6576 616c 6628 6461 7429    def evalf(dat)
+0001db70: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0001db80: 2064 6174 0a0a 2020 2020 6465 6620 5f64   dat..    def _d
+0001db90: 6572 6976 6174 6976 6528 7365 6c66 2c20  erivative(self, 
+0001dba0: 7661 722c 2073 6565 6e29 3a0a 2020 2020  var, seen):.    
+0001dbb0: 2020 2020 7265 7475 726e 2047 7561 7264      return Guard
+0001dbc0: 2864 6572 6976 6174 6976 6528 7365 6c66  (derivative(self
+0001dbd0: 2e66 756e 2c20 7661 722c 2073 6565 6e29  .fun, var, seen)
+0001dbe0: 290a 0a0a 636c 6173 7320 4669 6e64 2841  )...class Find(A
+0001dbf0: 7272 6179 293a 0a20 2020 2027 696e 6469  rray):.    'indi
+0001dc00: 6365 7320 6f66 2062 6f6f 6c65 616e 2069  ces of boolean i
+0001dc10: 6e64 6578 2076 6563 746f 7227 0a0a 2020  ndex vector'..  
+0001dc20: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+0001dc30: 656c 662c 2077 6865 7265 3a20 4172 7261  elf, where: Arra
+0001dc40: 7929 3a0a 2020 2020 2020 2020 6173 7365  y):.        asse
+0001dc50: 7274 2069 7361 7272 6179 2877 6865 7265  rt isarray(where
+0001dc60: 2920 616e 6420 7768 6572 652e 6e64 696d  ) and where.ndim
+0001dc70: 203d 3d20 3120 616e 6420 7768 6572 652e   == 1 and where.
+0001dc80: 6474 7970 6520 3d3d 2062 6f6f 6c0a 2020  dtype == bool.  
+0001dc90: 2020 2020 2020 7365 6c66 2e77 6865 7265        self.where
+0001dca0: 203d 2077 6865 7265 0a20 2020 2020 2020   = where.       
+0001dcb0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+0001dcc0: 5f28 6172 6773 3d28 7768 6572 652c 292c  _(args=(where,),
+0001dcd0: 2073 6861 7065 3d28 5375 6d28 426f 6f6c   shape=(Sum(Bool
+0001dce0: 546f 496e 7428 7768 6572 6529 292c 292c  ToInt(where)),),
+0001dcf0: 2064 7479 7065 3d69 6e74 290a 0a20 2020   dtype=int)..   
+0001dd00: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+0001dd10: 2020 2064 6566 2065 7661 6c66 2877 6865     def evalf(whe
+0001dd20: 7265 293a 0a20 2020 2020 2020 2072 6574  re):.        ret
+0001dd30: 7572 6e20 7768 6572 652e 6e6f 6e7a 6572  urn where.nonzer
+0001dd40: 6f28 295b 305d 0a0a 2020 2020 6465 6620  o()[0]..    def 
+0001dd50: 5f73 696d 706c 6966 6965 6428 7365 6c66  _simplified(self
+0001dd60: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
+0001dd70: 6c66 2e69 7363 6f6e 7374 616e 743a 0a20  lf.isconstant:. 
+0001dd80: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001dd90: 6e20 636f 6e73 7461 6e74 2873 656c 662e  n constant(self.
+0001dda0: 6576 616c 2829 290a 0a0a 636c 6173 7320  eval())...class 
+0001ddb0: 4465 7269 7661 7469 7665 5461 7267 6574  DerivativeTarget
+0001ddc0: 4261 7365 2841 7272 6179 293a 0a20 2020  Base(Array):.   
+0001ddd0: 2027 6261 7365 2063 6c61 7373 2066 6f72   'base class for
+0001dde0: 2064 6572 6976 6174 6976 6520 7461 7267   derivative targ
+0001ddf0: 6574 7327 0a0a 2020 2020 4070 726f 7065  ets'..    @prope
+0001de00: 7274 790a 2020 2020 6465 6620 6973 636f  rty.    def isco
+0001de10: 6e73 7461 6e74 2873 656c 6629 3a0a 2020  nstant(self):.  
+0001de20: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+0001de30: 7365 0a0a 0a63 6c61 7373 2057 6974 6844  se...class WithD
+0001de40: 6572 6976 6174 6976 6528 4172 7261 7929  erivative(Array)
+0001de50: 3a0a 2020 2020 2727 2757 7261 7020 7468  :.    '''Wrap th
+0001de60: 6520 6769 7665 6e20 6675 6e63 7469 6f6e  e given function
+0001de70: 2061 6e64 2064 6566 696e 6520 7468 6520   and define the 
+0001de80: 6465 7269 7661 7469 7665 2074 6f20 6120  derivative to a 
+0001de90: 7461 7267 6574 2e0a 0a20 2020 2054 6865  target...    The
+0001dea0: 2077 7261 7070 6572 2069 7320 7479 7069   wrapper is typi
+0001deb0: 6361 6c6c 7920 7573 6564 2074 6f67 6574  cally used toget
+0001dec0: 6865 7220 7769 7468 2061 2076 6972 7475  her with a virtu
+0001ded0: 616c 2064 6572 6976 6174 6976 6520 7461  al derivative ta
+0001dee0: 7267 6574 206c 696b 650a 2020 2020 3a63  rget like.    :c
+0001def0: 6c61 7373 3a60 4964 656e 7469 6669 6572  lass:`Identifier
+0001df00: 4465 7269 7661 7469 7665 5461 7267 6574  DerivativeTarget
+0001df10: 602e 2054 6865 2077 7261 7070 6572 2069  `. The wrapper i
+0001df20: 7320 7265 6d6f 7665 6420 696e 2074 6865  s removed in the
+0001df30: 2073 696d 706c 6966 6965 640a 2020 2020   simplified.    
+0001df40: 666f 726d 2e0a 0a20 2020 2050 6172 616d  form...    Param
+0001df50: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+0001df60: 2d2d 2d2d 0a20 2020 2066 756e 6320 3a20  ----.    func : 
+0001df70: 3a63 6c61 7373 3a60 4172 7261 7960 0a20  :class:`Array`. 
+0001df80: 2020 2020 2020 2054 6865 2066 756e 6374         The funct
+0001df90: 696f 6e20 746f 2077 7261 702e 0a20 2020  ion to wrap..   
+0001dfa0: 2076 6172 203a 203a 636c 6173 733a 6044   var : :class:`D
+0001dfb0: 6572 6976 6174 6976 6554 6172 6765 7442  erivativeTargetB
+0001dfc0: 6173 6560 0a20 2020 2020 2020 2054 6865  ase`.        The
+0001dfd0: 2064 6572 6976 6174 6976 6520 7461 7267   derivative targ
+0001dfe0: 6574 2e0a 2020 2020 6465 7269 7661 7469  et..    derivati
+0001dff0: 7665 203a 203a 636c 6173 733a 6041 7272  ve : :class:`Arr
+0001e000: 6179 600a 2020 2020 2020 2020 5468 6520  ay`.        The 
+0001e010: 6465 7269 7661 7469 7665 2077 6974 6820  derivative with 
+0001e020: 7368 6170 6520 6060 6675 6e63 2e73 6861  shape ``func.sha
+0001e030: 7065 202b 2076 6172 2e73 6861 7065 6060  pe + var.shape``
+0001e040: 2e0a 0a20 2020 2053 6565 2041 6c73 6f0a  ...    See Also.
+0001e050: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+0001e060: 203a 636c 6173 733a 6049 6465 6e74 6966   :class:`Identif
+0001e070: 6965 7244 6572 6976 6174 6976 6554 6172  ierDerivativeTar
+0001e080: 6765 7460 203a 2061 2076 6972 7475 616c  get` : a virtual
+0001e090: 2064 6572 6976 6174 6976 6520 7461 7267   derivative targ
+0001e0a0: 6574 0a20 2020 2027 2727 0a0a 2020 2020  et.    '''..    
+0001e0b0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+0001e0c0: 662c 2066 756e 633a 2041 7272 6179 2c20  f, func: Array, 
+0001e0d0: 7661 723a 2044 6572 6976 6174 6976 6554  var: DerivativeT
+0001e0e0: 6172 6765 7442 6173 652c 2064 6572 6976  argetBase, deriv
+0001e0f0: 6174 6976 653a 2041 7272 6179 2920 2d3e  ative: Array) ->
+0001e100: 204e 6f6e 653a 0a20 2020 2020 2020 2073   None:.        s
+0001e110: 656c 662e 5f66 756e 6320 3d20 6675 6e63  elf._func = func
+0001e120: 0a20 2020 2020 2020 2073 656c 662e 5f76  .        self._v
+0001e130: 6172 203d 2076 6172 0a20 2020 2020 2020  ar = var.       
+0001e140: 2073 656c 662e 5f64 6572 6976 203d 2064   self._deriv = d
+0001e150: 6572 6976 6174 6976 650a 2020 2020 2020  erivative.      
+0001e160: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+0001e170: 5f5f 2861 7267 733d 2866 756e 632c 292c  __(args=(func,),
+0001e180: 2073 6861 7065 3d66 756e 632e 7368 6170   shape=func.shap
+0001e190: 652c 2064 7479 7065 3d66 756e 632e 6474  e, dtype=func.dt
+0001e1a0: 7970 6529 0a0a 2020 2020 4070 726f 7065  ype)..    @prope
+0001e1b0: 7274 790a 2020 2020 6465 6620 6172 6775  rty.    def argu
+0001e1c0: 6d65 6e74 7328 7365 6c66 293a 0a20 2020  ments(self):.   
+0001e1d0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0001e1e0: 2e5f 6675 6e63 2e61 7267 756d 656e 7473  ._func.arguments
+0001e1f0: 207c 207b 7365 6c66 2e5f 7661 727d 0a0a   | {self._var}..
+0001e200: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+0001e210: 640a 2020 2020 6465 6620 6576 616c 6628  d.    def evalf(
+0001e220: 6675 6e63 3a20 6e75 6d70 792e 6e64 6172  func: numpy.ndar
+0001e230: 7261 7929 202d 3e20 6e75 6d70 792e 6e64  ray) -> numpy.nd
+0001e240: 6172 7261 793a 0a20 2020 2020 2020 2072  array:.        r
+0001e250: 6574 7572 6e20 6675 6e63 0a0a 2020 2020  eturn func..    
+0001e260: 6465 6620 5f64 6572 6976 6174 6976 6528  def _derivative(
+0001e270: 7365 6c66 2c20 7661 723a 2044 6572 6976  self, var: Deriv
+0001e280: 6174 6976 6554 6172 6765 7442 6173 652c  ativeTargetBase,
+0001e290: 2073 6565 6e29 202d 3e20 4172 7261 793a   seen) -> Array:
+0001e2a0: 0a20 2020 2020 2020 2069 6620 7661 7220  .        if var 
+0001e2b0: 3d3d 2073 656c 662e 5f76 6172 3a0a 2020  == self._var:.  
+0001e2c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001e2d0: 2073 656c 662e 5f64 6572 6976 0a20 2020   self._deriv.   
+0001e2e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001e2f0: 2020 2020 2020 2072 6574 7572 6e20 6465         return de
+0001e300: 7269 7661 7469 7665 2873 656c 662e 5f66  rivative(self._f
+0001e310: 756e 632c 2076 6172 2c20 7365 656e 290a  unc, var, seen).
+0001e320: 0a20 2020 2064 6566 205f 7369 6d70 6c69  .    def _simpli
+0001e330: 6669 6564 2873 656c 6629 202d 3e20 4172  fied(self) -> Ar
+0001e340: 7261 793a 0a20 2020 2020 2020 2072 6574  ray:.        ret
+0001e350: 7572 6e20 7365 6c66 2e5f 6675 6e63 0a0a  urn self._func..
+0001e360: 0a63 6c61 7373 2041 7267 756d 656e 7428  .class Argument(
+0001e370: 4465 7269 7661 7469 7665 5461 7267 6574  DerivativeTarget
+0001e380: 4261 7365 293a 0a20 2020 2027 2727 4172  Base):.    '''Ar
+0001e390: 7261 7920 6172 6775 6d65 6e74 2c20 746f  ray argument, to
+0001e3a0: 2062 6520 7375 6273 7469 7475 7465 6420   be substituted 
+0001e3b0: 6265 666f 7265 2065 7661 6c75 6174 696f  before evaluatio
+0001e3c0: 6e2e 0a0a 2020 2020 5468 6520 3a63 6c61  n...    The :cla
+0001e3d0: 7373 3a60 4172 6775 6d65 6e74 6020 6973  ss:`Argument` is
+0001e3e0: 2061 6e20 3a63 6c61 7373 3a60 4172 7261   an :class:`Arra
+0001e3f0: 7960 2077 6974 6820 6120 6b6e 6f77 6e20  y` with a known 
+0001e400: 7368 6170 652c 2062 7574 2077 686f 7365  shape, but whose
+0001e410: 0a20 2020 2076 616c 7565 7320 6172 6520  .    values are 
+0001e420: 746f 2062 6520 6465 6669 6e65 6420 6c61  to be defined la
+0001e430: 7465 722c 2062 6566 6f72 6520 6576 616c  ter, before eval
+0001e440: 7561 7469 6f6e 2c20 652e 672e 2075 7369  uation, e.g. usi
+0001e450: 6e67 0a20 2020 203a 6675 6e63 3a60 7265  ng.    :func:`re
+0001e460: 706c 6163 655f 6172 6775 6d65 6e74 7360  place_arguments`
+0001e470: 2e0a 0a20 2020 2049 7420 6973 2070 6f73  ...    It is pos
+0001e480: 7369 626c 6520 746f 2074 616b 6520 7468  sible to take th
+0001e490: 6520 6465 7269 7661 7469 7665 206f 6620  e derivative of 
+0001e4a0: 616e 203a 636c 6173 733a 6041 7272 6179  an :class:`Array
+0001e4b0: 6020 746f 2061 6e0a 2020 2020 3a63 6c61  ` to an.    :cla
+0001e4c0: 7373 3a60 4172 6775 6d65 6e74 603a 0a0a  ss:`Argument`:..
+0001e4d0: 2020 2020 3e3e 3e20 6672 6f6d 206e 7574      >>> from nut
+0001e4e0: 696c 7320 696d 706f 7274 2065 7661 6c75  ils import evalu
+0001e4f0: 6162 6c65 0a20 2020 203e 3e3e 2061 203d  able.    >>> a =
+0001e500: 2065 7661 6c75 6162 6c65 2e41 7267 756d   evaluable.Argum
+0001e510: 656e 7428 2778 272c 2028 2929 0a20 2020  ent('x', ()).   
+0001e520: 203e 3e3e 2062 203d 2065 7661 6c75 6162   >>> b = evaluab
+0001e530: 6c65 2e41 7267 756d 656e 7428 2779 272c  le.Argument('y',
+0001e540: 2028 2929 0a20 2020 203e 3e3e 2066 203d   ()).    >>> f =
+0001e550: 2061 2a2a 3320 2b20 622a 2a32 0a20 2020   a**3 + b**2.   
+0001e560: 203e 3e3e 2065 7661 6c75 6162 6c65 2e64   >>> evaluable.d
+0001e570: 6572 6976 6174 6976 6528 662c 2062 292e  erivative(f, b).
+0001e580: 7369 6d70 6c69 6669 6564 203d 3d20 322e  simplified == 2.
+0001e590: 2a62 0a20 2020 2054 7275 650a 0a20 2020  *b.    True..   
+0001e5a0: 2041 7267 730a 2020 2020 2d2d 2d2d 0a20   Args.    ----. 
+0001e5b0: 2020 206e 616d 6520 3a20 3a63 6c61 7373     name : :class
+0001e5c0: 3a60 7374 7260 0a20 2020 2020 2020 2054  :`str`.        T
+0001e5d0: 6865 2049 6465 6e74 6966 6965 7220 6f66  he Identifier of
+0001e5e0: 2074 6869 7320 6172 6775 6d65 6e74 2e0a   this argument..
+0001e5f0: 2020 2020 7368 6170 6520 3a20 3a63 6c61      shape : :cla
+0001e600: 7373 3a60 7475 706c 6560 206f 6620 3a63  ss:`tuple` of :c
+0001e610: 6c61 7373 3a60 696e 7460 5c5c 730a 2020  lass:`int`\\s.  
+0001e620: 2020 2020 2020 5468 6520 7368 6170 6520        The shape 
+0001e630: 6f66 2074 6869 7320 6172 6775 6d65 6e74  of this argument
+0001e640: 2e0a 2020 2020 2727 270a 0a20 2020 2064  ..    '''..    d
+0001e650: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+0001e660: 2c20 6e61 6d65 3a20 7374 722c 2073 6861  , name: str, sha
+0001e670: 7065 3a20 7479 7069 6e67 2e54 7570 6c65  pe: typing.Tuple
+0001e680: 5b41 7272 6179 2c20 2e2e 2e5d 2c20 6474  [Array, ...], dt
+0001e690: 7970 653a 2044 7479 7065 203d 2066 6c6f  ype: Dtype = flo
+0001e6a0: 6174 293a 0a20 2020 2020 2020 2061 7373  at):.        ass
+0001e6b0: 6572 7420 6973 696e 7374 616e 6365 286e  ert isinstance(n
+0001e6c0: 616d 652c 2073 7472 292c 2066 276e 616d  ame, str), f'nam
+0001e6d0: 653d 7b6e 616d 6521 727d 270a 2020 2020  e={name!r}'.    
+0001e6e0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0001e6f0: 7461 6e63 6528 7368 6170 652c 2074 7570  tance(shape, tup
+0001e700: 6c65 2920 616e 6420 616c 6c28 5f69 7369  le) and all(_isi
+0001e710: 6e64 6578 286e 2920 666f 7220 6e20 696e  ndex(n) for n in
+0001e720: 2073 6861 7065 292c 2066 2773 6861 7065   shape), f'shape
+0001e730: 3d7b 7368 6170 6521 727d 270a 2020 2020  ={shape!r}'.    
+0001e740: 2020 2020 7365 6c66 2e5f 6e61 6d65 203d      self._name =
+0001e750: 206e 616d 650a 2020 2020 2020 2020 7375   name.        su
+0001e760: 7065 7228 292e 5f5f 696e 6974 5f5f 2861  per().__init__(a
+0001e770: 7267 733d 2845 5641 4c41 5247 532c 202a  rgs=(EVALARGS, *
+0001e780: 7368 6170 6529 2c20 7368 6170 653d 7368  shape), shape=sh
+0001e790: 6170 652c 2064 7479 7065 3d64 7479 7065  ape, dtype=dtype
+0001e7a0: 290a 0a20 2020 2064 6566 2065 7661 6c66  )..    def evalf
+0001e7b0: 2873 656c 662c 2065 7661 6c61 7267 732c  (self, evalargs,
+0001e7c0: 202a 7368 6170 6529 3a0a 2020 2020 2020   *shape):.      
+0001e7d0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0001e7e0: 2020 2076 616c 7565 203d 2065 7661 6c61     value = evala
+0001e7f0: 7267 735b 7365 6c66 2e5f 6e61 6d65 5d0a  rgs[self._name].
+0001e800: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+0001e810: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+0001e820: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+0001e830: 4572 726f 7228 6627 6172 6775 6d65 6e74  Error(f'argument
+0001e840: 207b 7365 6c66 2e5f 6e61 6d65 2172 7d20   {self._name!r} 
+0001e850: 6d69 7373 696e 6727 290a 2020 2020 2020  missing').      
+0001e860: 2020 7661 6c75 6520 3d20 6e75 6d70 792e    value = numpy.
+0001e870: 6173 6172 7261 7928 7661 6c75 6529 0a20  asarray(value). 
+0001e880: 2020 2020 2020 2069 6620 7661 6c75 652e         if value.
+0001e890: 7368 6170 6520 213d 2073 6861 7065 3a0a  shape != shape:.
+0001e8a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001e8b0: 6520 5661 6c75 6545 7272 6f72 2866 2761  e ValueError(f'a
+0001e8c0: 7267 756d 656e 7420 7b73 656c 662e 5f6e  rgument {self._n
+0001e8d0: 616d 6521 727d 2068 6173 2074 6865 2077  ame!r} has the w
+0001e8e0: 726f 6e67 2073 6861 7065 3a20 6578 7065  rong shape: expe
+0001e8f0: 6374 6564 207b 7368 6170 657d 2c20 676f  cted {shape}, go
+0001e900: 7420 7b76 616c 7565 2e73 6861 7065 7d27  t {value.shape}'
+0001e910: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0001e920: 2076 616c 7565 2e61 7374 7970 6528 7365   value.astype(se
+0001e930: 6c66 2e64 7479 7065 2c20 6361 7374 696e  lf.dtype, castin
+0001e940: 673d 2773 6166 6527 2c20 636f 7079 3d46  g='safe', copy=F
+0001e950: 616c 7365 290a 0a20 2020 2064 6566 205f  alse)..    def _
+0001e960: 6465 7269 7661 7469 7665 2873 656c 662c  derivative(self,
+0001e970: 2076 6172 2c20 7365 656e 293a 0a20 2020   var, seen):.   
+0001e980: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0001e990: 6365 2876 6172 2c20 4172 6775 6d65 6e74  ce(var, Argument
+0001e9a0: 2920 616e 6420 7661 722e 5f6e 616d 6520  ) and var._name 
+0001e9b0: 3d3d 2073 656c 662e 5f6e 616d 6520 616e  == self._name an
+0001e9c0: 6420 7365 6c66 2e64 7479 7065 2069 6e20  d self.dtype in 
+0001e9d0: 2866 6c6f 6174 2c20 636f 6d70 6c65 7829  (float, complex)
+0001e9e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0001e9f0: 7375 6c74 203d 206f 6e65 7328 7365 6c66  sult = ones(self
+0001ea00: 2e73 6861 7065 2c20 7365 6c66 2e64 7479  .shape, self.dty
+0001ea10: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
+0001ea20: 666f 7220 692c 2073 6820 696e 2065 6e75  for i, sh in enu
+0001ea30: 6d65 7261 7465 2873 656c 662e 7368 6170  merate(self.shap
+0001ea40: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0001ea50: 2020 2020 7265 7375 6c74 203d 2064 6961      result = dia
+0001ea60: 676f 6e61 6c69 7a65 2872 6573 756c 742c  gonalize(result,
+0001ea70: 2069 2c20 692b 7365 6c66 2e6e 6469 6d29   i, i+self.ndim)
+0001ea80: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001ea90: 7572 6e20 7265 7375 6c74 0a20 2020 2020  urn result.     
+0001eaa0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001eab0: 2020 2020 2072 6574 7572 6e20 7a65 726f       return zero
+0001eac0: 7328 7365 6c66 2e73 6861 7065 2b76 6172  s(self.shape+var
+0001ead0: 2e73 6861 7065 290a 0a20 2020 2064 6566  .shape)..    def
+0001eae0: 205f 5f73 7472 5f5f 2873 656c 6629 3a0a   __str__(self):.
+0001eaf0: 2020 2020 2020 2020 7265 7475 726e 2027          return '
+0001eb00: 7b7d 207b 2172 7d20 3c7b 7d3e 272e 666f  {} {!r} <{}>'.fo
+0001eb10: 726d 6174 2873 656c 662e 5f5f 636c 6173  rmat(self.__clas
+0001eb20: 735f 5f2e 5f5f 6e61 6d65 5f5f 2c20 7365  s__.__name__, se
+0001eb30: 6c66 2e5f 6e61 6d65 2c20 7365 6c66 2e5f  lf._name, self._
+0001eb40: 7368 6170 655f 7374 7228 666f 726d 3d73  shape_str(form=s
+0001eb50: 7472 2929 0a0a 2020 2020 6465 6620 5f6e  tr))..    def _n
+0001eb60: 6f64 6528 7365 6c66 2c20 6361 6368 652c  ode(self, cache,
+0001eb70: 2073 7562 6772 6170 682c 2074 696d 6573   subgraph, times
+0001eb80: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
+0001eb90: 6c66 2069 6e20 6361 6368 653a 0a20 2020  lf in cache:.   
+0001eba0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001ebb0: 6361 6368 655b 7365 6c66 5d0a 2020 2020  cache[self].    
+0001ebc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001ebd0: 2020 2020 2020 6c61 6265 6c20 3d20 275c        label = '\
+0001ebe0: 6e27 2e6a 6f69 6e28 6669 6c74 6572 284e  n'.join(filter(N
+0001ebf0: 6f6e 652c 2028 7479 7065 2873 656c 6629  one, (type(self)
+0001ec00: 2e5f 5f6e 616d 655f 5f2c 2073 656c 662e  .__name__, self.
+0001ec10: 5f6e 616d 652c 2073 656c 662e 5f73 6861  _name, self._sha
+0001ec20: 7065 5f73 7472 2866 6f72 6d3d 7265 7072  pe_str(form=repr
+0001ec30: 2929 2929 0a20 2020 2020 2020 2020 2020  )))).           
+0001ec40: 2063 6163 6865 5b73 656c 665d 203d 206e   cache[self] = n
+0001ec50: 6f64 6520 3d20 4475 706c 6963 6174 6564  ode = Duplicated
+0001ec60: 4c65 6166 4e6f 6465 286c 6162 656c 2c20  LeafNode(label, 
+0001ec70: 2874 7970 6528 7365 6c66 292e 5f5f 6e61  (type(self).__na
+0001ec80: 6d65 5f5f 2c20 7469 6d65 735b 7365 6c66  me__, times[self
+0001ec90: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
+0001eca0: 7265 7475 726e 206e 6f64 650a 0a20 2020  return node..   
+0001ecb0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+0001ecc0: 6566 2061 7267 756d 656e 7473 2873 656c  ef arguments(sel
+0001ecd0: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
+0001ece0: 726e 2066 726f 7a65 6e73 6574 287b 7365  rn frozenset({se
+0001ecf0: 6c66 7d29 0a0a 0a63 6c61 7373 2049 6465  lf})...class Ide
+0001ed00: 6e74 6966 6965 7244 6572 6976 6174 6976  ntifierDerivativ
+0001ed10: 6554 6172 6765 7428 4465 7269 7661 7469  eTarget(Derivati
+0001ed20: 7665 5461 7267 6574 4261 7365 293a 0a20  veTargetBase):. 
+0001ed30: 2020 2027 2727 5669 7274 7561 6c20 6465     '''Virtual de
+0001ed40: 7269 7661 7469 7665 2074 6172 6765 7420  rivative target 
+0001ed50: 6469 7374 696e 6775 6973 6865 6420 6279  distinguished by
+0001ed60: 2061 6e20 6964 656e 7469 6669 6572 2e0a   an identifier..
+0001ed70: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+0001ed80: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+0001ed90: 2020 2069 6465 6e74 6966 6965 7220 3a20     identifier : 
+0001eda0: 6861 7368 6162 6c65 203a 636c 6173 733a  hashable :class:
+0001edb0: 606f 626a 6563 7460 0a20 2020 2020 2020  `object`.       
+0001edc0: 2054 6865 2069 6465 6e74 6966 6965 7220   The identifier 
+0001edd0: 666f 7220 7468 6973 2064 6572 6976 6174  for this derivat
+0001ede0: 6976 6520 7461 7267 6574 2e0a 2020 2020  ive target..    
+0001edf0: 7368 6170 6520 3a20 3a63 6c61 7373 3a60  shape : :class:`
+0001ee00: 7475 706c 6560 206f 6620 3a63 6c61 7373  tuple` of :class
+0001ee10: 3a60 4172 7261 7960 206f 7220 3a63 6c61  :`Array` or :cla
+0001ee20: 7373 3a60 696e 7460 0a20 2020 2020 2020  ss:`int`.       
+0001ee30: 2054 6865 2073 6861 7065 206f 6620 7468   The shape of th
+0001ee40: 6973 2064 6572 6976 6174 6976 6520 7461  is derivative ta
+0001ee50: 7267 6574 2e0a 0a20 2020 2053 6565 2041  rget...    See A
+0001ee60: 6c73 6f0a 2020 2020 2d2d 2d2d 2d2d 2d2d  lso.    --------
+0001ee70: 0a20 2020 203a 636c 6173 733a 6057 6974  .    :class:`Wit
+0001ee80: 6844 6572 6976 6174 6976 6560 203a 203a  hDerivative` : :
+0001ee90: 636c 6173 733a 6041 7272 6179 6020 7772  class:`Array` wr
+0001eea0: 6170 7065 7220 7769 7468 2061 6464 6974  apper with addit
+0001eeb0: 696f 6e61 6c20 6465 7269 7661 7469 7665  ional derivative
+0001eec0: 0a20 2020 2027 2727 0a0a 2020 2020 6465  .    '''..    de
+0001eed0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+0001eee0: 2069 6465 6e74 6966 6965 722c 2073 6861   identifier, sha
+0001eef0: 7065 293a 0a20 2020 2020 2020 2073 656c  pe):.        sel
+0001ef00: 662e 6964 656e 7469 6669 6572 203d 2069  f.identifier = i
+0001ef10: 6465 6e74 6966 6965 720a 2020 2020 2020  dentifier.      
+0001ef20: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+0001ef30: 5f5f 2861 7267 733d 2829 2c20 7368 6170  __(args=(), shap
+0001ef40: 653d 7368 6170 652c 2064 7479 7065 3d66  e=shape, dtype=f
+0001ef50: 6c6f 6174 290a 0a20 2020 2064 6566 2065  loat)..    def e
+0001ef60: 7661 6c66 2873 656c 6629 3a0a 2020 2020  valf(self):.    
+0001ef70: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
+0001ef80: 696f 6e28 277b 7d20 6361 6e6e 6f74 2062  ion('{} cannot b
+0001ef90: 6520 6576 616c 7561 626c 6564 272e 666f  e evaluabled'.fo
+0001efa0: 726d 6174 2874 7970 6528 7365 6c66 292e  rmat(type(self).
+0001efb0: 5f5f 6e61 6d65 5f5f 2929 0a0a 0a63 6c61  __name__))...cla
+0001efc0: 7373 2052 6176 656c 2841 7272 6179 293a  ss Ravel(Array):
+0001efd0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+0001efe0: 5f5f 2873 656c 662c 2066 756e 633a 2041  __(self, func: A
+0001eff0: 7272 6179 293a 0a20 2020 2020 2020 2061  rray):.        a
+0001f000: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+0001f010: 2866 756e 632c 2041 7272 6179 2920 616e  (func, Array) an
+0001f020: 6420 6675 6e63 2e6e 6469 6d20 3e3d 2032  d func.ndim >= 2
+0001f030: 2c20 6627 6675 6e63 3d7b 6675 6e63 2172  , f'func={func!r
+0001f040: 7d27 0a20 2020 2020 2020 2073 656c 662e  }'.        self.
+0001f050: 6675 6e63 203d 2066 756e 630a 2020 2020  func = func.    
+0001f060: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+0001f070: 6974 5f5f 2861 7267 733d 2866 756e 632c  it__(args=(func,
+0001f080: 292c 2073 6861 7065 3d28 2a66 756e 632e  ), shape=(*func.
+0001f090: 7368 6170 655b 3a2d 325d 2c20 6675 6e63  shape[:-2], func
+0001f0a0: 2e73 6861 7065 5b2d 325d 202a 2066 756e  .shape[-2] * fun
+0001f0b0: 632e 7368 6170 655b 2d31 5d29 2c20 6474  c.shape[-1]), dt
+0001f0c0: 7970 653d 6675 6e63 2e64 7479 7065 290a  ype=func.dtype).
+0001f0d0: 0a20 2020 2040 6361 6368 6564 5f70 726f  .    @cached_pro
+0001f0e0: 7065 7274 790a 2020 2020 6465 6620 5f69  perty.    def _i
+0001f0f0: 6e66 6c61 7469 6f6e 7328 7365 6c66 293a  nflations(self):
+0001f100: 0a20 2020 2020 2020 2069 6e66 6c61 7469  .        inflati
+0001f110: 6f6e 7320 3d20 5b5d 0a20 2020 2020 2020  ons = [].       
+0001f120: 2073 7472 6964 6520 3d20 7365 6c66 2e66   stride = self.f
+0001f130: 756e 632e 7368 6170 655b 2d31 5d0a 2020  unc.shape[-1].  
+0001f140: 2020 2020 2020 6e20 3d20 4e6f 6e65 0a20        n = None. 
+0001f150: 2020 2020 2020 2066 6f72 2061 7869 732c         for axis,
+0001f160: 206f 6c64 5f70 6172 7473 2069 6e20 7365   old_parts in se
+0001f170: 6c66 2e66 756e 632e 5f69 6e66 6c61 7469  lf.func._inflati
+0001f180: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+0001f190: 2069 6620 6178 6973 203d 3d20 7365 6c66   if axis == self
+0001f1a0: 2e6e 6469 6d20 2d20 3120 616e 6420 6e20  .ndim - 1 and n 
+0001f1b0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0001f1c0: 2020 2020 2020 2020 206e 203d 2073 656c           n = sel
+0001f1d0: 662e 6675 6e63 2e73 6861 7065 5b2d 315d  f.func.shape[-1]
+0001f1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f1f0: 2069 6e66 6c61 7469 6f6e 732e 6170 7065   inflations.appe
+0001f200: 6e64 2828 7365 6c66 2e6e 6469 6d20 2d20  nd((self.ndim - 
+0001f210: 312c 2074 7970 6573 2e66 726f 7a65 6e64  1, types.frozend
+0001f220: 6963 7428 2852 6176 656c 496e 6465 7828  ict((RavelIndex(
+0001f230: 646f 666d 6170 2c20 5261 6e67 6528 6e29  dofmap, Range(n)
+0001f240: 2c20 2a73 656c 662e 6675 6e63 2e73 6861  , *self.func.sha
+0001f250: 7065 5b2d 323a 5d29 2c20 6675 6e63 2920  pe[-2:]), func) 
+0001f260: 666f 7220 646f 666d 6170 2c20 6675 6e63  for dofmap, func
+0001f270: 2069 6e20 6f6c 645f 7061 7274 732e 6974   in old_parts.it
+0001f280: 656d 7328 2929 2929 0a20 2020 2020 2020  ems()))).       
+0001f290: 2020 2020 2065 6c69 6620 6178 6973 203d       elif axis =
+0001f2a0: 3d20 7365 6c66 2e6e 6469 6d20 616e 6420  = self.ndim and 
+0001f2b0: 6e20 6973 204e 6f6e 653a 0a20 2020 2020  n is None:.     
+0001f2c0: 2020 2020 2020 2020 2020 206e 203d 2073             n = s
+0001f2d0: 656c 662e 6675 6e63 2e73 6861 7065 5b2d  elf.func.shape[-
+0001f2e0: 325d 0a20 2020 2020 2020 2020 2020 2020  2].             
+0001f2f0: 2020 2069 6e66 6c61 7469 6f6e 732e 6170     inflations.ap
+0001f300: 7065 6e64 2828 7365 6c66 2e6e 6469 6d20  pend((self.ndim 
+0001f310: 2d20 312c 2074 7970 6573 2e66 726f 7a65  - 1, types.froze
+0001f320: 6e64 6963 7428 2852 6176 656c 496e 6465  ndict((RavelInde
+0001f330: 7828 5261 6e67 6528 6e29 2c20 646f 666d  x(Range(n), dofm
+0001f340: 6170 2c20 2a73 656c 662e 6675 6e63 2e73  ap, *self.func.s
+0001f350: 6861 7065 5b2d 323a 5d29 2c20 6675 6e63  hape[-2:]), func
+0001f360: 2920 666f 7220 646f 666d 6170 2c20 6675  ) for dofmap, fu
+0001f370: 6e63 2069 6e20 6f6c 645f 7061 7274 732e  nc in old_parts.
+0001f380: 6974 656d 7328 2929 2929 0a20 2020 2020  items()))).     
+0001f390: 2020 2020 2020 2065 6c69 6620 6178 6973         elif axis
+0001f3a0: 203c 2073 656c 662e 6e64 696d 202d 2031   < self.ndim - 1
+0001f3b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001f3c0: 2020 696e 666c 6174 696f 6e73 2e61 7070    inflations.app
+0001f3d0: 656e 6428 2861 7869 732c 2074 7970 6573  end((axis, types
+0001f3e0: 2e66 726f 7a65 6e64 6963 7428 2864 6f66  .frozendict((dof
+0001f3f0: 6d61 702c 2052 6176 656c 2866 756e 6329  map, Ravel(func)
+0001f400: 2920 666f 7220 646f 666d 6170 2c20 6675  ) for dofmap, fu
+0001f410: 6e63 2069 6e20 6f6c 645f 7061 7274 732e  nc in old_parts.
+0001f420: 6974 656d 7328 2929 2929 0a20 2020 2020  items()))).     
+0001f430: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
+0001f440: 696e 666c 6174 696f 6e73 290a 0a20 2020  inflations)..   
+0001f450: 2064 6566 205f 7369 6d70 6c69 6669 6564   def _simplified
+0001f460: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001f470: 6966 205f 6571 7561 6c73 5f73 6361 6c61  if _equals_scala
+0001f480: 725f 636f 6e73 7461 6e74 2873 656c 662e  r_constant(self.
+0001f490: 6675 6e63 2e73 6861 7065 5b2d 325d 2c20  func.shape[-2], 
+0001f4a0: 3129 3a0a 2020 2020 2020 2020 2020 2020  1):.            
+0001f4b0: 7265 7475 726e 2067 6574 2873 656c 662e  return get(self.
+0001f4c0: 6675 6e63 2c20 2d32 2c20 636f 6e73 7461  func, -2, consta
+0001f4d0: 6e74 2830 2929 0a20 2020 2020 2020 2069  nt(0)).        i
+0001f4e0: 6620 5f65 7175 616c 735f 7363 616c 6172  f _equals_scalar
+0001f4f0: 5f63 6f6e 7374 616e 7428 7365 6c66 2e66  _constant(self.f
+0001f500: 756e 632e 7368 6170 655b 2d31 5d2c 2031  unc.shape[-1], 1
+0001f510: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0001f520: 6574 7572 6e20 6765 7428 7365 6c66 2e66  eturn get(self.f
+0001f530: 756e 632c 202d 312c 2063 6f6e 7374 616e  unc, -1, constan
+0001f540: 7428 3029 290a 2020 2020 2020 2020 7265  t(0)).        re
+0001f550: 7475 726e 2073 656c 662e 6675 6e63 2e5f  turn self.func._
+0001f560: 7261 7665 6c28 7365 6c66 2e6e 6469 6d2d  ravel(self.ndim-
+0001f570: 3129 0a0a 2020 2020 4073 7461 7469 636d  1)..    @staticm
+0001f580: 6574 686f 640a 2020 2020 6465 6620 6576  ethod.    def ev
+0001f590: 616c 6628 6629 3a0a 2020 2020 2020 2020  alf(f):.        
+0001f5a0: 7265 7475 726e 2066 2e72 6573 6861 7065  return f.reshape
+0001f5b0: 2866 2e73 6861 7065 5b3a 2d32 5d20 2b20  (f.shape[:-2] + 
+0001f5c0: 2866 2e73 6861 7065 5b2d 325d 2a66 2e73  (f.shape[-2]*f.s
+0001f5d0: 6861 7065 5b2d 315d 2c29 290a 0a20 2020  hape[-1],))..   
+0001f5e0: 2064 6566 205f 6d75 6c74 6970 6c79 2873   def _multiply(s
+0001f5f0: 656c 662c 206f 7468 6572 293a 0a20 2020  elf, other):.   
+0001f600: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0001f610: 6365 286f 7468 6572 2c20 5261 7665 6c29  ce(other, Ravel)
+0001f620: 2061 6e64 2065 7175 616c 7368 6170 6528   and equalshape(
+0001f630: 6f74 6865 722e 6675 6e63 2e73 6861 7065  other.func.shape
+0001f640: 5b2d 323a 5d2c 2073 656c 662e 6675 6e63  [-2:], self.func
+0001f650: 2e73 6861 7065 5b2d 323a 5d29 3a0a 2020  .shape[-2:]):.  
+0001f660: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001f670: 2052 6176 656c 286d 756c 7469 706c 7928   Ravel(multiply(
+0001f680: 7365 6c66 2e66 756e 632c 206f 7468 6572  self.func, other
+0001f690: 2e66 756e 6329 290a 2020 2020 2020 2020  .func)).        
+0001f6a0: 7265 7475 726e 2052 6176 656c 286d 756c  return Ravel(mul
+0001f6b0: 7469 706c 7928 7365 6c66 2e66 756e 632c  tiply(self.func,
+0001f6c0: 2055 6e72 6176 656c 286f 7468 6572 2c20   Unravel(other, 
+0001f6d0: 2a73 656c 662e 6675 6e63 2e73 6861 7065  *self.func.shape
+0001f6e0: 5b2d 323a 5d29 2929 0a0a 2020 2020 6465  [-2:])))..    de
+0001f6f0: 6620 5f61 6464 2873 656c 662c 206f 7468  f _add(self, oth
+0001f700: 6572 293a 0a20 2020 2020 2020 2072 6574  er):.        ret
+0001f710: 7572 6e20 5261 7665 6c28 7365 6c66 2e66  urn Ravel(self.f
+0001f720: 756e 6320 2b20 556e 7261 7665 6c28 6f74  unc + Unravel(ot
+0001f730: 6865 722c 202a 7365 6c66 2e66 756e 632e  her, *self.func.
+0001f740: 7368 6170 655b 2d32 3a5d 2929 0a0a 2020  shape[-2:]))..  
+0001f750: 2020 6465 6620 5f73 756d 2873 656c 662c    def _sum(self,
+0001f760: 2061 7869 7329 3a0a 2020 2020 2020 2020   axis):.        
+0001f770: 6966 2061 7869 7320 3d3d 2073 656c 662e  if axis == self.
+0001f780: 6e64 696d 2d31 3a0a 2020 2020 2020 2020  ndim-1:.        
+0001f790: 2020 2020 7265 7475 726e 2053 756d 2853      return Sum(S
+0001f7a0: 756d 2873 656c 662e 6675 6e63 2929 0a20  um(self.func)). 
+0001f7b0: 2020 2020 2020 2072 6574 7572 6e20 5261         return Ra
+0001f7c0: 7665 6c28 7375 6d28 7365 6c66 2e66 756e  vel(sum(self.fun
+0001f7d0: 632c 2061 7869 7329 290a 0a20 2020 2064  c, axis))..    d
+0001f7e0: 6566 205f 6465 7269 7661 7469 7665 2873  ef _derivative(s
+0001f7f0: 656c 662c 2076 6172 2c20 7365 656e 293a  elf, var, seen):
+0001f800: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001f810: 7261 7665 6c28 6465 7269 7661 7469 7665  ravel(derivative
+0001f820: 2873 656c 662e 6675 6e63 2c20 7661 722c  (self.func, var,
+0001f830: 2073 6565 6e29 2c20 6178 6973 3d73 656c   seen), axis=sel
+0001f840: 662e 6e64 696d 2d31 290a 0a20 2020 2064  f.ndim-1)..    d
+0001f850: 6566 205f 7461 6b65 6469 6167 2873 656c  ef _takediag(sel
+0001f860: 662c 2061 7869 7331 2c20 6178 6973 3229  f, axis1, axis2)
+0001f870: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+0001f880: 2061 7869 7331 203c 2061 7869 7332 0a20   axis1 < axis2. 
+0001f890: 2020 2020 2020 2069 6620 6178 6973 3220         if axis2 
+0001f8a0: 3c3d 2073 656c 662e 6e64 696d 2d32 3a0a  <= self.ndim-2:.
+0001f8b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001f8c0: 726e 2072 6176 656c 285f 7461 6b65 6469  rn ravel(_takedi
+0001f8d0: 6167 2873 656c 662e 6675 6e63 2c20 6178  ag(self.func, ax
+0001f8e0: 6973 312c 2061 7869 7332 292c 2073 656c  is1, axis2), sel
+0001f8f0: 662e 6e64 696d 2d33 290a 2020 2020 2020  f.ndim-3).      
+0001f900: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001f910: 2020 2020 756e 7261 7665 6c65 6420 3d20      unraveled = 
+0001f920: 756e 7261 7665 6c28 7365 6c66 2e66 756e  unravel(self.fun
+0001f930: 632c 2061 7869 7331 2c20 7365 6c66 2e66  c, axis1, self.f
+0001f940: 756e 632e 7368 6170 655b 2d32 3a5d 290a  unc.shape[-2:]).
+0001f950: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001f960: 726e 2052 6176 656c 285f 7461 6b65 6469  rn Ravel(_takedi
+0001f970: 6167 285f 7461 6b65 6469 6167 2875 6e72  ag(_takediag(unr
+0001f980: 6176 656c 6564 2c20 6178 6973 312c 202d  aveled, axis1, -
+0001f990: 3229 2c20 6178 6973 312c 202d 3229 290a  2), axis1, -2)).
+0001f9a0: 0a20 2020 2064 6566 205f 7461 6b65 2873  .    def _take(s
+0001f9b0: 656c 662c 2069 6e64 6578 2c20 6178 6973  elf, index, axis
+0001f9c0: 293a 0a20 2020 2020 2020 2069 6620 6178  ):.        if ax
+0001f9d0: 6973 2021 3d20 7365 6c66 2e6e 6469 6d2d  is != self.ndim-
+0001f9e0: 313a 0a20 2020 2020 2020 2020 2020 2072  1:.            r
+0001f9f0: 6574 7572 6e20 5261 7665 6c28 5f74 616b  eturn Ravel(_tak
+0001fa00: 6528 7365 6c66 2e66 756e 632c 2069 6e64  e(self.func, ind
+0001fa10: 6578 2c20 6178 6973 2929 0a0a 2020 2020  ex, axis))..    
+0001fa20: 6465 6620 5f72 7461 6b65 2873 656c 662c  def _rtake(self,
+0001fa30: 2066 756e 632c 2061 7869 7329 3a0a 2020   func, axis):.  
+0001fa40: 2020 2020 2020 6966 2073 656c 662e 6e64        if self.nd
+0001fa50: 696d 203d 3d20 313a 0a20 2020 2020 2020  im == 1:.       
+0001fa60: 2020 2020 2072 6574 7572 6e20 5261 7665       return Rave
+0001fa70: 6c28 5461 6b65 2866 756e 632c 2073 656c  l(Take(func, sel
+0001fa80: 662e 6675 6e63 2929 0a0a 2020 2020 6465  f.func))..    de
+0001fa90: 6620 5f75 6e72 6176 656c 2873 656c 662c  f _unravel(self,
+0001faa0: 2061 7869 732c 2073 6861 7065 293a 0a20   axis, shape):. 
+0001fab0: 2020 2020 2020 2069 6620 6178 6973 2021         if axis !
+0001fac0: 3d20 7365 6c66 2e6e 6469 6d2d 313a 0a20  = self.ndim-1:. 
+0001fad0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001fae0: 6e20 5261 7665 6c28 756e 7261 7665 6c28  n Ravel(unravel(
+0001faf0: 7365 6c66 2e66 756e 632c 2061 7869 732c  self.func, axis,
+0001fb00: 2073 6861 7065 2929 0a20 2020 2020 2020   shape)).       
+0001fb10: 2065 6c69 6620 6571 7561 6c73 6861 7065   elif equalshape
+0001fb20: 2873 6861 7065 2c20 7365 6c66 2e66 756e  (shape, self.fun
+0001fb30: 632e 7368 6170 655b 2d32 3a5d 293a 0a20  c.shape[-2:]):. 
+0001fb40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001fb50: 6e20 7365 6c66 2e66 756e 630a 0a20 2020  n self.func..   
+0001fb60: 2064 6566 205f 696e 666c 6174 6528 7365   def _inflate(se
+0001fb70: 6c66 2c20 646f 666d 6170 2c20 6c65 6e67  lf, dofmap, leng
+0001fb80: 7468 2c20 6178 6973 293a 0a20 2020 2020  th, axis):.     
+0001fb90: 2020 2069 6620 6178 6973 203c 2073 656c     if axis < sel
+0001fba0: 662e 6e64 696d 2d64 6f66 6d61 702e 6e64  f.ndim-dofmap.nd
+0001fbb0: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
+0001fbc0: 7265 7475 726e 2052 6176 656c 285f 696e  return Ravel(_in
+0001fbd0: 666c 6174 6528 7365 6c66 2e66 756e 632c  flate(self.func,
+0001fbe0: 2064 6f66 6d61 702c 206c 656e 6774 682c   dofmap, length,
+0001fbf0: 2061 7869 7329 290a 2020 2020 2020 2020   axis)).        
+0001fc00: 656c 6966 2064 6f66 6d61 702e 6e64 696d  elif dofmap.ndim
+0001fc10: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+0001fc20: 2020 2072 6574 7572 6e20 7261 7665 6c28     return ravel(
+0001fc30: 496e 666c 6174 6528 7365 6c66 2e66 756e  Inflate(self.fun
+0001fc40: 632c 2064 6f66 6d61 702c 206c 656e 6774  c, dofmap, lengt
+0001fc50: 6829 2c20 7365 6c66 2e6e 6469 6d2d 3129  h), self.ndim-1)
+0001fc60: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001fc70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001fc80: 6e20 5f69 6e66 6c61 7465 2873 656c 662e  n _inflate(self.
+0001fc90: 6675 6e63 2c20 556e 7261 7665 6c28 646f  func, Unravel(do
+0001fca0: 666d 6170 2c20 2a73 656c 662e 6675 6e63  fmap, *self.func
+0001fcb0: 2e73 6861 7065 5b2d 323a 5d29 2c20 6c65  .shape[-2:]), le
+0001fcc0: 6e67 7468 2c20 6178 6973 290a 0a20 2020  ngth, axis)..   
+0001fcd0: 2064 6566 205f 6469 6167 6f6e 616c 697a   def _diagonaliz
+0001fce0: 6528 7365 6c66 2c20 6178 6973 293a 0a20  e(self, axis):. 
+0001fcf0: 2020 2020 2020 2069 6620 6178 6973 2021         if axis !
+0001fd00: 3d20 7365 6c66 2e6e 6469 6d2d 313a 0a20  = self.ndim-1:. 
+0001fd10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001fd20: 6e20 7261 7665 6c28 6469 6167 6f6e 616c  n ravel(diagonal
+0001fd30: 697a 6528 7365 6c66 2e66 756e 632c 2061  ize(self.func, a
+0001fd40: 7869 7329 2c20 7365 6c66 2e6e 6469 6d2d  xis), self.ndim-
+0001fd50: 3129 0a0a 2020 2020 6465 6620 5f69 6e73  1)..    def _ins
+0001fd60: 6572 7461 7869 7328 7365 6c66 2c20 6178  ertaxis(self, ax
+0001fd70: 6973 2c20 6c65 6e67 7468 293a 0a20 2020  is, length):.   
+0001fd80: 2020 2020 2072 6574 7572 6e20 7261 7665       return rave
+0001fd90: 6c28 696e 7365 7274 6178 6973 2873 656c  l(insertaxis(sel
+0001fda0: 662e 6675 6e63 2c20 6178 6973 2b28 6178  f.func, axis+(ax
+0001fdb0: 6973 203d 3d20 7365 6c66 2e6e 6469 6d29  is == self.ndim)
+0001fdc0: 2c20 6c65 6e67 7468 292c 2073 656c 662e  , length), self.
+0001fdd0: 6e64 696d 2d28 6178 6973 203d 3d20 7365  ndim-(axis == se
+0001fde0: 6c66 2e6e 6469 6d29 290a 0a20 2020 2064  lf.ndim))..    d
+0001fdf0: 6566 205f 706f 7765 7228 7365 6c66 2c20  ef _power(self, 
+0001fe00: 6e29 3a0a 2020 2020 2020 2020 7265 7475  n):.        retu
+0001fe10: 726e 2052 6176 656c 2850 6f77 6572 2873  rn Ravel(Power(s
+0001fe20: 656c 662e 6675 6e63 2c20 556e 7261 7665  elf.func, Unrave
+0001fe30: 6c28 6e2c 202a 7365 6c66 2e66 756e 632e  l(n, *self.func.
+0001fe40: 7368 6170 655b 2d32 3a5d 2929 290a 0a20  shape[-2:]))).. 
+0001fe50: 2020 2064 6566 205f 7369 676e 2873 656c     def _sign(sel
+0001fe60: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
+0001fe70: 726e 2052 6176 656c 2853 6967 6e28 7365  rn Ravel(Sign(se
+0001fe80: 6c66 2e66 756e 6329 290a 0a20 2020 2064  lf.func))..    d
+0001fe90: 6566 205f 7072 6f64 7563 7428 7365 6c66  ef _product(self
+0001fea0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+0001feb0: 6e20 5072 6f64 7563 7428 5072 6f64 7563  n Product(Produc
+0001fec0: 7428 7365 6c66 2e66 756e 6329 290a 0a20  t(self.func)).. 
+0001fed0: 2020 2064 6566 205f 6c6f 6f70 7375 6d28     def _loopsum(
+0001fee0: 7365 6c66 2c20 696e 6465 7829 3a0a 2020  self, index):.  
+0001fef0: 2020 2020 2020 7265 7475 726e 2052 6176        return Rav
+0001ff00: 656c 286c 6f6f 705f 7375 6d28 7365 6c66  el(loop_sum(self
+0001ff10: 2e66 756e 632c 2069 6e64 6578 2929 0a0a  .func, index))..
+0001ff20: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+0001ff30: 2020 6465 6620 5f75 6e61 6c69 676e 6564    def _unaligned
+0001ff40: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001ff50: 756e 616c 6967 6e65 642c 2077 6865 7265  unaligned, where
+0001ff60: 203d 2075 6e61 6c69 676e 2873 656c 662e   = unalign(self.
+0001ff70: 6675 6e63 2c20 6e61 7865 733d 7365 6c66  func, naxes=self
+0001ff80: 2e6e 6469 6d20 2d20 3129 0a20 2020 2020  .ndim - 1).     
+0001ff90: 2020 2072 6574 7572 6e20 5261 7665 6c28     return Ravel(
+0001ffa0: 756e 616c 6967 6e65 6429 2c20 282a 7768  unaligned), (*wh
+0001ffb0: 6572 652c 2073 656c 662e 6e64 696d 202d  ere, self.ndim -
+0001ffc0: 2031 290a 0a20 2020 2040 6361 6368 6564   1)..    @cached
+0001ffd0: 5f70 726f 7065 7274 790a 2020 2020 6465  _property.    de
+0001ffe0: 6620 5f61 7373 7061 7273 6528 7365 6c66  f _assparse(self
+0001fff0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00020000: 6e20 7475 706c 6528 282a 696e 6469 6365  n tuple((*indice
+00020010: 735b 3a2d 325d 2c20 696e 6469 6365 735b  s[:-2], indices[
+00020020: 2d32 5d2a 7365 6c66 2e66 756e 632e 7368  -2]*self.func.sh
+00020030: 6170 655b 2d31 5d2b 696e 6469 6365 735b  ape[-1]+indices[
+00020040: 2d31 5d2c 2076 616c 7565 7329 2066 6f72  -1], values) for
+00020050: 202a 696e 6469 6365 732c 2076 616c 7565   *indices, value
+00020060: 7320 696e 2073 656c 662e 6675 6e63 2e5f  s in self.func._
+00020070: 6173 7370 6172 7365 290a 0a20 2020 2064  assparse)..    d
+00020080: 6566 205f 696e 7462 6f75 6e64 735f 696d  ef _intbounds_im
+00020090: 706c 2873 656c 6629 3a0a 2020 2020 2020  pl(self):.      
+000200a0: 2020 7265 7475 726e 2073 656c 662e 6675    return self.fu
+000200b0: 6e63 2e5f 696e 7462 6f75 6e64 735f 696d  nc._intbounds_im
+000200c0: 706c 2829 0a0a 0a63 6c61 7373 2055 6e72  pl()...class Unr
+000200d0: 6176 656c 2841 7272 6179 293a 0a0a 2020  avel(Array):..  
+000200e0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+000200f0: 656c 662c 2066 756e 633a 2041 7272 6179  elf, func: Array
+00020100: 2c20 7368 313a 2041 7272 6179 2c20 7368  , sh1: Array, sh
+00020110: 323a 2041 7272 6179 293a 0a20 2020 2020  2: Array):.     
+00020120: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+00020130: 616e 6365 2866 756e 632c 2041 7272 6179  ance(func, Array
+00020140: 2920 616e 6420 6675 6e63 2e6e 6469 6d20  ) and func.ndim 
+00020150: 3e20 302c 2066 2766 756e 633d 7b66 756e  > 0, f'func={fun
+00020160: 6321 727d 270a 2020 2020 2020 2020 6173  c!r}'.        as
+00020170: 7365 7274 205f 6973 696e 6465 7828 7368  sert _isindex(sh
+00020180: 3129 2c20 6627 7368 313d 7b73 6831 2172  1), f'sh1={sh1!r
+00020190: 7d27 0a20 2020 2020 2020 2061 7373 6572  }'.        asser
+000201a0: 7420 5f69 7369 6e64 6578 2873 6832 292c  t _isindex(sh2),
+000201b0: 2066 2773 6832 3d7b 7368 3221 727d 270a   f'sh2={sh2!r}'.
+000201c0: 2020 2020 2020 2020 6173 7365 7274 205f          assert _
+000201d0: 6571 7561 6c73 5f73 696d 706c 6966 6965  equals_simplifie
+000201e0: 6428 6675 6e63 2e73 6861 7065 5b2d 315d  d(func.shape[-1]
+000201f0: 2c20 7368 3120 2a20 7368 3229 0a20 2020  , sh1 * sh2).   
+00020200: 2020 2020 2073 656c 662e 6675 6e63 203d       self.func =
+00020210: 2066 756e 630a 2020 2020 2020 2020 7375   func.        su
+00020220: 7065 7228 292e 5f5f 696e 6974 5f5f 2861  per().__init__(a
+00020230: 7267 733d 2866 756e 632c 2073 6831 2c20  rgs=(func, sh1, 
+00020240: 7368 3229 2c20 7368 6170 653d 282a 6675  sh2), shape=(*fu
+00020250: 6e63 2e73 6861 7065 5b3a 2d31 5d2c 2073  nc.shape[:-1], s
+00020260: 6831 2c20 7368 3229 2c20 6474 7970 653d  h1, sh2), dtype=
+00020270: 6675 6e63 2e64 7479 7065 290a 0a20 2020  func.dtype)..   
+00020280: 2064 6566 205f 7369 6d70 6c69 6669 6564   def _simplified
+00020290: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000202a0: 6966 205f 6571 7561 6c73 5f73 6361 6c61  if _equals_scala
+000202b0: 725f 636f 6e73 7461 6e74 2873 656c 662e  r_constant(self.
+000202c0: 7368 6170 655b 2d32 5d2c 2031 293a 0a20  shape[-2], 1):. 
+000202d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000202e0: 6e20 696e 7365 7274 6178 6973 2873 656c  n insertaxis(sel
+000202f0: 662e 6675 6e63 2c20 7365 6c66 2e6e 6469  f.func, self.ndi
+00020300: 6d2d 322c 2063 6f6e 7374 616e 7428 3129  m-2, constant(1)
+00020310: 290a 2020 2020 2020 2020 6966 205f 6571  ).        if _eq
+00020320: 7561 6c73 5f73 6361 6c61 725f 636f 6e73  uals_scalar_cons
+00020330: 7461 6e74 2873 656c 662e 7368 6170 655b  tant(self.shape[
+00020340: 2d31 5d2c 2031 293a 0a20 2020 2020 2020  -1], 1):.       
+00020350: 2020 2020 2072 6574 7572 6e20 696e 7365       return inse
+00020360: 7274 6178 6973 2873 656c 662e 6675 6e63  rtaxis(self.func
+00020370: 2c20 7365 6c66 2e6e 6469 6d2d 312c 2063  , self.ndim-1, c
+00020380: 6f6e 7374 616e 7428 3129 290a 2020 2020  onstant(1)).    
+00020390: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+000203a0: 6675 6e63 2e5f 756e 7261 7665 6c28 7365  func._unravel(se
+000203b0: 6c66 2e6e 6469 6d2d 322c 2073 656c 662e  lf.ndim-2, self.
+000203c0: 7368 6170 655b 2d32 3a5d 290a 0a20 2020  shape[-2:])..   
+000203d0: 2064 6566 205f 6465 7269 7661 7469 7665   def _derivative
+000203e0: 2873 656c 662c 2076 6172 2c20 7365 656e  (self, var, seen
+000203f0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00020400: 6e20 756e 7261 7665 6c28 6465 7269 7661  n unravel(deriva
+00020410: 7469 7665 2873 656c 662e 6675 6e63 2c20  tive(self.func, 
+00020420: 7661 722c 2073 6565 6e29 2c20 6178 6973  var, seen), axis
+00020430: 3d73 656c 662e 6e64 696d 2d32 2c20 7368  =self.ndim-2, sh
+00020440: 6170 653d 7365 6c66 2e73 6861 7065 5b2d  ape=self.shape[-
+00020450: 323a 5d29 0a0a 2020 2020 4073 7461 7469  2:])..    @stati
+00020460: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
+00020470: 6576 616c 6628 662c 2073 6831 2c20 7368  evalf(f, sh1, sh
+00020480: 3229 3a0a 2020 2020 2020 2020 7265 7475  2):.        retu
+00020490: 726e 2066 2e72 6573 6861 7065 2866 2e73  rn f.reshape(f.s
+000204a0: 6861 7065 5b3a 2d31 5d20 2b20 2873 6831  hape[:-1] + (sh1
+000204b0: 2c20 7368 3229 290a 0a20 2020 2064 6566  , sh2))..    def
+000204c0: 205f 7461 6b65 6469 6167 2873 656c 662c   _takediag(self,
+000204d0: 2061 7869 7331 2c20 6178 6973 3229 3a0a   axis1, axis2):.
+000204e0: 2020 2020 2020 2020 6966 2061 7869 7332          if axis2
+000204f0: 203c 2073 656c 662e 6e64 696d 2d32 3a0a   < self.ndim-2:.
+00020500: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00020510: 726e 2075 6e72 6176 656c 285f 7461 6b65  rn unravel(_take
+00020520: 6469 6167 2873 656c 662e 6675 6e63 2c20  diag(self.func, 
+00020530: 6178 6973 312c 2061 7869 7332 292c 2073  axis1, axis2), s
+00020540: 656c 662e 6e64 696d 2d34 2c20 7365 6c66  elf.ndim-4, self
+00020550: 2e73 6861 7065 5b2d 323a 5d29 0a0a 2020  .shape[-2:])..  
+00020560: 2020 6465 6620 5f74 616b 6528 7365 6c66    def _take(self
+00020570: 2c20 696e 6465 782c 2061 7869 7329 3a0a  , index, axis):.
+00020580: 2020 2020 2020 2020 6966 2061 7869 7320          if axis 
+00020590: 3c20 7365 6c66 2e6e 6469 6d20 2d20 323a  < self.ndim - 2:
+000205a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000205b0: 7572 6e20 556e 7261 7665 6c28 5f74 616b  urn Unravel(_tak
+000205c0: 6528 7365 6c66 2e66 756e 632c 2069 6e64  e(self.func, ind
+000205d0: 6578 2c20 6178 6973 292c 202a 7365 6c66  ex, axis), *self
+000205e0: 2e73 6861 7065 5b2d 323a 5d29 0a0a 2020  .shape[-2:])..  
+000205f0: 2020 6465 6620 5f73 756d 2873 656c 662c    def _sum(self,
+00020600: 2061 7869 7329 3a0a 2020 2020 2020 2020   axis):.        
+00020610: 6966 2061 7869 7320 3c20 7365 6c66 2e6e  if axis < self.n
+00020620: 6469 6d20 2d20 323a 0a20 2020 2020 2020  dim - 2:.       
+00020630: 2020 2020 2072 6574 7572 6e20 556e 7261       return Unra
+00020640: 7665 6c28 7375 6d28 7365 6c66 2e66 756e  vel(sum(self.fun
+00020650: 632c 2061 7869 7329 2c20 2a73 656c 662e  c, axis), *self.
+00020660: 7368 6170 655b 2d32 3a5d 290a 0a20 2020  shape[-2:])..   
+00020670: 2040 6361 6368 6564 5f70 726f 7065 7274   @cached_propert
+00020680: 790a 2020 2020 6465 6620 5f61 7373 7061  y.    def _asspa
+00020690: 7273 6528 7365 6c66 293a 0a20 2020 2020  rse(self):.     
+000206a0: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
+000206b0: 282a 696e 6469 6365 735b 3a2d 315d 2c20  (*indices[:-1], 
+000206c0: 2a64 6976 6d6f 6428 696e 6469 6365 735b  *divmod(indices[
+000206d0: 2d31 5d2c 2061 7070 656e 6461 7865 7328  -1], appendaxes(
+000206e0: 7365 6c66 2e73 6861 7065 5b2d 315d 2c20  self.shape[-1], 
+000206f0: 7661 6c75 6573 2e73 6861 7065 2929 2c20  values.shape)), 
+00020700: 7661 6c75 6573 2920 666f 7220 2a69 6e64  values) for *ind
+00020710: 6963 6573 2c20 7661 6c75 6573 2069 6e20  ices, values in 
+00020720: 7365 6c66 2e66 756e 632e 5f61 7373 7061  self.func._asspa
+00020730: 7273 6529 0a0a 0a63 6c61 7373 2052 6176  rse)...class Rav
+00020740: 656c 496e 6465 7828 4172 7261 7929 3a0a  elIndex(Array):.
+00020750: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00020760: 5f28 7365 6c66 2c20 6961 3a20 4172 7261  _(self, ia: Arra
+00020770: 792c 2069 623a 2041 7272 6179 2c20 6e61  y, ib: Array, na
+00020780: 3a20 4172 7261 792c 206e 623a 2041 7272  : Array, nb: Arr
+00020790: 6179 293a 0a20 2020 2020 2020 2061 7373  ay):.        ass
+000207a0: 6572 7420 6973 696e 7374 616e 6365 2869  ert isinstance(i
+000207b0: 612c 2041 7272 6179 292c 2066 2769 613d  a, Array), f'ia=
+000207c0: 7b69 6121 727d 270a 2020 2020 2020 2020  {ia!r}'.        
+000207d0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+000207e0: 6528 6962 2c20 4172 7261 7929 2c20 6627  e(ib, Array), f'
+000207f0: 6962 3d7b 6962 2172 7d27 0a20 2020 2020  ib={ib!r}'.     
+00020800: 2020 2061 7373 6572 7420 5f69 7369 6e64     assert _isind
+00020810: 6578 286e 6129 2c20 6627 6e61 3d7b 6e61  ex(na), f'na={na
+00020820: 2172 7d27 0a20 2020 2020 2020 2061 7373  !r}'.        ass
+00020830: 6572 7420 5f69 7369 6e64 6578 286e 6229  ert _isindex(nb)
+00020840: 2c20 6627 6e62 3d7b 6e62 2172 7d27 0a20  , f'nb={nb!r}'. 
+00020850: 2020 2020 2020 2073 656c 662e 5f69 6120         self._ia 
+00020860: 3d20 6961 0a20 2020 2020 2020 2073 656c  = ia.        sel
+00020870: 662e 5f69 6220 3d20 6962 0a20 2020 2020  f._ib = ib.     
+00020880: 2020 2073 656c 662e 5f6e 6120 3d20 6e61     self._na = na
+00020890: 0a20 2020 2020 2020 2073 656c 662e 5f6e  .        self._n
+000208a0: 6220 3d20 6e62 0a20 2020 2020 2020 2073  b = nb.        s
+000208b0: 656c 662e 5f6c 656e 6774 6820 3d20 6e61  elf._length = na
+000208c0: 202a 206e 620a 2020 2020 2020 2020 7375   * nb.        su
+000208d0: 7065 7228 292e 5f5f 696e 6974 5f5f 2861  per().__init__(a
+000208e0: 7267 733d 2869 612c 2069 622c 206e 6229  rgs=(ia, ib, nb)
+000208f0: 2c20 7368 6170 653d 6961 2e73 6861 7065  , shape=ia.shape
+00020900: 202b 2069 622e 7368 6170 652c 2064 7479   + ib.shape, dty
+00020910: 7065 3d69 6e74 290a 0a20 2020 2040 7374  pe=int)..    @st
+00020920: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
+00020930: 6566 2065 7661 6c66 2869 612c 2069 622c  ef evalf(ia, ib,
+00020940: 206e 6229 3a0a 2020 2020 2020 2020 7265   nb):.        re
+00020950: 7475 726e 2069 615b 282e 2e2e 2c29 2b28  turn ia[(...,)+(
+00020960: 6e75 6d70 792e 6e65 7761 7869 732c 292a  numpy.newaxis,)*
+00020970: 6962 2e6e 6469 6d5d 202a 206e 6220 2b20  ib.ndim] * nb + 
+00020980: 6962 0a0a 2020 2020 6465 6620 5f74 616b  ib..    def _tak
+00020990: 6528 7365 6c66 2c20 696e 6465 782c 2061  e(self, index, a
+000209a0: 7869 7329 3a0a 2020 2020 2020 2020 6966  xis):.        if
+000209b0: 2061 7869 7320 3c20 7365 6c66 2e5f 6961   axis < self._ia
+000209c0: 2e6e 6469 6d3a 0a20 2020 2020 2020 2020  .ndim:.         
+000209d0: 2020 2072 6574 7572 6e20 5261 7665 6c49     return RavelI
+000209e0: 6e64 6578 285f 7461 6b65 2873 656c 662e  ndex(_take(self.
+000209f0: 5f69 612c 2069 6e64 6578 2c20 6178 6973  _ia, index, axis
+00020a00: 292c 2073 656c 662e 5f69 622c 2073 656c  ), self._ib, sel
+00020a10: 662e 5f6e 612c 2073 656c 662e 5f6e 6229  f._na, self._nb)
+00020a20: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00020a30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00020a40: 6e20 5261 7665 6c49 6e64 6578 2873 656c  n RavelIndex(sel
+00020a50: 662e 5f69 612c 205f 7461 6b65 2873 656c  f._ia, _take(sel
+00020a60: 662e 5f69 622c 2069 6e64 6578 2c20 6178  f._ib, index, ax
+00020a70: 6973 202d 2073 656c 662e 5f69 612e 6e64  is - self._ia.nd
+00020a80: 696d 292c 2073 656c 662e 5f6e 612c 2073  im), self._na, s
+00020a90: 656c 662e 5f6e 6229 0a0a 2020 2020 6465  elf._nb)..    de
+00020aa0: 6620 5f72 7461 6b65 2873 656c 662c 2066  f _rtake(self, f
+00020ab0: 756e 632c 2061 7869 7329 3a0a 2020 2020  unc, axis):.    
+00020ac0: 2020 2020 6966 205f 6571 7561 6c73 5f73      if _equals_s
+00020ad0: 696d 706c 6966 6965 6428 6675 6e63 2e73  implified(func.s
+00020ae0: 6861 7065 5b61 7869 735d 2c20 7365 6c66  hape[axis], self
+00020af0: 2e5f 6c65 6e67 7468 293a 0a20 2020 2020  ._length):.     
+00020b00: 2020 2020 2020 2072 6574 7572 6e20 5f74         return _t
+00020b10: 616b 6528 5f74 616b 6528 756e 7261 7665  ake(_take(unrave
+00020b20: 6c28 6675 6e63 2c20 6178 6973 2c20 2873  l(func, axis, (s
+00020b30: 656c 662e 5f6e 612c 2073 656c 662e 5f6e  elf._na, self._n
+00020b40: 6229 292c 2073 656c 662e 5f69 622c 2061  b)), self._ib, a
+00020b50: 7869 732b 3129 2c20 7365 6c66 2e5f 6961  xis+1), self._ia
+00020b60: 2c20 6178 6973 290a 0a20 2020 2064 6566  , axis)..    def
+00020b70: 205f 7269 6e66 6c61 7465 2873 656c 662c   _rinflate(self,
+00020b80: 2066 756e 632c 206c 656e 6774 682c 2061   func, length, a
+00020b90: 7869 7329 3a0a 2020 2020 2020 2020 6966  xis):.        if
+00020ba0: 205f 6571 7561 6c73 5f73 696d 706c 6966   _equals_simplif
+00020bb0: 6965 6428 6c65 6e67 7468 2c20 7365 6c66  ied(length, self
+00020bc0: 2e5f 6c65 6e67 7468 293a 0a20 2020 2020  ._length):.     
+00020bd0: 2020 2020 2020 2072 6574 7572 6e20 5261         return Ra
+00020be0: 7665 6c28 496e 666c 6174 6528 5f69 6e66  vel(Inflate(_inf
+00020bf0: 6c61 7465 2866 756e 632c 2073 656c 662e  late(func, self.
+00020c00: 5f69 612c 2073 656c 662e 5f6e 612c 2066  _ia, self._na, f
+00020c10: 756e 632e 6e64 696d 202d 2073 656c 662e  unc.ndim - self.
+00020c20: 6e64 696d 292c 2073 656c 662e 5f69 622c  ndim), self._ib,
+00020c30: 2073 656c 662e 5f6e 6229 290a 0a20 2020   self._nb))..   
+00020c40: 2064 6566 205f 756e 7261 7665 6c28 7365   def _unravel(se
+00020c50: 6c66 2c20 6178 6973 2c20 7368 6170 6529  lf, axis, shape)
+00020c60: 3a0a 2020 2020 2020 2020 6966 2061 7869  :.        if axi
+00020c70: 7320 3c20 7365 6c66 2e5f 6961 2e6e 6469  s < self._ia.ndi
+00020c80: 6d3a 0a20 2020 2020 2020 2020 2020 2072  m:.            r
+00020c90: 6574 7572 6e20 5261 7665 6c49 6e64 6578  eturn RavelIndex
+00020ca0: 2875 6e72 6176 656c 2873 656c 662e 5f69  (unravel(self._i
+00020cb0: 612c 2061 7869 732c 2073 6861 7065 292c  a, axis, shape),
+00020cc0: 2073 656c 662e 5f69 622c 2073 656c 662e   self._ib, self.
+00020cd0: 5f6e 612c 2073 656c 662e 5f6e 6229 0a20  _na, self._nb). 
+00020ce0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00020cf0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00020d00: 5261 7665 6c49 6e64 6578 2873 656c 662e  RavelIndex(self.
+00020d10: 5f69 612c 2075 6e72 6176 656c 2873 656c  _ia, unravel(sel
+00020d20: 662e 5f69 622c 2061 7869 732d 7365 6c66  f._ib, axis-self
+00020d30: 2e5f 6961 2e6e 6469 6d2c 2073 6861 7065  ._ia.ndim, shape
+00020d40: 292c 2073 656c 662e 5f6e 612c 2073 656c  ), self._na, sel
+00020d50: 662e 5f6e 6229 0a0a 2020 2020 6465 6620  f._nb)..    def 
+00020d60: 5f69 6e74 626f 756e 6473 5f69 6d70 6c28  _intbounds_impl(
+00020d70: 7365 6c66 293a 0a20 2020 2020 2020 206e  self):.        n
+00020d80: 626d 696e 2c20 6e62 6d61 7820 3d20 7365  bmin, nbmax = se
+00020d90: 6c66 2e5f 6e62 2e5f 696e 7462 6f75 6e64  lf._nb._intbound
+00020da0: 730a 2020 2020 2020 2020 6961 6d69 6e2c  s.        iamin,
+00020db0: 2069 616d 6178 203d 2073 656c 662e 5f69   iamax = self._i
+00020dc0: 612e 5f69 6e74 626f 756e 6473 0a20 2020  a._intbounds.   
+00020dd0: 2020 2020 2069 626d 696e 2c20 6962 6d61       ibmin, ibma
+00020de0: 7820 3d20 7365 6c66 2e5f 6962 2e5f 696e  x = self._ib._in
+00020df0: 7462 6f75 6e64 730a 2020 2020 2020 2020  tbounds.        
+00020e00: 7265 7475 726e 2069 616d 696e 202a 206e  return iamin * n
+00020e10: 626d 696e 202b 2069 626d 696e 2c20 2869  bmin + ibmin, (i
+00020e20: 616d 6178 2061 6e64 206e 626d 6178 2061  amax and nbmax a
+00020e30: 6e64 2069 616d 6178 202a 206e 626d 6178  nd iamax * nbmax
+00020e40: 2920 2b20 6962 6d61 780a 0a0a 636c 6173  ) + ibmax...clas
+00020e50: 7320 5261 6e67 6528 4172 7261 7929 3a0a  s Range(Array):.
+00020e60: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00020e70: 5f28 7365 6c66 2c20 6c65 6e67 7468 3a20  _(self, length: 
+00020e80: 4172 7261 7929 3a0a 2020 2020 2020 2020  Array):.        
+00020e90: 6173 7365 7274 205f 6973 696e 6465 7828  assert _isindex(
+00020ea0: 6c65 6e67 7468 292c 2066 276c 656e 6774  length), f'lengt
+00020eb0: 683d 7b6c 656e 6774 6821 727d 270a 2020  h={length!r}'.  
+00020ec0: 2020 2020 2020 7365 6c66 2e6c 656e 6774        self.lengt
+00020ed0: 6820 3d20 6c65 6e67 7468 0a20 2020 2020  h = length.     
+00020ee0: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00020ef0: 745f 5f28 6172 6773 3d28 6c65 6e67 7468  t__(args=(length
+00020f00: 2c29 2c20 7368 6170 653d 286c 656e 6774  ,), shape=(lengt
+00020f10: 682c 292c 2064 7479 7065 3d69 6e74 290a  h,), dtype=int).
+00020f20: 0a20 2020 2064 6566 205f 7461 6b65 2873  .    def _take(s
+00020f30: 656c 662c 2069 6e64 6578 2c20 6178 6973  elf, index, axis
+00020f40: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00020f50: 6e20 496e 5261 6e67 6528 696e 6465 782c  n InRange(index,
+00020f60: 2073 656c 662e 6c65 6e67 7468 290a 0a20   self.length).. 
+00020f70: 2020 2064 6566 205f 756e 7261 7665 6c28     def _unravel(
+00020f80: 7365 6c66 2c20 6178 6973 2c20 7368 6170  self, axis, shap
+00020f90: 6529 3a0a 2020 2020 2020 2020 6966 206c  e):.        if l
+00020fa0: 656e 2873 6861 7065 2920 3d3d 2032 3a0a  en(shape) == 2:.
+00020fb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00020fc0: 726e 2052 6176 656c 496e 6465 7828 5261  rn RavelIndex(Ra
+00020fd0: 6e67 6528 7368 6170 655b 305d 292c 2052  nge(shape[0]), R
+00020fe0: 616e 6765 2873 6861 7065 5b31 5d29 2c20  ange(shape[1]), 
+00020ff0: 7368 6170 655b 305d 2c20 7368 6170 655b  shape[0], shape[
+00021000: 315d 290a 0a20 2020 2064 6566 205f 7274  1])..    def _rt
+00021010: 616b 6528 7365 6c66 2c20 6675 6e63 2c20  ake(self, func, 
+00021020: 6178 6973 293a 0a20 2020 2020 2020 2069  axis):.        i
+00021030: 6620 5f65 7175 616c 735f 7369 6d70 6c69  f _equals_simpli
+00021040: 6669 6564 2873 656c 662e 6c65 6e67 7468  fied(self.length
+00021050: 2c20 6675 6e63 2e73 6861 7065 5b61 7869  , func.shape[axi
+00021060: 735d 293a 0a20 2020 2020 2020 2020 2020  s]):.           
+00021070: 2072 6574 7572 6e20 6675 6e63 0a0a 2020   return func..  
+00021080: 2020 6465 6620 5f72 696e 666c 6174 6528    def _rinflate(
+00021090: 7365 6c66 2c20 6675 6e63 2c20 6c65 6e67  self, func, leng
+000210a0: 7468 2c20 6178 6973 293a 0a20 2020 2020  th, axis):.     
+000210b0: 2020 2069 6620 6c65 6e67 7468 203d 3d20     if length == 
+000210c0: 7365 6c66 2e6c 656e 6774 683a 0a20 2020  self.length:.   
+000210d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000210e0: 6675 6e63 0a0a 2020 2020 6576 616c 6620  func..    evalf 
+000210f0: 3d20 7374 6174 6963 6d65 7468 6f64 286e  = staticmethod(n
+00021100: 756d 7079 2e61 7261 6e67 6529 0a0a 2020  umpy.arange)..  
+00021110: 2020 6465 6620 5f69 6e74 626f 756e 6473    def _intbounds
+00021120: 5f69 6d70 6c28 7365 6c66 293a 0a20 2020  _impl(self):.   
+00021130: 2020 2020 206c 6f77 6572 2c20 7570 7065       lower, uppe
+00021140: 7220 3d20 7365 6c66 2e6c 656e 6774 682e  r = self.length.
+00021150: 5f69 6e74 626f 756e 6473 0a20 2020 2020  _intbounds.     
+00021160: 2020 2061 7373 6572 7420 6c6f 7765 7220     assert lower 
+00021170: 3e3d 2030 0a20 2020 2020 2020 2072 6574  >= 0.        ret
+00021180: 7572 6e20 302c 206d 6178 2830 2c20 7570  urn 0, max(0, up
+00021190: 7065 7220 2d20 3129 0a0a 0a63 6c61 7373  per - 1)...class
+000211a0: 2049 6e52 616e 6765 2841 7272 6179 293a   InRange(Array):
+000211b0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+000211c0: 5f5f 2873 656c 662c 2069 6e64 6578 3a20  __(self, index: 
+000211d0: 4172 7261 792c 206c 656e 6774 683a 2041  Array, length: A
+000211e0: 7272 6179 293a 0a20 2020 2020 2020 2061  rray):.        a
+000211f0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00021200: 2869 6e64 6578 2c20 4172 7261 7929 2061  (index, Array) a
+00021210: 6e64 2069 6e64 6578 2e64 7479 7065 203d  nd index.dtype =
+00021220: 3d20 696e 742c 2066 2769 6e64 6578 3d7b  = int, f'index={
+00021230: 696e 6465 7821 727d 270a 2020 2020 2020  index!r}'.      
+00021240: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00021250: 6e63 6528 6c65 6e67 7468 2c20 4172 7261  nce(length, Arra
+00021260: 7929 2061 6e64 206c 656e 6774 682e 6474  y) and length.dt
+00021270: 7970 6520 3d3d 2069 6e74 2061 6e64 206c  ype == int and l
+00021280: 656e 6774 682e 6e64 696d 203d 3d20 302c  ength.ndim == 0,
+00021290: 2066 276c 656e 6774 683d 7b6c 656e 6774   f'length={lengt
+000212a0: 6821 727d 270a 2020 2020 2020 2020 7365  h!r}'.        se
+000212b0: 6c66 2e69 6e64 6578 203d 2069 6e64 6578  lf.index = index
+000212c0: 0a20 2020 2020 2020 2073 656c 662e 6c65  .        self.le
+000212d0: 6e67 7468 203d 206c 656e 6774 680a 2020  ngth = length.  
+000212e0: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+000212f0: 696e 6974 5f5f 2861 7267 733d 2869 6e64  init__(args=(ind
+00021300: 6578 2c20 6c65 6e67 7468 292c 2073 6861  ex, length), sha
+00021310: 7065 3d69 6e64 6578 2e73 6861 7065 2c20  pe=index.shape, 
+00021320: 6474 7970 653d 696e 7429 0a0a 2020 2020  dtype=int)..    
+00021330: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+00021340: 2020 6465 6620 6576 616c 6628 696e 6465    def evalf(inde
+00021350: 782c 206c 656e 6774 6829 3a0a 2020 2020  x, length):.    
+00021360: 2020 2020 6173 7365 7274 2069 6e64 6578      assert index
+00021370: 2e73 697a 6520 3d3d 2030 206f 7220 3020  .size == 0 or 0 
+00021380: 3c3d 2069 6e64 6578 2e6d 696e 2829 2061  <= index.min() a
+00021390: 6e64 2069 6e64 6578 2e6d 6178 2829 203c  nd index.max() <
+000213a0: 206c 656e 6774 680a 2020 2020 2020 2020   length.        
+000213b0: 7265 7475 726e 2069 6e64 6578 0a0a 2020  return index..  
+000213c0: 2020 6465 6620 5f73 696d 706c 6966 6965    def _simplifie
+000213d0: 6428 7365 6c66 293a 0a20 2020 2020 2020  d(self):.       
+000213e0: 206c 6f77 6572 5f6c 656e 6774 682c 2075   lower_length, u
+000213f0: 7070 6572 5f6c 656e 6774 6820 3d20 7365  pper_length = se
+00021400: 6c66 2e6c 656e 6774 682e 5f69 6e74 626f  lf.length._intbo
+00021410: 756e 6473 0a20 2020 2020 2020 206c 6f77  unds.        low
+00021420: 6572 5f69 6e64 6578 2c20 7570 7065 725f  er_index, upper_
+00021430: 696e 6465 7820 3d20 7365 6c66 2e69 6e64  index = self.ind
+00021440: 6578 2e5f 696e 7462 6f75 6e64 730a 2020  ex._intbounds.  
+00021450: 2020 2020 2020 6966 2030 203c 3d20 6c6f        if 0 <= lo
+00021460: 7765 725f 696e 6465 7820 3c3d 2075 7070  wer_index <= upp
+00021470: 6572 5f69 6e64 6578 203c 206c 6f77 6572  er_index < lower
+00021480: 5f6c 656e 6774 683a 0a20 2020 2020 2020  _length:.       
+00021490: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+000214a0: 2e69 6e64 6578 0a0a 2020 2020 6465 6620  .index..    def 
+000214b0: 5f69 6e74 626f 756e 6473 5f69 6d70 6c28  _intbounds_impl(
+000214c0: 7365 6c66 293a 0a20 2020 2020 2020 206c  self):.        l
+000214d0: 6f77 6572 5f69 6e64 6578 2c20 7570 7065  ower_index, uppe
+000214e0: 725f 696e 6465 7820 3d20 7365 6c66 2e69  r_index = self.i
+000214f0: 6e64 6578 2e5f 696e 7462 6f75 6e64 730a  ndex._intbounds.
+00021500: 2020 2020 2020 2020 6c6f 7765 725f 6c65          lower_le
+00021510: 6e67 7468 2c20 7570 7065 725f 6c65 6e67  ngth, upper_leng
+00021520: 7468 203d 2073 656c 662e 6c65 6e67 7468  th = self.length
+00021530: 2e5f 696e 7462 6f75 6e64 730a 2020 2020  ._intbounds.    
+00021540: 2020 2020 7570 7065 7220 3d20 6d69 6e28      upper = min(
+00021550: 7570 7065 725f 696e 6465 782c 206d 6178  upper_index, max
+00021560: 2830 2c20 7570 7065 725f 6c65 6e67 7468  (0, upper_length
+00021570: 202d 2031 2929 0a20 2020 2020 2020 2072   - 1)).        r
+00021580: 6574 7572 6e20 6d61 7828 302c 206d 696e  eturn max(0, min
+00021590: 286c 6f77 6572 5f69 6e64 6578 2c20 7570  (lower_index, up
+000215a0: 7065 7229 292c 2075 7070 6572 0a0a 0a63  per)), upper...c
+000215b0: 6c61 7373 2050 6f6c 7976 616c 2841 7272  lass Polyval(Arr
+000215c0: 6179 293a 0a20 2020 2027 2727 4576 616c  ay):.    '''Eval
+000215d0: 7561 7465 2061 2070 6f6c 796e 6f6d 6961  uate a polynomia
+000215e0: 6c0a 0a20 2020 2054 6865 2070 6f6c 796e  l..    The polyn
+000215f0: 6f6d 6961 6c73 2061 7265 206f 6620 7468  omials are of th
+00021600: 6520 666f 726d 0a0a 2020 2020 2e2e 206d  e form..    .. m
+00021610: 6174 683a 3a20 cea3 5f7b 6b20 e288 8820  ath:: .._{k ... 
+00021620: e284 a45e 6e20 7c20 cea3 5f69 206b 5f69  ...^n | .._i k_i
+00021630: 20e2 89a4 2070 7d20 635f 6b20 e288 8f5f   ... p} c_k ..._
+00021640: 6920 785f 695e 286b 5f69 290a 0a20 2020  i x_i^(k_i)..   
+00021650: 2077 6865 7265 203a 6d61 7468 3a60 6360   where :math:`c`
+00021660: 2069 7320 6120 7665 6374 6f72 206f 6620   is a vector of 
+00021670: 636f 6566 6669 6369 656e 7473 2c20 3a6d  coefficients, :m
+00021680: 6174 683a 6078 6020 6120 7665 6374 6f72  ath:`x` a vector
+00021690: 206f 660a 2020 2020 3a6d 6174 683a 606e   of.    :math:`n
+000216a0: 6020 7661 7269 6162 6c65 7320 616e 6420  ` variables and 
+000216b0: 3a6d 6174 683a 6070 6020 6120 6e6f 6e6e  :math:`p` a nonn
+000216c0: 6567 6174 6976 6520 696e 7465 6765 7220  egative integer 
+000216d0: 6465 6772 6565 2e20 5468 650a 2020 2020  degree. The.    
+000216e0: 636f 6566 6669 6369 656e 7473 2061 7265  coefficients are
+000216f0: 2061 7373 756d 6564 2074 6f20 6265 2069   assumed to be i
+00021700: 6e20 7265 7665 7273 6520 5b6c 6578 6963  n reverse [lexic
+00021710: 6f67 7261 7068 6963 206f 7264 6572 5d3a  ographic order]:
+00021720: 2074 6865 0a20 2020 2063 6f65 6666 6963   the.    coeffic
+00021730: 6965 6e74 2066 6f72 2070 6f77 6572 7320  ient for powers 
+00021740: 3a6d 6174 683a 606a 20e2 8888 20e2 84a4  :math:`j ... ...
+00021750: 5e6e 6020 636f 6d65 7320 6265 666f 7265  ^n` comes before
+00021760: 2074 6865 2063 6f65 6666 6963 6965 6e74   the coefficient
+00021770: 2066 6f72 0a20 2020 2070 6f77 6572 7320   for.    powers 
+00021780: 3a6d 6174 683a 606b 20e2 8888 20e2 84a4  :math:`k ... ...
+00021790: 5e6e 202f 207b 6a7d 6020 6966 6620 3a6d  ^n / {j}` iff :m
+000217a0: 6174 683a 606a 5f69 203e 206b 5f69 602c  ath:`j_i > k_i`,
+000217b0: 2077 6865 7265 203a 6d61 7468 3a60 6920   where :math:`i 
+000217c0: 3d0a 2020 2020 6d61 785f 6c28 6a5f 6c20  =.    max_l(j_l 
+000217d0: e289 a020 6b5f 6c29 602c 2074 6865 2069  ... k_l)`, the i
+000217e0: 6e64 6578 206f 6620 7468 6520 2a6c 6173  ndex of the *las
+000217f0: 742a 206e 6f6e 2d6d 6174 6368 696e 6720  t* non-matching 
+00021800: 706f 7765 722e 0a0a 2020 2020 4172 6773  power...    Args
+00021810: 0a20 2020 202d 2d2d 2d0a 2020 2020 636f  .    ----.    co
+00021820: 6566 6673 203a 203a 636c 6173 733a 6041  effs : :class:`A
+00021830: 7272 6179 600a 2020 2020 2020 2020 4172  rray`.        Ar
+00021840: 7261 7920 6f66 2063 6f65 6666 6963 6965  ray of coefficie
+00021850: 6e74 7320 7768 6572 6520 7468 6520 6c61  nts where the la
+00021860: 7374 2061 7869 7320 6973 2074 7265 6174  st axis is treat
+00021870: 6564 2061 7320 7468 650a 2020 2020 2020  ed as the.      
+00021880: 2020 636f 6566 6669 6369 656e 7473 2061    coefficients a
+00021890: 7865 732e 2041 6c6c 2072 656d 6169 6e69  xes. All remaini
+000218a0: 6e67 2061 7865 7320 6172 6520 7472 6561  ng axes are trea
+000218b0: 7465 6420 706f 696e 7477 6973 652e 0a20  ted pointwise.. 
+000218c0: 2020 2070 6f69 6e74 7320 3a20 3a63 6c61     points : :cla
+000218d0: 7373 3a60 4172 7261 7960 0a20 2020 2020  ss:`Array`.     
+000218e0: 2020 2041 7272 6179 206f 6620 7661 6c75     Array of valu
+000218f0: 6573 2077 6865 7265 2074 6865 206c 6173  es where the las
+00021900: 7420 6178 6973 2069 7320 7472 6561 7465  t axis is treate
+00021910: 6420 6173 2074 6865 2076 6172 6961 626c  d as the variabl
+00021920: 6573 2061 7869 732e 0a20 2020 2020 2020  es axis..       
+00021930: 2041 6c6c 2072 656d 6169 6e69 6e67 2061   All remaining a
+00021940: 7865 7320 6172 6520 7472 6561 7465 6420  xes are treated 
+00021950: 706f 696e 7477 6973 652e 0a20 2020 2027  pointwise..    '
+00021960: 2727 0a0a 2020 2020 6465 6620 5f5f 696e  ''..    def __in
+00021970: 6974 5f5f 2873 656c 662c 2063 6f65 6666  it__(self, coeff
+00021980: 733a 2041 7272 6179 2c20 706f 696e 7473  s: Array, points
+00021990: 3a20 4172 7261 7929 3a0a 2020 2020 2020  : Array):.      
+000219a0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+000219b0: 6e63 6528 636f 6566 6673 2c20 4172 7261  nce(coeffs, Arra
+000219c0: 7929 2061 6e64 2063 6f65 6666 732e 6474  y) and coeffs.dt
+000219d0: 7970 6520 3d3d 2066 6c6f 6174 2061 6e64  ype == float and
+000219e0: 2063 6f65 6666 732e 6e64 696d 203e 3d20   coeffs.ndim >= 
+000219f0: 312c 2066 2763 6f65 6666 733d 7b63 6f65  1, f'coeffs={coe
+00021a00: 6666 7321 727d 270a 2020 2020 2020 2020  ffs!r}'.        
+00021a10: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+00021a20: 6528 706f 696e 7473 2c20 4172 7261 7929  e(points, Array)
+00021a30: 2061 6e64 2070 6f69 6e74 732e 6474 7970   and points.dtyp
+00021a40: 6520 3d3d 2066 6c6f 6174 2061 6e64 2070  e == float and p
+00021a50: 6f69 6e74 732e 6e64 696d 203e 3d20 3120  oints.ndim >= 1 
+00021a60: 616e 6420 706f 696e 7473 2e73 6861 7065  and points.shape
+00021a70: 5b2d 315d 2e69 7363 6f6e 7374 616e 742c  [-1].isconstant,
+00021a80: 2066 2770 6f69 6e74 733d 7b70 6f69 6e74   f'points={point
+00021a90: 7321 727d 270a 2020 2020 2020 2020 7365  s!r}'.        se
+00021aa0: 6c66 2e70 6f69 6e74 735f 6e64 696d 203d  lf.points_ndim =
+00021ab0: 2069 6e74 2870 6f69 6e74 732e 7368 6170   int(points.shap
+00021ac0: 655b 2d31 5d29 0a20 2020 2020 2020 2073  e[-1]).        s
+00021ad0: 656c 662e 636f 6566 6673 203d 2063 6f65  elf.coeffs = coe
+00021ae0: 6666 730a 2020 2020 2020 2020 7365 6c66  ffs.        self
+00021af0: 2e70 6f69 6e74 7320 3d20 706f 696e 7473  .points = points
+00021b00: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+00021b10: 2e5f 5f69 6e69 745f 5f28 6172 6773 3d28  .__init__(args=(
+00021b20: 636f 6566 6673 2c20 706f 696e 7473 292c  coeffs, points),
+00021b30: 2073 6861 7065 3d70 6f69 6e74 732e 7368   shape=points.sh
+00021b40: 6170 655b 3a2d 315d 2b63 6f65 6666 732e  ape[:-1]+coeffs.
+00021b50: 7368 6170 655b 3a2d 315d 2c20 6474 7970  shape[:-1], dtyp
+00021b60: 653d 666c 6f61 7429 0a0a 2020 2020 6576  e=float)..    ev
+00021b70: 616c 6620 3d20 7374 6174 6963 6d65 7468  alf = staticmeth
+00021b80: 6f64 2870 6f6c 792e 6576 616c 5f6f 7574  od(poly.eval_out
+00021b90: 6572 290a 0a20 2020 2064 6566 205f 6465  er)..    def _de
+00021ba0: 7269 7661 7469 7665 2873 656c 662c 2076  rivative(self, v
+00021bb0: 6172 2c20 7365 656e 293a 0a20 2020 2020  ar, seen):.     
+00021bc0: 2020 2069 6620 7365 6c66 2e64 7479 7065     if self.dtype
+00021bd0: 203d 3d20 636f 6d70 6c65 783a 0a20 2020   == complex:.   
+00021be0: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
+00021bf0: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
+00021c00: 6f72 2827 5468 6520 636f 6d70 6c65 7820  or('The complex 
+00021c10: 6465 7269 7661 7469 7665 2069 7320 6e6f  derivative is no
+00021c20: 7420 696d 706c 656d 656e 7465 642e 2729  t implemented.')
+00021c30: 0a20 2020 2020 2020 2064 706f 696e 7473  .        dpoints
+00021c40: 203d 2065 696e 7375 6d28 2741 4269 2c41   = einsum('ABi,A
+00021c50: 6944 2d3e 4142 4427 2c20 506f 6c79 7661  iD->ABD', Polyva
+00021c60: 6c28 506f 6c79 4772 6164 2873 656c 662e  l(PolyGrad(self.
+00021c70: 636f 6566 6673 2c20 7365 6c66 2e70 6f69  coeffs, self.poi
+00021c80: 6e74 735f 6e64 696d 292c 2073 656c 662e  nts_ndim), self.
+00021c90: 706f 696e 7473 292c 2064 6572 6976 6174  points), derivat
+00021ca0: 6976 6528 7365 6c66 2e70 6f69 6e74 732c  ive(self.points,
+00021cb0: 2076 6172 2c20 7365 656e 292c 2041 3d73   var, seen), A=s
+00021cc0: 656c 662e 706f 696e 7473 2e6e 6469 6d2d  elf.points.ndim-
+00021cd0: 3129 0a20 2020 2020 2020 2064 636f 6566  1).        dcoef
+00021ce0: 6673 203d 2054 7261 6e73 706f 7365 2e66  fs = Transpose.f
+00021cf0: 726f 6d5f 656e 6428 506f 6c79 7661 6c28  rom_end(Polyval(
+00021d00: 5472 616e 7370 6f73 652e 746f 5f65 6e64  Transpose.to_end
+00021d10: 2864 6572 6976 6174 6976 6528 7365 6c66  (derivative(self
+00021d20: 2e63 6f65 6666 732c 2076 6172 2c20 7365  .coeffs, var, se
+00021d30: 656e 292c 202a 7261 6e67 6528 7365 6c66  en), *range(self
+00021d40: 2e63 6f65 6666 732e 6e64 696d 2929 2c20  .coeffs.ndim)), 
+00021d50: 7365 6c66 2e70 6f69 6e74 7329 2c20 2a72  self.points), *r
+00021d60: 616e 6765 2873 656c 662e 706f 696e 7473  ange(self.points
+00021d70: 2e6e 6469 6d2d 312c 2073 656c 662e 6e64  .ndim-1, self.nd
+00021d80: 696d 2929 0a20 2020 2020 2020 2072 6574  im)).        ret
+00021d90: 7572 6e20 6470 6f69 6e74 7320 2b20 6463  urn dpoints + dc
+00021da0: 6f65 6666 730a 0a20 2020 2064 6566 205f  oeffs..    def _
+00021db0: 7461 6b65 2873 656c 662c 2069 6e64 6578  take(self, index
+00021dc0: 2c20 6178 6973 293a 0a20 2020 2020 2020  , axis):.       
+00021dd0: 2069 6620 6178 6973 203c 2073 656c 662e   if axis < self.
+00021de0: 706f 696e 7473 2e6e 6469 6d20 2d20 313a  points.ndim - 1:
+00021df0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00021e00: 7572 6e20 506f 6c79 7661 6c28 7365 6c66  urn Polyval(self
+00021e10: 2e63 6f65 6666 732c 205f 7461 6b65 2873  .coeffs, _take(s
+00021e20: 656c 662e 706f 696e 7473 2c20 696e 6465  elf.points, inde
+00021e30: 782c 2061 7869 7329 290a 2020 2020 2020  x, axis)).      
+00021e40: 2020 656c 6966 2061 7869 7320 3c20 7365    elif axis < se
+00021e50: 6c66 2e6e 6469 6d3a 0a20 2020 2020 2020  lf.ndim:.       
+00021e60: 2020 2020 2072 6574 7572 6e20 506f 6c79       return Poly
+00021e70: 7661 6c28 5f74 616b 6528 7365 6c66 2e63  val(_take(self.c
+00021e80: 6f65 6666 732c 2069 6e64 6578 2c20 6178  oeffs, index, ax
+00021e90: 6973 202d 2073 656c 662e 706f 696e 7473  is - self.points
+00021ea0: 2e6e 6469 6d20 2b20 3129 2c20 7365 6c66  .ndim + 1), self
+00021eb0: 2e70 6f69 6e74 7329 0a0a 2020 2020 6465  .points)..    de
+00021ec0: 6620 5f73 696d 706c 6966 6965 6428 7365  f _simplified(se
+00021ed0: 6c66 293a 0a20 2020 2020 2020 206e 636f  lf):.        nco
+00021ee0: 6566 6673 5f6c 6f77 6572 2c20 6e63 6f65  effs_lower, ncoe
+00021ef0: 6666 735f 7570 7065 7220 3d20 7365 6c66  ffs_upper = self
+00021f00: 2e63 6f65 6666 732e 7368 6170 655b 2d31  .coeffs.shape[-1
+00021f10: 5d2e 5f69 6e74 626f 756e 6473 0a20 2020  ]._intbounds.   
+00021f20: 2020 2020 2069 6620 6973 7a65 726f 2873       if iszero(s
+00021f30: 656c 662e 636f 6566 6673 293a 0a20 2020  elf.coeffs):.   
+00021f40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00021f50: 7a65 726f 735f 6c69 6b65 2873 656c 6629  zeros_like(self)
+00021f60: 0a20 2020 2020 2020 2065 6c69 6620 5f65  .        elif _e
+00021f70: 7175 616c 735f 7363 616c 6172 5f63 6f6e  quals_scalar_con
+00021f80: 7374 616e 7428 7365 6c66 2e63 6f65 6666  stant(self.coeff
+00021f90: 732e 7368 6170 655b 2d31 5d2c 2031 293a  s.shape[-1], 1):
+00021fa0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00021fb0: 7572 6e20 7072 6570 656e 6461 7865 7328  urn prependaxes(
+00021fc0: 6765 7428 7365 6c66 2e63 6f65 6666 732c  get(self.coeffs,
+00021fd0: 202d 312c 2063 6f6e 7374 616e 7428 3029   -1, constant(0)
+00021fe0: 292c 2073 656c 662e 706f 696e 7473 2e73  ), self.points.s
+00021ff0: 6861 7065 5b3a 2d31 5d29 0a20 2020 2020  hape[:-1]).     
+00022000: 2020 2070 6f69 6e74 732c 2077 6865 7265     points, where
+00022010: 5f70 6f69 6e74 7320 3d20 756e 616c 6967  _points = unalig
+00022020: 6e28 7365 6c66 2e70 6f69 6e74 732c 206e  n(self.points, n
+00022030: 6178 6573 3d73 656c 662e 706f 696e 7473  axes=self.points
+00022040: 2e6e 6469 6d20 2d20 3129 0a20 2020 2020  .ndim - 1).     
+00022050: 2020 2063 6f65 6666 732c 2077 6865 7265     coeffs, where
+00022060: 5f63 6f65 6666 7320 3d20 756e 616c 6967  _coeffs = unalig
+00022070: 6e28 7365 6c66 2e63 6f65 6666 732c 206e  n(self.coeffs, n
+00022080: 6178 6573 3d73 656c 662e 636f 6566 6673  axes=self.coeffs
+00022090: 2e6e 6469 6d20 2d20 3129 0a20 2020 2020  .ndim - 1).     
+000220a0: 2020 2069 6620 6c65 6e28 7768 6572 655f     if len(where_
+000220b0: 706f 696e 7473 2920 2b20 6c65 6e28 7768  points) + len(wh
+000220c0: 6572 655f 636f 6566 6673 2920 3c20 7365  ere_coeffs) < se
+000220d0: 6c66 2e6e 6469 6d3a 0a20 2020 2020 2020  lf.ndim:.       
+000220e0: 2020 2020 2077 6865 7265 203d 202a 7768       where = *wh
+000220f0: 6572 655f 706f 696e 7473 2c20 2a28 6178  ere_points, *(ax
+00022100: 6973 202b 2073 656c 662e 706f 696e 7473  is + self.points
+00022110: 2e6e 6469 6d20 2d20 3120 666f 7220 6178  .ndim - 1 for ax
+00022120: 6973 2069 6e20 7768 6572 655f 636f 6566  is in where_coef
+00022130: 6673 290a 2020 2020 2020 2020 2020 2020  fs).            
+00022140: 7265 7475 726e 2061 6c69 676e 2850 6f6c  return align(Pol
+00022150: 7976 616c 2863 6f65 6666 732c 2070 6f69  yval(coeffs, poi
+00022160: 6e74 7329 2c20 7768 6572 652c 2073 656c  nts), where, sel
+00022170: 662e 7368 6170 6529 0a0a 0a63 6c61 7373  f.shape)...class
+00022180: 2050 6f6c 7944 6567 7265 6528 4172 7261   PolyDegree(Arra
+00022190: 7929 3a0a 2020 2020 2727 2752 6574 7572  y):.    '''Retur
+000221a0: 6e73 2074 6865 2064 6567 7265 6520 6f66  ns the degree of
+000221b0: 2061 2070 6f6c 796e 6f6d 6961 6c20 6769   a polynomial gi
+000221c0: 7665 6e20 7468 6520 6e75 6d62 6572 206f  ven the number o
+000221d0: 6620 636f 6566 6669 6369 656e 7473 2061  f coefficients a
+000221e0: 6e64 206e 756d 6265 7220 6f66 2076 6172  nd number of var
+000221f0: 6961 626c 6573 0a0a 2020 2020 4172 6773  iables..    Args
+00022200: 0a20 2020 202d 2d2d 2d0a 2020 2020 6e63  .    ----.    nc
+00022210: 6f65 6666 7320 3a20 3a63 6c61 7373 3a60  oeffs : :class:`
+00022220: 4172 7261 7960 0a20 2020 2020 2020 2054  Array`.        T
+00022230: 6865 206e 756d 6265 7220 6f66 2063 6f65  he number of coe
+00022240: 6666 6963 6965 6e74 7320 6f66 2074 6865  fficients of the
+00022250: 2070 6f6c 796e 6f6d 6961 6c2e 0a20 2020   polynomial..   
+00022260: 206e 7661 7273 203a 203a 636c 6173 733a   nvars : :class:
+00022270: 6069 6e74 600a 2020 2020 2020 2020 5468  `int`.        Th
+00022280: 6520 6e75 6d62 6572 206f 6620 7661 7269  e number of vari
+00022290: 6162 6c65 7320 6f66 2074 6865 2070 6f6c  ables of the pol
+000222a0: 796e 6f6d 6961 6c2e 0a0a 2020 2020 4e6f  ynomial...    No
+000222b0: 7465 730a 2020 2020 2d2d 2d2d 2d0a 0a20  tes.    -----.. 
+000222c0: 2020 2053 6565 203a 636c 6173 733a 6050     See :class:`P
+000222d0: 6f6c 7976 616c 6020 666f 7220 6120 6465  olyval` for a de
+000222e0: 6669 6e69 7469 6f6e 206f 6620 7468 6520  finition of the 
+000222f0: 706f 6c79 6e6f 6d69 616c 2e0a 2020 2020  polynomial..    
+00022300: 2727 270a 0a20 2020 2064 6566 205f 5f69  '''..    def __i
+00022310: 6e69 745f 5f28 7365 6c66 2c20 6e63 6f65  nit__(self, ncoe
+00022320: 6666 733a 2041 7272 6179 2c20 6e76 6172  ffs: Array, nvar
+00022330: 733a 2069 6e74 2920 2d3e 204e 6f6e 653a  s: int) -> None:
+00022340: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00022350: 6973 696e 7374 616e 6365 286e 636f 6566  isinstance(ncoef
+00022360: 6673 2c20 4172 7261 7929 2061 6e64 206e  fs, Array) and n
+00022370: 636f 6566 6673 2e6e 6469 6d20 3d3d 2030  coeffs.ndim == 0
+00022380: 2061 6e64 206e 636f 6566 6673 2e64 7479   and ncoeffs.dty
+00022390: 7065 203d 3d20 696e 742c 2027 6e63 6f65  pe == int, 'ncoe
+000223a0: 6666 733d 7b6e 636f 6566 6673 2172 7d27  ffs={ncoeffs!r}'
+000223b0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000223c0: 6973 696e 7374 616e 6365 286e 7661 7273  isinstance(nvars
+000223d0: 2c20 696e 7429 2061 6e64 206e 7661 7273  , int) and nvars
+000223e0: 203e 3d20 302c 2027 6e76 6172 733d 7b6e   >= 0, 'nvars={n
+000223f0: 7661 7273 2172 7d27 0a20 2020 2020 2020  vars!r}'.       
+00022400: 2073 656c 662e 6e63 6f65 6666 7320 3d20   self.ncoeffs = 
+00022410: 6e63 6f65 6666 730a 2020 2020 2020 2020  ncoeffs.        
+00022420: 7365 6c66 2e6e 7661 7273 203d 206e 7661  self.nvars = nva
+00022430: 7273 0a20 2020 2020 2020 2073 7570 6572  rs.        super
+00022440: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
+00022450: 3d28 6e63 6f65 6666 732c 292c 2073 6861  =(ncoeffs,), sha
+00022460: 7065 3d28 292c 2064 7479 7065 3d69 6e74  pe=(), dtype=int
+00022470: 290a 0a20 2020 2064 6566 2065 7661 6c66  )..    def evalf
+00022480: 2873 656c 662c 206e 636f 6566 6673 293a  (self, ncoeffs):
+00022490: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000224a0: 6e75 6d70 792e 6172 7261 7928 706f 6c79  numpy.array(poly
+000224b0: 2e64 6567 7265 6528 7365 6c66 2e6e 7661  .degree(self.nva
+000224c0: 7273 2c20 6e63 6f65 6666 732e 5f5f 696e  rs, ncoeffs.__in
+000224d0: 6465 785f 5f28 2929 290a 0a20 2020 2064  dex__()))..    d
+000224e0: 6566 205f 696e 7462 6f75 6e64 735f 696d  ef _intbounds_im
+000224f0: 706c 2873 656c 6629 3a0a 2020 2020 2020  pl(self):.      
+00022500: 2020 6c6f 7765 722c 2075 7070 6572 203d    lower, upper =
+00022510: 2073 656c 662e 6e63 6f65 6666 732e 5f69   self.ncoeffs._i
+00022520: 6e74 626f 756e 6473 0a20 2020 2020 2020  ntbounds.       
+00022530: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00022540: 2020 6c6f 7765 7220 3d20 706f 6c79 2e64    lower = poly.d
+00022550: 6567 7265 6528 7365 6c66 2e6e 7661 7273  egree(self.nvars
+00022560: 2c20 6c6f 7765 7229 0a20 2020 2020 2020  , lower).       
+00022570: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+00022580: 2020 2020 206c 6f77 6572 203d 2030 0a20       lower = 0. 
+00022590: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000225a0: 2020 2020 2020 2020 7570 7065 7220 3d20          upper = 
+000225b0: 706f 6c79 2e64 6567 7265 6528 7365 6c66  poly.degree(self
+000225c0: 2e6e 7661 7273 2c20 7570 7065 7229 0a20  .nvars, upper). 
+000225d0: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+000225e0: 2020 2020 2020 2020 2020 2075 7070 6572             upper
+000225f0: 203d 2066 6c6f 6174 2827 696e 6627 290a   = float('inf').
+00022600: 2020 2020 2020 2020 7265 7475 726e 206c          return l
+00022610: 6f77 6572 2c20 7570 7065 720a 0a0a 636c  ower, upper...cl
+00022620: 6173 7320 506f 6c79 4e43 6f65 6666 7328  ass PolyNCoeffs(
+00022630: 4172 7261 7929 3a0a 2020 2020 2727 2752  Array):.    '''R
+00022640: 6574 7572 6e73 2074 6865 206e 756d 6265  eturns the numbe
+00022650: 7220 6f66 2063 6f65 6666 6963 6965 6e74  r of coefficient
+00022660: 7320 666f 7220 6120 706f 6c79 6e6f 6d69  s for a polynomi
+00022670: 616c 206f 6620 6769 7665 6e20 6465 6772  al of given degr
+00022680: 6565 2061 6e64 206e 756d 6265 7220 6f66  ee and number of
+00022690: 2076 6172 6961 626c 6573 0a0a 2020 2020   variables..    
+000226a0: 4172 6773 0a20 2020 202d 2d2d 2d0a 2020  Args.    ----.  
+000226b0: 2020 6e76 6172 7320 3a20 3a63 6c61 7373    nvars : :class
+000226c0: 3a60 696e 7460 0a20 2020 2020 2020 2054  :`int`.        T
+000226d0: 6865 206e 756d 6265 7220 6f66 2076 6172  he number of var
+000226e0: 6961 626c 6573 206f 6620 7468 6520 706f  iables of the po
+000226f0: 6c79 6e6f 6d69 616c 2e0a 2020 2020 6465  lynomial..    de
+00022700: 6772 6565 203a 203a 636c 6173 733a 6041  gree : :class:`A
+00022710: 7272 6179 600a 2020 2020 2020 2020 5468  rray`.        Th
+00022720: 6520 6465 6772 6565 206f 6620 7468 6520  e degree of the 
+00022730: 706f 6c79 6e6f 6d69 616c 2e0a 0a20 2020  polynomial...   
+00022740: 204e 6f74 6573 0a20 2020 202d 2d2d 2d2d   Notes.    -----
+00022750: 0a0a 2020 2020 5365 6520 3a63 6c61 7373  ..    See :class
+00022760: 3a60 506f 6c79 7661 6c60 2066 6f72 2061  :`Polyval` for a
+00022770: 2064 6566 696e 6974 696f 6e20 6f66 2074   definition of t
+00022780: 6865 2070 6f6c 796e 6f6d 6961 6c2e 0a20  he polynomial.. 
+00022790: 2020 2027 2727 0a0a 2020 2020 6465 6620     '''..    def 
+000227a0: 5f5f 696e 6974 5f5f 2873 656c 662c 206e  __init__(self, n
+000227b0: 7661 7273 3a20 696e 742c 2064 6567 7265  vars: int, degre
+000227c0: 653a 2041 7272 6179 2920 2d3e 204e 6f6e  e: Array) -> Non
+000227d0: 653a 0a20 2020 2020 2020 2061 7373 6572  e:.        asser
+000227e0: 7420 6973 696e 7374 616e 6365 2864 6567  t isinstance(deg
+000227f0: 7265 652c 2041 7272 6179 2920 616e 6420  ree, Array) and 
+00022800: 6465 6772 6565 2e6e 6469 6d20 3d3d 2030  degree.ndim == 0
+00022810: 2061 6e64 2064 6567 7265 652e 6474 7970   and degree.dtyp
+00022820: 6520 3d3d 2069 6e74 2c20 6627 6465 6772  e == int, f'degr
+00022830: 6565 3d7b 6465 6772 6565 2172 7d27 0a20  ee={degree!r}'. 
+00022840: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+00022850: 696e 7374 616e 6365 286e 7661 7273 2c20  instance(nvars, 
+00022860: 696e 7429 2061 6e64 206e 7661 7273 203e  int) and nvars >
+00022870: 3d20 302c 2027 6e76 6172 733d 7b6e 7661  = 0, 'nvars={nva
+00022880: 7273 2172 7d27 0a20 2020 2020 2020 2073  rs!r}'.        s
+00022890: 656c 662e 6e76 6172 7320 3d20 6e76 6172  elf.nvars = nvar
+000228a0: 730a 2020 2020 2020 2020 7365 6c66 2e64  s.        self.d
+000228b0: 6567 7265 6520 3d20 6465 6772 6565 0a20  egree = degree. 
+000228c0: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
+000228d0: 5f69 6e69 745f 5f28 6172 6773 3d28 6465  _init__(args=(de
+000228e0: 6772 6565 2c29 2c20 7368 6170 653d 2829  gree,), shape=()
+000228f0: 2c20 6474 7970 653d 696e 7429 0a0a 2020  , dtype=int)..  
+00022900: 2020 6465 6620 6576 616c 6628 7365 6c66    def evalf(self
+00022910: 2c20 6465 6772 6565 293a 0a20 2020 2020  , degree):.     
+00022920: 2020 2072 6574 7572 6e20 6e75 6d70 792e     return numpy.
+00022930: 6172 7261 7928 706f 6c79 2e6e 636f 6566  array(poly.ncoef
+00022940: 6673 2873 656c 662e 6e76 6172 732c 2064  fs(self.nvars, d
+00022950: 6567 7265 652e 5f5f 696e 6465 785f 5f28  egree.__index__(
+00022960: 2929 290a 0a20 2020 2064 6566 205f 696e  )))..    def _in
+00022970: 7462 6f75 6e64 735f 696d 706c 2873 656c  tbounds_impl(sel
+00022980: 6629 3a0a 2020 2020 2020 2020 6c6f 7765  f):.        lowe
+00022990: 722c 2075 7070 6572 203d 2073 656c 662e  r, upper = self.
+000229a0: 6465 6772 6565 2e5f 696e 7462 6f75 6e64  degree._intbound
+000229b0: 730a 2020 2020 2020 2020 6966 2069 7369  s.        if isi
+000229c0: 6e73 7461 6e63 6528 6c6f 7765 722c 2069  nstance(lower, i
+000229d0: 6e74 2920 616e 6420 6c6f 7765 7220 3e3d  nt) and lower >=
+000229e0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+000229f0: 6c6f 7765 7220 3d20 706f 6c79 2e6e 636f  lower = poly.nco
+00022a00: 6566 6673 2873 656c 662e 6e76 6172 732c  effs(self.nvars,
+00022a10: 206c 6f77 6572 290a 2020 2020 2020 2020   lower).        
+00022a20: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00022a30: 2020 6c6f 7765 7220 3d20 300a 2020 2020    lower = 0.    
+00022a40: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00022a50: 6528 7570 7065 722c 2069 6e74 2920 616e  e(upper, int) an
+00022a60: 6420 7570 7065 7220 3e3d 2030 3a0a 2020  d upper >= 0:.  
+00022a70: 2020 2020 2020 2020 2020 7570 7065 7220            upper 
+00022a80: 3d20 706f 6c79 2e6e 636f 6566 6673 2873  = poly.ncoeffs(s
+00022a90: 656c 662e 6e76 6172 732c 2075 7070 6572  elf.nvars, upper
+00022aa0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00022ab0: 2020 2020 2020 2020 2020 2020 7570 7065              uppe
+00022ac0: 7220 3d20 666c 6f61 7428 2769 6e66 2729  r = float('inf')
+00022ad0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00022ae0: 6c6f 7765 722c 2075 7070 6572 0a0a 0a63  lower, upper...c
+00022af0: 6c61 7373 2050 6f6c 794d 756c 2841 7272  lass PolyMul(Arr
+00022b00: 6179 293a 0a20 2020 2027 2727 436f 6d70  ay):.    '''Comp
+00022b10: 7574 6520 7468 6520 636f 6566 6669 6369  ute the coeffici
+00022b20: 656e 7473 2066 6f72 2074 6865 2070 726f  ents for the pro
+00022b30: 6475 6374 206f 6620 7477 6f20 706f 6c79  duct of two poly
+00022b40: 6e6f 6d69 616c 730a 0a20 2020 2052 6574  nomials..    Ret
+00022b50: 7572 6e20 7468 6520 636f 6566 6669 6369  urn the coeffici
+00022b60: 656e 7473 2073 7563 6820 7468 6174 2063  ents such that c
+00022b70: 616c 6c69 6e67 203a 636c 6173 733a 6050  alling :class:`P
+00022b80: 6f6c 7976 616c 6020 6f6e 2074 6869 7320  olyval` on this 
+00022b90: 7265 7375 6c74 0a20 2020 2069 7320 6571  result.    is eq
+00022ba0: 7561 6c20 746f 2074 6865 2070 726f 6475  ual to the produ
+00022bb0: 6374 206f 6620 3a63 6c61 7373 3a60 506f  ct of :class:`Po
+00022bc0: 6c79 7661 6c60 2063 616c 6c65 6420 6f6e  lyval` called on
+00022bd0: 2074 6865 2069 6e64 6976 6964 7561 6c20   the individual 
+00022be0: 6172 7261 7973 0a20 2020 206f 6620 636f  arrays.    of co
+00022bf0: 6566 6669 6369 656e 7473 2028 7769 7468  efficients (with
+00022c00: 2074 6865 2061 7070 726f 7072 6961 7465   the appropriate
+00022c10: 2073 656c 6563 7469 6f6e 206f 6620 7468   selection of th
+00022c20: 6520 7661 7269 6162 6c65 7320 6173 0a20  e variables as. 
+00022c30: 2020 2064 6573 6372 6962 6564 2062 7920     described by 
+00022c40: 7061 7261 6d65 7465 7220 6060 7661 7273  parameter ``vars
+00022c50: 6060 292e 0a0a 2020 2020 4172 6773 0a20  ``)...    Args. 
+00022c60: 2020 202d 2d2d 2d0a 2020 2020 636f 6566     ----.    coef
+00022c70: 6673 5f6c 6566 7420 3a20 3a63 6c61 7373  fs_left : :class
+00022c80: 3a60 4172 7261 7960 0a20 2020 2020 2020  :`Array`.       
+00022c90: 2054 6865 2063 6f65 6666 6963 6965 6e74   The coefficient
+00022ca0: 7320 666f 7220 7468 6520 6c65 6674 206f  s for the left o
+00022cb0: 7065 7261 6e64 2e20 5468 6520 6c61 7374  perand. The last
+00022cc0: 2061 7869 7320 6973 2074 7265 6174 6564   axis is treated
+00022cd0: 2061 7320 7468 650a 2020 2020 2020 2020   as the.        
+00022ce0: 636f 6566 6669 6369 656e 7473 2061 7869  coefficients axi
+00022cf0: 732e 0a20 2020 2063 6f65 6666 735f 7269  s..    coeffs_ri
+00022d00: 6768 7420 3a20 3a63 6c61 7373 3a60 4172  ght : :class:`Ar
+00022d10: 7261 7960 0a20 2020 2020 2020 2054 6865  ray`.        The
+00022d20: 2063 6f65 6666 6963 6965 6e74 7320 666f   coefficients fo
+00022d30: 7220 7468 6520 7269 6768 7420 6f70 6572  r the right oper
+00022d40: 616e 642e 2054 6865 206c 6173 7420 6178  and. The last ax
+00022d50: 6973 2069 7320 7472 6561 7465 6420 6173  is is treated as
+00022d60: 2074 6865 0a20 2020 2020 2020 2063 6f65   the.        coe
+00022d70: 6666 6963 6965 6e74 7320 6178 6973 2e0a  fficients axis..
+00022d80: 2020 2020 7661 7273 203a 203a 636c 6173      vars : :clas
+00022d90: 733a 6074 7570 6c65 6020 6f66 2060 606e  s:`tuple` of ``n
+00022da0: 7574 696c 735f 706f 6c79 2e4d 756c 5661  utils_poly.MulVa
+00022db0: 7260 600a 2020 2020 2020 2020 466f 7220  r``.        For 
+00022dc0: 6561 6368 2076 6172 6961 626c 6520 6f66  each variable of
+00022dd0: 2074 6869 7320 7072 6f64 7563 742c 2060   this product, `
+00022de0: 6076 6172 6060 2064 6566 696e 6573 2069  `var`` defines i
+00022df0: 6620 7468 6520 7661 7269 6162 6c65 0a20  f the variable. 
+00022e00: 2020 2020 2020 2065 7869 7374 7320 696e         exists in
+00022e10: 2074 6865 206c 6566 7420 706f 6c79 6e6f   the left polyno
+00022e20: 6d69 616c 2c20 7468 6520 7269 6768 7420  mial, the right 
+00022e30: 6f72 2062 6f74 682e 0a0a 2020 2020 4e6f  or both...    No
+00022e40: 7465 730a 2020 2020 2d2d 2d2d 2d0a 0a20  tes.    -----.. 
+00022e50: 2020 2053 6565 203a 636c 6173 733a 6050     See :class:`P
+00022e60: 6f6c 7976 616c 6020 666f 7220 6120 6465  olyval` for a de
+00022e70: 6669 6e69 7469 6f6e 206f 6620 7468 6520  finition of the 
+00022e80: 706f 6c79 6e6f 6d69 616c 2e0a 2020 2020  polynomial..    
+00022e90: 2727 270a 0a20 2020 2064 6566 205f 5f69  '''..    def __i
+00022ea0: 6e69 745f 5f28 7365 6c66 2c20 636f 6566  nit__(self, coef
+00022eb0: 6673 5f6c 6566 743a 2041 7272 6179 2c20  fs_left: Array, 
+00022ec0: 636f 6566 6673 5f72 6967 6874 3a20 4172  coeffs_right: Ar
+00022ed0: 7261 792c 2076 6172 733a 2074 7970 696e  ray, vars: typin
+00022ee0: 672e 5475 706c 655b 706f 6c79 2e4d 756c  g.Tuple[poly.Mul
+00022ef0: 5661 722c 202e 2e2e 5d29 3a0a 2020 2020  Var, ...]):.    
+00022f00: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+00022f10: 7461 6e63 6528 636f 6566 6673 5f6c 6566  tance(coeffs_lef
+00022f20: 742c 2041 7272 6179 2920 616e 6420 636f  t, Array) and co
+00022f30: 6566 6673 5f6c 6566 742e 6e64 696d 203e  effs_left.ndim >
+00022f40: 3d20 3120 616e 6420 636f 6566 6673 5f6c  = 1 and coeffs_l
+00022f50: 6566 742e 6474 7970 6520 3d3d 2066 6c6f  eft.dtype == flo
+00022f60: 6174 2c20 6627 636f 6566 6673 5f6c 6566  at, f'coeffs_lef
+00022f70: 743d 7b63 6f65 6666 735f 6c65 6674 2172  t={coeffs_left!r
+00022f80: 7d27 0a20 2020 2020 2020 2061 7373 6572  }'.        asser
+00022f90: 7420 6973 696e 7374 616e 6365 2863 6f65  t isinstance(coe
+00022fa0: 6666 735f 7269 6768 742c 2041 7272 6179  ffs_right, Array
+00022fb0: 2920 616e 6420 636f 6566 6673 5f72 6967  ) and coeffs_rig
+00022fc0: 6874 2e6e 6469 6d20 3e3d 2031 2061 6e64  ht.ndim >= 1 and
+00022fd0: 2063 6f65 6666 735f 7269 6768 742e 6474   coeffs_right.dt
+00022fe0: 7970 6520 3d3d 2066 6c6f 6174 2c20 6627  ype == float, f'
+00022ff0: 636f 6566 6673 5f72 6967 6874 3d7b 636f  coeffs_right={co
+00023000: 6566 6673 5f72 6967 6874 2172 7d27 0a20  effs_right!r}'. 
+00023010: 2020 2020 2020 2061 7373 6572 7420 6571         assert eq
+00023020: 7561 6c73 6861 7065 2863 6f65 6666 735f  ualshape(coeffs_
+00023030: 6c65 6674 2e73 6861 7065 5b3a 2d31 5d2c  left.shape[:-1],
+00023040: 2063 6f65 6666 735f 7269 6768 742e 7368   coeffs_right.sh
+00023050: 6170 655b 3a2d 315d 292c 2027 506f 6c79  ape[:-1]), 'Poly
+00023060: 4d75 6c28 7b7d 2c20 7b7d 2927 2e66 6f72  Mul({}, {})'.for
+00023070: 6d61 7428 636f 6566 6673 5f6c 6566 742c  mat(coeffs_left,
+00023080: 2063 6f65 6666 735f 7269 6768 7429 0a20   coeffs_right). 
+00023090: 2020 2020 2020 2073 656c 662e 636f 6566         self.coef
+000230a0: 6673 5f6c 6566 7420 3d20 636f 6566 6673  fs_left = coeffs
+000230b0: 5f6c 6566 740a 2020 2020 2020 2020 7365  _left.        se
+000230c0: 6c66 2e63 6f65 6666 735f 7269 6768 7420  lf.coeffs_right 
+000230d0: 3d20 636f 6566 6673 5f72 6967 6874 0a20  = coeffs_right. 
+000230e0: 2020 2020 2020 2073 656c 662e 7661 7273         self.vars
+000230f0: 203d 2076 6172 730a 2020 2020 2020 2020   = vars.        
+00023100: 7365 6c66 2e64 6567 7265 655f 6c65 6674  self.degree_left
+00023110: 203d 2050 6f6c 7944 6567 7265 6528 636f   = PolyDegree(co
+00023120: 6566 6673 5f6c 6566 742e 7368 6170 655b  effs_left.shape[
+00023130: 2d31 5d2c 2062 7569 6c74 696e 732e 7375  -1], builtins.su
+00023140: 6d28 7661 7220 213d 2070 6f6c 792e 4d75  m(var != poly.Mu
+00023150: 6c56 6172 2e52 6967 6874 2066 6f72 2076  lVar.Right for v
+00023160: 6172 2069 6e20 7661 7273 2929 0a20 2020  ar in vars)).   
+00023170: 2020 2020 2073 656c 662e 6465 6772 6565       self.degree
+00023180: 5f72 6967 6874 203d 2050 6f6c 7944 6567  _right = PolyDeg
+00023190: 7265 6528 636f 6566 6673 5f72 6967 6874  ree(coeffs_right
+000231a0: 2e73 6861 7065 5b2d 315d 2c20 6275 696c  .shape[-1], buil
+000231b0: 7469 6e73 2e73 756d 2876 6172 2021 3d20  tins.sum(var != 
+000231c0: 706f 6c79 2e4d 756c 5661 722e 4c65 6674  poly.MulVar.Left
+000231d0: 2066 6f72 2076 6172 2069 6e20 7661 7273   for var in vars
+000231e0: 2929 0a20 2020 2020 2020 206e 636f 6566  )).        ncoef
+000231f0: 6673 203d 2050 6f6c 794e 436f 6566 6673  fs = PolyNCoeffs
+00023200: 286c 656e 2876 6172 7329 2c20 7365 6c66  (len(vars), self
+00023210: 2e64 6567 7265 655f 6c65 6674 202b 2073  .degree_left + s
+00023220: 656c 662e 6465 6772 6565 5f72 6967 6874  elf.degree_right
+00023230: 290a 2020 2020 2020 2020 7375 7065 7228  ).        super(
+00023240: 292e 5f5f 696e 6974 5f5f 2861 7267 733d  ).__init__(args=
+00023250: 2863 6f65 6666 735f 6c65 6674 2c20 636f  (coeffs_left, co
+00023260: 6566 6673 5f72 6967 6874 292c 2073 6861  effs_right), sha
+00023270: 7065 3d28 2a63 6f65 6666 735f 6c65 6674  pe=(*coeffs_left
+00023280: 2e73 6861 7065 5b3a 2d31 5d2c 206e 636f  .shape[:-1], nco
+00023290: 6566 6673 292c 2064 7479 7065 3d66 6c6f  effs), dtype=flo
+000232a0: 6174 290a 0a20 2020 2040 6361 6368 6564  at)..    @cached
+000232b0: 5f70 726f 7065 7274 790a 2020 2020 6465  _property.    de
+000232c0: 6620 6576 616c 6628 7365 6c66 293a 0a20  f evalf(self):. 
+000232d0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000232e0: 2020 2020 2020 2020 6465 6772 6565 5f6c          degree_l
+000232f0: 6566 7420 3d20 7365 6c66 2e64 6567 7265  eft = self.degre
+00023300: 655f 6c65 6674 2e5f 5f69 6e64 6578 5f5f  e_left.__index__
+00023310: 2829 0a20 2020 2020 2020 2020 2020 2064  ().            d
+00023320: 6567 7265 655f 7269 6768 7420 3d20 7365  egree_right = se
+00023330: 6c66 2e64 6567 7265 655f 7269 6768 742e  lf.degree_right.
+00023340: 5f5f 696e 6465 785f 5f28 290a 2020 2020  __index__().    
+00023350: 2020 2020 6578 6365 7074 2054 7970 6545      except TypeE
+00023360: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+00023370: 2020 2020 2020 2072 6574 7572 6e20 6675         return fu
+00023380: 6e63 746f 6f6c 732e 7061 7274 6961 6c28  nctools.partial(
+00023390: 706f 6c79 2e6d 756c 2c20 7661 7273 3d73  poly.mul, vars=s
+000233a0: 656c 662e 7661 7273 290a 2020 2020 2020  elf.vars).      
+000233b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000233c0: 2020 2020 7265 7475 726e 2070 6f6c 792e      return poly.
+000233d0: 4d75 6c50 6c61 6e28 7365 6c66 2e76 6172  MulPlan(self.var
+000233e0: 732c 2064 6567 7265 655f 6c65 6674 2c20  s, degree_left, 
+000233f0: 6465 6772 6565 5f72 6967 6874 290a 0a20  degree_right).. 
+00023400: 2020 2064 6566 205f 7369 6d70 6c69 6669     def _simplifi
+00023410: 6564 2873 656c 6629 3a0a 2020 2020 2020  ed(self):.      
+00023420: 2020 6966 2069 737a 6572 6f28 7365 6c66    if iszero(self
+00023430: 2e63 6f65 6666 735f 6c65 6674 2920 6f72  .coeffs_left) or
+00023440: 2069 737a 6572 6f28 7365 6c66 2e63 6f65   iszero(self.coe
+00023450: 6666 735f 7269 6768 7429 3a0a 2020 2020  ffs_right):.    
+00023460: 2020 2020 2020 2020 7265 7475 726e 207a          return z
+00023470: 6572 6f73 5f6c 696b 6528 7365 6c66 290a  eros_like(self).
+00023480: 0a20 2020 2064 6566 205f 7461 6b65 6469  .    def _takedi
+00023490: 6167 2873 656c 662c 2061 7869 7331 2c20  ag(self, axis1, 
+000234a0: 6178 6973 3229 3a0a 2020 2020 2020 2020  axis2):.        
+000234b0: 6966 2061 7869 7331 203c 2073 656c 662e  if axis1 < self.
+000234c0: 6e64 696d 202d 2031 2061 6e64 2061 7869  ndim - 1 and axi
+000234d0: 7332 203c 2073 656c 662e 6e64 696d 202d  s2 < self.ndim -
+000234e0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+000234f0: 636f 6566 6673 5f6c 6566 7420 3d20 5472  coeffs_left = Tr
+00023500: 616e 7370 6f73 652e 746f 5f65 6e64 285f  anspose.to_end(_
+00023510: 7461 6b65 6469 6167 2873 656c 662e 636f  takediag(self.co
+00023520: 6566 6673 5f6c 6566 742c 2061 7869 7331  effs_left, axis1
+00023530: 2c20 6178 6973 3229 2c20 2d32 290a 2020  , axis2), -2).  
+00023540: 2020 2020 2020 2020 2020 636f 6566 6673            coeffs
+00023550: 5f72 6967 6874 203d 2054 7261 6e73 706f  _right = Transpo
+00023560: 7365 2e74 6f5f 656e 6428 5f74 616b 6564  se.to_end(_taked
+00023570: 6961 6728 7365 6c66 2e63 6f65 6666 735f  iag(self.coeffs_
+00023580: 7269 6768 742c 2061 7869 7331 2c20 6178  right, axis1, ax
+00023590: 6973 3229 2c20 2d32 290a 2020 2020 2020  is2), -2).      
+000235a0: 2020 2020 2020 7265 7475 726e 2054 7261        return Tra
+000235b0: 6e73 706f 7365 2e74 6f5f 656e 6428 506f  nspose.to_end(Po
+000235c0: 6c79 4d75 6c28 636f 6566 6673 5f6c 6566  lyMul(coeffs_lef
+000235d0: 742c 2063 6f65 6666 735f 7269 6768 742c  t, coeffs_right,
+000235e0: 2073 656c 662e 7661 7273 292c 202d 3229   self.vars), -2)
+000235f0: 0a0a 2020 2020 6465 6620 5f74 616b 6528  ..    def _take(
+00023600: 7365 6c66 2c20 696e 6465 782c 2061 7869  self, index, axi
+00023610: 7329 3a0a 2020 2020 2020 2020 6966 2061  s):.        if a
+00023620: 7869 7320 3c20 7365 6c66 2e6e 6469 6d20  xis < self.ndim 
+00023630: 2d20 313a 0a20 2020 2020 2020 2020 2020  - 1:.           
+00023640: 2072 6574 7572 6e20 506f 6c79 4d75 6c28   return PolyMul(
+00023650: 5f74 616b 6528 7365 6c66 2e63 6f65 6666  _take(self.coeff
+00023660: 735f 6c65 6674 2c20 696e 6465 782c 2061  s_left, index, a
+00023670: 7869 7329 2c20 5f74 616b 6528 7365 6c66  xis), _take(self
+00023680: 2e63 6f65 6666 735f 7269 6768 742c 2069  .coeffs_right, i
+00023690: 6e64 6578 2c20 6178 6973 292c 2073 656c  ndex, axis), sel
+000236a0: 662e 7661 7273 290a 0a20 2020 2064 6566  f.vars)..    def
+000236b0: 205f 756e 7261 7665 6c28 7365 6c66 2c20   _unravel(self, 
+000236c0: 6178 6973 2c20 7368 6170 6529 3a0a 2020  axis, shape):.  
+000236d0: 2020 2020 2020 6966 2061 7869 7320 3c20        if axis < 
+000236e0: 7365 6c66 2e6e 6469 6d20 2d20 313a 0a20  self.ndim - 1:. 
+000236f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00023700: 6e20 506f 6c79 4d75 6c28 756e 7261 7665  n PolyMul(unrave
+00023710: 6c28 7365 6c66 2e63 6f65 6666 735f 6c65  l(self.coeffs_le
+00023720: 6674 2c20 6178 6973 2c20 7368 6170 6529  ft, axis, shape)
+00023730: 2c20 756e 7261 7665 6c28 7365 6c66 2e63  , unravel(self.c
+00023740: 6f65 6666 735f 7269 6768 742c 2061 7869  oeffs_right, axi
+00023750: 732c 2073 6861 7065 292c 2073 656c 662e  s, shape), self.
+00023760: 7661 7273 290a 0a0a 636c 6173 7320 506f  vars)...class Po
+00023770: 6c79 4772 6164 2841 7272 6179 293a 0a20  lyGrad(Array):. 
+00023780: 2020 2027 2727 436f 6d70 7574 6520 7468     '''Compute th
+00023790: 6520 636f 6566 6669 6369 656e 7473 2066  e coefficients f
+000237a0: 6f72 2074 6865 2067 7261 6469 656e 7420  or the gradient 
+000237b0: 6f66 2061 2070 6f6c 796e 6f6d 6961 6c0a  of a polynomial.
+000237c0: 0a20 2020 2054 6865 206c 6173 7420 7477  .    The last tw
+000237d0: 6f20 6178 6573 206f 6620 7468 6973 2061  o axes of this a
+000237e0: 7272 6179 2061 7265 2074 6865 2061 7869  rray are the axi
+000237f0: 7320 6f66 2076 6172 6961 626c 6573 2061  s of variables a
+00023800: 6e64 2074 6865 2061 7869 7320 6f66 0a20  nd the axis of. 
+00023810: 2020 2063 6f65 6666 6963 6965 6e74 732e     coefficients.
+00023820: 0a0a 2020 2020 4172 6773 0a20 2020 202d  ..    Args.    -
+00023830: 2d2d 2d0a 2020 2020 636f 6566 6673 203a  ---.    coeffs :
+00023840: 203a 636c 6173 733a 6041 7272 6179 600a   :class:`Array`.
+00023850: 2020 2020 2020 2020 5468 6520 636f 6566          The coef
+00023860: 6669 6369 656e 7473 206f 6620 7468 6520  ficients of the 
+00023870: 706f 6c79 6e6f 6d69 616c 2074 6f20 636f  polynomial to co
+00023880: 6d70 7574 6520 7468 6520 6772 6164 6965  mpute the gradie
+00023890: 6e74 2066 6f72 2e20 5468 650a 2020 2020  nt for. The.    
+000238a0: 2020 2020 6c61 7374 2061 7869 7320 6973      last axis is
+000238b0: 2074 7265 6174 6564 2061 7320 7468 6520   treated as the 
+000238c0: 636f 6566 6669 6369 656e 7473 2061 7869  coefficients axi
+000238d0: 732e 0a20 2020 206e 7661 7273 203a 203a  s..    nvars : :
+000238e0: 636c 6173 733a 6069 6e74 600a 2020 2020  class:`int`.    
+000238f0: 2020 2020 5468 6520 6e75 6d62 6572 206f      The number o
+00023900: 6620 7661 7269 6162 6c65 7320 6f66 2074  f variables of t
+00023910: 6865 2070 6f6c 796e 6f6d 6961 6c2e 0a0a  he polynomial...
+00023920: 2020 2020 4e6f 7465 730a 2020 2020 2d2d      Notes.    --
+00023930: 2d2d 2d0a 0a20 2020 2053 6565 203a 636c  ---..    See :cl
+00023940: 6173 733a 6050 6f6c 7976 616c 6020 666f  ass:`Polyval` fo
+00023950: 7220 6120 6465 6669 6e69 7469 6f6e 206f  r a definition o
+00023960: 6620 7468 6520 706f 6c79 6e6f 6d69 616c  f the polynomial
+00023970: 2e0a 2020 2020 2727 270a 0a20 2020 2064  ..    '''..    d
+00023980: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00023990: 2c20 636f 6566 6673 3a20 4172 7261 792c  , coeffs: Array,
+000239a0: 206e 7661 7273 3a20 696e 7429 3a0a 2020   nvars: int):.  
+000239b0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+000239c0: 6e73 7461 6e63 6528 636f 6566 6673 2c20  nstance(coeffs, 
+000239d0: 4172 7261 7929 2061 6e64 2063 6f65 6666  Array) and coeff
+000239e0: 732e 6474 7970 6520 3d3d 2066 6c6f 6174  s.dtype == float
+000239f0: 2061 6e64 2063 6f65 6666 732e 6e64 696d   and coeffs.ndim
+00023a00: 203e 3d20 312c 2066 2763 6f65 6666 733d   >= 1, f'coeffs=
+00023a10: 7b63 6f65 6666 7321 727d 270a 2020 2020  {coeffs!r}'.    
+00023a20: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+00023a30: 7461 6e63 6528 6e76 6172 732c 2069 6e74  tance(nvars, int
+00023a40: 2920 616e 6420 6e76 6172 7320 3e3d 2030  ) and nvars >= 0
+00023a50: 2c20 6627 6e76 6172 733d 7b6e 7661 7273  , f'nvars={nvars
+00023a60: 2172 7d27 0a20 2020 2020 2020 2073 656c  !r}'.        sel
+00023a70: 662e 636f 6566 6673 203d 2063 6f65 6666  f.coeffs = coeff
+00023a80: 730a 2020 2020 2020 2020 7365 6c66 2e6e  s.        self.n
+00023a90: 7661 7273 203d 206e 7661 7273 0a20 2020  vars = nvars.   
+00023aa0: 2020 2020 2073 656c 662e 6465 6772 6565       self.degree
+00023ab0: 203d 2050 6f6c 7944 6567 7265 6528 636f   = PolyDegree(co
+00023ac0: 6566 6673 2e73 6861 7065 5b2d 315d 2c20  effs.shape[-1], 
+00023ad0: 6e76 6172 7329 0a20 2020 2020 2020 206e  nvars).        n
+00023ae0: 636f 6566 6673 203d 2050 6f6c 794e 436f  coeffs = PolyNCo
+00023af0: 6566 6673 286e 7661 7273 2c20 4d61 7869  effs(nvars, Maxi
+00023b00: 6d75 6d28 636f 6e73 7461 6e74 2830 292c  mum(constant(0),
+00023b10: 2073 656c 662e 6465 6772 6565 202d 2063   self.degree - c
+00023b20: 6f6e 7374 616e 7428 3129 2929 0a20 2020  onstant(1))).   
+00023b30: 2020 2020 2073 6861 7065 203d 202a 636f       shape = *co
+00023b40: 6566 6673 2e73 6861 7065 5b3a 2d31 5d2c  effs.shape[:-1],
+00023b50: 2063 6f6e 7374 616e 7428 6e76 6172 7329   constant(nvars)
+00023b60: 2c20 6e63 6f65 6666 730a 2020 2020 2020  , ncoeffs.      
+00023b70: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00023b80: 5f5f 2861 7267 733d 2863 6f65 6666 732c  __(args=(coeffs,
+00023b90: 292c 2073 6861 7065 3d73 6861 7065 2c20  ), shape=shape, 
+00023ba0: 6474 7970 653d 666c 6f61 7429 0a0a 2020  dtype=float)..  
+00023bb0: 2020 4063 6163 6865 645f 7072 6f70 6572    @cached_proper
+00023bc0: 7479 0a20 2020 2064 6566 2065 7661 6c66  ty.    def evalf
+00023bd0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00023be0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00023bf0: 2064 6567 7265 6520 3d20 7365 6c66 2e64   degree = self.d
+00023c00: 6567 7265 652e 5f5f 696e 6465 785f 5f28  egree.__index__(
+00023c10: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+00023c20: 2054 7970 6545 7272 6f72 2061 7320 653a   TypeError as e:
+00023c30: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00023c40: 7572 6e20 6675 6e63 746f 6f6c 732e 7061  urn functools.pa
+00023c50: 7274 6961 6c28 706f 6c79 2e67 7261 642c  rtial(poly.grad,
+00023c60: 206e 7661 7273 3d73 656c 662e 6e76 6172   nvars=self.nvar
+00023c70: 7329 0a20 2020 2020 2020 2065 6c73 653a  s).        else:
+00023c80: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00023c90: 7572 6e20 706f 6c79 2e47 7261 6450 6c61  urn poly.GradPla
+00023ca0: 6e28 7365 6c66 2e6e 7661 7273 2c20 6465  n(self.nvars, de
+00023cb0: 6772 6565 290a 0a20 2020 2064 6566 205f  gree)..    def _
+00023cc0: 7369 6d70 6c69 6669 6564 2873 656c 6629  simplified(self)
+00023cd0: 3a0a 2020 2020 2020 2020 6966 2069 737a  :.        if isz
+00023ce0: 6572 6f28 7365 6c66 2e63 6f65 6666 7329  ero(self.coeffs)
+00023cf0: 206f 7220 5f65 7175 616c 735f 7363 616c   or _equals_scal
+00023d00: 6172 5f63 6f6e 7374 616e 7428 7365 6c66  ar_constant(self
+00023d10: 2e64 6567 7265 652c 2030 293a 0a20 2020  .degree, 0):.   
+00023d20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00023d30: 7a65 726f 735f 6c69 6b65 2873 656c 6629  zeros_like(self)
+00023d40: 0a20 2020 2020 2020 2065 6c69 6620 5f65  .        elif _e
+00023d50: 7175 616c 735f 7363 616c 6172 5f63 6f6e  quals_scalar_con
+00023d60: 7374 616e 7428 7365 6c66 2e64 6567 7265  stant(self.degre
+00023d70: 652c 2031 293a 0a20 2020 2020 2020 2020  e, 1):.         
+00023d80: 2020 2072 6574 7572 6e20 496e 7365 7274     return Insert
+00023d90: 4178 6973 2854 616b 6528 7365 6c66 2e63  Axis(Take(self.c
+00023da0: 6f65 6666 732c 2063 6f6e 7374 616e 7428  oeffs, constant(
+00023db0: 7365 6c66 2e6e 7661 7273 202d 2031 2920  self.nvars - 1) 
+00023dc0: 2d20 5261 6e67 6528 636f 6e73 7461 6e74  - Range(constant
+00023dd0: 2873 656c 662e 6e76 6172 7329 2929 2c20  (self.nvars))), 
+00023de0: 636f 6e73 7461 6e74 2831 2929 0a0a 2020  constant(1))..  
+00023df0: 2020 6465 6620 5f74 616b 6564 6961 6728    def _takediag(
+00023e00: 7365 6c66 2c20 6178 6973 312c 2061 7869  self, axis1, axi
+00023e10: 7332 293a 0a20 2020 2020 2020 2069 6620  s2):.        if 
+00023e20: 6178 6973 3120 3c20 7365 6c66 2e6e 6469  axis1 < self.ndi
+00023e30: 6d20 2d20 3220 616e 6420 6178 6973 3220  m - 2 and axis2 
+00023e40: 3c20 7365 6c66 2e6e 6469 6d20 2d20 323a  < self.ndim - 2:
+00023e50: 0a20 2020 2020 2020 2020 2020 2063 6f65  .            coe
+00023e60: 6666 7320 3d20 5472 616e 7370 6f73 652e  ffs = Transpose.
+00023e70: 746f 5f65 6e64 285f 7461 6b65 6469 6167  to_end(_takediag
+00023e80: 2873 656c 662e 636f 6566 6673 2c20 6178  (self.coeffs, ax
+00023e90: 6973 312c 2061 7869 7332 292c 202d 3229  is1, axis2), -2)
+00023ea0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00023eb0: 7572 6e20 5472 616e 7370 6f73 652e 6672  urn Transpose.fr
+00023ec0: 6f6d 5f65 6e64 2850 6f6c 7947 7261 6428  om_end(PolyGrad(
+00023ed0: 636f 6566 6673 2c20 7365 6c66 2e6e 7661  coeffs, self.nva
+00023ee0: 7273 292c 202d 332c 202d 3229 0a0a 2020  rs), -3, -2)..  
+00023ef0: 2020 6465 6620 5f74 616b 6528 7365 6c66    def _take(self
+00023f00: 2c20 696e 6465 782c 2061 7869 7329 3a0a  , index, axis):.
+00023f10: 2020 2020 2020 2020 6966 2061 7869 7320          if axis 
+00023f20: 3c20 7365 6c66 2e6e 6469 6d20 2d20 323a  < self.ndim - 2:
+00023f30: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00023f40: 7572 6e20 506f 6c79 4772 6164 285f 7461  urn PolyGrad(_ta
+00023f50: 6b65 2873 656c 662e 636f 6566 6673 2c20  ke(self.coeffs, 
+00023f60: 696e 6465 782c 2061 7869 7329 2c20 7365  index, axis), se
+00023f70: 6c66 2e6e 7661 7273 290a 0a20 2020 2064  lf.nvars)..    d
+00023f80: 6566 205f 756e 7261 7665 6c28 7365 6c66  ef _unravel(self
+00023f90: 2c20 6178 6973 2c20 7368 6170 6529 3a0a  , axis, shape):.
+00023fa0: 2020 2020 2020 2020 6966 2061 7869 7320          if axis 
+00023fb0: 3c20 7365 6c66 2e6e 6469 6d20 2d20 323a  < self.ndim - 2:
+00023fc0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00023fd0: 7572 6e20 506f 6c79 4772 6164 2875 6e72  urn PolyGrad(unr
+00023fe0: 6176 656c 2873 656c 662e 636f 6566 6673  avel(self.coeffs
+00023ff0: 2c20 6178 6973 2c20 7368 6170 6529 2c20  , axis, shape), 
+00024000: 7365 6c66 2e6e 7661 7273 290a 0a0a 636c  self.nvars)...cl
+00024010: 6173 7320 4c65 6765 6e64 7265 2841 7272  ass Legendre(Arr
+00024020: 6179 293a 0a20 2020 2027 2727 5365 7269  ay):.    '''Seri
+00024030: 6573 206f 6620 4c65 6765 6e64 7265 2070  es of Legendre p
+00024040: 6f6c 796e 6f6d 6961 6c20 7570 2074 6f20  olynomial up to 
+00024050: 616e 6420 696e 636c 7564 696e 6720 7468  and including th
+00024060: 6520 6769 7665 6e20 6465 6772 6565 2e0a  e given degree..
+00024070: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00024080: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020      ---------.  
+00024090: 2020 7820 3a20 3a63 6c61 7373 3a60 4172    x : :class:`Ar
+000240a0: 7261 7960 0a20 2020 2020 2020 2054 6865  ray`.        The
+000240b0: 2063 6f6f 7264 696e 6174 6573 2074 6f20   coordinates to 
+000240c0: 6576 616c 7561 7465 2074 6865 2073 6572  evaluate the ser
+000240d0: 6965 7320 6174 2e0a 2020 2020 6465 6772  ies at..    degr
+000240e0: 6565 203a 203a 636c 6173 733a 6069 6e74  ee : :class:`int
+000240f0: 600a 2020 2020 2020 2020 5468 6520 6465  `.        The de
+00024100: 6772 6565 206f 6620 7468 6520 6c61 7374  gree of the last
+00024110: 2070 6f6c 796e 6f6d 6961 6c20 6f66 2074   polynomial of t
+00024120: 6865 2073 6572 6965 732e 0a20 2020 2027  he series..    '
+00024130: 2727 0a0a 2020 2020 6465 6620 5f5f 696e  ''..    def __in
+00024140: 6974 5f5f 2873 656c 662c 2078 3a20 4172  it__(self, x: Ar
+00024150: 7261 792c 2064 6567 7265 653a 2069 6e74  ray, degree: int
+00024160: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00024170: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+00024180: 616e 6365 2878 2c20 4172 7261 7929 2061  ance(x, Array) a
+00024190: 6e64 2078 2e64 7479 7065 203d 3d20 666c  nd x.dtype == fl
+000241a0: 6f61 742c 2066 2778 3d7b 7821 727d 270a  oat, f'x={x!r}'.
+000241b0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
+000241c0: 7369 6e73 7461 6e63 6528 6465 6772 6565  sinstance(degree
+000241d0: 2c20 696e 7429 2061 6e64 2064 6567 7265  , int) and degre
+000241e0: 6520 3e3d 2030 2c20 6627 6465 6772 6565  e >= 0, f'degree
+000241f0: 3d7b 6465 6772 6565 2172 7d27 0a20 2020  ={degree!r}'.   
+00024200: 2020 2020 2073 656c 662e 5f78 203d 2078       self._x = x
+00024210: 0a20 2020 2020 2020 2073 656c 662e 5f64  .        self._d
+00024220: 6567 7265 6520 3d20 6465 6772 6565 0a20  egree = degree. 
+00024230: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
+00024240: 5f69 6e69 745f 5f28 6172 6773 3d28 782c  _init__(args=(x,
+00024250: 292c 2073 6861 7065 3d28 2a78 2e73 6861  ), shape=(*x.sha
+00024260: 7065 2c20 636f 6e73 7461 6e74 2864 6567  pe, constant(deg
+00024270: 7265 652b 3129 292c 2064 7479 7065 3d66  ree+1)), dtype=f
+00024280: 6c6f 6174 290a 0a20 2020 2064 6566 2065  loat)..    def e
+00024290: 7661 6c66 2873 656c 662c 2078 3a20 6e75  valf(self, x: nu
+000242a0: 6d70 792e 6e64 6172 7261 7929 202d 3e20  mpy.ndarray) -> 
+000242b0: 6e75 6d70 792e 6e64 6172 7261 793a 0a20  numpy.ndarray:. 
+000242c0: 2020 2020 2020 2050 203d 206e 756d 7079         P = numpy
+000242d0: 2e65 6d70 7479 2828 2a78 2e73 6861 7065  .empty((*x.shape
+000242e0: 2c20 7365 6c66 2e5f 6465 6772 6565 2b31  , self._degree+1
+000242f0: 292c 2064 7479 7065 3d66 6c6f 6174 290a  ), dtype=float).
+00024300: 2020 2020 2020 2020 505b 2e2e 2e2c 2030          P[..., 0
+00024310: 5d20 3d20 310a 2020 2020 2020 2020 6966  ] = 1.        if
+00024320: 2073 656c 662e 5f64 6567 7265 653a 0a20   self._degree:. 
+00024330: 2020 2020 2020 2020 2020 2050 5b2e 2e2e             P[...
+00024340: 2c20 315d 203d 2078 0a20 2020 2020 2020  , 1] = x.       
+00024350: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00024360: 322c 2073 656c 662e 5f64 6567 7265 652b  2, self._degree+
+00024370: 3129 3a0a 2020 2020 2020 2020 2020 2020  1):.            
+00024380: 505b 2e2e 2e2c 2069 5d20 3d20 2832 2d31  P[..., i] = (2-1
+00024390: 2f69 292a 505b 2e2e 2e2c 2031 5d2a 505b  /i)*P[..., 1]*P[
+000243a0: 2e2e 2e2c 2069 2d31 5d20 2d20 2831 2d31  ..., i-1] - (1-1
+000243b0: 2f69 292a 505b 2e2e 2e2c 2069 2d32 5d0a  /i)*P[..., i-2].
+000243c0: 2020 2020 2020 2020 7265 7475 726e 2050          return P
+000243d0: 0a0a 2020 2020 6465 6620 5f64 6572 6976  ..    def _deriv
+000243e0: 6174 6976 6528 7365 6c66 2c20 7661 722c  ative(self, var,
+000243f0: 2073 6565 6e29 3a0a 2020 2020 2020 2020   seen):.        
+00024400: 6966 2073 656c 662e 6474 7970 6520 3d3d  if self.dtype ==
+00024410: 2063 6f6d 706c 6578 3a0a 2020 2020 2020   complex:.      
+00024420: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
+00024430: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
+00024440: 2754 6865 2063 6f6d 706c 6578 2064 6572  'The complex der
+00024450: 6976 6174 6976 6520 6973 206e 6f74 2069  ivative is not i
+00024460: 6d70 6c65 6d65 6e74 6564 2e27 290a 2020  mplemented.').  
+00024470: 2020 2020 2020 6420 3d20 6e75 6d70 792e        d = numpy.
+00024480: 7a65 726f 7328 2873 656c 662e 5f64 6567  zeros((self._deg
+00024490: 7265 652b 312c 292a 322c 2064 7479 7065  ree+1,)*2, dtype
+000244a0: 3d69 6e74 290a 2020 2020 2020 2020 666f  =int).        fo
+000244b0: 7220 6920 696e 2072 616e 6765 2873 656c  r i in range(sel
+000244c0: 662e 5f64 6567 7265 652b 3129 3a0a 2020  f._degree+1):.  
+000244d0: 2020 2020 2020 2020 2020 645b 692c 2069            d[i, i
+000244e0: 2b31 3a3a 325d 203d 2032 2a69 2b31 0a20  +1::2] = 2*i+1. 
+000244f0: 2020 2020 2020 2064 7365 6c66 203d 2065         dself = e
+00024500: 696e 7375 6d28 2741 692c 696a 2d3e 416a  insum('Ai,ij->Aj
+00024510: 272c 2073 656c 662c 2063 6f6e 7374 616e  ', self, constan
+00024520: 7428 6429 290a 2020 2020 2020 2020 7265  t(d)).        re
+00024530: 7475 726e 2065 696e 7375 6d28 2741 692c  turn einsum('Ai,
+00024540: 4142 2d3e 4169 4227 2c20 6473 656c 662c  AB->AiB', dself,
+00024550: 2064 6572 6976 6174 6976 6528 7365 6c66   derivative(self
+00024560: 2e5f 782c 2076 6172 2c20 7365 656e 2929  ._x, var, seen))
+00024570: 0a0a 2020 2020 6465 6620 5f73 696d 706c  ..    def _simpl
+00024580: 6966 6965 6428 7365 6c66 293a 0a20 2020  ified(self):.   
+00024590: 2020 2020 2075 6e61 6c69 676e 6564 2c20       unaligned, 
+000245a0: 7768 6572 6520 3d20 756e 616c 6967 6e28  where = unalign(
+000245b0: 7365 6c66 2e5f 7829 0a20 2020 2020 2020  self._x).       
+000245c0: 2069 6620 7768 6572 6520 213d 2074 7570   if where != tup
+000245d0: 6c65 2872 616e 6765 2873 656c 662e 5f78  le(range(self._x
+000245e0: 2e6e 6469 6d29 293a 0a20 2020 2020 2020  .ndim)):.       
+000245f0: 2020 2020 2072 6574 7572 6e20 616c 6967       return alig
+00024600: 6e28 4c65 6765 6e64 7265 2875 6e61 6c69  n(Legendre(unali
+00024610: 676e 6564 2c20 7365 6c66 2e5f 6465 6772  gned, self._degr
+00024620: 6565 292c 2028 2a77 6865 7265 2c20 7365  ee), (*where, se
+00024630: 6c66 2e6e 6469 6d2d 3129 2c20 7365 6c66  lf.ndim-1), self
+00024640: 2e73 6861 7065 290a 0a20 2020 2064 6566  .shape)..    def
+00024650: 205f 7461 6b65 6469 6167 2873 656c 662c   _takediag(self,
+00024660: 2061 7869 7331 2c20 6178 6973 3229 3a0a   axis1, axis2):.
+00024670: 2020 2020 2020 2020 6966 2061 7869 7331          if axis1
+00024680: 203c 2073 656c 662e 6e64 696d 202d 2031   < self.ndim - 1
+00024690: 2061 6e64 2061 7869 7332 203c 2073 656c   and axis2 < sel
+000246a0: 662e 6e64 696d 202d 2031 3a0a 2020 2020  f.ndim - 1:.    
+000246b0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+000246c0: 7261 6e73 706f 7365 2e74 6f5f 656e 6428  ranspose.to_end(
+000246d0: 4c65 6765 6e64 7265 285f 7461 6b65 6469  Legendre(_takedi
+000246e0: 6167 2873 656c 662e 5f78 2c20 6178 6973  ag(self._x, axis
+000246f0: 312c 2061 7869 7332 292c 2073 656c 662e  1, axis2), self.
+00024700: 5f64 6567 7265 6529 2c20 2d32 290a 0a20  _degree), -2).. 
+00024710: 2020 2064 6566 205f 7461 6b65 2873 656c     def _take(sel
+00024720: 662c 2069 6e64 6578 2c20 6178 6973 293a  f, index, axis):
+00024730: 0a20 2020 2020 2020 2069 6620 6178 6973  .        if axis
+00024740: 203c 2073 656c 662e 6e64 696d 202d 2031   < self.ndim - 1
+00024750: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00024760: 7475 726e 204c 6567 656e 6472 6528 5f74  turn Legendre(_t
+00024770: 616b 6528 7365 6c66 2e5f 782c 2069 6e64  ake(self._x, ind
+00024780: 6578 2c20 6178 6973 292c 2073 656c 662e  ex, axis), self.
+00024790: 5f64 6567 7265 6529 0a0a 2020 2020 6465  _degree)..    de
+000247a0: 6620 5f75 6e72 6176 656c 2873 656c 662c  f _unravel(self,
+000247b0: 2061 7869 732c 2073 6861 7065 293a 0a20   axis, shape):. 
+000247c0: 2020 2020 2020 2069 6620 6178 6973 203c         if axis <
+000247d0: 2073 656c 662e 6e64 696d 202d 2031 3a0a   self.ndim - 1:.
+000247e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000247f0: 726e 204c 6567 656e 6472 6528 756e 7261  rn Legendre(unra
+00024800: 7665 6c28 7365 6c66 2e5f 782c 2061 7869  vel(self._x, axi
+00024810: 732c 2073 6861 7065 292c 2073 656c 662e  s, shape), self.
+00024820: 5f64 6567 7265 6529 0a0a 0a63 6c61 7373  _degree)...class
+00024830: 2043 686f 6f73 6528 4172 7261 7929 3a0a   Choose(Array):.
+00024840: 2020 2020 2727 2746 756e 6374 696f 6e20      '''Function 
+00024850: 6571 7569 7661 6c65 6e74 206f 6620 3a66  equivalent of :f
+00024860: 756e 633a 606e 756d 7079 2e63 686f 6f73  unc:`numpy.choos
+00024870: 6560 2e27 2727 0a0a 2020 2020 6465 6620  e`.'''..    def 
+00024880: 5f5f 696e 6974 5f5f 2873 656c 662c 2069  __init__(self, i
+00024890: 6e64 6578 3a20 4172 7261 792c 202a 6368  ndex: Array, *ch
+000248a0: 6f69 6365 733a 2041 7272 6179 293a 0a20  oices: Array):. 
+000248b0: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+000248c0: 696e 7374 616e 6365 2869 6e64 6578 2c20  instance(index, 
+000248d0: 4172 7261 7929 2061 6e64 2069 6e64 6578  Array) and index
+000248e0: 2e64 7479 7065 203d 3d20 696e 742c 2066  .dtype == int, f
+000248f0: 2769 6e64 6578 3d7b 696e 6465 7821 727d  'index={index!r}
+00024900: 270a 2020 2020 2020 2020 6173 7365 7274  '.        assert
+00024910: 2069 7369 6e73 7461 6e63 6528 6368 6f69   isinstance(choi
+00024920: 6365 732c 2074 7570 6c65 2920 616e 6420  ces, tuple) and 
+00024930: 616c 6c28 6973 696e 7374 616e 6365 2863  all(isinstance(c
+00024940: 686f 6963 652c 2041 7272 6179 2920 666f  hoice, Array) fo
+00024950: 7220 6368 6f69 6365 2069 6e20 6368 6f69  r choice in choi
+00024960: 6365 7329 2c20 6627 6368 6f69 6365 733d  ces), f'choices=
+00024970: 7b63 686f 6963 6573 2172 7d27 0a20 2020  {choices!r}'.   
+00024980: 2020 2020 2064 7479 7065 203d 2063 686f       dtype = cho
+00024990: 6963 6573 5b30 5d2e 6474 7970 650a 2020  ices[0].dtype.  
+000249a0: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
+000249b0: 2863 686f 6963 652e 6474 7970 6520 3d3d  (choice.dtype ==
+000249c0: 2064 7479 7065 2066 6f72 2063 686f 6963   dtype for choic
+000249d0: 6520 696e 2063 686f 6963 6573 5b31 3a5d  e in choices[1:]
+000249e0: 290a 2020 2020 2020 2020 7368 6170 6520  ).        shape 
+000249f0: 3d20 696e 6465 782e 7368 6170 650a 2020  = index.shape.  
+00024a00: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
+00024a10: 2865 7175 616c 7368 6170 6528 6368 6f69  (equalshape(choi
+00024a20: 6365 2e73 6861 7065 2c20 7368 6170 6529  ce.shape, shape)
+00024a30: 2066 6f72 2063 686f 6963 6520 696e 2063   for choice in c
+00024a40: 686f 6963 6573 290a 2020 2020 2020 2020  hoices).        
+00024a50: 7365 6c66 2e69 6e64 6578 203d 2069 6e64  self.index = ind
+00024a60: 6578 0a20 2020 2020 2020 2073 656c 662e  ex.        self.
+00024a70: 6368 6f69 6365 7320 3d20 6368 6f69 6365  choices = choice
+00024a80: 730a 2020 2020 2020 2020 7375 7065 7228  s.        super(
+00024a90: 292e 5f5f 696e 6974 5f5f 2861 7267 733d  ).__init__(args=
+00024aa0: 2869 6e64 6578 2c29 2b63 686f 6963 6573  (index,)+choices
+00024ab0: 2c20 7368 6170 653d 7368 6170 652c 2064  , shape=shape, d
+00024ac0: 7479 7065 3d64 7479 7065 290a 0a20 2020  type=dtype)..   
+00024ad0: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+00024ae0: 2020 2064 6566 2065 7661 6c66 2869 6e64     def evalf(ind
+00024af0: 6578 2c20 2a63 686f 6963 6573 293a 0a20  ex, *choices):. 
+00024b00: 2020 2020 2020 2072 6574 7572 6e20 6e75         return nu
+00024b10: 6d70 792e 6368 6f6f 7365 2869 6e64 6578  mpy.choose(index
+00024b20: 2c20 6368 6f69 6365 7329 0a0a 2020 2020  , choices)..    
+00024b30: 6465 6620 5f64 6572 6976 6174 6976 6528  def _derivative(
+00024b40: 7365 6c66 2c20 7661 722c 2073 6565 6e29  self, var, seen)
+00024b50: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00024b60: 2043 686f 6f73 6528 6170 7065 6e64 6178   Choose(appendax
+00024b70: 6573 2873 656c 662e 696e 6465 782c 2076  es(self.index, v
+00024b80: 6172 2e73 6861 7065 292c 202a 2864 6572  ar.shape), *(der
+00024b90: 6976 6174 6976 6528 6368 6f69 6365 2c20  ivative(choice, 
+00024ba0: 7661 722c 2073 6565 6e29 2066 6f72 2063  var, seen) for c
+00024bb0: 686f 6963 6520 696e 2073 656c 662e 6368  hoice in self.ch
+00024bc0: 6f69 6365 7329 290a 0a20 2020 2064 6566  oices))..    def
+00024bd0: 205f 7369 6d70 6c69 6669 6564 2873 656c   _simplified(sel
+00024be0: 6629 3a0a 2020 2020 2020 2020 6966 2061  f):.        if a
+00024bf0: 6c6c 2863 686f 6963 6520 3d3d 2073 656c  ll(choice == sel
+00024c00: 662e 6368 6f69 6365 735b 305d 2066 6f72  f.choices[0] for
+00024c10: 2063 686f 6963 6520 696e 2073 656c 662e   choice in self.
+00024c20: 6368 6f69 6365 735b 313a 5d29 3a0a 2020  choices[1:]):.  
+00024c30: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00024c40: 2073 656c 662e 6368 6f69 6365 735b 305d   self.choices[0]
+00024c50: 0a20 2020 2020 2020 2069 6e64 6578 2c20  .        index, 
+00024c60: 2a63 686f 6963 6573 2c20 7768 6572 6520  *choices, where 
+00024c70: 3d20 756e 616c 6967 6e28 7365 6c66 2e69  = unalign(self.i
+00024c80: 6e64 6578 2c20 2a73 656c 662e 6368 6f69  ndex, *self.choi
+00024c90: 6365 7329 0a20 2020 2020 2020 2069 6620  ces).        if 
+00024ca0: 6c65 6e28 7768 6572 6529 203c 2073 656c  len(where) < sel
+00024cb0: 662e 6e64 696d 3a0a 2020 2020 2020 2020  f.ndim:.        
+00024cc0: 2020 2020 7265 7475 726e 2061 6c69 676e      return align
+00024cd0: 2843 686f 6f73 6528 696e 6465 782c 202a  (Choose(index, *
+00024ce0: 6368 6f69 6365 7329 2c20 7768 6572 652c  choices), where,
+00024cf0: 2073 656c 662e 7368 6170 6529 0a0a 2020   self.shape)..  
+00024d00: 2020 6465 6620 5f6d 756c 7469 706c 7928    def _multiply(
+00024d10: 7365 6c66 2c20 6f74 6865 7229 3a0a 2020  self, other):.  
+00024d20: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00024d30: 6e63 6528 6f74 6865 722c 2043 686f 6f73  nce(other, Choos
+00024d40: 6529 2061 6e64 2073 656c 662e 696e 6465  e) and self.inde
+00024d50: 7820 3d3d 206f 7468 6572 2e69 6e64 6578  x == other.index
+00024d60: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00024d70: 7475 726e 2043 686f 6f73 6528 7365 6c66  turn Choose(self
+00024d80: 2e69 6e64 6578 2c20 2a6d 6170 286d 756c  .index, *map(mul
+00024d90: 7469 706c 792c 2073 656c 662e 6368 6f69  tiply, self.choi
+00024da0: 6365 732c 206f 7468 6572 2e63 686f 6963  ces, other.choic
+00024db0: 6573 2929 0a0a 2020 2020 6465 6620 5f67  es))..    def _g
+00024dc0: 6574 2873 656c 662c 2069 2c20 6974 656d  et(self, i, item
+00024dd0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00024de0: 6e20 4368 6f6f 7365 2867 6574 2873 656c  n Choose(get(sel
+00024df0: 662e 696e 6465 782c 2069 2c20 6974 656d  f.index, i, item
+00024e00: 292c 202a 2867 6574 2863 686f 6963 652c  ), *(get(choice,
+00024e10: 2069 2c20 6974 656d 2920 666f 7220 6368   i, item) for ch
+00024e20: 6f69 6365 2069 6e20 7365 6c66 2e63 686f  oice in self.cho
+00024e30: 6963 6573 2929 0a0a 2020 2020 6465 6620  ices))..    def 
+00024e40: 5f73 756d 2873 656c 662c 2061 7869 7329  _sum(self, axis)
+00024e50: 3a0a 2020 2020 2020 2020 756e 616c 6967  :.        unalig
+00024e60: 6e65 642c 2077 6865 7265 203d 2075 6e61  ned, where = una
+00024e70: 6c69 676e 2873 656c 662e 696e 6465 7829  lign(self.index)
+00024e80: 0a20 2020 2020 2020 2069 6620 6178 6973  .        if axis
+00024e90: 206e 6f74 2069 6e20 7768 6572 653a 0a20   not in where:. 
+00024ea0: 2020 2020 2020 2020 2020 2069 6e64 6578             index
+00024eb0: 203d 2061 6c69 676e 2875 6e61 6c69 676e   = align(unalign
+00024ec0: 6564 2c20 5b69 2d28 6920 3e20 6178 6973  ed, [i-(i > axis
+00024ed0: 2920 666f 7220 6920 696e 2077 6865 7265  ) for i in where
+00024ee0: 5d2c 2073 656c 662e 7368 6170 655b 3a61  ], self.shape[:a
+00024ef0: 7869 735d 2b73 656c 662e 7368 6170 655b  xis]+self.shape[
+00024f00: 6178 6973 2b31 3a5d 290a 2020 2020 2020  axis+1:]).      
+00024f10: 2020 2020 2020 7265 7475 726e 2043 686f        return Cho
+00024f20: 6f73 6528 696e 6465 782c 202a 2873 756d  ose(index, *(sum
+00024f30: 2863 686f 6963 652c 2061 7869 7329 2066  (choice, axis) f
+00024f40: 6f72 2063 686f 6963 6520 696e 2073 656c  or choice in sel
+00024f50: 662e 6368 6f69 6365 7329 290a 0a20 2020  f.choices))..   
+00024f60: 2064 6566 205f 7461 6b65 2873 656c 662c   def _take(self,
+00024f70: 2069 6e64 6578 2c20 6178 6973 293a 0a20   index, axis):. 
+00024f80: 2020 2020 2020 2072 6574 7572 6e20 4368         return Ch
+00024f90: 6f6f 7365 285f 7461 6b65 2873 656c 662e  oose(_take(self.
+00024fa0: 696e 6465 782c 2069 6e64 6578 2c20 6178  index, index, ax
+00024fb0: 6973 292c 202a 285f 7461 6b65 2863 686f  is), *(_take(cho
+00024fc0: 6963 652c 2069 6e64 6578 2c20 6178 6973  ice, index, axis
+00024fd0: 2920 666f 7220 6368 6f69 6365 2069 6e20  ) for choice in 
+00024fe0: 7365 6c66 2e63 686f 6963 6573 2929 0a0a  self.choices))..
+00024ff0: 2020 2020 6465 6620 5f74 616b 6564 6961      def _takedia
+00025000: 6728 7365 6c66 2c20 6178 6973 2c20 726d  g(self, axis, rm
+00025010: 6178 6973 293a 0a20 2020 2020 2020 2072  axis):.        r
+00025020: 6574 7572 6e20 4368 6f6f 7365 2874 616b  eturn Choose(tak
+00025030: 6564 6961 6728 7365 6c66 2e69 6e64 6578  ediag(self.index
+00025040: 2c20 6178 6973 2c20 726d 6178 6973 292c  , axis, rmaxis),
+00025050: 202a 2874 616b 6564 6961 6728 6368 6f69   *(takediag(choi
+00025060: 6365 2c20 6178 6973 2c20 726d 6178 6973  ce, axis, rmaxis
+00025070: 2920 666f 7220 6368 6f69 6365 2069 6e20  ) for choice in 
+00025080: 7365 6c66 2e63 686f 6963 6573 2929 0a0a  self.choices))..
+00025090: 2020 2020 6465 6620 5f70 726f 6475 6374      def _product
+000250a0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000250b0: 756e 616c 6967 6e65 642c 2077 6865 7265  unaligned, where
+000250c0: 203d 2075 6e61 6c69 676e 2873 656c 662e   = unalign(self.
+000250d0: 696e 6465 7829 0a20 2020 2020 2020 2069  index).        i
+000250e0: 6620 7365 6c66 2e6e 6469 6d2d 3120 6e6f  f self.ndim-1 no
+000250f0: 7420 696e 2077 6865 7265 3a0a 2020 2020  t in where:.    
+00025100: 2020 2020 2020 2020 696e 6465 7820 3d20          index = 
+00025110: 616c 6967 6e28 756e 616c 6967 6e65 642c  align(unaligned,
+00025120: 2077 6865 7265 2c20 7365 6c66 2e73 6861   where, self.sha
+00025130: 7065 5b3a 2d31 5d29 0a20 2020 2020 2020  pe[:-1]).       
+00025140: 2020 2020 2072 6574 7572 6e20 4368 6f6f       return Choo
+00025150: 7365 2869 6e64 6578 2c20 2a6d 6170 2850  se(index, *map(P
+00025160: 726f 6475 6374 2c20 7365 6c66 2e63 686f  roduct, self.cho
+00025170: 6963 6573 2929 0a0a 0a63 6c61 7373 204e  ices))...class N
+00025180: 6f72 6d44 696d 2841 7272 6179 293a 0a0a  ormDim(Array):..
+00025190: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+000251a0: 2873 656c 662c 206c 656e 6774 683a 2041  (self, length: A
+000251b0: 7272 6179 2c20 696e 6465 783a 2041 7272  rray, index: Arr
+000251c0: 6179 293a 0a20 2020 2020 2020 2061 7373  ay):.        ass
+000251d0: 6572 7420 6973 696e 7374 616e 6365 286c  ert isinstance(l
+000251e0: 656e 6774 682c 2041 7272 6179 2920 616e  ength, Array) an
+000251f0: 6420 6c65 6e67 7468 2e64 7479 7065 203d  d length.dtype =
+00025200: 3d20 696e 742c 2066 276c 656e 6774 683d  = int, f'length=
+00025210: 7b6c 656e 6774 6821 727d 270a 2020 2020  {length!r}'.    
+00025220: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+00025230: 7461 6e63 6528 696e 6465 782c 2041 7272  tance(index, Arr
+00025240: 6179 2920 616e 6420 696e 6465 782e 6474  ay) and index.dt
+00025250: 7970 6520 3d3d 2069 6e74 2c20 6627 696e  ype == int, f'in
+00025260: 6465 783d 7b69 6e64 6578 2172 7d27 0a20  dex={index!r}'. 
+00025270: 2020 2020 2020 2061 7373 6572 7420 6571         assert eq
+00025280: 7561 6c73 6861 7065 286c 656e 6774 682e  ualshape(length.
+00025290: 7368 6170 652c 2069 6e64 6578 2e73 6861  shape, index.sha
+000252a0: 7065 290a 2020 2020 2020 2020 2320 5468  pe).        # Th
+000252b0: 6520 666f 6c6c 6f77 696e 6720 636f 726e  e following corn
+000252c0: 6572 2063 6173 6573 206d 616b 6573 2074  er cases makes t
+000252d0: 6865 2061 7373 6572 7469 6f6e 2066 6169  he assertion fai
+000252e0: 6c2c 2068 656e 6365 2077 6520 6361 6e20  l, hence we can 
+000252f0: 6f6e 6c79 0a20 2020 2020 2020 2023 2061  only.        # a
+00025300: 7373 6572 7420 7468 6520 626f 756e 6473  ssert the bounds
+00025310: 2069 6620 7468 6520 6172 7261 7973 2061   if the arrays a
+00025320: 7265 2067 7561 7261 6e74 6565 6420 746f  re guaranteed to
+00025330: 2062 6520 756e 656d 7074 793a 0a20 2020   be unempty:.   
+00025340: 2020 2020 2023 0a20 2020 2020 2020 2023       #.        #
+00025350: 2020 2020 2054 616b 6528 6675 6e63 2c20       Take(func, 
+00025360: 4e6f 726d 4469 6d28 6675 6e63 2e73 6861  NormDim(func.sha
+00025370: 7065 5b2d 315d 2c20 5261 6e67 6528 3029  pe[-1], Range(0)
+00025380: 202b 2066 756e 632e 7368 6170 655b 2d31   + func.shape[-1
+00025390: 5d29 290a 2020 2020 2020 2020 6966 2061  ])).        if a
+000253a0: 6c6c 286e 2e5f 696e 7462 6f75 6e64 735b  ll(n._intbounds[
+000253b0: 305d 203e 2030 2066 6f72 206e 2069 6e20  0] > 0 for n in 
+000253c0: 696e 6465 782e 7368 6170 6529 3a0a 2020  index.shape):.  
+000253d0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000253e0: 202d 6c65 6e67 7468 2e5f 696e 7462 6f75   -length._intbou
+000253f0: 6e64 735b 315d 203c 3d20 696e 6465 782e  nds[1] <= index.
+00025400: 5f69 6e74 626f 756e 6473 5b30 5d20 616e  _intbounds[0] an
+00025410: 6420 696e 6465 782e 5f69 6e74 626f 756e  d index._intboun
+00025420: 6473 5b31 5d20 3c3d 206c 656e 6774 682e  ds[1] <= length.
+00025430: 5f69 6e74 626f 756e 6473 5b31 5d20 2d20  _intbounds[1] - 
+00025440: 310a 2020 2020 2020 2020 7365 6c66 2e6c  1.        self.l
+00025450: 656e 6774 6820 3d20 6c65 6e67 7468 0a20  ength = length. 
+00025460: 2020 2020 2020 2073 656c 662e 696e 6465         self.inde
+00025470: 7820 3d20 696e 6465 780a 2020 2020 2020  x = index.      
+00025480: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00025490: 5f5f 2861 7267 733d 286c 656e 6774 682c  __(args=(length,
+000254a0: 2069 6e64 6578 292c 2073 6861 7065 3d69   index), shape=i
+000254b0: 6e64 6578 2e73 6861 7065 2c20 6474 7970  ndex.shape, dtyp
+000254c0: 653d 696e 6465 782e 6474 7970 6529 0a0a  e=index.dtype)..
+000254d0: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+000254e0: 640a 2020 2020 6465 6620 6576 616c 6628  d.    def evalf(
+000254f0: 6c65 6e67 7468 2c20 696e 6465 7829 3a0a  length, index):.
+00025500: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
+00025510: 656e 6774 682e 7368 6170 6520 3d3d 2069  ength.shape == i
+00025520: 6e64 6578 2e73 6861 7065 0a20 2020 2020  ndex.shape.     
+00025530: 2020 2061 7373 6572 7420 6c65 6e67 7468     assert length
+00025540: 2e64 7479 7065 2e6b 696e 6420 3d3d 2027  .dtype.kind == '
+00025550: 6927 0a20 2020 2020 2020 2061 7373 6572  i'.        asser
+00025560: 7420 696e 6465 782e 6474 7970 652e 6b69  t index.dtype.ki
+00025570: 6e64 203d 3d20 2769 270a 2020 2020 2020  nd == 'i'.      
+00025580: 2020 7265 7375 6c74 203d 206e 756d 7079    result = numpy
+00025590: 2e65 6d70 7479 2869 6e64 6578 2e73 6861  .empty(index.sha
+000255a0: 7065 2c20 6474 7970 653d 696e 7429 0a20  pe, dtype=int). 
+000255b0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+000255c0: 6e75 6d70 792e 6e64 696e 6465 7828 696e  numpy.ndindex(in
+000255d0: 6465 782e 7368 6170 6529 3a0a 2020 2020  dex.shape):.    
+000255e0: 2020 2020 2020 2020 7265 7375 6c74 5b69          result[i
+000255f0: 5d20 3d20 6e75 6d65 7269 632e 6e6f 726d  ] = numeric.norm
+00025600: 6469 6d28 6c65 6e67 7468 5b69 5d2c 2069  dim(length[i], i
+00025610: 6e64 6578 5b69 5d29 0a20 2020 2020 2020  ndex[i]).       
+00025620: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
+00025630: 2020 2020 6465 6620 5f73 696d 706c 6966      def _simplif
+00025640: 6965 6428 7365 6c66 293a 0a20 2020 2020  ied(self):.     
+00025650: 2020 206c 6f77 6572 5f6c 656e 6774 682c     lower_length,
+00025660: 2075 7070 6572 5f6c 656e 6774 6820 3d20   upper_length = 
+00025670: 7365 6c66 2e6c 656e 6774 682e 5f69 6e74  self.length._int
+00025680: 626f 756e 6473 0a20 2020 2020 2020 206c  bounds.        l
+00025690: 6f77 6572 5f69 6e64 6578 2c20 7570 7065  ower_index, uppe
+000256a0: 725f 696e 6465 7820 3d20 7365 6c66 2e69  r_index = self.i
+000256b0: 6e64 6578 2e5f 696e 7462 6f75 6e64 730a  ndex._intbounds.
+000256c0: 2020 2020 2020 2020 6966 2030 203c 3d20          if 0 <= 
+000256d0: 6c6f 7765 725f 696e 6465 7820 616e 6420  lower_index and 
+000256e0: 7570 7065 725f 696e 6465 7820 3c20 6c6f  upper_index < lo
+000256f0: 7765 725f 6c65 6e67 7468 3a0a 2020 2020  wer_length:.    
+00025700: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00025710: 656c 662e 696e 6465 780a 2020 2020 2020  elf.index.      
+00025720: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00025730: 6c6f 7765 725f 6c65 6e67 7468 2c20 696e  lower_length, in
+00025740: 7429 2061 6e64 206c 6f77 6572 5f6c 656e  t) and lower_len
+00025750: 6774 6820 3d3d 2075 7070 6572 5f6c 656e  gth == upper_len
+00025760: 6774 6820 616e 6420 2d6c 6f77 6572 5f6c  gth and -lower_l
+00025770: 656e 6774 6820 3c3d 206c 6f77 6572 5f69  ength <= lower_i
+00025780: 6e64 6578 2061 6e64 2075 7070 6572 5f69  ndex and upper_i
+00025790: 6e64 6578 203c 2030 3a0a 2020 2020 2020  ndex < 0:.      
+000257a0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000257b0: 662e 696e 6465 7820 2b20 6c6f 7765 725f  f.index + lower_
+000257c0: 6c65 6e67 7468 0a20 2020 2020 2020 2069  length.        i
+000257d0: 6620 7365 6c66 2e6c 656e 6774 682e 6973  f self.length.is
+000257e0: 636f 6e73 7461 6e74 2061 6e64 2073 656c  constant and sel
+000257f0: 662e 696e 6465 782e 6973 636f 6e73 7461  f.index.isconsta
+00025800: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+00025810: 7265 7475 726e 2063 6f6e 7374 616e 7428  return constant(
+00025820: 7365 6c66 2e65 7661 6c28 2929 0a0a 2020  self.eval())..  
+00025830: 2020 6465 6620 5f69 6e74 626f 756e 6473    def _intbounds
+00025840: 5f69 6d70 6c28 7365 6c66 293a 0a20 2020  _impl(self):.   
+00025850: 2020 2020 206c 6f77 6572 5f6c 656e 6774       lower_lengt
+00025860: 682c 2075 7070 6572 5f6c 656e 6774 6820  h, upper_length 
+00025870: 3d20 7365 6c66 2e6c 656e 6774 682e 5f69  = self.length._i
+00025880: 6e74 626f 756e 6473 0a20 2020 2020 2020  ntbounds.       
+00025890: 206c 6f77 6572 5f69 6e64 6578 2c20 7570   lower_index, up
+000258a0: 7065 725f 696e 6465 7820 3d20 7365 6c66  per_index = self
+000258b0: 2e69 6e64 6578 2e5f 696e 7462 6f75 6e64  .index._intbound
+000258c0: 730a 2020 2020 2020 2020 6966 206c 6f77  s.        if low
+000258d0: 6572 5f69 6e64 6578 203e 3d20 303a 0a20  er_index >= 0:. 
+000258e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000258f0: 6e20 6d69 6e28 6c6f 7765 725f 696e 6465  n min(lower_inde
+00025900: 782c 2075 7070 6572 5f6c 656e 6774 6820  x, upper_length 
+00025910: 2d20 3129 2c20 6d69 6e28 7570 7065 725f  - 1), min(upper_
+00025920: 696e 6465 782c 2075 7070 6572 5f6c 656e  index, upper_len
+00025930: 6774 6820 2d20 3129 0a20 2020 2020 2020  gth - 1).       
+00025940: 2065 6c69 6620 7570 7065 725f 696e 6465   elif upper_inde
+00025950: 7820 3c20 3020 616e 6420 6973 696e 7374  x < 0 and isinst
+00025960: 616e 6365 286c 6f77 6572 5f6c 656e 6774  ance(lower_lengt
+00025970: 682c 2069 6e74 2920 616e 6420 6c6f 7765  h, int) and lowe
+00025980: 725f 6c65 6e67 7468 203d 3d20 7570 7065  r_length == uppe
+00025990: 725f 6c65 6e67 7468 3a0a 2020 2020 2020  r_length:.      
+000259a0: 2020 2020 2020 7265 7475 726e 206d 6178        return max
+000259b0: 286c 6f77 6572 5f69 6e64 6578 202b 206c  (lower_index + l
+000259c0: 6f77 6572 5f6c 656e 6774 682c 2030 292c  ower_length, 0),
+000259d0: 206d 6178 2875 7070 6572 5f69 6e64 6578   max(upper_index
+000259e0: 202b 206c 6f77 6572 5f6c 656e 6774 682c   + lower_length,
+000259f0: 2030 290a 2020 2020 2020 2020 656c 7365   0).        else
+00025a00: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00025a10: 7475 726e 2030 2c20 7570 7065 725f 6c65  turn 0, upper_le
+00025a20: 6e67 7468 202d 2031 0a0a 0a63 6c61 7373  ngth - 1...class
+00025a30: 2054 7261 6e73 666f 726d 436f 6f72 6473   TransformCoords
+00025a40: 2841 7272 6179 293a 0a20 2020 2027 2727  (Array):.    '''
+00025a50: 5472 616e 7366 6f72 6d20 636f 6f72 6469  Transform coordi
+00025a60: 6e61 7465 7320 6672 6f6d 206f 6e65 2063  nates from one c
+00025a70: 6f6f 7264 696e 6174 6520 7379 7374 656d  oordinate system
+00025a80: 2074 6f20 616e 6f74 6865 7220 2873 7061   to another (spa
+00025a90: 7469 616c 2070 6172 7429 0a0a 2020 2020  tial part)..    
+00025aa0: 4172 6773 0a20 2020 202d 2d2d 2d0a 2020  Args.    ----.  
+00025ab0: 2020 7461 7267 6574 203a 203a 636c 6173    target : :clas
+00025ac0: 733a 606e 7574 696c 732e 7472 616e 7366  s:`nutils.transf
+00025ad0: 6f72 6d73 6571 2e54 7261 6e73 666f 726d  ormseq.Transform
+00025ae0: 7360 2c20 6f70 7469 6f6e 616c 0a20 2020  s`, optional.   
+00025af0: 2020 2020 2054 6865 2074 6172 6765 7420       The target 
+00025b00: 636f 6f72 6469 6e61 7465 2073 7973 7465  coordinate syste
+00025b10: 6d2e 2049 6620 604e 6f6e 6560 2074 6865  m. If `None` the
+00025b20: 2074 6172 6765 7420 6973 2072 6f6f 7420   target is root 
+00025b30: 636f 6f72 6469 6e61 7465 0a20 2020 2020  coordinate.     
+00025b40: 2020 2073 7973 7465 6d2e 0a20 2020 2073     system..    s
+00025b50: 6f75 7263 6520 3a20 3a63 6c61 7373 3a60  ource : :class:`
+00025b60: 6e75 7469 6c73 2e74 7261 6e73 666f 726d  nutils.transform
+00025b70: 7365 712e 5472 616e 7366 6f72 6d73 600a  seq.Transforms`.
+00025b80: 2020 2020 2020 2020 5468 6520 736f 7572          The sour
+00025b90: 6365 2063 6f6f 7264 696e 6174 6520 7379  ce coordinate sy
+00025ba0: 7374 656d 2e0a 2020 2020 696e 6465 7820  stem..    index 
+00025bb0: 3a20 7363 616c 6172 2c20 696e 7465 6765  : scalar, intege
+00025bc0: 7220 3a63 6c61 7373 3a60 4172 7261 7960  r :class:`Array`
+00025bd0: 0a20 2020 2020 2020 2054 6865 2069 6e64  .        The ind
+00025be0: 6578 2070 6172 7420 6f66 2074 6865 2073  ex part of the s
+00025bf0: 6f75 7263 6520 636f 6f72 6469 6e61 7465  ource coordinate
+00025c00: 732e 0a20 2020 2063 6f6f 7264 7320 3a20  s..    coords : 
+00025c10: 3a63 6c61 7373 3a60 4172 7261 7960 0a20  :class:`Array`. 
+00025c20: 2020 2020 2020 2054 6865 2073 7061 7469         The spati
+00025c30: 616c 2070 6172 7420 6f66 2074 6865 2073  al part of the s
+00025c40: 6f75 7263 6520 636f 6f72 6469 6e61 7465  ource coordinate
+00025c50: 732e 0a20 2020 2027 2727 0a0a 2020 2020  s..    '''..    
+00025c60: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00025c70: 662c 2074 6172 6765 742c 2073 6f75 7263  f, target, sourc
+00025c80: 652c 2069 6e64 6578 3a20 4172 7261 792c  e, index: Array,
+00025c90: 2063 6f6f 7264 733a 2041 7272 6179 293a   coords: Array):
+00025ca0: 0a20 2020 2020 2020 2069 6620 696e 6465  .        if inde
+00025cb0: 782e 6474 7970 6520 213d 2069 6e74 206f  x.dtype != int o
+00025cc0: 7220 696e 6465 782e 6e64 696d 2021 3d20  r index.ndim != 
+00025cd0: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
+00025ce0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00025cf0: 2761 7267 756d 656e 7420 6069 6e64 6578  'argument `index
+00025d00: 6020 6d75 7374 2062 6520 6120 7363 616c  ` must be a scal
+00025d10: 6172 2c20 696e 7465 6765 7220 606e 7574  ar, integer `nut
+00025d20: 696c 732e 6576 616c 7561 626c 652e 4172  ils.evaluable.Ar
+00025d30: 7261 7960 2729 0a20 2020 2020 2020 2069  ray`').        i
+00025d40: 6620 636f 6f72 6473 2e64 7479 7065 2021  f coords.dtype !
+00025d50: 3d20 666c 6f61 743a 0a20 2020 2020 2020  = float:.       
+00025d60: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00025d70: 4572 726f 7228 2761 7267 756d 656e 7420  Error('argument 
+00025d80: 6063 6f6f 7264 7360 206d 7573 7420 6265  `coords` must be
+00025d90: 2061 2072 6561 6c2d 7661 6c75 6564 2061   a real-valued a
+00025da0: 7272 6179 2077 6974 6820 6174 206c 6561  rray with at lea
+00025db0: 7374 206f 6e65 2061 7869 7327 290a 2020  st one axis').  
+00025dc0: 2020 2020 2020 7365 6c66 2e5f 7461 7267        self._targ
+00025dd0: 6574 203d 2074 6172 6765 740a 2020 2020  et = target.    
+00025de0: 2020 2020 7365 6c66 2e5f 736f 7572 6365      self._source
+00025df0: 203d 2073 6f75 7263 650a 2020 2020 2020   = source.      
+00025e00: 2020 7365 6c66 2e5f 696e 6465 7820 3d20    self._index = 
+00025e10: 696e 6465 780a 2020 2020 2020 2020 7365  index.        se
+00025e20: 6c66 2e5f 636f 6f72 6473 203d 2063 6f6f  lf._coords = coo
+00025e30: 7264 730a 2020 2020 2020 2020 7461 7267  rds.        targ
+00025e40: 6574 5f64 696d 203d 2073 6f75 7263 652e  et_dim = source.
+00025e50: 746f 6469 6d73 2069 6620 7461 7267 6574  todims if target
+00025e60: 2069 7320 4e6f 6e65 2065 6c73 6520 7461   is None else ta
+00025e70: 7267 6574 2e66 726f 6d64 696d 730a 2020  rget.fromdims.  
+00025e80: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+00025e90: 696e 6974 5f5f 2861 7267 733d 2869 6e64  init__(args=(ind
+00025ea0: 6578 2c20 636f 6f72 6473 292c 2073 6861  ex, coords), sha
+00025eb0: 7065 3d28 2a63 6f6f 7264 732e 7368 6170  pe=(*coords.shap
+00025ec0: 655b 3a2d 315d 2c20 636f 6e73 7461 6e74  e[:-1], constant
+00025ed0: 2874 6172 6765 745f 6469 6d29 292c 2064  (target_dim)), d
+00025ee0: 7479 7065 3d66 6c6f 6174 290a 0a20 2020  type=float)..   
+00025ef0: 2064 6566 2065 7661 6c66 2873 656c 662c   def evalf(self,
+00025f00: 2069 6e64 6578 2c20 636f 6f72 6473 293a   index, coords):
+00025f10: 0a20 2020 2020 2020 2063 6861 696e 203d  .        chain =
+00025f20: 2073 656c 662e 5f73 6f75 7263 655b 696e   self._source[in
+00025f30: 6465 782e 5f5f 696e 6465 785f 5f28 295d  dex.__index__()]
+00025f40: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00025f50: 2e5f 7461 7267 6574 2069 7320 6e6f 7420  ._target is not 
+00025f60: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00025f70: 2020 5f2c 2063 6861 696e 203d 2073 656c    _, chain = sel
+00025f80: 662e 5f74 6172 6765 742e 696e 6465 785f  f._target.index_
+00025f90: 7769 7468 5f74 6169 6c28 6368 6169 6e29  with_tail(chain)
+00025fa0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00025fb0: 6675 6e63 746f 6f6c 732e 7265 6475 6365  functools.reduce
+00025fc0: 286c 616d 6264 6120 632c 2074 3a20 742e  (lambda c, t: t.
+00025fd0: 6170 706c 7928 6329 2c20 7265 7665 7273  apply(c), revers
+00025fe0: 6564 2863 6861 696e 292c 2063 6f6f 7264  ed(chain), coord
+00025ff0: 7329 0a0a 2020 2020 6465 6620 5f64 6572  s)..    def _der
+00026000: 6976 6174 6976 6528 7365 6c66 2c20 7661  ivative(self, va
+00026010: 722c 2073 6565 6e29 3a0a 2020 2020 2020  r, seen):.      
+00026020: 2020 6c69 6e65 6172 203d 2054 7261 6e73    linear = Trans
+00026030: 666f 726d 4c69 6e65 6172 2873 656c 662e  formLinear(self.
+00026040: 5f74 6172 6765 742c 2073 656c 662e 5f73  _target, self._s
+00026050: 6f75 7263 652c 2073 656c 662e 5f69 6e64  ource, self._ind
+00026060: 6578 290a 2020 2020 2020 2020 6463 6f6f  ex).        dcoo
+00026070: 7264 7320 3d20 6465 7269 7661 7469 7665  rds = derivative
+00026080: 2873 656c 662e 5f63 6f6f 7264 732c 2076  (self._coords, v
+00026090: 6172 2c20 7365 656e 290a 2020 2020 2020  ar, seen).      
+000260a0: 2020 7265 7475 726e 2065 696e 7375 6d28    return einsum(
+000260b0: 2769 6a2c 416a 422d 3e41 6942 272c 206c  'ij,AjB->AiB', l
+000260c0: 696e 6561 722c 2064 636f 6f72 6473 2c20  inear, dcoords, 
+000260d0: 413d 7365 6c66 2e5f 636f 6f72 6473 2e6e  A=self._coords.n
+000260e0: 6469 6d20 2d20 312c 2042 3d76 6172 2e6e  dim - 1, B=var.n
+000260f0: 6469 6d29 0a0a 2020 2020 6465 6620 5f73  dim)..    def _s
+00026100: 696d 706c 6966 6965 6428 7365 6c66 293a  implified(self):
+00026110: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00026120: 2e5f 7461 7267 6574 203d 3d20 7365 6c66  ._target == self
+00026130: 2e5f 736f 7572 6365 3a0a 2020 2020 2020  ._source:.      
+00026140: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00026150: 662e 5f63 6f6f 7264 730a 2020 2020 2020  f._coords.      
+00026160: 2020 6361 7820 3d20 7365 6c66 2e6e 6469    cax = self.ndi
+00026170: 6d20 2d20 310a 2020 2020 2020 2020 636f  m - 1.        co
+00026180: 6f72 6473 2c20 7768 6572 6520 3d20 756e  ords, where = un
+00026190: 616c 6967 6e28 7365 6c66 2e5f 636f 6f72  align(self._coor
+000261a0: 6473 2c20 6e61 7865 733d 6361 7829 0a20  ds, naxes=cax). 
+000261b0: 2020 2020 2020 2069 6620 6c65 6e28 7768         if len(wh
+000261c0: 6572 6529 203c 2063 6178 3a0a 2020 2020  ere) < cax:.    
+000261d0: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+000261e0: 6c69 676e 2854 7261 6e73 666f 726d 436f  lign(TransformCo
+000261f0: 6f72 6473 2873 656c 662e 5f74 6172 6765  ords(self._targe
+00026200: 742c 2073 656c 662e 5f73 6f75 7263 652c  t, self._source,
+00026210: 2073 656c 662e 5f69 6e64 6578 2c20 636f   self._index, co
+00026220: 6f72 6473 292c 2028 2a77 6865 7265 2c20  ords), (*where, 
+00026230: 6361 7829 2c20 7365 6c66 2e73 6861 7065  cax), self.shape
+00026240: 290a 0a0a 636c 6173 7320 5472 616e 7366  )...class Transf
+00026250: 6f72 6d49 6e64 6578 2841 7272 6179 293a  ormIndex(Array):
+00026260: 0a20 2020 2027 2727 5472 616e 7366 6f72  .    '''Transfor
+00026270: 6d20 636f 6f72 6469 6e61 7465 7320 6672  m coordinates fr
+00026280: 6f6d 206f 6e65 2063 6f6f 7264 696e 6174  om one coordinat
+00026290: 6520 7379 7374 656d 2074 6f20 616e 6f74  e system to anot
+000262a0: 6865 7220 2869 6e64 6578 2070 6172 7429  her (index part)
+000262b0: 0a0a 2020 2020 4172 6773 0a20 2020 202d  ..    Args.    -
+000262c0: 2d2d 2d0a 2020 2020 7461 7267 6574 203a  ---.    target :
+000262d0: 203a 636c 6173 733a 606e 7574 696c 732e   :class:`nutils.
+000262e0: 7472 616e 7366 6f72 6d73 6571 2e54 7261  transformseq.Tra
+000262f0: 6e73 666f 726d 7360 2c20 6f70 7469 6f6e  nsforms`, option
+00026300: 616c 0a20 2020 2020 2020 2054 6865 2074  al.        The t
+00026310: 6172 6765 7420 636f 6f72 6469 6e61 7465  arget coordinate
+00026320: 2073 7973 7465 6d2e 2049 6620 604e 6f6e   system. If `Non
+00026330: 6560 2074 6865 2074 6172 6765 7420 6973  e` the target is
+00026340: 2074 6865 2072 6f6f 740a 2020 2020 2020   the root.      
+00026350: 2020 636f 6f72 6469 6e61 7465 2073 7973    coordinate sys
+00026360: 7465 6d2e 0a20 2020 2073 6f75 7263 6520  tem..    source 
+00026370: 3a20 3a63 6c61 7373 3a60 6e75 7469 6c73  : :class:`nutils
+00026380: 2e74 7261 6e73 666f 726d 7365 712e 5472  .transformseq.Tr
+00026390: 616e 7366 6f72 6d73 600a 2020 2020 2020  ansforms`.      
+000263a0: 2020 5468 6520 736f 7572 6365 2063 6f6f    The source coo
+000263b0: 7264 696e 6174 6520 7379 7374 656d 2e0a  rdinate system..
+000263c0: 2020 2020 696e 6465 7820 3a20 7363 616c      index : scal
+000263d0: 6172 2c20 696e 7465 6765 7220 3a63 6c61  ar, integer :cla
+000263e0: 7373 3a60 4172 7261 7960 0a20 2020 2020  ss:`Array`.     
+000263f0: 2020 2054 6865 2069 6e64 6578 2070 6172     The index par
+00026400: 7420 6f66 2074 6865 2073 6f75 7263 6520  t of the source 
+00026410: 636f 6f72 6469 6e61 7465 732e 0a20 2020  coordinates..   
+00026420: 2027 2727 0a0a 2020 2020 6465 6620 5f5f   '''..    def __
+00026430: 696e 6974 5f5f 2873 656c 662c 2074 6172  init__(self, tar
+00026440: 6765 742c 2073 6f75 7263 652c 2069 6e64  get, source, ind
+00026450: 6578 3a20 4172 7261 7929 3a0a 2020 2020  ex: Array):.    
+00026460: 2020 2020 6966 2069 6e64 6578 2e64 7479      if index.dty
+00026470: 7065 2021 3d20 696e 7420 6f72 2069 6e64  pe != int or ind
+00026480: 6578 2e6e 6469 6d20 213d 2030 3a0a 2020  ex.ndim != 0:.  
+00026490: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000264a0: 5661 6c75 6545 7272 6f72 2827 6172 6775  ValueError('argu
+000264b0: 6d65 6e74 2060 696e 6465 7860 206d 7573  ment `index` mus
+000264c0: 7420 6265 2061 2073 6361 6c61 722c 2069  t be a scalar, i
+000264d0: 6e74 6567 6572 2060 6e75 7469 6c73 2e65  nteger `nutils.e
+000264e0: 7661 6c75 6162 6c65 2e41 7272 6179 6027  valuable.Array`'
+000264f0: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+00026500: 7461 7267 6574 203d 2074 6172 6765 740a  target = target.
+00026510: 2020 2020 2020 2020 7365 6c66 2e5f 736f          self._so
+00026520: 7572 6365 203d 2073 6f75 7263 650a 2020  urce = source.  
+00026530: 2020 2020 2020 7365 6c66 2e5f 696e 6465        self._inde
+00026540: 7820 3d20 696e 6465 780a 2020 2020 2020  x = index.      
+00026550: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00026560: 5f5f 2861 7267 733d 2869 6e64 6578 2c29  __(args=(index,)
+00026570: 2c20 7368 6170 653d 2829 2c20 6474 7970  , shape=(), dtyp
+00026580: 653d 696e 7429 0a0a 2020 2020 6465 6620  e=int)..    def 
+00026590: 6576 616c 6628 7365 6c66 2c20 696e 6465  evalf(self, inde
+000265a0: 7829 3a0a 2020 2020 2020 2020 6966 2073  x):.        if s
+000265b0: 656c 662e 5f74 6172 6765 7420 6973 206e  elf._target is n
+000265c0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000265d0: 2020 2020 2069 6e64 6578 2c20 5f20 3d20       index, _ = 
+000265e0: 7365 6c66 2e5f 7461 7267 6574 2e69 6e64  self._target.ind
+000265f0: 6578 5f77 6974 685f 7461 696c 2873 656c  ex_with_tail(sel
+00026600: 662e 5f73 6f75 7263 655b 696e 6465 782e  f._source[index.
+00026610: 5f5f 696e 6465 785f 5f28 295d 290a 2020  __index__()]).  
+00026620: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00026630: 2020 2020 2020 2020 696e 6465 7820 3d20          index = 
+00026640: 300a 2020 2020 2020 2020 7265 7475 726e  0.        return
+00026650: 206e 756d 7079 2e61 7272 6179 2869 6e64   numpy.array(ind
+00026660: 6578 290a 0a20 2020 2064 6566 205f 696e  ex)..    def _in
+00026670: 7462 6f75 6e64 735f 696d 706c 2873 656c  tbounds_impl(sel
+00026680: 6629 3a0a 2020 2020 2020 2020 6c65 6e5f  f):.        len_
+00026690: 7461 7267 6574 203d 2031 2069 6620 7365  target = 1 if se
+000266a0: 6c66 2e5f 7461 7267 6574 2069 7320 4e6f  lf._target is No
+000266b0: 6e65 2065 6c73 6520 6c65 6e28 7365 6c66  ne else len(self
+000266c0: 2e5f 7461 7267 6574 290a 2020 2020 2020  ._target).      
+000266d0: 2020 7265 7475 726e 2030 2c20 6c65 6e5f    return 0, len_
+000266e0: 7461 7267 6574 202d 2031 0a0a 2020 2020  target - 1..    
+000266f0: 6465 6620 5f73 696d 706c 6966 6965 6428  def _simplified(
+00026700: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
+00026710: 6620 7365 6c66 2e5f 7461 7267 6574 2069  f self._target i
+00026720: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00026730: 2020 2020 7265 7475 726e 206f 6e65 7328      return ones(
+00026740: 2831 2c29 2c20 6474 7970 653d 696e 7429  (1,), dtype=int)
+00026750: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
+00026760: 6c66 2e5f 7461 7267 6574 203d 3d20 7365  lf._target == se
+00026770: 6c66 2e5f 736f 7572 6365 3a0a 2020 2020  lf._source:.    
+00026780: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00026790: 656c 662e 5f69 6e64 6578 0a0a 0a63 6c61  elf._index...cla
+000267a0: 7373 2054 7261 6e73 666f 726d 4c69 6e65  ss TransformLine
+000267b0: 6172 2841 7272 6179 293a 0a20 2020 2027  ar(Array):.    '
+000267c0: 2727 4c69 6e65 6172 2070 6172 7420 6f66  ''Linear part of
+000267d0: 2061 2063 6f6f 7264 696e 6174 6520 7472   a coordinate tr
+000267e0: 616e 7366 6f72 6d61 7469 6f6e 0a0a 2020  ansformation..  
+000267f0: 2020 4172 6773 0a20 2020 202d 2d2d 2d0a    Args.    ----.
+00026800: 2020 2020 7461 7267 6574 203a 203a 636c      target : :cl
+00026810: 6173 733a 606e 7574 696c 732e 7472 616e  ass:`nutils.tran
+00026820: 7366 6f72 6d73 6571 2e54 7261 6e73 666f  sformseq.Transfo
+00026830: 726d 7360 2c20 6f70 7469 6f6e 616c 0a20  rms`, optional. 
+00026840: 2020 2020 2020 2054 6865 2074 6172 6765         The targe
+00026850: 7420 636f 6f72 6469 6e61 7465 2073 7973  t coordinate sys
+00026860: 7465 6d2e 2049 6620 604e 6f6e 6560 2074  tem. If `None` t
+00026870: 6865 2074 6172 6765 7420 6973 2074 6865  he target is the
+00026880: 2072 6f6f 740a 2020 2020 2020 2020 636f   root.        co
+00026890: 6f72 6469 6e61 7465 2073 7973 7465 6d2e  ordinate system.
+000268a0: 0a20 2020 2073 6f75 7263 6520 3a20 3a63  .    source : :c
+000268b0: 6c61 7373 3a60 6e75 7469 6c73 2e74 7261  lass:`nutils.tra
+000268c0: 6e73 666f 726d 7365 712e 5472 616e 7366  nsformseq.Transf
+000268d0: 6f72 6d73 600a 2020 2020 2020 2020 5468  orms`.        Th
+000268e0: 6520 736f 7572 6365 2063 6f6f 7264 696e  e source coordin
+000268f0: 6174 6520 7379 7374 656d 2e0a 2020 2020  ate system..    
+00026900: 696e 6465 7820 3a20 7363 616c 6172 2c20  index : scalar, 
+00026910: 696e 7465 6765 7220 3a63 6c61 7373 3a60  integer :class:`
+00026920: 4172 7261 7960 0a20 2020 2020 2020 2054  Array`.        T
+00026930: 6865 2069 6e64 6578 2070 6172 7420 6f66  he index part of
+00026940: 2074 6865 2073 6f75 7263 6520 636f 6f72   the source coor
+00026950: 6469 6e61 7465 732e 0a20 2020 2027 2727  dinates..    '''
+00026960: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00026970: 5f5f 2873 656c 662c 2074 6172 6765 742c  __(self, target,
+00026980: 2073 6f75 7263 652c 2069 6e64 6578 3a20   source, index: 
+00026990: 4172 7261 7929 3a0a 2020 2020 2020 2020  Array):.        
+000269a0: 6966 2069 6e64 6578 2e64 7479 7065 2021  if index.dtype !
+000269b0: 3d20 696e 7420 6f72 2069 6e64 6578 2e6e  = int or index.n
+000269c0: 6469 6d20 213d 2030 3a0a 2020 2020 2020  dim != 0:.      
+000269d0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+000269e0: 6545 7272 6f72 2827 6172 6775 6d65 6e74  eError('argument
+000269f0: 2060 696e 6465 7860 206d 7573 7420 6265   `index` must be
+00026a00: 2061 2073 6361 6c61 722c 2069 6e74 6567   a scalar, integ
+00026a10: 6572 2060 6e75 7469 6c73 2e65 7661 6c75  er `nutils.evalu
+00026a20: 6162 6c65 2e41 7272 6179 6027 290a 2020  able.Array`').  
+00026a30: 2020 2020 2020 7365 6c66 2e5f 7461 7267        self._targ
+00026a40: 6574 203d 2074 6172 6765 740a 2020 2020  et = target.    
+00026a50: 2020 2020 7365 6c66 2e5f 736f 7572 6365      self._source
+00026a60: 203d 2073 6f75 7263 650a 2020 2020 2020   = source.      
+00026a70: 2020 7461 7267 6574 5f64 696d 203d 2073    target_dim = s
+00026a80: 6f75 7263 652e 746f 6469 6d73 2069 6620  ource.todims if 
+00026a90: 7461 7267 6574 2069 7320 4e6f 6e65 2065  target is None e
+00026aa0: 6c73 6520 7461 7267 6574 2e66 726f 6d64  lse target.fromd
+00026ab0: 696d 730a 2020 2020 2020 2020 7375 7065  ims.        supe
+00026ac0: 7228 292e 5f5f 696e 6974 5f5f 2861 7267  r().__init__(arg
+00026ad0: 733d 2869 6e64 6578 2c29 2c20 7368 6170  s=(index,), shap
+00026ae0: 653d 2863 6f6e 7374 616e 7428 7461 7267  e=(constant(targ
+00026af0: 6574 5f64 696d 292c 2063 6f6e 7374 616e  et_dim), constan
+00026b00: 7428 736f 7572 6365 2e66 726f 6d64 696d  t(source.fromdim
+00026b10: 7329 292c 2064 7479 7065 3d66 6c6f 6174  s)), dtype=float
+00026b20: 290a 0a20 2020 2064 6566 2065 7661 6c66  )..    def evalf
+00026b30: 2873 656c 662c 2069 6e64 6578 293a 0a20  (self, index):. 
+00026b40: 2020 2020 2020 2063 6861 696e 203d 2073         chain = s
+00026b50: 656c 662e 5f73 6f75 7263 655b 696e 6465  elf._source[inde
+00026b60: 782e 5f5f 696e 6465 785f 5f28 295d 0a20  x.__index__()]. 
+00026b70: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
+00026b80: 7461 7267 6574 2069 7320 6e6f 7420 4e6f  target is not No
+00026b90: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00026ba0: 5f2c 2063 6861 696e 203d 2073 656c 662e  _, chain = self.
+00026bb0: 5f74 6172 6765 742e 696e 6465 785f 7769  _target.index_wi
+00026bc0: 7468 5f74 6169 6c28 6368 6169 6e29 0a20  th_tail(chain). 
+00026bd0: 2020 2020 2020 2069 6620 6368 6169 6e3a         if chain:
+00026be0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00026bf0: 7572 6e20 6675 6e63 746f 6f6c 732e 7265  urn functools.re
+00026c00: 6475 6365 286c 616d 6264 6120 722c 2069  duce(lambda r, i
+00026c10: 3a20 6920 4020 722c 2028 6974 656d 2e6c  : i @ r, (item.l
+00026c20: 696e 6561 7220 666f 7220 6974 656d 2069  inear for item i
+00026c30: 6e20 7265 7665 7273 6564 2863 6861 696e  n reversed(chain
+00026c40: 2929 290a 2020 2020 2020 2020 656c 7365  ))).        else
+00026c50: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00026c60: 7475 726e 206e 756d 7079 2e65 7965 2873  turn numpy.eye(s
+00026c70: 656c 662e 5f73 6f75 7263 652e 6672 6f6d  elf._source.from
+00026c80: 6469 6d73 290a 0a20 2020 2064 6566 205f  dims)..    def _
+00026c90: 7369 6d70 6c69 6669 6564 2873 656c 6629  simplified(self)
+00026ca0: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
+00026cb0: 662e 5f74 6172 6765 7420 3d3d 2073 656c  f._target == sel
+00026cc0: 662e 5f73 6f75 7263 653a 0a20 2020 2020  f._source:.     
+00026cd0: 2020 2020 2020 2072 6574 7572 6e20 6469         return di
+00026ce0: 6167 6f6e 616c 697a 6528 6f6e 6573 2828  agonalize(ones((
+00026cf0: 636f 6e73 7461 6e74 2873 656c 662e 5f73  constant(self._s
+00026d00: 6f75 7263 652e 6672 6f6d 6469 6d73 292c  ource.fromdims),
+00026d10: 292c 2064 7479 7065 3d66 6c6f 6174 2929  ), dtype=float))
+00026d20: 0a0a 0a63 6c61 7373 2054 7261 6e73 666f  ...class Transfo
+00026d30: 726d 4261 7369 7328 4172 7261 7929 3a0a  rmBasis(Array):.
+00026d40: 2020 2020 2727 2756 6563 746f 7220 6261      '''Vector ba
+00026d50: 7369 7320 666f 7220 7468 6520 726f 6f74  sis for the root
+00026d60: 2061 6e64 2061 2073 6f75 7263 6520 636f   and a source co
+00026d70: 6f72 6469 6e61 7465 2073 7973 7465 6d0a  ordinate system.
+00026d80: 0a20 2020 2054 6865 2063 6f6c 756d 6e73  .    The columns
+00026d90: 206f 6620 7468 6973 206d 6174 7269 7820   of this matrix 
+00026da0: 666f 726d 2061 2076 6563 746f 7220 6261  form a vector ba
+00026db0: 7369 7320 666f 7220 7468 6520 7370 6163  sis for the spac
+00026dc0: 6520 6f66 2072 6f6f 740a 2020 2020 636f  e of root.    co
+00026dd0: 6f72 6469 6e61 7465 732e 2054 6865 2066  ordinates. The f
+00026de0: 6972 7374 2060 6e60 2076 6563 746f 7273  irst `n` vectors
+00026df0: 2061 6c73 6f20 7370 616e 2074 6865 2073   also span the s
+00026e00: 7061 6365 206f 6620 736f 7572 6365 0a20  pace of source. 
+00026e10: 2020 2063 6f6f 7264 696e 6174 6573 206d     coordinates m
+00026e20: 6170 7065 6420 746f 2074 6865 2072 6f6f  apped to the roo
+00026e30: 742c 2077 6865 7265 2060 6e60 2069 7320  t, where `n` is 
+00026e40: 7468 6520 6469 6d65 6e73 696f 6e20 6f66  the dimension of
+00026e50: 2074 6865 2073 6f75 7263 650a 2020 2020   the source.    
+00026e60: 636f 6f72 6469 6e61 7465 2073 7973 7465  coordinate syste
+00026e70: 6d2e 2054 6865 2072 656d 6169 6e64 6572  m. The remainder
+00026e80: 2069 7320 2a6e 6f74 2a20 6120 7370 616e   is *not* a span
+00026e90: 206f 6620 7468 6520 636f 6d70 6c65 6d65   of the compleme
+00026ea0: 6e74 2073 7061 6365 2069 6e0a 2020 2020  nt space in.    
+00026eb0: 6765 6e65 7261 6c2e 0a0a 2020 2020 4e6f  general...    No
+00026ec0: 2061 6464 6974 696f 6e61 6c20 7072 6f70   additional prop
+00026ed0: 6572 7469 6573 2061 7265 2067 7561 7261  erties are guara
+00026ee0: 6e74 6565 6420 6265 796f 6e64 2074 6865  nteed beyond the
+00026ef0: 2061 626f 7665 2e20 496e 2070 6172 7469   above. In parti
+00026f00: 6375 6c61 722c 2069 660a 2020 2020 7468  cular, if.    th
+00026f10: 6520 736f 7572 6365 2063 6f6f 7264 696e  e source coordin
+00026f20: 6174 6520 7379 7374 656d 2068 6173 2074  ate system has t
+00026f30: 6865 2073 616d 6520 6469 6d65 6e73 696f  he same dimensio
+00026f40: 6e20 6173 2074 6865 2072 6f6f 742c 2074  n as the root, t
+00026f50: 6865 0a20 2020 2062 6173 6973 2069 7320  he.    basis is 
+00026f60: 2a6e 6f74 206e 6563 6573 7361 7269 6c79  *not necessarily
+00026f70: 2a20 7468 6520 7361 6d65 2061 7320 6060  * the same as ``
+00026f80: 5472 616e 7366 6f72 6d4c 696e 6561 7228  TransformLinear(
+00026f90: 4e6f 6e65 2c20 736f 7572 6365 2c0a 2020  None, source,.  
+00026fa0: 2020 696e 6465 7829 6060 2e0a 0a20 2020    index)``...   
+00026fb0: 2041 7267 730a 2020 2020 2d2d 2d2d 0a20   Args.    ----. 
+00026fc0: 2020 2073 6f75 7263 6520 3a20 3a63 6c61     source : :cla
+00026fd0: 7373 3a60 6e75 7469 6c73 2e74 7261 6e73  ss:`nutils.trans
+00026fe0: 666f 726d 7365 712e 5472 616e 7366 6f72  formseq.Transfor
+00026ff0: 6d73 600a 2020 2020 2020 2020 5468 6520  ms`.        The 
+00027000: 736f 7572 6365 2063 6f6f 7264 696e 6174  source coordinat
+00027010: 6520 7379 7374 656d 2e0a 2020 2020 696e  e system..    in
+00027020: 6465 7820 3a20 7363 616c 6172 2c20 696e  dex : scalar, in
+00027030: 7465 6765 7220 3a63 6c61 7373 3a60 4172  teger :class:`Ar
+00027040: 7261 7960 0a20 2020 2020 2020 2054 6865  ray`.        The
+00027050: 2069 6e64 6578 2070 6172 7420 6f66 2074   index part of t
+00027060: 6865 2073 6f75 7263 6520 636f 6f72 6469  he source coordi
+00027070: 6e61 7465 732e 0a20 2020 2027 2727 0a0a  nates..    '''..
+00027080: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00027090: 2873 656c 662c 2073 6f75 7263 652c 2069  (self, source, i
+000270a0: 6e64 6578 3a20 4172 7261 7929 3a0a 2020  ndex: Array):.  
+000270b0: 2020 2020 2020 6966 2069 6e64 6578 2e64        if index.d
+000270c0: 7479 7065 2021 3d20 696e 7420 6f72 2069  type != int or i
+000270d0: 6e64 6578 2e6e 6469 6d20 213d 2030 3a0a  ndex.ndim != 0:.
+000270e0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000270f0: 6520 5661 6c75 6545 7272 6f72 2827 6172  e ValueError('ar
+00027100: 6775 6d65 6e74 2060 696e 6465 7860 206d  gument `index` m
+00027110: 7573 7420 6265 2061 2073 6361 6c61 722c  ust be a scalar,
+00027120: 2069 6e74 6567 6572 2060 6e75 7469 6c73   integer `nutils
+00027130: 2e65 7661 6c75 6162 6c65 2e41 7272 6179  .evaluable.Array
+00027140: 6027 290a 2020 2020 2020 2020 7365 6c66  `').        self
+00027150: 2e5f 736f 7572 6365 203d 2073 6f75 7263  ._source = sourc
+00027160: 650a 2020 2020 2020 2020 7375 7065 7228  e.        super(
+00027170: 292e 5f5f 696e 6974 5f5f 2861 7267 733d  ).__init__(args=
+00027180: 2869 6e64 6578 2c29 2c20 7368 6170 653d  (index,), shape=
+00027190: 2863 6f6e 7374 616e 7428 736f 7572 6365  (constant(source
+000271a0: 2e74 6f64 696d 7329 2c20 636f 6e73 7461  .todims), consta
+000271b0: 6e74 2873 6f75 7263 652e 746f 6469 6d73  nt(source.todims
+000271c0: 2929 2c20 6474 7970 653d 666c 6f61 7429  )), dtype=float)
+000271d0: 0a0a 2020 2020 6465 6620 6576 616c 6628  ..    def evalf(
+000271e0: 7365 6c66 2c20 696e 6465 7829 3a0a 2020  self, index):.  
+000271f0: 2020 2020 2020 6368 6169 6e20 3d20 7365        chain = se
+00027200: 6c66 2e5f 736f 7572 6365 5b69 6e64 6578  lf._source[index
+00027210: 2e5f 5f69 6e64 6578 5f5f 2829 5d0a 2020  .__index__()].  
+00027220: 2020 2020 2020 6c69 6e65 6172 203d 206e        linear = n
+00027230: 756d 7079 2e65 7965 2873 656c 662e 5f73  umpy.eye(self._s
+00027240: 6f75 7263 652e 6672 6f6d 6469 6d73 290a  ource.fromdims).
+00027250: 2020 2020 2020 2020 666f 7220 6974 656d          for item
+00027260: 2069 6e20 7265 7665 7273 6564 2863 6861   in reversed(cha
+00027270: 696e 293a 0a20 2020 2020 2020 2020 2020  in):.           
+00027280: 206c 696e 6561 7220 3d20 6974 656d 2e6c   linear = item.l
+00027290: 696e 6561 7220 4020 6c69 6e65 6172 0a20  inear @ linear. 
+000272a0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000272b0: 7420 6974 656d 2e66 726f 6d64 696d 7320  t item.fromdims 
+000272c0: 3c3d 2069 7465 6d2e 746f 6469 6d73 203c  <= item.todims <
+000272d0: 3d20 6974 656d 2e66 726f 6d64 696d 7320  = item.fromdims 
+000272e0: 2b20 310a 2020 2020 2020 2020 2020 2020  + 1.            
+000272f0: 6966 2069 7465 6d2e 746f 6469 6d73 203d  if item.todims =
+00027300: 3d20 6974 656d 2e66 726f 6d64 696d 7320  = item.fromdims 
+00027310: 2b20 313a 0a20 2020 2020 2020 2020 2020  + 1:.           
+00027320: 2020 2020 206c 696e 6561 7220 3d20 6e75       linear = nu
+00027330: 6d70 792e 636f 6e63 6174 656e 6174 6528  mpy.concatenate(
+00027340: 5b6c 696e 6561 722c 2069 7465 6d2e 6578  [linear, item.ex
+00027350: 745b 3a2c 206e 756d 7079 2e6e 6577 6178  t[:, numpy.newax
+00027360: 6973 5d5d 2c20 6178 6973 3d31 290a 2020  is]], axis=1).  
+00027370: 2020 2020 2020 6173 7365 7274 206c 696e        assert lin
+00027380: 6561 722e 7368 6170 6520 3d3d 2028 7365  ear.shape == (se
+00027390: 6c66 2e5f 736f 7572 6365 2e74 6f64 696d  lf._source.todim
+000273a0: 732c 2073 656c 662e 5f73 6f75 7263 652e  s, self._source.
+000273b0: 746f 6469 6d73 290a 2020 2020 2020 2020  todims).        
+000273c0: 7265 7475 726e 206c 696e 6561 720a 0a20  return linear.. 
+000273d0: 2020 2064 6566 205f 7369 6d70 6c69 6669     def _simplifi
+000273e0: 6564 2873 656c 6629 3a0a 2020 2020 2020  ed(self):.      
+000273f0: 2020 6966 2073 656c 662e 5f73 6f75 7263    if self._sourc
+00027400: 652e 746f 6469 6d73 203d 3d20 7365 6c66  e.todims == self
+00027410: 2e5f 736f 7572 6365 2e66 726f 6d64 696d  ._source.fromdim
+00027420: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
+00027430: 2053 696e 6365 2077 6520 6f6e 6c79 2067   Since we only g
+00027440: 7561 7261 6e74 6565 2074 6861 7420 7468  uarantee that th
+00027450: 6520 6261 7369 7320 7370 616e 7320 7468  e basis spans th
+00027460: 6520 7370 6163 6520 6f66 2073 6f75 7263  e space of sourc
+00027470: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+00027480: 636f 6f72 6469 6e61 7465 7320 6d61 7070  coordinates mapp
+00027490: 6564 2074 6f20 7468 6520 726f 6f74 2061  ed to the root a
+000274a0: 6e64 2074 6865 206d 6170 2069 7320 6120  nd the map is a 
+000274b0: 6269 6a65 6374 696f 6e20 2865 7665 7279  bijection (every
+000274c0: 0a20 2020 2020 2020 2020 2020 2023 2060  .            # `
+000274d0: 5472 616e 7366 6f72 6d60 2069 7320 6173  Transform` is as
+000274e0: 7375 6d65 6420 746f 2062 6520 696e 6a65  sumed to be inje
+000274f0: 6374 6976 6529 2c20 7765 2063 616e 2072  ctive), we can r
+00027500: 6574 7572 6e20 7468 6520 756e 6974 0a20  eturn the unit. 
+00027510: 2020 2020 2020 2020 2020 2023 2076 6563             # vec
+00027520: 746f 7273 2068 6572 652e 0a20 2020 2020  tors here..     
+00027530: 2020 2020 2020 2072 6574 7572 6e20 6469         return di
+00027540: 6167 6f6e 616c 697a 6528 6f6e 6573 2828  agonalize(ones((
+00027550: 7365 6c66 2e5f 736f 7572 6365 2e66 726f  self._source.fro
+00027560: 6d64 696d 732c 292c 2064 7479 7065 3d66  mdims,), dtype=f
+00027570: 6c6f 6174 2929 0a0a 0a63 6c61 7373 205f  loat))...class _
+00027580: 4c6f 6f70 496e 6465 7828 4172 6775 6d65  LoopIndex(Argume
+00027590: 6e74 293a 0a0a 2020 2020 6465 6620 5f5f  nt):..    def __
+000275a0: 696e 6974 5f5f 2873 656c 662c 206e 616d  init__(self, nam
+000275b0: 653a 2073 7472 2c20 6c65 6e67 7468 3a20  e: str, length: 
+000275c0: 4172 7261 7929 3a0a 2020 2020 2020 2020  Array):.        
+000275d0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+000275e0: 6528 6e61 6d65 2c20 7374 7229 2c20 6627  e(name, str), f'
+000275f0: 6e61 6d65 3d7b 6e61 6d65 2172 7d27 0a20  name={name!r}'. 
+00027600: 2020 2020 2020 2061 7373 6572 7420 5f69         assert _i
+00027610: 7369 6e64 6578 286c 656e 6774 6829 2c20  sindex(length), 
+00027620: 6627 6c65 6e67 7468 3d7b 6c65 6e67 7468  f'length={length
+00027630: 2172 7d27 0a20 2020 2020 2020 2073 656c  !r}'.        sel
+00027640: 662e 6c65 6e67 7468 203d 206c 656e 6774  f.length = lengt
+00027650: 680a 2020 2020 2020 2020 7375 7065 7228  h.        super(
+00027660: 292e 5f5f 696e 6974 5f5f 286e 616d 652c  ).__init__(name,
+00027670: 2028 292c 2069 6e74 290a 0a20 2020 2064   (), int)..    d
+00027680: 6566 205f 5f73 7472 5f5f 2873 656c 6629  ef __str__(self)
+00027690: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
+000276a0: 2020 2020 2020 2020 2020 206c 656e 6774             lengt
+000276b0: 6820 3d20 7365 6c66 2e6c 656e 6774 682e  h = self.length.
+000276c0: 5f5f 696e 6465 785f 5f28 290a 2020 2020  __index__().    
+000276d0: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+000276e0: 2020 2020 2020 2020 6c65 6e67 7468 203d          length =
+000276f0: 2027 3f27 0a20 2020 2020 2020 2072 6574   '?'.        ret
+00027700: 7572 6e20 274c 6f6f 7049 6e64 6578 287b  urn 'LoopIndex({
+00027710: 7d2c 206c 656e 6774 683d 7b7d 2927 2e66  }, length={})'.f
+00027720: 6f72 6d61 7428 7365 6c66 2e5f 6e61 6d65  ormat(self._name
+00027730: 2c20 6c65 6e67 7468 290a 0a20 2020 2064  , length)..    d
+00027740: 6566 205f 6e6f 6465 2873 656c 662c 2063  ef _node(self, c
+00027750: 6163 6865 2c20 7375 6267 7261 7068 2c20  ache, subgraph, 
+00027760: 7469 6d65 7329 3a0a 2020 2020 2020 2020  times):.        
+00027770: 6966 2073 656c 6620 696e 2063 6163 6865  if self in cache
+00027780: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00027790: 7475 726e 2063 6163 6865 5b73 656c 665d  turn cache[self]
+000277a0: 0a20 2020 2020 2020 2063 6163 6865 5b73  .        cache[s
+000277b0: 656c 665d 203d 206e 6f64 6520 3d20 5265  elf] = node = Re
+000277c0: 6775 6c61 724e 6f64 6528 274c 6f6f 7049  gularNode('LoopI
+000277d0: 6e64 6578 272c 2028 292c 2064 6963 7428  ndex', (), dict(
+000277e0: 6c65 6e67 7468 3d73 656c 662e 6c65 6e67  length=self.leng
+000277f0: 7468 2e5f 6e6f 6465 2863 6163 6865 2c20  th._node(cache, 
+00027800: 7375 6267 7261 7068 2c20 7469 6d65 7329  subgraph, times)
+00027810: 292c 2028 7479 7065 2873 656c 6629 2e5f  ), (type(self)._
+00027820: 5f6e 616d 655f 5f2c 205f 5374 6174 7328  _name__, _Stats(
+00027830: 2929 2c20 7375 6267 7261 7068 290a 2020  )), subgraph).  
+00027840: 2020 2020 2020 7265 7475 726e 206e 6f64        return nod
+00027850: 650a 0a20 2020 2064 6566 205f 696e 7462  e..    def _intb
+00027860: 6f75 6e64 735f 696d 706c 2873 656c 6629  ounds_impl(self)
+00027870: 3a0a 2020 2020 2020 2020 6c6f 7765 725f  :.        lower_
+00027880: 6c65 6e67 7468 2c20 7570 7065 725f 6c65  length, upper_le
+00027890: 6e67 7468 203d 2073 656c 662e 6c65 6e67  ngth = self.leng
+000278a0: 7468 2e5f 696e 7462 6f75 6e64 730a 2020  th._intbounds.  
+000278b0: 2020 2020 2020 7265 7475 726e 2030 2c20        return 0, 
+000278c0: 6d61 7828 302c 2075 7070 6572 5f6c 656e  max(0, upper_len
+000278d0: 6774 6820 2d20 3129 0a0a 2020 2020 6465  gth - 1)..    de
+000278e0: 6620 5f73 696d 706c 6966 6965 6428 7365  f _simplified(se
+000278f0: 6c66 293a 0a20 2020 2020 2020 2069 6620  lf):.        if 
+00027900: 5f65 7175 616c 735f 7363 616c 6172 5f63  _equals_scalar_c
+00027910: 6f6e 7374 616e 7428 7365 6c66 2e6c 656e  onstant(self.len
+00027920: 6774 682c 2031 293a 0a20 2020 2020 2020  gth, 1):.       
+00027930: 2020 2020 2072 6574 7572 6e20 5a65 726f       return Zero
+00027940: 7328 2829 2c20 696e 7429 0a0a 0a63 6c61  s((), int)...cla
+00027950: 7373 204c 6f6f 7053 756d 2841 7272 6179  ss LoopSum(Array
+00027960: 293a 0a0a 2020 2020 6465 6620 5f5f 696e  ):..    def __in
+00027970: 6974 5f5f 2873 656c 662c 2066 756e 633a  it__(self, func:
+00027980: 2041 7272 6179 2c20 7368 6170 653a 2074   Array, shape: t
+00027990: 7970 696e 672e 5475 706c 655b 4172 7261  yping.Tuple[Arra
+000279a0: 792c 202e 2e2e 5d2c 2069 6e64 6578 5f6e  y, ...], index_n
+000279b0: 616d 653a 2073 7472 2c20 6c65 6e67 7468  ame: str, length
+000279c0: 3a20 4172 7261 7929 3a0a 2020 2020 2020  : Array):.      
+000279d0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+000279e0: 6e63 6528 6675 6e63 2c20 4172 7261 7929  nce(func, Array)
+000279f0: 2061 6e64 2066 756e 632e 6474 7970 6520   and func.dtype 
+00027a00: 213d 2062 6f6f 6c2c 2066 2766 756e 633d  != bool, f'func=
+00027a10: 7b66 756e 6321 727d 270a 2020 2020 2020  {func!r}'.      
+00027a20: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00027a30: 6e63 6528 7368 6170 652c 2074 7570 6c65  nce(shape, tuple
+00027a40: 2920 616e 6420 616c 6c28 5f69 7369 6e64  ) and all(_isind
+00027a50: 6578 286e 2920 666f 7220 6e20 696e 2073  ex(n) for n in s
+00027a60: 6861 7065 292c 2066 2773 6861 7065 3d7b  hape), f'shape={
+00027a70: 7368 6170 6521 727d 270a 2020 2020 2020  shape!r}'.      
+00027a80: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00027a90: 6e63 6528 696e 6465 785f 6e61 6d65 2c20  nce(index_name, 
+00027aa0: 7374 7229 2c20 6627 696e 6465 785f 6e61  str), f'index_na
+00027ab0: 6d65 3d7b 696e 6465 785f 6e61 6d65 2172  me={index_name!r
+00027ac0: 7d27 0a20 2020 2020 2020 2061 7373 6572  }'.        asser
+00027ad0: 7420 5f69 7369 6e64 6578 286c 656e 6774  t _isindex(lengt
+00027ae0: 6829 2c20 6627 6c65 6e67 7468 3d7b 6c65  h), f'length={le
+00027af0: 6e67 7468 2172 7d27 0a20 2020 2020 2020  ngth!r}'.       
+00027b00: 2061 7373 6572 7420 6675 6e63 2e6e 6469   assert func.ndi
+00027b10: 6d20 3d3d 206c 656e 2873 6861 7065 290a  m == len(shape).
+00027b20: 2020 2020 2020 2020 7365 6c66 2e69 6e64          self.ind
+00027b30: 6578 203d 206c 6f6f 705f 696e 6465 7828  ex = loop_index(
+00027b40: 696e 6465 785f 6e61 6d65 2c20 6c65 6e67  index_name, leng
+00027b50: 7468 290a 2020 2020 2020 2020 6966 2061  th).        if a
+00027b60: 6e79 2873 656c 662e 696e 6465 7820 696e  ny(self.index in
+00027b70: 206e 2e61 7267 756d 656e 7473 2066 6f72   n.arguments for
+00027b80: 206e 2069 6e20 7368 6170 6529 3a0a 2020   n in shape):.  
+00027b90: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00027ba0: 5661 6c75 6545 7272 6f72 2827 7468 6520  ValueError('the 
+00027bb0: 7368 6170 6520 6f66 2074 6865 2066 756e  shape of the fun
+00027bc0: 6374 696f 6e20 6d75 7374 206e 6f74 2064  ction must not d
+00027bd0: 6570 656e 6420 6f6e 2074 6865 2069 6e64  epend on the ind
+00027be0: 6578 2729 0a20 2020 2020 2020 2073 656c  ex').        sel
+00027bf0: 662e 6675 6e63 203d 2066 756e 630a 2020  f.func = func.  
+00027c00: 2020 2020 2020 7365 6c66 2e5f 696e 7661        self._inva
+00027c10: 7269 616e 7473 2c20 7365 6c66 2e5f 6465  riants, self._de
+00027c20: 7065 6e64 656e 6369 6573 203d 205f 6465  pendencies = _de
+00027c30: 7065 6e64 656e 6369 6573 5f73 616e 735f  pendencies_sans_
+00027c40: 696e 7661 7269 616e 7473 2866 756e 632c  invariants(func,
+00027c50: 2073 656c 662e 696e 6465 7829 0a20 2020   self.index).   
+00027c60: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+00027c70: 6e69 745f 5f28 6172 6773 3d28 5475 706c  nit__(args=(Tupl
+00027c80: 6528 7368 6170 6529 2c20 6c65 6e67 7468  e(shape), length
+00027c90: 2c20 2a73 656c 662e 5f69 6e76 6172 6961  , *self._invaria
+00027ca0: 6e74 7329 2c20 7368 6170 653d 7368 6170  nts), shape=shap
+00027cb0: 652c 2064 7479 7065 3d66 756e 632e 6474  e, dtype=func.dt
+00027cc0: 7970 6529 0a0a 2020 2020 4063 6163 6865  ype)..    @cache
+00027cd0: 645f 7072 6f70 6572 7479 0a20 2020 2064  d_property.    d
+00027ce0: 6566 205f 7365 7269 616c 697a 6564 5f6c  ef _serialized_l
+00027cf0: 6f6f 7028 7365 6c66 293a 0a20 2020 2020  oop(self):.     
+00027d00: 2020 2069 6e64 6963 6573 203d 207b 643a     indices = {d:
+00027d10: 2069 2066 6f72 2069 2c20 6420 696e 2065   i for i, d in e
+00027d20: 6e75 6d65 7261 7465 2869 7465 7274 6f6f  numerate(itertoo
+00027d30: 6c73 2e63 6861 696e 285b 7365 6c66 2e69  ls.chain([self.i
+00027d40: 6e64 6578 5d2c 2073 656c 662e 5f69 6e76  ndex], self._inv
+00027d50: 6172 6961 6e74 732c 2073 656c 662e 5f64  ariants, self._d
+00027d60: 6570 656e 6465 6e63 6965 7329 297d 0a20  ependencies))}. 
+00027d70: 2020 2020 2020 2072 6574 7572 6e20 7475         return tu
+00027d80: 706c 6528 2864 6570 2c20 7475 706c 6528  ple((dep, tuple(
+00027d90: 6d61 7028 696e 6469 6365 732e 5f5f 6765  map(indices.__ge
+00027da0: 7469 7465 6d5f 5f2c 2064 6570 2e5f 4576  titem__, dep._Ev
+00027db0: 616c 7561 626c 655f 5f61 7267 7329 2929  aluable__args)))
+00027dc0: 2066 6f72 2064 6570 2069 6e20 7365 6c66   for dep in self
+00027dd0: 2e5f 6465 7065 6e64 656e 6369 6573 290a  ._dependencies).
+00027de0: 0a20 2020 2023 2054 6869 7320 7072 6f70  .    # This prop
+00027df0: 6572 7479 2069 7320 6120 6465 7269 7661  erty is a deriva
+00027e00: 7469 6f6e 206f 6620 605f 7365 7269 616c  tion of `_serial
+00027e10: 697a 6564 6020 7768 6572 6520 7468 6520  ized` where the 
+00027e20: 6045 7661 6c75 6162 6c65 600a 2020 2020  `Evaluable`.    
+00027e30: 2320 696e 7374 616e 6365 7320 6172 6520  # instances are 
+00027e40: 6d61 7070 6564 2074 6f20 7468 6520 6065  mapped to the `e
+00027e50: 7661 6c66 6020 6d65 7468 6f64 7320 6f66  valf` methods of
+00027e60: 2074 6865 2069 6e73 7461 6e63 6573 2e20   the instances. 
+00027e70: 4173 7365 7274 696e 670a 2020 2020 2320  Asserting.    # 
+00027e80: 7468 6174 2066 756e 6374 696f 6e73 2061  that functions a
+00027e90: 7265 2069 6d6d 7574 6162 6c65 2069 7320  re immutable is 
+00027ea0: 6469 6666 6963 756c 7420 616e 6420 6375  difficult and cu
+00027eb0: 7272 656e 746c 790a 2020 2020 2320 6074  rrently.    # `t
+00027ec0: 7970 6573 2e5f 6973 696d 6d75 7461 626c  ypes._isimmutabl
+00027ed0: 6560 206d 6172 6b73 2061 6c6c 2066 756e  e` marks all fun
+00027ee0: 6374 696f 6e73 2061 7320 6d75 7461 626c  ctions as mutabl
+00027ef0: 652e 2053 696e 6365 2074 6865 0a20 2020  e. Since the.   
+00027f00: 2023 2060 7479 7065 732e 4361 6368 654d   # `types.CacheM
+00027f10: 6574 6160 206d 6163 6869 6e65 7279 2061  eta` machinery a
+00027f20: 7373 6572 7473 2069 6d6d 7574 6162 696c  sserts immutabil
+00027f30: 6974 7920 6f66 2074 6865 2070 726f 7065  ity of the prope
+00027f40: 7274 792c 2077 6520 6861 7665 0a20 2020  rty, we have.   
+00027f50: 2023 2074 6f20 7265 736f 7274 2074 6f20   # to resort to 
+00027f60: 6120 7265 6775 6c61 7220 6066 756e 6374  a regular `funct
+00027f70: 6f6f 6c73 2e63 6163 6865 645f 7072 6f70  ools.cached_prop
+00027f80: 6572 7479 602e 204e 6576 6572 7468 656c  erty`. Neverthel
+00027f90: 6573 732c 2074 6869 730a 2020 2020 2320  ess, this.    # 
+00027fa0: 7072 6f70 6572 7479 2073 686f 756c 6420  property should 
+00027fb0: 6265 2074 7265 6174 6564 2061 7320 6966  be treated as if
+00027fc0: 2069 7420 6973 2069 6d6d 7574 6162 6c65   it is immutable
+00027fd0: 2e0a 2020 2020 4063 6163 6865 645f 7072  ..    @cached_pr
+00027fe0: 6f70 6572 7479 0a20 2020 2064 6566 205f  operty.    def _
+00027ff0: 7365 7269 616c 697a 6564 5f6c 6f6f 705f  serialized_loop_
+00028000: 6576 616c 6628 7365 6c66 293a 0a20 2020  evalf(self):.   
+00028010: 2020 2020 2072 6574 7572 6e20 7475 706c       return tupl
+00028020: 6528 2864 6570 2e65 7661 6c66 2c20 696e  e((dep.evalf, in
+00028030: 6469 6365 7329 2066 6f72 2064 6570 2c20  dices) for dep, 
+00028040: 696e 6469 6365 7320 696e 2073 656c 662e  indices in self.
+00028050: 5f73 6572 6961 6c69 7a65 645f 6c6f 6f70  _serialized_loop
+00028060: 290a 0a20 2020 2064 6566 2065 7661 6c66  )..    def evalf
+00028070: 2873 656c 662c 2073 6861 7065 2c20 6c65  (self, shape, le
+00028080: 6e67 7468 2c20 2a61 7267 7329 3a0a 2020  ngth, *args):.  
+00028090: 2020 2020 2020 7365 7269 616c 697a 6564        serialized
+000280a0: 5f65 7661 6c66 203d 2073 656c 662e 5f73  _evalf = self._s
+000280b0: 6572 6961 6c69 7a65 645f 6c6f 6f70 5f65  erialized_loop_e
+000280c0: 7661 6c66 0a20 2020 2020 2020 2072 6573  valf.        res
+000280d0: 756c 7420 3d20 6e75 6d70 792e 7a65 726f  ult = numpy.zero
+000280e0: 7328 7368 6170 652c 2073 656c 662e 6474  s(shape, self.dt
+000280f0: 7970 6529 0a20 2020 2020 2020 2066 6f72  ype).        for
+00028100: 2069 6e64 6578 2069 6e20 7261 6e67 6528   index in range(
+00028110: 6c65 6e67 7468 293a 0a20 2020 2020 2020  length):.       
+00028120: 2020 2020 2076 616c 7565 7320 3d20 5b6e       values = [n
+00028130: 756d 7079 2e61 7272 6179 2869 6e64 6578  umpy.array(index
+00028140: 295d 0a20 2020 2020 2020 2020 2020 2076  )].            v
+00028150: 616c 7565 732e 6578 7465 6e64 2861 7267  alues.extend(arg
+00028160: 7329 0a20 2020 2020 2020 2020 2020 2076  s).            v
+00028170: 616c 7565 732e 6578 7465 6e64 286f 705f  alues.extend(op_
+00028180: 6576 616c 6628 2a5b 7661 6c75 6573 5b69  evalf(*[values[i
+00028190: 5d20 666f 7220 6920 696e 2069 6e64 6963  ] for i in indic
+000281a0: 6573 5d29 2066 6f72 206f 705f 6576 616c  es]) for op_eval
+000281b0: 662c 2069 6e64 6963 6573 2069 6e20 7365  f, indices in se
+000281c0: 7269 616c 697a 6564 5f65 7661 6c66 290a  rialized_evalf).
+000281d0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+000281e0: 6c74 202b 3d20 7661 6c75 6573 5b2d 315d  lt += values[-1]
+000281f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00028200: 7265 7375 6c74 0a0a 2020 2020 6465 6620  result..    def 
+00028210: 6576 616c 665f 7769 7468 7469 6d65 7328  evalf_withtimes(
+00028220: 7365 6c66 2c20 7469 6d65 732c 2073 6861  self, times, sha
+00028230: 7065 2c20 6c65 6e67 7468 2c20 2a61 7267  pe, length, *arg
+00028240: 7329 3a0a 2020 2020 2020 2020 7365 7269  s):.        seri
+00028250: 616c 697a 6564 203d 2073 656c 662e 5f73  alized = self._s
+00028260: 6572 6961 6c69 7a65 645f 6c6f 6f70 0a20  erialized_loop. 
+00028270: 2020 2020 2020 2073 7562 7469 6d65 7320         subtimes 
+00028280: 3d20 7469 6d65 732e 7365 7464 6566 6175  = times.setdefau
+00028290: 6c74 2873 656c 662c 2063 6f6c 6c65 6374  lt(self, collect
+000282a0: 696f 6e73 2e64 6566 6175 6c74 6469 6374  ions.defaultdict
+000282b0: 285f 5374 6174 7329 290a 2020 2020 2020  (_Stats)).      
+000282c0: 2020 7265 7375 6c74 203d 206e 756d 7079    result = numpy
+000282d0: 2e7a 6572 6f73 2873 6861 7065 2c20 7365  .zeros(shape, se
+000282e0: 6c66 2e64 7479 7065 290a 2020 2020 2020  lf.dtype).      
+000282f0: 2020 666f 7220 696e 6465 7820 696e 2072    for index in r
+00028300: 616e 6765 286c 656e 6774 6829 3a0a 2020  ange(length):.  
+00028310: 2020 2020 2020 2020 2020 7661 6c75 6573            values
+00028320: 203d 205b 6e75 6d70 792e 6172 7261 7928   = [numpy.array(
+00028330: 696e 6465 7829 5d0a 2020 2020 2020 2020  index)].        
+00028340: 2020 2020 7661 6c75 6573 2e65 7874 656e      values.exten
+00028350: 6428 6172 6773 290a 2020 2020 2020 2020  d(args).        
+00028360: 2020 2020 7661 6c75 6573 2e65 7874 656e      values.exten
+00028370: 6428 6f70 2e65 7661 6c66 5f77 6974 6874  d(op.evalf_witht
+00028380: 696d 6573 2873 7562 7469 6d65 732c 202a  imes(subtimes, *
+00028390: 5b76 616c 7565 735b 695d 2066 6f72 2069  [values[i] for i
+000283a0: 2069 6e20 696e 6469 6365 735d 2920 666f   in indices]) fo
+000283b0: 7220 6f70 2c20 696e 6469 6365 7320 696e  r op, indices in
+000283c0: 2073 6572 6961 6c69 7a65 6429 0a20 2020   serialized).   
+000283d0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+000283e0: 2b3d 2076 616c 7565 735b 2d31 5d0a 2020  += values[-1].  
+000283f0: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00028400: 756c 740a 0a20 2020 2064 6566 205f 6465  ult..    def _de
+00028410: 7269 7661 7469 7665 2873 656c 662c 2076  rivative(self, v
+00028420: 6172 2c20 7365 656e 293a 0a20 2020 2020  ar, seen):.     
+00028430: 2020 2072 6574 7572 6e20 6c6f 6f70 5f73     return loop_s
+00028440: 756d 2864 6572 6976 6174 6976 6528 7365  um(derivative(se
+00028450: 6c66 2e66 756e 632c 2076 6172 2c20 7365  lf.func, var, se
+00028460: 656e 292c 2073 656c 662e 696e 6465 7829  en), self.index)
+00028470: 0a0a 2020 2020 6465 6620 5f6e 6f64 6528  ..    def _node(
+00028480: 7365 6c66 2c20 6361 6368 652c 2073 7562  self, cache, sub
+00028490: 6772 6170 682c 2074 696d 6573 293a 0a20  graph, times):. 
+000284a0: 2020 2020 2020 2069 6620 7365 6c66 2069         if self i
+000284b0: 6e20 6361 6368 653a 0a20 2020 2020 2020  n cache:.       
+000284c0: 2020 2020 2072 6574 7572 6e20 6361 6368       return cach
+000284d0: 655b 7365 6c66 5d0a 2020 2020 2020 2020  e[self].        
+000284e0: 7375 6263 6163 6865 203d 207b 7d0a 2020  subcache = {}.  
+000284f0: 2020 2020 2020 666f 7220 6172 6720 696e        for arg in
+00028500: 2073 656c 662e 5f45 7661 6c75 6162 6c65   self._Evaluable
+00028510: 5f5f 6172 6773 3a0a 2020 2020 2020 2020  __args:.        
+00028520: 2020 2020 7375 6263 6163 6865 5b61 7267      subcache[arg
+00028530: 5d20 3d20 6172 672e 5f6e 6f64 6528 6361  ] = arg._node(ca
+00028540: 6368 652c 2073 7562 6772 6170 682c 2074  che, subgraph, t
+00028550: 696d 6573 290a 2020 2020 2020 2020 6c6f  imes).        lo
+00028560: 6f70 6772 6170 6820 3d20 5375 6267 7261  opgraph = Subgra
+00028570: 7068 2827 4c6f 6f70 272c 2073 7562 6772  ph('Loop', subgr
+00028580: 6170 6829 0a20 2020 2020 2020 2073 7562  aph).        sub
+00028590: 7469 6d65 7320 3d20 7469 6d65 732e 6765  times = times.ge
+000285a0: 7428 7365 6c66 2c20 636f 6c6c 6563 7469  t(self, collecti
+000285b0: 6f6e 732e 6465 6661 756c 7464 6963 7428  ons.defaultdict(
+000285c0: 5f53 7461 7473 2929 0a20 2020 2020 2020  _Stats)).       
+000285d0: 2073 756d 5f6b 7761 7267 7320 3d20 7b27   sum_kwargs = {'
+000285e0: 7368 6170 655b 7b7d 5d27 2e66 6f72 6d61  shape[{}]'.forma
+000285f0: 7428 6929 3a20 6e2e 5f6e 6f64 6528 6361  t(i): n._node(ca
+00028600: 6368 652c 2073 7562 6772 6170 682c 2074  che, subgraph, t
+00028610: 696d 6573 2920 666f 7220 692c 206e 2069  imes) for i, n i
+00028620: 6e20 656e 756d 6572 6174 6528 7365 6c66  n enumerate(self
+00028630: 2e73 6861 7065 297d 0a20 2020 2020 2020  .shape)}.       
+00028640: 2073 756d 5f6b 7761 7267 735b 2766 756e   sum_kwargs['fun
+00028650: 6327 5d20 3d20 7365 6c66 2e66 756e 632e  c'] = self.func.
+00028660: 5f6e 6f64 6528 7375 6263 6163 6865 2c20  _node(subcache, 
+00028670: 6c6f 6f70 6772 6170 682c 2073 7562 7469  loopgraph, subti
+00028680: 6d65 7329 0a20 2020 2020 2020 2063 6163  mes).        cac
+00028690: 6865 5b73 656c 665d 203d 206e 6f64 6520  he[self] = node 
+000286a0: 3d20 5265 6775 6c61 724e 6f64 6528 274c  = RegularNode('L
+000286b0: 6f6f 7053 756d 272c 2028 292c 2073 756d  oopSum', (), sum
+000286c0: 5f6b 7761 7267 732c 2028 7479 7065 2873  _kwargs, (type(s
+000286d0: 656c 6629 2e5f 5f6e 616d 655f 5f2c 2073  elf).__name__, s
+000286e0: 7562 7469 6d65 735b 2773 756d 275d 292c  ubtimes['sum']),
+000286f0: 206c 6f6f 7067 7261 7068 290a 2020 2020   loopgraph).    
+00028700: 2020 2020 7265 7475 726e 206e 6f64 650a      return node.
+00028710: 0a20 2020 2064 6566 205f 7369 6d70 6c69  .    def _simpli
+00028720: 6669 6564 2873 656c 6629 3a0a 2020 2020  fied(self):.    
+00028730: 2020 2020 6966 2069 737a 6572 6f28 7365      if iszero(se
+00028740: 6c66 2e66 756e 6329 3a0a 2020 2020 2020  lf.func):.      
+00028750: 2020 2020 2020 7265 7475 726e 207a 6572        return zer
+00028760: 6f73 5f6c 696b 6528 7365 6c66 290a 2020  os_like(self).  
+00028770: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
+00028780: 696e 6465 7820 6e6f 7420 696e 2073 656c  index not in sel
+00028790: 662e 6675 6e63 2e61 7267 756d 656e 7473  f.func.arguments
+000287a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000287b0: 7475 726e 2073 656c 662e 6675 6e63 202a  turn self.func *
+000287c0: 2073 656c 662e 696e 6465 782e 6c65 6e67   self.index.leng
+000287d0: 7468 0a20 2020 2020 2020 2072 6574 7572  th.        retur
+000287e0: 6e20 7365 6c66 2e66 756e 632e 5f6c 6f6f  n self.func._loo
+000287f0: 7073 756d 2873 656c 662e 696e 6465 7829  psum(self.index)
+00028800: 0a0a 2020 2020 6465 6620 5f74 616b 6564  ..    def _taked
+00028810: 6961 6728 7365 6c66 2c20 6178 6973 312c  iag(self, axis1,
+00028820: 2061 7869 7332 293a 0a20 2020 2020 2020   axis2):.       
+00028830: 2072 6574 7572 6e20 6c6f 6f70 5f73 756d   return loop_sum
+00028840: 285f 7461 6b65 6469 6167 2873 656c 662e  (_takediag(self.
+00028850: 6675 6e63 2c20 6178 6973 312c 2061 7869  func, axis1, axi
+00028860: 7332 292c 2073 656c 662e 696e 6465 7829  s2), self.index)
+00028870: 0a0a 2020 2020 6465 6620 5f74 616b 6528  ..    def _take(
+00028880: 7365 6c66 2c20 696e 6465 782c 2061 7869  self, index, axi
+00028890: 7329 3a0a 2020 2020 2020 2020 7265 7475  s):.        retu
+000288a0: 726e 206c 6f6f 705f 7375 6d28 5f74 616b  rn loop_sum(_tak
+000288b0: 6528 7365 6c66 2e66 756e 632c 2069 6e64  e(self.func, ind
+000288c0: 6578 2c20 6178 6973 292c 2073 656c 662e  ex, axis), self.
+000288d0: 696e 6465 7829 0a0a 2020 2020 6465 6620  index)..    def 
+000288e0: 5f75 6e72 6176 656c 2873 656c 662c 2061  _unravel(self, a
+000288f0: 7869 732c 2073 6861 7065 293a 0a20 2020  xis, shape):.   
+00028900: 2020 2020 2072 6574 7572 6e20 6c6f 6f70       return loop
+00028910: 5f73 756d 2875 6e72 6176 656c 2873 656c  _sum(unravel(sel
+00028920: 662e 6675 6e63 2c20 6178 6973 2c20 7368  f.func, axis, sh
+00028930: 6170 6529 2c20 7365 6c66 2e69 6e64 6578  ape), self.index
+00028940: 290a 0a20 2020 2064 6566 205f 7375 6d28  )..    def _sum(
+00028950: 7365 6c66 2c20 6178 6973 293a 0a20 2020  self, axis):.   
+00028960: 2020 2020 2072 6574 7572 6e20 6c6f 6f70       return loop
+00028970: 5f73 756d 2873 756d 2873 656c 662e 6675  _sum(sum(self.fu
+00028980: 6e63 2c20 6178 6973 292c 2073 656c 662e  nc, axis), self.
+00028990: 696e 6465 7829 0a0a 2020 2020 6465 6620  index)..    def 
+000289a0: 5f61 6464 2873 656c 662c 206f 7468 6572  _add(self, other
+000289b0: 293a 0a20 2020 2020 2020 2069 6620 6973  ):.        if is
+000289c0: 696e 7374 616e 6365 286f 7468 6572 2c20  instance(other, 
+000289d0: 4c6f 6f70 5375 6d29 2061 6e64 206f 7468  LoopSum) and oth
+000289e0: 6572 2e69 6e64 6578 203d 3d20 7365 6c66  er.index == self
+000289f0: 2e69 6e64 6578 3a0a 2020 2020 2020 2020  .index:.        
+00028a00: 2020 2020 7265 7475 726e 206c 6f6f 705f      return loop_
+00028a10: 7375 6d28 7365 6c66 2e66 756e 6320 2b20  sum(self.func + 
+00028a20: 6f74 6865 722e 6675 6e63 2c20 7365 6c66  other.func, self
+00028a30: 2e69 6e64 6578 290a 0a20 2020 2064 6566  .index)..    def
+00028a40: 205f 6d75 6c74 6970 6c79 2873 656c 662c   _multiply(self,
+00028a50: 206f 7468 6572 293a 0a20 2020 2020 2020   other):.       
+00028a60: 2023 2049 6620 606f 7468 6572 6020 6465   # If `other` de
+00028a70: 7065 6e64 7320 6f6e 2060 7365 6c66 2e69  pends on `self.i
+00028a80: 6e64 6578 602c 2065 2e67 2e20 6265 6361  ndex`, e.g. beca
+00028a90: 7573 6520 6073 656c 6660 2069 7320 7468  use `self` is th
+00028aa0: 6520 696e 6e65 720a 2020 2020 2020 2020  e inner.        
+00028ab0: 2320 6c6f 6f70 206f 6620 7477 6f20 6e65  # loop of two ne
+00028ac0: 7374 6564 2060 4c6f 6f70 5375 6d60 7320  sted `LoopSum`s 
+00028ad0: 6f76 6572 2074 6865 2073 616d 6520 696e  over the same in
+00028ae0: 6465 782c 2074 6865 6e20 7765 2073 686f  dex, then we sho
+00028af0: 756c 6420 6e6f 740a 2020 2020 2020 2020  uld not.        
+00028b00: 2320 6d6f 7665 2060 6f74 6865 7260 2069  # move `other` i
+00028b10: 6e73 6964 6520 7468 6973 206c 6f6f 702e  nside this loop.
+00028b20: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00028b30: 2e69 6e64 6578 206e 6f74 2069 6e20 6f74  .index not in ot
+00028b40: 6865 722e 6172 6775 6d65 6e74 733a 0a20  her.arguments:. 
+00028b50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00028b60: 6e20 6c6f 6f70 5f73 756d 2873 656c 662e  n loop_sum(self.
+00028b70: 6675 6e63 202a 206f 7468 6572 2c20 7365  func * other, se
+00028b80: 6c66 2e69 6e64 6578 290a 0a20 2020 2040  lf.index)..    @
+00028b90: 6361 6368 6564 5f70 726f 7065 7274 790a  cached_property.
+00028ba0: 2020 2020 6465 6620 5f61 7373 7061 7273      def _asspars
+00028bb0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+00028bc0: 2063 6875 6e6b 7320 3d20 5b5d 0a20 2020   chunks = [].   
+00028bd0: 2020 2020 2066 6f72 202a 656c 656d 5f69       for *elem_i
+00028be0: 6e64 6963 6573 2c20 656c 656d 5f76 616c  ndices, elem_val
+00028bf0: 7565 7320 696e 2073 656c 662e 6675 6e63  ues in self.func
+00028c00: 2e5f 6173 7370 6172 7365 3a0a 2020 2020  ._assparse:.    
+00028c10: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00028c20: 6e64 696d 203d 3d20 303a 0a20 2020 2020  ndim == 0:.     
+00028c30: 2020 2020 2020 2020 2020 2076 616c 7565             value
+00028c40: 7320 3d20 6c6f 6f70 5f63 6f6e 6361 7465  s = loop_concate
+00028c50: 6e61 7465 2849 6e73 6572 7441 7869 7328  nate(InsertAxis(
+00028c60: 656c 656d 5f76 616c 7565 732c 2063 6f6e  elem_values, con
+00028c70: 7374 616e 7428 3129 292c 2073 656c 662e  stant(1)), self.
+00028c80: 696e 6465 7829 0a20 2020 2020 2020 2020  index).         
+00028c90: 2020 2020 2020 2077 6869 6c65 2076 616c         while val
+00028ca0: 7565 732e 6e64 696d 3a0a 2020 2020 2020  ues.ndim:.      
+00028cb0: 2020 2020 2020 2020 2020 2020 2020 7661                va
+00028cc0: 6c75 6573 203d 2053 756d 2876 616c 7565  lues = Sum(value
+00028cd0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00028ce0: 2020 2063 6875 6e6b 732e 6170 7065 6e64     chunks.append
+00028cf0: 2828 7661 6c75 6573 2c29 290a 2020 2020  ((values,)).    
+00028d00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00028d10: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00028d20: 2065 6c65 6d5f 7661 6c75 6573 2e6e 6469   elem_values.ndi
+00028d30: 6d20 3d3d 2030 3a0a 2020 2020 2020 2020  m == 0:.        
+00028d40: 2020 2020 2020 2020 2020 2020 2a65 6c65              *ele
+00028d50: 6d5f 696e 6469 6365 732c 2065 6c65 6d5f  m_indices, elem_
+00028d60: 7661 6c75 6573 203d 2028 496e 7365 7274  values = (Insert
+00028d70: 4178 6973 2861 7272 2c20 636f 6e73 7461  Axis(arr, consta
+00028d80: 6e74 2831 2929 2066 6f72 2061 7272 2069  nt(1)) for arr i
+00028d90: 6e20 282a 656c 656d 5f69 6e64 6963 6573  n (*elem_indices
+00028da0: 2c20 656c 656d 5f76 616c 7565 7329 290a  , elem_values)).
+00028db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028dc0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00028dd0: 2020 2020 2020 2020 2020 2320 6d69 6e69            # mini
+00028de0: 6d69 7a65 2072 6176 656c 7320 6279 2074  mize ravels by t
+00028df0: 7261 6e73 706f 7369 6e67 2061 6c6c 2076  ransposing all v
+00028e00: 6172 6961 626c 6520 6c65 6e67 7468 2061  ariable length a
+00028e10: 7865 7320 746f 2074 6865 2065 6e64 0a20  xes to the end. 
+00028e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028e30: 2020 2076 6172 6961 626c 6520 3d20 7475     variable = tu
+00028e40: 706c 6528 6920 666f 7220 692c 206e 2069  ple(i for i, n i
+00028e50: 6e20 656e 756d 6572 6174 6528 656c 656d  n enumerate(elem
+00028e60: 5f76 616c 7565 732e 7368 6170 6529 2069  _values.shape) i
+00028e70: 6620 7365 6c66 2e69 6e64 6578 2069 6e20  f self.index in 
+00028e80: 6e2e 6172 6775 6d65 6e74 7329 0a20 2020  n.arguments).   
 00028e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028ea0: 6173 7365 7274 2061 6c6c 2873 656c 662e  assert all(self.
-00028eb0: 696e 6465 7820 6e6f 7420 696e 206e 2e61  index not in n.a
-00028ec0: 7267 756d 656e 7473 2066 6f72 206e 2069  rguments for n i
-00028ed0: 6e20 656c 656d 5f76 616c 7565 732e 7368  n elem_values.sh
-00028ee0: 6170 655b 3a2d 315d 290a 2020 2020 2020  ape[:-1]).      
-00028ef0: 2020 2020 2020 2020 2020 6368 756e 6b73            chunks
-00028f00: 2e61 7070 656e 6428 7475 706c 6528 6c6f  .append(tuple(lo
-00028f10: 6f70 5f63 6f6e 6361 7465 6e61 7465 2861  op_concatenate(a
-00028f20: 7272 2c20 7365 6c66 2e69 6e64 6578 2920  rr, self.index) 
-00028f30: 666f 7220 6172 7220 696e 2028 2a65 6c65  for arr in (*ele
-00028f40: 6d5f 696e 6469 6365 732c 2065 6c65 6d5f  m_indices, elem_
-00028f50: 7661 6c75 6573 2929 290a 2020 2020 2020  values))).      
-00028f60: 2020 7265 7475 726e 2074 7570 6c65 2863    return tuple(c
-00028f70: 6875 6e6b 7329 0a0a 0a63 6c61 7373 205f  hunks)...class _
-00028f80: 5369 7a65 7354 6f4f 6666 7365 7473 2841  SizesToOffsets(A
-00028f90: 7272 6179 293a 0a0a 2020 2020 6465 6620  rray):..    def 
-00028fa0: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
-00028fb0: 697a 6573 293a 0a20 2020 2020 2020 2061  izes):.        a
-00028fc0: 7373 6572 7420 7369 7a65 732e 6e64 696d  ssert sizes.ndim
-00028fd0: 203d 3d20 310a 2020 2020 2020 2020 6173   == 1.        as
-00028fe0: 7365 7274 2073 697a 6573 2e64 7479 7065  sert sizes.dtype
-00028ff0: 203d 3d20 696e 740a 2020 2020 2020 2020   == int.        
-00029000: 6173 7365 7274 2073 697a 6573 2e5f 696e  assert sizes._in
-00029010: 7462 6f75 6e64 735b 305d 203e 3d20 300a  tbounds[0] >= 0.
-00029020: 2020 2020 2020 2020 7365 6c66 2e5f 7369          self._si
-00029030: 7a65 7320 3d20 7369 7a65 730a 2020 2020  zes = sizes.    
-00029040: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-00029050: 6974 5f5f 2861 7267 733d 2873 697a 6573  it__(args=(sizes
-00029060: 2c29 2c20 7368 6170 653d 2873 697a 6573  ,), shape=(sizes
-00029070: 2e73 6861 7065 5b30 5d2b 312c 292c 2064  .shape[0]+1,), d
-00029080: 7479 7065 3d69 6e74 290a 0a20 2020 2040  type=int)..    @
-00029090: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-000290a0: 2064 6566 2065 7661 6c66 2873 697a 6573   def evalf(sizes
-000290b0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-000290c0: 6e20 6e75 6d70 792e 6375 6d73 756d 285b  n numpy.cumsum([
-000290d0: 302c 202a 7369 7a65 735d 290a 0a20 2020  0, *sizes])..   
-000290e0: 2064 6566 205f 7369 6d70 6c69 6669 6564   def _simplified
-000290f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00029100: 756e 616c 6967 6e65 642c 2077 6865 7265  unaligned, where
-00029110: 203d 2075 6e61 6c69 676e 2873 656c 662e   = unalign(self.
-00029120: 5f73 697a 6573 290a 2020 2020 2020 2020  _sizes).        
-00029130: 6966 206e 6f74 2077 6865 7265 3a0a 2020  if not where:.  
-00029140: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00029150: 2052 616e 6765 2873 656c 662e 7368 6170   Range(self.shap
-00029160: 655b 305d 2920 2a20 6170 7065 6e64 6178  e[0]) * appendax
-00029170: 6573 2875 6e61 6c69 676e 6564 2c20 7365  es(unaligned, se
-00029180: 6c66 2e73 6861 7065 5b3a 315d 290a 0a20  lf.shape[:1]).. 
-00029190: 2020 2064 6566 205f 696e 7462 6f75 6e64     def _intbound
-000291a0: 735f 696d 706c 2873 656c 6629 3a0a 2020  s_impl(self):.  
-000291b0: 2020 2020 2020 6e20 3d20 7365 6c66 2e5f        n = self._
-000291c0: 7369 7a65 732e 7368 6170 655b 305d 2e5f  sizes.shape[0]._
-000291d0: 696e 7462 6f75 6e64 735b 315d 0a20 2020  intbounds[1].   
-000291e0: 2020 2020 206d 203d 2073 656c 662e 5f73       m = self._s
-000291f0: 697a 6573 2e5f 696e 7462 6f75 6e64 735b  izes._intbounds[
-00029200: 315d 0a20 2020 2020 2020 2072 6574 7572  1].        retur
-00029210: 6e20 302c 2028 3020 6966 206e 203d 3d20  n 0, (0 if n == 
-00029220: 3020 6f72 206d 203d 3d20 3020 656c 7365  0 or m == 0 else
-00029230: 206e 202a 206d 290a 0a0a 636c 6173 7320   n * m)...class 
-00029240: 4c6f 6f70 436f 6e63 6174 656e 6174 6528  LoopConcatenate(
-00029250: 4172 7261 7929 3a0a 0a20 2020 2064 6566  Array):..    def
-00029260: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00029270: 6675 6e63 6461 7461 3a20 7479 7069 6e67  funcdata: typing
-00029280: 2e54 7570 6c65 5b41 7272 6179 2c20 2e2e  .Tuple[Array, ..
-00029290: 2e5d 2c20 696e 6465 785f 6e61 6d65 3a20  .], index_name: 
-000292a0: 7374 722c 206c 656e 6774 683a 2041 7272  str, length: Arr
-000292b0: 6179 293a 0a20 2020 2020 2020 2061 7373  ay):.        ass
-000292c0: 6572 7420 6973 696e 7374 616e 6365 2866  ert isinstance(f
-000292d0: 756e 6364 6174 612c 2074 7570 6c65 2920  uncdata, tuple) 
-000292e0: 616e 6420 616c 6c28 6973 696e 7374 616e  and all(isinstan
-000292f0: 6365 2864 2c20 4172 7261 7929 2066 6f72  ce(d, Array) for
-00029300: 2064 2069 6e20 6675 6e63 6461 7461 292c   d in funcdata),
-00029310: 2066 2766 756e 6364 6174 613d 7b66 756e   f'funcdata={fun
-00029320: 6364 6174 6121 727d 270a 2020 2020 2020  cdata!r}'.      
-00029330: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-00029340: 6e63 6528 696e 6465 785f 6e61 6d65 2c20  nce(index_name, 
-00029350: 7374 7229 2c20 6627 696e 6465 785f 6e61  str), f'index_na
-00029360: 6d65 3d7b 696e 6465 785f 6e61 6d65 2172  me={index_name!r
-00029370: 7d27 0a20 2020 2020 2020 2061 7373 6572  }'.        asser
-00029380: 7420 5f69 7369 6e64 6578 286c 656e 6774  t _isindex(lengt
-00029390: 6829 2c20 6627 6c65 6e67 7468 3d7b 6c65  h), f'length={le
-000293a0: 6e67 7468 2172 7d27 0a20 2020 2020 2020  ngth!r}'.       
-000293b0: 2073 656c 662e 6675 6e63 6461 7461 203d   self.funcdata =
-000293c0: 2066 756e 6364 6174 610a 2020 2020 2020   funcdata.      
-000293d0: 2020 7365 6c66 2e66 756e 632c 2073 656c    self.func, sel
-000293e0: 662e 7374 6172 742c 2073 746f 702c 202a  f.start, stop, *
-000293f0: 7368 6170 6520 3d20 6675 6e63 6461 7461  shape = funcdata
-00029400: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
-00029410: 6465 7820 3d20 6c6f 6f70 5f69 6e64 6578  dex = loop_index
-00029420: 2869 6e64 6578 5f6e 616d 652c 206c 656e  (index_name, len
-00029430: 6774 6829 0a20 2020 2020 2020 2069 6620  gth).        if 
-00029440: 6e6f 7420 7365 6c66 2e66 756e 632e 6e64  not self.func.nd
-00029450: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
-00029460: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00029470: 2827 6578 7065 6374 6564 2061 6e20 6172  ('expected an ar
-00029480: 7261 7920 7769 7468 2061 7420 6c65 6173  ray with at leas
-00029490: 7420 6f6e 6520 6178 6973 2729 0a20 2020  t one axis').   
-000294a0: 2020 2020 2069 6620 616e 7928 7365 6c66       if any(self
-000294b0: 2e69 6e64 6578 2069 6e20 6e2e 6172 6775  .index in n.argu
-000294c0: 6d65 6e74 7320 666f 7220 6e20 696e 2073  ments for n in s
-000294d0: 6861 7065 293a 0a20 2020 2020 2020 2020  hape):.         
-000294e0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-000294f0: 726f 7228 2774 6865 2073 6861 7065 206f  ror('the shape o
-00029500: 6620 7468 6520 6675 6e63 7469 6f6e 206d  f the function m
-00029510: 7573 7420 6e6f 7420 6465 7065 6e64 206f  ust not depend o
-00029520: 6e20 7468 6520 696e 6465 7827 290a 2020  n the index').  
-00029530: 2020 2020 2020 7365 6c66 2e5f 6c63 6320        self._lcc 
-00029540: 3d20 4c6f 6f70 436f 6e63 6174 656e 6174  = LoopConcatenat
-00029550: 6543 6f6d 6269 6e65 6428 2873 656c 662e  eCombined((self.
-00029560: 6675 6e63 6461 7461 2c29 2c20 696e 6465  funcdata,), inde
-00029570: 785f 6e61 6d65 2c20 6c65 6e67 7468 290a  x_name, length).
-00029580: 2020 2020 2020 2020 7375 7065 7228 292e          super().
-00029590: 5f5f 696e 6974 5f5f 2861 7267 733d 2873  __init__(args=(s
-000295a0: 656c 662e 5f6c 6363 2c29 2c20 7368 6170  elf._lcc,), shap
-000295b0: 653d 7475 706c 6528 7368 6170 6529 2c20  e=tuple(shape), 
-000295c0: 6474 7970 653d 7365 6c66 2e66 756e 632e  dtype=self.func.
-000295d0: 6474 7970 6529 0a0a 2020 2020 4073 7461  dtype)..    @sta
-000295e0: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
-000295f0: 6620 6576 616c 6628 6172 6729 3a0a 2020  f evalf(arg):.  
-00029600: 2020 2020 2020 7265 7475 726e 2061 7267        return arg
-00029610: 5b30 5d0a 0a20 2020 2064 6566 2065 7661  [0]..    def eva
-00029620: 6c66 5f77 6974 6874 696d 6573 2873 656c  lf_withtimes(sel
-00029630: 662c 2074 696d 6573 2c20 6172 6729 3a0a  f, times, arg):.
-00029640: 2020 2020 2020 2020 7769 7468 2074 696d          with tim
-00029650: 6573 5b73 656c 665d 3a0a 2020 2020 2020  es[self]:.      
-00029660: 2020 2020 2020 7265 7475 726e 2061 7267        return arg
-00029670: 5b30 5d0a 0a20 2020 2064 6566 205f 6465  [0]..    def _de
-00029680: 7269 7661 7469 7665 2873 656c 662c 2076  rivative(self, v
-00029690: 6172 2c20 7365 656e 293a 0a20 2020 2020  ar, seen):.     
-000296a0: 2020 2072 6574 7572 6e20 5472 616e 7370     return Transp
-000296b0: 6f73 652e 6672 6f6d 5f65 6e64 286c 6f6f  ose.from_end(loo
-000296c0: 705f 636f 6e63 6174 656e 6174 6528 5472  p_concatenate(Tr
-000296d0: 616e 7370 6f73 652e 746f 5f65 6e64 2864  anspose.to_end(d
-000296e0: 6572 6976 6174 6976 6528 7365 6c66 2e66  erivative(self.f
-000296f0: 756e 632c 2076 6172 2c20 7365 656e 292c  unc, var, seen),
-00029700: 2073 656c 662e 6e64 696d 2d31 292c 2073   self.ndim-1), s
-00029710: 656c 662e 696e 6465 7829 2c20 7365 6c66  elf.index), self
-00029720: 2e6e 6469 6d2d 3129 0a0a 2020 2020 6465  .ndim-1)..    de
-00029730: 6620 5f6e 6f64 6528 7365 6c66 2c20 6361  f _node(self, ca
-00029740: 6368 652c 2073 7562 6772 6170 682c 2074  che, subgraph, t
-00029750: 696d 6573 293a 0a20 2020 2020 2020 2069  imes):.        i
-00029760: 6620 7365 6c66 2069 6e20 6361 6368 653a  f self in cache:
-00029770: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00029780: 7572 6e20 6361 6368 655b 7365 6c66 5d0a  urn cache[self].
-00029790: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000297a0: 2020 2020 2020 2020 2020 6361 6368 655b            cache[
-000297b0: 7365 6c66 5d20 3d20 6e6f 6465 203d 2073  self] = node = s
-000297c0: 656c 662e 5f6c 6363 2e5f 6e6f 6465 5f74  elf._lcc._node_t
-000297d0: 7570 6c65 2863 6163 6865 2c20 7375 6267  uple(cache, subg
-000297e0: 7261 7068 2c20 7469 6d65 7329 5b30 5d0a  raph, times)[0].
-000297f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00029800: 726e 206e 6f64 650a 0a20 2020 2064 6566  rn node..    def
-00029810: 205f 7369 6d70 6c69 6669 6564 2873 656c   _simplified(sel
-00029820: 6629 3a0a 2020 2020 2020 2020 6966 2069  f):.        if i
-00029830: 737a 6572 6f28 7365 6c66 2e66 756e 6329  szero(self.func)
-00029840: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00029850: 7475 726e 207a 6572 6f73 5f6c 696b 6528  turn zeros_like(
-00029860: 7365 6c66 290a 2020 2020 2020 2020 656c  self).        el
-00029870: 6966 2073 656c 662e 696e 6465 7820 6e6f  if self.index no
-00029880: 7420 696e 2073 656c 662e 6675 6e63 2e61  t in self.func.a
-00029890: 7267 756d 656e 7473 3a0a 2020 2020 2020  rguments:.      
-000298a0: 2020 2020 2020 7265 7475 726e 2052 6176        return Rav
-000298b0: 656c 2854 7261 6e73 706f 7365 2e66 726f  el(Transpose.fro
-000298c0: 6d5f 656e 6428 496e 7365 7274 4178 6973  m_end(InsertAxis
-000298d0: 2873 656c 662e 6675 6e63 2c20 7365 6c66  (self.func, self
-000298e0: 2e69 6e64 6578 2e6c 656e 6774 6829 2c20  .index.length), 
-000298f0: 2d32 2929 0a20 2020 2020 2020 2075 6e61  -2)).        una
-00029900: 6c69 676e 6564 2c20 7768 6572 6520 3d20  ligned, where = 
-00029910: 756e 616c 6967 6e28 7365 6c66 2e66 756e  unalign(self.fun
-00029920: 6329 0a20 2020 2020 2020 2069 6620 7365  c).        if se
-00029930: 6c66 2e6e 6469 6d2d 3120 6e6f 7420 696e  lf.ndim-1 not in
-00029940: 2077 6865 7265 3a0a 2020 2020 2020 2020   where:.        
-00029950: 2020 2020 2320 7265 696e 7365 7274 2063      # reinsert c
-00029960: 6f6e 6361 7465 6e61 7469 6f6e 2061 7869  oncatenation axi
-00029970: 732c 2061 7420 756e 6974 206c 656e 6774  s, at unit lengt
-00029980: 6820 6966 2070 6f73 7369 626c 6520 736f  h if possible so
-00029990: 2077 6520 6361 6e0a 2020 2020 2020 2020   we can.        
-000299a0: 2020 2020 2320 696e 7365 7274 2074 6865      # insert the
-000299b0: 2072 656d 6169 6e64 6572 206f 7574 7369   remainder outsi
-000299c0: 6465 206f 6620 7468 6520 6c6f 6f70 0a20  de of the loop. 
-000299d0: 2020 2020 2020 2020 2020 2075 6e61 6c69             unali
-000299e0: 676e 6564 203d 2049 6e73 6572 7441 7869  gned = InsertAxi
-000299f0: 7328 756e 616c 6967 6e65 642c 2073 656c  s(unaligned, sel
-00029a00: 662e 6675 6e63 2e73 6861 7065 5b2d 315d  f.func.shape[-1]
-00029a10: 2069 6620 7365 6c66 2e69 6e64 6578 2069   if self.index i
-00029a20: 6e20 7365 6c66 2e66 756e 632e 7368 6170  n self.func.shap
-00029a30: 655b 2d31 5d2e 6172 6775 6d65 6e74 7320  e[-1].arguments 
-00029a40: 656c 7365 2063 6f6e 7374 616e 7428 3129  else constant(1)
-00029a50: 290a 2020 2020 2020 2020 2020 2020 7768  ).            wh
-00029a60: 6572 6520 2b3d 2073 656c 662e 6e64 696d  ere += self.ndim
-00029a70: 2d31 2c0a 2020 2020 2020 2020 656c 6966  -1,.        elif
-00029a80: 2077 6865 7265 5b2d 315d 2021 3d20 7365   where[-1] != se
-00029a90: 6c66 2e6e 6469 6d2d 313a 0a20 2020 2020  lf.ndim-1:.     
-00029aa0: 2020 2020 2020 2023 2062 7269 6e67 2063         # bring c
-00029ab0: 6f6e 6361 7465 6e61 7469 6f6e 2061 7869  oncatenation axi
-00029ac0: 7320 746f 2074 6865 2065 6e64 0a20 2020  s to the end.   
-00029ad0: 2020 2020 2020 2020 2075 6e61 6c69 676e           unalign
-00029ae0: 6564 203d 2054 7261 6e73 706f 7365 2e69  ed = Transpose.i
-00029af0: 6e76 2875 6e61 6c69 676e 6564 2c20 7768  nv(unaligned, wh
-00029b00: 6572 6529 0a20 2020 2020 2020 2020 2020  ere).           
-00029b10: 2077 6865 7265 203d 2074 7570 6c65 2873   where = tuple(s
-00029b20: 6f72 7465 6428 7768 6572 6529 290a 2020  orted(where)).  
-00029b30: 2020 2020 2020 6620 3d20 6c6f 6f70 5f63        f = loop_c
-00029b40: 6f6e 6361 7465 6e61 7465 2875 6e61 6c69  oncatenate(unali
-00029b50: 676e 6564 2c20 7365 6c66 2e69 6e64 6578  gned, self.index
-00029b60: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-00029b70: 205f 6571 7561 6c73 5f73 696d 706c 6966   _equals_simplif
-00029b80: 6965 6428 7365 6c66 2e73 6861 7065 5b2d  ied(self.shape[-
-00029b90: 315d 2c20 662e 7368 6170 655b 2d31 5d29  1], f.shape[-1])
+00028ea0: 202a 656c 656d 5f69 6e64 6963 6573 2c20   *elem_indices, 
+00028eb0: 656c 656d 5f76 616c 7565 7320 3d20 2854  elem_values = (T
+00028ec0: 7261 6e73 706f 7365 2e74 6f5f 656e 6428  ranspose.to_end(
+00028ed0: 6172 722c 202a 7661 7269 6162 6c65 2920  arr, *variable) 
+00028ee0: 666f 7220 6172 7220 696e 2028 2a65 6c65  for arr in (*ele
+00028ef0: 6d5f 696e 6469 6365 732c 2065 6c65 6d5f  m_indices, elem_
+00028f00: 7661 6c75 6573 2929 0a20 2020 2020 2020  values)).       
+00028f10: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00028f20: 2069 2069 6e20 7661 7269 6162 6c65 5b3a   i in variable[:
+00028f30: 2d31 5d3a 0a20 2020 2020 2020 2020 2020  -1]:.           
+00028f40: 2020 2020 2020 2020 2020 2020 202a 656c               *el
+00028f50: 656d 5f69 6e64 6963 6573 2c20 656c 656d  em_indices, elem
+00028f60: 5f76 616c 7565 7320 3d20 6d61 7028 5261  _values = map(Ra
+00028f70: 7665 6c2c 2028 2a65 6c65 6d5f 696e 6469  vel, (*elem_indi
+00028f80: 6365 732c 2065 6c65 6d5f 7661 6c75 6573  ces, elem_values
+00028f90: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00028fa0: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
+00028fb0: 6c28 7365 6c66 2e69 6e64 6578 206e 6f74  l(self.index not
+00028fc0: 2069 6e20 6e2e 6172 6775 6d65 6e74 7320   in n.arguments 
+00028fd0: 666f 7220 6e20 696e 2065 6c65 6d5f 7661  for n in elem_va
+00028fe0: 6c75 6573 2e73 6861 7065 5b3a 2d31 5d29  lues.shape[:-1])
+00028ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029000: 2063 6875 6e6b 732e 6170 7065 6e64 2874   chunks.append(t
+00029010: 7570 6c65 286c 6f6f 705f 636f 6e63 6174  uple(loop_concat
+00029020: 656e 6174 6528 6172 722c 2073 656c 662e  enate(arr, self.
+00029030: 696e 6465 7829 2066 6f72 2061 7272 2069  index) for arr i
+00029040: 6e20 282a 656c 656d 5f69 6e64 6963 6573  n (*elem_indices
+00029050: 2c20 656c 656d 5f76 616c 7565 7329 2929  , elem_values)))
+00029060: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00029070: 7475 706c 6528 6368 756e 6b73 290a 0a0a  tuple(chunks)...
+00029080: 636c 6173 7320 5f53 697a 6573 546f 4f66  class _SizesToOf
+00029090: 6673 6574 7328 4172 7261 7929 3a0a 0a20  fsets(Array):.. 
+000290a0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+000290b0: 7365 6c66 2c20 7369 7a65 7329 3a0a 2020  self, sizes):.  
+000290c0: 2020 2020 2020 6173 7365 7274 2073 697a        assert siz
+000290d0: 6573 2e6e 6469 6d20 3d3d 2031 0a20 2020  es.ndim == 1.   
+000290e0: 2020 2020 2061 7373 6572 7420 7369 7a65       assert size
+000290f0: 732e 6474 7970 6520 3d3d 2069 6e74 0a20  s.dtype == int. 
+00029100: 2020 2020 2020 2061 7373 6572 7420 7369         assert si
+00029110: 7a65 732e 5f69 6e74 626f 756e 6473 5b30  zes._intbounds[0
+00029120: 5d20 3e3d 2030 0a20 2020 2020 2020 2073  ] >= 0.        s
+00029130: 656c 662e 5f73 697a 6573 203d 2073 697a  elf._sizes = siz
+00029140: 6573 0a20 2020 2020 2020 2073 7570 6572  es.        super
+00029150: 2829 2e5f 5f69 6e69 745f 5f28 6172 6773  ().__init__(args
+00029160: 3d28 7369 7a65 732c 292c 2073 6861 7065  =(sizes,), shape
+00029170: 3d28 7369 7a65 732e 7368 6170 655b 305d  =(sizes.shape[0]
+00029180: 2b31 2c29 2c20 6474 7970 653d 696e 7429  +1,), dtype=int)
+00029190: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
+000291a0: 686f 640a 2020 2020 6465 6620 6576 616c  hod.    def eval
+000291b0: 6628 7369 7a65 7329 3a0a 2020 2020 2020  f(sizes):.      
+000291c0: 2020 7265 7475 726e 206e 756d 7079 2e63    return numpy.c
+000291d0: 756d 7375 6d28 5b30 2c20 2a73 697a 6573  umsum([0, *sizes
+000291e0: 5d29 0a0a 2020 2020 6465 6620 5f73 696d  ])..    def _sim
+000291f0: 706c 6966 6965 6428 7365 6c66 293a 0a20  plified(self):. 
+00029200: 2020 2020 2020 2075 6e61 6c69 676e 6564         unaligned
+00029210: 2c20 7768 6572 6520 3d20 756e 616c 6967  , where = unalig
+00029220: 6e28 7365 6c66 2e5f 7369 7a65 7329 0a20  n(self._sizes). 
+00029230: 2020 2020 2020 2069 6620 6e6f 7420 7768         if not wh
+00029240: 6572 653a 0a20 2020 2020 2020 2020 2020  ere:.           
+00029250: 2072 6574 7572 6e20 5261 6e67 6528 7365   return Range(se
+00029260: 6c66 2e73 6861 7065 5b30 5d29 202a 2061  lf.shape[0]) * a
+00029270: 7070 656e 6461 7865 7328 756e 616c 6967  ppendaxes(unalig
+00029280: 6e65 642c 2073 656c 662e 7368 6170 655b  ned, self.shape[
+00029290: 3a31 5d29 0a0a 2020 2020 6465 6620 5f69  :1])..    def _i
+000292a0: 6e74 626f 756e 6473 5f69 6d70 6c28 7365  ntbounds_impl(se
+000292b0: 6c66 293a 0a20 2020 2020 2020 206e 203d  lf):.        n =
+000292c0: 2073 656c 662e 5f73 697a 6573 2e73 6861   self._sizes.sha
+000292d0: 7065 5b30 5d2e 5f69 6e74 626f 756e 6473  pe[0]._intbounds
+000292e0: 5b31 5d0a 2020 2020 2020 2020 6d20 3d20  [1].        m = 
+000292f0: 7365 6c66 2e5f 7369 7a65 732e 5f69 6e74  self._sizes._int
+00029300: 626f 756e 6473 5b31 5d0a 2020 2020 2020  bounds[1].      
+00029310: 2020 7265 7475 726e 2030 2c20 2830 2069    return 0, (0 i
+00029320: 6620 6e20 3d3d 2030 206f 7220 6d20 3d3d  f n == 0 or m ==
+00029330: 2030 2065 6c73 6520 6e20 2a20 6d29 0a0a   0 else n * m)..
+00029340: 0a63 6c61 7373 204c 6f6f 7043 6f6e 6361  .class LoopConca
+00029350: 7465 6e61 7465 2841 7272 6179 293a 0a0a  tenate(Array):..
+00029360: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00029370: 2873 656c 662c 2066 756e 6364 6174 613a  (self, funcdata:
+00029380: 2074 7970 696e 672e 5475 706c 655b 4172   typing.Tuple[Ar
+00029390: 7261 792c 202e 2e2e 5d2c 2069 6e64 6578  ray, ...], index
+000293a0: 5f6e 616d 653a 2073 7472 2c20 6c65 6e67  _name: str, leng
+000293b0: 7468 3a20 4172 7261 7929 3a0a 2020 2020  th: Array):.    
+000293c0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+000293d0: 7461 6e63 6528 6675 6e63 6461 7461 2c20  tance(funcdata, 
+000293e0: 7475 706c 6529 2061 6e64 2061 6c6c 2869  tuple) and all(i
+000293f0: 7369 6e73 7461 6e63 6528 642c 2041 7272  sinstance(d, Arr
+00029400: 6179 2920 666f 7220 6420 696e 2066 756e  ay) for d in fun
+00029410: 6364 6174 6129 2c20 6627 6675 6e63 6461  cdata), f'funcda
+00029420: 7461 3d7b 6675 6e63 6461 7461 2172 7d27  ta={funcdata!r}'
+00029430: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00029440: 6973 696e 7374 616e 6365 2869 6e64 6578  isinstance(index
+00029450: 5f6e 616d 652c 2073 7472 292c 2066 2769  _name, str), f'i
+00029460: 6e64 6578 5f6e 616d 653d 7b69 6e64 6578  ndex_name={index
+00029470: 5f6e 616d 6521 727d 270a 2020 2020 2020  _name!r}'.      
+00029480: 2020 6173 7365 7274 205f 6973 696e 6465    assert _isinde
+00029490: 7828 6c65 6e67 7468 292c 2066 276c 656e  x(length), f'len
+000294a0: 6774 683d 7b6c 656e 6774 6821 727d 270a  gth={length!r}'.
+000294b0: 2020 2020 2020 2020 7365 6c66 2e66 756e          self.fun
+000294c0: 6364 6174 6120 3d20 6675 6e63 6461 7461  cdata = funcdata
+000294d0: 0a20 2020 2020 2020 2073 656c 662e 6675  .        self.fu
+000294e0: 6e63 2c20 7365 6c66 2e73 7461 7274 2c20  nc, self.start, 
+000294f0: 7374 6f70 2c20 2a73 6861 7065 203d 2066  stop, *shape = f
+00029500: 756e 6364 6174 610a 2020 2020 2020 2020  uncdata.        
+00029510: 7365 6c66 2e69 6e64 6578 203d 206c 6f6f  self.index = loo
+00029520: 705f 696e 6465 7828 696e 6465 785f 6e61  p_index(index_na
+00029530: 6d65 2c20 6c65 6e67 7468 290a 2020 2020  me, length).    
+00029540: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00029550: 6675 6e63 2e6e 6469 6d3a 0a20 2020 2020  func.ndim:.     
+00029560: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00029570: 7565 4572 726f 7228 2765 7870 6563 7465  ueError('expecte
+00029580: 6420 616e 2061 7272 6179 2077 6974 6820  d an array with 
+00029590: 6174 206c 6561 7374 206f 6e65 2061 7869  at least one axi
+000295a0: 7327 290a 2020 2020 2020 2020 6966 2061  s').        if a
+000295b0: 6e79 2873 656c 662e 696e 6465 7820 696e  ny(self.index in
+000295c0: 206e 2e61 7267 756d 656e 7473 2066 6f72   n.arguments for
+000295d0: 206e 2069 6e20 7368 6170 6529 3a0a 2020   n in shape):.  
+000295e0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000295f0: 5661 6c75 6545 7272 6f72 2827 7468 6520  ValueError('the 
+00029600: 7368 6170 6520 6f66 2074 6865 2066 756e  shape of the fun
+00029610: 6374 696f 6e20 6d75 7374 206e 6f74 2064  ction must not d
+00029620: 6570 656e 6420 6f6e 2074 6865 2069 6e64  epend on the ind
+00029630: 6578 2729 0a20 2020 2020 2020 2073 656c  ex').        sel
+00029640: 662e 5f6c 6363 203d 204c 6f6f 7043 6f6e  f._lcc = LoopCon
+00029650: 6361 7465 6e61 7465 436f 6d62 696e 6564  catenateCombined
+00029660: 2828 7365 6c66 2e66 756e 6364 6174 612c  ((self.funcdata,
+00029670: 292c 2069 6e64 6578 5f6e 616d 652c 206c  ), index_name, l
+00029680: 656e 6774 6829 0a20 2020 2020 2020 2073  ength).        s
+00029690: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
+000296a0: 6172 6773 3d28 7365 6c66 2e5f 6c63 632c  args=(self._lcc,
+000296b0: 292c 2073 6861 7065 3d74 7570 6c65 2873  ), shape=tuple(s
+000296c0: 6861 7065 292c 2064 7479 7065 3d73 656c  hape), dtype=sel
+000296d0: 662e 6675 6e63 2e64 7479 7065 290a 0a20  f.func.dtype).. 
+000296e0: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
+000296f0: 0a20 2020 2064 6566 2065 7661 6c66 2861  .    def evalf(a
+00029700: 7267 293a 0a20 2020 2020 2020 2072 6574  rg):.        ret
+00029710: 7572 6e20 6172 675b 305d 0a0a 2020 2020  urn arg[0]..    
+00029720: 6465 6620 6576 616c 665f 7769 7468 7469  def evalf_withti
+00029730: 6d65 7328 7365 6c66 2c20 7469 6d65 732c  mes(self, times,
+00029740: 2061 7267 293a 0a20 2020 2020 2020 2077   arg):.        w
+00029750: 6974 6820 7469 6d65 735b 7365 6c66 5d3a  ith times[self]:
+00029760: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00029770: 7572 6e20 6172 675b 305d 0a0a 2020 2020  urn arg[0]..    
+00029780: 6465 6620 5f64 6572 6976 6174 6976 6528  def _derivative(
+00029790: 7365 6c66 2c20 7661 722c 2073 6565 6e29  self, var, seen)
+000297a0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000297b0: 2054 7261 6e73 706f 7365 2e66 726f 6d5f   Transpose.from_
+000297c0: 656e 6428 6c6f 6f70 5f63 6f6e 6361 7465  end(loop_concate
+000297d0: 6e61 7465 2854 7261 6e73 706f 7365 2e74  nate(Transpose.t
+000297e0: 6f5f 656e 6428 6465 7269 7661 7469 7665  o_end(derivative
+000297f0: 2873 656c 662e 6675 6e63 2c20 7661 722c  (self.func, var,
+00029800: 2073 6565 6e29 2c20 7365 6c66 2e6e 6469   seen), self.ndi
+00029810: 6d2d 3129 2c20 7365 6c66 2e69 6e64 6578  m-1), self.index
+00029820: 292c 2073 656c 662e 6e64 696d 2d31 290a  ), self.ndim-1).
+00029830: 0a20 2020 2064 6566 205f 6e6f 6465 2873  .    def _node(s
+00029840: 656c 662c 2063 6163 6865 2c20 7375 6267  elf, cache, subg
+00029850: 7261 7068 2c20 7469 6d65 7329 3a0a 2020  raph, times):.  
+00029860: 2020 2020 2020 6966 2073 656c 6620 696e        if self in
+00029870: 2063 6163 6865 3a0a 2020 2020 2020 2020   cache:.        
+00029880: 2020 2020 7265 7475 726e 2063 6163 6865      return cache
+00029890: 5b73 656c 665d 0a20 2020 2020 2020 2065  [self].        e
+000298a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000298b0: 2063 6163 6865 5b73 656c 665d 203d 206e   cache[self] = n
+000298c0: 6f64 6520 3d20 7365 6c66 2e5f 6c63 632e  ode = self._lcc.
+000298d0: 5f6e 6f64 655f 7475 706c 6528 6361 6368  _node_tuple(cach
+000298e0: 652c 2073 7562 6772 6170 682c 2074 696d  e, subgraph, tim
+000298f0: 6573 295b 305d 0a20 2020 2020 2020 2020  es)[0].         
+00029900: 2020 2072 6574 7572 6e20 6e6f 6465 0a0a     return node..
+00029910: 2020 2020 6465 6620 5f73 696d 706c 6966      def _simplif
+00029920: 6965 6428 7365 6c66 293a 0a20 2020 2020  ied(self):.     
+00029930: 2020 2069 6620 6973 7a65 726f 2873 656c     if iszero(sel
+00029940: 662e 6675 6e63 293a 0a20 2020 2020 2020  f.func):.       
+00029950: 2020 2020 2072 6574 7572 6e20 7a65 726f       return zero
+00029960: 735f 6c69 6b65 2873 656c 6629 0a20 2020  s_like(self).   
+00029970: 2020 2020 2065 6c69 6620 7365 6c66 2e69       elif self.i
+00029980: 6e64 6578 206e 6f74 2069 6e20 7365 6c66  ndex not in self
+00029990: 2e66 756e 632e 6172 6775 6d65 6e74 733a  .func.arguments:
+000299a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000299b0: 7572 6e20 5261 7665 6c28 5472 616e 7370  urn Ravel(Transp
+000299c0: 6f73 652e 6672 6f6d 5f65 6e64 2849 6e73  ose.from_end(Ins
+000299d0: 6572 7441 7869 7328 7365 6c66 2e66 756e  ertAxis(self.fun
+000299e0: 632c 2073 656c 662e 696e 6465 782e 6c65  c, self.index.le
+000299f0: 6e67 7468 292c 202d 3229 290a 2020 2020  ngth), -2)).    
+00029a00: 2020 2020 756e 616c 6967 6e65 642c 2077      unaligned, w
+00029a10: 6865 7265 203d 2075 6e61 6c69 676e 2873  here = unalign(s
+00029a20: 656c 662e 6675 6e63 290a 2020 2020 2020  elf.func).      
+00029a30: 2020 6966 2073 656c 662e 6e64 696d 2d31    if self.ndim-1
+00029a40: 206e 6f74 2069 6e20 7768 6572 653a 0a20   not in where:. 
+00029a50: 2020 2020 2020 2020 2020 2023 2072 6569             # rei
+00029a60: 6e73 6572 7420 636f 6e63 6174 656e 6174  nsert concatenat
+00029a70: 696f 6e20 6178 6973 2c20 6174 2075 6e69  ion axis, at uni
+00029a80: 7420 6c65 6e67 7468 2069 6620 706f 7373  t length if poss
+00029a90: 6962 6c65 2073 6f20 7765 2063 616e 0a20  ible so we can. 
+00029aa0: 2020 2020 2020 2020 2020 2023 2069 6e73             # ins
+00029ab0: 6572 7420 7468 6520 7265 6d61 696e 6465  ert the remainde
+00029ac0: 7220 6f75 7473 6964 6520 6f66 2074 6865  r outside of the
+00029ad0: 206c 6f6f 700a 2020 2020 2020 2020 2020   loop.          
+00029ae0: 2020 756e 616c 6967 6e65 6420 3d20 496e    unaligned = In
+00029af0: 7365 7274 4178 6973 2875 6e61 6c69 676e  sertAxis(unalign
+00029b00: 6564 2c20 7365 6c66 2e66 756e 632e 7368  ed, self.func.sh
+00029b10: 6170 655b 2d31 5d20 6966 2073 656c 662e  ape[-1] if self.
+00029b20: 696e 6465 7820 696e 2073 656c 662e 6675  index in self.fu
+00029b30: 6e63 2e73 6861 7065 5b2d 315d 2e61 7267  nc.shape[-1].arg
+00029b40: 756d 656e 7473 2065 6c73 6520 636f 6e73  uments else cons
+00029b50: 7461 6e74 2831 2929 0a20 2020 2020 2020  tant(1)).       
+00029b60: 2020 2020 2077 6865 7265 202b 3d20 7365       where += se
+00029b70: 6c66 2e6e 6469 6d2d 312c 0a20 2020 2020  lf.ndim-1,.     
+00029b80: 2020 2065 6c69 6620 7768 6572 655b 2d31     elif where[-1
+00029b90: 5d20 213d 2073 656c 662e 6e64 696d 2d31  ] != self.ndim-1
 00029ba0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00029bb0: 6c61 7374 2061 7869 7320 7761 7320 7265  last axis was re
-00029bc0: 696e 7365 7274 6564 2061 7420 756e 6974  inserted at unit
-00029bd0: 206c 656e 6774 6820 414e 4420 6974 2077   length AND it w
-00029be0: 6173 206e 6f74 2075 6e69 7420 6c65 6e67  as not unit leng
-00029bf0: 7468 0a20 2020 2020 2020 2020 2020 2023  th.            #
-00029c00: 206f 7269 6769 6e61 6c6c 7920 2d20 6966   originally - if
-00029c10: 2069 7420 7761 7320 756e 6974 206c 656e   it was unit len
-00029c20: 6774 6820 6f72 6967 696e 616c 6c79 2074  gth originally t
-00029c30: 6865 6e20 7765 2070 726f 6365 6564 206f  hen we proceed o
-00029c40: 6e6c 7920 6966 0a20 2020 2020 2020 2020  nly if.         
-00029c50: 2020 2023 2074 6865 7265 2061 7265 206f     # there are o
-00029c60: 7468 6572 2069 6e73 6572 7469 6f6e 7320  ther insertions 
-00029c70: 746f 2070 726f 6d6f 7465 2c20 6f74 6865  to promote, othe
-00029c80: 7277 6973 6520 7765 2764 2067 6574 2061  rwise we'd get a
-00029c90: 2072 6563 7572 7369 6f6e 2e0a 2020 2020   recursion..    
-00029ca0: 2020 2020 2020 2020 6620 3d20 5261 7665          f = Rave
-00029cb0: 6c28 496e 7365 7274 4178 6973 2866 2c20  l(InsertAxis(f, 
-00029cc0: 7365 6c66 2e66 756e 632e 7368 6170 655b  self.func.shape[
-00029cd0: 2d31 5d29 290a 2020 2020 2020 2020 656c  -1])).        el
-00029ce0: 6966 206c 656e 2877 6865 7265 2920 3d3d  if len(where) ==
-00029cf0: 2073 656c 662e 6e64 696d 3a0a 2020 2020   self.ndim:.    
-00029d00: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-00029d10: 2020 2020 2020 2072 6574 7572 6e20 616c         return al
-00029d20: 6967 6e28 662c 2077 6865 7265 2c20 7365  ign(f, where, se
-00029d30: 6c66 2e73 6861 7065 290a 0a20 2020 2064  lf.shape)..    d
-00029d40: 6566 205f 7461 6b65 6469 6167 2873 656c  ef _takediag(sel
-00029d50: 662c 2061 7869 7331 2c20 6178 6973 3229  f, axis1, axis2)
-00029d60: 3a0a 2020 2020 2020 2020 6966 2061 7869  :.        if axi
-00029d70: 7331 203c 2073 656c 662e 6e64 696d 2d31  s1 < self.ndim-1
-00029d80: 2061 6e64 2061 7869 7332 203c 2073 656c   and axis2 < sel
-00029d90: 662e 6e64 696d 2d31 3a0a 2020 2020 2020  f.ndim-1:.      
-00029da0: 2020 2020 2020 7265 7475 726e 2054 7261        return Tra
-00029db0: 6e73 706f 7365 2e66 726f 6d5f 656e 6428  nspose.from_end(
-00029dc0: 6c6f 6f70 5f63 6f6e 6361 7465 6e61 7465  loop_concatenate
-00029dd0: 2854 7261 6e73 706f 7365 2e74 6f5f 656e  (Transpose.to_en
-00029de0: 6428 5f74 616b 6564 6961 6728 7365 6c66  d(_takediag(self
-00029df0: 2e66 756e 632c 2061 7869 7331 2c20 6178  .func, axis1, ax
-00029e00: 6973 3229 2c20 2d32 292c 2073 656c 662e  is2), -2), self.
-00029e10: 696e 6465 7829 2c20 2d32 290a 0a20 2020  index), -2)..   
-00029e20: 2064 6566 205f 7461 6b65 2873 656c 662c   def _take(self,
-00029e30: 2069 6e64 6578 2c20 6178 6973 293a 0a20   index, axis):. 
-00029e40: 2020 2020 2020 2069 6620 6178 6973 203c         if axis <
-00029e50: 2073 656c 662e 6e64 696d 2d31 3a0a 2020   self.ndim-1:.  
-00029e60: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00029e70: 206c 6f6f 705f 636f 6e63 6174 656e 6174   loop_concatenat
-00029e80: 6528 5f74 616b 6528 7365 6c66 2e66 756e  e(_take(self.fun
-00029e90: 632c 2069 6e64 6578 2c20 6178 6973 292c  c, index, axis),
-00029ea0: 2073 656c 662e 696e 6465 7829 0a0a 2020   self.index)..  
-00029eb0: 2020 6465 6620 5f75 6e72 6176 656c 2873    def _unravel(s
-00029ec0: 656c 662c 2061 7869 732c 2073 6861 7065  elf, axis, shape
-00029ed0: 293a 0a20 2020 2020 2020 2069 6620 6178  ):.        if ax
-00029ee0: 6973 203c 2073 656c 662e 6e64 696d 2d31  is < self.ndim-1
-00029ef0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00029f00: 7475 726e 206c 6f6f 705f 636f 6e63 6174  turn loop_concat
-00029f10: 656e 6174 6528 756e 7261 7665 6c28 7365  enate(unravel(se
-00029f20: 6c66 2e66 756e 632c 2061 7869 732c 2073  lf.func, axis, s
-00029f30: 6861 7065 292c 2073 656c 662e 696e 6465  hape), self.inde
-00029f40: 7829 0a0a 2020 2020 4063 6163 6865 645f  x)..    @cached_
-00029f50: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00029f60: 205f 6173 7370 6172 7365 2873 656c 6629   _assparse(self)
-00029f70: 3a0a 2020 2020 2020 2020 6368 756e 6b73  :.        chunks
-00029f80: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
-00029f90: 7220 2a69 6e64 6963 6573 2c20 6c61 7374  r *indices, last
-00029fa0: 5f69 6e64 6578 2c20 7661 6c75 6573 2069  _index, values i
-00029fb0: 6e20 7365 6c66 2e66 756e 632e 5f61 7373  n self.func._ass
-00029fc0: 7061 7273 653a 0a20 2020 2020 2020 2020  parse:.         
-00029fd0: 2020 206c 6173 745f 696e 6465 7820 3d20     last_index = 
-00029fe0: 6c61 7374 5f69 6e64 6578 202b 2070 7265  last_index + pre
-00029ff0: 7065 6e64 6178 6573 2873 656c 662e 7374  pendaxes(self.st
-0002a000: 6172 742c 206c 6173 745f 696e 6465 782e  art, last_index.
-0002a010: 7368 6170 6529 0a20 2020 2020 2020 2020  shape).         
-0002a020: 2020 2063 6875 6e6b 732e 6170 7065 6e64     chunks.append
-0002a030: 2874 7570 6c65 286c 6f6f 705f 636f 6e63  (tuple(loop_conc
-0002a040: 6174 656e 6174 6528 5f66 6c61 7428 6172  atenate(_flat(ar
-0002a050: 7229 2c20 7365 6c66 2e69 6e64 6578 2920  r), self.index) 
-0002a060: 666f 7220 6172 7220 696e 2028 2a69 6e64  for arr in (*ind
-0002a070: 6963 6573 2c20 6c61 7374 5f69 6e64 6578  ices, last_index
-0002a080: 2c20 7661 6c75 6573 2929 290a 2020 2020  , values))).    
-0002a090: 2020 2020 7265 7475 726e 2074 7570 6c65      return tuple
-0002a0a0: 2863 6875 6e6b 7329 0a0a 2020 2020 4070  (chunks)..    @p
-0002a0b0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0002a0c0: 5f6c 6f6f 705f 636f 6e63 6174 656e 6174  _loop_concatenat
-0002a0d0: 655f 6465 7073 2873 656c 6629 3a0a 2020  e_deps(self):.  
-0002a0e0: 2020 2020 2020 7265 7475 726e 2028 7365        return (se
-0002a0f0: 6c66 2c29 202b 2073 7570 6572 2829 2e5f  lf,) + super()._
-0002a100: 6c6f 6f70 5f63 6f6e 6361 7465 6e61 7465  loop_concatenate
-0002a110: 5f64 6570 730a 0a20 2020 2064 6566 205f  _deps..    def _
-0002a120: 696e 7462 6f75 6e64 735f 696d 706c 2873  intbounds_impl(s
-0002a130: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-0002a140: 7475 726e 2073 656c 662e 6675 6e63 2e5f  turn self.func._
-0002a150: 696e 7462 6f75 6e64 730a 0a0a 636c 6173  intbounds...clas
-0002a160: 7320 4c6f 6f70 436f 6e63 6174 656e 6174  s LoopConcatenat
-0002a170: 6543 6f6d 6269 6e65 6428 4576 616c 7561  eCombined(Evalua
-0002a180: 626c 6529 3a0a 0a20 2020 2064 6566 205f  ble):..    def _
-0002a190: 5f69 6e69 745f 5f28 7365 6c66 2c20 6675  _init__(self, fu
-0002a1a0: 6e63 6461 7461 733a 2074 7970 696e 672e  ncdatas: typing.
-0002a1b0: 5475 706c 655b 7479 7069 6e67 2e54 7570  Tuple[typing.Tup
-0002a1c0: 6c65 5b41 7272 6179 2c20 2e2e 2e5d 2c20  le[Array, ...], 
-0002a1d0: 2e2e 2e5d 2c20 696e 6465 785f 6e61 6d65  ...], index_name
-0002a1e0: 3a20 7374 722c 206c 656e 6774 683a 2041  : str, length: A
-0002a1f0: 7272 6179 293a 0a20 2020 2020 2020 2061  rray):.        a
-0002a200: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-0002a210: 2866 756e 6364 6174 6173 2c20 7475 706c  (funcdatas, tupl
-0002a220: 6529 2061 6e64 2061 6c6c 2869 7369 6e73  e) and all(isins
-0002a230: 7461 6e63 6528 6675 6e63 6461 7461 2c20  tance(funcdata, 
-0002a240: 7475 706c 6529 2061 6e64 2061 6c6c 2869  tuple) and all(i
-0002a250: 7369 6e73 7461 6e63 6528 642c 2041 7272  sinstance(d, Arr
-0002a260: 6179 2920 666f 7220 6420 696e 2066 756e  ay) for d in fun
-0002a270: 6364 6174 6129 2066 6f72 2066 756e 6364  cdata) for funcd
-0002a280: 6174 6120 696e 2066 756e 6364 6174 6173  ata in funcdatas
-0002a290: 292c 2066 2766 756e 6364 6174 6173 3d7b  ), f'funcdatas={
-0002a2a0: 6675 6e63 6461 7461 7321 727d 270a 2020  funcdatas!r}'.  
-0002a2b0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-0002a2c0: 6e73 7461 6e63 6528 696e 6465 785f 6e61  nstance(index_na
-0002a2d0: 6d65 2c20 7374 7229 2c20 6627 696e 6465  me, str), f'inde
-0002a2e0: 785f 6e61 6d65 3d7b 696e 6465 785f 6e61  x_name={index_na
-0002a2f0: 6d65 7d27 0a20 2020 2020 2020 2061 7373  me}'.        ass
-0002a300: 6572 7420 5f69 7369 6e64 6578 286c 656e  ert _isindex(len
-0002a310: 6774 6829 2c20 6627 6c65 6e67 7468 3d7b  gth), f'length={
-0002a320: 6c65 6e67 7468 2172 7d27 0a20 2020 2020  length!r}'.     
-0002a330: 2020 2073 656c 662e 5f66 756e 6364 6174     self._funcdat
-0002a340: 6173 203d 2066 756e 6364 6174 6173 0a20  as = funcdatas. 
-0002a350: 2020 2020 2020 2073 656c 662e 5f66 756e         self._fun
-0002a360: 6373 203d 2074 7570 6c65 2866 756e 6320  cs = tuple(func 
-0002a370: 666f 7220 6675 6e63 2c20 7374 6172 742c  for func, start,
-0002a380: 2073 746f 702c 202a 7368 6170 6520 696e   stop, *shape in
-0002a390: 2066 756e 6364 6174 6173 290a 2020 2020   funcdatas).    
-0002a3a0: 2020 2020 7365 6c66 2e5f 696e 6465 785f      self._index_
-0002a3b0: 6e61 6d65 203d 2069 6e64 6578 5f6e 616d  name = index_nam
-0002a3c0: 650a 2020 2020 2020 2020 7365 6c66 2e5f  e.        self._
-0002a3d0: 696e 6465 7820 3d20 6c6f 6f70 5f69 6e64  index = loop_ind
-0002a3e0: 6578 2869 6e64 6578 5f6e 616d 652c 206c  ex(index_name, l
-0002a3f0: 656e 6774 6829 0a20 2020 2020 2020 2069  ength).        i
-0002a400: 6620 616e 7928 6e6f 7420 6675 6e63 2e6e  f any(not func.n
-0002a410: 6469 6d20 666f 7220 6675 6e63 2069 6e20  dim for func in 
-0002a420: 7365 6c66 2e5f 6675 6e63 7329 3a0a 2020  self._funcs):.  
-0002a430: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0002a440: 5661 6c75 6545 7272 6f72 2827 6578 7065  ValueError('expe
-0002a450: 6374 6564 2061 6e20 6172 7261 7920 7769  cted an array wi
-0002a460: 7468 2061 7420 6c65 6173 7420 6f6e 6520  th at least one 
-0002a470: 6178 6973 2729 0a20 2020 2020 2020 2073  axis').        s
-0002a480: 6861 7065 7320 3d20 7475 706c 6528 5475  hapes = tuple(Tu
-0002a490: 706c 6528 7475 706c 6528 7368 6170 6529  ple(tuple(shape)
-0002a4a0: 2920 666f 7220 6675 6e63 2c20 7374 6172  ) for func, star
-0002a4b0: 742c 2073 746f 702c 202a 7368 6170 6520  t, stop, *shape 
-0002a4c0: 696e 2066 756e 6364 6174 6173 290a 2020  in funcdatas).  
-0002a4d0: 2020 2020 2020 6966 2061 6e79 2873 656c        if any(sel
-0002a4e0: 662e 5f69 6e64 6578 2069 6e20 7368 6170  f._index in shap
-0002a4f0: 652e 6172 6775 6d65 6e74 7320 666f 7220  e.arguments for 
-0002a500: 7368 6170 6520 696e 2073 6861 7065 7329  shape in shapes)
-0002a510: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0002a520: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
-0002a530: 7468 6520 7368 6170 6520 6f66 2074 6865  the shape of the
-0002a540: 2066 756e 6374 696f 6e20 6d75 7374 206e   function must n
-0002a550: 6f74 2064 6570 656e 6420 6f6e 2074 6865  ot depend on the
-0002a560: 2069 6e64 6578 2729 0a20 2020 2020 2020   index').       
-0002a570: 2073 656c 662e 5f69 6e76 6172 6961 6e74   self._invariant
-0002a580: 732c 2073 656c 662e 5f64 6570 656e 6465  s, self._depende
-0002a590: 6e63 6965 7320 3d20 5f64 6570 656e 6465  ncies = _depende
-0002a5a0: 6e63 6965 735f 7361 6e73 5f69 6e76 6172  ncies_sans_invar
-0002a5b0: 6961 6e74 7328 0a20 2020 2020 2020 2020  iants(.         
-0002a5c0: 2020 2054 7570 6c65 2874 7570 6c65 2854     Tuple(tuple(T
-0002a5d0: 7570 6c65 2828 7374 6172 742c 2073 746f  uple((start, sto
-0002a5e0: 702c 2066 756e 6329 2920 666f 7220 6675  p, func)) for fu
-0002a5f0: 6e63 2c20 7374 6172 742c 2073 746f 702c  nc, start, stop,
-0002a600: 202a 7368 6170 6520 696e 2066 756e 6364   *shape in funcd
-0002a610: 6174 6173 2929 2c20 7365 6c66 2e5f 696e  atas)), self._in
-0002a620: 6465 7829 0a20 2020 2020 2020 2073 7570  dex).        sup
-0002a630: 6572 2829 2e5f 5f69 6e69 745f 5f28 6172  er().__init__(ar
-0002a640: 6773 3d28 5475 706c 6528 7368 6170 6573  gs=(Tuple(shapes
-0002a650: 292c 206c 656e 6774 682c 202a 7365 6c66  ), length, *self
-0002a660: 2e5f 696e 7661 7269 616e 7473 2929 0a0a  ._invariants))..
-0002a670: 2020 2020 4063 6163 6865 645f 7072 6f70      @cached_prop
-0002a680: 6572 7479 0a20 2020 2064 6566 205f 7365  erty.    def _se
-0002a690: 7269 616c 697a 6564 5f6c 6f6f 7028 7365  rialized_loop(se
-0002a6a0: 6c66 293a 0a20 2020 2020 2020 2069 6e64  lf):.        ind
-0002a6b0: 6963 6573 203d 207b 643a 2069 2066 6f72  ices = {d: i for
-0002a6c0: 2069 2c20 6420 696e 2065 6e75 6d65 7261   i, d in enumera
-0002a6d0: 7465 2869 7465 7274 6f6f 6c73 2e63 6861  te(itertools.cha
-0002a6e0: 696e 285b 7365 6c66 2e5f 696e 6465 785d  in([self._index]
-0002a6f0: 2c20 7365 6c66 2e5f 696e 7661 7269 616e  , self._invarian
-0002a700: 7473 2c20 7365 6c66 2e5f 6465 7065 6e64  ts, self._depend
-0002a710: 656e 6369 6573 2929 7d0a 2020 2020 2020  encies))}.      
-0002a720: 2020 7265 7475 726e 2074 7570 6c65 2828    return tuple((
-0002a730: 6465 702c 2074 7570 6c65 286d 6170 2869  dep, tuple(map(i
-0002a740: 6e64 6963 6573 2e5f 5f67 6574 6974 656d  ndices.__getitem
-0002a750: 5f5f 2c20 6465 702e 5f45 7661 6c75 6162  __, dep._Evaluab
-0002a760: 6c65 5f5f 6172 6773 2929 2920 666f 7220  le__args))) for 
-0002a770: 6465 7020 696e 2073 656c 662e 5f64 6570  dep in self._dep
-0002a780: 656e 6465 6e63 6965 7329 0a0a 2020 2020  endencies)..    
-0002a790: 2320 5468 6973 2070 726f 7065 7274 7920  # This property 
-0002a7a0: 6973 2061 2064 6572 6976 6174 696f 6e20  is a derivation 
-0002a7b0: 6f66 2060 5f73 6572 6961 6c69 7a65 6460  of `_serialized`
-0002a7c0: 2077 6865 7265 2074 6865 2060 4576 616c   where the `Eval
-0002a7d0: 7561 626c 6560 0a20 2020 2023 2069 6e73  uable`.    # ins
-0002a7e0: 7461 6e63 6573 2061 7265 206d 6170 7065  tances are mappe
-0002a7f0: 6420 746f 2074 6865 2060 6576 616c 6660  d to the `evalf`
-0002a800: 206d 6574 686f 6473 206f 6620 7468 6520   methods of the 
-0002a810: 696e 7374 616e 6365 732e 2041 7373 6572  instances. Asser
-0002a820: 7469 6e67 0a20 2020 2023 2074 6861 7420  ting.    # that 
-0002a830: 6675 6e63 7469 6f6e 7320 6172 6520 696d  functions are im
-0002a840: 6d75 7461 626c 6520 6973 2064 6966 6669  mutable is diffi
-0002a850: 6375 6c74 2061 6e64 2063 7572 7265 6e74  cult and current
-0002a860: 6c79 0a20 2020 2023 2060 7479 7065 732e  ly.    # `types.
-0002a870: 5f69 7369 6d6d 7574 6162 6c65 6020 6d61  _isimmutable` ma
-0002a880: 726b 7320 616c 6c20 6675 6e63 7469 6f6e  rks all function
-0002a890: 7320 6173 206d 7574 6162 6c65 2e20 5369  s as mutable. Si
-0002a8a0: 6e63 6520 7468 650a 2020 2020 2320 6074  nce the.    # `t
-0002a8b0: 7970 6573 2e43 6163 6865 4d65 7461 6020  ypes.CacheMeta` 
-0002a8c0: 6d61 6368 696e 6572 7920 6173 7365 7274  machinery assert
-0002a8d0: 7320 696d 6d75 7461 6269 6c69 7479 206f  s immutability o
-0002a8e0: 6620 7468 6520 7072 6f70 6572 7479 2c20  f the property, 
-0002a8f0: 7765 2068 6176 650a 2020 2020 2320 746f  we have.    # to
-0002a900: 2072 6573 6f72 7420 746f 2061 2072 6567   resort to a reg
-0002a910: 756c 6172 2060 6675 6e63 746f 6f6c 732e  ular `functools.
-0002a920: 6361 6368 6564 5f70 726f 7065 7274 7960  cached_property`
-0002a930: 2e20 4e65 7665 7274 6865 6c65 7373 2c20  . Nevertheless, 
-0002a940: 7468 6973 0a20 2020 2023 2070 726f 7065  this.    # prope
-0002a950: 7274 7920 7368 6f75 6c64 2062 6520 7472  rty should be tr
-0002a960: 6561 7465 6420 6173 2069 6620 6974 2069  eated as if it i
-0002a970: 7320 696d 6d75 7461 626c 652e 0a20 2020  s immutable..   
-0002a980: 2040 6361 6368 6564 5f70 726f 7065 7274   @cached_propert
-0002a990: 790a 2020 2020 6465 6620 5f73 6572 6961  y.    def _seria
-0002a9a0: 6c69 7a65 645f 6c6f 6f70 5f65 7661 6c66  lized_loop_evalf
-0002a9b0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0002a9c0: 7265 7475 726e 2074 7570 6c65 2828 6465  return tuple((de
-0002a9d0: 702e 6576 616c 662c 2069 6e64 6963 6573  p.evalf, indices
-0002a9e0: 2920 666f 7220 6465 702c 2069 6e64 6963  ) for dep, indic
-0002a9f0: 6573 2069 6e20 7365 6c66 2e5f 7365 7269  es in self._seri
-0002aa00: 616c 697a 6564 5f6c 6f6f 7029 0a0a 2020  alized_loop)..  
-0002aa10: 2020 6465 6620 6576 616c 6628 7365 6c66    def evalf(self
-0002aa20: 2c20 7368 6170 6573 2c20 6c65 6e67 7468  , shapes, length
-0002aa30: 2c20 2a61 7267 7329 3a0a 2020 2020 2020  , *args):.      
-0002aa40: 2020 7365 7269 616c 697a 6564 5f65 7661    serialized_eva
-0002aa50: 6c66 203d 2073 656c 662e 5f73 6572 6961  lf = self._seria
-0002aa60: 6c69 7a65 645f 6c6f 6f70 5f65 7661 6c66  lized_loop_evalf
-0002aa70: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
-0002aa80: 203d 205b 7061 7261 6c6c 656c 2e73 6865   = [parallel.she
-0002aa90: 6d70 7479 2874 7570 6c65 286d 6170 2869  mpty(tuple(map(i
-0002aaa0: 6e74 2c20 7368 6170 6529 292c 2064 7479  nt, shape)), dty
-0002aab0: 7065 3d66 756e 632e 6474 7970 6529 2066  pe=func.dtype) f
-0002aac0: 6f72 2066 756e 632c 2073 6861 7065 2069  or func, shape i
-0002aad0: 6e20 7a69 7028 7365 6c66 2e5f 6675 6e63  n zip(self._func
-0002aae0: 732c 2073 6861 7065 7329 5d0a 2020 2020  s, shapes)].    
-0002aaf0: 2020 2020 7769 7468 2070 6172 616c 6c65      with paralle
-0002ab00: 6c2e 6374 7872 616e 6765 2827 6c6f 6f70  l.ctxrange('loop
-0002ab10: 207b 7d27 2e66 6f72 6d61 7428 7365 6c66   {}'.format(self
-0002ab20: 2e5f 696e 6465 785f 6e61 6d65 292c 2069  ._index_name), i
-0002ab30: 6e74 286c 656e 6774 6829 2920 6173 2069  nt(length)) as i
-0002ab40: 6e64 6963 6573 3a0a 2020 2020 2020 2020  ndices:.        
-0002ab50: 2020 2020 666f 7220 696e 6465 7820 696e      for index in
-0002ab60: 2069 6e64 6963 6573 3a0a 2020 2020 2020   indices:.      
-0002ab70: 2020 2020 2020 2020 2020 7661 6c75 6573            values
-0002ab80: 203d 205b 6e75 6d70 792e 6172 7261 7928   = [numpy.array(
-0002ab90: 696e 6465 7829 5d0a 2020 2020 2020 2020  index)].        
-0002aba0: 2020 2020 2020 2020 7661 6c75 6573 2e65          values.e
-0002abb0: 7874 656e 6428 6172 6773 290a 2020 2020  xtend(args).    
-0002abc0: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
-0002abd0: 6573 2e65 7874 656e 6428 6f70 5f65 7661  es.extend(op_eva
-0002abe0: 6c66 282a 5b76 616c 7565 735b 695d 2066  lf(*[values[i] f
-0002abf0: 6f72 2069 2069 6e20 696e 6469 6365 735d  or i in indices]
-0002ac00: 2920 666f 7220 6f70 5f65 7661 6c66 2c20  ) for op_evalf, 
-0002ac10: 696e 6469 6365 7320 696e 2073 6572 6961  indices in seria
-0002ac20: 6c69 7a65 645f 6576 616c 6629 0a20 2020  lized_evalf).   
-0002ac30: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0002ac40: 2072 6573 756c 742c 2028 7374 6172 742c   result, (start,
-0002ac50: 2073 746f 702c 2062 6c6f 636b 2920 696e   stop, block) in
-0002ac60: 207a 6970 2872 6573 756c 7473 2c20 7661   zip(results, va
-0002ac70: 6c75 6573 5b2d 315d 293a 0a20 2020 2020  lues[-1]):.     
-0002ac80: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002ac90: 6573 756c 745b 2e2e 2e2c 2073 7461 7274  esult[..., start
-0002aca0: 3a73 746f 705d 203d 2062 6c6f 636b 0a20  :stop] = block. 
-0002acb0: 2020 2020 2020 2072 6574 7572 6e20 7475         return tu
-0002acc0: 706c 6528 7265 7375 6c74 7329 0a0a 2020  ple(results)..  
-0002acd0: 2020 6465 6620 6576 616c 665f 7769 7468    def evalf_with
-0002ace0: 7469 6d65 7328 7365 6c66 2c20 7469 6d65  times(self, time
-0002acf0: 732c 2073 6861 7065 732c 206c 656e 6774  s, shapes, lengt
-0002ad00: 682c 202a 6172 6773 293a 0a20 2020 2020  h, *args):.     
-0002ad10: 2020 2073 6572 6961 6c69 7a65 6420 3d20     serialized = 
-0002ad20: 7365 6c66 2e5f 7365 7269 616c 697a 6564  self._serialized
-0002ad30: 5f6c 6f6f 700a 2020 2020 2020 2020 7375  _loop.        su
-0002ad40: 6274 696d 6573 203d 2074 696d 6573 2e73  btimes = times.s
-0002ad50: 6574 6465 6661 756c 7428 7365 6c66 2c20  etdefault(self, 
-0002ad60: 636f 6c6c 6563 7469 6f6e 732e 6465 6661  collections.defa
-0002ad70: 756c 7464 6963 7428 5f53 7461 7473 2929  ultdict(_Stats))
-0002ad80: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
-0002ad90: 203d 205b 7061 7261 6c6c 656c 2e73 6865   = [parallel.she
-0002ada0: 6d70 7479 2874 7570 6c65 286d 6170 2869  mpty(tuple(map(i
-0002adb0: 6e74 2c20 7368 6170 6529 292c 2064 7479  nt, shape)), dty
-0002adc0: 7065 3d66 756e 632e 6474 7970 6529 2066  pe=func.dtype) f
-0002add0: 6f72 2066 756e 632c 2073 6861 7065 2069  or func, shape i
-0002ade0: 6e20 7a69 7028 7365 6c66 2e5f 6675 6e63  n zip(self._func
-0002adf0: 732c 2073 6861 7065 7329 5d0a 2020 2020  s, shapes)].    
-0002ae00: 2020 2020 666f 7220 696e 6465 7820 696e      for index in
-0002ae10: 2072 616e 6765 286c 656e 6774 6829 3a0a   range(length):.
-0002ae20: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
-0002ae30: 6573 203d 205b 6e75 6d70 792e 6172 7261  es = [numpy.arra
-0002ae40: 7928 696e 6465 7829 5d0a 2020 2020 2020  y(index)].      
-0002ae50: 2020 2020 2020 7661 6c75 6573 2e65 7874        values.ext
-0002ae60: 656e 6428 6172 6773 290a 2020 2020 2020  end(args).      
-0002ae70: 2020 2020 2020 7661 6c75 6573 2e65 7874        values.ext
-0002ae80: 656e 6428 6f70 2e65 7661 6c66 5f77 6974  end(op.evalf_wit
-0002ae90: 6874 696d 6573 2873 7562 7469 6d65 732c  htimes(subtimes,
-0002aea0: 202a 5b76 616c 7565 735b 695d 2066 6f72   *[values[i] for
-0002aeb0: 2069 2069 6e20 696e 6469 6365 735d 2920   i in indices]) 
-0002aec0: 666f 7220 6f70 2c20 696e 6469 6365 7320  for op, indices 
-0002aed0: 696e 2073 6572 6961 6c69 7a65 6429 0a20  in serialized). 
-0002aee0: 2020 2020 2020 2020 2020 2066 6f72 2066             for f
-0002aef0: 756e 632c 2072 6573 756c 742c 2028 7374  unc, result, (st
-0002af00: 6172 742c 2073 746f 702c 2062 6c6f 636b  art, stop, block
-0002af10: 2920 696e 207a 6970 2873 656c 662e 5f66  ) in zip(self._f
-0002af20: 756e 6373 2c20 7265 7375 6c74 732c 2076  uncs, results, v
-0002af30: 616c 7565 735b 2d31 5d29 3a0a 2020 2020  alues[-1]):.    
-0002af40: 2020 2020 2020 2020 2020 2020 7769 7468              with
-0002af50: 2073 7562 7469 6d65 735b 2763 6f6e 6361   subtimes['conca
-0002af60: 7427 2c20 6675 6e63 5d3a 0a20 2020 2020  t', func]:.     
-0002af70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002af80: 6573 756c 745b 2e2e 2e2c 2073 7461 7274  esult[..., start
-0002af90: 3a73 746f 705d 203d 2062 6c6f 636b 0a20  :stop] = block. 
-0002afa0: 2020 2020 2020 2072 6574 7572 6e20 7475         return tu
-0002afb0: 706c 6528 7265 7375 6c74 7329 0a0a 2020  ple(results)..  
-0002afc0: 2020 6465 6620 5f6e 6f64 655f 7475 706c    def _node_tupl
-0002afd0: 6528 7365 6c66 2c20 6361 6368 652c 2073  e(self, cache, s
-0002afe0: 7562 6772 6170 682c 2074 696d 6573 293a  ubgraph, times):
-0002aff0: 0a20 2020 2020 2020 2069 6620 2873 656c  .        if (sel
-0002b000: 662c 2027 7475 706c 6527 2920 696e 2063  f, 'tuple') in c
-0002b010: 6163 6865 3a0a 2020 2020 2020 2020 2020  ache:.          
-0002b020: 2020 7265 7475 726e 2063 6163 6865 5b73    return cache[s
-0002b030: 656c 662c 2027 7475 706c 6527 5d0a 2020  elf, 'tuple'].  
-0002b040: 2020 2020 2020 7375 6263 6163 6865 203d        subcache =
-0002b050: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
-0002b060: 6172 6720 696e 2073 656c 662e 5f69 6e76  arg in self._inv
-0002b070: 6172 6961 6e74 733a 0a20 2020 2020 2020  ariants:.       
-0002b080: 2020 2020 2073 7562 6361 6368 655b 6172       subcache[ar
-0002b090: 675d 203d 2061 7267 2e5f 6e6f 6465 2863  g] = arg._node(c
-0002b0a0: 6163 6865 2c20 7375 6267 7261 7068 2c20  ache, subgraph, 
-0002b0b0: 7469 6d65 7329 0a20 2020 2020 2020 206c  times).        l
-0002b0c0: 6f6f 7067 7261 7068 203d 2053 7562 6772  oopgraph = Subgr
-0002b0d0: 6170 6828 274c 6f6f 7027 2c20 7375 6267  aph('Loop', subg
-0002b0e0: 7261 7068 290a 2020 2020 2020 2020 7375  raph).        su
-0002b0f0: 6274 696d 6573 203d 2074 696d 6573 2e67  btimes = times.g
-0002b100: 6574 2873 656c 662c 2063 6f6c 6c65 6374  et(self, collect
-0002b110: 696f 6e73 2e64 6566 6175 6c74 6469 6374  ions.defaultdict
-0002b120: 285f 5374 6174 7329 290a 2020 2020 2020  (_Stats)).      
-0002b130: 2020 636f 6e63 6174 7320 3d20 5b5d 0a20    concats = []. 
-0002b140: 2020 2020 2020 2066 6f72 2066 756e 632c         for func,
-0002b150: 2073 7461 7274 2c20 7374 6f70 2c20 2a73   start, stop, *s
-0002b160: 6861 7065 2069 6e20 7365 6c66 2e5f 6675  hape in self._fu
-0002b170: 6e63 6461 7461 733a 0a20 2020 2020 2020  ncdatas:.       
-0002b180: 2020 2020 2063 6f6e 6361 745f 6b77 6172       concat_kwar
-0002b190: 6773 203d 207b 2773 6861 7065 5b7b 7d5d  gs = {'shape[{}]
-0002b1a0: 272e 666f 726d 6174 2869 293a 206e 2e5f  '.format(i): n._
-0002b1b0: 6e6f 6465 2863 6163 6865 2c20 7375 6267  node(cache, subg
-0002b1c0: 7261 7068 2c20 7469 6d65 7329 2066 6f72  raph, times) for
-0002b1d0: 2069 2c20 6e20 696e 2065 6e75 6d65 7261   i, n in enumera
-0002b1e0: 7465 2873 6861 7065 297d 0a20 2020 2020  te(shape)}.     
-0002b1f0: 2020 2020 2020 2063 6f6e 6361 745f 6b77         concat_kw
-0002b200: 6172 6773 5b27 7374 6172 7427 5d20 3d20  args['start'] = 
-0002b210: 7374 6172 742e 5f6e 6f64 6528 7375 6263  start._node(subc
-0002b220: 6163 6865 2c20 6c6f 6f70 6772 6170 682c  ache, loopgraph,
-0002b230: 2073 7562 7469 6d65 7329 0a20 2020 2020   subtimes).     
-0002b240: 2020 2020 2020 2063 6f6e 6361 745f 6b77         concat_kw
-0002b250: 6172 6773 5b27 7374 6f70 275d 203d 2073  args['stop'] = s
-0002b260: 746f 702e 5f6e 6f64 6528 7375 6263 6163  top._node(subcac
-0002b270: 6865 2c20 6c6f 6f70 6772 6170 682c 2073  he, loopgraph, s
-0002b280: 7562 7469 6d65 7329 0a20 2020 2020 2020  ubtimes).       
-0002b290: 2020 2020 2063 6f6e 6361 745f 6b77 6172       concat_kwar
-0002b2a0: 6773 5b27 6675 6e63 275d 203d 2066 756e  gs['func'] = fun
-0002b2b0: 632e 5f6e 6f64 6528 7375 6263 6163 6865  c._node(subcache
-0002b2c0: 2c20 6c6f 6f70 6772 6170 682c 2073 7562  , loopgraph, sub
-0002b2d0: 7469 6d65 7329 0a20 2020 2020 2020 2020  times).         
-0002b2e0: 2020 2063 6f6e 6361 7473 2e61 7070 656e     concats.appen
-0002b2f0: 6428 5265 6775 6c61 724e 6f64 6528 274c  d(RegularNode('L
-0002b300: 6f6f 7043 6f6e 6361 7465 6e61 7465 272c  oopConcatenate',
-0002b310: 2028 292c 2063 6f6e 6361 745f 6b77 6172   (), concat_kwar
-0002b320: 6773 2c20 2874 7970 6528 7365 6c66 292e  gs, (type(self).
-0002b330: 5f5f 6e61 6d65 5f5f 2c20 7375 6274 696d  __name__, subtim
-0002b340: 6573 5b27 636f 6e63 6174 272c 2066 756e  es['concat', fun
-0002b350: 635d 292c 206c 6f6f 7067 7261 7068 2929  c]), loopgraph))
-0002b360: 0a20 2020 2020 2020 2063 6163 6865 5b73  .        cache[s
-0002b370: 656c 662c 2027 7475 706c 6527 5d20 3d20  elf, 'tuple'] = 
-0002b380: 636f 6e63 6174 7320 3d20 7475 706c 6528  concats = tuple(
-0002b390: 636f 6e63 6174 7329 0a20 2020 2020 2020  concats).       
-0002b3a0: 2072 6574 7572 6e20 636f 6e63 6174 730a   return concats.
-0002b3b0: 0a0a 636c 6173 7320 5365 6172 6368 536f  ..class SearchSo
-0002b3c0: 7274 6564 2841 7272 6179 293a 0a20 2020  rted(Array):.   
-0002b3d0: 2027 2727 4669 6e64 2069 6e64 6578 206f   '''Find index o
-0002b3e0: 6620 6576 616c 7561 626c 6520 6172 7261  f evaluable arra
-0002b3f0: 7920 696e 746f 2073 6f72 7465 6420 6e75  y into sorted nu
-0002b400: 6d70 7920 6172 7261 792e 2727 270a 0a20  mpy array.'''.. 
-0002b410: 2020 2023 204e 4f54 453a 2053 6561 7263     # NOTE: Searc
-0002b420: 6853 6f72 7465 6420 6973 2065 7373 656e  hSorted is essen
-0002b430: 7469 616c 6c79 2070 6f69 6e74 7769 7365  tially pointwise
-0002b440: 2069 6e20 6974 7320 6f6e 6c79 2065 7661   in its only eva
-0002b450: 6c75 6162 6c65 0a20 2020 2023 2061 7267  luable.    # arg
-0002b460: 756d 656e 742c 2062 7574 2074 6865 2050  ument, but the P
-0002b470: 6f69 6e74 7769 7365 2063 6c61 7373 2063  ointwise class c
-0002b480: 7572 7265 6e74 6c79 2064 6f65 7320 6e6f  urrently does no
-0002b490: 7420 616c 6c6f 7720 666f 720a 2020 2020  t allow for.    
-0002b4a0: 2320 6164 6469 7469 6f6e 616c 2c20 7374  # additional, st
-0002b4b0: 6174 6963 2061 7267 756d 656e 7473 2e20  atic arguments. 
-0002b4c0: 5468 6520 666f 6c6c 6f77 696e 6720 636f  The following co
-0002b4d0: 6e73 7472 7563 746f 7220 6d61 6b65 7320  nstructor makes 
-0002b4e0: 7468 6520 7374 6174 6963 0a20 2020 2023  the static.    #
-0002b4f0: 2061 7267 756d 656e 7473 206b 6579 776f   arguments keywo
-0002b500: 7264 2d6f 6e6c 7920 696e 2061 6e74 6963  rd-only in antic
-0002b510: 6970 6174 696f 6e20 6f66 2070 6f74 656e  ipation of poten
-0002b520: 7469 616c 2066 7574 7572 6520 7375 7070  tial future supp
-0002b530: 6f72 742e 0a0a 2020 2020 6465 6620 5f5f  ort...    def __
-0002b540: 696e 6974 5f5f 2873 656c 662c 2061 7267  init__(self, arg
-0002b550: 3a20 4172 7261 792c 202a 2c20 6172 7261  : Array, *, arra
-0002b560: 793a 2074 7970 6573 2e61 7272 6179 6461  y: types.arrayda
-0002b570: 7461 2c20 7369 6465 3a20 7374 722c 2073  ta, side: str, s
-0002b580: 6f72 7465 723a 2074 7970 696e 672e 4f70  orter: typing.Op
-0002b590: 7469 6f6e 616c 5b74 7970 6573 2e61 7272  tional[types.arr
-0002b5a0: 6179 6461 7461 5d29 3a0a 2020 2020 2020  aydata]):.      
-0002b5b0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-0002b5c0: 6e63 6528 6172 672c 2041 7272 6179 292c  nce(arg, Array),
-0002b5d0: 2066 2761 7267 3d7b 6172 6721 727d 270a   f'arg={arg!r}'.
-0002b5e0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-0002b5f0: 7369 6e73 7461 6e63 6528 6172 7261 792c  sinstance(array,
-0002b600: 2074 7970 6573 2e61 7272 6179 6461 7461   types.arraydata
-0002b610: 2920 616e 6420 6172 7261 792e 6e64 696d  ) and array.ndim
-0002b620: 203d 3d20 312c 2066 2761 7272 6179 3d7b   == 1, f'array={
-0002b630: 6172 7261 7921 727d 270a 2020 2020 2020  array!r}'.      
-0002b640: 2020 6173 7365 7274 2073 6964 6520 696e    assert side in
-0002b650: 2028 276c 6566 7427 2c20 2772 6967 6874   ('left', 'right
-0002b660: 2729 2c20 6627 7369 6465 3d7b 7369 6465  '), f'side={side
-0002b670: 2172 7d27 0a20 2020 2020 2020 2061 7373  !r}'.        ass
-0002b680: 6572 7420 736f 7274 6572 2069 7320 4e6f  ert sorter is No
-0002b690: 6e65 206f 7220 6973 696e 7374 616e 6365  ne or isinstance
-0002b6a0: 2873 6f72 7465 722c 2074 7970 6573 2e61  (sorter, types.a
-0002b6b0: 7272 6179 6461 7461 2920 616e 6420 736f  rraydata) and so
-0002b6c0: 7274 6572 2e64 7479 7065 203d 3d20 696e  rter.dtype == in
-0002b6d0: 7420 616e 6420 736f 7274 6572 2e73 6861  t and sorter.sha
-0002b6e0: 7065 203d 3d20 6172 7261 792e 7368 6170  pe == array.shap
-0002b6f0: 652c 2066 2773 6f72 7465 723d 7b73 6f72  e, f'sorter={sor
-0002b700: 7465 7221 727d 270a 2020 2020 2020 2020  ter!r}'.        
-0002b710: 7365 6c66 2e5f 6172 6720 3d20 6172 670a  self._arg = arg.
-0002b720: 2020 2020 2020 2020 7365 6c66 2e5f 6172          self._ar
-0002b730: 7261 7920 3d20 6172 7261 790a 2020 2020  ray = array.    
-0002b740: 2020 2020 7365 6c66 2e5f 7369 6465 203d      self._side =
-0002b750: 2073 6964 650a 2020 2020 2020 2020 7365   side.        se
-0002b760: 6c66 2e5f 736f 7274 6572 203d 2073 6f72  lf._sorter = sor
-0002b770: 7465 720a 2020 2020 2020 2020 7375 7065  ter.        supe
-0002b780: 7228 292e 5f5f 696e 6974 5f5f 2861 7267  r().__init__(arg
-0002b790: 733d 2861 7267 2c29 2c20 7368 6170 653d  s=(arg,), shape=
-0002b7a0: 6172 672e 7368 6170 652c 2064 7479 7065  arg.shape, dtype
-0002b7b0: 3d69 6e74 290a 0a20 2020 2064 6566 2065  =int)..    def e
-0002b7c0: 7661 6c66 2873 656c 662c 2076 616c 7565  valf(self, value
-0002b7d0: 7329 3a0a 2020 2020 2020 2020 696e 6465  s):.        inde
-0002b7e0: 7820 3d20 6e75 6d70 792e 7365 6172 6368  x = numpy.search
-0002b7f0: 736f 7274 6564 2873 656c 662e 5f61 7272  sorted(self._arr
-0002b800: 6179 2c20 7661 6c75 6573 2c20 7369 6465  ay, values, side
-0002b810: 3d73 656c 662e 5f73 6964 652c 2073 6f72  =self._side, sor
-0002b820: 7465 723d 7365 6c66 2e5f 736f 7274 6572  ter=self._sorter
-0002b830: 290a 2020 2020 2020 2020 2320 6f6e 2073  ).        # on s
-0002b840: 6f6d 6520 706c 6174 666f 726d 7320 2877  ome platforms (w
-0002b850: 696e 646f 7773 2920 7365 6172 6368 736f  indows) searchso
-0002b860: 7274 6564 2064 6f65 7320 6e6f 7420 7265  rted does not re
-0002b870: 7475 726e 2069 6e64 6963 6573 2061 730a  turn indices as.
-0002b880: 2020 2020 2020 2020 2320 6e75 6d70 792e          # numpy.
-0002b890: 6474 7970 6528 696e 7429 2c20 736f 2077  dtype(int), so w
-0002b8a0: 6520 7479 7065 2063 6173 7420 6974 2066  e type cast it f
-0002b8b0: 6f72 2063 6f6e 7369 7374 656e 6379 0a20  or consistency. 
-0002b8c0: 2020 2020 2020 2072 6574 7572 6e20 696e         return in
-0002b8d0: 6465 782e 6173 7479 7065 2869 6e74 2c20  dex.astype(int, 
-0002b8e0: 636f 7079 3d46 616c 7365 290a 0a20 2020  copy=False)..   
-0002b8f0: 2064 6566 205f 696e 7462 6f75 6e64 735f   def _intbounds_
-0002b900: 696d 706c 2873 656c 6629 3a0a 2020 2020  impl(self):.    
-0002b910: 2020 2020 7265 7475 726e 2030 2c20 7365      return 0, se
-0002b920: 6c66 2e5f 6172 7261 792e 7368 6170 655b  lf._array.shape[
-0002b930: 305d 0a0a 2020 2020 6465 6620 5f74 616b  0]..    def _tak
-0002b940: 6564 6961 6728 7365 6c66 2c20 6178 6973  ediag(self, axis
-0002b950: 312c 2061 7869 7332 293a 0a20 2020 2020  1, axis2):.     
-0002b960: 2020 2072 6574 7572 6e20 5365 6172 6368     return Search
-0002b970: 536f 7274 6564 285f 7461 6b65 6469 6167  Sorted(_takediag
-0002b980: 2873 656c 662e 5f61 7267 2c20 6178 6973  (self._arg, axis
-0002b990: 312c 2061 7869 7332 292c 2061 7272 6179  1, axis2), array
-0002b9a0: 3d73 656c 662e 5f61 7272 6179 2c20 7369  =self._array, si
-0002b9b0: 6465 3d73 656c 662e 5f73 6964 652c 2073  de=self._side, s
-0002b9c0: 6f72 7465 723d 7365 6c66 2e5f 736f 7274  orter=self._sort
-0002b9d0: 6572 290a 0a20 2020 2064 6566 205f 7461  er)..    def _ta
-0002b9e0: 6b65 2873 656c 662c 2069 6e64 6578 2c20  ke(self, index, 
-0002b9f0: 6178 6973 293a 0a20 2020 2020 2020 2072  axis):.        r
-0002ba00: 6574 7572 6e20 5365 6172 6368 536f 7274  eturn SearchSort
-0002ba10: 6564 285f 7461 6b65 2873 656c 662e 5f61  ed(_take(self._a
-0002ba20: 7267 2c20 696e 6465 782c 2061 7869 7329  rg, index, axis)
-0002ba30: 2c20 6172 7261 793d 7365 6c66 2e5f 6172  , array=self._ar
-0002ba40: 7261 792c 2073 6964 653d 7365 6c66 2e5f  ray, side=self._
-0002ba50: 7369 6465 2c20 736f 7274 6572 3d73 656c  side, sorter=sel
-0002ba60: 662e 5f73 6f72 7465 7229 0a0a 2020 2020  f._sorter)..    
-0002ba70: 6465 6620 5f75 6e72 6176 656c 2873 656c  def _unravel(sel
-0002ba80: 662c 2061 7869 732c 2073 6861 7065 293a  f, axis, shape):
-0002ba90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0002baa0: 5365 6172 6368 536f 7274 6564 2875 6e72  SearchSorted(unr
-0002bab0: 6176 656c 2873 656c 662e 5f61 7267 2c20  avel(self._arg, 
-0002bac0: 6178 6973 2c20 7368 6170 6529 2c20 6172  axis, shape), ar
-0002bad0: 7261 793d 7365 6c66 2e5f 6172 7261 792c  ray=self._array,
-0002bae0: 2073 6964 653d 7365 6c66 2e5f 7369 6465   side=self._side
-0002baf0: 2c20 736f 7274 6572 3d73 656c 662e 5f73  , sorter=self._s
-0002bb00: 6f72 7465 7229 0a0a 0a23 2041 5558 494c  orter)...# AUXIL
-0002bb10: 4941 5259 2046 554e 4354 494f 4e53 2028  IARY FUNCTIONS (
-0002bb20: 464f 5220 494e 5445 524e 414c 2055 5345  FOR INTERNAL USE
-0002bb30: 290a 0a0a 5f61 7363 656e 6469 6e67 203d  )..._ascending =
-0002bb40: 206c 616d 6264 6120 6172 673a 206e 756d   lambda arg: num
-0002bb50: 7079 2e67 7265 6174 6572 286e 756d 7079  py.greater(numpy
-0002bb60: 2e64 6966 6628 6172 6729 2c20 3029 2e61  .diff(arg), 0).a
-0002bb70: 6c6c 2829 0a0a 0a64 6566 205f 6761 7468  ll()...def _gath
-0002bb80: 6572 626c 6f63 6b73 2862 6c6f 636b 7329  erblocks(blocks)
-0002bb90: 3a0a 2020 2020 7265 7475 726e 2074 7570  :.    return tup
-0002bba0: 6c65 2828 696e 642c 2075 7469 6c2e 7375  le((ind, util.su
-0002bbb0: 6d28 6675 6e63 7329 2920 666f 7220 696e  m(funcs)) for in
-0002bbc0: 642c 2066 756e 6373 2069 6e20 7574 696c  d, funcs in util
-0002bbd0: 2e67 6174 6865 7228 626c 6f63 6b73 2929  .gather(blocks))
-0002bbe0: 0a0a 0a64 6566 205f 6761 7468 6572 7370  ...def _gathersp
-0002bbf0: 6172 7365 6368 756e 6b73 2863 6875 6e6b  arsechunks(chunk
-0002bc00: 7329 3a0a 2020 2020 7265 7475 726e 2074  s):.    return t
-0002bc10: 7570 6c65 2828 2a69 6e64 2c20 7574 696c  uple((*ind, util
-0002bc20: 2e73 756d 2866 756e 6373 2929 2066 6f72  .sum(funcs)) for
-0002bc30: 2069 6e64 2c20 6675 6e63 7320 696e 2075   ind, funcs in u
-0002bc40: 7469 6c2e 6761 7468 6572 2828 7475 706c  til.gather((tupl
-0002bc50: 6528 696e 6429 2c20 6675 6e63 2920 666f  e(ind), func) fo
-0002bc60: 7220 2a69 6e64 2c20 6675 6e63 2069 6e20  r *ind, func in 
-0002bc70: 6368 756e 6b73 2929 0a0a 0a64 6566 205f  chunks))...def _
-0002bc80: 6e75 6d70 795f 616c 6967 6e28 612c 2062  numpy_align(a, b
-0002bc90: 293a 0a20 2020 2027 2727 6368 6563 6b20  ):.    '''check 
-0002bca0: 7368 6170 6520 636f 6e73 6973 7465 6e63  shape consistenc
-0002bcb0: 7920 616e 6420 696e 666c 6174 6520 7363  y and inflate sc
-0002bcc0: 616c 6172 7327 2727 0a0a 2020 2020 6120  alars'''..    a 
-0002bcd0: 3d20 6173 6172 7261 7928 6129 0a20 2020  = asarray(a).   
-0002bce0: 2062 203d 2061 7361 7272 6179 2862 290a   b = asarray(b).
-0002bcf0: 2020 2020 6966 2061 2e64 7479 7065 2021      if a.dtype !
-0002bd00: 3d20 622e 6474 7970 653a 0a20 2020 2020  = b.dtype:.     
-0002bd10: 2020 2069 6620 5f74 7970 655f 6f72 6465     if _type_orde
-0002bd20: 722e 696e 6465 7828 612e 6474 7970 6529  r.index(a.dtype)
-0002bd30: 203c 205f 7479 7065 5f6f 7264 6572 2e69   < _type_order.i
-0002bd40: 6e64 6578 2862 2e64 7479 7065 293a 0a20  ndex(b.dtype):. 
-0002bd50: 2020 2020 2020 2020 2020 2061 203d 2061             a = a
-0002bd60: 7374 7970 6528 612c 2062 2e64 7479 7065  stype(a, b.dtype
-0002bd70: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0002bd80: 2020 2020 2020 2020 2020 2020 6220 3d20              b = 
-0002bd90: 6173 7479 7065 2862 2c20 612e 6474 7970  astype(b, a.dtyp
-0002bda0: 6529 0a20 2020 2069 6620 6e6f 7420 612e  e).    if not a.
-0002bdb0: 6e64 696d 3a0a 2020 2020 2020 2020 7265  ndim:.        re
-0002bdc0: 7475 726e 205f 696e 666c 6174 655f 7363  turn _inflate_sc
-0002bdd0: 616c 6172 2861 2c20 622e 7368 6170 6529  alar(a, b.shape)
-0002bde0: 2c20 620a 2020 2020 6966 206e 6f74 2062  , b.    if not b
-0002bdf0: 2e6e 6469 6d3a 0a20 2020 2020 2020 2072  .ndim:.        r
-0002be00: 6574 7572 6e20 612c 205f 696e 666c 6174  eturn a, _inflat
-0002be10: 655f 7363 616c 6172 2862 2c20 612e 7368  e_scalar(b, a.sh
-0002be20: 6170 6529 0a20 2020 2069 6620 6571 7561  ape).    if equa
-0002be30: 6c73 6861 7065 2861 2e73 6861 7065 2c20  lshape(a.shape, 
-0002be40: 622e 7368 6170 6529 3a0a 2020 2020 2020  b.shape):.      
-0002be50: 2020 7265 7475 726e 2061 2c20 620a 2020    return a, b.  
-0002be60: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-0002be70: 6f72 2827 696e 636f 6d70 6174 6962 6c65  or('incompatible
-0002be80: 2073 6861 7065 733a 207b 7d20 213d 207b   shapes: {} != {
-0002be90: 7d27 2e66 6f72 6d61 7428 2a5b 7475 706c  }'.format(*[tupl
-0002bea0: 6528 696e 7428 6e29 2069 6620 6e2e 6973  e(int(n) if n.is
-0002beb0: 636f 6e73 7461 6e74 2065 6c73 6520 6e20  constant else n 
-0002bec0: 666f 7220 6e20 696e 2061 7267 2e73 6861  for n in arg.sha
-0002bed0: 7065 2920 666f 7220 6172 6720 696e 2028  pe) for arg in (
-0002bee0: 612c 2062 295d 2929 0a0a 0a64 6566 205f  a, b)]))...def _
-0002bef0: 696e 666c 6174 655f 7363 616c 6172 2861  inflate_scalar(a
-0002bf00: 7267 2c20 7368 6170 6529 3a0a 2020 2020  rg, shape):.    
-0002bf10: 6172 6720 3d20 6173 6172 7261 7928 6172  arg = asarray(ar
-0002bf20: 6729 0a20 2020 2061 7373 6572 7420 6172  g).    assert ar
-0002bf30: 672e 6e64 696d 203d 3d20 300a 2020 2020  g.ndim == 0.    
-0002bf40: 666f 7220 6964 696d 2c20 6c65 6e67 7468  for idim, length
-0002bf50: 2069 6e20 656e 756d 6572 6174 6528 7368   in enumerate(sh
-0002bf60: 6170 6529 3a0a 2020 2020 2020 2020 6172  ape):.        ar
-0002bf70: 6720 3d20 696e 7365 7274 6178 6973 2861  g = insertaxis(a
-0002bf80: 7267 2c20 6964 696d 2c20 6c65 6e67 7468  rg, idim, length
-0002bf90: 290a 2020 2020 7265 7475 726e 2061 7267  ).    return arg
-0002bfa0: 0a0a 0a64 6566 205f 6973 756e 6971 7565  ...def _isunique
-0002bfb0: 2861 7272 6179 293a 0a20 2020 2072 6574  (array):.    ret
-0002bfc0: 7572 6e20 6e75 6d70 792e 756e 6971 7565  urn numpy.unique
-0002bfd0: 2861 7272 6179 292e 7369 7a65 203d 3d20  (array).size == 
-0002bfe0: 6172 7261 792e 7369 7a65 0a0a 0a64 6566  array.size...def
-0002bff0: 205f 6465 7065 6e64 656e 6369 6573 5f73   _dependencies_s
-0002c000: 616e 735f 696e 7661 7269 616e 7473 2866  ans_invariants(f
-0002c010: 756e 632c 2061 7267 293a 0a20 2020 2069  unc, arg):.    i
-0002c020: 6e76 6172 6961 6e74 7320 3d20 5b5d 0a20  nvariants = []. 
-0002c030: 2020 2064 6570 656e 6465 6e63 6965 7320     dependencies 
-0002c040: 3d20 5b5d 0a20 2020 205f 706f 7075 6c61  = [].    _popula
-0002c050: 7465 5f64 6570 656e 6465 6e63 6965 735f  te_dependencies_
-0002c060: 7361 6e73 5f69 6e76 6172 6961 6e74 7328  sans_invariants(
-0002c070: 6675 6e63 2c20 6172 672c 2069 6e76 6172  func, arg, invar
-0002c080: 6961 6e74 732c 2064 6570 656e 6465 6e63  iants, dependenc
-0002c090: 6965 732c 207b 6172 677d 290a 2020 2020  ies, {arg}).    
-0002c0a0: 6173 7365 7274 2028 6465 7065 6e64 656e  assert (dependen
-0002c0b0: 6369 6573 206f 7220 696e 7661 7269 616e  cies or invarian
-0002c0c0: 7473 206f 7220 5b61 7267 5d29 5b2d 315d  ts or [arg])[-1]
-0002c0d0: 203d 3d20 6675 6e63 0a20 2020 2072 6574   == func.    ret
-0002c0e0: 7572 6e20 7475 706c 6528 696e 7661 7269  urn tuple(invari
-0002c0f0: 616e 7473 292c 2074 7570 6c65 2864 6570  ants), tuple(dep
-0002c100: 656e 6465 6e63 6965 7329 0a0a 0a64 6566  endencies)...def
-0002c110: 205f 706f 7075 6c61 7465 5f64 6570 656e   _populate_depen
-0002c120: 6465 6e63 6965 735f 7361 6e73 5f69 6e76  dencies_sans_inv
-0002c130: 6172 6961 6e74 7328 6675 6e63 2c20 6172  ariants(func, ar
-0002c140: 672c 2069 6e76 6172 6961 6e74 732c 2064  g, invariants, d
-0002c150: 6570 656e 6465 6e63 6965 732c 2063 6163  ependencies, cac
-0002c160: 6865 293a 0a20 2020 2069 6620 6675 6e63  he):.    if func
-0002c170: 2069 6e20 6361 6368 653a 0a20 2020 2020   in cache:.     
-0002c180: 2020 2072 6574 7572 6e0a 2020 2020 6361     return.    ca
-0002c190: 6368 652e 6164 6428 6675 6e63 290a 2020  che.add(func).  
-0002c1a0: 2020 6966 2061 7267 2069 6e20 6675 6e63    if arg in func
-0002c1b0: 2e61 7267 756d 656e 7473 3a0a 2020 2020  .arguments:.    
-0002c1c0: 2020 2020 666f 7220 6368 696c 6420 696e      for child in
-0002c1d0: 2066 756e 632e 5f45 7661 6c75 6162 6c65   func._Evaluable
-0002c1e0: 5f5f 6172 6773 3a0a 2020 2020 2020 2020  __args:.        
-0002c1f0: 2020 2020 5f70 6f70 756c 6174 655f 6465      _populate_de
-0002c200: 7065 6e64 656e 6369 6573 5f73 616e 735f  pendencies_sans_
-0002c210: 696e 7661 7269 616e 7473 2863 6869 6c64  invariants(child
-0002c220: 2c20 6172 672c 2069 6e76 6172 6961 6e74  , arg, invariant
-0002c230: 732c 2064 6570 656e 6465 6e63 6965 732c  s, dependencies,
-0002c240: 2063 6163 6865 290a 2020 2020 2020 2020   cache).        
-0002c250: 6465 7065 6e64 656e 6369 6573 2e61 7070  dependencies.app
-0002c260: 656e 6428 6675 6e63 290a 2020 2020 656c  end(func).    el
-0002c270: 7365 3a0a 2020 2020 2020 2020 696e 7661  se:.        inva
-0002c280: 7269 616e 7473 2e61 7070 656e 6428 6675  riants.append(fu
-0002c290: 6e63 290a 0a0a 636c 6173 7320 5f53 7461  nc)...class _Sta
-0002c2a0: 7473 3a0a 0a20 2020 2064 6566 205f 5f69  ts:..    def __i
-0002c2b0: 6e69 745f 5f28 7365 6c66 2c20 6e63 616c  nit__(self, ncal
-0002c2c0: 6c73 3a20 696e 7420 3d20 302c 2074 696d  ls: int = 0, tim
-0002c2d0: 653a 2069 6e74 203d 2030 2920 2d3e 204e  e: int = 0) -> N
-0002c2e0: 6f6e 653a 0a20 2020 2020 2020 2073 656c  one:.        sel
-0002c2f0: 662e 6e63 616c 6c73 203d 206e 6361 6c6c  f.ncalls = ncall
-0002c300: 730a 2020 2020 2020 2020 7365 6c66 2e74  s.        self.t
-0002c310: 696d 6520 3d20 7469 6d65 0a20 2020 2020  ime = time.     
-0002c320: 2020 2073 656c 662e 5f73 7461 7274 203d     self._start =
-0002c330: 204e 6f6e 650a 0a20 2020 2064 6566 205f   None..    def _
-0002c340: 5f72 6570 725f 5f28 7365 6c66 293a 0a20  _repr__(self):. 
-0002c350: 2020 2020 2020 2072 6574 7572 6e20 275f         return '_
-0002c360: 5374 6174 7328 6e63 616c 6c73 3d7b 7d2c  Stats(ncalls={},
-0002c370: 2074 696d 653d 7b7d 2927 2e66 6f72 6d61   time={})'.forma
-0002c380: 7428 7365 6c66 2e6e 6361 6c6c 732c 2073  t(self.ncalls, s
-0002c390: 656c 662e 7469 6d65 290a 0a20 2020 2064  elf.time)..    d
-0002c3a0: 6566 205f 5f61 6464 5f5f 2873 656c 662c  ef __add__(self,
-0002c3b0: 206f 7468 6572 293a 0a20 2020 2020 2020   other):.       
-0002c3c0: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-0002c3d0: 6365 286f 7468 6572 2c20 5f53 7461 7473  ce(other, _Stats
-0002c3e0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-0002c3f0: 6574 7572 6e20 4e6f 7449 6d70 6c65 6d65  eturn NotImpleme
-0002c400: 6e74 6564 0a20 2020 2020 2020 2072 6574  nted.        ret
-0002c410: 7572 6e20 5f53 7461 7473 2873 656c 662e  urn _Stats(self.
-0002c420: 6e63 616c 6c73 2b6f 7468 6572 2e6e 6361  ncalls+other.nca
-0002c430: 6c6c 732c 2073 656c 662e 7469 6d65 2b6f  lls, self.time+o
-0002c440: 7468 6572 2e74 696d 6529 0a0a 2020 2020  ther.time)..    
-0002c450: 6465 6620 5f5f 656e 7465 725f 5f28 7365  def __enter__(se
-0002c460: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
-0002c470: 2020 2020 2073 656c 662e 5f73 7461 7274       self._start
-0002c480: 203d 2074 696d 652e 7065 7266 5f63 6f75   = time.perf_cou
-0002c490: 6e74 6572 5f6e 7328 290a 0a20 2020 2064  nter_ns()..    d
-0002c4a0: 6566 205f 5f65 7869 745f 5f28 7365 6c66  ef __exit__(self
-0002c4b0: 2c20 2a65 7863 5f69 6e66 6f29 202d 3e20  , *exc_info) -> 
-0002c4c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
-0002c4d0: 6c66 2e74 696d 6520 2b3d 2074 696d 652e  lf.time += time.
-0002c4e0: 7065 7266 5f63 6f75 6e74 6572 5f6e 7328  perf_counter_ns(
-0002c4f0: 2920 2d20 7365 6c66 2e5f 7374 6172 740a  ) - self._start.
-0002c500: 2020 2020 2020 2020 7365 6c66 2e6e 6361          self.nca
-0002c510: 6c6c 7320 2b3d 2031 0a0a 2320 4655 4e43  lls += 1..# FUNC
-0002c520: 5449 4f4e 530a 0a0a 6465 6620 6973 6172  TIONS...def isar
-0002c530: 7261 7928 6172 6729 3a0a 2020 2020 7265  ray(arg):.    re
-0002c540: 7475 726e 2069 7369 6e73 7461 6e63 6528  turn isinstance(
-0002c550: 6172 672c 2041 7272 6179 290a 0a0a 6465  arg, Array)...de
-0002c560: 6620 5f63 6f6e 7461 696e 7361 7272 6179  f _containsarray
-0002c570: 2861 7267 293a 0a20 2020 2072 6574 7572  (arg):.    retur
-0002c580: 6e20 616e 7928 6d61 7028 5f63 6f6e 7461  n any(map(_conta
-0002c590: 696e 7361 7272 6179 2c20 6172 6729 2920  insarray, arg)) 
-0002c5a0: 6966 2069 7369 6e73 7461 6e63 6528 6172  if isinstance(ar
-0002c5b0: 672c 2028 6c69 7374 2c20 7475 706c 6529  g, (list, tuple)
-0002c5c0: 2920 656c 7365 2069 7361 7272 6179 2861  ) else isarray(a
-0002c5d0: 7267 290a 0a0a 6465 6620 636f 6e73 7461  rg)...def consta
-0002c5e0: 6e74 2876 293a 0a20 2020 2072 6574 7572  nt(v):.    retur
-0002c5f0: 6e20 436f 6e73 7461 6e74 2874 7970 6573  n Constant(types
-0002c600: 2e61 7272 6179 6461 7461 2876 2929 0a0a  .arraydata(v))..
-0002c610: 0a64 6566 2069 737a 6572 6f28 6172 6729  .def iszero(arg)
-0002c620: 3a0a 2020 2020 7265 7475 726e 2069 7369  :.    return isi
-0002c630: 6e73 7461 6e63 6528 6172 672e 7369 6d70  nstance(arg.simp
-0002c640: 6c69 6669 6564 2c20 5a65 726f 7329 0a0a  lified, Zeros)..
-0002c650: 0a64 6566 207a 6572 6f73 2873 6861 7065  .def zeros(shape
-0002c660: 2c20 6474 7970 653d 666c 6f61 7429 3a0a  , dtype=float):.
-0002c670: 2020 2020 7265 7475 726e 205a 6572 6f73      return Zeros
-0002c680: 2873 6861 7065 2c20 6474 7970 6529 0a0a  (shape, dtype)..
-0002c690: 0a64 6566 207a 6572 6f73 5f6c 696b 6528  .def zeros_like(
-0002c6a0: 6172 7229 3a0a 2020 2020 7265 7475 726e  arr):.    return
-0002c6b0: 207a 6572 6f73 2861 7272 2e73 6861 7065   zeros(arr.shape
-0002c6c0: 2c20 6172 722e 6474 7970 6529 0a0a 0a64  , arr.dtype)...d
-0002c6d0: 6566 206f 6e65 7328 7368 6170 652c 2064  ef ones(shape, d
-0002c6e0: 7479 7065 3d66 6c6f 6174 293a 0a20 2020  type=float):.   
-0002c6f0: 2072 6574 7572 6e20 5f69 6e66 6c61 7465   return _inflate
-0002c700: 5f73 6361 6c61 7228 636f 6e73 7461 6e74  _scalar(constant
-0002c710: 2864 7479 7065 2831 2929 2c20 7368 6170  (dtype(1)), shap
-0002c720: 6529 0a0a 0a64 6566 206f 6e65 735f 6c69  e)...def ones_li
-0002c730: 6b65 2861 7272 293a 0a20 2020 2072 6574  ke(arr):.    ret
-0002c740: 7572 6e20 6f6e 6573 2861 7272 2e73 6861  urn ones(arr.sha
-0002c750: 7065 2c20 6172 722e 6474 7970 6529 0a0a  pe, arr.dtype)..
-0002c760: 0a64 6566 2072 6563 6970 726f 6361 6c28  .def reciprocal(
-0002c770: 6172 6729 3a0a 2020 2020 7265 7475 726e  arg):.    return
-0002c780: 2070 6f77 6572 2861 7267 2c20 6173 7479   power(arg, asty
-0002c790: 7065 282d 312c 2066 6c6f 6174 2929 0a0a  pe(-1, float))..
-0002c7a0: 0a64 6566 206e 6567 6174 6976 6528 6172  .def negative(ar
-0002c7b0: 6729 3a0a 2020 2020 7265 7475 726e 206d  g):.    return m
-0002c7c0: 756c 7469 706c 7928 6172 672c 202d 3129  ultiply(arg, -1)
-0002c7d0: 0a0a 0a64 6566 2073 696e 2878 293a 0a20  ...def sin(x):. 
-0002c7e0: 2020 2072 6574 7572 6e20 5369 6e28 7829     return Sin(x)
-0002c7f0: 0a0a 0a64 6566 2063 6f73 2878 293a 0a20  ...def cos(x):. 
-0002c800: 2020 2072 6574 7572 6e20 436f 7328 7829     return Cos(x)
-0002c810: 0a0a 0a64 6566 2074 616e 2878 293a 0a20  ...def tan(x):. 
-0002c820: 2020 2072 6574 7572 6e20 5461 6e28 7829     return Tan(x)
-0002c830: 0a0a 0a64 6566 2061 7263 7369 6e28 7829  ...def arcsin(x)
-0002c840: 3a0a 2020 2020 7265 7475 726e 2041 7263  :.    return Arc
-0002c850: 5369 6e28 7829 0a0a 0a64 6566 2061 7263  Sin(x)...def arc
-0002c860: 636f 7328 7829 3a0a 2020 2020 7265 7475  cos(x):.    retu
-0002c870: 726e 2041 7263 436f 7328 7829 0a0a 0a64  rn ArcCos(x)...d
-0002c880: 6566 2061 7263 7461 6e28 7829 3a0a 2020  ef arctan(x):.  
-0002c890: 2020 7265 7475 726e 2041 7263 5461 6e28    return ArcTan(
-0002c8a0: 7829 0a0a 0a64 6566 2073 696e 6328 7829  x)...def sinc(x)
-0002c8b0: 3a0a 2020 2020 7265 7475 726e 2053 696e  :.    return Sin
-0002c8c0: 6328 782c 206e 3d30 290a 0a0a 6465 6620  c(x, n=0)...def 
-0002c8d0: 6578 7028 7829 3a0a 2020 2020 7265 7475  exp(x):.    retu
-0002c8e0: 726e 2045 7870 2878 290a 0a0a 6465 6620  rn Exp(x)...def 
-0002c8f0: 6c6e 2878 293a 0a20 2020 2072 6574 7572  ln(x):.    retur
-0002c900: 6e20 4c6f 6728 7829 0a0a 0a64 6566 2064  n Log(x)...def d
-0002c910: 6976 6d6f 6428 782c 2079 293a 0a20 2020  ivmod(x, y):.   
-0002c920: 2064 6976 203d 2046 6c6f 6f72 4469 7669   div = FloorDivi
-0002c930: 6465 282a 5f6e 756d 7079 5f61 6c69 676e  de(*_numpy_align
-0002c940: 2878 2c20 7929 290a 2020 2020 6d6f 6420  (x, y)).    mod 
-0002c950: 3d20 7820 2d20 6469 7620 2a20 790a 2020  = x - div * y.  
-0002c960: 2020 7265 7475 726e 2064 6976 2c20 6d6f    return div, mo
-0002c970: 640a 0a0a 6465 6620 6d6f 6428 6172 6731  d...def mod(arg1
-0002c980: 2c20 6172 6732 293a 0a20 2020 2072 6574  , arg2):.    ret
-0002c990: 7572 6e20 4d6f 6428 2a5f 6e75 6d70 795f  urn Mod(*_numpy_
-0002c9a0: 616c 6967 6e28 6172 6731 2c20 6172 6732  align(arg1, arg2
-0002c9b0: 2929 0a0a 0a64 6566 206c 6f67 3228 6172  ))...def log2(ar
-0002c9c0: 6729 3a0a 2020 2020 7265 7475 726e 206c  g):.    return l
-0002c9d0: 6e28 6172 6729 202f 2063 6f6e 7374 616e  n(arg) / constan
-0002c9e0: 7428 6e75 6d70 792e 6c6f 6728 3229 290a  t(numpy.log(2)).
-0002c9f0: 0a0a 6465 6620 6c6f 6731 3028 6172 6729  ..def log10(arg)
-0002ca00: 3a0a 2020 2020 7265 7475 726e 206c 6e28  :.    return ln(
-0002ca10: 6172 6729 202f 2063 6f6e 7374 616e 7428  arg) / constant(
-0002ca20: 6e75 6d70 792e 6c6f 6728 3130 2929 0a0a  numpy.log(10))..
-0002ca30: 0a64 6566 2073 7172 7428 6172 6729 3a0a  .def sqrt(arg):.
-0002ca40: 2020 2020 7265 7475 726e 2070 6f77 6572      return power
-0002ca50: 2861 7267 2c20 636f 6e73 7461 6e74 282e  (arg, constant(.
-0002ca60: 3529 290a 0a0a 6465 6620 6172 6374 616e  5))...def arctan
-0002ca70: 3228 6172 6731 2c20 6172 6732 293a 0a20  2(arg1, arg2):. 
-0002ca80: 2020 2072 6574 7572 6e20 4172 6354 616e     return ArcTan
-0002ca90: 3228 2a5f 6e75 6d70 795f 616c 6967 6e28  2(*_numpy_align(
-0002caa0: 6172 6731 2c20 6172 6732 2929 0a0a 0a64  arg1, arg2))...d
-0002cab0: 6566 2061 6273 2861 7267 293a 0a20 2020  ef abs(arg):.   
-0002cac0: 2069 6620 6172 672e 6474 7970 6520 3d3d   if arg.dtype ==
-0002cad0: 2063 6f6d 706c 6578 3a0a 2020 2020 2020   complex:.      
-0002cae0: 2020 7265 7475 726e 2073 7172 7428 6172    return sqrt(ar
-0002caf0: 672e 7265 616c 2a2a 3220 2b20 6172 672e  g.real**2 + arg.
-0002cb00: 696d 6167 2a2a 3229 0a20 2020 2065 6c73  imag**2).    els
-0002cb10: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
-0002cb20: 6e20 6172 6720 2a20 7369 676e 2861 7267  n arg * sign(arg
-0002cb30: 290a 0a0a 6465 6620 7369 6e68 2861 7267  )...def sinh(arg
-0002cb40: 293a 0a20 2020 2072 6574 7572 6e20 5369  ):.    return Si
-0002cb50: 6e48 2861 7267 290a 0a0a 6465 6620 636f  nH(arg)...def co
-0002cb60: 7368 2861 7267 293a 0a20 2020 2072 6574  sh(arg):.    ret
-0002cb70: 7572 6e20 436f 7348 2861 7267 290a 0a0a  urn CosH(arg)...
-0002cb80: 6465 6620 7461 6e68 2861 7267 293a 0a20  def tanh(arg):. 
-0002cb90: 2020 2072 6574 7572 6e20 5461 6e48 2861     return TanH(a
-0002cba0: 7267 290a 0a0a 6465 6620 6172 6374 616e  rg)...def arctan
-0002cbb0: 6828 6172 6729 3a0a 2020 2020 7265 7475  h(arg):.    retu
-0002cbc0: 726e 2041 7263 5461 6e48 2861 7267 290a  rn ArcTanH(arg).
-0002cbd0: 0a0a 6465 6620 6469 7669 6465 2861 7267  ..def divide(arg
-0002cbe0: 312c 2061 7267 3229 3a0a 2020 2020 7265  1, arg2):.    re
-0002cbf0: 7475 726e 206d 756c 7469 706c 7928 6172  turn multiply(ar
-0002cc00: 6731 2c20 7265 6369 7072 6f63 616c 2861  g1, reciprocal(a
-0002cc10: 7267 3229 290a 0a0a 6465 6620 7375 6274  rg2))...def subt
-0002cc20: 7261 6374 2861 7267 312c 2061 7267 3229  ract(arg1, arg2)
-0002cc30: 3a0a 2020 2020 7265 7475 726e 2061 6464  :.    return add
-0002cc40: 2861 7267 312c 206e 6567 6174 6976 6528  (arg1, negative(
-0002cc50: 6172 6732 2929 0a0a 0a64 6566 2069 6e73  arg2))...def ins
-0002cc60: 6572 7461 7869 7328 6172 672c 206e 2c20  ertaxis(arg, n, 
-0002cc70: 6c65 6e67 7468 293a 0a20 2020 2072 6574  length):.    ret
-0002cc80: 7572 6e20 5472 616e 7370 6f73 652e 6672  urn Transpose.fr
-0002cc90: 6f6d 5f65 6e64 2849 6e73 6572 7441 7869  om_end(InsertAxi
-0002cca0: 7328 6172 672c 206c 656e 6774 6829 2c20  s(arg, length), 
-0002ccb0: 6e29 0a0a 0a64 6566 2063 6f6e 6361 7465  n)...def concate
-0002ccc0: 6e61 7465 2861 7267 732c 2061 7869 733d  nate(args, axis=
-0002ccd0: 3029 3a0a 2020 2020 6c65 6e67 7468 7320  0):.    lengths 
-0002cce0: 3d20 5b61 7267 2e73 6861 7065 5b61 7869  = [arg.shape[axi
-0002ccf0: 735d 2066 6f72 2061 7267 2069 6e20 6172  s] for arg in ar
-0002cd00: 6773 5d0a 2020 2020 2a6f 6666 7365 7473  gs].    *offsets
-0002cd10: 2c20 746f 746c 656e 6774 6820 3d20 7574  , totlength = ut
-0002cd20: 696c 2e63 756d 7375 6d28 6c65 6e67 7468  il.cumsum(length
-0002cd30: 7320 2b20 5b30 5d29 0a20 2020 2072 6574  s + [0]).    ret
-0002cd40: 7572 6e20 5472 616e 7370 6f73 652e 6672  urn Transpose.fr
-0002cd50: 6f6d 5f65 6e64 2875 7469 6c2e 7375 6d28  om_end(util.sum(
-0002cd60: 496e 666c 6174 6528 5472 616e 7370 6f73  Inflate(Transpos
-0002cd70: 652e 746f 5f65 6e64 2861 7267 2c20 6178  e.to_end(arg, ax
-0002cd80: 6973 292c 2052 616e 6765 286c 656e 6774  is), Range(lengt
-0002cd90: 6829 202b 206f 6666 7365 742c 2074 6f74  h) + offset, tot
-0002cda0: 6c65 6e67 7468 2920 666f 7220 6172 672c  length) for arg,
-0002cdb0: 206c 656e 6774 682c 206f 6666 7365 7420   length, offset 
-0002cdc0: 696e 207a 6970 2861 7267 732c 206c 656e  in zip(args, len
-0002cdd0: 6774 6873 2c20 6f66 6673 6574 7329 292c  gths, offsets)),
-0002cde0: 2061 7869 7329 0a0a 0a64 6566 2073 7461   axis)...def sta
-0002cdf0: 636b 2861 7267 732c 2061 7869 733d 3029  ck(args, axis=0)
-0002ce00: 3a0a 2020 2020 7265 7475 726e 2054 7261  :.    return Tra
-0002ce10: 6e73 706f 7365 2e66 726f 6d5f 656e 6428  nspose.from_end(
-0002ce20: 7574 696c 2e73 756d 2849 6e66 6c61 7465  util.sum(Inflate
-0002ce30: 2861 7267 2c20 636f 6e73 7461 6e74 2869  (arg, constant(i
-0002ce40: 292c 2063 6f6e 7374 616e 7428 6c65 6e28  ), constant(len(
-0002ce50: 6172 6773 2929 2920 666f 7220 692c 2061  args))) for i, a
-0002ce60: 7267 2069 6e20 656e 756d 6572 6174 6528  rg in enumerate(
-0002ce70: 6172 6773 2929 2c20 6178 6973 290a 0a0a  args)), axis)...
-0002ce80: 6465 6620 7265 7065 6174 2861 7267 2c20  def repeat(arg, 
-0002ce90: 6c65 6e67 7468 2c20 6178 6973 293a 0a20  length, axis):. 
-0002cea0: 2020 2061 7267 203d 2061 7361 7272 6179     arg = asarray
-0002ceb0: 2861 7267 290a 2020 2020 6173 7365 7274  (arg).    assert
-0002cec0: 205f 6571 7561 6c73 5f73 6361 6c61 725f   _equals_scalar_
-0002ced0: 636f 6e73 7461 6e74 2861 7267 2e73 6861  constant(arg.sha
-0002cee0: 7065 5b61 7869 735d 2c20 3129 0a20 2020  pe[axis], 1).   
-0002cef0: 2072 6574 7572 6e20 696e 7365 7274 6178   return insertax
-0002cf00: 6973 2867 6574 2861 7267 2c20 6178 6973  is(get(arg, axis
-0002cf10: 2c20 636f 6e73 7461 6e74 2830 2929 2c20  , constant(0)), 
-0002cf20: 6178 6973 2c20 6c65 6e67 7468 290a 0a0a  axis, length)...
-0002cf30: 6465 6620 6765 7428 6172 672c 2069 6178  def get(arg, iax
-0002cf40: 2c20 6974 656d 293a 0a20 2020 2069 6620  , item):.    if 
-0002cf50: 6e75 6d65 7269 632e 6973 696e 7428 6974  numeric.isint(it
-0002cf60: 656d 293a 0a20 2020 2020 2020 2069 6620  em):.        if 
-0002cf70: 6e75 6d65 7269 632e 6973 696e 7428 6172  numeric.isint(ar
-0002cf80: 672e 7368 6170 655b 6961 785d 293a 0a20  g.shape[iax]):. 
-0002cf90: 2020 2020 2020 2020 2020 2069 7465 6d20             item 
-0002cfa0: 3d20 6e75 6d65 7269 632e 6e6f 726d 6469  = numeric.normdi
-0002cfb0: 6d28 6172 672e 7368 6170 655b 6961 785d  m(arg.shape[iax]
-0002cfc0: 2c20 6974 656d 290a 2020 2020 2020 2020  , item).        
-0002cfd0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0002cfe0: 2020 6173 7365 7274 2069 7465 6d20 3e3d    assert item >=
-0002cff0: 2030 0a20 2020 2072 6574 7572 6e20 5461   0.    return Ta
-0002d000: 6b65 2854 7261 6e73 706f 7365 2e74 6f5f  ke(Transpose.to_
-0002d010: 656e 6428 6172 672c 2069 6178 292c 2069  end(arg, iax), i
-0002d020: 7465 6d29 0a0a 0a64 6566 2064 6574 6572  tem)...def deter
-0002d030: 6d69 6e61 6e74 2861 7267 2c20 6178 6573  minant(arg, axes
-0002d040: 3d28 2d32 2c20 2d31 2929 3a0a 2020 2020  =(-2, -1)):.    
-0002d050: 7265 7475 726e 2044 6574 6572 6d69 6e61  return Determina
-0002d060: 6e74 2854 7261 6e73 706f 7365 2e74 6f5f  nt(Transpose.to_
-0002d070: 656e 6428 6172 672c 202a 6178 6573 2929  end(arg, *axes))
-0002d080: 0a0a 0a64 6566 2067 7261 6d6d 6975 6d28  ...def grammium(
-0002d090: 6172 672c 2061 7865 733d 282d 322c 202d  arg, axes=(-2, -
-0002d0a0: 3129 293a 0a20 2020 2061 7267 203d 2054  1)):.    arg = T
-0002d0b0: 7261 6e73 706f 7365 2e74 6f5f 656e 6428  ranspose.to_end(
-0002d0c0: 6172 672c 202a 6178 6573 290a 2020 2020  arg, *axes).    
-0002d0d0: 6772 616d 6d69 756d 203d 2065 696e 7375  grammium = einsu
-0002d0e0: 6d28 2741 6b69 2c41 6b6a 2d3e 4169 6a27  m('Aki,Akj->Aij'
-0002d0f0: 2c20 6172 672c 2061 7267 290a 2020 2020  , arg, arg).    
-0002d100: 7265 7475 726e 2054 7261 6e73 706f 7365  return Transpose
-0002d110: 2e66 726f 6d5f 656e 6428 6772 616d 6d69  .from_end(grammi
-0002d120: 756d 2c20 2a61 7865 7329 0a0a 0a64 6566  um, *axes)...def
-0002d130: 2073 7172 745f 6162 735f 6465 745f 6772   sqrt_abs_det_gr
-0002d140: 616d 2861 7267 2c20 6178 6573 3d28 2d32  am(arg, axes=(-2
-0002d150: 2c20 2d31 2929 3a0a 2020 2020 6172 6720  , -1)):.    arg 
-0002d160: 3d20 5472 616e 7370 6f73 652e 746f 5f65  = Transpose.to_e
-0002d170: 6e64 2861 7267 2c20 2a61 7865 7329 0a20  nd(arg, *axes). 
-0002d180: 2020 2069 6620 5f65 7175 616c 735f 7369     if _equals_si
-0002d190: 6d70 6c69 6669 6564 2861 7267 2e73 6861  mplified(arg.sha
-0002d1a0: 7065 5b2d 315d 2c20 6172 672e 7368 6170  pe[-1], arg.shap
-0002d1b0: 655b 2d32 5d29 3a0a 2020 2020 2020 2020  e[-2]):.        
-0002d1c0: 7265 7475 726e 2061 6273 2844 6574 6572  return abs(Deter
-0002d1d0: 6d69 6e61 6e74 2861 7267 2929 0a20 2020  minant(arg)).   
-0002d1e0: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
-0002d1f0: 6574 7572 6e20 7371 7274 2861 6273 2844  eturn sqrt(abs(D
-0002d200: 6574 6572 6d69 6e61 6e74 2867 7261 6d6d  eterminant(gramm
-0002d210: 6975 6d28 6172 6729 2929 290a 0a0a 6465  ium(arg))))...de
-0002d220: 6620 696e 7665 7273 6528 6172 672c 2061  f inverse(arg, a
-0002d230: 7865 733d 282d 322c 202d 3129 293a 0a20  xes=(-2, -1)):. 
-0002d240: 2020 2072 6574 7572 6e20 5472 616e 7370     return Transp
-0002d250: 6f73 652e 6672 6f6d 5f65 6e64 2849 6e76  ose.from_end(Inv
-0002d260: 6572 7365 2854 7261 6e73 706f 7365 2e74  erse(Transpose.t
-0002d270: 6f5f 656e 6428 6172 672c 202a 6178 6573  o_end(arg, *axes
-0002d280: 2929 2c20 2a61 7865 7329 0a0a 0a64 6566  )), *axes)...def
-0002d290: 2074 616b 6564 6961 6728 6172 672c 2061   takediag(arg, a
-0002d2a0: 7869 733d 2d32 2c20 726d 6178 6973 3d2d  xis=-2, rmaxis=-
-0002d2b0: 3129 3a0a 2020 2020 6172 6720 3d20 6173  1):.    arg = as
-0002d2c0: 6172 7261 7928 6172 6729 0a20 2020 2061  array(arg).    a
-0002d2d0: 7869 7320 3d20 6e75 6d65 7269 632e 6e6f  xis = numeric.no
-0002d2e0: 726d 6469 6d28 6172 672e 6e64 696d 2c20  rmdim(arg.ndim, 
-0002d2f0: 6178 6973 290a 2020 2020 726d 6178 6973  axis).    rmaxis
-0002d300: 203d 206e 756d 6572 6963 2e6e 6f72 6d64   = numeric.normd
-0002d310: 696d 2861 7267 2e6e 6469 6d2c 2072 6d61  im(arg.ndim, rma
-0002d320: 7869 7329 0a20 2020 2061 7373 6572 7420  xis).    assert 
-0002d330: 6178 6973 203c 2072 6d61 7869 730a 2020  axis < rmaxis.  
-0002d340: 2020 7265 7475 726e 2054 7261 6e73 706f    return Transpo
-0002d350: 7365 2e66 726f 6d5f 656e 6428 5f74 616b  se.from_end(_tak
-0002d360: 6564 6961 6728 6172 672c 2061 7869 732c  ediag(arg, axis,
-0002d370: 2072 6d61 7869 7329 2c20 6178 6973 290a   rmaxis), axis).
-0002d380: 0a0a 6465 6620 5f74 616b 6564 6961 6728  ..def _takediag(
-0002d390: 6172 672c 2061 7869 7331 3d2d 322c 2061  arg, axis1=-2, a
-0002d3a0: 7869 7332 3d2d 3129 3a0a 2020 2020 7265  xis2=-1):.    re
-0002d3b0: 7475 726e 2054 616b 6544 6961 6728 5472  turn TakeDiag(Tr
-0002d3c0: 616e 7370 6f73 652e 746f 5f65 6e64 2861  anspose.to_end(a
-0002d3d0: 7267 2c20 6178 6973 312c 2061 7869 7332  rg, axis1, axis2
-0002d3e0: 2929 0a0a 0a64 6566 2064 6572 6976 6174  ))...def derivat
-0002d3f0: 6976 6528 6675 6e63 2c20 7661 722c 2073  ive(func, var, s
-0002d400: 6565 6e3d 4e6f 6e65 293a 0a20 2020 2027  een=None):.    '
-0002d410: 6465 7269 7661 7469 7665 270a 0a20 2020  derivative'..   
-0002d420: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-0002d430: 6365 2876 6172 2c20 4465 7269 7661 7469  ce(var, Derivati
-0002d440: 7665 5461 7267 6574 4261 7365 292c 2027  veTargetBase), '
-0002d450: 696e 7661 6c69 6420 6465 7269 7661 7469  invalid derivati
-0002d460: 7665 2074 6172 6765 7420 7b21 727d 272e  ve target {!r}'.
-0002d470: 666f 726d 6174 2876 6172 290a 2020 2020  format(var).    
-0002d480: 6966 2076 6172 2e64 7479 7065 2069 6e20  if var.dtype in 
-0002d490: 2862 6f6f 6c2c 2069 6e74 2920 6f72 2076  (bool, int) or v
-0002d4a0: 6172 206e 6f74 2069 6e20 6675 6e63 2e61  ar not in func.a
-0002d4b0: 7267 756d 656e 7473 3a0a 2020 2020 2020  rguments:.      
-0002d4c0: 2020 7265 7475 726e 205a 6572 6f73 2866    return Zeros(f
-0002d4d0: 756e 632e 7368 6170 6520 2b20 7661 722e  unc.shape + var.
-0002d4e0: 7368 6170 652c 2064 7479 7065 3d66 756e  shape, dtype=fun
-0002d4f0: 632e 6474 7970 6529 0a20 2020 2069 6620  c.dtype).    if 
-0002d500: 7365 656e 2069 7320 4e6f 6e65 3a0a 2020  seen is None:.  
-0002d510: 2020 2020 2020 7365 656e 203d 207b 7d0a        seen = {}.
-0002d520: 2020 2020 6966 2066 756e 6320 696e 2073      if func in s
-0002d530: 6565 6e3a 0a20 2020 2020 2020 2072 6573  een:.        res
-0002d540: 756c 7420 3d20 7365 656e 5b66 756e 635d  ult = seen[func]
-0002d550: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0002d560: 2020 2072 6573 756c 7420 3d20 6675 6e63     result = func
-0002d570: 2e5f 6465 7269 7661 7469 7665 2876 6172  ._derivative(var
-0002d580: 2c20 7365 656e 290a 2020 2020 2020 2020  , seen).        
-0002d590: 7365 656e 5b66 756e 635d 203d 2072 6573  seen[func] = res
-0002d5a0: 756c 740a 2020 2020 6173 7365 7274 2065  ult.    assert e
-0002d5b0: 7175 616c 7368 6170 6528 7265 7375 6c74  qualshape(result
-0002d5c0: 2e73 6861 7065 2c20 6675 6e63 2e73 6861  .shape, func.sha
-0002d5d0: 7065 2b76 6172 2e73 6861 7065 2920 616e  pe+var.shape) an
-0002d5e0: 6420 7265 7375 6c74 2e64 7479 7065 203d  d result.dtype =
-0002d5f0: 3d20 6675 6e63 2e64 7479 7065 2c20 2762  = func.dtype, 'b
-0002d600: 7567 2069 6e20 7b7d 2e5f 6465 7269 7661  ug in {}._deriva
-0002d610: 7469 7665 272e 666f 726d 6174 2874 7970  tive'.format(typ
-0002d620: 6528 6675 6e63 292e 5f5f 6e61 6d65 5f5f  e(func).__name__
-0002d630: 290a 2020 2020 7265 7475 726e 2072 6573  ).    return res
-0002d640: 756c 740a 0a0a 6465 6620 6469 6167 6f6e  ult...def diagon
-0002d650: 616c 697a 6528 6172 672c 2061 7869 733d  alize(arg, axis=
-0002d660: 2d31 2c20 6e65 7761 7869 733d 2d31 293a  -1, newaxis=-1):
-0002d670: 0a20 2020 2061 7267 203d 2061 7361 7272  .    arg = asarr
-0002d680: 6179 2861 7267 290a 2020 2020 6178 6973  ay(arg).    axis
-0002d690: 203d 206e 756d 6572 6963 2e6e 6f72 6d64   = numeric.normd
-0002d6a0: 696d 2861 7267 2e6e 6469 6d2c 2061 7869  im(arg.ndim, axi
-0002d6b0: 7329 0a20 2020 206e 6577 6178 6973 203d  s).    newaxis =
-0002d6c0: 206e 756d 6572 6963 2e6e 6f72 6d64 696d   numeric.normdim
-0002d6d0: 2861 7267 2e6e 6469 6d2b 312c 206e 6577  (arg.ndim+1, new
-0002d6e0: 6178 6973 290a 2020 2020 6173 7365 7274  axis).    assert
-0002d6f0: 2061 7869 7320 3c20 6e65 7761 7869 730a   axis < newaxis.
-0002d700: 2020 2020 7265 7475 726e 2054 7261 6e73      return Trans
-0002d710: 706f 7365 2e66 726f 6d5f 656e 6428 4469  pose.from_end(Di
-0002d720: 6167 6f6e 616c 697a 6528 5472 616e 7370  agonalize(Transp
-0002d730: 6f73 652e 746f 5f65 6e64 2861 7267 2c20  ose.to_end(arg, 
-0002d740: 6178 6973 2929 2c20 6178 6973 2c20 6e65  axis)), axis, ne
-0002d750: 7761 7869 7329 0a0a 0a64 6566 2073 6967  waxis)...def sig
-0002d760: 6e28 6172 6729 3a0a 2020 2020 6172 6720  n(arg):.    arg 
-0002d770: 3d20 6173 6172 7261 7928 6172 6729 0a20  = asarray(arg). 
-0002d780: 2020 2069 6620 6172 672e 6474 7970 6520     if arg.dtype 
-0002d790: 3d3d 2063 6f6d 706c 6578 3a0a 2020 2020  == complex:.    
-0002d7a0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-0002d7b0: 7272 6f72 2827 7369 676e 2069 7320 6e6f  rror('sign is no
-0002d7c0: 7420 6465 6669 6e65 6420 666f 7220 636f  t defined for co
-0002d7d0: 6d70 6c65 7820 6e75 6d62 6572 7327 290a  mplex numbers').
-0002d7e0: 2020 2020 7265 7475 726e 2053 6967 6e28      return Sign(
-0002d7f0: 6172 6729 0a0a 0a64 6566 2065 6967 2861  arg)...def eig(a
-0002d800: 7267 2c20 6178 6573 3d28 2d32 2c20 2d31  rg, axes=(-2, -1
-0002d810: 292c 2073 796d 6d65 7472 6963 3d46 616c  ), symmetric=Fal
-0002d820: 7365 293a 0a20 2020 2065 6967 7661 6c2c  se):.    eigval,
-0002d830: 2065 6967 7665 6320 3d20 4569 6728 5472   eigvec = Eig(Tr
-0002d840: 616e 7370 6f73 652e 746f 5f65 6e64 2861  anspose.to_end(a
-0002d850: 7267 2c20 2a61 7865 7329 2c20 7379 6d6d  rg, *axes), symm
-0002d860: 6574 7269 6329 0a20 2020 2072 6574 7572  etric).    retur
-0002d870: 6e20 5475 706c 6528 7475 706c 6528 5472  n Tuple(tuple(Tr
-0002d880: 616e 7370 6f73 652e 6672 6f6d 5f65 6e64  anspose.from_end
-0002d890: 2876 2c20 2a61 7865 7329 2066 6f72 2076  (v, *axes) for v
-0002d8a0: 2069 6e20 5b64 6961 676f 6e61 6c69 7a65   in [diagonalize
-0002d8b0: 2865 6967 7661 6c29 2c20 6569 6776 6563  (eigval), eigvec
-0002d8c0: 5d29 290a 0a0a 6465 6620 5f74 616b 6573  ]))...def _takes
-0002d8d0: 6c69 6365 2861 7267 3a20 4172 7261 792c  lice(arg: Array,
-0002d8e0: 2073 3a20 736c 6963 652c 2061 7869 733a   s: slice, axis:
-0002d8f0: 2069 6e74 293a 0a20 2020 2061 7373 6572   int):.    asser
-0002d900: 7420 6973 696e 7374 616e 6365 2861 7267  t isinstance(arg
-0002d910: 2c20 4172 7261 7929 2c20 6627 6172 673d  , Array), f'arg=
-0002d920: 7b61 7267 2172 7d27 0a20 2020 2061 7373  {arg!r}'.    ass
-0002d930: 6572 7420 6973 696e 7374 616e 6365 2873  ert isinstance(s
-0002d940: 2c20 736c 6963 6529 2c20 6627 733d 7b73  , slice), f's={s
-0002d950: 2172 7d27 0a20 2020 2061 7373 6572 7420  !r}'.    assert 
-0002d960: 6973 696e 7374 616e 6365 2861 7869 732c  isinstance(axis,
-0002d970: 2069 6e74 292c 2066 2761 7869 733d 7b61   int), f'axis={a
-0002d980: 7869 7321 727d 270a 2020 2020 6e20 3d20  xis!r}'.    n = 
-0002d990: 6172 672e 7368 6170 655b 6178 6973 5d0a  arg.shape[axis].
-0002d9a0: 2020 2020 6966 2073 2e73 7465 7020 3d3d      if s.step ==
-0002d9b0: 204e 6f6e 6520 6f72 2073 2e73 7465 7020   None or s.step 
-0002d9c0: 3d3d 2031 3a0a 2020 2020 2020 2020 7374  == 1:.        st
-0002d9d0: 6172 7420 3d20 3020 6966 2073 2e73 7461  art = 0 if s.sta
-0002d9e0: 7274 2069 7320 4e6f 6e65 2065 6c73 6520  rt is None else 
-0002d9f0: 732e 7374 6172 7420 6966 2073 2e73 7461  s.start if s.sta
-0002da00: 7274 203e 3d20 3020 656c 7365 2073 2e73  rt >= 0 else s.s
-0002da10: 7461 7274 202b 206e 0a20 2020 2020 2020  tart + n.       
-0002da20: 2073 746f 7020 3d20 6e20 6966 2073 2e73   stop = n if s.s
-0002da30: 746f 7020 6973 204e 6f6e 6520 656c 7365  top is None else
-0002da40: 2073 2e73 746f 7020 6966 2073 2e73 746f   s.stop if s.sto
-0002da50: 7020 3e3d 2030 2065 6c73 6520 732e 7374  p >= 0 else s.st
-0002da60: 6f70 202b 206e 0a20 2020 2020 2020 2069  op + n.        i
-0002da70: 6620 7374 6172 7420 3d3d 2030 2061 6e64  f start == 0 and
-0002da80: 2073 746f 7020 3d3d 206e 3a0a 2020 2020   stop == n:.    
-0002da90: 2020 2020 2020 2020 7265 7475 726e 2061          return a
-0002daa0: 7267 0a20 2020 2020 2020 2069 6e64 6578  rg.        index
-0002dab0: 203d 2052 616e 6765 2861 7361 7272 6179   = Range(asarray
-0002dac0: 2873 746f 702d 7374 6172 7429 2920 2b20  (stop-start)) + 
-0002dad0: 7374 6172 740a 2020 2020 656c 6966 206e  start.    elif n
-0002dae0: 2e69 7363 6f6e 7374 616e 743a 0a20 2020  .isconstant:.   
-0002daf0: 2020 2020 2069 6e64 6578 203d 2063 6f6e       index = con
-0002db00: 7374 616e 7428 6e75 6d70 792e 6172 616e  stant(numpy.aran
-0002db10: 6765 282a 732e 696e 6469 6365 7328 6172  ge(*s.indices(ar
-0002db20: 672e 7368 6170 655b 6178 6973 5d29 2929  g.shape[axis])))
-0002db30: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0002db40: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-0002db50: 6f6e 2827 6120 6e6f 6e2d 756e 6974 2073  on('a non-unit s
-0002db60: 6c69 6365 2072 6571 7569 7265 7320 6120  lice requires a 
-0002db70: 636f 6e73 7461 6e74 2d6c 656e 6774 6820  constant-length 
-0002db80: 6178 6973 2729 0a20 2020 2072 6574 7572  axis').    retur
-0002db90: 6e20 7461 6b65 2861 7267 2c20 696e 6465  n take(arg, inde
-0002dba0: 782c 2061 7869 7329 0a0a 0a64 6566 2074  x, axis)...def t
-0002dbb0: 616b 6528 6172 673a 2041 7272 6179 2c20  ake(arg: Array, 
-0002dbc0: 696e 6465 783a 2041 7272 6179 2c20 6178  index: Array, ax
-0002dbd0: 6973 3a20 696e 7429 3a0a 2020 2020 6173  is: int):.    as
-0002dbe0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-0002dbf0: 6172 672c 2041 7272 6179 292c 2066 2761  arg, Array), f'a
-0002dc00: 7267 3d7b 6172 6721 727d 270a 2020 2020  rg={arg!r}'.    
-0002dc10: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-0002dc20: 6528 696e 6465 782c 2041 7272 6179 2920  e(index, Array) 
-0002dc30: 616e 6420 696e 6465 782e 6474 7970 6520  and index.dtype 
-0002dc40: 696e 2028 626f 6f6c 2c20 696e 7429 2061  in (bool, int) a
-0002dc50: 6e64 2069 6e64 6578 2e6e 6469 6d20 3d3d  nd index.ndim ==
-0002dc60: 2031 2c20 6627 696e 6465 783d 7b69 6e64   1, f'index={ind
-0002dc70: 6578 2172 7d27 0a20 2020 2061 7373 6572  ex!r}'.    asser
-0002dc80: 7420 6973 696e 7374 616e 6365 2861 7869  t isinstance(axi
-0002dc90: 732c 2069 6e74 292c 2066 2761 7869 733d  s, int), f'axis=
-0002dca0: 7b61 7869 7321 727d 270a 2020 2020 6c65  {axis!r}'.    le
-0002dcb0: 6e67 7468 203d 2061 7267 2e73 6861 7065  ngth = arg.shape
-0002dcc0: 5b61 7869 735d 0a20 2020 2069 6620 696e  [axis].    if in
-0002dcd0: 6465 782e 6474 7970 6520 3d3d 2062 6f6f  dex.dtype == boo
-0002dce0: 6c3a 0a20 2020 2020 2020 2061 7373 6572  l:.        asser
-0002dcf0: 7420 5f65 7175 616c 735f 7369 6d70 6c69  t _equals_simpli
-0002dd00: 6669 6564 2869 6e64 6578 2e73 6861 7065  fied(index.shape
-0002dd10: 5b30 5d2c 206c 656e 6774 6829 0a20 2020  [0], length).   
-0002dd20: 2020 2020 2069 6e64 6578 203d 2046 696e       index = Fin
-0002dd30: 6428 696e 6465 7829 0a20 2020 2065 6c69  d(index).    eli
-0002dd40: 6620 696e 6465 782e 6973 636f 6e73 7461  f index.isconsta
-0002dd50: 6e74 3a0a 2020 2020 2020 2020 696e 6465  nt:.        inde
-0002dd60: 785f 203d 2069 6e64 6578 2e65 7661 6c28  x_ = index.eval(
-0002dd70: 290a 2020 2020 2020 2020 696e 6567 203d  ).        ineg =
-0002dd80: 206e 756d 7079 2e6c 6573 7328 696e 6465   numpy.less(inde
-0002dd90: 785f 2c20 3029 0a20 2020 2020 2020 2069  x_, 0).        i
-0002dda0: 6620 6e6f 7420 6c65 6e67 7468 2e69 7363  f not length.isc
-0002ddb0: 6f6e 7374 616e 743a 0a20 2020 2020 2020  onstant:.       
-0002ddc0: 2020 2020 2069 6620 696e 6567 2e61 6e79       if ineg.any
-0002ddd0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0002dde0: 2020 2020 7261 6973 6520 496e 6465 7845      raise IndexE
-0002ddf0: 7272 6f72 2827 6e65 6761 7469 7665 2069  rror('negative i
-0002de00: 6e64 6963 6573 206f 6e6c 7920 616c 6c6f  ndices only allo
-0002de10: 7765 6420 666f 7220 636f 6e73 7461 6e74  wed for constant
-0002de20: 2d6c 656e 6774 6820 6178 6573 2729 0a20  -length axes'). 
-0002de30: 2020 2020 2020 2065 6c69 6620 696e 6567         elif ineg
-0002de40: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
-0002de50: 2020 2020 6966 206e 756d 7079 2e6c 6573      if numpy.les
-0002de60: 7328 696e 6465 785f 2c20 2d69 6e74 286c  s(index_, -int(l
-0002de70: 656e 6774 6829 292e 616e 7928 293a 0a20  ength)).any():. 
-0002de80: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002de90: 6169 7365 2049 6e64 6578 4572 726f 7228  aise IndexError(
-0002dea0: 2769 6e64 6963 6573 206f 7574 206f 6620  'indices out of 
-0002deb0: 626f 756e 6473 3a20 7b7d 203c 207b 7d27  bounds: {} < {}'
-0002dec0: 2e66 6f72 6d61 7428 696e 6465 785f 2c20  .format(index_, 
-0002ded0: 2d69 6e74 286c 656e 6774 6829 2929 0a20  -int(length))). 
-0002dee0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002def0: 6e20 5f74 616b 6528 6172 672c 2063 6f6e  n _take(arg, con
-0002df00: 7374 616e 7428 696e 6465 785f 202b 2069  stant(index_ + i
-0002df10: 6e65 6720 2a20 696e 7428 6c65 6e67 7468  neg * int(length
-0002df20: 2929 2c20 6178 6973 290a 2020 2020 2020  )), axis).      
-0002df30: 2020 656c 6966 206e 756d 7079 2e67 7265    elif numpy.gre
-0002df40: 6174 6572 5f65 7175 616c 2869 6e64 6578  ater_equal(index
-0002df50: 5f2c 2069 6e74 286c 656e 6774 6829 292e  _, int(length)).
-0002df60: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
-0002df70: 2020 2072 6169 7365 2049 6e64 6578 4572     raise IndexEr
-0002df80: 726f 7228 2769 6e64 6963 6573 206f 7574  ror('indices out
-0002df90: 206f 6620 626f 756e 6473 3a20 7b7d 203e   of bounds: {} >
-0002dfa0: 3d20 7b7d 272e 666f 726d 6174 2869 6e64  = {}'.format(ind
-0002dfb0: 6578 5f2c 2069 6e74 286c 656e 6774 6829  ex_, int(length)
-0002dfc0: 2929 0a20 2020 2020 2020 2065 6c69 6620  )).        elif 
-0002dfd0: 6e75 6d70 792e 6772 6561 7465 7228 6e75  numpy.greater(nu
-0002dfe0: 6d70 792e 6469 6666 2869 6e64 6578 5f29  mpy.diff(index_)
-0002dff0: 2c20 3029 2e61 6c6c 2829 3a0a 2020 2020  , 0).all():.    
-0002e000: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-0002e010: 6173 6b28 6172 672c 206e 756d 6572 6963  ask(arg, numeric
-0002e020: 2e61 7362 6f6f 6c65 616e 2869 6e64 6578  .asboolean(index
-0002e030: 5f2c 2069 6e74 286c 656e 6774 6829 292c  _, int(length)),
-0002e040: 2061 7869 7329 0a20 2020 2072 6574 7572   axis).    retur
-0002e050: 6e20 5f74 616b 6528 6172 672c 2069 6e64  n _take(arg, ind
-0002e060: 6578 2c20 6178 6973 290a 0a0a 6465 6620  ex, axis)...def 
-0002e070: 5f74 616b 6528 6172 673a 2041 7272 6179  _take(arg: Array
-0002e080: 2c20 696e 6465 783a 2041 7272 6179 2c20  , index: Array, 
-0002e090: 6178 6973 3a20 696e 7429 3a0a 2020 2020  axis: int):.    
-0002e0a0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-0002e0b0: 6528 6172 672c 2041 7272 6179 292c 2066  e(arg, Array), f
-0002e0c0: 2761 7267 3d7b 6172 6721 727d 270a 2020  'arg={arg!r}'.  
-0002e0d0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-0002e0e0: 6e63 6528 696e 6465 782c 2041 7272 6179  nce(index, Array
-0002e0f0: 2920 616e 6420 696e 6465 782e 6474 7970  ) and index.dtyp
-0002e100: 6520 3d3d 2069 6e74 2c20 6627 696e 6465  e == int, f'inde
-0002e110: 783d 7b69 6e64 6578 2172 7d27 0a20 2020  x={index!r}'.   
-0002e120: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-0002e130: 6365 2861 7869 732c 2069 6e74 292c 2066  ce(axis, int), f
-0002e140: 2761 7869 733d 7b61 7869 7321 727d 270a  'axis={axis!r}'.
-0002e150: 2020 2020 6178 6973 203d 206e 756d 6572      axis = numer
-0002e160: 6963 2e6e 6f72 6d64 696d 2861 7267 2e6e  ic.normdim(arg.n
-0002e170: 6469 6d2c 2061 7869 7329 0a20 2020 2072  dim, axis).    r
-0002e180: 6574 7572 6e20 5472 616e 7370 6f73 652e  eturn Transpose.
-0002e190: 6672 6f6d 5f65 6e64 2854 616b 6528 5472  from_end(Take(Tr
-0002e1a0: 616e 7370 6f73 652e 746f 5f65 6e64 2861  anspose.to_end(a
-0002e1b0: 7267 2c20 6178 6973 292c 2069 6e64 6578  rg, axis), index
-0002e1c0: 292c 202a 7261 6e67 6528 6178 6973 2c20  ), *range(axis, 
-0002e1d0: 6178 6973 2b69 6e64 6578 2e6e 6469 6d29  axis+index.ndim)
-0002e1e0: 290a 0a0a 6465 6620 5f69 6e66 6c61 7465  )...def _inflate
-0002e1f0: 2861 7267 3a20 4172 7261 792c 2064 6f66  (arg: Array, dof
-0002e200: 6d61 703a 2041 7272 6179 2c20 6c65 6e67  map: Array, leng
-0002e210: 7468 3a20 4172 7261 792c 2061 7869 733a  th: Array, axis:
-0002e220: 2069 6e74 293a 0a20 2020 2061 7373 6572   int):.    asser
-0002e230: 7420 6973 696e 7374 616e 6365 2861 7267  t isinstance(arg
-0002e240: 2c20 4172 7261 7929 2c20 6627 6172 673d  , Array), f'arg=
-0002e250: 7b61 7267 2172 7d27 0a20 2020 2061 7373  {arg!r}'.    ass
-0002e260: 6572 7420 6973 696e 7374 616e 6365 2864  ert isinstance(d
-0002e270: 6f66 6d61 702c 2041 7272 6179 2920 616e  ofmap, Array) an
-0002e280: 6420 646f 666d 6170 2e64 7479 7065 203d  d dofmap.dtype =
-0002e290: 3d20 696e 742c 2066 2764 6f66 6d61 703d  = int, f'dofmap=
-0002e2a0: 7b64 6f66 6d61 7021 727d 270a 2020 2020  {dofmap!r}'.    
-0002e2b0: 6173 7365 7274 205f 6973 696e 6465 7828  assert _isindex(
-0002e2c0: 6c65 6e67 7468 292c 2066 276c 656e 6774  length), f'lengt
-0002e2d0: 683d 7b6c 656e 6774 6821 727d 270a 2020  h={length!r}'.  
-0002e2e0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-0002e2f0: 6e63 6528 6178 6973 2c20 696e 7429 2c20  nce(axis, int), 
-0002e300: 6627 6178 6973 3d7b 6178 6973 2172 7d27  f'axis={axis!r}'
-0002e310: 0a20 2020 2061 7869 7320 3d20 6e75 6d65  .    axis = nume
-0002e320: 7269 632e 6e6f 726d 6469 6d28 6172 672e  ric.normdim(arg.
-0002e330: 6e64 696d 2b31 2d64 6f66 6d61 702e 6e64  ndim+1-dofmap.nd
-0002e340: 696d 2c20 6178 6973 290a 2020 2020 6173  im, axis).    as
-0002e350: 7365 7274 2065 7175 616c 7368 6170 6528  sert equalshape(
-0002e360: 646f 666d 6170 2e73 6861 7065 2c20 6172  dofmap.shape, ar
-0002e370: 672e 7368 6170 655b 6178 6973 3a61 7869  g.shape[axis:axi
-0002e380: 732b 646f 666d 6170 2e6e 6469 6d5d 290a  s+dofmap.ndim]).
-0002e390: 2020 2020 7265 7475 726e 2054 7261 6e73      return Trans
-0002e3a0: 706f 7365 2e66 726f 6d5f 656e 6428 496e  pose.from_end(In
-0002e3b0: 666c 6174 6528 5472 616e 7370 6f73 652e  flate(Transpose.
-0002e3c0: 746f 5f65 6e64 2861 7267 2c20 2a72 616e  to_end(arg, *ran
-0002e3d0: 6765 2861 7869 732c 2061 7869 732b 646f  ge(axis, axis+do
-0002e3e0: 666d 6170 2e6e 6469 6d29 292c 2064 6f66  fmap.ndim)), dof
-0002e3f0: 6d61 702c 206c 656e 6774 6829 2c20 6178  map, length), ax
-0002e400: 6973 290a 0a0a 6465 6620 6d61 736b 2861  is)...def mask(a
-0002e410: 7267 2c20 6d61 736b 3a20 4172 7261 792c  rg, mask: Array,
-0002e420: 2061 7869 733a 2069 6e74 203d 2030 293a   axis: int = 0):
-0002e430: 0a20 2020 2061 7373 6572 7420 6973 696e  .    assert isin
-0002e440: 7374 616e 6365 2861 7267 2c20 4172 7261  stance(arg, Arra
-0002e450: 7929 2c20 6627 6172 673d 7b61 7267 2172  y), f'arg={arg!r
-0002e460: 7d27 0a20 2020 2061 7373 6572 7420 6973  }'.    assert is
-0002e470: 696e 7374 616e 6365 286d 6173 6b2c 206e  instance(mask, n
-0002e480: 756d 7079 2e6e 6461 7272 6179 2920 616e  umpy.ndarray) an
-0002e490: 6420 6d61 736b 2e64 7479 7065 203d 3d20  d mask.dtype == 
-0002e4a0: 626f 6f6c 2061 6e64 206d 6173 6b2e 6e64  bool and mask.nd
-0002e4b0: 696d 203d 3d20 3120 616e 6420 5f65 7175  im == 1 and _equ
-0002e4c0: 616c 735f 7363 616c 6172 5f63 6f6e 7374  als_scalar_const
-0002e4d0: 616e 7428 6172 672e 7368 6170 655b 6178  ant(arg.shape[ax
-0002e4e0: 6973 5d2c 206c 656e 286d 6173 6b29 292c  is], len(mask)),
-0002e4f0: 2066 276d 6173 6b3d 7b6d 6173 6b21 727d   f'mask={mask!r}
-0002e500: 270a 2020 2020 696e 6465 782c 203d 206d  '.    index, = m
-0002e510: 6173 6b2e 6e6f 6e7a 6572 6f28 290a 2020  ask.nonzero().  
-0002e520: 2020 7265 7475 726e 205f 7461 6b65 2861    return _take(a
-0002e530: 7267 2c20 636f 6e73 7461 6e74 2869 6e64  rg, constant(ind
-0002e540: 6578 292c 2061 7869 7329 0a0a 0a64 6566  ex), axis)...def
-0002e550: 2075 6e72 6176 656c 2866 756e 632c 2061   unravel(func, a
-0002e560: 7869 732c 2073 6861 7065 293a 0a20 2020  xis, shape):.   
-0002e570: 2066 756e 6320 3d20 6173 6172 7261 7928   func = asarray(
-0002e580: 6675 6e63 290a 2020 2020 6178 6973 203d  func).    axis =
-0002e590: 206e 756d 6572 6963 2e6e 6f72 6d64 696d   numeric.normdim
-0002e5a0: 2866 756e 632e 6e64 696d 2c20 6178 6973  (func.ndim, axis
-0002e5b0: 290a 2020 2020 6173 7365 7274 206c 656e  ).    assert len
-0002e5c0: 2873 6861 7065 2920 3d3d 2032 0a20 2020  (shape) == 2.   
-0002e5d0: 2072 6574 7572 6e20 5472 616e 7370 6f73   return Transpos
-0002e5e0: 652e 6672 6f6d 5f65 6e64 2855 6e72 6176  e.from_end(Unrav
-0002e5f0: 656c 2854 7261 6e73 706f 7365 2e74 6f5f  el(Transpose.to_
-0002e600: 656e 6428 6675 6e63 2c20 6178 6973 292c  end(func, axis),
-0002e610: 202a 7368 6170 6529 2c20 6178 6973 2c20   *shape), axis, 
-0002e620: 6178 6973 2b31 290a 0a0a 6465 6620 7261  axis+1)...def ra
-0002e630: 7665 6c28 6675 6e63 2c20 6178 6973 293a  vel(func, axis):
-0002e640: 0a20 2020 2066 756e 6320 3d20 6173 6172  .    func = asar
-0002e650: 7261 7928 6675 6e63 290a 2020 2020 6178  ray(func).    ax
-0002e660: 6973 203d 206e 756d 6572 6963 2e6e 6f72  is = numeric.nor
-0002e670: 6d64 696d 2866 756e 632e 6e64 696d 2d31  mdim(func.ndim-1
-0002e680: 2c20 6178 6973 290a 2020 2020 7265 7475  , axis).    retu
-0002e690: 726e 2054 7261 6e73 706f 7365 2e66 726f  rn Transpose.fro
-0002e6a0: 6d5f 656e 6428 5261 7665 6c28 5472 616e  m_end(Ravel(Tran
-0002e6b0: 7370 6f73 652e 746f 5f65 6e64 2866 756e  spose.to_end(fun
-0002e6c0: 632c 2061 7869 732c 2061 7869 732b 3129  c, axis, axis+1)
-0002e6d0: 292c 2061 7869 7329 0a0a 0a64 6566 205f  ), axis)...def _
-0002e6e0: 666c 6174 2866 756e 6329 3a0a 2020 2020  flat(func):.    
-0002e6f0: 6675 6e63 203d 2061 7361 7272 6179 2866  func = asarray(f
-0002e700: 756e 6329 0a20 2020 2069 6620 6675 6e63  unc).    if func
-0002e710: 2e6e 6469 6d20 3d3d 2030 3a0a 2020 2020  .ndim == 0:.    
-0002e720: 2020 2020 7265 7475 726e 2049 6e73 6572      return Inser
-0002e730: 7441 7869 7328 6675 6e63 2c20 636f 6e73  tAxis(func, cons
-0002e740: 7461 6e74 2831 2929 0a20 2020 2077 6869  tant(1)).    whi
-0002e750: 6c65 2066 756e 632e 6e64 696d 203e 2031  le func.ndim > 1
-0002e760: 3a0a 2020 2020 2020 2020 6675 6e63 203d  :.        func =
-0002e770: 2052 6176 656c 2866 756e 6329 0a20 2020   Ravel(func).   
-0002e780: 2072 6574 7572 6e20 6675 6e63 0a0a 0a64   return func...d
-0002e790: 6566 2070 7265 7065 6e64 6178 6573 2866  ef prependaxes(f
-0002e7a0: 756e 632c 2073 6861 7065 293a 0a20 2020  unc, shape):.   
-0002e7b0: 2027 5072 6570 656e 6420 6178 6573 2077   'Prepend axes w
-0002e7c0: 6974 6820 7370 6563 6966 6965 6420 6073  ith specified `s
-0002e7d0: 6861 7065 6020 746f 2060 6675 6e63 602e  hape` to `func`.
-0002e7e0: 270a 0a20 2020 2066 756e 6320 3d20 6173  '..    func = as
-0002e7f0: 6172 7261 7928 6675 6e63 290a 2020 2020  array(func).    
-0002e800: 666f 7220 692c 206e 2069 6e20 656e 756d  for i, n in enum
-0002e810: 6572 6174 6528 7368 6170 6529 3a0a 2020  erate(shape):.  
-0002e820: 2020 2020 2020 6675 6e63 203d 2069 6e73        func = ins
-0002e830: 6572 7461 7869 7328 6675 6e63 2c20 692c  ertaxis(func, i,
-0002e840: 206e 290a 2020 2020 7265 7475 726e 2066   n).    return f
-0002e850: 756e 630a 0a0a 6465 6620 6170 7065 6e64  unc...def append
-0002e860: 6178 6573 2866 756e 632c 2073 6861 7065  axes(func, shape
-0002e870: 293a 0a20 2020 2027 4170 7065 6e64 2061  ):.    'Append a
-0002e880: 7865 7320 7769 7468 2073 7065 6369 6669  xes with specifi
-0002e890: 6564 2060 7368 6170 6560 2074 6f20 6066  ed `shape` to `f
-0002e8a0: 756e 6360 2e27 0a0a 2020 2020 6675 6e63  unc`.'..    func
-0002e8b0: 203d 2061 7361 7272 6179 2866 756e 6329   = asarray(func)
-0002e8c0: 0a20 2020 2066 6f72 206e 2069 6e20 7368  .    for n in sh
-0002e8d0: 6170 653a 0a20 2020 2020 2020 2066 756e  ape:.        fun
-0002e8e0: 6320 3d20 496e 7365 7274 4178 6973 2866  c = InsertAxis(f
-0002e8f0: 756e 632c 206e 290a 2020 2020 7265 7475  unc, n).    retu
-0002e900: 726e 2066 756e 630a 0a0a 6465 6620 6c6f  rn func...def lo
-0002e910: 6f70 5f69 6e64 6578 286e 616d 652c 206c  op_index(name, l
-0002e920: 656e 6774 6829 3a0a 2020 2020 7265 7475  ength):.    retu
-0002e930: 726e 205f 4c6f 6f70 496e 6465 7828 6e61  rn _LoopIndex(na
-0002e940: 6d65 2c20 6173 6172 7261 7928 6c65 6e67  me, asarray(leng
-0002e950: 7468 2929 0a0a 0a64 6566 206c 6f6f 705f  th))...def loop_
-0002e960: 7375 6d28 6675 6e63 2c20 696e 6465 7829  sum(func, index)
-0002e970: 3a0a 2020 2020 6675 6e63 203d 2061 7361  :.    func = asa
-0002e980: 7272 6179 2866 756e 6329 0a20 2020 2069  rray(func).    i
-0002e990: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-0002e9a0: 2869 6e64 6578 2c20 5f4c 6f6f 7049 6e64  (index, _LoopInd
-0002e9b0: 6578 293a 0a20 2020 2020 2020 2072 6169  ex):.        rai
-0002e9c0: 7365 2054 7970 6545 7272 6f72 2866 2765  se TypeError(f'e
-0002e9d0: 7870 6563 7465 6420 5f4c 6f6f 7049 6e64  xpected _LoopInd
-0002e9e0: 6578 2c20 676f 7420 7b69 6e64 6578 2172  ex, got {index!r
-0002e9f0: 7d27 290a 2020 2020 7265 7475 726e 204c  }').    return L
-0002ea00: 6f6f 7053 756d 2866 756e 632c 2066 756e  oopSum(func, fun
-0002ea10: 632e 7368 6170 652c 2069 6e64 6578 2e5f  c.shape, index._
-0002ea20: 6e61 6d65 2c20 696e 6465 782e 6c65 6e67  name, index.leng
-0002ea30: 7468 290a 0a0a 6465 6620 5f6c 6f6f 705f  th)...def _loop_
-0002ea40: 636f 6e63 6174 656e 6174 655f 6461 7461  concatenate_data
-0002ea50: 2866 756e 632c 2069 6e64 6578 293a 0a20  (func, index):. 
-0002ea60: 2020 2066 756e 6320 3d20 6173 6172 7261     func = asarra
-0002ea70: 7928 6675 6e63 290a 2020 2020 6966 206e  y(func).    if n
-0002ea80: 6f74 2069 7369 6e73 7461 6e63 6528 696e  ot isinstance(in
-0002ea90: 6465 782c 205f 4c6f 6f70 496e 6465 7829  dex, _LoopIndex)
-0002eaa0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-0002eab0: 5479 7065 4572 726f 7228 6627 6578 7065  TypeError(f'expe
-0002eac0: 6374 6564 205f 4c6f 6f70 496e 6465 782c  cted _LoopIndex,
-0002ead0: 2067 6f74 207b 696e 6465 7821 727d 2729   got {index!r}')
-0002eae0: 0a20 2020 2063 6875 6e6b 5f73 697a 6520  .    chunk_size 
-0002eaf0: 3d20 6675 6e63 2e73 6861 7065 5b2d 315d  = func.shape[-1]
-0002eb00: 0a20 2020 2069 6620 6368 756e 6b5f 7369  .    if chunk_si
-0002eb10: 7a65 2e69 7363 6f6e 7374 616e 743a 0a20  ze.isconstant:. 
-0002eb20: 2020 2020 2020 2063 6875 6e6b 5f73 697a         chunk_siz
-0002eb30: 6573 203d 2049 6e73 6572 7441 7869 7328  es = InsertAxis(
-0002eb40: 6368 756e 6b5f 7369 7a65 2c20 696e 6465  chunk_size, inde
-0002eb50: 782e 6c65 6e67 7468 290a 2020 2020 656c  x.length).    el
-0002eb60: 7365 3a0a 2020 2020 2020 2020 6368 756e  se:.        chun
-0002eb70: 6b5f 7369 7a65 7320 3d20 6c6f 6f70 5f63  k_sizes = loop_c
-0002eb80: 6f6e 6361 7465 6e61 7465 2849 6e73 6572  oncatenate(Inser
-0002eb90: 7441 7869 7328 6675 6e63 2e73 6861 7065  tAxis(func.shape
-0002eba0: 5b2d 315d 2c20 636f 6e73 7461 6e74 2831  [-1], constant(1
-0002ebb0: 2929 2c20 696e 6465 7829 0a20 2020 206f  )), index).    o
-0002ebc0: 6666 7365 7473 203d 205f 5369 7a65 7354  ffsets = _SizesT
-0002ebd0: 6f4f 6666 7365 7473 2863 6875 6e6b 5f73  oOffsets(chunk_s
-0002ebe0: 697a 6573 290a 2020 2020 7374 6172 7420  izes).    start 
-0002ebf0: 3d20 5461 6b65 286f 6666 7365 7473 2c20  = Take(offsets, 
-0002ec00: 696e 6465 7829 0a20 2020 2073 746f 7020  index).    stop 
-0002ec10: 3d20 5461 6b65 286f 6666 7365 7473 2c20  = Take(offsets, 
-0002ec20: 696e 6465 782b 3129 0a20 2020 2072 6574  index+1).    ret
-0002ec30: 7572 6e20 2866 756e 632c 2073 7461 7274  urn (func, start
-0002ec40: 2c20 7374 6f70 2c20 2a66 756e 632e 7368  , stop, *func.sh
-0002ec50: 6170 655b 3a2d 315d 2c20 5461 6b65 286f  ape[:-1], Take(o
-0002ec60: 6666 7365 7473 2c20 696e 6465 782e 6c65  ffsets, index.le
-0002ec70: 6e67 7468 2929 0a0a 0a64 6566 206c 6f6f  ngth))...def loo
-0002ec80: 705f 636f 6e63 6174 656e 6174 6528 6675  p_concatenate(fu
-0002ec90: 6e63 2c20 696e 6465 7829 3a0a 2020 2020  nc, index):.    
-0002eca0: 6675 6e63 6461 7461 203d 205f 6c6f 6f70  funcdata = _loop
-0002ecb0: 5f63 6f6e 6361 7465 6e61 7465 5f64 6174  _concatenate_dat
-0002ecc0: 6128 6675 6e63 2c20 696e 6465 7829 0a20  a(func, index). 
-0002ecd0: 2020 2072 6574 7572 6e20 4c6f 6f70 436f     return LoopCo
-0002ece0: 6e63 6174 656e 6174 6528 6675 6e63 6461  ncatenate(funcda
-0002ecf0: 7461 2c20 696e 6465 782e 5f6e 616d 652c  ta, index._name,
-0002ed00: 2069 6e64 6578 2e6c 656e 6774 6829 0a0a   index.length)..
-0002ed10: 0a64 6566 206c 6f6f 705f 636f 6e63 6174  .def loop_concat
-0002ed20: 656e 6174 655f 636f 6d62 696e 6564 2866  enate_combined(f
-0002ed30: 756e 6373 2c20 696e 6465 7829 3a0a 2020  uncs, index):.  
-0002ed40: 2020 756e 6971 7565 5f66 756e 6373 203d    unique_funcs =
-0002ed50: 205b 5d0a 2020 2020 756e 6971 7565 5f66   [].    unique_f
-0002ed60: 756e 6373 2e65 7874 656e 6428 6675 6e63  uncs.extend(func
-0002ed70: 2066 6f72 2066 756e 6320 696e 2066 756e   for func in fun
-0002ed80: 6373 2069 6620 6675 6e63 206e 6f74 2069  cs if func not i
-0002ed90: 6e20 756e 6971 7565 5f66 756e 6373 290a  n unique_funcs).
-0002eda0: 2020 2020 756e 6971 7565 5f66 756e 635f      unique_func_
-0002edb0: 6461 7461 203d 2074 7570 6c65 285f 6c6f  data = tuple(_lo
-0002edc0: 6f70 5f63 6f6e 6361 7465 6e61 7465 5f64  op_concatenate_d
-0002edd0: 6174 6128 6675 6e63 2c20 696e 6465 7829  ata(func, index)
-0002ede0: 2066 6f72 2066 756e 6320 696e 2075 6e69   for func in uni
-0002edf0: 7175 655f 6675 6e63 7329 0a20 2020 206c  que_funcs).    l
-0002ee00: 6f6f 7020 3d20 4c6f 6f70 436f 6e63 6174  oop = LoopConcat
-0002ee10: 656e 6174 6543 6f6d 6269 6e65 6428 756e  enateCombined(un
-0002ee20: 6971 7565 5f66 756e 635f 6461 7461 2c20  ique_func_data, 
-0002ee30: 696e 6465 782e 5f6e 616d 652c 2069 6e64  index._name, ind
-0002ee40: 6578 2e6c 656e 6774 6829 0a20 2020 2072  ex.length).    r
-0002ee50: 6574 7572 6e20 7475 706c 6528 4172 7261  eturn tuple(Arra
-0002ee60: 7946 726f 6d54 7570 6c65 286c 6f6f 702c  yFromTuple(loop,
-0002ee70: 2075 6e69 7175 655f 6675 6e63 732e 696e   unique_funcs.in
-0002ee80: 6465 7828 6675 6e63 292c 2074 7570 6c65  dex(func), tuple
-0002ee90: 2873 6861 7065 292c 2066 756e 632e 6474  (shape), func.dt
-0002eea0: 7970 6529 2066 6f72 2066 756e 632c 2073  ype) for func, s
-0002eeb0: 7461 7274 2c20 7374 6f70 2c20 2a73 6861  tart, stop, *sha
-0002eec0: 7065 2069 6e20 756e 6971 7565 5f66 756e  pe in unique_fun
-0002eed0: 635f 6461 7461 290a 0a0a 4072 6570 6c61  c_data)...@repla
-0002eee0: 6365 0a64 6566 2072 6570 6c61 6365 5f61  ce.def replace_a
-0002eef0: 7267 756d 656e 7473 2876 616c 7565 2c20  rguments(value, 
-0002ef00: 6172 6775 6d65 6e74 7329 3a0a 2020 2020  arguments):.    
-0002ef10: 2727 2752 6570 6c61 6365 203a 636c 6173  '''Replace :clas
-0002ef20: 733a 6041 7267 756d 656e 7460 206f 626a  s:`Argument` obj
-0002ef30: 6563 7473 2069 6e20 6060 7661 6c75 6560  ects in ``value`
-0002ef40: 602e 0a0a 2020 2020 5265 706c 6163 6520  `...    Replace 
-0002ef50: 3a63 6c61 7373 3a60 4172 6775 6d65 6e74  :class:`Argument
-0002ef60: 6020 6f62 6a65 6374 7320 696e 2060 6076  ` objects in ``v
-0002ef70: 616c 7565 6060 2061 6363 6f72 6469 6e67  alue`` according
-0002ef80: 2074 6f20 7468 6520 6060 6172 6775 6d65   to the ``argume
-0002ef90: 6e74 7360 600a 2020 2020 6d61 702c 2074  nts``.    map, t
-0002efa0: 616b 696e 6720 696e 746f 2061 6363 6f75  aking into accou
-0002efb0: 6e74 2064 6572 6976 6174 6976 6573 2074  nt derivatives t
-0002efc0: 6f20 7468 6520 6c6f 6361 6c20 636f 6f72  o the local coor
-0002efd0: 6469 6e61 7465 732e 0a0a 2020 2020 4172  dinates...    Ar
-0002efe0: 6773 0a20 2020 202d 2d2d 2d0a 2020 2020  gs.    ----.    
-0002eff0: 7661 6c75 6520 3a20 3a63 6c61 7373 3a60  value : :class:`
-0002f000: 4172 7261 7960 0a20 2020 2020 2020 2041  Array`.        A
-0002f010: 7272 6179 2074 6f20 6265 2065 6469 7465  rray to be edite
-0002f020: 642e 0a20 2020 2061 7267 756d 656e 7473  d..    arguments
-0002f030: 203a 203a 636c 6173 733a 6063 6f6c 6c65   : :class:`colle
-0002f040: 6374 696f 6e73 2e61 6263 2e4d 6170 7069  ctions.abc.Mappi
-0002f050: 6e67 6020 7769 7468 203a 636c 6173 733a  ng` with :class:
-0002f060: 6041 7272 6179 605c 5c73 2061 7320 7661  `Array`\\s as va
-0002f070: 6c75 6573 0a20 2020 2020 2020 203a 636c  lues.        :cl
-0002f080: 6173 733a 6041 7267 756d 656e 7460 5c5c  ass:`Argument`\\
-0002f090: 7320 7265 706c 6163 656d 656e 7473 2e20  s replacements. 
-0002f0a0: 2054 6865 206b 6579 2063 6f72 7265 7370   The key corresp
-0002f0b0: 6f6e 6420 746f 2074 6865 2060 606e 616d  ond to the ``nam
-0002f0c0: 6560 600a 2020 2020 2020 2020 7061 7373  e``.        pass
-0002f0d0: 6564 2074 6f20 616e 203a 636c 6173 733a  ed to an :class:
-0002f0e0: 6041 7267 756d 656e 7460 2061 6e64 2074  `Argument` and t
-0002f0f0: 6865 2076 616c 7565 2069 7320 7468 6520  he value is the 
-0002f100: 7265 706c 6163 656d 656e 742e 0a0a 2020  replacement...  
-0002f110: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
-0002f120: 2d2d 2d2d 2d0a 2020 2020 3a63 6c61 7373  -----.    :class
-0002f130: 3a60 4172 7261 7960 0a20 2020 2020 2020  :`Array`.       
-0002f140: 2054 6865 2065 6469 7465 6420 6060 7661   The edited ``va
-0002f150: 6c75 6560 602e 0a20 2020 2027 2727 0a20  lue``..    '''. 
-0002f160: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0002f170: 2876 616c 7565 2c20 4172 6775 6d65 6e74  (value, Argument
-0002f180: 2920 616e 6420 7661 6c75 652e 5f6e 616d  ) and value._nam
-0002f190: 6520 696e 2061 7267 756d 656e 7473 3a0a  e in arguments:.
-0002f1a0: 2020 2020 2020 2020 7620 3d20 6173 6172          v = asar
-0002f1b0: 7261 7928 6172 6775 6d65 6e74 735b 7661  ray(arguments[va
-0002f1c0: 6c75 652e 5f6e 616d 655d 290a 2020 2020  lue._name]).    
-0002f1d0: 2020 2020 6173 7365 7274 2065 7175 616c      assert equal
-0002f1e0: 7368 6170 6528 7661 6c75 652e 7368 6170  shape(value.shap
-0002f1f0: 652c 2076 2e73 6861 7065 292c 2028 7661  e, v.shape), (va
-0002f200: 6c75 652e 7368 6170 652c 2076 2e73 6861  lue.shape, v.sha
-0002f210: 7065 290a 2020 2020 2020 2020 6173 7365  pe).        asse
-0002f220: 7274 2076 616c 7565 2e64 7479 7065 203d  rt value.dtype =
-0002f230: 3d20 762e 6474 7970 652c 2028 7661 6c75  = v.dtype, (valu
-0002f240: 652e 6474 7970 652c 2076 2e64 7479 7065  e.dtype, v.dtype
-0002f250: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0002f260: 2076 0a0a 0a64 6566 2065 696e 7375 6d28   v...def einsum(
-0002f270: 666d 742c 202a 6172 6773 2c20 2a2a 6469  fmt, *args, **di
-0002f280: 6d73 293a 0a20 2020 2027 2727 4d75 6c74  ms):.    '''Mult
-0002f290: 6970 6c79 2061 6e64 2f6f 7220 636f 6e74  iply and/or cont
-0002f2a0: 7261 6374 2061 7272 6179 7320 7669 6120  ract arrays via 
-0002f2b0: 666f 726d 6174 2073 7472 696e 672e 0a0a  format string...
-0002f2c0: 2020 2020 5468 6520 666f 726d 6174 2073      The format s
-0002f2d0: 7472 696e 6720 636f 6e73 6973 7473 206f  tring consists o
-0002f2e0: 6620 6120 636f 6d6d 6120 7365 7061 7261  f a comma separa
-0002f2f0: 7465 6420 6c69 7374 206f 6620 6178 6973  ted list of axis
-0002f300: 206c 6162 656c 732c 2066 6f6c 6c6f 7765   labels, followe
-0002f310: 640a 2020 2020 6279 2060 602d 3e60 6020  d.    by ``->`` 
-0002f320: 616e 6420 7468 6520 6178 6973 206c 6162  and the axis lab
-0002f330: 656c 7320 6f66 2074 6865 2072 6574 7572  els of the retur
-0002f340: 6e20 7661 6c75 652e 2046 6f72 2065 7861  n value. For exa
-0002f350: 6d70 6c65 2c20 7468 6520 666f 6c6c 6f77  mple, the follow
-0002f360: 696e 670a 2020 2020 7377 6170 7320 7468  ing.    swaps th
-0002f370: 6520 6178 6573 206f 6620 6120 6d61 7472  e axes of a matr
-0002f380: 6978 3a0a 0a20 2020 203e 3e3e 2061 3435  ix:..    >>> a45
-0002f390: 203d 206f 6e65 7328 7475 706c 6528 6d61   = ones(tuple(ma
-0002f3a0: 7028 636f 6e73 7461 6e74 2c20 5b34 2c35  p(constant, [4,5
-0002f3b0: 5d29 2929 2023 2034 7835 206d 6174 7269  ]))) # 4x5 matri
-0002f3c0: 780a 2020 2020 3e3e 3e20 6569 6e73 756d  x.    >>> einsum
-0002f3d0: 2827 696a 2d3e 6a69 272c 2061 3435 290a  ('ij->ji', a45).
-0002f3e0: 2020 2020 6e75 7469 6c73 2e65 7661 6c75      nutils.evalu
-0002f3f0: 6162 6c65 2e54 7261 6e73 706f 7365 3c66  able.Transpose<f
-0002f400: 3a28 3529 2c28 3429 3e0a 0a20 2020 2041  :(5),(4)>..    A
-0002f410: 7869 7320 6c61 6265 6c73 2074 6861 7420  xis labels that 
-0002f420: 646f 206e 6f74 206f 6363 7572 2069 6e20  do not occur in 
-0002f430: 7468 6520 7265 7475 726e 2076 616c 7565  the return value
-0002f440: 2061 7265 2073 756d 6d65 642e 2046 6f72   are summed. For
-0002f450: 2065 7861 6d70 6c65 2c0a 2020 2020 7468   example,.    th
-0002f460: 6520 666f 6c6c 6f77 696e 6720 7065 7266  e following perf
-0002f470: 6f72 6d73 2061 206d 6174 7269 782d 7665  orms a matrix-ve
-0002f480: 6374 6f72 2070 726f 6475 6374 3a0a 0a20  ctor product:.. 
-0002f490: 2020 203e 3e3e 2061 3520 3d20 6f6e 6573     >>> a5 = ones
-0002f4a0: 2874 7570 6c65 286d 6170 2863 6f6e 7374  (tuple(map(const
-0002f4b0: 616e 742c 205b 355d 2929 2920 2320 7665  ant, [5]))) # ve
-0002f4c0: 6374 6f72 2077 6974 6820 6c65 6e67 7468  ctor with length
-0002f4d0: 2035 0a20 2020 203e 3e3e 2065 696e 7375   5.    >>> einsu
-0002f4e0: 6d28 2769 6a2c 6a2d 3e69 272c 2061 3435  m('ij,j->i', a45
-0002f4f0: 2c20 6135 290a 2020 2020 6e75 7469 6c73  , a5).    nutils
-0002f500: 2e65 7661 6c75 6162 6c65 2e53 756d 3c66  .evaluable.Sum<f
-0002f510: 3a34 3e0a 0a20 2020 2054 6865 2066 6f6c  :4>..    The fol
-0002f520: 6c6f 7769 6e67 2063 6f6e 7472 6163 7473  lowing contracts
-0002f530: 2061 2074 6869 7264 206f 7264 6572 2074   a third order t
-0002f540: 656e 736f 722c 2061 206d 6174 7269 782c  ensor, a matrix,
-0002f550: 2061 6e64 2061 2076 6563 746f 722c 2061   and a vector, a
-0002f560: 6e64 0a20 2020 2074 7261 6e73 706f 7365  nd.    transpose
-0002f570: 7320 7468 6520 7265 7375 6c74 3a0a 0a20  s the result:.. 
-0002f580: 2020 203e 3e3e 2061 3233 3420 3d20 6f6e     >>> a234 = on
-0002f590: 6573 2874 7570 6c65 286d 6170 2863 6f6e  es(tuple(map(con
-0002f5a0: 7374 616e 742c 205b 322c 332c 345d 2929  stant, [2,3,4]))
-0002f5b0: 2920 2320 3278 3378 3420 7465 6e73 6f72  ) # 2x3x4 tensor
-0002f5c0: 0a20 2020 203e 3e3e 2065 696e 7375 6d28  .    >>> einsum(
-0002f5d0: 2769 6a6b 2c6b 6c2c 6c2d 3e6a 6927 2c20  'ijk,kl,l->ji', 
-0002f5e0: 6132 3334 2c20 6134 352c 2061 3529 0a20  a234, a45, a5). 
-0002f5f0: 2020 206e 7574 696c 732e 6576 616c 7561     nutils.evalua
-0002f600: 626c 652e 5375 6d3c 663a 332c 323e 0a0a  ble.Sum<f:3,2>..
-0002f610: 2020 2020 496e 2063 6173 6520 7468 6520      In case the 
-0002f620: 6469 6d65 6e73 696f 6e20 6f66 2074 6865  dimension of the
-0002f630: 2069 6e70 7574 2061 6e64 206f 7574 7075   input and outpu
-0002f640: 7420 6172 7261 7973 206d 6179 2076 6172  t arrays may var
-0002f650: 792c 2061 2076 6172 6961 626c 650a 2020  y, a variable.  
-0002f660: 2020 6c65 6e67 7468 2061 7865 7320 6772    length axes gr
-0002f670: 6f75 7020 6361 6e20 6265 2064 656e 6f74  oup can be denot
-0002f680: 6564 2062 7920 6120 6361 7069 7461 6c2e  ed by a capital.
-0002f690: 2049 7473 206c 656e 6774 6820 6973 2061   Its length is a
-0002f6a0: 7574 6f6d 6174 6963 616c 6c79 0a20 2020  utomatically.   
-0002f6b0: 2065 7374 6162 6c69 7368 6564 2062 6173   established bas
-0002f6c0: 6564 206f 6e20 7468 6520 6469 6d65 6e73  ed on the dimens
-0002f6d0: 696f 6e20 6f66 2074 6865 2069 6e70 7574  ion of the input
-0002f6e0: 2061 7272 6179 732e 2054 6865 2066 6f6c   arrays. The fol
-0002f6f0: 6c6f 7769 6e67 2065 7861 6d70 6c65 0a20  lowing example. 
-0002f700: 2020 2070 6572 666f 726d 7320 6120 7465     performs a te
-0002f710: 6e73 6f72 2070 726f 6475 6374 206f 6620  nsor product of 
-0002f720: 616e 2061 7272 6179 2061 6e64 2061 2076  an array and a v
-0002f730: 6563 746f 723a 0a0a 2020 2020 3e3e 3e20  ector:..    >>> 
-0002f740: 6569 6e73 756d 2827 412c 692d 3e41 6927  einsum('A,i->Ai'
-0002f750: 2c20 6132 3334 2c20 6135 290a 2020 2020  , a234, a5).    
-0002f760: 6e75 7469 6c73 2e65 7661 6c75 6162 6c65  nutils.evaluable
-0002f770: 2e4d 756c 7469 706c 793c 663a 322c 332c  .Multiply<f:2,3,
-0002f780: 342c 353e 0a0a 2020 2020 5468 6520 666f  4,5>..    The fo
-0002f790: 726d 6174 2073 7472 696e 6720 6d61 7920  rmat string may 
-0002f7a0: 636f 6e74 6169 6e20 6d75 6c74 6970 6c65  contain multiple
-0002f7b0: 2076 6172 6961 626c 6520 6c65 6e67 7468   variable length
-0002f7c0: 2061 7865 7320 6772 6f75 7073 2c20 6275   axes groups, bu
-0002f7d0: 7420 7468 6569 720a 2020 2020 6c65 6e67  t their.    leng
-0002f7e0: 7468 7320 6d75 7374 2062 6520 7265 736f  ths must be reso
-0002f7f0: 6c76 6162 6c65 2066 726f 6d20 6c65 6674  lvable from left
-0002f800: 2074 6f20 7269 6768 742e 2049 6e20 6361   to right. In ca
-0002f810: 7365 2074 6869 7320 6973 206e 6f74 2070  se this is not p
-0002f820: 6f73 7369 626c 652c 0a20 2020 206c 656e  ossible,.    len
-0002f830: 6774 6873 206d 6179 2062 6520 7370 6563  gths may be spec
-0002f840: 6966 6965 6420 6173 206b 6579 776f 7264  ified as keyword
-0002f850: 2061 7267 756d 656e 7473 2e0a 0a20 2020   arguments...   
-0002f860: 203e 3e3e 2065 696e 7375 6d28 2741 6a42   >>> einsum('AjB
-0002f870: 2c69 2d3e 4169 6a42 272c 2061 3233 342c  ,i->AijB', a234,
-0002f880: 2061 352c 2042 3d31 290a 2020 2020 6e75   a5, B=1).    nu
-0002f890: 7469 6c73 2e65 7661 6c75 6162 6c65 2e4d  tils.evaluable.M
-0002f8a0: 756c 7469 706c 793c 663a 322c 352c 332c  ultiply<f:2,5,3,
-0002f8b0: 343e 0a20 2020 2027 2727 0a0a 2020 2020  4>.    '''..    
-0002f8c0: 6966 206e 6f74 2061 6c6c 2869 7369 6e73  if not all(isins
-0002f8d0: 7461 6e63 6528 6172 672c 2041 7272 6179  tance(arg, Array
-0002f8e0: 2920 666f 7220 6172 6720 696e 2061 7267  ) for arg in arg
-0002f8f0: 7329 3a0a 2020 2020 2020 2020 7261 6973  s):.        rais
-0002f900: 6520 5661 6c75 6545 7272 6f72 2827 6172  e ValueError('ar
-0002f910: 6775 6d65 6e74 7320 6d75 7374 2062 6520  guments must be 
-0002f920: 4172 7261 7920 7661 6c75 6564 2729 0a0a  Array valued')..
-0002f930: 2020 2020 7369 6e2c 2073 6f75 7420 3d20      sin, sout = 
-0002f940: 666d 742e 7370 6c69 7428 272d 3e27 290a  fmt.split('->').
-0002f950: 2020 2020 7369 6e20 3d20 7369 6e2e 7370      sin = sin.sp
-0002f960: 6c69 7428 272c 2729 0a0a 2020 2020 6966  lit(',')..    if
-0002f970: 206c 656e 2873 696e 2920 213d 206c 656e   len(sin) != len
-0002f980: 2861 7267 7329 3a0a 2020 2020 2020 2020  (args):.        
-0002f990: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-0002f9a0: 2827 6e75 6d62 6572 206f 6620 6172 6775  ('number of argu
-0002f9b0: 6d65 6e74 7320 646f 6573 206e 6f74 206d  ments does not m
-0002f9c0: 6174 6368 2066 6f72 6d61 7420 7374 7269  atch format stri
-0002f9d0: 6e67 2729 0a0a 2020 2020 6966 2061 6e79  ng')..    if any
-0002f9e0: 286c 656e 2873 2920 213d 206c 656e 2873  (len(s) != len(s
-0002f9f0: 6574 2873 2929 2066 6f72 2073 2069 6e20  et(s)) for s in 
-0002fa00: 282a 7369 6e2c 2073 6f75 7429 293a 0a20  (*sin, sout)):. 
-0002fa10: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0002fa20: 7565 4572 726f 7228 2769 6e74 6572 6e61  ueError('interna
-0002fa30: 6c20 7265 7065 7469 7469 6f6e 7320 6172  l repetitions ar
-0002fa40: 6520 6e6f 7420 7375 7070 6f72 7465 6427  e not supported'
-0002fa50: 290a 0a20 2020 2069 6620 616e 7928 6e20  )..    if any(n 
-0002fa60: 3c20 3020 666f 7220 6e20 696e 2064 696d  < 0 for n in dim
-0002fa70: 732e 7661 6c75 6573 2829 293a 0a20 2020  s.values()):.   
-0002fa80: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-0002fa90: 4572 726f 7228 2761 7869 7320 6772 6f75  Error('axis grou
-0002faa0: 7020 6469 6d65 6e73 696f 6e73 2063 616e  p dimensions can
-0002fab0: 6e6f 7420 6265 206e 6567 6174 6976 6527  not be negative'
-0002fac0: 290a 0a20 2020 2066 6f72 2063 2069 6e20  )..    for c in 
-0002fad0: 2761 6263 6465 6667 6869 6a6b 6c6d 6e6f  'abcdefghijklmno
-0002fae0: 7071 7273 7475 7677 7879 7a27 3a0a 2020  pqrstuvwxyz':.  
-0002faf0: 2020 2020 2020 6469 6d73 2e73 6574 6465        dims.setde
-0002fb00: 6661 756c 7428 632c 2031 2920 2023 206c  fault(c, 1)  # l
-0002fb10: 6f77 6572 6361 7365 2063 6861 7261 6374  owercase charact
-0002fb20: 6572 7320 6465 6661 756c 7420 746f 2073  ers default to s
-0002fb30: 696e 676c 6520 6469 6d65 6e73 696f 6e0a  ingle dimension.
-0002fb40: 0a20 2020 2066 6f72 2073 2c20 6172 6720  .    for s, arg 
-0002fb50: 696e 207a 6970 2873 696e 2c20 6172 6773  in zip(sin, args
-0002fb60: 293a 0a20 2020 2020 2020 206d 6973 7369  ):.        missi
-0002fb70: 6e67 5f64 696d 7320 3d20 6172 672e 6e64  ng_dims = arg.nd
-0002fb80: 696d 202d 2062 7569 6c74 696e 732e 7375  im - builtins.su
-0002fb90: 6d28 6469 6d73 2e67 6574 2863 2c20 3029  m(dims.get(c, 0)
-0002fba0: 2066 6f72 2063 2069 6e20 7329 0a20 2020   for c in s).   
-0002fbb0: 2020 2020 2075 6e6b 6e6f 776e 5f61 7865       unknown_axe
-0002fbc0: 7320 3d20 5b63 2066 6f72 2063 2069 6e20  s = [c for c in 
-0002fbd0: 7320 6966 2063 206e 6f74 2069 6e20 6469  s if c not in di
-0002fbe0: 6d73 5d0a 2020 2020 2020 2020 6966 206c  ms].        if l
-0002fbf0: 656e 2875 6e6b 6e6f 776e 5f61 7865 7329  en(unknown_axes)
-0002fc00: 203d 3d20 3120 616e 6420 6d69 7373 696e   == 1 and missin
-0002fc10: 675f 6469 6d73 203e 3d20 303a 0a20 2020  g_dims >= 0:.   
-0002fc20: 2020 2020 2020 2020 2064 696d 735b 756e           dims[un
-0002fc30: 6b6e 6f77 6e5f 6178 6573 5b30 5d5d 203d  known_axes[0]] =
-0002fc40: 206d 6973 7369 6e67 5f64 696d 730a 2020   missing_dims.  
-0002fc50: 2020 2020 2020 656c 6966 206c 656e 2875        elif len(u
-0002fc60: 6e6b 6e6f 776e 5f61 7865 7329 203e 2031  nknown_axes) > 1
-0002fc70: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0002fc80: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
-0002fc90: 6361 6e6e 6f74 2065 7374 6162 6c69 7368  cannot establish
-0002fca0: 206c 656e 6774 6820 6f66 2076 6172 6961   length of varia
-0002fcb0: 626c 6520 6772 6f75 7073 207b 7d27 2e66  ble groups {}'.f
-0002fcc0: 6f72 6d61 7428 272c 2027 2e6a 6f69 6e28  ormat(', '.join(
-0002fcd0: 756e 6b6e 6f77 6e5f 6178 6573 2929 290a  unknown_axes))).
-0002fce0: 2020 2020 2020 2020 656c 6966 206d 6973          elif mis
-0002fcf0: 7369 6e67 5f64 696d 733a 0a20 2020 2020  sing_dims:.     
-0002fd00: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0002fd10: 7565 4572 726f 7228 2761 7267 756d 656e  ueError('argumen
-0002fd20: 7420 6469 6d65 6e73 696f 6e73 2061 7265  t dimensions are
-0002fd30: 2069 6e63 6f6e 7369 7374 656e 7420 7769   inconsistent wi
-0002fd40: 7468 2066 6f72 6d61 7420 7374 7269 6e67  th format string
-0002fd50: 2729 0a0a 2020 2020 2320 6578 7061 6e64  ')..    # expand
-0002fd60: 2063 6861 7261 6374 6572 7320 746f 206d   characters to m
-0002fd70: 6174 6368 2061 7267 756d 656e 7420 6469  atch argument di
-0002fd80: 6d65 6e73 696f 6e0a 2020 2020 2a73 696e  mension.    *sin
-0002fd90: 2c20 736f 7574 203d 205b 5b28 632c 2064  , sout = [[(c, d
-0002fda0: 2920 666f 7220 6320 696e 2073 2066 6f72  ) for c in s for
-0002fdb0: 2064 2069 6e20 7261 6e67 6528 6469 6d73   d in range(dims
-0002fdc0: 5b63 5d29 5d20 666f 7220 7320 696e 2028  [c])] for s in (
-0002fdd0: 2a73 696e 2c20 736f 7574 295d 0a20 2020  *sin, sout)].   
-0002fde0: 2073 616c 6c20 3d20 736f 7574 202b 2073   sall = sout + s
-0002fdf0: 6f72 7465 6428 7b63 2066 6f72 2073 2069  orted({c for s i
-0002fe00: 6e20 7369 6e20 666f 7220 6320 696e 2073  n sin for c in s
-0002fe10: 2069 6620 6320 6e6f 7420 696e 2073 6f75   if c not in sou
-0002fe20: 747d 290a 0a20 2020 2073 6861 7065 7320  t})..    shapes 
-0002fe30: 3d20 7b7d 0a20 2020 2066 6f72 2073 2c20  = {}.    for s, 
-0002fe40: 6172 6720 696e 207a 6970 2873 696e 2c20  arg in zip(sin, 
-0002fe50: 6172 6773 293a 0a20 2020 2020 2020 2061  args):.        a
-0002fe60: 7373 6572 7420 6c65 6e28 7329 203d 3d20  ssert len(s) == 
-0002fe70: 6172 672e 6e64 696d 0a20 2020 2020 2020  arg.ndim.       
-0002fe80: 2066 6f72 2063 2c20 7368 2069 6e20 7a69   for c, sh in zi
-0002fe90: 7028 732c 2061 7267 2e73 6861 7065 293a  p(s, arg.shape):
-0002fea0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002feb0: 6e6f 7420 5f65 7175 616c 735f 7369 6d70  not _equals_simp
-0002fec0: 6c69 6669 6564 2873 6861 7065 732e 7365  lified(shapes.se
-0002fed0: 7464 6566 6175 6c74 2863 2c20 7368 292c  tdefault(c, sh),
-0002fee0: 2073 6829 3a0a 2020 2020 2020 2020 2020   sh):.          
-0002fef0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-0002ff00: 6545 7272 6f72 2827 7368 6170 6573 2064  eError('shapes d
-0002ff10: 6f20 6e6f 7420 6d61 7463 6820 666f 7220  o not match for 
-0002ff20: 6178 6973 207b 305b 305d 7d7b 305b 315d  axis {0[0]}{0[1]
-0002ff30: 7d27 2e66 6f72 6d61 7428 6329 290a 0a20  }'.format(c)).. 
-0002ff40: 2020 2072 6574 203d 204e 6f6e 650a 2020     ret = None.  
-0002ff50: 2020 666f 7220 732c 2061 7267 2069 6e20    for s, arg in 
-0002ff60: 7a69 7028 7369 6e2c 2061 7267 7329 3a0a  zip(sin, args):.
-0002ff70: 2020 2020 2020 2020 696e 6465 7820 3d20          index = 
-0002ff80: 7b63 3a20 6920 666f 7220 692c 2063 2069  {c: i for i, c i
-0002ff90: 6e20 656e 756d 6572 6174 6528 7329 7d0a  n enumerate(s)}.
-0002ffa0: 2020 2020 2020 2020 666f 7220 6320 696e          for c in
-0002ffb0: 2073 616c 6c3a 0a20 2020 2020 2020 2020   sall:.         
-0002ffc0: 2020 2069 6620 6320 6e6f 7420 696e 2069     if c not in i
-0002ffd0: 6e64 6578 3a0a 2020 2020 2020 2020 2020  ndex:.          
-0002ffe0: 2020 2020 2020 696e 6465 785b 635d 203d        index[c] =
-0002fff0: 2061 7267 2e6e 6469 6d0a 2020 2020 2020   arg.ndim.      
-00030000: 2020 2020 2020 2020 2020 6172 6720 3d20            arg = 
-00030010: 496e 7365 7274 4178 6973 2861 7267 2c20  InsertAxis(arg, 
-00030020: 7368 6170 6573 5b63 5d29 0a20 2020 2020  shapes[c]).     
-00030030: 2020 2076 203d 2054 7261 6e73 706f 7365     v = Transpose
-00030040: 2861 7267 2c20 7475 706c 6528 696e 6465  (arg, tuple(inde
-00030050: 785b 635d 2066 6f72 2063 2069 6e20 7361  x[c] for c in sa
-00030060: 6c6c 2929 0a20 2020 2020 2020 2072 6574  ll)).        ret
-00030070: 203d 2076 2069 6620 7265 7420 6973 204e   = v if ret is N
-00030080: 6f6e 6520 656c 7365 2072 6574 202a 2076  one else ret * v
-00030090: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
-000300a0: 6e67 6528 6c65 6e28 736f 7574 292c 206c  nge(len(sout), l
-000300b0: 656e 2873 616c 6c29 293a 0a20 2020 2020  en(sall)):.     
-000300c0: 2020 2072 6574 203d 2053 756d 2872 6574     ret = Sum(ret
-000300d0: 290a 2020 2020 7265 7475 726e 2072 6574  ).    return ret
-000300e0: 0a0a 0a40 7574 696c 2e73 696e 676c 655f  ...@util.single_
-000300f0: 6f72 5f6d 756c 7469 706c 650a 6465 6620  or_multiple.def 
-00030100: 6576 616c 5f73 7061 7273 6528 6675 6e63  eval_sparse(func
-00030110: 733a 2041 7345 7661 6c75 6162 6c65 4172  s: AsEvaluableAr
-00030120: 7261 792c 202a 2a61 7267 756d 656e 7473  ray, **arguments
-00030130: 3a20 7479 7069 6e67 2e4d 6170 7069 6e67  : typing.Mapping
-00030140: 5b73 7472 2c20 6e75 6d70 792e 6e64 6172  [str, numpy.ndar
-00030150: 7261 795d 2920 2d3e 2074 7970 696e 672e  ray]) -> typing.
-00030160: 5475 706c 655b 6e75 6d70 792e 6e64 6172  Tuple[numpy.ndar
-00030170: 7261 792c 202e 2e2e 5d3a 0a20 2020 2027  ray, ...]:.    '
-00030180: 2727 4576 616c 7561 7465 206f 6e65 206f  ''Evaluate one o
-00030190: 7220 7365 7665 7261 6c20 4172 7261 7920  r several Array 
-000301a0: 6f62 6a65 6374 7320 6173 2073 7061 7273  objects as spars
-000301b0: 6520 6461 7461 2e0a 0a20 2020 2041 7267  e data...    Arg
-000301c0: 730a 2020 2020 2d2d 2d2d 0a20 2020 2066  s.    ----.    f
-000301d0: 756e 6373 203a 203a 636c 6173 733a 6074  uncs : :class:`t
-000301e0: 7570 6c65 6020 6f66 2041 7272 6179 206f  uple` of Array o
-000301f0: 626a 6563 7473 0a20 2020 2020 2020 2041  bjects.        A
-00030200: 7272 6179 7320 746f 2062 6520 6576 616c  rrays to be eval
-00030210: 7561 7465 642e 0a20 2020 2061 7267 756d  uated..    argum
-00030220: 656e 7473 203a 203a 636c 6173 733a 6064  ents : :class:`d
-00030230: 6963 7460 2028 6465 6661 756c 743a 204e  ict` (default: N
-00030240: 6f6e 6529 0a20 2020 2020 2020 204f 7074  one).        Opt
-00030250: 696f 6e61 6c20 6172 6775 6d65 6e74 7320  ional arguments 
-00030260: 666f 7220 6675 6e63 7469 6f6e 2065 7661  for function eva
-00030270: 6c75 6174 696f 6e2e 0a0a 2020 2020 5265  luation...    Re
-00030280: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00030290: 2d0a 2020 2020 7265 7375 6c74 7320 3a20  -.    results : 
-000302a0: 3a63 6c61 7373 3a60 7475 706c 6560 206f  :class:`tuple` o
-000302b0: 6620 7370 6172 7365 2064 6174 6120 6172  f sparse data ar
-000302c0: 7261 7973 0a20 2020 2027 2727 0a0a 2020  rays.    '''..  
-000302d0: 2020 6675 6e63 7320 3d20 5b66 756e 632e    funcs = [func.
-000302e0: 6173 5f65 7661 6c75 6162 6c65 5f61 7272  as_evaluable_arr
-000302f0: 6179 2066 6f72 2066 756e 6320 696e 2066  ay for func in f
-00030300: 756e 6373 5d0a 2020 2020 7368 6170 655f  uncs].    shape_
-00030310: 6368 756e 6b73 203d 2054 7570 6c65 2874  chunks = Tuple(t
-00030320: 7570 6c65 2854 7570 6c65 2862 7569 6c74  uple(Tuple(built
-00030330: 696e 732e 7375 6d28 6675 6e63 2e73 696d  ins.sum(func.sim
-00030340: 706c 6966 6965 642e 5f61 7373 7061 7273  plified._asspars
-00030350: 652c 2066 756e 632e 7368 6170 6529 2920  e, func.shape)) 
-00030360: 666f 7220 6675 6e63 2069 6e20 6675 6e63  for func in func
-00030370: 7329 290a 2020 2020 7769 7468 2073 6861  s)).    with sha
-00030380: 7065 5f63 6875 6e6b 732e 6f70 7469 6d69  pe_chunks.optimi
-00030390: 7a65 645f 666f 725f 6e75 6d70 792e 7365  zed_for_numpy.se
-000303a0: 7373 696f 6e28 6772 6170 6876 697a 3d67  ssion(graphviz=g
-000303b0: 7261 7068 7669 7a29 2061 7320 6576 616c  raphviz) as eval
-000303c0: 3a0a 2020 2020 2020 2020 666f 7220 6675  :.        for fu
-000303d0: 6e63 2c20 6172 6773 2069 6e20 7a69 7028  nc, args in zip(
-000303e0: 6675 6e63 732c 2065 7661 6c28 2a2a 6172  funcs, eval(**ar
-000303f0: 6775 6d65 6e74 7329 293a 0a20 2020 2020  guments)):.     
-00030400: 2020 2020 2020 2073 6861 7065 203d 2074         shape = t
-00030410: 7570 6c65 286d 6170 2869 6e74 2c20 6172  uple(map(int, ar
-00030420: 6773 5b3a 6675 6e63 2e6e 6469 6d5d 2929  gs[:func.ndim]))
-00030430: 0a20 2020 2020 2020 2020 2020 2063 6875  .            chu
-00030440: 6e6b 7320 3d20 5b61 7267 735b 693a 692b  nks = [args[i:i+
-00030450: 6675 6e63 2e6e 6469 6d2b 315d 2066 6f72  func.ndim+1] for
-00030460: 2069 2069 6e20 7261 6e67 6528 6675 6e63   i in range(func
-00030470: 2e6e 6469 6d2c 206c 656e 2861 7267 7329  .ndim, len(args)
-00030480: 2c20 6675 6e63 2e6e 6469 6d2b 3129 5d0a  , func.ndim+1)].
-00030490: 2020 2020 2020 2020 2020 2020 6c65 6e67              leng
-000304a0: 7468 203d 2062 7569 6c74 696e 732e 7375  th = builtins.su
-000304b0: 6d28 7661 6c75 6573 2e73 697a 6520 666f  m(values.size fo
-000304c0: 7220 2a69 6e64 6963 6573 2c20 7661 6c75  r *indices, valu
-000304d0: 6573 2069 6e20 6368 756e 6b73 290a 2020  es in chunks).  
-000304e0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-000304f0: 206e 756d 7079 2e65 6d70 7479 2828 6c65   numpy.empty((le
-00030500: 6e67 7468 2c29 2c20 6474 7970 653d 7370  ngth,), dtype=sp
-00030510: 6172 7365 2e64 7479 7065 2873 6861 7065  arse.dtype(shape
-00030520: 2c20 6675 6e63 2e64 7479 7065 2929 0a20  , func.dtype)). 
-00030530: 2020 2020 2020 2020 2020 2073 7461 7274             start
-00030540: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-00030550: 2066 6f72 202a 696e 6469 6365 732c 2076   for *indices, v
-00030560: 616c 7565 7320 696e 2063 6875 6e6b 733a  alues in chunks:
-00030570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030580: 2073 746f 7020 3d20 7374 6172 7420 2b20   stop = start + 
-00030590: 7661 6c75 6573 2e73 697a 650a 2020 2020  values.size.    
-000305a0: 2020 2020 2020 2020 2020 2020 6420 3d20              d = 
-000305b0: 6461 7461 5b73 7461 7274 3a73 746f 705d  data[start:stop]
-000305c0: 2e72 6573 6861 7065 2876 616c 7565 732e  .reshape(values.
-000305d0: 7368 6170 6529 0a20 2020 2020 2020 2020  shape).         
-000305e0: 2020 2020 2020 2064 5b27 7661 6c75 6527         d['value'
-000305f0: 5d20 3d20 7661 6c75 6573 0a20 2020 2020  ] = values.     
-00030600: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-00030610: 6469 6d2c 2069 6920 696e 2065 6e75 6d65  dim, ii in enume
-00030620: 7261 7465 2869 6e64 6963 6573 293a 0a20  rate(indices):. 
-00030630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030640: 2020 2064 5b27 696e 6465 7827 5d5b 2769     d['index']['i
-00030650: 272b 7374 7228 6964 696d 295d 203d 2069  '+str(idim)] = i
-00030660: 690a 2020 2020 2020 2020 2020 2020 2020  i.              
-00030670: 2020 7374 6172 7420 3d20 7374 6f70 0a20    start = stop. 
-00030680: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-00030690: 2064 6174 610a 0a0a 6966 205f 5f6e 616d   data...if __nam
-000306a0: 655f 5f20 3d3d 2027 5f5f 6d61 696e 5f5f  e__ == '__main__
-000306b0: 273a 0a20 2020 2023 2044 6961 676e 6f73  ':.    # Diagnos
-000306c0: 7469 6373 2066 6f72 2074 6865 2064 6576  tics for the dev
-000306d0: 656c 6f70 6d65 6e74 2066 6f72 2073 696d  elopment for sim
-000306e0: 706c 6966 7920 6f70 6572 6174 696f 6e73  plify operations
-000306f0: 2e0a 2020 2020 7369 6d70 6c69 6679 5f70  ..    simplify_p
-00030700: 7269 6f72 6974 7920 3d20 280a 2020 2020  riority = (.    
-00030710: 2020 2020 5472 616e 7370 6f73 652c 2052      Transpose, R
-00030720: 6176 656c 2c20 2023 2072 6569 6e74 6572  avel,  # reinter
-00030730: 7072 6574 6174 696f 6e0a 2020 2020 2020  pretation.      
-00030740: 2020 496e 7365 7274 4178 6973 2c20 496e    InsertAxis, In
-00030750: 666c 6174 652c 2044 6961 676f 6e61 6c69  flate, Diagonali
-00030760: 7a65 2c20 2023 2073 697a 6520 696e 6372  ze,  # size incr
-00030770: 6561 7369 6e67 0a20 2020 2020 2020 204d  easing.        M
-00030780: 756c 7469 706c 792c 2041 6464 2c20 4c6f  ultiply, Add, Lo
-00030790: 6f70 5375 6d2c 2053 6967 6e2c 2050 6f77  opSum, Sign, Pow
-000307a0: 6572 2c20 496e 7665 7273 652c 2055 6e72  er, Inverse, Unr
-000307b0: 6176 656c 2c20 2023 2073 697a 6520 7072  avel,  # size pr
-000307c0: 6573 6572 7669 6e67 0a20 2020 2020 2020  eserving.       
-000307d0: 2050 726f 6475 6374 2c20 4465 7465 726d   Product, Determ
-000307e0: 696e 616e 742c 2054 616b 6544 6961 672c  inant, TakeDiag,
-000307f0: 2054 616b 652c 2053 756d 2920 2023 2073   Take, Sum)  # s
-00030800: 697a 6520 6465 6372 6561 7369 6e67 0a20  ize decreasing. 
-00030810: 2020 2023 2054 6865 2073 696d 706c 6966     # The simplif
-00030820: 7920 7072 696f 7269 7479 2064 6566 696e  y priority defin
-00030830: 6573 2074 6865 2070 7265 6665 7272 6564  es the preferred
-00030840: 206f 7264 6572 2069 6e20 7768 6963 6820   order in which 
-00030850: 6f70 6572 6174 696f 6e73 2061 7265 0a20  operations are. 
-00030860: 2020 2023 2070 6572 666f 726d 6564 3a20     # performed: 
-00030870: 7368 6170 6520 6465 6372 6561 7369 6e67  shape decreasing
-00030880: 206f 7065 7261 7469 6f6e 7320 7375 6368   operations such
-00030890: 2061 7320 5375 6d20 616e 6420 5461 6b65   as Sum and Take
-000308a0: 2073 686f 756c 6420 6265 2064 6f6e 650a   should be done.
-000308b0: 2020 2020 2320 6173 2073 6f6f 6e20 6173      # as soon as
-000308c0: 2070 6f73 7369 626c 652c 2061 6e64 2073   possible, and s
-000308d0: 6861 7065 2069 6e63 7265 6173 696e 6720  hape increasing 
-000308e0: 6f70 6572 6174 696f 6e73 2073 7563 6820  operations such 
-000308f0: 6173 2049 6e66 6c61 7465 2061 6e64 0a20  as Inflate and. 
-00030900: 2020 2023 2044 6961 676f 6e61 6c69 7a65     # Diagonalize
-00030910: 2061 7320 6c61 7465 2061 7320 706f 7373   as late as poss
-00030920: 6962 6c65 2e20 496e 2073 6875 6666 6c69  ible. In shuffli
-00030930: 6e67 2074 6865 206f 7264 6572 206f 6620  ng the order of 
-00030940: 6f70 6572 6174 696f 6e73 2074 6865 0a20  operations the. 
-00030950: 2020 2023 2074 776f 2063 6c61 7373 6573     # two classes
-00030960: 206d 6967 6874 2061 6e6e 6968 696c 6174   might annihilat
-00030970: 6520 6561 6368 206f 7468 6572 2c20 666f  e each other, fo
-00030980: 7220 6578 616d 706c 6520 7768 656e 2061  r example when a
-00030990: 2053 756d 2070 6173 7365 730a 2020 2020   Sum passes.    
-000309a0: 2320 7468 726f 7567 6820 6120 4469 6167  # through a Diag
-000309b0: 6f6e 616c 697a 652e 2041 6e79 2073 6861  onalize. Any sha
-000309c0: 7065 2069 6e63 7265 6173 696e 6720 6f70  pe increasing op
-000309d0: 6572 6174 696f 6e73 2074 6861 7420 7265  erations that re
-000309e0: 6d61 696e 2073 686f 756c 640a 2020 2020  main should.    
-000309f0: 2320 656e 6420 7570 2061 7420 7468 6520  # end up at the 
-00030a00: 7375 7266 6163 652c 2065 7870 6f73 696e  surface, exposin
-00030a10: 6720 7370 6172 7369 7479 2062 7920 6d65  g sparsity by me
-00030a20: 616e 7320 6f66 2074 6865 205f 6173 7370  ans of the _assp
-00030a30: 6172 7365 206d 6574 686f 642e 0a20 2020  arse method..   
-00030a40: 2061 7474 7273 203d 205b 275f 272b 636c   attrs = ['_'+cl
-00030a50: 732e 5f5f 6e61 6d65 5f5f 2e6c 6f77 6572  s.__name__.lower
-00030a60: 2829 2066 6f72 2063 6c73 2069 6e20 7369  () for cls in si
-00030a70: 6d70 6c69 6679 5f70 7269 6f72 6974 795d  mplify_priority]
-00030a80: 0a20 2020 2023 2054 6865 2073 696d 706c  .    # The simpl
-00030a90: 6966 7920 6f70 6572 6174 696f 6e73 2072  ify operations r
-00030aa0: 6573 706f 6e73 6962 6c65 2066 6f72 2073  esponsible for s
-00030ab0: 7761 7070 696e 6720 2861 2e6f 2e29 2061  wapping (a.o.) a
-00030ac0: 7265 206d 6574 686f 6473 206e 616d 6564  re methods named
-00030ad0: 0a20 2020 2023 2027 5f61 6464 272c 2027  .    # '_add', '
-00030ae0: 5f6d 756c 7469 706c 7927 2c20 6574 632e  _multiply', etc.
-00030af0: 2049 6e20 6f72 6465 7220 746f 2061 766f   In order to avo
-00030b00: 6964 2072 6563 7572 7369 6f6e 7320 7468  id recursions th
-00030b10: 6520 6f70 6572 6174 696f 6e73 0a20 2020  e operations.   
-00030b20: 2023 2073 686f 756c 6420 6f6e 6c79 2062   # should only b
-00030b30: 6520 6465 6669 6e65 6420 696e 2074 6865  e defined in the
-00030b40: 2064 6972 6563 7469 6f6e 2064 6566 696e   direction defin
-00030b50: 6564 2062 7920 6f70 6572 6174 6f72 2070  ed by operator p
-00030b60: 7269 6f72 6974 792e 2054 6865 0a20 2020  riority. The.   
-00030b70: 2023 2066 6f6c 6c6f 7769 6e67 2063 6f64   # following cod
-00030b80: 6520 7761 726e 7320 6761 696e 7374 2076  e warns gainst v
-00030b90: 696f 6c61 7469 6f6e 7320 6f66 2074 6869  iolations of thi
-00030ba0: 7320 7275 6c65 2061 6e64 206c 6973 7473  s rule and lists
-00030bb0: 2070 6572 6d69 7373 6962 6c65 0a20 2020   permissible.   
-00030bc0: 2023 2073 696d 706c 6966 6963 6174 696f   # simplificatio
-00030bd0: 6e73 2074 6861 7420 6861 7665 206e 6f74  ns that have not
-00030be0: 2079 6574 2062 6565 6e20 696d 706c 656d   yet been implem
-00030bf0: 656e 7465 642e 0a20 2020 2066 6f72 2069  ented..    for i
-00030c00: 2c20 636c 7320 696e 2065 6e75 6d65 7261  , cls in enumera
-00030c10: 7465 2873 696d 706c 6966 795f 7072 696f  te(simplify_prio
-00030c20: 7269 7479 293a 0a20 2020 2020 2020 2077  rity):.        w
-00030c30: 6172 6e20 3d20 5b61 7474 7220 666f 7220  arn = [attr for 
-00030c40: 6174 7472 2069 6e20 6174 7472 735b 3a69  attr in attrs[:i
-00030c50: 5d20 6966 2067 6574 6174 7472 2863 6c73  ] if getattr(cls
-00030c60: 2c20 6174 7472 2920 6973 206e 6f74 2067  , attr) is not g
-00030c70: 6574 6174 7472 2841 7272 6179 2c20 6174  etattr(Array, at
-00030c80: 7472 295d 0a20 2020 2020 2020 2069 6620  tr)].        if 
-00030c90: 7761 726e 3a0a 2020 2020 2020 2020 2020  warn:.          
-00030ca0: 2020 7072 696e 7428 275b 215d 207b 7d20    print('[!] {} 
-00030cb0: 7368 6f75 6c64 206e 6f74 2064 6566 696e  should not defin
-00030cc0: 6520 7b7d 272e 666f 726d 6174 2863 6c73  e {}'.format(cls
-00030cd0: 2e5f 5f6e 616d 655f 5f2c 2027 2c20 272e  .__name__, ', '.
-00030ce0: 6a6f 696e 2877 6172 6e29 2929 0a20 2020  join(warn))).   
-00030cf0: 2020 2020 206d 6973 7369 6e67 203d 205b       missing = [
-00030d00: 6174 7472 2066 6f72 2061 7474 7220 696e  attr for attr in
-00030d10: 2061 7474 7273 5b69 2b31 3a5d 2069 6620   attrs[i+1:] if 
-00030d20: 6e6f 7420 6765 7461 7474 7228 636c 732c  not getattr(cls,
-00030d30: 2061 7474 7229 2069 7320 6e6f 7420 6765   attr) is not ge
-00030d40: 7461 7474 7228 4172 7261 792c 2061 7474  tattr(Array, att
-00030d50: 7229 5d0a 2020 2020 2020 2020 6966 206d  r)].        if m
-00030d60: 6973 7369 6e67 3a0a 2020 2020 2020 2020  issing:.        
-00030d70: 2020 2020 7072 696e 7428 275b 205d 207b      print('[ ] {
-00030d80: 7d20 636f 756c 6420 6465 6669 6e65 207b  } could define {
-00030d90: 7d27 2e66 6f72 6d61 7428 636c 732e 5f5f  }'.format(cls.__
-00030da0: 6e61 6d65 5f5f 2c20 272c 2027 2e6a 6f69  name__, ', '.joi
-00030db0: 6e28 6d69 7373 696e 6729 2929 0a0a 2320  n(missing)))..# 
-00030dc0: 7669 6d3a 7377 3d34 3a73 7473 3d34 3a65  vim:sw=4:sts=4:e
-00030dd0: 740a                                     t.
+00029bb0: 6272 696e 6720 636f 6e63 6174 656e 6174  bring concatenat
+00029bc0: 696f 6e20 6178 6973 2074 6f20 7468 6520  ion axis to the 
+00029bd0: 656e 640a 2020 2020 2020 2020 2020 2020  end.            
+00029be0: 756e 616c 6967 6e65 6420 3d20 5472 616e  unaligned = Tran
+00029bf0: 7370 6f73 652e 696e 7628 756e 616c 6967  spose.inv(unalig
+00029c00: 6e65 642c 2077 6865 7265 290a 2020 2020  ned, where).    
+00029c10: 2020 2020 2020 2020 7768 6572 6520 3d20          where = 
+00029c20: 7475 706c 6528 736f 7274 6564 2877 6865  tuple(sorted(whe
+00029c30: 7265 2929 0a20 2020 2020 2020 2066 203d  re)).        f =
+00029c40: 206c 6f6f 705f 636f 6e63 6174 656e 6174   loop_concatenat
+00029c50: 6528 756e 616c 6967 6e65 642c 2073 656c  e(unaligned, sel
+00029c60: 662e 696e 6465 7829 0a20 2020 2020 2020  f.index).       
+00029c70: 2069 6620 6e6f 7420 5f65 7175 616c 735f   if not _equals_
+00029c80: 7369 6d70 6c69 6669 6564 2873 656c 662e  simplified(self.
+00029c90: 7368 6170 655b 2d31 5d2c 2066 2e73 6861  shape[-1], f.sha
+00029ca0: 7065 5b2d 315d 293a 0a20 2020 2020 2020  pe[-1]):.       
+00029cb0: 2020 2020 2023 206c 6173 7420 6178 6973       # last axis
+00029cc0: 2077 6173 2072 6569 6e73 6572 7465 6420   was reinserted 
+00029cd0: 6174 2075 6e69 7420 6c65 6e67 7468 2041  at unit length A
+00029ce0: 4e44 2069 7420 7761 7320 6e6f 7420 756e  ND it was not un
+00029cf0: 6974 206c 656e 6774 680a 2020 2020 2020  it length.      
+00029d00: 2020 2020 2020 2320 6f72 6967 696e 616c        # original
+00029d10: 6c79 202d 2069 6620 6974 2077 6173 2075  ly - if it was u
+00029d20: 6e69 7420 6c65 6e67 7468 206f 7269 6769  nit length origi
+00029d30: 6e61 6c6c 7920 7468 656e 2077 6520 7072  nally then we pr
+00029d40: 6f63 6565 6420 6f6e 6c79 2069 660a 2020  oceed only if.  
+00029d50: 2020 2020 2020 2020 2020 2320 7468 6572            # ther
+00029d60: 6520 6172 6520 6f74 6865 7220 696e 7365  e are other inse
+00029d70: 7274 696f 6e73 2074 6f20 7072 6f6d 6f74  rtions to promot
+00029d80: 652c 206f 7468 6572 7769 7365 2077 6527  e, otherwise we'
+00029d90: 6420 6765 7420 6120 7265 6375 7273 696f  d get a recursio
+00029da0: 6e2e 0a20 2020 2020 2020 2020 2020 2066  n..            f
+00029db0: 203d 2052 6176 656c 2849 6e73 6572 7441   = Ravel(InsertA
+00029dc0: 7869 7328 662c 2073 656c 662e 6675 6e63  xis(f, self.func
+00029dd0: 2e73 6861 7065 5b2d 315d 2929 0a20 2020  .shape[-1])).   
+00029de0: 2020 2020 2065 6c69 6620 6c65 6e28 7768       elif len(wh
+00029df0: 6572 6529 203d 3d20 7365 6c66 2e6e 6469  ere) == self.ndi
+00029e00: 6d3a 0a20 2020 2020 2020 2020 2020 2072  m:.            r
+00029e10: 6574 7572 6e0a 2020 2020 2020 2020 7265  eturn.        re
+00029e20: 7475 726e 2061 6c69 676e 2866 2c20 7768  turn align(f, wh
+00029e30: 6572 652c 2073 656c 662e 7368 6170 6529  ere, self.shape)
+00029e40: 0a0a 2020 2020 6465 6620 5f74 616b 6564  ..    def _taked
+00029e50: 6961 6728 7365 6c66 2c20 6178 6973 312c  iag(self, axis1,
+00029e60: 2061 7869 7332 293a 0a20 2020 2020 2020   axis2):.       
+00029e70: 2069 6620 6178 6973 3120 3c20 7365 6c66   if axis1 < self
+00029e80: 2e6e 6469 6d2d 3120 616e 6420 6178 6973  .ndim-1 and axis
+00029e90: 3220 3c20 7365 6c66 2e6e 6469 6d2d 313a  2 < self.ndim-1:
+00029ea0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00029eb0: 7572 6e20 5472 616e 7370 6f73 652e 6672  urn Transpose.fr
+00029ec0: 6f6d 5f65 6e64 286c 6f6f 705f 636f 6e63  om_end(loop_conc
+00029ed0: 6174 656e 6174 6528 5472 616e 7370 6f73  atenate(Transpos
+00029ee0: 652e 746f 5f65 6e64 285f 7461 6b65 6469  e.to_end(_takedi
+00029ef0: 6167 2873 656c 662e 6675 6e63 2c20 6178  ag(self.func, ax
+00029f00: 6973 312c 2061 7869 7332 292c 202d 3229  is1, axis2), -2)
+00029f10: 2c20 7365 6c66 2e69 6e64 6578 292c 202d  , self.index), -
+00029f20: 3229 0a0a 2020 2020 6465 6620 5f74 616b  2)..    def _tak
+00029f30: 6528 7365 6c66 2c20 696e 6465 782c 2061  e(self, index, a
+00029f40: 7869 7329 3a0a 2020 2020 2020 2020 6966  xis):.        if
+00029f50: 2061 7869 7320 3c20 7365 6c66 2e6e 6469   axis < self.ndi
+00029f60: 6d2d 313a 0a20 2020 2020 2020 2020 2020  m-1:.           
+00029f70: 2072 6574 7572 6e20 6c6f 6f70 5f63 6f6e   return loop_con
+00029f80: 6361 7465 6e61 7465 285f 7461 6b65 2873  catenate(_take(s
+00029f90: 656c 662e 6675 6e63 2c20 696e 6465 782c  elf.func, index,
+00029fa0: 2061 7869 7329 2c20 7365 6c66 2e69 6e64   axis), self.ind
+00029fb0: 6578 290a 0a20 2020 2064 6566 205f 756e  ex)..    def _un
+00029fc0: 7261 7665 6c28 7365 6c66 2c20 6178 6973  ravel(self, axis
+00029fd0: 2c20 7368 6170 6529 3a0a 2020 2020 2020  , shape):.      
+00029fe0: 2020 6966 2061 7869 7320 3c20 7365 6c66    if axis < self
+00029ff0: 2e6e 6469 6d2d 313a 0a20 2020 2020 2020  .ndim-1:.       
+0002a000: 2020 2020 2072 6574 7572 6e20 6c6f 6f70       return loop
+0002a010: 5f63 6f6e 6361 7465 6e61 7465 2875 6e72  _concatenate(unr
+0002a020: 6176 656c 2873 656c 662e 6675 6e63 2c20  avel(self.func, 
+0002a030: 6178 6973 2c20 7368 6170 6529 2c20 7365  axis, shape), se
+0002a040: 6c66 2e69 6e64 6578 290a 0a20 2020 2040  lf.index)..    @
+0002a050: 6361 6368 6564 5f70 726f 7065 7274 790a  cached_property.
+0002a060: 2020 2020 6465 6620 5f61 7373 7061 7273      def _asspars
+0002a070: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+0002a080: 2063 6875 6e6b 7320 3d20 5b5d 0a20 2020   chunks = [].   
+0002a090: 2020 2020 2066 6f72 202a 696e 6469 6365       for *indice
+0002a0a0: 732c 206c 6173 745f 696e 6465 782c 2076  s, last_index, v
+0002a0b0: 616c 7565 7320 696e 2073 656c 662e 6675  alues in self.fu
+0002a0c0: 6e63 2e5f 6173 7370 6172 7365 3a0a 2020  nc._assparse:.  
+0002a0d0: 2020 2020 2020 2020 2020 6c61 7374 5f69            last_i
+0002a0e0: 6e64 6578 203d 206c 6173 745f 696e 6465  ndex = last_inde
+0002a0f0: 7820 2b20 7072 6570 656e 6461 7865 7328  x + prependaxes(
+0002a100: 7365 6c66 2e73 7461 7274 2c20 6c61 7374  self.start, last
+0002a110: 5f69 6e64 6578 2e73 6861 7065 290a 2020  _index.shape).  
+0002a120: 2020 2020 2020 2020 2020 6368 756e 6b73            chunks
+0002a130: 2e61 7070 656e 6428 7475 706c 6528 6c6f  .append(tuple(lo
+0002a140: 6f70 5f63 6f6e 6361 7465 6e61 7465 285f  op_concatenate(_
+0002a150: 666c 6174 2861 7272 292c 2073 656c 662e  flat(arr), self.
+0002a160: 696e 6465 7829 2066 6f72 2061 7272 2069  index) for arr i
+0002a170: 6e20 282a 696e 6469 6365 732c 206c 6173  n (*indices, las
+0002a180: 745f 696e 6465 782c 2076 616c 7565 7329  t_index, values)
+0002a190: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
+0002a1a0: 6e20 7475 706c 6528 6368 756e 6b73 290a  n tuple(chunks).
+0002a1b0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+0002a1c0: 2020 2064 6566 205f 6c6f 6f70 5f63 6f6e     def _loop_con
+0002a1d0: 6361 7465 6e61 7465 5f64 6570 7328 7365  catenate_deps(se
+0002a1e0: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
+0002a1f0: 7572 6e20 2873 656c 662c 2920 2b20 7375  urn (self,) + su
+0002a200: 7065 7228 292e 5f6c 6f6f 705f 636f 6e63  per()._loop_conc
+0002a210: 6174 656e 6174 655f 6465 7073 0a0a 2020  atenate_deps..  
+0002a220: 2020 6465 6620 5f69 6e74 626f 756e 6473    def _intbounds
+0002a230: 5f69 6d70 6c28 7365 6c66 293a 0a20 2020  _impl(self):.   
+0002a240: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0002a250: 2e66 756e 632e 5f69 6e74 626f 756e 6473  .func._intbounds
+0002a260: 0a0a 0a63 6c61 7373 204c 6f6f 7043 6f6e  ...class LoopCon
+0002a270: 6361 7465 6e61 7465 436f 6d62 696e 6564  catenateCombined
+0002a280: 2845 7661 6c75 6162 6c65 293a 0a0a 2020  (Evaluable):..  
+0002a290: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+0002a2a0: 656c 662c 2066 756e 6364 6174 6173 3a20  elf, funcdatas: 
+0002a2b0: 7479 7069 6e67 2e54 7570 6c65 5b74 7970  typing.Tuple[typ
+0002a2c0: 696e 672e 5475 706c 655b 4172 7261 792c  ing.Tuple[Array,
+0002a2d0: 202e 2e2e 5d2c 202e 2e2e 5d2c 2069 6e64   ...], ...], ind
+0002a2e0: 6578 5f6e 616d 653a 2073 7472 2c20 6c65  ex_name: str, le
+0002a2f0: 6e67 7468 3a20 4172 7261 7929 3a0a 2020  ngth: Array):.  
+0002a300: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+0002a310: 6e73 7461 6e63 6528 6675 6e63 6461 7461  nstance(funcdata
+0002a320: 732c 2074 7570 6c65 2920 616e 6420 616c  s, tuple) and al
+0002a330: 6c28 6973 696e 7374 616e 6365 2866 756e  l(isinstance(fun
+0002a340: 6364 6174 612c 2074 7570 6c65 2920 616e  cdata, tuple) an
+0002a350: 6420 616c 6c28 6973 696e 7374 616e 6365  d all(isinstance
+0002a360: 2864 2c20 4172 7261 7929 2066 6f72 2064  (d, Array) for d
+0002a370: 2069 6e20 6675 6e63 6461 7461 2920 666f   in funcdata) fo
+0002a380: 7220 6675 6e63 6461 7461 2069 6e20 6675  r funcdata in fu
+0002a390: 6e63 6461 7461 7329 2c20 6627 6675 6e63  ncdatas), f'func
+0002a3a0: 6461 7461 733d 7b66 756e 6364 6174 6173  datas={funcdatas
+0002a3b0: 2172 7d27 0a20 2020 2020 2020 2061 7373  !r}'.        ass
+0002a3c0: 6572 7420 6973 696e 7374 616e 6365 2869  ert isinstance(i
+0002a3d0: 6e64 6578 5f6e 616d 652c 2073 7472 292c  ndex_name, str),
+0002a3e0: 2066 2769 6e64 6578 5f6e 616d 653d 7b69   f'index_name={i
+0002a3f0: 6e64 6578 5f6e 616d 657d 270a 2020 2020  ndex_name}'.    
+0002a400: 2020 2020 6173 7365 7274 205f 6973 696e      assert _isin
+0002a410: 6465 7828 6c65 6e67 7468 292c 2066 276c  dex(length), f'l
+0002a420: 656e 6774 683d 7b6c 656e 6774 6821 727d  ength={length!r}
+0002a430: 270a 2020 2020 2020 2020 7365 6c66 2e5f  '.        self._
+0002a440: 6675 6e63 6461 7461 7320 3d20 6675 6e63  funcdatas = func
+0002a450: 6461 7461 730a 2020 2020 2020 2020 7365  datas.        se
+0002a460: 6c66 2e5f 6675 6e63 7320 3d20 7475 706c  lf._funcs = tupl
+0002a470: 6528 6675 6e63 2066 6f72 2066 756e 632c  e(func for func,
+0002a480: 2073 7461 7274 2c20 7374 6f70 2c20 2a73   start, stop, *s
+0002a490: 6861 7065 2069 6e20 6675 6e63 6461 7461  hape in funcdata
+0002a4a0: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
+0002a4b0: 5f69 6e64 6578 5f6e 616d 6520 3d20 696e  _index_name = in
+0002a4c0: 6465 785f 6e61 6d65 0a20 2020 2020 2020  dex_name.       
+0002a4d0: 2073 656c 662e 5f69 6e64 6578 203d 206c   self._index = l
+0002a4e0: 6f6f 705f 696e 6465 7828 696e 6465 785f  oop_index(index_
+0002a4f0: 6e61 6d65 2c20 6c65 6e67 7468 290a 2020  name, length).  
+0002a500: 2020 2020 2020 6966 2061 6e79 286e 6f74        if any(not
+0002a510: 2066 756e 632e 6e64 696d 2066 6f72 2066   func.ndim for f
+0002a520: 756e 6320 696e 2073 656c 662e 5f66 756e  unc in self._fun
+0002a530: 6373 293a 0a20 2020 2020 2020 2020 2020  cs):.           
+0002a540: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0002a550: 7228 2765 7870 6563 7465 6420 616e 2061  r('expected an a
+0002a560: 7272 6179 2077 6974 6820 6174 206c 6561  rray with at lea
+0002a570: 7374 206f 6e65 2061 7869 7327 290a 2020  st one axis').  
+0002a580: 2020 2020 2020 7368 6170 6573 203d 2074        shapes = t
+0002a590: 7570 6c65 2854 7570 6c65 2874 7570 6c65  uple(Tuple(tuple
+0002a5a0: 2873 6861 7065 2929 2066 6f72 2066 756e  (shape)) for fun
+0002a5b0: 632c 2073 7461 7274 2c20 7374 6f70 2c20  c, start, stop, 
+0002a5c0: 2a73 6861 7065 2069 6e20 6675 6e63 6461  *shape in funcda
+0002a5d0: 7461 7329 0a20 2020 2020 2020 2069 6620  tas).        if 
+0002a5e0: 616e 7928 7365 6c66 2e5f 696e 6465 7820  any(self._index 
+0002a5f0: 696e 2073 6861 7065 2e61 7267 756d 656e  in shape.argumen
+0002a600: 7473 2066 6f72 2073 6861 7065 2069 6e20  ts for shape in 
+0002a610: 7368 6170 6573 293a 0a20 2020 2020 2020  shapes):.       
+0002a620: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+0002a630: 4572 726f 7228 2774 6865 2073 6861 7065  Error('the shape
+0002a640: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
+0002a650: 206d 7573 7420 6e6f 7420 6465 7065 6e64   must not depend
+0002a660: 206f 6e20 7468 6520 696e 6465 7827 290a   on the index').
+0002a670: 2020 2020 2020 2020 7365 6c66 2e5f 696e          self._in
+0002a680: 7661 7269 616e 7473 2c20 7365 6c66 2e5f  variants, self._
+0002a690: 6465 7065 6e64 656e 6369 6573 203d 205f  dependencies = _
+0002a6a0: 6465 7065 6e64 656e 6369 6573 5f73 616e  dependencies_san
+0002a6b0: 735f 696e 7661 7269 616e 7473 280a 2020  s_invariants(.  
+0002a6c0: 2020 2020 2020 2020 2020 5475 706c 6528            Tuple(
+0002a6d0: 7475 706c 6528 5475 706c 6528 2873 7461  tuple(Tuple((sta
+0002a6e0: 7274 2c20 7374 6f70 2c20 6675 6e63 2929  rt, stop, func))
+0002a6f0: 2066 6f72 2066 756e 632c 2073 7461 7274   for func, start
+0002a700: 2c20 7374 6f70 2c20 2a73 6861 7065 2069  , stop, *shape i
+0002a710: 6e20 6675 6e63 6461 7461 7329 292c 2073  n funcdatas)), s
+0002a720: 656c 662e 5f69 6e64 6578 290a 2020 2020  elf._index).    
+0002a730: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+0002a740: 6974 5f5f 2861 7267 733d 2854 7570 6c65  it__(args=(Tuple
+0002a750: 2873 6861 7065 7329 2c20 6c65 6e67 7468  (shapes), length
+0002a760: 2c20 2a73 656c 662e 5f69 6e76 6172 6961  , *self._invaria
+0002a770: 6e74 7329 290a 0a20 2020 2040 6361 6368  nts))..    @cach
+0002a780: 6564 5f70 726f 7065 7274 790a 2020 2020  ed_property.    
+0002a790: 6465 6620 5f73 6572 6961 6c69 7a65 645f  def _serialized_
+0002a7a0: 6c6f 6f70 2873 656c 6629 3a0a 2020 2020  loop(self):.    
+0002a7b0: 2020 2020 696e 6469 6365 7320 3d20 7b64      indices = {d
+0002a7c0: 3a20 6920 666f 7220 692c 2064 2069 6e20  : i for i, d in 
+0002a7d0: 656e 756d 6572 6174 6528 6974 6572 746f  enumerate(iterto
+0002a7e0: 6f6c 732e 6368 6169 6e28 5b73 656c 662e  ols.chain([self.
+0002a7f0: 5f69 6e64 6578 5d2c 2073 656c 662e 5f69  _index], self._i
+0002a800: 6e76 6172 6961 6e74 732c 2073 656c 662e  nvariants, self.
+0002a810: 5f64 6570 656e 6465 6e63 6965 7329 297d  _dependencies))}
+0002a820: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0002a830: 7475 706c 6528 2864 6570 2c20 7475 706c  tuple((dep, tupl
+0002a840: 6528 6d61 7028 696e 6469 6365 732e 5f5f  e(map(indices.__
+0002a850: 6765 7469 7465 6d5f 5f2c 2064 6570 2e5f  getitem__, dep._
+0002a860: 4576 616c 7561 626c 655f 5f61 7267 7329  Evaluable__args)
+0002a870: 2929 2066 6f72 2064 6570 2069 6e20 7365  )) for dep in se
+0002a880: 6c66 2e5f 6465 7065 6e64 656e 6369 6573  lf._dependencies
+0002a890: 290a 0a20 2020 2023 2054 6869 7320 7072  )..    # This pr
+0002a8a0: 6f70 6572 7479 2069 7320 6120 6465 7269  operty is a deri
+0002a8b0: 7661 7469 6f6e 206f 6620 605f 7365 7269  vation of `_seri
+0002a8c0: 616c 697a 6564 6020 7768 6572 6520 7468  alized` where th
+0002a8d0: 6520 6045 7661 6c75 6162 6c65 600a 2020  e `Evaluable`.  
+0002a8e0: 2020 2320 696e 7374 616e 6365 7320 6172    # instances ar
+0002a8f0: 6520 6d61 7070 6564 2074 6f20 7468 6520  e mapped to the 
+0002a900: 6065 7661 6c66 6020 6d65 7468 6f64 7320  `evalf` methods 
+0002a910: 6f66 2074 6865 2069 6e73 7461 6e63 6573  of the instances
+0002a920: 2e20 4173 7365 7274 696e 670a 2020 2020  . Asserting.    
+0002a930: 2320 7468 6174 2066 756e 6374 696f 6e73  # that functions
+0002a940: 2061 7265 2069 6d6d 7574 6162 6c65 2069   are immutable i
+0002a950: 7320 6469 6666 6963 756c 7420 616e 6420  s difficult and 
+0002a960: 6375 7272 656e 746c 790a 2020 2020 2320  currently.    # 
+0002a970: 6074 7970 6573 2e5f 6973 696d 6d75 7461  `types._isimmuta
+0002a980: 626c 6560 206d 6172 6b73 2061 6c6c 2066  ble` marks all f
+0002a990: 756e 6374 696f 6e73 2061 7320 6d75 7461  unctions as muta
+0002a9a0: 626c 652e 2053 696e 6365 2074 6865 0a20  ble. Since the. 
+0002a9b0: 2020 2023 2060 7479 7065 732e 4361 6368     # `types.Cach
+0002a9c0: 654d 6574 6160 206d 6163 6869 6e65 7279  eMeta` machinery
+0002a9d0: 2061 7373 6572 7473 2069 6d6d 7574 6162   asserts immutab
+0002a9e0: 696c 6974 7920 6f66 2074 6865 2070 726f  ility of the pro
+0002a9f0: 7065 7274 792c 2077 6520 6861 7665 0a20  perty, we have. 
+0002aa00: 2020 2023 2074 6f20 7265 736f 7274 2074     # to resort t
+0002aa10: 6f20 6120 7265 6775 6c61 7220 6066 756e  o a regular `fun
+0002aa20: 6374 6f6f 6c73 2e63 6163 6865 645f 7072  ctools.cached_pr
+0002aa30: 6f70 6572 7479 602e 204e 6576 6572 7468  operty`. Neverth
+0002aa40: 656c 6573 732c 2074 6869 730a 2020 2020  eless, this.    
+0002aa50: 2320 7072 6f70 6572 7479 2073 686f 756c  # property shoul
+0002aa60: 6420 6265 2074 7265 6174 6564 2061 7320  d be treated as 
+0002aa70: 6966 2069 7420 6973 2069 6d6d 7574 6162  if it is immutab
+0002aa80: 6c65 2e0a 2020 2020 4063 6163 6865 645f  le..    @cached_
+0002aa90: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+0002aaa0: 205f 7365 7269 616c 697a 6564 5f6c 6f6f   _serialized_loo
+0002aab0: 705f 6576 616c 6628 7365 6c66 293a 0a20  p_evalf(self):. 
+0002aac0: 2020 2020 2020 2072 6574 7572 6e20 7475         return tu
+0002aad0: 706c 6528 2864 6570 2e65 7661 6c66 2c20  ple((dep.evalf, 
+0002aae0: 696e 6469 6365 7329 2066 6f72 2064 6570  indices) for dep
+0002aaf0: 2c20 696e 6469 6365 7320 696e 2073 656c  , indices in sel
+0002ab00: 662e 5f73 6572 6961 6c69 7a65 645f 6c6f  f._serialized_lo
+0002ab10: 6f70 290a 0a20 2020 2064 6566 2065 7661  op)..    def eva
+0002ab20: 6c66 2873 656c 662c 2073 6861 7065 732c  lf(self, shapes,
+0002ab30: 206c 656e 6774 682c 202a 6172 6773 293a   length, *args):
+0002ab40: 0a20 2020 2020 2020 2073 6572 6961 6c69  .        seriali
+0002ab50: 7a65 645f 6576 616c 6620 3d20 7365 6c66  zed_evalf = self
+0002ab60: 2e5f 7365 7269 616c 697a 6564 5f6c 6f6f  ._serialized_loo
+0002ab70: 705f 6576 616c 660a 2020 2020 2020 2020  p_evalf.        
+0002ab80: 7265 7375 6c74 7320 3d20 5b70 6172 616c  results = [paral
+0002ab90: 6c65 6c2e 7368 656d 7074 7928 7475 706c  lel.shempty(tupl
+0002aba0: 6528 6d61 7028 696e 742c 2073 6861 7065  e(map(int, shape
+0002abb0: 2929 2c20 6474 7970 653d 6675 6e63 2e64  )), dtype=func.d
+0002abc0: 7479 7065 2920 666f 7220 6675 6e63 2c20  type) for func, 
+0002abd0: 7368 6170 6520 696e 207a 6970 2873 656c  shape in zip(sel
+0002abe0: 662e 5f66 756e 6373 2c20 7368 6170 6573  f._funcs, shapes
+0002abf0: 295d 0a20 2020 2020 2020 2077 6974 6820  )].        with 
+0002ac00: 7061 7261 6c6c 656c 2e63 7478 7261 6e67  parallel.ctxrang
+0002ac10: 6528 276c 6f6f 7020 7b7d 272e 666f 726d  e('loop {}'.form
+0002ac20: 6174 2873 656c 662e 5f69 6e64 6578 5f6e  at(self._index_n
+0002ac30: 616d 6529 2c20 696e 7428 6c65 6e67 7468  ame), int(length
+0002ac40: 2929 2061 7320 696e 6469 6365 733a 0a20  )) as indices:. 
+0002ac50: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0002ac60: 6e64 6578 2069 6e20 696e 6469 6365 733a  ndex in indices:
+0002ac70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ac80: 2076 616c 7565 7320 3d20 5b6e 756d 7079   values = [numpy
+0002ac90: 2e61 7272 6179 2869 6e64 6578 295d 0a20  .array(index)]. 
+0002aca0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0002acb0: 616c 7565 732e 6578 7465 6e64 2861 7267  alues.extend(arg
+0002acc0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0002acd0: 2020 2076 616c 7565 732e 6578 7465 6e64     values.extend
+0002ace0: 286f 705f 6576 616c 6628 2a5b 7661 6c75  (op_evalf(*[valu
+0002acf0: 6573 5b69 5d20 666f 7220 6920 696e 2069  es[i] for i in i
+0002ad00: 6e64 6963 6573 5d29 2066 6f72 206f 705f  ndices]) for op_
+0002ad10: 6576 616c 662c 2069 6e64 6963 6573 2069  evalf, indices i
+0002ad20: 6e20 7365 7269 616c 697a 6564 5f65 7661  n serialized_eva
+0002ad30: 6c66 290a 2020 2020 2020 2020 2020 2020  lf).            
+0002ad40: 2020 2020 666f 7220 7265 7375 6c74 2c20      for result, 
+0002ad50: 2873 7461 7274 2c20 7374 6f70 2c20 626c  (start, stop, bl
+0002ad60: 6f63 6b29 2069 6e20 7a69 7028 7265 7375  ock) in zip(resu
+0002ad70: 6c74 732c 2076 616c 7565 735b 2d31 5d29  lts, values[-1])
+0002ad80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002ad90: 2020 2020 2020 7265 7375 6c74 5b2e 2e2e        result[...
+0002ada0: 2c20 7374 6172 743a 7374 6f70 5d20 3d20  , start:stop] = 
+0002adb0: 626c 6f63 6b0a 2020 2020 2020 2020 7265  block.        re
+0002adc0: 7475 726e 2074 7570 6c65 2872 6573 756c  turn tuple(resul
+0002add0: 7473 290a 0a20 2020 2064 6566 2065 7661  ts)..    def eva
+0002ade0: 6c66 5f77 6974 6874 696d 6573 2873 656c  lf_withtimes(sel
+0002adf0: 662c 2074 696d 6573 2c20 7368 6170 6573  f, times, shapes
+0002ae00: 2c20 6c65 6e67 7468 2c20 2a61 7267 7329  , length, *args)
+0002ae10: 3a0a 2020 2020 2020 2020 7365 7269 616c  :.        serial
+0002ae20: 697a 6564 203d 2073 656c 662e 5f73 6572  ized = self._ser
+0002ae30: 6961 6c69 7a65 645f 6c6f 6f70 0a20 2020  ialized_loop.   
+0002ae40: 2020 2020 2073 7562 7469 6d65 7320 3d20       subtimes = 
+0002ae50: 7469 6d65 732e 7365 7464 6566 6175 6c74  times.setdefault
+0002ae60: 2873 656c 662c 2063 6f6c 6c65 6374 696f  (self, collectio
+0002ae70: 6e73 2e64 6566 6175 6c74 6469 6374 285f  ns.defaultdict(_
+0002ae80: 5374 6174 7329 290a 2020 2020 2020 2020  Stats)).        
+0002ae90: 7265 7375 6c74 7320 3d20 5b70 6172 616c  results = [paral
+0002aea0: 6c65 6c2e 7368 656d 7074 7928 7475 706c  lel.shempty(tupl
+0002aeb0: 6528 6d61 7028 696e 742c 2073 6861 7065  e(map(int, shape
+0002aec0: 2929 2c20 6474 7970 653d 6675 6e63 2e64  )), dtype=func.d
+0002aed0: 7479 7065 2920 666f 7220 6675 6e63 2c20  type) for func, 
+0002aee0: 7368 6170 6520 696e 207a 6970 2873 656c  shape in zip(sel
+0002aef0: 662e 5f66 756e 6373 2c20 7368 6170 6573  f._funcs, shapes
+0002af00: 295d 0a20 2020 2020 2020 2066 6f72 2069  )].        for i
+0002af10: 6e64 6578 2069 6e20 7261 6e67 6528 6c65  ndex in range(le
+0002af20: 6e67 7468 293a 0a20 2020 2020 2020 2020  ngth):.         
+0002af30: 2020 2076 616c 7565 7320 3d20 5b6e 756d     values = [num
+0002af40: 7079 2e61 7272 6179 2869 6e64 6578 295d  py.array(index)]
+0002af50: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
+0002af60: 7565 732e 6578 7465 6e64 2861 7267 7329  ues.extend(args)
+0002af70: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
+0002af80: 7565 732e 6578 7465 6e64 286f 702e 6576  ues.extend(op.ev
+0002af90: 616c 665f 7769 7468 7469 6d65 7328 7375  alf_withtimes(su
+0002afa0: 6274 696d 6573 2c20 2a5b 7661 6c75 6573  btimes, *[values
+0002afb0: 5b69 5d20 666f 7220 6920 696e 2069 6e64  [i] for i in ind
+0002afc0: 6963 6573 5d29 2066 6f72 206f 702c 2069  ices]) for op, i
+0002afd0: 6e64 6963 6573 2069 6e20 7365 7269 616c  ndices in serial
+0002afe0: 697a 6564 290a 2020 2020 2020 2020 2020  ized).          
+0002aff0: 2020 666f 7220 6675 6e63 2c20 7265 7375    for func, resu
+0002b000: 6c74 2c20 2873 7461 7274 2c20 7374 6f70  lt, (start, stop
+0002b010: 2c20 626c 6f63 6b29 2069 6e20 7a69 7028  , block) in zip(
+0002b020: 7365 6c66 2e5f 6675 6e63 732c 2072 6573  self._funcs, res
+0002b030: 756c 7473 2c20 7661 6c75 6573 5b2d 315d  ults, values[-1]
+0002b040: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0002b050: 2020 2077 6974 6820 7375 6274 696d 6573     with subtimes
+0002b060: 5b27 636f 6e63 6174 272c 2066 756e 635d  ['concat', func]
+0002b070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002b080: 2020 2020 2020 7265 7375 6c74 5b2e 2e2e        result[...
+0002b090: 2c20 7374 6172 743a 7374 6f70 5d20 3d20  , start:stop] = 
+0002b0a0: 626c 6f63 6b0a 2020 2020 2020 2020 7265  block.        re
+0002b0b0: 7475 726e 2074 7570 6c65 2872 6573 756c  turn tuple(resul
+0002b0c0: 7473 290a 0a20 2020 2064 6566 205f 6e6f  ts)..    def _no
+0002b0d0: 6465 5f74 7570 6c65 2873 656c 662c 2063  de_tuple(self, c
+0002b0e0: 6163 6865 2c20 7375 6267 7261 7068 2c20  ache, subgraph, 
+0002b0f0: 7469 6d65 7329 3a0a 2020 2020 2020 2020  times):.        
+0002b100: 6966 2028 7365 6c66 2c20 2774 7570 6c65  if (self, 'tuple
+0002b110: 2729 2069 6e20 6361 6368 653a 0a20 2020  ') in cache:.   
+0002b120: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002b130: 6361 6368 655b 7365 6c66 2c20 2774 7570  cache[self, 'tup
+0002b140: 6c65 275d 0a20 2020 2020 2020 2073 7562  le'].        sub
+0002b150: 6361 6368 6520 3d20 7b7d 0a20 2020 2020  cache = {}.     
+0002b160: 2020 2066 6f72 2061 7267 2069 6e20 7365     for arg in se
+0002b170: 6c66 2e5f 696e 7661 7269 616e 7473 3a0a  lf._invariants:.
+0002b180: 2020 2020 2020 2020 2020 2020 7375 6263              subc
+0002b190: 6163 6865 5b61 7267 5d20 3d20 6172 672e  ache[arg] = arg.
+0002b1a0: 5f6e 6f64 6528 6361 6368 652c 2073 7562  _node(cache, sub
+0002b1b0: 6772 6170 682c 2074 696d 6573 290a 2020  graph, times).  
+0002b1c0: 2020 2020 2020 6c6f 6f70 6772 6170 6820        loopgraph 
+0002b1d0: 3d20 5375 6267 7261 7068 2827 4c6f 6f70  = Subgraph('Loop
+0002b1e0: 272c 2073 7562 6772 6170 6829 0a20 2020  ', subgraph).   
+0002b1f0: 2020 2020 2073 7562 7469 6d65 7320 3d20       subtimes = 
+0002b200: 7469 6d65 732e 6765 7428 7365 6c66 2c20  times.get(self, 
+0002b210: 636f 6c6c 6563 7469 6f6e 732e 6465 6661  collections.defa
+0002b220: 756c 7464 6963 7428 5f53 7461 7473 2929  ultdict(_Stats))
+0002b230: 0a20 2020 2020 2020 2063 6f6e 6361 7473  .        concats
+0002b240: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
+0002b250: 7220 6675 6e63 2c20 7374 6172 742c 2073  r func, start, s
+0002b260: 746f 702c 202a 7368 6170 6520 696e 2073  top, *shape in s
+0002b270: 656c 662e 5f66 756e 6364 6174 6173 3a0a  elf._funcdatas:.
+0002b280: 2020 2020 2020 2020 2020 2020 636f 6e63              conc
+0002b290: 6174 5f6b 7761 7267 7320 3d20 7b27 7368  at_kwargs = {'sh
+0002b2a0: 6170 655b 7b7d 5d27 2e66 6f72 6d61 7428  ape[{}]'.format(
+0002b2b0: 6929 3a20 6e2e 5f6e 6f64 6528 6361 6368  i): n._node(cach
+0002b2c0: 652c 2073 7562 6772 6170 682c 2074 696d  e, subgraph, tim
+0002b2d0: 6573 2920 666f 7220 692c 206e 2069 6e20  es) for i, n in 
+0002b2e0: 656e 756d 6572 6174 6528 7368 6170 6529  enumerate(shape)
+0002b2f0: 7d0a 2020 2020 2020 2020 2020 2020 636f  }.            co
+0002b300: 6e63 6174 5f6b 7761 7267 735b 2773 7461  ncat_kwargs['sta
+0002b310: 7274 275d 203d 2073 7461 7274 2e5f 6e6f  rt'] = start._no
+0002b320: 6465 2873 7562 6361 6368 652c 206c 6f6f  de(subcache, loo
+0002b330: 7067 7261 7068 2c20 7375 6274 696d 6573  pgraph, subtimes
+0002b340: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
+0002b350: 6e63 6174 5f6b 7761 7267 735b 2773 746f  ncat_kwargs['sto
+0002b360: 7027 5d20 3d20 7374 6f70 2e5f 6e6f 6465  p'] = stop._node
+0002b370: 2873 7562 6361 6368 652c 206c 6f6f 7067  (subcache, loopg
+0002b380: 7261 7068 2c20 7375 6274 696d 6573 290a  raph, subtimes).
+0002b390: 2020 2020 2020 2020 2020 2020 636f 6e63              conc
+0002b3a0: 6174 5f6b 7761 7267 735b 2766 756e 6327  at_kwargs['func'
+0002b3b0: 5d20 3d20 6675 6e63 2e5f 6e6f 6465 2873  ] = func._node(s
+0002b3c0: 7562 6361 6368 652c 206c 6f6f 7067 7261  ubcache, loopgra
+0002b3d0: 7068 2c20 7375 6274 696d 6573 290a 2020  ph, subtimes).  
+0002b3e0: 2020 2020 2020 2020 2020 636f 6e63 6174            concat
+0002b3f0: 732e 6170 7065 6e64 2852 6567 756c 6172  s.append(Regular
+0002b400: 4e6f 6465 2827 4c6f 6f70 436f 6e63 6174  Node('LoopConcat
+0002b410: 656e 6174 6527 2c20 2829 2c20 636f 6e63  enate', (), conc
+0002b420: 6174 5f6b 7761 7267 732c 2028 7479 7065  at_kwargs, (type
+0002b430: 2873 656c 6629 2e5f 5f6e 616d 655f 5f2c  (self).__name__,
+0002b440: 2073 7562 7469 6d65 735b 2763 6f6e 6361   subtimes['conca
+0002b450: 7427 2c20 6675 6e63 5d29 2c20 6c6f 6f70  t', func]), loop
+0002b460: 6772 6170 6829 290a 2020 2020 2020 2020  graph)).        
+0002b470: 6361 6368 655b 7365 6c66 2c20 2774 7570  cache[self, 'tup
+0002b480: 6c65 275d 203d 2063 6f6e 6361 7473 203d  le'] = concats =
+0002b490: 2074 7570 6c65 2863 6f6e 6361 7473 290a   tuple(concats).
+0002b4a0: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+0002b4b0: 6f6e 6361 7473 0a0a 0a63 6c61 7373 2053  oncats...class S
+0002b4c0: 6561 7263 6853 6f72 7465 6428 4172 7261  earchSorted(Arra
+0002b4d0: 7929 3a0a 2020 2020 2727 2746 696e 6420  y):.    '''Find 
+0002b4e0: 696e 6465 7820 6f66 2065 7661 6c75 6162  index of evaluab
+0002b4f0: 6c65 2061 7272 6179 2069 6e74 6f20 736f  le array into so
+0002b500: 7274 6564 206e 756d 7079 2061 7272 6179  rted numpy array
+0002b510: 2e27 2727 0a0a 2020 2020 2320 4e4f 5445  .'''..    # NOTE
+0002b520: 3a20 5365 6172 6368 536f 7274 6564 2069  : SearchSorted i
+0002b530: 7320 6573 7365 6e74 6961 6c6c 7920 706f  s essentially po
+0002b540: 696e 7477 6973 6520 696e 2069 7473 206f  intwise in its o
+0002b550: 6e6c 7920 6576 616c 7561 626c 650a 2020  nly evaluable.  
+0002b560: 2020 2320 6172 6775 6d65 6e74 2c20 6275    # argument, bu
+0002b570: 7420 7468 6520 506f 696e 7477 6973 6520  t the Pointwise 
+0002b580: 636c 6173 7320 6375 7272 656e 746c 7920  class currently 
+0002b590: 646f 6573 206e 6f74 2061 6c6c 6f77 2066  does not allow f
+0002b5a0: 6f72 0a20 2020 2023 2061 6464 6974 696f  or.    # additio
+0002b5b0: 6e61 6c2c 2073 7461 7469 6320 6172 6775  nal, static argu
+0002b5c0: 6d65 6e74 732e 2054 6865 2066 6f6c 6c6f  ments. The follo
+0002b5d0: 7769 6e67 2063 6f6e 7374 7275 6374 6f72  wing constructor
+0002b5e0: 206d 616b 6573 2074 6865 2073 7461 7469   makes the stati
+0002b5f0: 630a 2020 2020 2320 6172 6775 6d65 6e74  c.    # argument
+0002b600: 7320 6b65 7977 6f72 642d 6f6e 6c79 2069  s keyword-only i
+0002b610: 6e20 616e 7469 6369 7061 7469 6f6e 206f  n anticipation o
+0002b620: 6620 706f 7465 6e74 6961 6c20 6675 7475  f potential futu
+0002b630: 7265 2073 7570 706f 7274 2e0a 0a20 2020  re support...   
+0002b640: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+0002b650: 6c66 2c20 6172 673a 2041 7272 6179 2c20  lf, arg: Array, 
+0002b660: 2a2c 2061 7272 6179 3a20 7479 7065 732e  *, array: types.
+0002b670: 6172 7261 7964 6174 612c 2073 6964 653a  arraydata, side:
+0002b680: 2073 7472 2c20 736f 7274 6572 3a20 7479   str, sorter: ty
+0002b690: 7069 6e67 2e4f 7074 696f 6e61 6c5b 7479  ping.Optional[ty
+0002b6a0: 7065 732e 6172 7261 7964 6174 615d 293a  pes.arraydata]):
+0002b6b0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002b6c0: 6973 696e 7374 616e 6365 2861 7267 2c20  isinstance(arg, 
+0002b6d0: 4172 7261 7929 2c20 6627 6172 673d 7b61  Array), f'arg={a
+0002b6e0: 7267 2172 7d27 0a20 2020 2020 2020 2061  rg!r}'.        a
+0002b6f0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+0002b700: 2861 7272 6179 2c20 7479 7065 732e 6172  (array, types.ar
+0002b710: 7261 7964 6174 6129 2061 6e64 2061 7272  raydata) and arr
+0002b720: 6179 2e6e 6469 6d20 3d3d 2031 2c20 6627  ay.ndim == 1, f'
+0002b730: 6172 7261 793d 7b61 7272 6179 2172 7d27  array={array!r}'
+0002b740: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002b750: 7369 6465 2069 6e20 2827 6c65 6674 272c  side in ('left',
+0002b760: 2027 7269 6768 7427 292c 2066 2773 6964   'right'), f'sid
+0002b770: 653d 7b73 6964 6521 727d 270a 2020 2020  e={side!r}'.    
+0002b780: 2020 2020 6173 7365 7274 2073 6f72 7465      assert sorte
+0002b790: 7220 6973 204e 6f6e 6520 6f72 2069 7369  r is None or isi
+0002b7a0: 6e73 7461 6e63 6528 736f 7274 6572 2c20  nstance(sorter, 
+0002b7b0: 7479 7065 732e 6172 7261 7964 6174 6129  types.arraydata)
+0002b7c0: 2061 6e64 2073 6f72 7465 722e 6474 7970   and sorter.dtyp
+0002b7d0: 6520 3d3d 2069 6e74 2061 6e64 2073 6f72  e == int and sor
+0002b7e0: 7465 722e 7368 6170 6520 3d3d 2061 7272  ter.shape == arr
+0002b7f0: 6179 2e73 6861 7065 2c20 6627 736f 7274  ay.shape, f'sort
+0002b800: 6572 3d7b 736f 7274 6572 2172 7d27 0a20  er={sorter!r}'. 
+0002b810: 2020 2020 2020 2073 656c 662e 5f61 7267         self._arg
+0002b820: 203d 2061 7267 0a20 2020 2020 2020 2073   = arg.        s
+0002b830: 656c 662e 5f61 7272 6179 203d 2061 7272  elf._array = arr
+0002b840: 6179 0a20 2020 2020 2020 2073 656c 662e  ay.        self.
+0002b850: 5f73 6964 6520 3d20 7369 6465 0a20 2020  _side = side.   
+0002b860: 2020 2020 2073 656c 662e 5f73 6f72 7465       self._sorte
+0002b870: 7220 3d20 736f 7274 6572 0a20 2020 2020  r = sorter.     
+0002b880: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+0002b890: 745f 5f28 6172 6773 3d28 6172 672c 292c  t__(args=(arg,),
+0002b8a0: 2073 6861 7065 3d61 7267 2e73 6861 7065   shape=arg.shape
+0002b8b0: 2c20 6474 7970 653d 696e 7429 0a0a 2020  , dtype=int)..  
+0002b8c0: 2020 6465 6620 6576 616c 6628 7365 6c66    def evalf(self
+0002b8d0: 2c20 7661 6c75 6573 293a 0a20 2020 2020  , values):.     
+0002b8e0: 2020 2069 6e64 6578 203d 206e 756d 7079     index = numpy
+0002b8f0: 2e73 6561 7263 6873 6f72 7465 6428 7365  .searchsorted(se
+0002b900: 6c66 2e5f 6172 7261 792c 2076 616c 7565  lf._array, value
+0002b910: 732c 2073 6964 653d 7365 6c66 2e5f 7369  s, side=self._si
+0002b920: 6465 2c20 736f 7274 6572 3d73 656c 662e  de, sorter=self.
+0002b930: 5f73 6f72 7465 7229 0a20 2020 2020 2020  _sorter).       
+0002b940: 2023 206f 6e20 736f 6d65 2070 6c61 7466   # on some platf
+0002b950: 6f72 6d73 2028 7769 6e64 6f77 7329 2073  orms (windows) s
+0002b960: 6561 7263 6873 6f72 7465 6420 646f 6573  earchsorted does
+0002b970: 206e 6f74 2072 6574 7572 6e20 696e 6469   not return indi
+0002b980: 6365 7320 6173 0a20 2020 2020 2020 2023  ces as.        #
+0002b990: 206e 756d 7079 2e64 7479 7065 2869 6e74   numpy.dtype(int
+0002b9a0: 292c 2073 6f20 7765 2074 7970 6520 6361  ), so we type ca
+0002b9b0: 7374 2069 7420 666f 7220 636f 6e73 6973  st it for consis
+0002b9c0: 7465 6e63 790a 2020 2020 2020 2020 7265  tency.        re
+0002b9d0: 7475 726e 2069 6e64 6578 2e61 7374 7970  turn index.astyp
+0002b9e0: 6528 696e 742c 2063 6f70 793d 4661 6c73  e(int, copy=Fals
+0002b9f0: 6529 0a0a 2020 2020 6465 6620 5f69 6e74  e)..    def _int
+0002ba00: 626f 756e 6473 5f69 6d70 6c28 7365 6c66  bounds_impl(self
+0002ba10: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+0002ba20: 6e20 302c 2073 656c 662e 5f61 7272 6179  n 0, self._array
+0002ba30: 2e73 6861 7065 5b30 5d0a 0a20 2020 2064  .shape[0]..    d
+0002ba40: 6566 205f 7461 6b65 6469 6167 2873 656c  ef _takediag(sel
+0002ba50: 662c 2061 7869 7331 2c20 6178 6973 3229  f, axis1, axis2)
+0002ba60: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0002ba70: 2053 6561 7263 6853 6f72 7465 6428 5f74   SearchSorted(_t
+0002ba80: 616b 6564 6961 6728 7365 6c66 2e5f 6172  akediag(self._ar
+0002ba90: 672c 2061 7869 7331 2c20 6178 6973 3229  g, axis1, axis2)
+0002baa0: 2c20 6172 7261 793d 7365 6c66 2e5f 6172  , array=self._ar
+0002bab0: 7261 792c 2073 6964 653d 7365 6c66 2e5f  ray, side=self._
+0002bac0: 7369 6465 2c20 736f 7274 6572 3d73 656c  side, sorter=sel
+0002bad0: 662e 5f73 6f72 7465 7229 0a0a 2020 2020  f._sorter)..    
+0002bae0: 6465 6620 5f74 616b 6528 7365 6c66 2c20  def _take(self, 
+0002baf0: 696e 6465 782c 2061 7869 7329 3a0a 2020  index, axis):.  
+0002bb00: 2020 2020 2020 7265 7475 726e 2053 6561        return Sea
+0002bb10: 7263 6853 6f72 7465 6428 5f74 616b 6528  rchSorted(_take(
+0002bb20: 7365 6c66 2e5f 6172 672c 2069 6e64 6578  self._arg, index
+0002bb30: 2c20 6178 6973 292c 2061 7272 6179 3d73  , axis), array=s
+0002bb40: 656c 662e 5f61 7272 6179 2c20 7369 6465  elf._array, side
+0002bb50: 3d73 656c 662e 5f73 6964 652c 2073 6f72  =self._side, sor
+0002bb60: 7465 723d 7365 6c66 2e5f 736f 7274 6572  ter=self._sorter
+0002bb70: 290a 0a20 2020 2064 6566 205f 756e 7261  )..    def _unra
+0002bb80: 7665 6c28 7365 6c66 2c20 6178 6973 2c20  vel(self, axis, 
+0002bb90: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
+0002bba0: 7265 7475 726e 2053 6561 7263 6853 6f72  return SearchSor
+0002bbb0: 7465 6428 756e 7261 7665 6c28 7365 6c66  ted(unravel(self
+0002bbc0: 2e5f 6172 672c 2061 7869 732c 2073 6861  ._arg, axis, sha
+0002bbd0: 7065 292c 2061 7272 6179 3d73 656c 662e  pe), array=self.
+0002bbe0: 5f61 7272 6179 2c20 7369 6465 3d73 656c  _array, side=sel
+0002bbf0: 662e 5f73 6964 652c 2073 6f72 7465 723d  f._side, sorter=
+0002bc00: 7365 6c66 2e5f 736f 7274 6572 290a 0a0a  self._sorter)...
+0002bc10: 2320 4155 5849 4c49 4152 5920 4655 4e43  # AUXILIARY FUNC
+0002bc20: 5449 4f4e 5320 2846 4f52 2049 4e54 4552  TIONS (FOR INTER
+0002bc30: 4e41 4c20 5553 4529 0a0a 0a5f 6173 6365  NAL USE)..._asce
+0002bc40: 6e64 696e 6720 3d20 6c61 6d62 6461 2061  nding = lambda a
+0002bc50: 7267 3a20 6e75 6d70 792e 6772 6561 7465  rg: numpy.greate
+0002bc60: 7228 6e75 6d70 792e 6469 6666 2861 7267  r(numpy.diff(arg
+0002bc70: 292c 2030 292e 616c 6c28 290a 0a0a 6465  ), 0).all()...de
+0002bc80: 6620 5f67 6174 6865 7262 6c6f 636b 7328  f _gatherblocks(
+0002bc90: 626c 6f63 6b73 293a 0a20 2020 2072 6574  blocks):.    ret
+0002bca0: 7572 6e20 7475 706c 6528 2869 6e64 2c20  urn tuple((ind, 
+0002bcb0: 7574 696c 2e73 756d 2866 756e 6373 2929  util.sum(funcs))
+0002bcc0: 2066 6f72 2069 6e64 2c20 6675 6e63 7320   for ind, funcs 
+0002bcd0: 696e 2075 7469 6c2e 6761 7468 6572 2862  in util.gather(b
+0002bce0: 6c6f 636b 7329 290a 0a0a 6465 6620 5f67  locks))...def _g
+0002bcf0: 6174 6865 7273 7061 7273 6563 6875 6e6b  athersparsechunk
+0002bd00: 7328 6368 756e 6b73 293a 0a20 2020 2072  s(chunks):.    r
+0002bd10: 6574 7572 6e20 7475 706c 6528 282a 696e  eturn tuple((*in
+0002bd20: 642c 2075 7469 6c2e 7375 6d28 6675 6e63  d, util.sum(func
+0002bd30: 7329 2920 666f 7220 696e 642c 2066 756e  s)) for ind, fun
+0002bd40: 6373 2069 6e20 7574 696c 2e67 6174 6865  cs in util.gathe
+0002bd50: 7228 2874 7570 6c65 2869 6e64 292c 2066  r((tuple(ind), f
+0002bd60: 756e 6329 2066 6f72 202a 696e 642c 2066  unc) for *ind, f
+0002bd70: 756e 6320 696e 2063 6875 6e6b 7329 290a  unc in chunks)).
+0002bd80: 0a0a 6465 6620 5f6e 756d 7079 5f61 6c69  ..def _numpy_ali
+0002bd90: 676e 2861 2c20 6229 3a0a 2020 2020 2727  gn(a, b):.    ''
+0002bda0: 2763 6865 636b 2073 6861 7065 2063 6f6e  'check shape con
+0002bdb0: 7369 7374 656e 6379 2061 6e64 2069 6e66  sistency and inf
+0002bdc0: 6c61 7465 2073 6361 6c61 7273 2727 270a  late scalars'''.
+0002bdd0: 0a20 2020 2061 203d 2061 7361 7272 6179  .    a = asarray
+0002bde0: 2861 290a 2020 2020 6220 3d20 6173 6172  (a).    b = asar
+0002bdf0: 7261 7928 6229 0a20 2020 2069 6620 612e  ray(b).    if a.
+0002be00: 6474 7970 6520 213d 2062 2e64 7479 7065  dtype != b.dtype
+0002be10: 3a0a 2020 2020 2020 2020 6966 205f 7479  :.        if _ty
+0002be20: 7065 5f6f 7264 6572 2e69 6e64 6578 2861  pe_order.index(a
+0002be30: 2e64 7479 7065 2920 3c20 5f74 7970 655f  .dtype) < _type_
+0002be40: 6f72 6465 722e 696e 6465 7828 622e 6474  order.index(b.dt
+0002be50: 7970 6529 3a0a 2020 2020 2020 2020 2020  ype):.          
+0002be60: 2020 6120 3d20 6173 7479 7065 2861 2c20    a = astype(a, 
+0002be70: 622e 6474 7970 6529 0a20 2020 2020 2020  b.dtype).       
+0002be80: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002be90: 2020 2062 203d 2061 7374 7970 6528 622c     b = astype(b,
+0002bea0: 2061 2e64 7479 7065 290a 2020 2020 6966   a.dtype).    if
+0002beb0: 206e 6f74 2061 2e6e 6469 6d3a 0a20 2020   not a.ndim:.   
+0002bec0: 2020 2020 2072 6574 7572 6e20 5f69 6e66       return _inf
+0002bed0: 6c61 7465 5f73 6361 6c61 7228 612c 2062  late_scalar(a, b
+0002bee0: 2e73 6861 7065 292c 2062 0a20 2020 2069  .shape), b.    i
+0002bef0: 6620 6e6f 7420 622e 6e64 696d 3a0a 2020  f not b.ndim:.  
+0002bf00: 2020 2020 2020 7265 7475 726e 2061 2c20        return a, 
+0002bf10: 5f69 6e66 6c61 7465 5f73 6361 6c61 7228  _inflate_scalar(
+0002bf20: 622c 2061 2e73 6861 7065 290a 2020 2020  b, a.shape).    
+0002bf30: 6966 2065 7175 616c 7368 6170 6528 612e  if equalshape(a.
+0002bf40: 7368 6170 652c 2062 2e73 6861 7065 293a  shape, b.shape):
+0002bf50: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0002bf60: 612c 2062 0a20 2020 2072 6169 7365 2056  a, b.    raise V
+0002bf70: 616c 7565 4572 726f 7228 2769 6e63 6f6d  alueError('incom
+0002bf80: 7061 7469 626c 6520 7368 6170 6573 3a20  patible shapes: 
+0002bf90: 7b7d 2021 3d20 7b7d 272e 666f 726d 6174  {} != {}'.format
+0002bfa0: 282a 5b74 7570 6c65 2869 6e74 286e 2920  (*[tuple(int(n) 
+0002bfb0: 6966 206e 2e69 7363 6f6e 7374 616e 7420  if n.isconstant 
+0002bfc0: 656c 7365 206e 2066 6f72 206e 2069 6e20  else n for n in 
+0002bfd0: 6172 672e 7368 6170 6529 2066 6f72 2061  arg.shape) for a
+0002bfe0: 7267 2069 6e20 2861 2c20 6229 5d29 290a  rg in (a, b)])).
+0002bff0: 0a0a 6465 6620 5f69 6e66 6c61 7465 5f73  ..def _inflate_s
+0002c000: 6361 6c61 7228 6172 672c 2073 6861 7065  calar(arg, shape
+0002c010: 293a 0a20 2020 2061 7267 203d 2061 7361  ):.    arg = asa
+0002c020: 7272 6179 2861 7267 290a 2020 2020 6173  rray(arg).    as
+0002c030: 7365 7274 2061 7267 2e6e 6469 6d20 3d3d  sert arg.ndim ==
+0002c040: 2030 0a20 2020 2066 6f72 2069 6469 6d2c   0.    for idim,
+0002c050: 206c 656e 6774 6820 696e 2065 6e75 6d65   length in enume
+0002c060: 7261 7465 2873 6861 7065 293a 0a20 2020  rate(shape):.   
+0002c070: 2020 2020 2061 7267 203d 2069 6e73 6572       arg = inser
+0002c080: 7461 7869 7328 6172 672c 2069 6469 6d2c  taxis(arg, idim,
+0002c090: 206c 656e 6774 6829 0a20 2020 2072 6574   length).    ret
+0002c0a0: 7572 6e20 6172 670a 0a0a 6465 6620 5f69  urn arg...def _i
+0002c0b0: 7375 6e69 7175 6528 6172 7261 7929 3a0a  sunique(array):.
+0002c0c0: 2020 2020 7265 7475 726e 206e 756d 7079      return numpy
+0002c0d0: 2e75 6e69 7175 6528 6172 7261 7929 2e73  .unique(array).s
+0002c0e0: 697a 6520 3d3d 2061 7272 6179 2e73 697a  ize == array.siz
+0002c0f0: 650a 0a0a 6465 6620 5f64 6570 656e 6465  e...def _depende
+0002c100: 6e63 6965 735f 7361 6e73 5f69 6e76 6172  ncies_sans_invar
+0002c110: 6961 6e74 7328 6675 6e63 2c20 6172 6729  iants(func, arg)
+0002c120: 3a0a 2020 2020 696e 7661 7269 616e 7473  :.    invariants
+0002c130: 203d 205b 5d0a 2020 2020 6465 7065 6e64   = [].    depend
+0002c140: 656e 6369 6573 203d 205b 5d0a 2020 2020  encies = [].    
+0002c150: 5f70 6f70 756c 6174 655f 6465 7065 6e64  _populate_depend
+0002c160: 656e 6369 6573 5f73 616e 735f 696e 7661  encies_sans_inva
+0002c170: 7269 616e 7473 2866 756e 632c 2061 7267  riants(func, arg
+0002c180: 2c20 696e 7661 7269 616e 7473 2c20 6465  , invariants, de
+0002c190: 7065 6e64 656e 6369 6573 2c20 7b61 7267  pendencies, {arg
+0002c1a0: 7d29 0a20 2020 2061 7373 6572 7420 2864  }).    assert (d
+0002c1b0: 6570 656e 6465 6e63 6965 7320 6f72 2069  ependencies or i
+0002c1c0: 6e76 6172 6961 6e74 7320 6f72 205b 6172  nvariants or [ar
+0002c1d0: 675d 295b 2d31 5d20 3d3d 2066 756e 630a  g])[-1] == func.
+0002c1e0: 2020 2020 7265 7475 726e 2074 7570 6c65      return tuple
+0002c1f0: 2869 6e76 6172 6961 6e74 7329 2c20 7475  (invariants), tu
+0002c200: 706c 6528 6465 7065 6e64 656e 6369 6573  ple(dependencies
+0002c210: 290a 0a0a 6465 6620 5f70 6f70 756c 6174  )...def _populat
+0002c220: 655f 6465 7065 6e64 656e 6369 6573 5f73  e_dependencies_s
+0002c230: 616e 735f 696e 7661 7269 616e 7473 2866  ans_invariants(f
+0002c240: 756e 632c 2061 7267 2c20 696e 7661 7269  unc, arg, invari
+0002c250: 616e 7473 2c20 6465 7065 6e64 656e 6369  ants, dependenci
+0002c260: 6573 2c20 6361 6368 6529 3a0a 2020 2020  es, cache):.    
+0002c270: 6966 2066 756e 6320 696e 2063 6163 6865  if func in cache
+0002c280: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0002c290: 0a20 2020 2063 6163 6865 2e61 6464 2866  .    cache.add(f
+0002c2a0: 756e 6329 0a20 2020 2069 6620 6172 6720  unc).    if arg 
+0002c2b0: 696e 2066 756e 632e 6172 6775 6d65 6e74  in func.argument
+0002c2c0: 733a 0a20 2020 2020 2020 2066 6f72 2063  s:.        for c
+0002c2d0: 6869 6c64 2069 6e20 6675 6e63 2e5f 4576  hild in func._Ev
+0002c2e0: 616c 7561 626c 655f 5f61 7267 733a 0a20  aluable__args:. 
+0002c2f0: 2020 2020 2020 2020 2020 205f 706f 7075             _popu
+0002c300: 6c61 7465 5f64 6570 656e 6465 6e63 6965  late_dependencie
+0002c310: 735f 7361 6e73 5f69 6e76 6172 6961 6e74  s_sans_invariant
+0002c320: 7328 6368 696c 642c 2061 7267 2c20 696e  s(child, arg, in
+0002c330: 7661 7269 616e 7473 2c20 6465 7065 6e64  variants, depend
+0002c340: 656e 6369 6573 2c20 6361 6368 6529 0a20  encies, cache). 
+0002c350: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
+0002c360: 6965 732e 6170 7065 6e64 2866 756e 6329  ies.append(func)
+0002c370: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0002c380: 2020 2069 6e76 6172 6961 6e74 732e 6170     invariants.ap
+0002c390: 7065 6e64 2866 756e 6329 0a0a 0a63 6c61  pend(func)...cla
+0002c3a0: 7373 205f 5374 6174 733a 0a0a 2020 2020  ss _Stats:..    
+0002c3b0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+0002c3c0: 662c 206e 6361 6c6c 733a 2069 6e74 203d  f, ncalls: int =
+0002c3d0: 2030 2c20 7469 6d65 3a20 696e 7420 3d20   0, time: int = 
+0002c3e0: 3029 202d 3e20 4e6f 6e65 3a0a 2020 2020  0) -> None:.    
+0002c3f0: 2020 2020 7365 6c66 2e6e 6361 6c6c 7320      self.ncalls 
+0002c400: 3d20 6e63 616c 6c73 0a20 2020 2020 2020  = ncalls.       
+0002c410: 2073 656c 662e 7469 6d65 203d 2074 696d   self.time = tim
+0002c420: 650a 2020 2020 2020 2020 7365 6c66 2e5f  e.        self._
+0002c430: 7374 6172 7420 3d20 4e6f 6e65 0a0a 2020  start = None..  
+0002c440: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
+0002c450: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+0002c460: 7475 726e 2027 5f53 7461 7473 286e 6361  turn '_Stats(nca
+0002c470: 6c6c 733d 7b7d 2c20 7469 6d65 3d7b 7d29  lls={}, time={})
+0002c480: 272e 666f 726d 6174 2873 656c 662e 6e63  '.format(self.nc
+0002c490: 616c 6c73 2c20 7365 6c66 2e74 696d 6529  alls, self.time)
+0002c4a0: 0a0a 2020 2020 6465 6620 5f5f 6164 645f  ..    def __add_
+0002c4b0: 5f28 7365 6c66 2c20 6f74 6865 7229 3a0a  _(self, other):.
+0002c4c0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
+0002c4d0: 7369 6e73 7461 6e63 6528 6f74 6865 722c  sinstance(other,
+0002c4e0: 205f 5374 6174 7329 3a0a 2020 2020 2020   _Stats):.      
+0002c4f0: 2020 2020 2020 7265 7475 726e 204e 6f74        return Not
+0002c500: 496d 706c 656d 656e 7465 640a 2020 2020  Implemented.    
+0002c510: 2020 2020 7265 7475 726e 205f 5374 6174      return _Stat
+0002c520: 7328 7365 6c66 2e6e 6361 6c6c 732b 6f74  s(self.ncalls+ot
+0002c530: 6865 722e 6e63 616c 6c73 2c20 7365 6c66  her.ncalls, self
+0002c540: 2e74 696d 652b 6f74 6865 722e 7469 6d65  .time+other.time
+0002c550: 290a 0a20 2020 2064 6566 205f 5f65 6e74  )..    def __ent
+0002c560: 6572 5f5f 2873 656c 6629 202d 3e20 4e6f  er__(self) -> No
+0002c570: 6e65 3a0a 2020 2020 2020 2020 7365 6c66  ne:.        self
+0002c580: 2e5f 7374 6172 7420 3d20 7469 6d65 2e70  ._start = time.p
+0002c590: 6572 665f 636f 756e 7465 725f 6e73 2829  erf_counter_ns()
+0002c5a0: 0a0a 2020 2020 6465 6620 5f5f 6578 6974  ..    def __exit
+0002c5b0: 5f5f 2873 656c 662c 202a 6578 635f 696e  __(self, *exc_in
+0002c5c0: 666f 2920 2d3e 204e 6f6e 653a 0a20 2020  fo) -> None:.   
+0002c5d0: 2020 2020 2073 656c 662e 7469 6d65 202b       self.time +
+0002c5e0: 3d20 7469 6d65 2e70 6572 665f 636f 756e  = time.perf_coun
+0002c5f0: 7465 725f 6e73 2829 202d 2073 656c 662e  ter_ns() - self.
+0002c600: 5f73 7461 7274 0a20 2020 2020 2020 2073  _start.        s
+0002c610: 656c 662e 6e63 616c 6c73 202b 3d20 310a  elf.ncalls += 1.
+0002c620: 0a23 2046 554e 4354 494f 4e53 0a0a 0a64  .# FUNCTIONS...d
+0002c630: 6566 2069 7361 7272 6179 2861 7267 293a  ef isarray(arg):
+0002c640: 0a20 2020 2072 6574 7572 6e20 6973 696e  .    return isin
+0002c650: 7374 616e 6365 2861 7267 2c20 4172 7261  stance(arg, Arra
+0002c660: 7929 0a0a 0a64 6566 205f 636f 6e74 6169  y)...def _contai
+0002c670: 6e73 6172 7261 7928 6172 6729 3a0a 2020  nsarray(arg):.  
+0002c680: 2020 7265 7475 726e 2061 6e79 286d 6170    return any(map
+0002c690: 285f 636f 6e74 6169 6e73 6172 7261 792c  (_containsarray,
+0002c6a0: 2061 7267 2929 2069 6620 6973 696e 7374   arg)) if isinst
+0002c6b0: 616e 6365 2861 7267 2c20 286c 6973 742c  ance(arg, (list,
+0002c6c0: 2074 7570 6c65 2929 2065 6c73 6520 6973   tuple)) else is
+0002c6d0: 6172 7261 7928 6172 6729 0a0a 0a64 6566  array(arg)...def
+0002c6e0: 2063 6f6e 7374 616e 7428 7629 3a0a 2020   constant(v):.  
+0002c6f0: 2020 7265 7475 726e 2043 6f6e 7374 616e    return Constan
+0002c700: 7428 7479 7065 732e 6172 7261 7964 6174  t(types.arraydat
+0002c710: 6128 7629 290a 0a0a 6465 6620 6973 7a65  a(v))...def isze
+0002c720: 726f 2861 7267 293a 0a20 2020 2072 6574  ro(arg):.    ret
+0002c730: 7572 6e20 6973 696e 7374 616e 6365 2861  urn isinstance(a
+0002c740: 7267 2e73 696d 706c 6966 6965 642c 205a  rg.simplified, Z
+0002c750: 6572 6f73 290a 0a0a 6465 6620 7a65 726f  eros)...def zero
+0002c760: 7328 7368 6170 652c 2064 7479 7065 3d66  s(shape, dtype=f
+0002c770: 6c6f 6174 293a 0a20 2020 2072 6574 7572  loat):.    retur
+0002c780: 6e20 5a65 726f 7328 7368 6170 652c 2064  n Zeros(shape, d
+0002c790: 7479 7065 290a 0a0a 6465 6620 7a65 726f  type)...def zero
+0002c7a0: 735f 6c69 6b65 2861 7272 293a 0a20 2020  s_like(arr):.   
+0002c7b0: 2072 6574 7572 6e20 7a65 726f 7328 6172   return zeros(ar
+0002c7c0: 722e 7368 6170 652c 2061 7272 2e64 7479  r.shape, arr.dty
+0002c7d0: 7065 290a 0a0a 6465 6620 6f6e 6573 2873  pe)...def ones(s
+0002c7e0: 6861 7065 2c20 6474 7970 653d 666c 6f61  hape, dtype=floa
+0002c7f0: 7429 3a0a 2020 2020 7265 7475 726e 205f  t):.    return _
+0002c800: 696e 666c 6174 655f 7363 616c 6172 2863  inflate_scalar(c
+0002c810: 6f6e 7374 616e 7428 6474 7970 6528 3129  onstant(dtype(1)
+0002c820: 292c 2073 6861 7065 290a 0a0a 6465 6620  ), shape)...def 
+0002c830: 6f6e 6573 5f6c 696b 6528 6172 7229 3a0a  ones_like(arr):.
+0002c840: 2020 2020 7265 7475 726e 206f 6e65 7328      return ones(
+0002c850: 6172 722e 7368 6170 652c 2061 7272 2e64  arr.shape, arr.d
+0002c860: 7479 7065 290a 0a0a 6465 6620 7265 6369  type)...def reci
+0002c870: 7072 6f63 616c 2861 7267 293a 0a20 2020  procal(arg):.   
+0002c880: 2072 6574 7572 6e20 706f 7765 7228 6172   return power(ar
+0002c890: 672c 2061 7374 7970 6528 2d31 2c20 666c  g, astype(-1, fl
+0002c8a0: 6f61 7429 290a 0a0a 6465 6620 6e65 6761  oat))...def nega
+0002c8b0: 7469 7665 2861 7267 293a 0a20 2020 2072  tive(arg):.    r
+0002c8c0: 6574 7572 6e20 6d75 6c74 6970 6c79 2861  eturn multiply(a
+0002c8d0: 7267 2c20 2d31 290a 0a0a 6465 6620 7369  rg, -1)...def si
+0002c8e0: 6e28 7829 3a0a 2020 2020 7265 7475 726e  n(x):.    return
+0002c8f0: 2053 696e 2878 290a 0a0a 6465 6620 636f   Sin(x)...def co
+0002c900: 7328 7829 3a0a 2020 2020 7265 7475 726e  s(x):.    return
+0002c910: 2043 6f73 2878 290a 0a0a 6465 6620 7461   Cos(x)...def ta
+0002c920: 6e28 7829 3a0a 2020 2020 7265 7475 726e  n(x):.    return
+0002c930: 2054 616e 2878 290a 0a0a 6465 6620 6172   Tan(x)...def ar
+0002c940: 6373 696e 2878 293a 0a20 2020 2072 6574  csin(x):.    ret
+0002c950: 7572 6e20 4172 6353 696e 2878 290a 0a0a  urn ArcSin(x)...
+0002c960: 6465 6620 6172 6363 6f73 2878 293a 0a20  def arccos(x):. 
+0002c970: 2020 2072 6574 7572 6e20 4172 6343 6f73     return ArcCos
+0002c980: 2878 290a 0a0a 6465 6620 6172 6374 616e  (x)...def arctan
+0002c990: 2878 293a 0a20 2020 2072 6574 7572 6e20  (x):.    return 
+0002c9a0: 4172 6354 616e 2878 290a 0a0a 6465 6620  ArcTan(x)...def 
+0002c9b0: 7369 6e63 2878 293a 0a20 2020 2072 6574  sinc(x):.    ret
+0002c9c0: 7572 6e20 5369 6e63 2878 2c20 6e3d 3029  urn Sinc(x, n=0)
+0002c9d0: 0a0a 0a64 6566 2065 7870 2878 293a 0a20  ...def exp(x):. 
+0002c9e0: 2020 2072 6574 7572 6e20 4578 7028 7829     return Exp(x)
+0002c9f0: 0a0a 0a64 6566 206c 6e28 7829 3a0a 2020  ...def ln(x):.  
+0002ca00: 2020 7265 7475 726e 204c 6f67 2878 290a    return Log(x).
+0002ca10: 0a0a 6465 6620 6469 766d 6f64 2878 2c20  ..def divmod(x, 
+0002ca20: 7929 3a0a 2020 2020 6469 7620 3d20 466c  y):.    div = Fl
+0002ca30: 6f6f 7244 6976 6964 6528 2a5f 6e75 6d70  oorDivide(*_nump
+0002ca40: 795f 616c 6967 6e28 782c 2079 2929 0a20  y_align(x, y)). 
+0002ca50: 2020 206d 6f64 203d 2078 202d 2064 6976     mod = x - div
+0002ca60: 202a 2079 0a20 2020 2072 6574 7572 6e20   * y.    return 
+0002ca70: 6469 762c 206d 6f64 0a0a 0a64 6566 206d  div, mod...def m
+0002ca80: 6f64 2861 7267 312c 2061 7267 3229 3a0a  od(arg1, arg2):.
+0002ca90: 2020 2020 7265 7475 726e 204d 6f64 282a      return Mod(*
+0002caa0: 5f6e 756d 7079 5f61 6c69 676e 2861 7267  _numpy_align(arg
+0002cab0: 312c 2061 7267 3229 290a 0a0a 6465 6620  1, arg2))...def 
+0002cac0: 6c6f 6732 2861 7267 293a 0a20 2020 2072  log2(arg):.    r
+0002cad0: 6574 7572 6e20 6c6e 2861 7267 2920 2f20  eturn ln(arg) / 
+0002cae0: 636f 6e73 7461 6e74 286e 756d 7079 2e6c  constant(numpy.l
+0002caf0: 6f67 2832 2929 0a0a 0a64 6566 206c 6f67  og(2))...def log
+0002cb00: 3130 2861 7267 293a 0a20 2020 2072 6574  10(arg):.    ret
+0002cb10: 7572 6e20 6c6e 2861 7267 2920 2f20 636f  urn ln(arg) / co
+0002cb20: 6e73 7461 6e74 286e 756d 7079 2e6c 6f67  nstant(numpy.log
+0002cb30: 2831 3029 290a 0a0a 6465 6620 7371 7274  (10))...def sqrt
+0002cb40: 2861 7267 293a 0a20 2020 2072 6574 7572  (arg):.    retur
+0002cb50: 6e20 706f 7765 7228 6172 672c 2063 6f6e  n power(arg, con
+0002cb60: 7374 616e 7428 2e35 2929 0a0a 0a64 6566  stant(.5))...def
+0002cb70: 2061 7263 7461 6e32 2861 7267 312c 2061   arctan2(arg1, a
+0002cb80: 7267 3229 3a0a 2020 2020 7265 7475 726e  rg2):.    return
+0002cb90: 2041 7263 5461 6e32 282a 5f6e 756d 7079   ArcTan2(*_numpy
+0002cba0: 5f61 6c69 676e 2861 7267 312c 2061 7267  _align(arg1, arg
+0002cbb0: 3229 290a 0a0a 6465 6620 6162 7328 6172  2))...def abs(ar
+0002cbc0: 6729 3a0a 2020 2020 6966 2061 7267 2e64  g):.    if arg.d
+0002cbd0: 7479 7065 203d 3d20 636f 6d70 6c65 783a  type == complex:
+0002cbe0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0002cbf0: 7371 7274 2861 7267 2e72 6561 6c2a 2a32  sqrt(arg.real**2
+0002cc00: 202b 2061 7267 2e69 6d61 672a 2a32 290a   + arg.imag**2).
+0002cc10: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002cc20: 2020 7265 7475 726e 2061 7267 202a 2073    return arg * s
+0002cc30: 6967 6e28 6172 6729 0a0a 0a64 6566 2073  ign(arg)...def s
+0002cc40: 696e 6828 6172 6729 3a0a 2020 2020 7265  inh(arg):.    re
+0002cc50: 7475 726e 2053 696e 4828 6172 6729 0a0a  turn SinH(arg)..
+0002cc60: 0a64 6566 2063 6f73 6828 6172 6729 3a0a  .def cosh(arg):.
+0002cc70: 2020 2020 7265 7475 726e 2043 6f73 4828      return CosH(
+0002cc80: 6172 6729 0a0a 0a64 6566 2074 616e 6828  arg)...def tanh(
+0002cc90: 6172 6729 3a0a 2020 2020 7265 7475 726e  arg):.    return
+0002cca0: 2054 616e 4828 6172 6729 0a0a 0a64 6566   TanH(arg)...def
+0002ccb0: 2061 7263 7461 6e68 2861 7267 293a 0a20   arctanh(arg):. 
+0002ccc0: 2020 2072 6574 7572 6e20 4172 6354 616e     return ArcTan
+0002ccd0: 4828 6172 6729 0a0a 0a64 6566 2064 6976  H(arg)...def div
+0002cce0: 6964 6528 6172 6731 2c20 6172 6732 293a  ide(arg1, arg2):
+0002ccf0: 0a20 2020 2072 6574 7572 6e20 6d75 6c74  .    return mult
+0002cd00: 6970 6c79 2861 7267 312c 2072 6563 6970  iply(arg1, recip
+0002cd10: 726f 6361 6c28 6172 6732 2929 0a0a 0a64  rocal(arg2))...d
+0002cd20: 6566 2073 7562 7472 6163 7428 6172 6731  ef subtract(arg1
+0002cd30: 2c20 6172 6732 293a 0a20 2020 2072 6574  , arg2):.    ret
+0002cd40: 7572 6e20 6164 6428 6172 6731 2c20 6e65  urn add(arg1, ne
+0002cd50: 6761 7469 7665 2861 7267 3229 290a 0a0a  gative(arg2))...
+0002cd60: 6465 6620 696e 7365 7274 6178 6973 2861  def insertaxis(a
+0002cd70: 7267 2c20 6e2c 206c 656e 6774 6829 3a0a  rg, n, length):.
+0002cd80: 2020 2020 7265 7475 726e 2054 7261 6e73      return Trans
+0002cd90: 706f 7365 2e66 726f 6d5f 656e 6428 496e  pose.from_end(In
+0002cda0: 7365 7274 4178 6973 2861 7267 2c20 6c65  sertAxis(arg, le
+0002cdb0: 6e67 7468 292c 206e 290a 0a0a 6465 6620  ngth), n)...def 
+0002cdc0: 636f 6e63 6174 656e 6174 6528 6172 6773  concatenate(args
+0002cdd0: 2c20 6178 6973 3d30 293a 0a20 2020 206c  , axis=0):.    l
+0002cde0: 656e 6774 6873 203d 205b 6172 672e 7368  engths = [arg.sh
+0002cdf0: 6170 655b 6178 6973 5d20 666f 7220 6172  ape[axis] for ar
+0002ce00: 6720 696e 2061 7267 735d 0a20 2020 202a  g in args].    *
+0002ce10: 6f66 6673 6574 732c 2074 6f74 6c65 6e67  offsets, totleng
+0002ce20: 7468 203d 2075 7469 6c2e 6375 6d73 756d  th = util.cumsum
+0002ce30: 286c 656e 6774 6873 202b 205b 305d 290a  (lengths + [0]).
+0002ce40: 2020 2020 7265 7475 726e 2054 7261 6e73      return Trans
+0002ce50: 706f 7365 2e66 726f 6d5f 656e 6428 7574  pose.from_end(ut
+0002ce60: 696c 2e73 756d 2849 6e66 6c61 7465 2854  il.sum(Inflate(T
+0002ce70: 7261 6e73 706f 7365 2e74 6f5f 656e 6428  ranspose.to_end(
+0002ce80: 6172 672c 2061 7869 7329 2c20 5261 6e67  arg, axis), Rang
+0002ce90: 6528 6c65 6e67 7468 2920 2b20 6f66 6673  e(length) + offs
+0002cea0: 6574 2c20 746f 746c 656e 6774 6829 2066  et, totlength) f
+0002ceb0: 6f72 2061 7267 2c20 6c65 6e67 7468 2c20  or arg, length, 
+0002cec0: 6f66 6673 6574 2069 6e20 7a69 7028 6172  offset in zip(ar
+0002ced0: 6773 2c20 6c65 6e67 7468 732c 206f 6666  gs, lengths, off
+0002cee0: 7365 7473 2929 2c20 6178 6973 290a 0a0a  sets)), axis)...
+0002cef0: 6465 6620 7374 6163 6b28 6172 6773 2c20  def stack(args, 
+0002cf00: 6178 6973 3d30 293a 0a20 2020 2072 6574  axis=0):.    ret
+0002cf10: 7572 6e20 5472 616e 7370 6f73 652e 6672  urn Transpose.fr
+0002cf20: 6f6d 5f65 6e64 2875 7469 6c2e 7375 6d28  om_end(util.sum(
+0002cf30: 496e 666c 6174 6528 6172 672c 2063 6f6e  Inflate(arg, con
+0002cf40: 7374 616e 7428 6929 2c20 636f 6e73 7461  stant(i), consta
+0002cf50: 6e74 286c 656e 2861 7267 7329 2929 2066  nt(len(args))) f
+0002cf60: 6f72 2069 2c20 6172 6720 696e 2065 6e75  or i, arg in enu
+0002cf70: 6d65 7261 7465 2861 7267 7329 292c 2061  merate(args)), a
+0002cf80: 7869 7329 0a0a 0a64 6566 2072 6570 6561  xis)...def repea
+0002cf90: 7428 6172 672c 206c 656e 6774 682c 2061  t(arg, length, a
+0002cfa0: 7869 7329 3a0a 2020 2020 6172 6720 3d20  xis):.    arg = 
+0002cfb0: 6173 6172 7261 7928 6172 6729 0a20 2020  asarray(arg).   
+0002cfc0: 2061 7373 6572 7420 5f65 7175 616c 735f   assert _equals_
+0002cfd0: 7363 616c 6172 5f63 6f6e 7374 616e 7428  scalar_constant(
+0002cfe0: 6172 672e 7368 6170 655b 6178 6973 5d2c  arg.shape[axis],
+0002cff0: 2031 290a 2020 2020 7265 7475 726e 2069   1).    return i
+0002d000: 6e73 6572 7461 7869 7328 6765 7428 6172  nsertaxis(get(ar
+0002d010: 672c 2061 7869 732c 2063 6f6e 7374 616e  g, axis, constan
+0002d020: 7428 3029 292c 2061 7869 732c 206c 656e  t(0)), axis, len
+0002d030: 6774 6829 0a0a 0a64 6566 2067 6574 2861  gth)...def get(a
+0002d040: 7267 2c20 6961 782c 2069 7465 6d29 3a0a  rg, iax, item):.
+0002d050: 2020 2020 6966 206e 756d 6572 6963 2e69      if numeric.i
+0002d060: 7369 6e74 2869 7465 6d29 3a0a 2020 2020  sint(item):.    
+0002d070: 2020 2020 6966 206e 756d 6572 6963 2e69      if numeric.i
+0002d080: 7369 6e74 2861 7267 2e73 6861 7065 5b69  sint(arg.shape[i
+0002d090: 6178 5d29 3a0a 2020 2020 2020 2020 2020  ax]):.          
+0002d0a0: 2020 6974 656d 203d 206e 756d 6572 6963    item = numeric
+0002d0b0: 2e6e 6f72 6d64 696d 2861 7267 2e73 6861  .normdim(arg.sha
+0002d0c0: 7065 5b69 6178 5d2c 2069 7465 6d29 0a20  pe[iax], item). 
+0002d0d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002d0e0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002d0f0: 6974 656d 203e 3d20 300a 2020 2020 7265  item >= 0.    re
+0002d100: 7475 726e 2054 616b 6528 5472 616e 7370  turn Take(Transp
+0002d110: 6f73 652e 746f 5f65 6e64 2861 7267 2c20  ose.to_end(arg, 
+0002d120: 6961 7829 2c20 6974 656d 290a 0a0a 6465  iax), item)...de
+0002d130: 6620 6465 7465 726d 696e 616e 7428 6172  f determinant(ar
+0002d140: 672c 2061 7865 733d 282d 322c 202d 3129  g, axes=(-2, -1)
+0002d150: 293a 0a20 2020 2072 6574 7572 6e20 4465  ):.    return De
+0002d160: 7465 726d 696e 616e 7428 5472 616e 7370  terminant(Transp
+0002d170: 6f73 652e 746f 5f65 6e64 2861 7267 2c20  ose.to_end(arg, 
+0002d180: 2a61 7865 7329 290a 0a0a 6465 6620 6772  *axes))...def gr
+0002d190: 616d 6d69 756d 2861 7267 2c20 6178 6573  ammium(arg, axes
+0002d1a0: 3d28 2d32 2c20 2d31 2929 3a0a 2020 2020  =(-2, -1)):.    
+0002d1b0: 6172 6720 3d20 5472 616e 7370 6f73 652e  arg = Transpose.
+0002d1c0: 746f 5f65 6e64 2861 7267 2c20 2a61 7865  to_end(arg, *axe
+0002d1d0: 7329 0a20 2020 2067 7261 6d6d 6975 6d20  s).    grammium 
+0002d1e0: 3d20 6569 6e73 756d 2827 416b 692c 416b  = einsum('Aki,Ak
+0002d1f0: 6a2d 3e41 696a 272c 2061 7267 2c20 6172  j->Aij', arg, ar
+0002d200: 6729 0a20 2020 2072 6574 7572 6e20 5472  g).    return Tr
+0002d210: 616e 7370 6f73 652e 6672 6f6d 5f65 6e64  anspose.from_end
+0002d220: 2867 7261 6d6d 6975 6d2c 202a 6178 6573  (grammium, *axes
+0002d230: 290a 0a0a 6465 6620 7371 7274 5f61 6273  )...def sqrt_abs
+0002d240: 5f64 6574 5f67 7261 6d28 6172 672c 2061  _det_gram(arg, a
+0002d250: 7865 733d 282d 322c 202d 3129 293a 0a20  xes=(-2, -1)):. 
+0002d260: 2020 2061 7267 203d 2054 7261 6e73 706f     arg = Transpo
+0002d270: 7365 2e74 6f5f 656e 6428 6172 672c 202a  se.to_end(arg, *
+0002d280: 6178 6573 290a 2020 2020 6966 205f 6571  axes).    if _eq
+0002d290: 7561 6c73 5f73 696d 706c 6966 6965 6428  uals_simplified(
+0002d2a0: 6172 672e 7368 6170 655b 2d31 5d2c 2061  arg.shape[-1], a
+0002d2b0: 7267 2e73 6861 7065 5b2d 325d 293a 0a20  rg.shape[-2]):. 
+0002d2c0: 2020 2020 2020 2072 6574 7572 6e20 6162         return ab
+0002d2d0: 7328 4465 7465 726d 696e 616e 7428 6172  s(Determinant(ar
+0002d2e0: 6729 290a 2020 2020 656c 7365 3a0a 2020  g)).    else:.  
+0002d2f0: 2020 2020 2020 7265 7475 726e 2073 7172        return sqr
+0002d300: 7428 6162 7328 4465 7465 726d 696e 616e  t(abs(Determinan
+0002d310: 7428 6772 616d 6d69 756d 2861 7267 2929  t(grammium(arg))
+0002d320: 2929 0a0a 0a64 6566 2069 6e76 6572 7365  ))...def inverse
+0002d330: 2861 7267 2c20 6178 6573 3d28 2d32 2c20  (arg, axes=(-2, 
+0002d340: 2d31 2929 3a0a 2020 2020 7265 7475 726e  -1)):.    return
+0002d350: 2054 7261 6e73 706f 7365 2e66 726f 6d5f   Transpose.from_
+0002d360: 656e 6428 496e 7665 7273 6528 5472 616e  end(Inverse(Tran
+0002d370: 7370 6f73 652e 746f 5f65 6e64 2861 7267  spose.to_end(arg
+0002d380: 2c20 2a61 7865 7329 292c 202a 6178 6573  , *axes)), *axes
+0002d390: 290a 0a0a 6465 6620 7461 6b65 6469 6167  )...def takediag
+0002d3a0: 2861 7267 2c20 6178 6973 3d2d 322c 2072  (arg, axis=-2, r
+0002d3b0: 6d61 7869 733d 2d31 293a 0a20 2020 2061  maxis=-1):.    a
+0002d3c0: 7267 203d 2061 7361 7272 6179 2861 7267  rg = asarray(arg
+0002d3d0: 290a 2020 2020 6178 6973 203d 206e 756d  ).    axis = num
+0002d3e0: 6572 6963 2e6e 6f72 6d64 696d 2861 7267  eric.normdim(arg
+0002d3f0: 2e6e 6469 6d2c 2061 7869 7329 0a20 2020  .ndim, axis).   
+0002d400: 2072 6d61 7869 7320 3d20 6e75 6d65 7269   rmaxis = numeri
+0002d410: 632e 6e6f 726d 6469 6d28 6172 672e 6e64  c.normdim(arg.nd
+0002d420: 696d 2c20 726d 6178 6973 290a 2020 2020  im, rmaxis).    
+0002d430: 6173 7365 7274 2061 7869 7320 3c20 726d  assert axis < rm
+0002d440: 6178 6973 0a20 2020 2072 6574 7572 6e20  axis.    return 
+0002d450: 5472 616e 7370 6f73 652e 6672 6f6d 5f65  Transpose.from_e
+0002d460: 6e64 285f 7461 6b65 6469 6167 2861 7267  nd(_takediag(arg
+0002d470: 2c20 6178 6973 2c20 726d 6178 6973 292c  , axis, rmaxis),
+0002d480: 2061 7869 7329 0a0a 0a64 6566 205f 7461   axis)...def _ta
+0002d490: 6b65 6469 6167 2861 7267 2c20 6178 6973  kediag(arg, axis
+0002d4a0: 313d 2d32 2c20 6178 6973 323d 2d31 293a  1=-2, axis2=-1):
+0002d4b0: 0a20 2020 2072 6574 7572 6e20 5461 6b65  .    return Take
+0002d4c0: 4469 6167 2854 7261 6e73 706f 7365 2e74  Diag(Transpose.t
+0002d4d0: 6f5f 656e 6428 6172 672c 2061 7869 7331  o_end(arg, axis1
+0002d4e0: 2c20 6178 6973 3229 290a 0a0a 6465 6620  , axis2))...def 
+0002d4f0: 6465 7269 7661 7469 7665 2866 756e 632c  derivative(func,
+0002d500: 2076 6172 2c20 7365 656e 3d4e 6f6e 6529   var, seen=None)
+0002d510: 3a0a 2020 2020 2764 6572 6976 6174 6976  :.    'derivativ
+0002d520: 6527 0a0a 2020 2020 6173 7365 7274 2069  e'..    assert i
+0002d530: 7369 6e73 7461 6e63 6528 7661 722c 2044  sinstance(var, D
+0002d540: 6572 6976 6174 6976 6554 6172 6765 7442  erivativeTargetB
+0002d550: 6173 6529 2c20 2769 6e76 616c 6964 2064  ase), 'invalid d
+0002d560: 6572 6976 6174 6976 6520 7461 7267 6574  erivative target
+0002d570: 207b 2172 7d27 2e66 6f72 6d61 7428 7661   {!r}'.format(va
+0002d580: 7229 0a20 2020 2069 6620 7661 722e 6474  r).    if var.dt
+0002d590: 7970 6520 696e 2028 626f 6f6c 2c20 696e  ype in (bool, in
+0002d5a0: 7429 206f 7220 7661 7220 6e6f 7420 696e  t) or var not in
+0002d5b0: 2066 756e 632e 6172 6775 6d65 6e74 733a   func.arguments:
+0002d5c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0002d5d0: 5a65 726f 7328 6675 6e63 2e73 6861 7065  Zeros(func.shape
+0002d5e0: 202b 2076 6172 2e73 6861 7065 2c20 6474   + var.shape, dt
+0002d5f0: 7970 653d 6675 6e63 2e64 7479 7065 290a  ype=func.dtype).
+0002d600: 2020 2020 6966 2073 6565 6e20 6973 204e      if seen is N
+0002d610: 6f6e 653a 0a20 2020 2020 2020 2073 6565  one:.        see
+0002d620: 6e20 3d20 7b7d 0a20 2020 2069 6620 6675  n = {}.    if fu
+0002d630: 6e63 2069 6e20 7365 656e 3a0a 2020 2020  nc in seen:.    
+0002d640: 2020 2020 7265 7375 6c74 203d 2073 6565      result = see
+0002d650: 6e5b 6675 6e63 5d0a 2020 2020 656c 7365  n[func].    else
+0002d660: 3a0a 2020 2020 2020 2020 7265 7375 6c74  :.        result
+0002d670: 203d 2066 756e 632e 5f64 6572 6976 6174   = func._derivat
+0002d680: 6976 6528 7661 722c 2073 6565 6e29 0a20  ive(var, seen). 
+0002d690: 2020 2020 2020 2073 6565 6e5b 6675 6e63         seen[func
+0002d6a0: 5d20 3d20 7265 7375 6c74 0a20 2020 2061  ] = result.    a
+0002d6b0: 7373 6572 7420 6571 7561 6c73 6861 7065  ssert equalshape
+0002d6c0: 2872 6573 756c 742e 7368 6170 652c 2066  (result.shape, f
+0002d6d0: 756e 632e 7368 6170 652b 7661 722e 7368  unc.shape+var.sh
+0002d6e0: 6170 6529 2061 6e64 2072 6573 756c 742e  ape) and result.
+0002d6f0: 6474 7970 6520 3d3d 2066 756e 632e 6474  dtype == func.dt
+0002d700: 7970 652c 2027 6275 6720 696e 207b 7d2e  ype, 'bug in {}.
+0002d710: 5f64 6572 6976 6174 6976 6527 2e66 6f72  _derivative'.for
+0002d720: 6d61 7428 7479 7065 2866 756e 6329 2e5f  mat(type(func)._
+0002d730: 5f6e 616d 655f 5f29 0a20 2020 2072 6574  _name__).    ret
+0002d740: 7572 6e20 7265 7375 6c74 0a0a 0a64 6566  urn result...def
+0002d750: 2064 6961 676f 6e61 6c69 7a65 2861 7267   diagonalize(arg
+0002d760: 2c20 6178 6973 3d2d 312c 206e 6577 6178  , axis=-1, newax
+0002d770: 6973 3d2d 3129 3a0a 2020 2020 6172 6720  is=-1):.    arg 
+0002d780: 3d20 6173 6172 7261 7928 6172 6729 0a20  = asarray(arg). 
+0002d790: 2020 2061 7869 7320 3d20 6e75 6d65 7269     axis = numeri
+0002d7a0: 632e 6e6f 726d 6469 6d28 6172 672e 6e64  c.normdim(arg.nd
+0002d7b0: 696d 2c20 6178 6973 290a 2020 2020 6e65  im, axis).    ne
+0002d7c0: 7761 7869 7320 3d20 6e75 6d65 7269 632e  waxis = numeric.
+0002d7d0: 6e6f 726d 6469 6d28 6172 672e 6e64 696d  normdim(arg.ndim
+0002d7e0: 2b31 2c20 6e65 7761 7869 7329 0a20 2020  +1, newaxis).   
+0002d7f0: 2061 7373 6572 7420 6178 6973 203c 206e   assert axis < n
+0002d800: 6577 6178 6973 0a20 2020 2072 6574 7572  ewaxis.    retur
+0002d810: 6e20 5472 616e 7370 6f73 652e 6672 6f6d  n Transpose.from
+0002d820: 5f65 6e64 2844 6961 676f 6e61 6c69 7a65  _end(Diagonalize
+0002d830: 2854 7261 6e73 706f 7365 2e74 6f5f 656e  (Transpose.to_en
+0002d840: 6428 6172 672c 2061 7869 7329 292c 2061  d(arg, axis)), a
+0002d850: 7869 732c 206e 6577 6178 6973 290a 0a0a  xis, newaxis)...
+0002d860: 6465 6620 7369 676e 2861 7267 293a 0a20  def sign(arg):. 
+0002d870: 2020 2061 7267 203d 2061 7361 7272 6179     arg = asarray
+0002d880: 2861 7267 290a 2020 2020 6966 2061 7267  (arg).    if arg
+0002d890: 2e64 7479 7065 203d 3d20 636f 6d70 6c65  .dtype == comple
+0002d8a0: 783a 0a20 2020 2020 2020 2072 6169 7365  x:.        raise
+0002d8b0: 2056 616c 7565 4572 726f 7228 2773 6967   ValueError('sig
+0002d8c0: 6e20 6973 206e 6f74 2064 6566 696e 6564  n is not defined
+0002d8d0: 2066 6f72 2063 6f6d 706c 6578 206e 756d   for complex num
+0002d8e0: 6265 7273 2729 0a20 2020 2072 6574 7572  bers').    retur
+0002d8f0: 6e20 5369 676e 2861 7267 290a 0a0a 6465  n Sign(arg)...de
+0002d900: 6620 6569 6728 6172 672c 2061 7865 733d  f eig(arg, axes=
+0002d910: 282d 322c 202d 3129 2c20 7379 6d6d 6574  (-2, -1), symmet
+0002d920: 7269 633d 4661 6c73 6529 3a0a 2020 2020  ric=False):.    
+0002d930: 6569 6776 616c 2c20 6569 6776 6563 203d  eigval, eigvec =
+0002d940: 2045 6967 2854 7261 6e73 706f 7365 2e74   Eig(Transpose.t
+0002d950: 6f5f 656e 6428 6172 672c 202a 6178 6573  o_end(arg, *axes
+0002d960: 292c 2073 796d 6d65 7472 6963 290a 2020  ), symmetric).  
+0002d970: 2020 7265 7475 726e 2054 7570 6c65 2874    return Tuple(t
+0002d980: 7570 6c65 2854 7261 6e73 706f 7365 2e66  uple(Transpose.f
+0002d990: 726f 6d5f 656e 6428 762c 202a 6178 6573  rom_end(v, *axes
+0002d9a0: 2920 666f 7220 7620 696e 205b 6469 6167  ) for v in [diag
+0002d9b0: 6f6e 616c 697a 6528 6569 6776 616c 292c  onalize(eigval),
+0002d9c0: 2065 6967 7665 635d 2929 0a0a 0a64 6566   eigvec]))...def
+0002d9d0: 205f 7461 6b65 736c 6963 6528 6172 673a   _takeslice(arg:
+0002d9e0: 2041 7272 6179 2c20 733a 2073 6c69 6365   Array, s: slice
+0002d9f0: 2c20 6178 6973 3a20 696e 7429 3a0a 2020  , axis: int):.  
+0002da00: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+0002da10: 6e63 6528 6172 672c 2041 7272 6179 292c  nce(arg, Array),
+0002da20: 2066 2761 7267 3d7b 6172 6721 727d 270a   f'arg={arg!r}'.
+0002da30: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0002da40: 7461 6e63 6528 732c 2073 6c69 6365 292c  tance(s, slice),
+0002da50: 2066 2773 3d7b 7321 727d 270a 2020 2020   f's={s!r}'.    
+0002da60: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0002da70: 6528 6178 6973 2c20 696e 7429 2c20 6627  e(axis, int), f'
+0002da80: 6178 6973 3d7b 6178 6973 2172 7d27 0a20  axis={axis!r}'. 
+0002da90: 2020 206e 203d 2061 7267 2e73 6861 7065     n = arg.shape
+0002daa0: 5b61 7869 735d 0a20 2020 2069 6620 732e  [axis].    if s.
+0002dab0: 7374 6570 203d 3d20 4e6f 6e65 206f 7220  step == None or 
+0002dac0: 732e 7374 6570 203d 3d20 313a 0a20 2020  s.step == 1:.   
+0002dad0: 2020 2020 2073 7461 7274 203d 2030 2069       start = 0 i
+0002dae0: 6620 732e 7374 6172 7420 6973 204e 6f6e  f s.start is Non
+0002daf0: 6520 656c 7365 2073 2e73 7461 7274 2069  e else s.start i
+0002db00: 6620 732e 7374 6172 7420 3e3d 2030 2065  f s.start >= 0 e
+0002db10: 6c73 6520 732e 7374 6172 7420 2b20 6e0a  lse s.start + n.
+0002db20: 2020 2020 2020 2020 7374 6f70 203d 206e          stop = n
+0002db30: 2069 6620 732e 7374 6f70 2069 7320 4e6f   if s.stop is No
+0002db40: 6e65 2065 6c73 6520 732e 7374 6f70 2069  ne else s.stop i
+0002db50: 6620 732e 7374 6f70 203e 3d20 3020 656c  f s.stop >= 0 el
+0002db60: 7365 2073 2e73 746f 7020 2b20 6e0a 2020  se s.stop + n.  
+0002db70: 2020 2020 2020 6966 2073 7461 7274 203d        if start =
+0002db80: 3d20 3020 616e 6420 7374 6f70 203d 3d20  = 0 and stop == 
+0002db90: 6e3a 0a20 2020 2020 2020 2020 2020 2072  n:.            r
+0002dba0: 6574 7572 6e20 6172 670a 2020 2020 2020  eturn arg.      
+0002dbb0: 2020 696e 6465 7820 3d20 5261 6e67 6528    index = Range(
+0002dbc0: 6173 6172 7261 7928 7374 6f70 2d73 7461  asarray(stop-sta
+0002dbd0: 7274 2929 202b 2073 7461 7274 0a20 2020  rt)) + start.   
+0002dbe0: 2065 6c69 6620 6e2e 6973 636f 6e73 7461   elif n.isconsta
+0002dbf0: 6e74 3a0a 2020 2020 2020 2020 696e 6465  nt:.        inde
+0002dc00: 7820 3d20 636f 6e73 7461 6e74 286e 756d  x = constant(num
+0002dc10: 7079 2e61 7261 6e67 6528 2a73 2e69 6e64  py.arange(*s.ind
+0002dc20: 6963 6573 2861 7267 2e73 6861 7065 5b61  ices(arg.shape[a
+0002dc30: 7869 735d 2929 290a 2020 2020 656c 7365  xis]))).    else
+0002dc40: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+0002dc50: 4578 6365 7074 696f 6e28 2761 206e 6f6e  Exception('a non
+0002dc60: 2d75 6e69 7420 736c 6963 6520 7265 7175  -unit slice requ
+0002dc70: 6972 6573 2061 2063 6f6e 7374 616e 742d  ires a constant-
+0002dc80: 6c65 6e67 7468 2061 7869 7327 290a 2020  length axis').  
+0002dc90: 2020 7265 7475 726e 2074 616b 6528 6172    return take(ar
+0002dca0: 672c 2069 6e64 6578 2c20 6178 6973 290a  g, index, axis).
+0002dcb0: 0a0a 6465 6620 7461 6b65 2861 7267 3a20  ..def take(arg: 
+0002dcc0: 4172 7261 792c 2069 6e64 6578 3a20 4172  Array, index: Ar
+0002dcd0: 7261 792c 2061 7869 733a 2069 6e74 293a  ray, axis: int):
+0002dce0: 0a20 2020 2061 7373 6572 7420 6973 696e  .    assert isin
+0002dcf0: 7374 616e 6365 2861 7267 2c20 4172 7261  stance(arg, Arra
+0002dd00: 7929 2c20 6627 6172 673d 7b61 7267 2172  y), f'arg={arg!r
+0002dd10: 7d27 0a20 2020 2061 7373 6572 7420 6973  }'.    assert is
+0002dd20: 696e 7374 616e 6365 2869 6e64 6578 2c20  instance(index, 
+0002dd30: 4172 7261 7929 2061 6e64 2069 6e64 6578  Array) and index
+0002dd40: 2e64 7479 7065 2069 6e20 2862 6f6f 6c2c  .dtype in (bool,
+0002dd50: 2069 6e74 2920 616e 6420 696e 6465 782e   int) and index.
+0002dd60: 6e64 696d 203d 3d20 312c 2066 2769 6e64  ndim == 1, f'ind
+0002dd70: 6578 3d7b 696e 6465 7821 727d 270a 2020  ex={index!r}'.  
+0002dd80: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+0002dd90: 6e63 6528 6178 6973 2c20 696e 7429 2c20  nce(axis, int), 
+0002dda0: 6627 6178 6973 3d7b 6178 6973 2172 7d27  f'axis={axis!r}'
+0002ddb0: 0a20 2020 206c 656e 6774 6820 3d20 6172  .    length = ar
+0002ddc0: 672e 7368 6170 655b 6178 6973 5d0a 2020  g.shape[axis].  
+0002ddd0: 2020 6966 2069 6e64 6578 2e64 7479 7065    if index.dtype
+0002dde0: 203d 3d20 626f 6f6c 3a0a 2020 2020 2020   == bool:.      
+0002ddf0: 2020 6173 7365 7274 205f 6571 7561 6c73    assert _equals
+0002de00: 5f73 696d 706c 6966 6965 6428 696e 6465  _simplified(inde
+0002de10: 782e 7368 6170 655b 305d 2c20 6c65 6e67  x.shape[0], leng
+0002de20: 7468 290a 2020 2020 2020 2020 696e 6465  th).        inde
+0002de30: 7820 3d20 4669 6e64 2869 6e64 6578 290a  x = Find(index).
+0002de40: 2020 2020 656c 6966 2069 6e64 6578 2e69      elif index.i
+0002de50: 7363 6f6e 7374 616e 743a 0a20 2020 2020  sconstant:.     
+0002de60: 2020 2069 6e64 6578 5f20 3d20 696e 6465     index_ = inde
+0002de70: 782e 6576 616c 2829 0a20 2020 2020 2020  x.eval().       
+0002de80: 2069 6e65 6720 3d20 6e75 6d70 792e 6c65   ineg = numpy.le
+0002de90: 7373 2869 6e64 6578 5f2c 2030 290a 2020  ss(index_, 0).  
+0002dea0: 2020 2020 2020 6966 206e 6f74 206c 656e        if not len
+0002deb0: 6774 682e 6973 636f 6e73 7461 6e74 3a0a  gth.isconstant:.
+0002dec0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0002ded0: 6e65 672e 616e 7928 293a 0a20 2020 2020  neg.any():.     
+0002dee0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0002def0: 2049 6e64 6578 4572 726f 7228 276e 6567   IndexError('neg
+0002df00: 6174 6976 6520 696e 6469 6365 7320 6f6e  ative indices on
+0002df10: 6c79 2061 6c6c 6f77 6564 2066 6f72 2063  ly allowed for c
+0002df20: 6f6e 7374 616e 742d 6c65 6e67 7468 2061  onstant-length a
+0002df30: 7865 7327 290a 2020 2020 2020 2020 656c  xes').        el
+0002df40: 6966 2069 6e65 672e 616e 7928 293a 0a20  if ineg.any():. 
+0002df50: 2020 2020 2020 2020 2020 2069 6620 6e75             if nu
+0002df60: 6d70 792e 6c65 7373 2869 6e64 6578 5f2c  mpy.less(index_,
+0002df70: 202d 696e 7428 6c65 6e67 7468 2929 2e61   -int(length)).a
+0002df80: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
+0002df90: 2020 2020 2020 7261 6973 6520 496e 6465        raise Inde
+0002dfa0: 7845 7272 6f72 2827 696e 6469 6365 7320  xError('indices 
+0002dfb0: 6f75 7420 6f66 2062 6f75 6e64 733a 207b  out of bounds: {
+0002dfc0: 7d20 3c20 7b7d 272e 666f 726d 6174 2869  } < {}'.format(i
+0002dfd0: 6e64 6578 5f2c 202d 696e 7428 6c65 6e67  ndex_, -int(leng
+0002dfe0: 7468 2929 290a 2020 2020 2020 2020 2020  th))).          
+0002dff0: 2020 7265 7475 726e 205f 7461 6b65 2861    return _take(a
+0002e000: 7267 2c20 636f 6e73 7461 6e74 2869 6e64  rg, constant(ind
+0002e010: 6578 5f20 2b20 696e 6567 202a 2069 6e74  ex_ + ineg * int
+0002e020: 286c 656e 6774 6829 292c 2061 7869 7329  (length)), axis)
+0002e030: 0a20 2020 2020 2020 2065 6c69 6620 6e75  .        elif nu
+0002e040: 6d70 792e 6772 6561 7465 725f 6571 7561  mpy.greater_equa
+0002e050: 6c28 696e 6465 785f 2c20 696e 7428 6c65  l(index_, int(le
+0002e060: 6e67 7468 2929 2e61 6e79 2829 3a0a 2020  ngth)).any():.  
+0002e070: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0002e080: 496e 6465 7845 7272 6f72 2827 696e 6469  IndexError('indi
+0002e090: 6365 7320 6f75 7420 6f66 2062 6f75 6e64  ces out of bound
+0002e0a0: 733a 207b 7d20 3e3d 207b 7d27 2e66 6f72  s: {} >= {}'.for
+0002e0b0: 6d61 7428 696e 6465 785f 2c20 696e 7428  mat(index_, int(
+0002e0c0: 6c65 6e67 7468 2929 290a 2020 2020 2020  length))).      
+0002e0d0: 2020 656c 6966 206e 756d 7079 2e67 7265    elif numpy.gre
+0002e0e0: 6174 6572 286e 756d 7079 2e64 6966 6628  ater(numpy.diff(
+0002e0f0: 696e 6465 785f 292c 2030 292e 616c 6c28  index_), 0).all(
+0002e100: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0002e110: 6574 7572 6e20 6d61 736b 2861 7267 2c20  eturn mask(arg, 
+0002e120: 6e75 6d65 7269 632e 6173 626f 6f6c 6561  numeric.asboolea
+0002e130: 6e28 696e 6465 785f 2c20 696e 7428 6c65  n(index_, int(le
+0002e140: 6e67 7468 2929 2c20 6178 6973 290a 2020  ngth)), axis).  
+0002e150: 2020 7265 7475 726e 205f 7461 6b65 2861    return _take(a
+0002e160: 7267 2c20 696e 6465 782c 2061 7869 7329  rg, index, axis)
+0002e170: 0a0a 0a64 6566 205f 7461 6b65 2861 7267  ...def _take(arg
+0002e180: 3a20 4172 7261 792c 2069 6e64 6578 3a20  : Array, index: 
+0002e190: 4172 7261 792c 2061 7869 733a 2069 6e74  Array, axis: int
+0002e1a0: 293a 0a20 2020 2061 7373 6572 7420 6973  ):.    assert is
+0002e1b0: 696e 7374 616e 6365 2861 7267 2c20 4172  instance(arg, Ar
+0002e1c0: 7261 7929 2c20 6627 6172 673d 7b61 7267  ray), f'arg={arg
+0002e1d0: 2172 7d27 0a20 2020 2061 7373 6572 7420  !r}'.    assert 
+0002e1e0: 6973 696e 7374 616e 6365 2869 6e64 6578  isinstance(index
+0002e1f0: 2c20 4172 7261 7929 2061 6e64 2069 6e64  , Array) and ind
+0002e200: 6578 2e64 7479 7065 203d 3d20 696e 742c  ex.dtype == int,
+0002e210: 2066 2769 6e64 6578 3d7b 696e 6465 7821   f'index={index!
+0002e220: 727d 270a 2020 2020 6173 7365 7274 2069  r}'.    assert i
+0002e230: 7369 6e73 7461 6e63 6528 6178 6973 2c20  sinstance(axis, 
+0002e240: 696e 7429 2c20 6627 6178 6973 3d7b 6178  int), f'axis={ax
+0002e250: 6973 2172 7d27 0a20 2020 2061 7869 7320  is!r}'.    axis 
+0002e260: 3d20 6e75 6d65 7269 632e 6e6f 726d 6469  = numeric.normdi
+0002e270: 6d28 6172 672e 6e64 696d 2c20 6178 6973  m(arg.ndim, axis
+0002e280: 290a 2020 2020 7265 7475 726e 2054 7261  ).    return Tra
+0002e290: 6e73 706f 7365 2e66 726f 6d5f 656e 6428  nspose.from_end(
+0002e2a0: 5461 6b65 2854 7261 6e73 706f 7365 2e74  Take(Transpose.t
+0002e2b0: 6f5f 656e 6428 6172 672c 2061 7869 7329  o_end(arg, axis)
+0002e2c0: 2c20 696e 6465 7829 2c20 2a72 616e 6765  , index), *range
+0002e2d0: 2861 7869 732c 2061 7869 732b 696e 6465  (axis, axis+inde
+0002e2e0: 782e 6e64 696d 2929 0a0a 0a64 6566 205f  x.ndim))...def _
+0002e2f0: 696e 666c 6174 6528 6172 673a 2041 7272  inflate(arg: Arr
+0002e300: 6179 2c20 646f 666d 6170 3a20 4172 7261  ay, dofmap: Arra
+0002e310: 792c 206c 656e 6774 683a 2041 7272 6179  y, length: Array
+0002e320: 2c20 6178 6973 3a20 696e 7429 3a0a 2020  , axis: int):.  
+0002e330: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+0002e340: 6e63 6528 6172 672c 2041 7272 6179 292c  nce(arg, Array),
+0002e350: 2066 2761 7267 3d7b 6172 6721 727d 270a   f'arg={arg!r}'.
+0002e360: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0002e370: 7461 6e63 6528 646f 666d 6170 2c20 4172  tance(dofmap, Ar
+0002e380: 7261 7929 2061 6e64 2064 6f66 6d61 702e  ray) and dofmap.
+0002e390: 6474 7970 6520 3d3d 2069 6e74 2c20 6627  dtype == int, f'
+0002e3a0: 646f 666d 6170 3d7b 646f 666d 6170 2172  dofmap={dofmap!r
+0002e3b0: 7d27 0a20 2020 2061 7373 6572 7420 5f69  }'.    assert _i
+0002e3c0: 7369 6e64 6578 286c 656e 6774 6829 2c20  sindex(length), 
+0002e3d0: 6627 6c65 6e67 7468 3d7b 6c65 6e67 7468  f'length={length
+0002e3e0: 2172 7d27 0a20 2020 2061 7373 6572 7420  !r}'.    assert 
+0002e3f0: 6973 696e 7374 616e 6365 2861 7869 732c  isinstance(axis,
+0002e400: 2069 6e74 292c 2066 2761 7869 733d 7b61   int), f'axis={a
+0002e410: 7869 7321 727d 270a 2020 2020 6178 6973  xis!r}'.    axis
+0002e420: 203d 206e 756d 6572 6963 2e6e 6f72 6d64   = numeric.normd
+0002e430: 696d 2861 7267 2e6e 6469 6d2b 312d 646f  im(arg.ndim+1-do
+0002e440: 666d 6170 2e6e 6469 6d2c 2061 7869 7329  fmap.ndim, axis)
+0002e450: 0a20 2020 2061 7373 6572 7420 6571 7561  .    assert equa
+0002e460: 6c73 6861 7065 2864 6f66 6d61 702e 7368  lshape(dofmap.sh
+0002e470: 6170 652c 2061 7267 2e73 6861 7065 5b61  ape, arg.shape[a
+0002e480: 7869 733a 6178 6973 2b64 6f66 6d61 702e  xis:axis+dofmap.
+0002e490: 6e64 696d 5d29 0a20 2020 2072 6574 7572  ndim]).    retur
+0002e4a0: 6e20 5472 616e 7370 6f73 652e 6672 6f6d  n Transpose.from
+0002e4b0: 5f65 6e64 2849 6e66 6c61 7465 2854 7261  _end(Inflate(Tra
+0002e4c0: 6e73 706f 7365 2e74 6f5f 656e 6428 6172  nspose.to_end(ar
+0002e4d0: 672c 202a 7261 6e67 6528 6178 6973 2c20  g, *range(axis, 
+0002e4e0: 6178 6973 2b64 6f66 6d61 702e 6e64 696d  axis+dofmap.ndim
+0002e4f0: 2929 2c20 646f 666d 6170 2c20 6c65 6e67  )), dofmap, leng
+0002e500: 7468 292c 2061 7869 7329 0a0a 0a64 6566  th), axis)...def
+0002e510: 206d 6173 6b28 6172 672c 206d 6173 6b3a   mask(arg, mask:
+0002e520: 2041 7272 6179 2c20 6178 6973 3a20 696e   Array, axis: in
+0002e530: 7420 3d20 3029 3a0a 2020 2020 6173 7365  t = 0):.    asse
+0002e540: 7274 2069 7369 6e73 7461 6e63 6528 6172  rt isinstance(ar
+0002e550: 672c 2041 7272 6179 292c 2066 2761 7267  g, Array), f'arg
+0002e560: 3d7b 6172 6721 727d 270a 2020 2020 6173  ={arg!r}'.    as
+0002e570: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+0002e580: 6d61 736b 2c20 6e75 6d70 792e 6e64 6172  mask, numpy.ndar
+0002e590: 7261 7929 2061 6e64 206d 6173 6b2e 6474  ray) and mask.dt
+0002e5a0: 7970 6520 3d3d 2062 6f6f 6c20 616e 6420  ype == bool and 
+0002e5b0: 6d61 736b 2e6e 6469 6d20 3d3d 2031 2061  mask.ndim == 1 a
+0002e5c0: 6e64 205f 6571 7561 6c73 5f73 6361 6c61  nd _equals_scala
+0002e5d0: 725f 636f 6e73 7461 6e74 2861 7267 2e73  r_constant(arg.s
+0002e5e0: 6861 7065 5b61 7869 735d 2c20 6c65 6e28  hape[axis], len(
+0002e5f0: 6d61 736b 2929 2c20 6627 6d61 736b 3d7b  mask)), f'mask={
+0002e600: 6d61 736b 2172 7d27 0a20 2020 2069 6e64  mask!r}'.    ind
+0002e610: 6578 2c20 3d20 6d61 736b 2e6e 6f6e 7a65  ex, = mask.nonze
+0002e620: 726f 2829 0a20 2020 2072 6574 7572 6e20  ro().    return 
+0002e630: 5f74 616b 6528 6172 672c 2063 6f6e 7374  _take(arg, const
+0002e640: 616e 7428 696e 6465 7829 2c20 6178 6973  ant(index), axis
+0002e650: 290a 0a0a 6465 6620 756e 7261 7665 6c28  )...def unravel(
+0002e660: 6675 6e63 2c20 6178 6973 2c20 7368 6170  func, axis, shap
+0002e670: 6529 3a0a 2020 2020 6675 6e63 203d 2061  e):.    func = a
+0002e680: 7361 7272 6179 2866 756e 6329 0a20 2020  sarray(func).   
+0002e690: 2061 7869 7320 3d20 6e75 6d65 7269 632e   axis = numeric.
+0002e6a0: 6e6f 726d 6469 6d28 6675 6e63 2e6e 6469  normdim(func.ndi
+0002e6b0: 6d2c 2061 7869 7329 0a20 2020 2061 7373  m, axis).    ass
+0002e6c0: 6572 7420 6c65 6e28 7368 6170 6529 203d  ert len(shape) =
+0002e6d0: 3d20 320a 2020 2020 7265 7475 726e 2054  = 2.    return T
+0002e6e0: 7261 6e73 706f 7365 2e66 726f 6d5f 656e  ranspose.from_en
+0002e6f0: 6428 556e 7261 7665 6c28 5472 616e 7370  d(Unravel(Transp
+0002e700: 6f73 652e 746f 5f65 6e64 2866 756e 632c  ose.to_end(func,
+0002e710: 2061 7869 7329 2c20 2a73 6861 7065 292c   axis), *shape),
+0002e720: 2061 7869 732c 2061 7869 732b 3129 0a0a   axis, axis+1)..
+0002e730: 0a64 6566 2072 6176 656c 2866 756e 632c  .def ravel(func,
+0002e740: 2061 7869 7329 3a0a 2020 2020 6675 6e63   axis):.    func
+0002e750: 203d 2061 7361 7272 6179 2866 756e 6329   = asarray(func)
+0002e760: 0a20 2020 2061 7869 7320 3d20 6e75 6d65  .    axis = nume
+0002e770: 7269 632e 6e6f 726d 6469 6d28 6675 6e63  ric.normdim(func
+0002e780: 2e6e 6469 6d2d 312c 2061 7869 7329 0a20  .ndim-1, axis). 
+0002e790: 2020 2072 6574 7572 6e20 5472 616e 7370     return Transp
+0002e7a0: 6f73 652e 6672 6f6d 5f65 6e64 2852 6176  ose.from_end(Rav
+0002e7b0: 656c 2854 7261 6e73 706f 7365 2e74 6f5f  el(Transpose.to_
+0002e7c0: 656e 6428 6675 6e63 2c20 6178 6973 2c20  end(func, axis, 
+0002e7d0: 6178 6973 2b31 2929 2c20 6178 6973 290a  axis+1)), axis).
+0002e7e0: 0a0a 6465 6620 5f66 6c61 7428 6675 6e63  ..def _flat(func
+0002e7f0: 293a 0a20 2020 2066 756e 6320 3d20 6173  ):.    func = as
+0002e800: 6172 7261 7928 6675 6e63 290a 2020 2020  array(func).    
+0002e810: 6966 2066 756e 632e 6e64 696d 203d 3d20  if func.ndim == 
+0002e820: 303a 0a20 2020 2020 2020 2072 6574 7572  0:.        retur
+0002e830: 6e20 496e 7365 7274 4178 6973 2866 756e  n InsertAxis(fun
+0002e840: 632c 2063 6f6e 7374 616e 7428 3129 290a  c, constant(1)).
+0002e850: 2020 2020 7768 696c 6520 6675 6e63 2e6e      while func.n
+0002e860: 6469 6d20 3e20 313a 0a20 2020 2020 2020  dim > 1:.       
+0002e870: 2066 756e 6320 3d20 5261 7665 6c28 6675   func = Ravel(fu
+0002e880: 6e63 290a 2020 2020 7265 7475 726e 2066  nc).    return f
+0002e890: 756e 630a 0a0a 6465 6620 7072 6570 656e  unc...def prepen
+0002e8a0: 6461 7865 7328 6675 6e63 2c20 7368 6170  daxes(func, shap
+0002e8b0: 6529 3a0a 2020 2020 2750 7265 7065 6e64  e):.    'Prepend
+0002e8c0: 2061 7865 7320 7769 7468 2073 7065 6369   axes with speci
+0002e8d0: 6669 6564 2060 7368 6170 6560 2074 6f20  fied `shape` to 
+0002e8e0: 6066 756e 6360 2e27 0a0a 2020 2020 6675  `func`.'..    fu
+0002e8f0: 6e63 203d 2061 7361 7272 6179 2866 756e  nc = asarray(fun
+0002e900: 6329 0a20 2020 2066 6f72 2069 2c20 6e20  c).    for i, n 
+0002e910: 696e 2065 6e75 6d65 7261 7465 2873 6861  in enumerate(sha
+0002e920: 7065 293a 0a20 2020 2020 2020 2066 756e  pe):.        fun
+0002e930: 6320 3d20 696e 7365 7274 6178 6973 2866  c = insertaxis(f
+0002e940: 756e 632c 2069 2c20 6e29 0a20 2020 2072  unc, i, n).    r
+0002e950: 6574 7572 6e20 6675 6e63 0a0a 0a64 6566  eturn func...def
+0002e960: 2061 7070 656e 6461 7865 7328 6675 6e63   appendaxes(func
+0002e970: 2c20 7368 6170 6529 3a0a 2020 2020 2741  , shape):.    'A
+0002e980: 7070 656e 6420 6178 6573 2077 6974 6820  ppend axes with 
+0002e990: 7370 6563 6966 6965 6420 6073 6861 7065  specified `shape
+0002e9a0: 6020 746f 2060 6675 6e63 602e 270a 0a20  ` to `func`.'.. 
+0002e9b0: 2020 2066 756e 6320 3d20 6173 6172 7261     func = asarra
+0002e9c0: 7928 6675 6e63 290a 2020 2020 666f 7220  y(func).    for 
+0002e9d0: 6e20 696e 2073 6861 7065 3a0a 2020 2020  n in shape:.    
+0002e9e0: 2020 2020 6675 6e63 203d 2049 6e73 6572      func = Inser
+0002e9f0: 7441 7869 7328 6675 6e63 2c20 6e29 0a20  tAxis(func, n). 
+0002ea00: 2020 2072 6574 7572 6e20 6675 6e63 0a0a     return func..
+0002ea10: 0a64 6566 206c 6f6f 705f 696e 6465 7828  .def loop_index(
+0002ea20: 6e61 6d65 2c20 6c65 6e67 7468 293a 0a20  name, length):. 
+0002ea30: 2020 2072 6574 7572 6e20 5f4c 6f6f 7049     return _LoopI
+0002ea40: 6e64 6578 286e 616d 652c 2061 7361 7272  ndex(name, asarr
+0002ea50: 6179 286c 656e 6774 6829 290a 0a0a 6465  ay(length))...de
+0002ea60: 6620 6c6f 6f70 5f73 756d 2866 756e 632c  f loop_sum(func,
+0002ea70: 2069 6e64 6578 293a 0a20 2020 2066 756e   index):.    fun
+0002ea80: 6320 3d20 6173 6172 7261 7928 6675 6e63  c = asarray(func
+0002ea90: 290a 2020 2020 6966 206e 6f74 2069 7369  ).    if not isi
+0002eaa0: 6e73 7461 6e63 6528 696e 6465 782c 205f  nstance(index, _
+0002eab0: 4c6f 6f70 496e 6465 7829 3a0a 2020 2020  LoopIndex):.    
+0002eac0: 2020 2020 7261 6973 6520 5479 7065 4572      raise TypeEr
+0002ead0: 726f 7228 6627 6578 7065 6374 6564 205f  ror(f'expected _
+0002eae0: 4c6f 6f70 496e 6465 782c 2067 6f74 207b  LoopIndex, got {
+0002eaf0: 696e 6465 7821 727d 2729 0a20 2020 2072  index!r}').    r
+0002eb00: 6574 7572 6e20 4c6f 6f70 5375 6d28 6675  eturn LoopSum(fu
+0002eb10: 6e63 2c20 6675 6e63 2e73 6861 7065 2c20  nc, func.shape, 
+0002eb20: 696e 6465 782e 5f6e 616d 652c 2069 6e64  index._name, ind
+0002eb30: 6578 2e6c 656e 6774 6829 0a0a 0a64 6566  ex.length)...def
+0002eb40: 205f 6c6f 6f70 5f63 6f6e 6361 7465 6e61   _loop_concatena
+0002eb50: 7465 5f64 6174 6128 6675 6e63 2c20 696e  te_data(func, in
+0002eb60: 6465 7829 3a0a 2020 2020 6675 6e63 203d  dex):.    func =
+0002eb70: 2061 7361 7272 6179 2866 756e 6329 0a20   asarray(func). 
+0002eb80: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+0002eb90: 616e 6365 2869 6e64 6578 2c20 5f4c 6f6f  ance(index, _Loo
+0002eba0: 7049 6e64 6578 293a 0a20 2020 2020 2020  pIndex):.       
+0002ebb0: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
+0002ebc0: 2866 2765 7870 6563 7465 6420 5f4c 6f6f  (f'expected _Loo
+0002ebd0: 7049 6e64 6578 2c20 676f 7420 7b69 6e64  pIndex, got {ind
+0002ebe0: 6578 2172 7d27 290a 2020 2020 6368 756e  ex!r}').    chun
+0002ebf0: 6b5f 7369 7a65 203d 2066 756e 632e 7368  k_size = func.sh
+0002ec00: 6170 655b 2d31 5d0a 2020 2020 6966 2063  ape[-1].    if c
+0002ec10: 6875 6e6b 5f73 697a 652e 6973 636f 6e73  hunk_size.iscons
+0002ec20: 7461 6e74 3a0a 2020 2020 2020 2020 6368  tant:.        ch
+0002ec30: 756e 6b5f 7369 7a65 7320 3d20 496e 7365  unk_sizes = Inse
+0002ec40: 7274 4178 6973 2863 6875 6e6b 5f73 697a  rtAxis(chunk_siz
+0002ec50: 652c 2069 6e64 6578 2e6c 656e 6774 6829  e, index.length)
+0002ec60: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0002ec70: 2020 2063 6875 6e6b 5f73 697a 6573 203d     chunk_sizes =
+0002ec80: 206c 6f6f 705f 636f 6e63 6174 656e 6174   loop_concatenat
+0002ec90: 6528 496e 7365 7274 4178 6973 2866 756e  e(InsertAxis(fun
+0002eca0: 632e 7368 6170 655b 2d31 5d2c 2063 6f6e  c.shape[-1], con
+0002ecb0: 7374 616e 7428 3129 292c 2069 6e64 6578  stant(1)), index
+0002ecc0: 290a 2020 2020 6f66 6673 6574 7320 3d20  ).    offsets = 
+0002ecd0: 5f53 697a 6573 546f 4f66 6673 6574 7328  _SizesToOffsets(
+0002ece0: 6368 756e 6b5f 7369 7a65 7329 0a20 2020  chunk_sizes).   
+0002ecf0: 2073 7461 7274 203d 2054 616b 6528 6f66   start = Take(of
+0002ed00: 6673 6574 732c 2069 6e64 6578 290a 2020  fsets, index).  
+0002ed10: 2020 7374 6f70 203d 2054 616b 6528 6f66    stop = Take(of
+0002ed20: 6673 6574 732c 2069 6e64 6578 2b31 290a  fsets, index+1).
+0002ed30: 2020 2020 7265 7475 726e 2028 6675 6e63      return (func
+0002ed40: 2c20 7374 6172 742c 2073 746f 702c 202a  , start, stop, *
+0002ed50: 6675 6e63 2e73 6861 7065 5b3a 2d31 5d2c  func.shape[:-1],
+0002ed60: 2054 616b 6528 6f66 6673 6574 732c 2069   Take(offsets, i
+0002ed70: 6e64 6578 2e6c 656e 6774 6829 290a 0a0a  ndex.length))...
+0002ed80: 6465 6620 6c6f 6f70 5f63 6f6e 6361 7465  def loop_concate
+0002ed90: 6e61 7465 2866 756e 632c 2069 6e64 6578  nate(func, index
+0002eda0: 293a 0a20 2020 2066 756e 6364 6174 6120  ):.    funcdata 
+0002edb0: 3d20 5f6c 6f6f 705f 636f 6e63 6174 656e  = _loop_concaten
+0002edc0: 6174 655f 6461 7461 2866 756e 632c 2069  ate_data(func, i
+0002edd0: 6e64 6578 290a 2020 2020 7265 7475 726e  ndex).    return
+0002ede0: 204c 6f6f 7043 6f6e 6361 7465 6e61 7465   LoopConcatenate
+0002edf0: 2866 756e 6364 6174 612c 2069 6e64 6578  (funcdata, index
+0002ee00: 2e5f 6e61 6d65 2c20 696e 6465 782e 6c65  ._name, index.le
+0002ee10: 6e67 7468 290a 0a0a 6465 6620 6c6f 6f70  ngth)...def loop
+0002ee20: 5f63 6f6e 6361 7465 6e61 7465 5f63 6f6d  _concatenate_com
+0002ee30: 6269 6e65 6428 6675 6e63 732c 2069 6e64  bined(funcs, ind
+0002ee40: 6578 293a 0a20 2020 2075 6e69 7175 655f  ex):.    unique_
+0002ee50: 6675 6e63 7320 3d20 5b5d 0a20 2020 2075  funcs = [].    u
+0002ee60: 6e69 7175 655f 6675 6e63 732e 6578 7465  nique_funcs.exte
+0002ee70: 6e64 2866 756e 6320 666f 7220 6675 6e63  nd(func for func
+0002ee80: 2069 6e20 6675 6e63 7320 6966 2066 756e   in funcs if fun
+0002ee90: 6320 6e6f 7420 696e 2075 6e69 7175 655f  c not in unique_
+0002eea0: 6675 6e63 7329 0a20 2020 2075 6e69 7175  funcs).    uniqu
+0002eeb0: 655f 6675 6e63 5f64 6174 6120 3d20 7475  e_func_data = tu
+0002eec0: 706c 6528 5f6c 6f6f 705f 636f 6e63 6174  ple(_loop_concat
+0002eed0: 656e 6174 655f 6461 7461 2866 756e 632c  enate_data(func,
+0002eee0: 2069 6e64 6578 2920 666f 7220 6675 6e63   index) for func
+0002eef0: 2069 6e20 756e 6971 7565 5f66 756e 6373   in unique_funcs
+0002ef00: 290a 2020 2020 6c6f 6f70 203d 204c 6f6f  ).    loop = Loo
+0002ef10: 7043 6f6e 6361 7465 6e61 7465 436f 6d62  pConcatenateComb
+0002ef20: 696e 6564 2875 6e69 7175 655f 6675 6e63  ined(unique_func
+0002ef30: 5f64 6174 612c 2069 6e64 6578 2e5f 6e61  _data, index._na
+0002ef40: 6d65 2c20 696e 6465 782e 6c65 6e67 7468  me, index.length
+0002ef50: 290a 2020 2020 7265 7475 726e 2074 7570  ).    return tup
+0002ef60: 6c65 2841 7272 6179 4672 6f6d 5475 706c  le(ArrayFromTupl
+0002ef70: 6528 6c6f 6f70 2c20 756e 6971 7565 5f66  e(loop, unique_f
+0002ef80: 756e 6373 2e69 6e64 6578 2866 756e 6329  uncs.index(func)
+0002ef90: 2c20 7475 706c 6528 7368 6170 6529 2c20  , tuple(shape), 
+0002efa0: 6675 6e63 2e64 7479 7065 2920 666f 7220  func.dtype) for 
+0002efb0: 6675 6e63 2c20 7374 6172 742c 2073 746f  func, start, sto
+0002efc0: 702c 202a 7368 6170 6520 696e 2075 6e69  p, *shape in uni
+0002efd0: 7175 655f 6675 6e63 5f64 6174 6129 0a0a  que_func_data)..
+0002efe0: 0a40 7265 706c 6163 650a 6465 6620 7265  .@replace.def re
+0002eff0: 706c 6163 655f 6172 6775 6d65 6e74 7328  place_arguments(
+0002f000: 7661 6c75 652c 2061 7267 756d 656e 7473  value, arguments
+0002f010: 293a 0a20 2020 2027 2727 5265 706c 6163  ):.    '''Replac
+0002f020: 6520 3a63 6c61 7373 3a60 4172 6775 6d65  e :class:`Argume
+0002f030: 6e74 6020 6f62 6a65 6374 7320 696e 2060  nt` objects in `
+0002f040: 6076 616c 7565 6060 2e0a 0a20 2020 2052  `value``...    R
+0002f050: 6570 6c61 6365 203a 636c 6173 733a 6041  eplace :class:`A
+0002f060: 7267 756d 656e 7460 206f 626a 6563 7473  rgument` objects
+0002f070: 2069 6e20 6060 7661 6c75 6560 6020 6163   in ``value`` ac
+0002f080: 636f 7264 696e 6720 746f 2074 6865 2060  cording to the `
+0002f090: 6061 7267 756d 656e 7473 6060 0a20 2020  `arguments``.   
+0002f0a0: 206d 6170 2c20 7461 6b69 6e67 2069 6e74   map, taking int
+0002f0b0: 6f20 6163 636f 756e 7420 6465 7269 7661  o account deriva
+0002f0c0: 7469 7665 7320 746f 2074 6865 206c 6f63  tives to the loc
+0002f0d0: 616c 2063 6f6f 7264 696e 6174 6573 2e0a  al coordinates..
+0002f0e0: 0a20 2020 2041 7267 730a 2020 2020 2d2d  .    Args.    --
+0002f0f0: 2d2d 0a20 2020 2076 616c 7565 203a 203a  --.    value : :
+0002f100: 636c 6173 733a 6041 7272 6179 600a 2020  class:`Array`.  
+0002f110: 2020 2020 2020 4172 7261 7920 746f 2062        Array to b
+0002f120: 6520 6564 6974 6564 2e0a 2020 2020 6172  e edited..    ar
+0002f130: 6775 6d65 6e74 7320 3a20 3a63 6c61 7373  guments : :class
+0002f140: 3a60 636f 6c6c 6563 7469 6f6e 732e 6162  :`collections.ab
+0002f150: 632e 4d61 7070 696e 6760 2077 6974 6820  c.Mapping` with 
+0002f160: 3a63 6c61 7373 3a60 4172 7261 7960 5c5c  :class:`Array`\\
+0002f170: 7320 6173 2076 616c 7565 730a 2020 2020  s as values.    
+0002f180: 2020 2020 3a63 6c61 7373 3a60 4172 6775      :class:`Argu
+0002f190: 6d65 6e74 605c 5c73 2072 6570 6c61 6365  ment`\\s replace
+0002f1a0: 6d65 6e74 732e 2020 5468 6520 6b65 7920  ments.  The key 
+0002f1b0: 636f 7272 6573 706f 6e64 2074 6f20 7468  correspond to th
+0002f1c0: 6520 6060 6e61 6d65 6060 0a20 2020 2020  e ``name``.     
+0002f1d0: 2020 2070 6173 7365 6420 746f 2061 6e20     passed to an 
+0002f1e0: 3a63 6c61 7373 3a60 4172 6775 6d65 6e74  :class:`Argument
+0002f1f0: 6020 616e 6420 7468 6520 7661 6c75 6520  ` and the value 
+0002f200: 6973 2074 6865 2072 6570 6c61 6365 6d65  is the replaceme
+0002f210: 6e74 2e0a 0a20 2020 2052 6574 7572 6e73  nt...    Returns
+0002f220: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+0002f230: 203a 636c 6173 733a 6041 7272 6179 600a   :class:`Array`.
+0002f240: 2020 2020 2020 2020 5468 6520 6564 6974          The edit
+0002f250: 6564 2060 6076 616c 7565 6060 2e0a 2020  ed ``value``..  
+0002f260: 2020 2727 270a 2020 2020 6966 2069 7369    '''.    if isi
+0002f270: 6e73 7461 6e63 6528 7661 6c75 652c 2041  nstance(value, A
+0002f280: 7267 756d 656e 7429 2061 6e64 2076 616c  rgument) and val
+0002f290: 7565 2e5f 6e61 6d65 2069 6e20 6172 6775  ue._name in argu
+0002f2a0: 6d65 6e74 733a 0a20 2020 2020 2020 2076  ments:.        v
+0002f2b0: 203d 2061 7361 7272 6179 2861 7267 756d   = asarray(argum
+0002f2c0: 656e 7473 5b76 616c 7565 2e5f 6e61 6d65  ents[value._name
+0002f2d0: 5d29 0a20 2020 2020 2020 2061 7373 6572  ]).        asser
+0002f2e0: 7420 6571 7561 6c73 6861 7065 2876 616c  t equalshape(val
+0002f2f0: 7565 2e73 6861 7065 2c20 762e 7368 6170  ue.shape, v.shap
+0002f300: 6529 2c20 2876 616c 7565 2e73 6861 7065  e), (value.shape
+0002f310: 2c20 762e 7368 6170 6529 0a20 2020 2020  , v.shape).     
+0002f320: 2020 2061 7373 6572 7420 7661 6c75 652e     assert value.
+0002f330: 6474 7970 6520 3d3d 2076 2e64 7479 7065  dtype == v.dtype
+0002f340: 2c20 2876 616c 7565 2e64 7479 7065 2c20  , (value.dtype, 
+0002f350: 762e 6474 7970 6529 0a20 2020 2020 2020  v.dtype).       
+0002f360: 2072 6574 7572 6e20 760a 0a0a 6465 6620   return v...def 
+0002f370: 6569 6e73 756d 2866 6d74 2c20 2a61 7267  einsum(fmt, *arg
+0002f380: 732c 202a 2a64 696d 7329 3a0a 2020 2020  s, **dims):.    
+0002f390: 2727 274d 756c 7469 706c 7920 616e 642f  '''Multiply and/
+0002f3a0: 6f72 2063 6f6e 7472 6163 7420 6172 7261  or contract arra
+0002f3b0: 7973 2076 6961 2066 6f72 6d61 7420 7374  ys via format st
+0002f3c0: 7269 6e67 2e0a 0a20 2020 2054 6865 2066  ring...    The f
+0002f3d0: 6f72 6d61 7420 7374 7269 6e67 2063 6f6e  ormat string con
+0002f3e0: 7369 7374 7320 6f66 2061 2063 6f6d 6d61  sists of a comma
+0002f3f0: 2073 6570 6172 6174 6564 206c 6973 7420   separated list 
+0002f400: 6f66 2061 7869 7320 6c61 6265 6c73 2c20  of axis labels, 
+0002f410: 666f 6c6c 6f77 6564 0a20 2020 2062 7920  followed.    by 
+0002f420: 6060 2d3e 6060 2061 6e64 2074 6865 2061  ``->`` and the a
+0002f430: 7869 7320 6c61 6265 6c73 206f 6620 7468  xis labels of th
+0002f440: 6520 7265 7475 726e 2076 616c 7565 2e20  e return value. 
+0002f450: 466f 7220 6578 616d 706c 652c 2074 6865  For example, the
+0002f460: 2066 6f6c 6c6f 7769 6e67 0a20 2020 2073   following.    s
+0002f470: 7761 7073 2074 6865 2061 7865 7320 6f66  waps the axes of
+0002f480: 2061 206d 6174 7269 783a 0a0a 2020 2020   a matrix:..    
+0002f490: 3e3e 3e20 6134 3520 3d20 6f6e 6573 2874  >>> a45 = ones(t
+0002f4a0: 7570 6c65 286d 6170 2863 6f6e 7374 616e  uple(map(constan
+0002f4b0: 742c 205b 342c 355d 2929 2920 2320 3478  t, [4,5]))) # 4x
+0002f4c0: 3520 6d61 7472 6978 0a20 2020 203e 3e3e  5 matrix.    >>>
+0002f4d0: 2065 696e 7375 6d28 2769 6a2d 3e6a 6927   einsum('ij->ji'
+0002f4e0: 2c20 6134 3529 0a20 2020 206e 7574 696c  , a45).    nutil
+0002f4f0: 732e 6576 616c 7561 626c 652e 5472 616e  s.evaluable.Tran
+0002f500: 7370 6f73 653c 663a 2835 292c 2834 293e  spose<f:(5),(4)>
+0002f510: 0a0a 2020 2020 4178 6973 206c 6162 656c  ..    Axis label
+0002f520: 7320 7468 6174 2064 6f20 6e6f 7420 6f63  s that do not oc
+0002f530: 6375 7220 696e 2074 6865 2072 6574 7572  cur in the retur
+0002f540: 6e20 7661 6c75 6520 6172 6520 7375 6d6d  n value are summ
+0002f550: 6564 2e20 466f 7220 6578 616d 706c 652c  ed. For example,
+0002f560: 0a20 2020 2074 6865 2066 6f6c 6c6f 7769  .    the followi
+0002f570: 6e67 2070 6572 666f 726d 7320 6120 6d61  ng performs a ma
+0002f580: 7472 6978 2d76 6563 746f 7220 7072 6f64  trix-vector prod
+0002f590: 7563 743a 0a0a 2020 2020 3e3e 3e20 6135  uct:..    >>> a5
+0002f5a0: 203d 206f 6e65 7328 7475 706c 6528 6d61   = ones(tuple(ma
+0002f5b0: 7028 636f 6e73 7461 6e74 2c20 5b35 5d29  p(constant, [5])
+0002f5c0: 2929 2023 2076 6563 746f 7220 7769 7468  )) # vector with
+0002f5d0: 206c 656e 6774 6820 350a 2020 2020 3e3e   length 5.    >>
+0002f5e0: 3e20 6569 6e73 756d 2827 696a 2c6a 2d3e  > einsum('ij,j->
+0002f5f0: 6927 2c20 6134 352c 2061 3529 0a20 2020  i', a45, a5).   
+0002f600: 206e 7574 696c 732e 6576 616c 7561 626c   nutils.evaluabl
+0002f610: 652e 5375 6d3c 663a 343e 0a0a 2020 2020  e.Sum<f:4>..    
+0002f620: 5468 6520 666f 6c6c 6f77 696e 6720 636f  The following co
+0002f630: 6e74 7261 6374 7320 6120 7468 6972 6420  ntracts a third 
+0002f640: 6f72 6465 7220 7465 6e73 6f72 2c20 6120  order tensor, a 
+0002f650: 6d61 7472 6978 2c20 616e 6420 6120 7665  matrix, and a ve
+0002f660: 6374 6f72 2c20 616e 640a 2020 2020 7472  ctor, and.    tr
+0002f670: 616e 7370 6f73 6573 2074 6865 2072 6573  ansposes the res
+0002f680: 756c 743a 0a0a 2020 2020 3e3e 3e20 6132  ult:..    >>> a2
+0002f690: 3334 203d 206f 6e65 7328 7475 706c 6528  34 = ones(tuple(
+0002f6a0: 6d61 7028 636f 6e73 7461 6e74 2c20 5b32  map(constant, [2
+0002f6b0: 2c33 2c34 5d29 2929 2023 2032 7833 7834  ,3,4]))) # 2x3x4
+0002f6c0: 2074 656e 736f 720a 2020 2020 3e3e 3e20   tensor.    >>> 
+0002f6d0: 6569 6e73 756d 2827 696a 6b2c 6b6c 2c6c  einsum('ijk,kl,l
+0002f6e0: 2d3e 6a69 272c 2061 3233 342c 2061 3435  ->ji', a234, a45
+0002f6f0: 2c20 6135 290a 2020 2020 6e75 7469 6c73  , a5).    nutils
+0002f700: 2e65 7661 6c75 6162 6c65 2e53 756d 3c66  .evaluable.Sum<f
+0002f710: 3a33 2c32 3e0a 0a20 2020 2049 6e20 6361  :3,2>..    In ca
+0002f720: 7365 2074 6865 2064 696d 656e 7369 6f6e  se the dimension
+0002f730: 206f 6620 7468 6520 696e 7075 7420 616e   of the input an
+0002f740: 6420 6f75 7470 7574 2061 7272 6179 7320  d output arrays 
+0002f750: 6d61 7920 7661 7279 2c20 6120 7661 7269  may vary, a vari
+0002f760: 6162 6c65 0a20 2020 206c 656e 6774 6820  able.    length 
+0002f770: 6178 6573 2067 726f 7570 2063 616e 2062  axes group can b
+0002f780: 6520 6465 6e6f 7465 6420 6279 2061 2063  e denoted by a c
+0002f790: 6170 6974 616c 2e20 4974 7320 6c65 6e67  apital. Its leng
+0002f7a0: 7468 2069 7320 6175 746f 6d61 7469 6361  th is automatica
+0002f7b0: 6c6c 790a 2020 2020 6573 7461 626c 6973  lly.    establis
+0002f7c0: 6865 6420 6261 7365 6420 6f6e 2074 6865  hed based on the
+0002f7d0: 2064 696d 656e 7369 6f6e 206f 6620 7468   dimension of th
+0002f7e0: 6520 696e 7075 7420 6172 7261 7973 2e20  e input arrays. 
+0002f7f0: 5468 6520 666f 6c6c 6f77 696e 6720 6578  The following ex
+0002f800: 616d 706c 650a 2020 2020 7065 7266 6f72  ample.    perfor
+0002f810: 6d73 2061 2074 656e 736f 7220 7072 6f64  ms a tensor prod
+0002f820: 7563 7420 6f66 2061 6e20 6172 7261 7920  uct of an array 
+0002f830: 616e 6420 6120 7665 6374 6f72 3a0a 0a20  and a vector:.. 
+0002f840: 2020 203e 3e3e 2065 696e 7375 6d28 2741     >>> einsum('A
+0002f850: 2c69 2d3e 4169 272c 2061 3233 342c 2061  ,i->Ai', a234, a
+0002f860: 3529 0a20 2020 206e 7574 696c 732e 6576  5).    nutils.ev
+0002f870: 616c 7561 626c 652e 4d75 6c74 6970 6c79  aluable.Multiply
+0002f880: 3c66 3a32 2c33 2c34 2c35 3e0a 0a20 2020  <f:2,3,4,5>..   
+0002f890: 2054 6865 2066 6f72 6d61 7420 7374 7269   The format stri
+0002f8a0: 6e67 206d 6179 2063 6f6e 7461 696e 206d  ng may contain m
+0002f8b0: 756c 7469 706c 6520 7661 7269 6162 6c65  ultiple variable
+0002f8c0: 206c 656e 6774 6820 6178 6573 2067 726f   length axes gro
+0002f8d0: 7570 732c 2062 7574 2074 6865 6972 0a20  ups, but their. 
+0002f8e0: 2020 206c 656e 6774 6873 206d 7573 7420     lengths must 
+0002f8f0: 6265 2072 6573 6f6c 7661 626c 6520 6672  be resolvable fr
+0002f900: 6f6d 206c 6566 7420 746f 2072 6967 6874  om left to right
+0002f910: 2e20 496e 2063 6173 6520 7468 6973 2069  . In case this i
+0002f920: 7320 6e6f 7420 706f 7373 6962 6c65 2c0a  s not possible,.
+0002f930: 2020 2020 6c65 6e67 7468 7320 6d61 7920      lengths may 
+0002f940: 6265 2073 7065 6369 6669 6564 2061 7320  be specified as 
+0002f950: 6b65 7977 6f72 6420 6172 6775 6d65 6e74  keyword argument
+0002f960: 732e 0a0a 2020 2020 3e3e 3e20 6569 6e73  s...    >>> eins
+0002f970: 756d 2827 416a 422c 692d 3e41 696a 4227  um('AjB,i->AijB'
+0002f980: 2c20 6132 3334 2c20 6135 2c20 423d 3129  , a234, a5, B=1)
+0002f990: 0a20 2020 206e 7574 696c 732e 6576 616c  .    nutils.eval
+0002f9a0: 7561 626c 652e 4d75 6c74 6970 6c79 3c66  uable.Multiply<f
+0002f9b0: 3a32 2c35 2c33 2c34 3e0a 2020 2020 2727  :2,5,3,4>.    ''
+0002f9c0: 270a 0a20 2020 2069 6620 6e6f 7420 616c  '..    if not al
+0002f9d0: 6c28 6973 696e 7374 616e 6365 2861 7267  l(isinstance(arg
+0002f9e0: 2c20 4172 7261 7929 2066 6f72 2061 7267  , Array) for arg
+0002f9f0: 2069 6e20 6172 6773 293a 0a20 2020 2020   in args):.     
+0002fa00: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+0002fa10: 726f 7228 2761 7267 756d 656e 7473 206d  ror('arguments m
+0002fa20: 7573 7420 6265 2041 7272 6179 2076 616c  ust be Array val
+0002fa30: 7565 6427 290a 0a20 2020 2073 696e 2c20  ued')..    sin, 
+0002fa40: 736f 7574 203d 2066 6d74 2e73 706c 6974  sout = fmt.split
+0002fa50: 2827 2d3e 2729 0a20 2020 2073 696e 203d  ('->').    sin =
+0002fa60: 2073 696e 2e73 706c 6974 2827 2c27 290a   sin.split(',').
+0002fa70: 0a20 2020 2069 6620 6c65 6e28 7369 6e29  .    if len(sin)
+0002fa80: 2021 3d20 6c65 6e28 6172 6773 293a 0a20   != len(args):. 
+0002fa90: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0002faa0: 7565 4572 726f 7228 276e 756d 6265 7220  ueError('number 
+0002fab0: 6f66 2061 7267 756d 656e 7473 2064 6f65  of arguments doe
+0002fac0: 7320 6e6f 7420 6d61 7463 6820 666f 726d  s not match form
+0002fad0: 6174 2073 7472 696e 6727 290a 0a20 2020  at string')..   
+0002fae0: 2069 6620 616e 7928 6c65 6e28 7329 2021   if any(len(s) !
+0002faf0: 3d20 6c65 6e28 7365 7428 7329 2920 666f  = len(set(s)) fo
+0002fb00: 7220 7320 696e 2028 2a73 696e 2c20 736f  r s in (*sin, so
+0002fb10: 7574 2929 3a0a 2020 2020 2020 2020 7261  ut)):.        ra
+0002fb20: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
+0002fb30: 696e 7465 726e 616c 2072 6570 6574 6974  internal repetit
+0002fb40: 696f 6e73 2061 7265 206e 6f74 2073 7570  ions are not sup
+0002fb50: 706f 7274 6564 2729 0a0a 2020 2020 6966  ported')..    if
+0002fb60: 2061 6e79 286e 203c 2030 2066 6f72 206e   any(n < 0 for n
+0002fb70: 2069 6e20 6469 6d73 2e76 616c 7565 7328   in dims.values(
+0002fb80: 2929 3a0a 2020 2020 2020 2020 7261 6973  )):.        rais
+0002fb90: 6520 5661 6c75 6545 7272 6f72 2827 6178  e ValueError('ax
+0002fba0: 6973 2067 726f 7570 2064 696d 656e 7369  is group dimensi
+0002fbb0: 6f6e 7320 6361 6e6e 6f74 2062 6520 6e65  ons cannot be ne
+0002fbc0: 6761 7469 7665 2729 0a0a 2020 2020 666f  gative')..    fo
+0002fbd0: 7220 6320 696e 2027 6162 6364 6566 6768  r c in 'abcdefgh
+0002fbe0: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
+0002fbf0: 797a 273a 0a20 2020 2020 2020 2064 696d  yz':.        dim
+0002fc00: 732e 7365 7464 6566 6175 6c74 2863 2c20  s.setdefault(c, 
+0002fc10: 3129 2020 2320 6c6f 7765 7263 6173 6520  1)  # lowercase 
+0002fc20: 6368 6172 6163 7465 7273 2064 6566 6175  characters defau
+0002fc30: 6c74 2074 6f20 7369 6e67 6c65 2064 696d  lt to single dim
+0002fc40: 656e 7369 6f6e 0a0a 2020 2020 666f 7220  ension..    for 
+0002fc50: 732c 2061 7267 2069 6e20 7a69 7028 7369  s, arg in zip(si
+0002fc60: 6e2c 2061 7267 7329 3a0a 2020 2020 2020  n, args):.      
+0002fc70: 2020 6d69 7373 696e 675f 6469 6d73 203d    missing_dims =
+0002fc80: 2061 7267 2e6e 6469 6d20 2d20 6275 696c   arg.ndim - buil
+0002fc90: 7469 6e73 2e73 756d 2864 696d 732e 6765  tins.sum(dims.ge
+0002fca0: 7428 632c 2030 2920 666f 7220 6320 696e  t(c, 0) for c in
+0002fcb0: 2073 290a 2020 2020 2020 2020 756e 6b6e   s).        unkn
+0002fcc0: 6f77 6e5f 6178 6573 203d 205b 6320 666f  own_axes = [c fo
+0002fcd0: 7220 6320 696e 2073 2069 6620 6320 6e6f  r c in s if c no
+0002fce0: 7420 696e 2064 696d 735d 0a20 2020 2020  t in dims].     
+0002fcf0: 2020 2069 6620 6c65 6e28 756e 6b6e 6f77     if len(unknow
+0002fd00: 6e5f 6178 6573 2920 3d3d 2031 2061 6e64  n_axes) == 1 and
+0002fd10: 206d 6973 7369 6e67 5f64 696d 7320 3e3d   missing_dims >=
+0002fd20: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+0002fd30: 6469 6d73 5b75 6e6b 6e6f 776e 5f61 7865  dims[unknown_axe
+0002fd40: 735b 305d 5d20 3d20 6d69 7373 696e 675f  s[0]] = missing_
+0002fd50: 6469 6d73 0a20 2020 2020 2020 2065 6c69  dims.        eli
+0002fd60: 6620 6c65 6e28 756e 6b6e 6f77 6e5f 6178  f len(unknown_ax
+0002fd70: 6573 2920 3e20 313a 0a20 2020 2020 2020  es) > 1:.       
+0002fd80: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+0002fd90: 4572 726f 7228 2763 616e 6e6f 7420 6573  Error('cannot es
+0002fda0: 7461 626c 6973 6820 6c65 6e67 7468 206f  tablish length o
+0002fdb0: 6620 7661 7269 6162 6c65 2067 726f 7570  f variable group
+0002fdc0: 7320 7b7d 272e 666f 726d 6174 2827 2c20  s {}'.format(', 
+0002fdd0: 272e 6a6f 696e 2875 6e6b 6e6f 776e 5f61  '.join(unknown_a
+0002fde0: 7865 7329 2929 0a20 2020 2020 2020 2065  xes))).        e
+0002fdf0: 6c69 6620 6d69 7373 696e 675f 6469 6d73  lif missing_dims
+0002fe00: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0002fe10: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
+0002fe20: 6172 6775 6d65 6e74 2064 696d 656e 7369  argument dimensi
+0002fe30: 6f6e 7320 6172 6520 696e 636f 6e73 6973  ons are inconsis
+0002fe40: 7465 6e74 2077 6974 6820 666f 726d 6174  tent with format
+0002fe50: 2073 7472 696e 6727 290a 0a20 2020 2023   string')..    #
+0002fe60: 2065 7870 616e 6420 6368 6172 6163 7465   expand characte
+0002fe70: 7273 2074 6f20 6d61 7463 6820 6172 6775  rs to match argu
+0002fe80: 6d65 6e74 2064 696d 656e 7369 6f6e 0a20  ment dimension. 
+0002fe90: 2020 202a 7369 6e2c 2073 6f75 7420 3d20     *sin, sout = 
+0002fea0: 5b5b 2863 2c20 6429 2066 6f72 2063 2069  [[(c, d) for c i
+0002feb0: 6e20 7320 666f 7220 6420 696e 2072 616e  n s for d in ran
+0002fec0: 6765 2864 696d 735b 635d 295d 2066 6f72  ge(dims[c])] for
+0002fed0: 2073 2069 6e20 282a 7369 6e2c 2073 6f75   s in (*sin, sou
+0002fee0: 7429 5d0a 2020 2020 7361 6c6c 203d 2073  t)].    sall = s
+0002fef0: 6f75 7420 2b20 736f 7274 6564 287b 6320  out + sorted({c 
+0002ff00: 666f 7220 7320 696e 2073 696e 2066 6f72  for s in sin for
+0002ff10: 2063 2069 6e20 7320 6966 2063 206e 6f74   c in s if c not
+0002ff20: 2069 6e20 736f 7574 7d29 0a0a 2020 2020   in sout})..    
+0002ff30: 7368 6170 6573 203d 207b 7d0a 2020 2020  shapes = {}.    
+0002ff40: 666f 7220 732c 2061 7267 2069 6e20 7a69  for s, arg in zi
+0002ff50: 7028 7369 6e2c 2061 7267 7329 3a0a 2020  p(sin, args):.  
+0002ff60: 2020 2020 2020 6173 7365 7274 206c 656e        assert len
+0002ff70: 2873 2920 3d3d 2061 7267 2e6e 6469 6d0a  (s) == arg.ndim.
+0002ff80: 2020 2020 2020 2020 666f 7220 632c 2073          for c, s
+0002ff90: 6820 696e 207a 6970 2873 2c20 6172 672e  h in zip(s, arg.
+0002ffa0: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
+0002ffb0: 2020 2020 6966 206e 6f74 205f 6571 7561      if not _equa
+0002ffc0: 6c73 5f73 696d 706c 6966 6965 6428 7368  ls_simplified(sh
+0002ffd0: 6170 6573 2e73 6574 6465 6661 756c 7428  apes.setdefault(
+0002ffe0: 632c 2073 6829 2c20 7368 293a 0a20 2020  c, sh), sh):.   
+0002fff0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00030000: 7365 2056 616c 7565 4572 726f 7228 2773  se ValueError('s
+00030010: 6861 7065 7320 646f 206e 6f74 206d 6174  hapes do not mat
+00030020: 6368 2066 6f72 2061 7869 7320 7b30 5b30  ch for axis {0[0
+00030030: 5d7d 7b30 5b31 5d7d 272e 666f 726d 6174  ]}{0[1]}'.format
+00030040: 2863 2929 0a0a 2020 2020 7265 7420 3d20  (c))..    ret = 
+00030050: 4e6f 6e65 0a20 2020 2066 6f72 2073 2c20  None.    for s, 
+00030060: 6172 6720 696e 207a 6970 2873 696e 2c20  arg in zip(sin, 
+00030070: 6172 6773 293a 0a20 2020 2020 2020 2069  args):.        i
+00030080: 6e64 6578 203d 207b 633a 2069 2066 6f72  ndex = {c: i for
+00030090: 2069 2c20 6320 696e 2065 6e75 6d65 7261   i, c in enumera
+000300a0: 7465 2873 297d 0a20 2020 2020 2020 2066  te(s)}.        f
+000300b0: 6f72 2063 2069 6e20 7361 6c6c 3a0a 2020  or c in sall:.  
+000300c0: 2020 2020 2020 2020 2020 6966 2063 206e            if c n
+000300d0: 6f74 2069 6e20 696e 6465 783a 0a20 2020  ot in index:.   
+000300e0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+000300f0: 6578 5b63 5d20 3d20 6172 672e 6e64 696d  ex[c] = arg.ndim
+00030100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030110: 2061 7267 203d 2049 6e73 6572 7441 7869   arg = InsertAxi
+00030120: 7328 6172 672c 2073 6861 7065 735b 635d  s(arg, shapes[c]
+00030130: 290a 2020 2020 2020 2020 7620 3d20 5472  ).        v = Tr
+00030140: 616e 7370 6f73 6528 6172 672c 2074 7570  anspose(arg, tup
+00030150: 6c65 2869 6e64 6578 5b63 5d20 666f 7220  le(index[c] for 
+00030160: 6320 696e 2073 616c 6c29 290a 2020 2020  c in sall)).    
+00030170: 2020 2020 7265 7420 3d20 7620 6966 2072      ret = v if r
+00030180: 6574 2069 7320 4e6f 6e65 2065 6c73 6520  et is None else 
+00030190: 7265 7420 2a20 760a 2020 2020 666f 7220  ret * v.    for 
+000301a0: 6920 696e 2072 616e 6765 286c 656e 2873  i in range(len(s
+000301b0: 6f75 7429 2c20 6c65 6e28 7361 6c6c 2929  out), len(sall))
+000301c0: 3a0a 2020 2020 2020 2020 7265 7420 3d20  :.        ret = 
+000301d0: 5375 6d28 7265 7429 0a20 2020 2072 6574  Sum(ret).    ret
+000301e0: 7572 6e20 7265 740a 0a0a 4075 7469 6c2e  urn ret...@util.
+000301f0: 7369 6e67 6c65 5f6f 725f 6d75 6c74 6970  single_or_multip
+00030200: 6c65 0a64 6566 2065 7661 6c5f 7370 6172  le.def eval_spar
+00030210: 7365 2866 756e 6373 3a20 4173 4576 616c  se(funcs: AsEval
+00030220: 7561 626c 6541 7272 6179 2c20 2a2a 6172  uableArray, **ar
+00030230: 6775 6d65 6e74 733a 2074 7970 696e 672e  guments: typing.
+00030240: 4d61 7070 696e 675b 7374 722c 206e 756d  Mapping[str, num
+00030250: 7079 2e6e 6461 7272 6179 5d29 202d 3e20  py.ndarray]) -> 
+00030260: 7479 7069 6e67 2e54 7570 6c65 5b6e 756d  typing.Tuple[num
+00030270: 7079 2e6e 6461 7272 6179 2c20 2e2e 2e5d  py.ndarray, ...]
+00030280: 3a0a 2020 2020 2727 2745 7661 6c75 6174  :.    '''Evaluat
+00030290: 6520 6f6e 6520 6f72 2073 6576 6572 616c  e one or several
+000302a0: 2041 7272 6179 206f 626a 6563 7473 2061   Array objects a
+000302b0: 7320 7370 6172 7365 2064 6174 612e 0a0a  s sparse data...
+000302c0: 2020 2020 4172 6773 0a20 2020 202d 2d2d      Args.    ---
+000302d0: 2d0a 2020 2020 6675 6e63 7320 3a20 3a63  -.    funcs : :c
+000302e0: 6c61 7373 3a60 7475 706c 6560 206f 6620  lass:`tuple` of 
+000302f0: 4172 7261 7920 6f62 6a65 6374 730a 2020  Array objects.  
+00030300: 2020 2020 2020 4172 7261 7973 2074 6f20        Arrays to 
+00030310: 6265 2065 7661 6c75 6174 6564 2e0a 2020  be evaluated..  
+00030320: 2020 6172 6775 6d65 6e74 7320 3a20 3a63    arguments : :c
+00030330: 6c61 7373 3a60 6469 6374 6020 2864 6566  lass:`dict` (def
+00030340: 6175 6c74 3a20 4e6f 6e65 290a 2020 2020  ault: None).    
+00030350: 2020 2020 4f70 7469 6f6e 616c 2061 7267      Optional arg
+00030360: 756d 656e 7473 2066 6f72 2066 756e 6374  uments for funct
+00030370: 696f 6e20 6576 616c 7561 7469 6f6e 2e0a  ion evaluation..
+00030380: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+00030390: 202d 2d2d 2d2d 2d2d 0a20 2020 2072 6573   -------.    res
+000303a0: 756c 7473 203a 203a 636c 6173 733a 6074  ults : :class:`t
+000303b0: 7570 6c65 6020 6f66 2073 7061 7273 6520  uple` of sparse 
+000303c0: 6461 7461 2061 7272 6179 730a 2020 2020  data arrays.    
+000303d0: 2727 270a 0a20 2020 2066 756e 6373 203d  '''..    funcs =
+000303e0: 205b 6675 6e63 2e61 735f 6576 616c 7561   [func.as_evalua
+000303f0: 626c 655f 6172 7261 7920 666f 7220 6675  ble_array for fu
+00030400: 6e63 2069 6e20 6675 6e63 735d 0a20 2020  nc in funcs].   
+00030410: 2073 6861 7065 5f63 6875 6e6b 7320 3d20   shape_chunks = 
+00030420: 5475 706c 6528 7475 706c 6528 5475 706c  Tuple(tuple(Tupl
+00030430: 6528 6275 696c 7469 6e73 2e73 756d 2866  e(builtins.sum(f
+00030440: 756e 632e 7369 6d70 6c69 6669 6564 2e5f  unc.simplified._
+00030450: 6173 7370 6172 7365 2c20 6675 6e63 2e73  assparse, func.s
+00030460: 6861 7065 2929 2066 6f72 2066 756e 6320  hape)) for func 
+00030470: 696e 2066 756e 6373 2929 0a20 2020 2077  in funcs)).    w
+00030480: 6974 6820 7368 6170 655f 6368 756e 6b73  ith shape_chunks
+00030490: 2e6f 7074 696d 697a 6564 5f66 6f72 5f6e  .optimized_for_n
+000304a0: 756d 7079 2e73 6573 7369 6f6e 2867 7261  umpy.session(gra
+000304b0: 7068 7669 7a3d 6772 6170 6876 697a 2920  phviz=graphviz) 
+000304c0: 6173 2065 7661 6c3a 0a20 2020 2020 2020  as eval:.       
+000304d0: 2066 6f72 2066 756e 632c 2061 7267 7320   for func, args 
+000304e0: 696e 207a 6970 2866 756e 6373 2c20 6576  in zip(funcs, ev
+000304f0: 616c 282a 2a61 7267 756d 656e 7473 2929  al(**arguments))
+00030500: 3a0a 2020 2020 2020 2020 2020 2020 7368  :.            sh
+00030510: 6170 6520 3d20 7475 706c 6528 6d61 7028  ape = tuple(map(
+00030520: 696e 742c 2061 7267 735b 3a66 756e 632e  int, args[:func.
+00030530: 6e64 696d 5d29 290a 2020 2020 2020 2020  ndim])).        
+00030540: 2020 2020 6368 756e 6b73 203d 205b 6172      chunks = [ar
+00030550: 6773 5b69 3a69 2b66 756e 632e 6e64 696d  gs[i:i+func.ndim
+00030560: 2b31 5d20 666f 7220 6920 696e 2072 616e  +1] for i in ran
+00030570: 6765 2866 756e 632e 6e64 696d 2c20 6c65  ge(func.ndim, le
+00030580: 6e28 6172 6773 292c 2066 756e 632e 6e64  n(args), func.nd
+00030590: 696d 2b31 295d 0a20 2020 2020 2020 2020  im+1)].         
+000305a0: 2020 206c 656e 6774 6820 3d20 6275 696c     length = buil
+000305b0: 7469 6e73 2e73 756d 2876 616c 7565 732e  tins.sum(values.
+000305c0: 7369 7a65 2066 6f72 202a 696e 6469 6365  size for *indice
+000305d0: 732c 2076 616c 7565 7320 696e 2063 6875  s, values in chu
+000305e0: 6e6b 7329 0a20 2020 2020 2020 2020 2020  nks).           
+000305f0: 2064 6174 6120 3d20 6e75 6d70 792e 656d   data = numpy.em
+00030600: 7074 7928 286c 656e 6774 682c 292c 2064  pty((length,), d
+00030610: 7479 7065 3d73 7061 7273 652e 6474 7970  type=sparse.dtyp
+00030620: 6528 7368 6170 652c 2066 756e 632e 6474  e(shape, func.dt
+00030630: 7970 6529 290a 2020 2020 2020 2020 2020  ype)).          
+00030640: 2020 7374 6172 7420 3d20 300a 2020 2020    start = 0.    
+00030650: 2020 2020 2020 2020 666f 7220 2a69 6e64          for *ind
+00030660: 6963 6573 2c20 7661 6c75 6573 2069 6e20  ices, values in 
+00030670: 6368 756e 6b73 3a0a 2020 2020 2020 2020  chunks:.        
+00030680: 2020 2020 2020 2020 7374 6f70 203d 2073          stop = s
+00030690: 7461 7274 202b 2076 616c 7565 732e 7369  tart + values.si
+000306a0: 7a65 0a20 2020 2020 2020 2020 2020 2020  ze.             
+000306b0: 2020 2064 203d 2064 6174 615b 7374 6172     d = data[star
+000306c0: 743a 7374 6f70 5d2e 7265 7368 6170 6528  t:stop].reshape(
+000306d0: 7661 6c75 6573 2e73 6861 7065 290a 2020  values.shape).  
+000306e0: 2020 2020 2020 2020 2020 2020 2020 645b                d[
+000306f0: 2776 616c 7565 275d 203d 2076 616c 7565  'value'] = value
+00030700: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00030710: 2020 666f 7220 6964 696d 2c20 6969 2069    for idim, ii i
+00030720: 6e20 656e 756d 6572 6174 6528 696e 6469  n enumerate(indi
+00030730: 6365 7329 3a0a 2020 2020 2020 2020 2020  ces):.          
+00030740: 2020 2020 2020 2020 2020 645b 2769 6e64            d['ind
+00030750: 6578 275d 5b27 6927 2b73 7472 2869 6469  ex']['i'+str(idi
+00030760: 6d29 5d20 3d20 6969 0a20 2020 2020 2020  m)] = ii.       
+00030770: 2020 2020 2020 2020 2073 7461 7274 203d           start =
+00030780: 2073 746f 700a 2020 2020 2020 2020 2020   stop.          
+00030790: 2020 7969 656c 6420 6461 7461 0a0a 0a69    yield data...i
+000307a0: 6620 5f5f 6e61 6d65 5f5f 203d 3d20 275f  f __name__ == '_
+000307b0: 5f6d 6169 6e5f 5f27 3a0a 2020 2020 2320  _main__':.    # 
+000307c0: 4469 6167 6e6f 7374 6963 7320 666f 7220  Diagnostics for 
+000307d0: 7468 6520 6465 7665 6c6f 706d 656e 7420  the development 
+000307e0: 666f 7220 7369 6d70 6c69 6679 206f 7065  for simplify ope
+000307f0: 7261 7469 6f6e 732e 0a20 2020 2073 696d  rations..    sim
+00030800: 706c 6966 795f 7072 696f 7269 7479 203d  plify_priority =
+00030810: 2028 0a20 2020 2020 2020 2054 7261 6e73   (.        Trans
+00030820: 706f 7365 2c20 5261 7665 6c2c 2020 2320  pose, Ravel,  # 
+00030830: 7265 696e 7465 7270 7265 7461 7469 6f6e  reinterpretation
+00030840: 0a20 2020 2020 2020 2049 6e73 6572 7441  .        InsertA
+00030850: 7869 732c 2049 6e66 6c61 7465 2c20 4469  xis, Inflate, Di
+00030860: 6167 6f6e 616c 697a 652c 2020 2320 7369  agonalize,  # si
+00030870: 7a65 2069 6e63 7265 6173 696e 670a 2020  ze increasing.  
+00030880: 2020 2020 2020 4d75 6c74 6970 6c79 2c20        Multiply, 
+00030890: 4164 642c 204c 6f6f 7053 756d 2c20 5369  Add, LoopSum, Si
+000308a0: 676e 2c20 506f 7765 722c 2049 6e76 6572  gn, Power, Inver
+000308b0: 7365 2c20 556e 7261 7665 6c2c 2020 2320  se, Unravel,  # 
+000308c0: 7369 7a65 2070 7265 7365 7276 696e 670a  size preserving.
+000308d0: 2020 2020 2020 2020 5072 6f64 7563 742c          Product,
+000308e0: 2044 6574 6572 6d69 6e61 6e74 2c20 5461   Determinant, Ta
+000308f0: 6b65 4469 6167 2c20 5461 6b65 2c20 5375  keDiag, Take, Su
+00030900: 6d29 2020 2320 7369 7a65 2064 6563 7265  m)  # size decre
+00030910: 6173 696e 670a 2020 2020 2320 5468 6520  asing.    # The 
+00030920: 7369 6d70 6c69 6679 2070 7269 6f72 6974  simplify priorit
+00030930: 7920 6465 6669 6e65 7320 7468 6520 7072  y defines the pr
+00030940: 6566 6572 7265 6420 6f72 6465 7220 696e  eferred order in
+00030950: 2077 6869 6368 206f 7065 7261 7469 6f6e   which operation
+00030960: 7320 6172 650a 2020 2020 2320 7065 7266  s are.    # perf
+00030970: 6f72 6d65 643a 2073 6861 7065 2064 6563  ormed: shape dec
+00030980: 7265 6173 696e 6720 6f70 6572 6174 696f  reasing operatio
+00030990: 6e73 2073 7563 6820 6173 2053 756d 2061  ns such as Sum a
+000309a0: 6e64 2054 616b 6520 7368 6f75 6c64 2062  nd Take should b
+000309b0: 6520 646f 6e65 0a20 2020 2023 2061 7320  e done.    # as 
+000309c0: 736f 6f6e 2061 7320 706f 7373 6962 6c65  soon as possible
+000309d0: 2c20 616e 6420 7368 6170 6520 696e 6372  , and shape incr
+000309e0: 6561 7369 6e67 206f 7065 7261 7469 6f6e  easing operation
+000309f0: 7320 7375 6368 2061 7320 496e 666c 6174  s such as Inflat
+00030a00: 6520 616e 640a 2020 2020 2320 4469 6167  e and.    # Diag
+00030a10: 6f6e 616c 697a 6520 6173 206c 6174 6520  onalize as late 
+00030a20: 6173 2070 6f73 7369 626c 652e 2049 6e20  as possible. In 
+00030a30: 7368 7566 666c 696e 6720 7468 6520 6f72  shuffling the or
+00030a40: 6465 7220 6f66 206f 7065 7261 7469 6f6e  der of operation
+00030a50: 7320 7468 650a 2020 2020 2320 7477 6f20  s the.    # two 
+00030a60: 636c 6173 7365 7320 6d69 6768 7420 616e  classes might an
+00030a70: 6e69 6869 6c61 7465 2065 6163 6820 6f74  nihilate each ot
+00030a80: 6865 722c 2066 6f72 2065 7861 6d70 6c65  her, for example
+00030a90: 2077 6865 6e20 6120 5375 6d20 7061 7373   when a Sum pass
+00030aa0: 6573 0a20 2020 2023 2074 6872 6f75 6768  es.    # through
+00030ab0: 2061 2044 6961 676f 6e61 6c69 7a65 2e20   a Diagonalize. 
+00030ac0: 416e 7920 7368 6170 6520 696e 6372 6561  Any shape increa
+00030ad0: 7369 6e67 206f 7065 7261 7469 6f6e 7320  sing operations 
+00030ae0: 7468 6174 2072 656d 6169 6e20 7368 6f75  that remain shou
+00030af0: 6c64 0a20 2020 2023 2065 6e64 2075 7020  ld.    # end up 
+00030b00: 6174 2074 6865 2073 7572 6661 6365 2c20  at the surface, 
+00030b10: 6578 706f 7369 6e67 2073 7061 7273 6974  exposing sparsit
+00030b20: 7920 6279 206d 6561 6e73 206f 6620 7468  y by means of th
+00030b30: 6520 5f61 7373 7061 7273 6520 6d65 7468  e _assparse meth
+00030b40: 6f64 2e0a 2020 2020 6174 7472 7320 3d20  od..    attrs = 
+00030b50: 5b27 5f27 2b63 6c73 2e5f 5f6e 616d 655f  ['_'+cls.__name_
+00030b60: 5f2e 6c6f 7765 7228 2920 666f 7220 636c  _.lower() for cl
+00030b70: 7320 696e 2073 696d 706c 6966 795f 7072  s in simplify_pr
+00030b80: 696f 7269 7479 5d0a 2020 2020 2320 5468  iority].    # Th
+00030b90: 6520 7369 6d70 6c69 6679 206f 7065 7261  e simplify opera
+00030ba0: 7469 6f6e 7320 7265 7370 6f6e 7369 626c  tions responsibl
+00030bb0: 6520 666f 7220 7377 6170 7069 6e67 2028  e for swapping (
+00030bc0: 612e 6f2e 2920 6172 6520 6d65 7468 6f64  a.o.) are method
+00030bd0: 7320 6e61 6d65 640a 2020 2020 2320 275f  s named.    # '_
+00030be0: 6164 6427 2c20 275f 6d75 6c74 6970 6c79  add', '_multiply
+00030bf0: 272c 2065 7463 2e20 496e 206f 7264 6572  ', etc. In order
+00030c00: 2074 6f20 6176 6f69 6420 7265 6375 7273   to avoid recurs
+00030c10: 696f 6e73 2074 6865 206f 7065 7261 7469  ions the operati
+00030c20: 6f6e 730a 2020 2020 2320 7368 6f75 6c64  ons.    # should
+00030c30: 206f 6e6c 7920 6265 2064 6566 696e 6564   only be defined
+00030c40: 2069 6e20 7468 6520 6469 7265 6374 696f   in the directio
+00030c50: 6e20 6465 6669 6e65 6420 6279 206f 7065  n defined by ope
+00030c60: 7261 746f 7220 7072 696f 7269 7479 2e20  rator priority. 
+00030c70: 5468 650a 2020 2020 2320 666f 6c6c 6f77  The.    # follow
+00030c80: 696e 6720 636f 6465 2077 6172 6e73 2067  ing code warns g
+00030c90: 6169 6e73 7420 7669 6f6c 6174 696f 6e73  ainst violations
+00030ca0: 206f 6620 7468 6973 2072 756c 6520 616e   of this rule an
+00030cb0: 6420 6c69 7374 7320 7065 726d 6973 7369  d lists permissi
+00030cc0: 626c 650a 2020 2020 2320 7369 6d70 6c69  ble.    # simpli
+00030cd0: 6669 6361 7469 6f6e 7320 7468 6174 2068  fications that h
+00030ce0: 6176 6520 6e6f 7420 7965 7420 6265 656e  ave not yet been
+00030cf0: 2069 6d70 6c65 6d65 6e74 6564 2e0a 2020   implemented..  
+00030d00: 2020 666f 7220 692c 2063 6c73 2069 6e20    for i, cls in 
+00030d10: 656e 756d 6572 6174 6528 7369 6d70 6c69  enumerate(simpli
+00030d20: 6679 5f70 7269 6f72 6974 7929 3a0a 2020  fy_priority):.  
+00030d30: 2020 2020 2020 7761 726e 203d 205b 6174        warn = [at
+00030d40: 7472 2066 6f72 2061 7474 7220 696e 2061  tr for attr in a
+00030d50: 7474 7273 5b3a 695d 2069 6620 6765 7461  ttrs[:i] if geta
+00030d60: 7474 7228 636c 732c 2061 7474 7229 2069  ttr(cls, attr) i
+00030d70: 7320 6e6f 7420 6765 7461 7474 7228 4172  s not getattr(Ar
+00030d80: 7261 792c 2061 7474 7229 5d0a 2020 2020  ray, attr)].    
+00030d90: 2020 2020 6966 2077 6172 6e3a 0a20 2020      if warn:.   
+00030da0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00030db0: 5b21 5d20 7b7d 2073 686f 756c 6420 6e6f  [!] {} should no
+00030dc0: 7420 6465 6669 6e65 207b 7d27 2e66 6f72  t define {}'.for
+00030dd0: 6d61 7428 636c 732e 5f5f 6e61 6d65 5f5f  mat(cls.__name__
+00030de0: 2c20 272c 2027 2e6a 6f69 6e28 7761 726e  , ', '.join(warn
+00030df0: 2929 290a 2020 2020 2020 2020 6d69 7373  ))).        miss
+00030e00: 696e 6720 3d20 5b61 7474 7220 666f 7220  ing = [attr for 
+00030e10: 6174 7472 2069 6e20 6174 7472 735b 692b  attr in attrs[i+
+00030e20: 313a 5d20 6966 206e 6f74 2067 6574 6174  1:] if not getat
+00030e30: 7472 2863 6c73 2c20 6174 7472 2920 6973  tr(cls, attr) is
+00030e40: 206e 6f74 2067 6574 6174 7472 2841 7272   not getattr(Arr
+00030e50: 6179 2c20 6174 7472 295d 0a20 2020 2020  ay, attr)].     
+00030e60: 2020 2069 6620 6d69 7373 696e 673a 0a20     if missing:. 
+00030e70: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00030e80: 2827 5b20 5d20 7b7d 2063 6f75 6c64 2064  ('[ ] {} could d
+00030e90: 6566 696e 6520 7b7d 272e 666f 726d 6174  efine {}'.format
+00030ea0: 2863 6c73 2e5f 5f6e 616d 655f 5f2c 2027  (cls.__name__, '
+00030eb0: 2c20 272e 6a6f 696e 286d 6973 7369 6e67  , '.join(missing
+00030ec0: 2929 290a 0a23 2076 696d 3a73 773d 343a  )))..# vim:sw=4:
+00030ed0: 7374 733d 343a 6574 0a                   sts=4:et.
```

### Comparing `nutils-8.6/nutils/export.py` & `nutils-8.7/nutils/export.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/expression_v1.py` & `nutils-8.7/nutils/expression_v1.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/expression_v2.py` & `nutils-8.7/nutils/expression_v2.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/function.py` & `nutils-8.7/nutils/function.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/matrix/__init__.py` & `nutils-8.7/nutils/matrix/__init__.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/matrix/_base.py` & `nutils-8.7/nutils/matrix/_base.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/matrix/_mkl.py` & `nutils-8.7/nutils/matrix/_mkl.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/matrix/_numpy.py` & `nutils-8.7/nutils/matrix/_numpy.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/matrix/_scipy.py` & `nutils-8.7/nutils/matrix/_scipy.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/mesh.py` & `nutils-8.7/nutils/mesh.py`

 * *Files 1% similar despite different names*

```diff
@@ -277,21 +277,17 @@
                     patchverts[j]*util.product(c if s else 1-c for c, s in zip(coord, side))
                     for j, side in zip(patch.flat, itertools.product(*[[0, 1]]*ndims))
                 )
                 for coord in patchcoords.T
             ]).T
         coords.append(patchcoords)
 
-    # build patch boundary data
-
-    boundarydata = topology.MultipatchTopology.build_boundarydata(patches)
-
     # join patch topologies, geometries
 
-    topo = topology.MultipatchTopology(tuple(map(topology.Patch, topos, patches, boundarydata)))
+    topo = topology.MultipatchTopology(topos, patches)
     funcsp = topo.basis('spline', degree=1, patchcontinuous=False)
     geom = (funcsp * numpy.concatenate(coords, axis=1)).sum(-1)
 
     return topo, geom
 
 
 @cache.function
```

### Comparing `nutils-8.6/nutils/numeric.py` & `nutils-8.7/nutils/numeric.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/parallel.py` & `nutils-8.7/nutils/parallel.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/points.py` & `nutils-8.7/nutils/points.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/pointsseq.py` & `nutils-8.7/nutils/pointsseq.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/sample.py` & `nutils-8.7/nutils/sample.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/solver.py` & `nutils-8.7/nutils/solver.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/sparse.py` & `nutils-8.7/nutils/sparse.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/testing.py` & `nutils-8.7/nutils/testing.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/topology.py` & `nutils-8.7/nutils/topology.py`

 * *Files 2% similar despite different names*

```diff
@@ -3035,114 +3035,64 @@
                 hbasis_dofs.append(numpy.concatenate(trans_dofs))
                 degree = poly.degree(self.ndims, max(c.shape[-1] for c in trans_coeffs))
                 hbasis_coeffs.append(numpy.concatenate([poly.change_degree(c, self.ndims, degree) for c in trans_coeffs], axis=0))
 
         return function.PlainBasis(hbasis_coeffs, hbasis_dofs, ndofs, self.f_index, self.f_coords)
 
 
-@dataclass(eq=True, frozen=True)
-class PatchBoundary:
-
-    id: Tuple[int, ...]
-    dim: int
-    side: int
-    reverse: Tuple[bool, ...]
-    transpose: Tuple[int, ...]
-
-    def apply_transform(self, array):
-        return array[tuple(slice(None, None, -1) if i else slice(None) for i in self.reverse)].transpose(self.transpose)
-
-
-@dataclass(eq=True, frozen=True)
-class Patch:
-
-    topo: Topology
-    verts: types.arraydata
-    boundaries: Tuple[PatchBoundary, ...]
-
-
 class MultipatchTopology(TransformChainsTopology):
     'multipatch topology'
 
-    @staticmethod
-    def build_boundarydata(connectivity):
-        'build boundary data based on connectivity'
-
-        boundarydata = []
-        for patch in connectivity:
-            ndims = len(patch.shape)
-            patchboundarydata = []
-            for dim, side in itertools.product(range(ndims), [-1, 0]):
-                # ignore vertices at opposite face
-                verts = numpy.array(patch)
-                opposite = tuple({0: -1, -1: 0}[side] if i == dim else slice(None) for i in range(ndims))
-                verts[opposite] = verts.max()+1
-                if len(set(verts.flat)) != 2**(ndims-1)+1:
-                    raise NotImplementedError('Cannot compute canonical boundary if vertices are used more than once.')
-                # reverse axes such that lowest vertex index is at first position
-                reverse = tuple(map(bool, numpy.unravel_index(verts.argmin(), verts.shape)))
-                verts = verts[tuple(slice(None, None, -1) if i else slice(None) for i in reverse)]
-                # transpose such that second lowest vertex connects to lowest vertex in first dimension, third in second dimension, et cetera
-                k = [verts[tuple(1 if i == j else 0 for j in range(ndims))] for i in range(ndims)]
-                transpose = tuple(sorted(range(ndims), key=k.__getitem__))
-                verts = verts.transpose(transpose)
-                # boundarid
-                boundaryid = tuple(verts[..., 0].flat)
-                patchboundarydata.append(PatchBoundary(boundaryid, dim, side, reverse, transpose))
-            boundarydata.append(tuple(patchboundarydata))
-
-        return boundarydata
-
-    def __init__(self, patches: Sequence[Patch]):
-        assert isinstance(patches, Sequence) and all(isinstance(patch, Patch) for patch in patches), f'patches={patches!r}'
-        self.patches = tuple(patches)
-
-        space = patches[0].topo.space
-        assert all(patch.topo.space == space for patch in patches)
-
-        for boundaryid, patchdata in self._patchinterfaces.items():
-            if len(patchdata) == 1:
-                continue
-            transposes = set()
-            reverses = set()
-            for topo, boundary in patchdata:
-                assert boundary.transpose[-1] == boundary.dim
-                transposes.add(tuple(i-1 if i > boundary.dim else i for i in boundary.transpose[:-1]))
-                reverses.add(boundary.reverse[:boundary.dim]+boundary.reverse[boundary.dim+1:])
-            if len(transposes) != 1 or len(reverses) != 1:
-                raise NotImplementedError('patch interfaces must have the same order of axes and the same orientation per axis')
+    def __init__(self, topos: Sequence[Topology], connectivity):
+
+        self._topos = tuple(topos)
+        self._connectivity = numpy.array(connectivity)
+
+        space = self._topos[0].space
+        assert all(topo.space == space for topo in self._topos)
 
         super().__init__(
             space,
-            util.sum(patch.topo.references for patch in self.patches),
-            transformseq.chain([patch.topo.transforms for patch in self.patches], self.patches[0].topo.transforms.todims, self.patches[0].topo.ndims),
-            transformseq.chain([patch.topo.opposites for patch in self.patches], self.patches[0].topo.transforms.todims, self.patches[0].topo.ndims))
+            util.sum(topo.references for topo in self._topos),
+            transformseq.chain([topo.transforms for topo in self._topos], self._topos[0].transforms.todims, self._topos[0].ndims),
+            transformseq.chain([topo.opposites for topo in self._topos], self._topos[0].transforms.todims, self._topos[0].ndims))
+
+        sides = {}
+        for topo, verts in zip(self._topos, self._connectivity):
+            for idim, iside, idx in self._iter_boundaries():
+                bverts = verts[idx]
+                sides.setdefault(frozenset(bverts.flat), []).append((bverts, (topo, idim, iside)))
+
+        self._boundaries = []
+        self._interfaces = []
+        for patchdata in sides.values():
+            (bverts0, *other_bverts), data = zip(*patchdata)
+            if not other_bverts:
+                self._boundaries.append(data[0])
+            else:
+                if not all((bverts == bverts0).all() for bverts in other_bverts):
+                    raise NotImplementedError('patch interfaces must have the same order of axes and the same orientation per axis')
+                self._interfaces.append((bverts0, data))
 
-    @cached_property
-    def _patchinterfaces(self):
-        patchinterfaces = {}
-        for patch in self.patches:
-            for boundary in patch.boundaries:
-                patchinterfaces.setdefault(boundary.id, []).append((patch.topo, boundary))
-        return types.frozendict({
-            boundaryid: tuple(data)
-            for boundaryid, data in patchinterfaces.items()
-            if len(data) > 1
-        })
+    def _iter_boundaries(self):
+        return ((idim, iside, (slice(None),)*idim + (iside,)) for idim in range(self.ndims) for iside in (-1, 0))
 
     def get_groups(self, *groups: str) -> TransformChainsTopology:
-        topos = (patch.topo if 'patch{}'.format(i) in groups else patch.topo.get_groups(*groups) for i, patch in enumerate(self.patches))
+        topos = (topo if 'patch{}'.format(i) in groups else topo.get_groups(*groups) for i, topo in enumerate(self._topos))
         topos = tuple(filter(None, topos))
         if len(topos) == 0:
             return self.empty_like()
         elif len(topos) == 1:
             return topos[0]
         else:
             return DisjointUnionTopology(topos)
 
+    def basis_std(self, degree, patchcontinuous=True):
+        return self.basis_spline(degree, patchcontinuous, continuity=0)
+
     def basis_spline(self, degree, patchcontinuous=True, knotvalues=None, knotmultiplicities=None, *, continuity=-1):
         '''spline from vertices
 
         Create a spline basis with degree ``degree`` per patch.  If
         ``patchcontinuous``` is true the basis is $C^0$-continuous at patch
         interfaces.
         '''
@@ -3187,137 +3137,121 @@
 
         missing = object()
 
         coeffs = []
         dofmap = []
         dofcount = 0
         commonboundarydofs = {}
-        for ipatch, patch in enumerate(self.patches):
-            # build structured spline basis on patch `patch.topo`
+        for ipatch, (topo, verts) in enumerate(zip(self._topos, self._connectivity)):
+            # build structured spline basis on patch `topo`
             patchknotvalues = []
             patchknotmultiplicities = []
             for idim in range(self.ndims):
                 left = tuple(0 if j == idim else slice(None) for j in range(self.ndims))
                 right = tuple(1 if j == idim else slice(None) for j in range(self.ndims))
                 dimknotvalues = set()
                 dimknotmultiplicities = set()
-                for edge in zip(patch.verts[left].flat, patch.verts[right].flat):
+                for edge in zip(verts[left].flat, verts[right].flat):
                     v = knotvalues.get(edge, knotvalues.get(None, missing))
                     m = knotmultiplicities.get(edge, knotmultiplicities.get(None, missing))
                     if v is missing:
                         raise 'missing edge'
                     dimknotvalues.add(v)
                     if m is missing:
                         raise 'missing edge'
                     dimknotmultiplicities.add(m)
                 if len(dimknotvalues) != 1:
                     raise 'ambiguous knot values for patch {}, dimension {}'.format(ipatch, idim)
                 if len(dimknotmultiplicities) != 1:
                     raise 'ambiguous knot multiplicities for patch {}, dimension {}'.format(ipatch, idim)
                 patchknotvalues.extend(dimknotvalues)
                 patchknotmultiplicities.extend(dimknotmultiplicities)
-            patchcoeffs, patchdofmap, patchdofcount = patch.topo._basis_spline(degree, knotvalues=patchknotvalues, knotmultiplicities=patchknotmultiplicities, continuity=continuity)
+            patchcoeffs, patchdofmap, patchdofcount = topo._basis_spline(degree, knotvalues=patchknotvalues, knotmultiplicities=patchknotmultiplicities, continuity=continuity)
             coeffs.extend(patchcoeffs)
             dofmap.extend(types.frozenarray(dofs+dofcount, copy=False) for dofs in patchdofmap)
             if patchcontinuous:
                 # reconstruct multidimensional dof structure
                 dofs = dofcount + numpy.arange(numpy.prod(patchdofcount), dtype=int).reshape(patchdofcount)
-                for boundary in patch.boundaries:
+                for idim, iside, idx in self._iter_boundaries():
                     # get patch boundary dofs and reorder to canonical form
-                    boundarydofs = boundary.apply_transform(dofs)[..., 0].ravel()
+                    boundarydofs = dofs[idx].ravel()
                     # append boundary dofs to list (in increasing order, automatic by outer loop and dof increment)
-                    commonboundarydofs.setdefault(boundary.id, []).append(boundarydofs)
+                    commonboundarydofs.setdefault(tuple(verts[idx].flat), []).append(boundarydofs)
             dofcount += numpy.prod(patchdofcount)
 
         if patchcontinuous:
             # build merge mapping: merge common boundary dofs (from low to high)
             pairs = itertools.chain(*(zip(*dofs) for dofs in commonboundarydofs.values() if len(dofs) > 1))
             renumber, dofcount = util.merge_index_map(dofcount, pairs)
             # apply mappings
             dofmap = tuple(types.frozenarray(renumber[v], copy=False) for v in dofmap)
 
         return function.PlainBasis(coeffs, dofmap, dofcount, self.f_index, self.f_coords)
 
     def basis_patch(self):
         'degree zero patchwise discontinuous basis'
 
-        transforms = transformseq.PlainTransforms(tuple((patch.topo.root,) for patch in self.patches), self.ndims, self.ndims)
+        transforms = transformseq.PlainTransforms(tuple((topo.root,) for topo in self._topos), self.ndims, self.ndims)
         index = function.transforms_index(self.space, transforms)
         coords = function.transforms_coords(self.space, transforms)
-        return function.DiscontBasis([types.frozenarray([[1]], dtype=float)]*len(self.patches), index, coords)
+        return function.DiscontBasis([types.frozenarray([[1]], dtype=float)]*len(self._topos), index, coords)
 
     @cached_property
     def boundary(self):
         'boundary'
 
+        if not self._boundaries:
+            return EmptyTopology(self.space, self.transforms.todims, self.ndims-1)
+
         subtopos = []
         subnames = []
-        for i, patch in enumerate(self.patches):
-            for boundary in patch.boundaries:
-                if boundary.id in self._patchinterfaces:
-                    continue
-                name = patch.topo._bnames[boundary.dim][boundary.side]
-                subtopos.append(patch.topo.boundary[name])
-                subnames.append('patch{}-{}'.format(i, name))
-        if len(subtopos) == 0:
-            return EmptyTopology(self.space, self.transforms.todims, self.ndims-1)
-        else:
-            return DisjointUnionTopology(subtopos, subnames)
+        for i, (topo, idim, iside) in enumerate(self._boundaries):
+            name = topo._bnames[idim][iside]
+            subtopos.append(topo.boundary[name])
+            subnames.append('patch{}-{}'.format(i, name))
+        return DisjointUnionTopology(subtopos, subnames)
 
     @cached_property
     def interfaces(self):
         '''interfaces
 
         Return a topology with all element interfaces.  The patch interfaces are
         accessible via the group ``'interpatch'`` and the interfaces *inside* a
         patch via ``'intrapatch'``.
         '''
 
-        intrapatchtopo = EmptyTopology(self.space, self.transforms.todims, self.ndims-1) if not self.patches else \
-            DisjointUnionTopology([patch.topo.interfaces for patch in self.patches])
+        intrapatchtopo = EmptyTopology(self.space, self.transforms.todims, self.ndims-1) if not self._topos else \
+            DisjointUnionTopology([topo.interfaces for topo in self._topos])
 
         btopos = []
         bconnectivity = []
-        for boundaryid, patchdata in self._patchinterfaces.items():
+        for bverts, patchdata in self._interfaces:
             if len(patchdata) > 2:
                 raise ValueError('Cannot create interfaces of multipatch topologies with more than two interface connections.')
-            pairs = []
-            references = None
-            for topo, boundary in patchdata:
-                btopo = topo.boundary[topo._bnames[boundary.dim][boundary.side]]
-                if references is None:
-                    references = numeric.asobjvector(btopo.references).reshape(btopo.shape)
-                    references = references[tuple(_ if i == boundary.dim else slice(None) for i in range(self.ndims))]
-                    references = boundary.apply_transform(references)[..., 0]
-                    references = tuple(references.flat)
-                transforms = numeric.asobjvector(btopo.transforms).reshape(btopo.shape)
-                transforms = transforms[tuple(_ if i == boundary.dim else slice(None) for i in range(self.ndims))]
-                transforms = boundary.apply_transform(transforms)[..., 0]
-                pairs.append(tuple(map(transform.canonical, transforms.flat)))
+            boundaries = [topo.boundary[topo._bnames[idim][iside]] for topo, idim, iside in patchdata]
+            transforms, opposites = [btopo.transforms for btopo in boundaries]
+            references, opposite_references = [btopo.references for btopo in boundaries]
+            assert references == opposite_references
             # create structured topology of joined element pairs
-            references = References.from_iter(references, self.ndims-1)
-            transforms, opposites = pairs
-            transforms = transformseq.PlainTransforms(transforms, self.transforms.todims, self.ndims-1)
-            opposites = transformseq.PlainTransforms(opposites, self.transforms.todims, self.ndims-1)
             btopos.append(TransformChainsTopology(self.space, references, transforms, opposites))
-            bconnectivity.append(numpy.array(boundaryid).reshape((2,)*(self.ndims-1)))
+            bconnectivity.append(bverts)
         # create multipatch topology of interpatch boundaries
-        interpatchtopo = MultipatchTopology(tuple(map(Patch, btopos, bconnectivity, self.build_boundarydata(bconnectivity))))
+        interpatchtopo = MultipatchTopology(btopos, bconnectivity)
 
         return DisjointUnionTopology((intrapatchtopo, interpatchtopo), ('intrapatch', 'interpatch'))
 
     @cached_property
     def connectivity(self):
         connectivity = []
         patchinterfaces = {}
-        for patch in self.patches:  # len(connectivity) represents the element offset for the current patch
-            ielems = numpy.arange(len(patch.topo)).reshape(patch.topo.shape) + len(connectivity)
-            for boundary in patch.boundaries:
-                patchinterfaces.setdefault(boundary.id, []).append((boundary.apply_transform(ielems)[..., 0], boundary.dim * 2 + (boundary.side == 0)))
-            connectivity.extend(patch.topo.connectivity + len(connectivity) * numpy.not_equal(patch.topo.connectivity, -1))
+        for topo, verts in zip(self._topos, self._connectivity):  # len(connectivity) represents the element offset for the current patch
+            ielems = numpy.arange(len(topo)).reshape(topo.shape) + len(connectivity)
+            for idim, iside, idx in self._iter_boundaries():
+                patchinterfaces.setdefault(tuple(verts[idx].flat), []).append((ielems[idx], idim * 2 + (iside == 0)))
+            connectivity.extend(topo.connectivity + len(connectivity) * numpy.not_equal(topo.connectivity, -1))
         connectivity = numpy.array(connectivity)
         for patchdata in patchinterfaces.values():
             if len(patchdata) > 2:
                 raise ValueError('Cannot create connectivity of multipatch topologies with more than two interface connections.')
             if len(patchdata) == 2:
                 (ielem, iedge), (jelem, jedge) = patchdata
                 assert ielem.shape == jelem.shape
@@ -3327,10 +3261,10 @@
                 connectivity[jelem, jedge] = ielem
         return types.frozenarray(connectivity, copy=False)
 
     @cached_property
     def refined(self):
         'refine'
 
-        return MultipatchTopology(tuple(Patch(patch.topo.refined, patch.verts, patch.boundaries) for patch in self.patches))
+        return MultipatchTopology([topo.refined for topo in self._topos], self._connectivity)
 
 # vim:sw=4:sts=4:et
```

### Comparing `nutils-8.6/nutils/transform.py` & `nutils-8.7/nutils/transform.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/transformseq.py` & `nutils-8.7/nutils/transformseq.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/types.py` & `nutils-8.7/nutils/types.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/unit.py` & `nutils-8.7/nutils/unit.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/nutils/warnings.py` & `nutils-8.7/nutils/warnings.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/pyproject.toml` & `nutils-8.7/pyproject.toml`

 * *Files 1% similar despite different names*

```diff
@@ -20,14 +20,14 @@
     "Topic :: Scientific/Engineering :: Mathematics",
     "Topic :: Scientific/Engineering :: Physics",
 ]
 
 [project.optional-dependencies]
 docs = ["Sphinx >=1.8,<8"]
 export_mpl = ["matplotlib >=3.3,<4"]
-matrix_mkl = ["mkl <2024"]
+matrix_mkl = ["mkl"]
 matrix_scipy = ["scipy >=0.13,<2"]
 import_gmsh = ["meshio >=4,<6"]
 
 [build-system]
 requires = ["flit_core >=3.2,<4"]
 build-backend = "flit_core.buildapi"
```

### Comparing `nutils-8.6/tests/test_SI.py` & `nutils-8.7/tests/test_SI.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_backports.py` & `nutils-8.7/tests/test_backports.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_basis.py` & `nutils-8.7/tests/test_basis.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_cache.py` & `nutils-8.7/tests/test_cache.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_cli.py` & `nutils-8.7/tests/test_cli.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_docs.py` & `nutils-8.7/tests/test_docs.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_element.py` & `nutils-8.7/tests/test_element.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_elementseq.py` & `nutils-8.7/tests/test_elementseq.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_evaluable.py` & `nutils-8.7/tests/test_evaluable.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_export.py` & `nutils-8.7/tests/test_export.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_expression_v1.py` & `nutils-8.7/tests/test_expression_v1.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_expression_v2.py` & `nutils-8.7/tests/test_expression_v2.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_finitecell.py` & `nutils-8.7/tests/test_finitecell.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_function.py` & `nutils-8.7/tests/test_function.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_graph.py` & `nutils-8.7/tests/test_graph.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_ischeme.py` & `nutils-8.7/tests/test_ischeme.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_matrix.py` & `nutils-8.7/tests/test_matrix.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh.py` & `nutils-8.7/tests/test_mesh.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh2d.geo` & `nutils-8.7/tests/test_mesh/mesh2d.geo`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh2d_p1_v2.msh` & `nutils-8.7/tests/test_mesh/mesh2d_p1_v2.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh2d_p1_v4.msh` & `nutils-8.7/tests/test_mesh/mesh2d_p1_v4.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh2d_p2_v2.msh` & `nutils-8.7/tests/test_mesh/mesh2d_p2_v2.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh2d_p2_v4.msh` & `nutils-8.7/tests/test_mesh/mesh2d_p2_v4.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh2d_p3_v2.msh` & `nutils-8.7/tests/test_mesh/mesh2d_p3_v2.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh2d_p3_v4.msh` & `nutils-8.7/tests/test_mesh/mesh2d_p3_v4.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh2d_p4_v2.msh` & `nutils-8.7/tests/test_mesh/mesh2d_p4_v2.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh2d_p4_v4.msh` & `nutils-8.7/tests/test_mesh/mesh2d_p4_v4.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh3d.geo` & `nutils-8.7/tests/test_mesh/mesh3d.geo`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh3d_p1_v2.msh` & `nutils-8.7/tests/test_mesh/mesh3d_p1_v2.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh3d_p1_v4.msh` & `nutils-8.7/tests/test_mesh/mesh3d_p1_v4.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh3d_p2_v2.msh` & `nutils-8.7/tests/test_mesh/mesh3d_p2_v2.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh3d_p2_v4.msh` & `nutils-8.7/tests/test_mesh/mesh3d_p2_v4.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh3dmani.geo` & `nutils-8.7/tests/test_mesh/mesh3dmani.geo`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh3dmani_p1_v2.msh` & `nutils-8.7/tests/test_mesh/mesh3dmani_p1_v2.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh3dmani_p1_v4.msh` & `nutils-8.7/tests/test_mesh/mesh3dmani_p1_v4.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh3dmani_p2_v2.msh` & `nutils-8.7/tests/test_mesh/mesh3dmani_p2_v2.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_mesh/mesh3dmani_p2_v4.msh` & `nutils-8.7/tests/test_mesh/mesh3dmani_p2_v4.msh`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_normals.py` & `nutils-8.7/tests/test_normals.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_numeric.py` & `nutils-8.7/tests/test_numeric.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_parallel.py` & `nutils-8.7/tests/test_parallel.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_points.py` & `nutils-8.7/tests/test_points.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_pointsseq.py` & `nutils-8.7/tests/test_pointsseq.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_quadrature.py` & `nutils-8.7/tests/test_quadrature.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_sample.py` & `nutils-8.7/tests/test_sample.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_solver.py` & `nutils-8.7/tests/test_solver.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_sparse.py` & `nutils-8.7/tests/test_sparse.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_testing.py` & `nutils-8.7/tests/test_testing.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_topology.py` & `nutils-8.7/tests/test_topology.py`

 * *Files 1% similar despite different names*

```diff
@@ -1166,14 +1166,43 @@
         domain, geom = mesh.multipatch(patches=patches, nelems=1)
         basis = domain.basis('spline', 1)
         actual = domain.sample('bezier', 2).eval(basis)
         desired = numpy.zeros((16, 10))
         desired[numpy.arange(16), [0, 1, 2, 3, 4, 5, 3, 6, 2, 3, 7, 8, 3, 6, 8, 9]] = 1
         numpy.testing.assert_allclose(actual, desired)
 
+    def test_ring(self):
+        patches = (0, 1, 3, 4), (3, 4, 5, 6), (1, 2, 4, 6)
+        patchverts = (0, 0), (.5, 0), (1, 0), (0, .5), (.5, .5), (0, 1), (1, 1)
+        # 5-------6
+        # |  1  / |
+        # 3---4   |
+        # | 0 | 2 |
+        # 0---1---2
+        domain, geom = mesh.multipatch(patches=patches, patchverts=patchverts, nelems=1)
+        self.assertEqual(domain.connectivity.tolist(), [[1, -1,  2, -1], [-1, 0, 2, -1], [1, -1, -1, 0]])
+        self.assertEqual(len(domain.interfaces['interpatch']), 3)
+        self.assertEqual(len(domain.basis('std', 1)), 7)
+        self.assertAlmostEqual(domain.integrate(function.J(geom), degree=1), 1)
+
+    def test_partial_ring(self):
+        patches = (10, 12, 6, 8, 11, 1, 7, 9), (10, 12, 6, 8, 0, 1, 2, 3), (13, 15, 10, 12, 14, 5, 11, 1), (13, 15, 10, 12, 4, 5, 0, 1)
+        #  side 1    14--11--7
+        # 5---1---9  | 2 | 0 |
+        # | 2 | 0 |  13--10--6
+        # 15--12--8  | 3 | 1 |
+        # | 3 | 1 |  4---0---2
+        # 5---1---3   side 2
+        domain, geom = mesh.multipatch(patches=patches, nelems=1)
+        self.assertEqual(len(domain.interfaces['interpatch']), 5) # 5th interface via 15-12-5-1
+        self.assertEqual(len(domain.boundary), 14)
+        self.assertEqual(len(domain.basis('std', 1)), 16)
+        # this test fails if MultipatchTopology.basis_std delegates to
+        # TransformChainsTopology.basis_std rather than MultipatchTopology.basis_spline.
+
 
 class multipatch_errors(TestCase):
 
     def test_reverse(self):
         with self.assertRaises(NotImplementedError):
             mesh.multipatch(
                 patches=[[0, 1, 2, 3], [3, 2, 5, 4]],
```

### Comparing `nutils-8.6/tests/test_transform.py` & `nutils-8.7/tests/test_transform.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_transformseq.py` & `nutils-8.7/tests/test_transformseq.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_types.py` & `nutils-8.7/tests/test_types.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_unit.py` & `nutils-8.7/tests/test_unit.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/tests/test_util.py` & `nutils-8.7/tests/test_util.py`

 * *Files identical despite different names*

### Comparing `nutils-8.6/PKG-INFO` & `nutils-8.7/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: nutils
-Version: 8.6
+Version: 8.7
 Summary: Numerical Utilities for Finite Element Analysis
 Author-email: Evalf <info@evalf.com>
 Requires-Python: >=3.7
 Description-Content-Type: text/markdown
 Classifier: License :: OSI Approved :: MIT License
 Classifier: Topic :: Scientific/Engineering :: Mathematics
 Classifier: Topic :: Scientific/Engineering :: Physics
@@ -14,15 +14,15 @@
 Requires-Dist: nutils-poly >=1,<2
 Requires-Dist: psutil >=5,<6
 Requires-Dist: stringly
 Requires-Dist: treelog >=1,<2
 Requires-Dist: Sphinx >=1.8,<8 ; extra == "docs"
 Requires-Dist: matplotlib >=3.3,<4 ; extra == "export_mpl"
 Requires-Dist: meshio >=4,<6 ; extra == "import_gmsh"
-Requires-Dist: mkl <2024 ; extra == "matrix_mkl"
+Requires-Dist: mkl ; extra == "matrix_mkl"
 Requires-Dist: scipy >=0.13,<2 ; extra == "matrix_scipy"
 Provides-Extra: docs
 Provides-Extra: export_mpl
 Provides-Extra: import_gmsh
 Provides-Extra: matrix_mkl
 Provides-Extra: matrix_scipy
```

